<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>地图的销毁 - MapOrbis</title>
  <link rel="stylesheet" href="./example/css/orbisstyle.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="./example/js/demo-common.js"></script>
  <style>
    html, body, #map {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }

    /* 控制面板定位 */
    .orbis-control-panel {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 300px;
      z-index: 1000;
    }

    /* 响应式调整 */
    @media (max-width: 768px) {
      .orbis-control-panel {
        width: calc(100% - 40px);
        right: 20px;
        left: 20px;
      }
    }
  </style>
</head>

<body class="orbis-body">
  <div id="map"></div>

  <div class="orbis-control-panel">
    <div class="orbis-panel orbis-shadow-lg">
        <div class="orbis-panel-header" style="display: flex; justify-content: space-between; align-items: center;">
          <h3 style="margin: 0; font-size: 15px; font-weight: 600;">
            <i class="fas fa-map" style="color: var(--orbis-blue)"></i>
            地图的销毁
          </h3>
          <button class="orbis-toggle" id="themeToggle" title="切换暗黑模式">
            <i class="fas fa-moon"></i>
          </button>
        </div>

      <div class="orbis-panel-body">
        <div class="orbis-btn-group orbis-mb-4">
          <div class="orbis-btn-row">
            <button class="orbis-btn orbis-btn-primary" id="createMap">
              <i class="fas fa-plus-circle"></i>
              创建地图
            </button>
            <button class="orbis-btn orbis-btn-danger" id="destroyMap">
              <i class="fas fa-trash"></i>
              销毁地图
            </button>
          </div>
        </div>
        
        <div class="orbis-status-card">
          <div class="orbis-status-title">地图状态</div>
          <div class="orbis-status-indicator">
            <span class="orbis-indicator orbis-indicator-active" id="statusIndicator"></span>
            <div class="orbis-status-content" id="statusText">地图运行中</div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.171.0/build/three.module.js"
        }
      }
    </script>

  <script type="module">
    import * as maporbis from "./dist/index.js";
    let map;

    createMap();
    
    function createMap() {
      showLoading("正在创建地图...");
      
      // Initialize Map
      map = new maporbis.Map("map", {
        state: {
          center: [116.4, 39.9, 2000], // Beijing, [lon, lat, height]
        },
        source: {
          minLevel: 2,
          maxLevel: 19,
          baseLayers: [
            new maporbis.WMTSTileLayer("esri_imagery", {
              source: new maporbis.TileSource({
                url: "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
                projectionID: "3857",
              }),
              projection: maporbis.ProjectionFactory.create("3857"),
              opacity: 1.0,
              visible: true,
              altitude: 1,
            }),
          ],
        },
        renderer: {
          stats: true,
          antialias: true,
          skybox: {
            hdr: "/example/public/image/hdr/kloofendal_48d_partly_cloudy_puresky_2k.hdr",
            hdrExposure: 1,
            defaultColor: "#B9D4FE",
          },
          minDistance: 20,
          maxDistance: 80000,
          defaultGround: {
            enabled: false,
            visible: true,
            color: "#ff0000",
            opacity: 1,
          },
        },
        camera: {
          pitch: 75,
          bearing: 0,
        },
      });

      map.on("load", () => {
        hideLoading();
        document.getElementById("statusIndicator").className = "orbis-indicator orbis-indicator-active";
        document.getElementById("statusText").textContent = "地图运行中";
        notify("地图创建成功", "success");
        console.log("Map loaded event fired");
      });
    }

    document.getElementById("createMap").addEventListener("click", () => {
      if (map) {
        showLoading("正在重建地图...");
        try {
          map.dispose();
          notify("旧地图已销毁", "info");
        } catch (error) {
          console.error("销毁失败:", error);
        }
      }
      createMap();
    });
    
    document.getElementById("destroyMap").addEventListener("click", () => {
      if (map) {
        showLoading("正在销毁地图...");
        try {
          map.dispose();
          map = null;
          hideLoading();
          document.getElementById("statusIndicator").className = "orbis-indicator";
          document.getElementById("statusText").textContent = "地图已销毁";
          notify("地图已成功销毁", "warning");
        } catch (error) {
          hideLoading();
          notify("销毁失败: " + error.message, "error");
        }
      } else {
        notify("地图不存在", "warning");
      }
    });
  </script>
</body>

</html>