# MapOrbis 示例与功能开发计划

本文档梳理现有 Demo 与后续功能开发的先后顺序，并对各项任务的可行性和依赖关系进行简要说明。整体原则是：

- 先完成「基础要素 + UI + 图层」相关的 Demo，保障引擎基础能力可演示。
- 再补齐「瓦片、矢量瓦片、Model」等数据源相关 Demo。
- 然后在此基础上开发高级渲染能力（天空盒、天气、特效、三维样式、地形）。
- 全程穿插单元测试与性能优化，避免后期返工成本过高。
- 将 Demo 持续集成到现有 map 示例项目中，形成统一的展示与验证环境。

---

## 阶段总览（推荐顺序）

1. **阶段一：基础要素与交互 Demo**
   - 点、线、面要素及样式
   - 绘制工具示例
   - 地图信息框、要素信息框、自定义信息框
   - UIMarker 示例、Tooltip 示例

2. **阶段二：图层与数据源 Demo**
   - 图层管理示例
   - 瓦片图层示例
   - 矢量瓦片示例
   - Model 相关示例

3. **阶段三：天空盒与集成**
   - 天空盒的设置和更新（静态）
   - 动态天空盒、体积云和体积光
   - 将上述 Demo 融入现有 map 示例项目

4. **阶段四：工具类能力**
   - 量测工具
   - 要素吸附（Snap）

5. **阶段五：矢量瓦片 & 大数据 & 特效**
   - 矢量瓦片性能优化
   - 大数据量要素支持
   - 各类特效：雷达扫描、飞线、流动线、光墙等
   - 矢量瓦片三维样式（三维管道、gltf style）

6. **阶段六：地形与系统化测试**
   - 地形功能
   - 单元测试体系完善与回归

---

## 阶段一：基础要素与交互 Demo

### 1.1 点要素的创建与样式（原任务 1）

- **目标**：展示点要素的创建、添加/删除/更新，以及多种样式（颜色、大小、图标、贴图、闪烁/呼吸等）。
- **优先级**：最高
- **依赖**：引擎现有点要素（`Marker` / `Point`）能力。
- **可行性**：  
  源码中已有 `feature/Marker.ts`、`feature/Point.ts`、`layer/PointLayer.ts` 等，基础能力齐全。主要工作是：
  - 设计统一的 Demo API 和界面配置（比如下拉选择不同样式）。
  - 构建不同风格的点样式配置（纯色、带图标、聚合等）。

### 1.2 线要素的场景与样式（原任务 2）

- **目标**：展示线要素（道路、轨迹等）以及多种样式（虚线、宽度变化、渐变色、带箭头等）。
- **优先级**：很高
- **依赖**：点要素 demo 已完成（用于连线、路径演示）。
- **可行性**：  
  源码中已存在 `Line.ts`、`LineLayer.ts` 等，基础渲染能力已经具备。可以通过：
  - 样式参数扩展（线宽、颜色、虚线、纹理）。
  - 在 Demo 中演示轨迹播放或线段高亮。

### 1.3 面要素的创建与样式（原任务 3）

- **目标**：展示多边形（面）创建与编辑，多种样式（填充颜色、边框、纹理、半透明等）。
- **优先级**：很高
- **依赖**：点、线 demo 完成后，复用交互逻辑。
- **可行性**：  
  源码中已有 `Polygon.ts`、`PolygonLayer.ts`。可行性高，主要是：
  - 制作多种面样式（纯色、渐变、纹理贴图）。
  - 演示区域高亮、选择、编辑。

### 1.4 绘制工具示例（原任务 5）

- **目标**：为点/线/面提供统一的绘制交互工具示例（点击画点、点击拖动画线、点击围合画面）。
- **优先级**：高
- **依赖**：点、线、面 demo 完成（做为绘制目标对象）。
- **可行性**：  
  项目已有 `handler/edit`、`handler/drag`、`map/tool` 相关代码和 `feature-edit-*.html` 示例，可在此基础上：
  - 封装一个统一的 Draw 工具入口（例如：画点/线/面按钮）。
  - 演示开始绘制、撤销、结束绘制等完整流程。

### 1.5 信息框相关（地图 / 要素 / 自定义）（原任务 6, 7, 8）

- **目标**：
  - 地图信息框：在指定经纬度/地理位置显示描述信息。
  - 要素信息框：点击要素弹出详细信息框。
  - 自定义信息框：支持用户自定义 HTML 结构和样式。
- **优先级**：中高
- **依赖**：点/线/面 demo 已有可点击要素。
- **可行性**：  
  项目已有 `ui/InfoWindow.ts`、`UIComponent.ts` 等，已经具备基础组件能力。主要工作：
  - 衔接地图事件（点击、鼠标移动）与 InfoWindow。
  - 提供一个简单的配置方式（内容模板、偏移、是否跟随视图）。

### 1.6 UIMarker 示例（原任务 9）

- **目标**：展示自定义 DOM/HTML 的 UIMarker 能力，比如带统计数字、进度条的小组件。
- **优先级**：中高
- **依赖**：基础要素 demo 完成。
- **可行性**：  
  有 `ui/UIMarker.ts`。主要是：
  - 展示 UIMarker 的创建、销毁、更新。
  - 演示随地图缩放/移动的表现。

### 1.7 Tooltip 示例（原任务 10）

- **目标**：鼠标悬浮在要素或 UI 元素上，提供简短提示。
- **优先级**：中
- **依赖**：点/线/面 或 UIMarker demo。
- **可行性**：  
  有 `ui/ToolTip.ts`，只需要编写几种典型场景（点要素、线要素、UIMarker）。

---

## 阶段二：图层与数据源 Demo

### 2.1 图层管理示例（原任务 11）

- **目标**：展示图层添加/移除、显示/隐藏、顺序调整、透明度等管理功能。
- **优先级**：高
- **依赖**：基础要素 demo（用于展示不同图层效果）。
- **可行性**：  
  有 `Layer.ts`、`LayerContainer.ts`、各类 Layer，图层管理是核心能力，完全可行。示例重点：
  - 一个简单图层面板（树或列表）。
  - 演示多种 Layer（点、线、面、瓦片、矢量瓦片）组合。

### 2.2 瓦片图层示例（原任务 12）

- **目标**：展示基础瓦片地图（XYZ/WMTS/ArcGIS 等）加载与切换。
- **优先级**：高
- **依赖**：图层管理示例（可以做为一个图层类型）。
- **可行性**：  
  源码有 `sources/TileSource.ts`、`WMTSSource.ts`、`ArcGisSource.ts`、`TDTSource.ts` 等；有 `layer/TileLayer`。只需：
  - 配置不同来源的瓦片服务。
  - 提供切换底图、调整亮度/透明度的 UI。

### 2.3 矢量瓦片示例（原任务 13）

- **目标**：加载 MVT/Mapbox 样式的矢量瓦片，展示不同类型要素（道路、建筑、区域）。
- **优先级**：高
- **依赖**：瓦片图层基础能力。
- **可行性**：  
  项目有 `MVTSource.ts`、`MVTGeoSource.ts`、`MapboxVectorTileGeometryLoader.ts`、`VectorTileTextureLoader.ts`，说明已具备矢量瓦片加载与解析能力。需要：
  - 准备或接入一套矢量瓦片服务。
  - 设计几种简单样式（道路颜色、面填充、文字标注）。

### 2.4 Model 相关示例（原任务 “model 相关的示例”）

- **目标**：演示 3D 模型（gltf/obj 等）的加载、位置调整、缩放、旋转。
- **优先级**：中高
- **依赖**：地图坐标与三维场景基础已存在。
- **可行性**：  
  已有 `ExternalModelLoader.ts`、`materials` 等，且底层基于 Three.js，加载 glTF 模型完全可行。要点：
  - 选择一个简单模型进行演示（建筑、车辆等）。
  - 展示模型与地图坐标的绑定（绑定经纬度/高度）。

---

## 阶段三：天空盒与集成

### 3.1 天空盒的设置和更新（静态）（原任务 4）

- **目标**：实现静态天空盒（白天/夜晚/黄昏）切换，并提供简单的更新接口（贴图更换）。
- **优先级**：中高
- **依赖**：基础三维场景、TileLayer 已有。
- **可行性**：  
  基于 Three.js 的 `CubeTexture` 或 `Sky` 材质打造天空盒很常见，可行性高。主要工作：
  - 封装天空盒加载与切换 API。
  - 在 Demo 中添加「场景主题」切换控件（白天、夜晚等）。

### 3.2 动态天空盒、体积云和体积光（原计划 14）

- **目标**：在静态天空盒基础上，引入动画和体积效果（云、光柱等）。
- **优先级**：中偏高（较为高级的效果）
- **依赖**：静态天空盒 demo 完成。
- **可行性**：  
  - 动态天空（时间变化、太阳位置变化）可通过 Shader 或 uniform 更新实现。
  - 体积云与体积光通常需要自定义 Shader 或使用噪声贴图，有一定技术难度，但 Three.js 生态中已有类似实现可参考。
  - 性能上需要注意移动端/低配机型，建议提供开关或质量等级。

### 3.3 将 Demo 融入现有 map 示例项目（原任务 14）

- **目标**：把所有已完成的 Demo 统一集成到现有的 map 示例项目中，形成一个完整的 Demo 入口/菜单。
- **优先级**：高（产品展示 & 验证场景）
- **依赖**：前面各阶段 Demo 有一定数量后再统一接入。
- **可行性**：  
  现有 example 中已经有多页面结构，可以：
  - 统一入口页面（列表/菜单），每项跳转对应 Demo。
  - 保持样式与交互统一，方便后续扩展。

---

## 阶段四：工具类能力

### 4.1 量测工具（原任务 16）

- **目标**：提供距离量测、面积量测（及可能的高度量测）工具。
- **优先级**：中高
- **依赖**：绘制工具、线/面基础 demo。
- **可行性**：  
  - 线测距：在地图投影坐标下计算两点间距离，或调用已有地理计算工具。
  - 面测面积：对多边形进行面积计算（可使用现有 Geometry 工具）。
  - UI 展示结果、支持重置与修改。

### 4.2 要素吸附（Snap）（原任务 17）

- **目标**：在绘制和编辑时，支持吸附到现有点/线/面（端点、中点、交点等）。
- **优先级**：中
- **依赖**：编辑 / 绘制工具已稳定。
- **可行性**：  
  需要在交互层面实现：
  - 空间索引或快速邻近搜索（在已有要素集合中找到最近的吸附目标）。
  - 鼠标移动时实时更新吸附位置和视觉反馈。
  算法并不复杂，但要兼顾性能与用户体验。

---

## 阶段五：矢量瓦片 & 大数据 & 特效

### 5.1 矢量瓦片性能优化（原任务 18）

- **目标**：在矢量瓦片示例基础上，针对大范围缩放、快速移动等场景，优化加载与渲染性能。
- **优先级**：高（影响整体体验）
- **依赖**：矢量瓦片示例。
- **可行性**：  
  可从以下方面优化：
  - 瓦片缓存策略（内存/磁盘）和复用。
  - 图层/样式简化（不同缩放级别使用简化几何）。
  - 合理使用 worker（已有 `workers` 目录）。
  项目已经有 `PromiseWorker.ts` 等基础，优化空间大，可行性高。

### 5.2 大数据量要素的支持（原任务 19）

- **目标**：支持十万级甚至百万级点/线数据的展示（聚合、抽稀、多级简化）。
- **优先级**：中高
- **依赖**：基础要素与矢量瓦片性能优化。
- **可行性**：  
  - 可通过点聚合（grid/quad tree）、线与面简化（Douglas-Peucker 等算法）。
  - 利用 shader 端 instancing 渲染点要素。
  - 结合已有 `collision`、`renderer` 模块设计方案。
  技术上可行，但需要较多性能调优和数据结构设计。

### 5.3 各种特效：雷达扫描、飞线、流动线、光墙（原任务 20）

- **目标**：展示一组具有视觉冲击力的特效，用于大屏与专题应用。
- **优先级**：中
- **依赖**：线/面 demo、Model demo、Shader 基础。
- **可行性**：  
  - 雷达扫描：圆形/扇形材质 + 时间动画。
  - 飞线 / 流动线：沿线路径的纹理滚动或顶点属性动画。
  - 光墙：垂直面几何 + 发光/渐变 Shader。
  这些在 Three.js 场景中都有成熟实践，主要是 Shader 编写和性能调优。

### 5.4 矢量瓦片三维样式（三维管道 & gltf style）（原任务 21）

- **目标**：在矢量瓦片基础上，将线/面转换为三维对象（如管道），并支持按属性驱动 gltf 模型样式。
- **优先级**：中
- **依赖**：矢量瓦片示例、Model 示例。
- **可行性**：  
  - 将线要素生成 3D 管道几何（挤出/扫掠）。
  - 使用样式规则控制 gltf 模型类型、大小、颜色。
  实现难度属于中等偏上，但技术路线上相对明确，属于引擎高级能力。

---

## 阶段六：地形与系统化测试

### 6.1 地形功能（原任务 22）

- **目标**：支持 DEM/地形瓦片加载，实现地表起伏、贴地要素等效果。
- **优先级**：中
- **依赖**：TileLayer、几何加载、三维场景已成熟。
- **可行性**：  
  项目中已有 `TerrainMeshBuilder.ts`, `MapTileGeometry.ts` 等地形相关工具，说明已有基础积累。主要工作：
  - 接入地形数据源（ArcGIS elevation, Cesium terrain, 自有 DEM 等）。
  - 实现 LOD（多级细节）控制与性能优化。
  - 要素贴地（点/线/面/模型随地形起伏）。

### 6.2 单元测试跟进与完善（原任务 22 - 单元测试）

- **目标**：为核心模块（数据源、投影、渲染、交互、UI 等）建立稳定的单元测试与部分集成测试。
- **优先级**：高（但应贯穿全程）
- **依赖**：无硬依赖，建议与每个功能同步推进。
- **可行性**：  
  项目已经集成 Vitest、Playwright 等测试工具（从 `vitest.config.ts`、`tests/` 目录可见）。可行性非常高。建议：
  - 为每一个新功能/模块至少补一到两类关键用例。
  - 对已有模块逐步补测，尤其是：投影、几何计算、数据加载、样式解析等。

---

## 建议的实施节奏（可参考）

1. **迭代 1（基础展示）**  
   完成：点/线/面 + 绘制工具 + UIMarker + Tooltip + 图层管理 + 基础瓦片示例。  
   ➜ 输出：一套基础地图功能 Demo，可全流程展示。

2. **迭代 2（数据源与信息交互）**  
   完成：矢量瓦片示例 + Model 示例 + 各种信息框示例。  
   ➜ 输出：更丰富的数据展示能力，为后续三维与特效打基础。

3. **迭代 3（天空与集成）**  
   完成：静态天空盒 + 动态天空盒/体积云/体积光 + Demo 集成到 map 示例项目。  
   ➜ 输出：视觉效果更完整的统一示例站点。

4. **迭代 4（工具与性能）**  
   完成：量测工具 + Snap + 矢量瓦片性能优化 + 大数据要素 Demo。  
   ➜ 输出：实用工具与高性能能力，面向实际项目场景。

5. **迭代 5（特效与三维深化）**  
   完成：雷达扫描/飞线/流动线/光墙等特效 + 矢量瓦片三维样式（管道/gltf）。  
   ➜ 输出：大屏级展示能力和高阶三维表现。

6. **迭代 6（地形与测试体系）**  
   完成：地形功能 + 全面梳理和补充单元测试。  
   ➜ 输出：地形 + 稳定性增强，为后续长期维护和新功能扩展打基础。

---

## 总体可行性结论

- **基础 Demo（点线面、UI、图层、瓦片、矢量瓦片、Model）**：  
  项目结构完整、模块齐全，可行性很高，主要是工程组织和 API 设计问题。
- **高级渲染（动态天空、体积云、特效、三维样式、地形）**：  
  依托 Three.js 生态，有大量可复用的技术方案和示例，尽管实现复杂度较高，但整体技术风险可控。
- **工具与性能（量测、Snap、大数据、矢量瓦片优化）**：  
  偏工程与算法实现，工作量大于技术风险，需要合理规划数据结构与测试。
- **测试与集成**：  
  构建体系与测试框架已经就绪，只要在开发过程中坚持“功能+测试”一起推进，就可以建立比较扎实的质量保障体系。

以上计划可以根据你当前的人力和优先业务场景随时微调，如果你愿意，我可以按某一个阶段进一步细化到「任务拆解 + 预计工期 + 风险点」的级别。