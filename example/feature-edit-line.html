<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="initial-scale=1.0, user-scalable=no, width=device-width"
    />
    <title>多边形的编辑 - MapOrbis</title>
    <!-- 引入 MapOrbisStyle CSS -->
    <link rel="stylesheet" href="./example/css/orbisstyle.css" />
    <style>
      html,
      body,
      #container {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
      }

      /* 控制面板样式 */
      .orbis-control-panel {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 300px;
        z-index: var(--orbis-z-index-fixed);
      }

      /* 面板头部布局 */
      .orbis-panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--orbis-space-4) var(--orbis-space-5);
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        background: rgba(255, 255, 255, 0.7);
      }

      .orbis-dark .orbis-panel-header {
        border-bottom-color: rgba(255, 255, 255, 0.1);
        background: rgba(44, 44, 46, 0.7);
      }

      .panel-header-content {
        display: flex;
        flex-direction: column;
        flex: 1;
      }

      .panel-title {
        display: flex;
        align-items: center;
        gap: var(--orbis-space-2);
        font-size: 15px;
        font-weight: 600;
        margin: 0;
        color: var(--orbis-text-primary);
      }

      .orbis-dark .panel-title {
        color: var(--orbis-dark-text-primary);
      }

      .panel-subtitle {
        font-size: 12px;
        color: var(--orbis-gray-6);
        margin: 2px 0 0 0;
      }

      .orbis-dark .panel-subtitle {
        color: var(--orbis-dark-text-tertiary);
      }

      /* 切换按钮样式 */
      .orbis-toggle {
        margin-left: var(--orbis-space-3);
        flex-shrink: 0;
      }

      /* 按钮组样式 */
      .orbis-btn {
        width: 100%;
        margin-bottom: 5px;
      }

      .orbis-btn-row {
        display: flex;
        gap: var(--orbis-space-2);
      }

      /* 编辑状态提示 */
      .edit-status {
        padding: var(--orbis-space-3);
        background: var(--orbis-blue-1);
        border-radius: var(--orbis-border-radius);
        margin-bottom: var(--orbis-space-4);
        font-size: 12px;
        color: var(--orbis-blue-8);
        display: none;
      }

      .orbis-dark .edit-status {
        background: rgba(24, 144, 255, 0.2);
        color: var(--orbis-blue-3);
      }

      .edit-status.active {
        display: block;
      }

      /* 响应式调整 */
      @media (max-width: 768px) {
        .orbis-control-panel {
          width: calc(100% - 40px);
          right: 20px;
          left: 20px;
        }
      }
    </style>
  </head>
  <body class="orbis-body">
    <div id="container"></div>

    <!-- MapOrbisStyle 控制面板 -->
    <div class="orbis-control-panel">
      <div class="orbis-panel orbis-shadow-lg">
        <div class="orbis-panel-header">
          <div class="panel-header-content">
            <h3 class="panel-title">
              <i class="fas fa-draw-polygon" style="color: var(--orbis-blue)"></i>
              多边形编辑
            </h3>
            <p class="panel-subtitle">MapOrbis 多边形编辑功能</p>
          </div>
          <button class="orbis-toggle" id="themeToggle" title="切换暗黑模式">
            <i class="fas fa-moon"></i>
          </button>
        </div>

        <div class="orbis-panel-body">
          <!-- 编辑状态提示 -->
          <div class="edit-status" id="editStatus">
            <i class="fas fa-info-circle"></i>
            拖拽点进行编辑，点击边线中间点可添加新顶点
          </div>
          <!-- 按钮组 -->
          <div class="orbis-btn-group orbis-mb-4">
            <button class="orbis-btn orbis-btn-primary" id="editPolygon1">
              <i class="fas fa-edit"></i>
              编辑多边形1
            </button>
            <button class="orbis-btn orbis-btn-primary" id="editPolygon2">
              <i class="fas fa-edit"></i>
              编辑多边形2
            </button>
            <button class="orbis-btn orbis-btn-success" id="createPolygon">
              <i class="fas fa-plus"></i>
              新建多边形
            </button>
            <button class="orbis-btn orbis-btn-secondary" id="endEdit">
              <i class="fas fa-times"></i>
              结束编辑
            </button>
          </div>

          <!-- 状态显示 -->
          <div class="orbis-status-card">
            <div class="orbis-status-title">编辑状态</div>
            <div class="orbis-status-indicator orbis-mb-3">
              <span class="orbis-indicator" id="statusIndicator"></span>
              <div class="orbis-status-content" id="statusText">未编辑</div>
            </div>
            <div class="orbis-info-grid">
              <div class="orbis-info-item">
                <div class="orbis-info-label">当前多边形</div>
                <div class="orbis-info-value" id="currentPolygon">无</div>
              </div>
              <div class="orbis-info-item">
                <div class="orbis-info-label">顶点数</div>
                <div class="orbis-info-value" id="vertexCount">0</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 引入 Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.171.0/build/three.module.js"
        }
      }
    </script>
    <script type="module">
      import * as maporbis from "./src/index.ts";

      // 创建地图实例
      var map = new maporbis.Map("container", {
        state: {
          center: [116.4, 39.9, 5000000],
        },
        source: {
          minLevel: 2,
          maxLevel: 19,
          baseLayers: [
            new maporbis.WMTSTileLayer("esri_imagery", {
              source: new maporbis.TileSource({
                url: "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
                projectionID: "3857",
              }),
              projection: maporbis.ProjectionFactory.create("3857"),
              opacity: 1.0,
              visible: true,
              altitude: 1,
            }),
          ],
        },
        renderer: {
          stats: true,
          antialias: true,
          skybox: {
            hdr: "/example/public/image/hdr/kloofendal_48d_partly_cloudy_puresky_2k.hdr",
            hdrExposure: 1,
            defaultColor: "#B9D4FE",
          },
          minDistance: 20,
          maxDistance: 80000,
          defaultGround: {
            enabled: false,
            visible: true,
            color: "#ff0000",
            opacity: 1,
          },
        },
        camera: {
          pitch: 75,
          bearing: 0,
        },
      });

      // 初始化变量
      let currentEditingPolygon = null;
      let isEditing = false;
      
      // 面的坐标数据
      var path = [
        [116.403322, 39.920255],
        [116.410703, 39.897555],
        [116.402292, 39.892353],
        [116.389846, 39.891365]
      ]
      
      var path1 = [
        [116.453322, 39.920255],
        [116.460703, 39.897555],
        [116.452292, 39.892353],
        [116.439846, 39.891365]
      ]

      // 创建多边形图层
      const polygonLayer = new maporbis.PolygonLayer("polygons", { 
        altitude: 1,
        paint: {
          // 设置图层级别的默认样式
          opacity: 0.5
        }
      });
      map.addLayer(polygonLayer);

      // 创建第一个多边形
      const polygon1 = new maporbis.Polygon({
        geometry: {
          type: "Polygon",
          coordinates: [path], // 注意：Polygon需要双层数组
        },
        paint: {
          type: "fill",
          color: "#FF33FF",
          opacity: 0.6,
        },
        border: {
          color: "#FF33FF",
          width: 2,
        },
        editable: true,
      });

      // 创建第二个多边形
      const polygon2 = new maporbis.Polygon({
        geometry: {
          type: "Polygon",
          coordinates: [path1], // 注意：Polygon需要双层数组
        },
        paint: {
          type: "fill",
          color: "#00FF00",
          opacity: 0.6,
        },
        border: {
          color: "#00FF00",
          width: 2,
        },
        editable: true,
      });

      // 添加多边形到图层
      polygon1.addTo(polygonLayer);
      polygon2.addTo(polygonLayer);

      // 更新状态显示
      function updateStatus() {
        const statusIndicator = document.getElementById("statusIndicator");
        const statusText = document.getElementById("statusText");
        const currentPolygonEl = document.getElementById("currentPolygon");
        const vertexCountEl = document.getElementById("vertexCount");
        const editStatusEl = document.getElementById("editStatus");

        if (isEditing) {
          statusIndicator.className = "orbis-indicator orbis-indicator-active";
          statusText.textContent = "编辑中";
          editStatusEl.classList.add("active");

          const currentPolygon =
            currentEditingPolygon === polygon1
              ? "多边形1"
              : currentEditingPolygon === polygon2
              ? "多边形2"
              : "新多边形";
          currentPolygonEl.textContent = currentPolygon;
          
          // 获取顶点数量
          if (currentEditingPolygon && currentEditingPolygon.geometry) {
            const coords = currentEditingPolygon.geometry.coordinates[0];
            vertexCountEl.textContent = coords.length.toString();
          } else {
            vertexCountEl.textContent = "0";
          }
        } else {
          statusIndicator.className = "orbis-indicator";
          statusText.textContent = "未编辑";
          editStatusEl.classList.remove("active");
          currentPolygonEl.textContent = "无";
          vertexCountEl.textContent = "0";
        }
      }

      // 设置新建多边形的地图点击事件
      function setupMapClickForNewPolygon() {
        let newPolygon = null;
        let clickPoints = [];
        
        map.off("click"); // 移除之前的点击事件
        
        map.on("click", (e) => {
          if (!isEditing) return;
          
          clickPoints.push([e.coordinate.lng, e.coordinate.lat]);
          
          if (clickPoints.length === 1) {
            // 第一次点击，创建多边形
            newPolygon = new maporbis.Polygon({
              geometry: {
                type: "Polygon",
                coordinates: [[
                  clickPoints[0],
                  clickPoints[0]  // 重复第一个点以形成闭合路径
                ]],
              },
              paint: {
                type: "fill",
                color: "#1890FF",
                opacity: 0.4,
              },
              border: {
                color: "#1890FF",
                width: 2,
              },
              editable: true,
            });
            newPolygon.addTo(polygonLayer);
            currentEditingPolygon = newPolygon;
            updateStatus();
          } else if (clickPoints.length === 2) {
            // 第二次点击，添加三角形
            newPolygon.setGeometry({
              type: "Polygon",
              coordinates: [[
                clickPoints[0],
                clickPoints[1],
                clickPoints[0]  // 闭合多边形
              ]],
            });
            updateStatus();
          } else {
            // 后续点击，添加更多顶点
            const currentCoords = newPolygon.geometry.coordinates[0];
            // 移除最后一个闭合点
            currentCoords.pop();
            // 添加新点
            currentCoords.push([e.coordinate.lng, e.coordinate.lat]);
            // 重新添加闭合点
            currentCoords.push(clickPoints[0]);
            
            newPolygon.setGeometry({
              type: "Polygon",
              coordinates: [currentCoords],
            });
            updateStatus();
          }
        });
        
        // 右键结束绘制
        map.on("contextmenu", (e) => {
          e.event.preventDefault();
          if (newPolygon && clickPoints.length >= 3) {
            // 结束新建，开始编辑
            newPolygon.startEdit({
              handleSize: 12,
              handleColor: "#1890FF",
              showMiddleHandles: true,
            });
            map.off("click");
            map.off("contextmenu");
            clickPoints = [];
            updateStatus();
          }
        });
      }

      // 按钮事件绑定
      document.getElementById("editPolygon1").onclick = function () {
        // 结束之前的多边形编辑
        if (currentEditingPolygon && currentEditingPolygon !== polygon1) {
          currentEditingPolygon.endEdit();
        }
        
        isEditing = true;
        currentEditingPolygon = polygon1;
        polygon1.startEdit({
          handleSize: 12,
          handleColor: "#1890FF",
          showMiddleHandles: true,
        });
        updateStatus();
      };

      document.getElementById("editPolygon2").onclick = function () {
        // 结束之前的多边形编辑
        if (currentEditingPolygon && currentEditingPolygon !== polygon2) {
          currentEditingPolygon.endEdit();
        }
        
        isEditing = true;
        currentEditingPolygon = polygon2;
        polygon2.startEdit({
          handleSize: 12,
          handleColor: "#1890FF",
          showMiddleHandles: false,
        });
        updateStatus();
      };

      document.getElementById("createPolygon").onclick = function () {
        // 结束之前的多边形编辑
        if (currentEditingPolygon) {
          currentEditingPolygon.endEdit();
        }
        
        isEditing = true;
        currentEditingPolygon = null;
        setupMapClickForNewPolygon();
        
        // 更新状态显示
        const statusIndicator = document.getElementById("statusIndicator");
        const statusText = document.getElementById("statusText");
        const currentPolygonEl = document.getElementById("currentPolygon");
        const vertexCountEl = document.getElementById("vertexCount");
        const editStatusEl = document.getElementById("editStatus");
        
        statusIndicator.className = "orbis-indicator orbis-indicator-active";
        statusText.textContent = "绘制中（左键添加点，右键结束）";
        editStatusEl.classList.add("active");
        editStatusEl.innerHTML = '<i class="fas fa-info-circle"></i> 左键添加顶点，右键结束绘制';
        currentPolygonEl.textContent = "新多边形";
        vertexCountEl.textContent = "0";
      };

      document.getElementById("endEdit").onclick = function () {
        if (currentEditingPolygon) {
          currentEditingPolygon.endEdit();
        }
        isEditing = false;
        currentEditingPolygon = null;
        map.off("click");
        map.off("contextmenu");
        updateStatus();
      };

      // 监听多边形编辑事件，更新顶点数量
      function setupPolygonEditEvents(polygon) {
        polygon.on("edit", (e) => {
          if (e.type === "vertexchange") {
            updateStatus();
          }
        });
      }

      // 设置多边形编辑事件监听
      setupPolygonEditEvents(polygon1);
      setupPolygonEditEvents(polygon2);

      // 主题切换
      const themeToggle = document.getElementById("themeToggle");
      themeToggle.onclick = function () {
        document.body.classList.toggle("orbis-dark");
        const icon = this.querySelector("i");
        if (document.body.classList.contains("orbis-dark")) {
          icon.className = "fas fa-sun";
        } else {
          icon.className = "fas fa-moon";
        }
      };

      // 调整地图视野以显示所有多边形
      setTimeout(() => {
        const bounds = [
          ...path,
          ...path1
        ];
        map.setView({
          bounds: bounds,
          padding: 50
        });
      }, 1000);

      // 初始状态
      updateStatus();
    </script>
  </body>
</html>