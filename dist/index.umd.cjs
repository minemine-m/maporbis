(function(J,f){typeof exports=="object"&&typeof module<"u"?f(exports,require("three")):typeof define=="function"&&define.amd?define(["exports","three"],f):(J=typeof globalThis<"u"?globalThis:J||self,f(J.maporbis={},J.THREE))})(this,(function(J,f){"use strict";function nd(s){const e=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(s){for(const t in s)if(t!=="default"){const r=Object.getOwnPropertyDescriptor(s,t);Object.defineProperty(e,t,r.get?r:{enumerable:!0,get:()=>s[t]})}}return e.default=s,Object.freeze(e)}const et=nd(f),sd="0.0.1";var un=(s=>(s[s.none=0]="none",s[s.create=1]="create",s[s.remove=2]="remove",s))(un||{});function od(s,e){const t=s.position.clone().setZ(s.maxZ).applyMatrix4(s.matrixWorld);return e.distanceTo(t)}function ad(s){const e=s.scale,t=new f.Vector3(-e.x,-e.y,0).applyMatrix4(s.matrixWorld),r=new f.Vector3(e.x,e.y,0).applyMatrix4(s.matrixWorld);return t.sub(r).length()}function ld(s){return s.distToCamera/s.sizeInWorld*.8}function cd(s,e,t,r){const i=ld(s);if(s.isLeaf){if(s.inFrustum&&s.z<t&&(s.z<e||s.showing)&&(s.z<e||i<r))return 1}else if(s.z>=e&&(s.z>t||i>r))return 2;return 0}function ud(s,e,t,r){const i=[],o=r+1,l=e*2,c=0,u=.25;{const d=t*2,m=new f.Vector3(.5,.5,1),p=new ni(l,d,o),_=new ni(l+1,d,o),v=new ni(l,d+1,o),S=new ni(l+1,d+1,o);p.position.set(-u,u,c),p.scale.copy(m),_.position.set(u,u,c),_.scale.copy(m),v.position.set(-u,-u,c),v.scale.copy(m),S.position.set(u,-u,c),S.scale.copy(m),i.push(p,_,v,S)}return i}var hd=Object.defineProperty,fd=(s,e,t)=>e in s?hd(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ze=(s,e,t)=>fd(s,typeof e!="symbol"?e+"":e,t);const dd=10,pd=new f.InstancedBufferGeometry,md=new f.Vector3,gd=new f.Matrix4,_d=new f.Box3(new f.Vector3(-.5,-.5,0),new f.Vector3(.5,.5,1)),Ll=new f.Frustum,Ol=class Jn extends f.Mesh{constructor(e=0,t=0,r=0){super(pd,[]),Ze(this,"_dataMode",!1),Ze(this,"_vectorData",null),Ze(this,"x"),Ze(this,"y"),Ze(this,"z"),Ze(this,"isTile",!0),Ze(this,"parent",null),Ze(this,"children",[]),Ze(this,"_isReady",!1),Ze(this,"_isVirtualTile",!1),Ze(this,"_isVisible",!1),Ze(this,"_maxHeight",0),Ze(this,"distToCamera",0),Ze(this,"sizeInWorld",0),Ze(this,"_isLoaded",!1),Ze(this,"_inFrustum",!1),this.x=e,this.y=t,this.z=r,this.name=`Tile ${r}-${e}-${t}`,this.up.set(0,0,1),this.matrixAutoUpdate=!1}setDataOnlyMode(e){return this._dataMode=e,e&&(this.visible=!1),this}isDataOnlyMode(){return this._dataMode}getVectorData(){return this._vectorData}static get downloadThreads(){return Jn._activeDownloads}get isDummy(){return this._isVirtualTile}get showing(){return this._isVisible}set showing(e){const t=this._isVisible;this._isVisible=e,this.material.forEach(r=>r.visible=e),t===!1&&this._isVisible===!0&&this._isLoaded&&this.dispatchEvent({type:"tile-shown",tile:this}),t===!0&&this._isVisible===!1&&this.dispatchEvent({type:"tile-hidden",tile:this})}get maxZ(){return this._maxHeight}set maxZ(e){this._maxHeight=e}get index(){return this.parent?this.parent.children.indexOf(this):-1}get loaded(){return this._isLoaded}get inFrustum(){return this._inFrustum}set inFrustum(e){this._inFrustum=e}get isLeaf(){return this.children.filter(e=>e.isTile).length===0}traverse(e){e(this),this.children.forEach(t=>{t.isTile&&t.traverse(e)})}traverseVisible(e){this.visible&&(e(this),this.children.forEach(t=>{t.isTile&&t.traverseVisible(e)}))}raycast(e,t){this.showing&&this.loaded&&this.isTile&&super.raycast(e,t)}_updateLOD(e){if(Jn.downloadThreads>dd)return{action:un.none};let t=[];const{loader:r,minLevel:i,maxLevel:o,LODThreshold:l}=e,c=cd(this,i,o,l);return c===un.create&&(t=ud(r,this.x,this.y,this.z),this.add(...t)),{action:c,newTiles:t}}_checkVisibility(){const e=this.parent;if(e&&e.isTile){const t=e.children.filter(i=>i.isTile),r=t.every(i=>i.loaded);e.showing=!r,t.forEach(i=>i.showing=r)}return this}async _loadData(e){Jn._activeDownloads++;const{x:t,y:r,z:i}=this;if(this._dataMode)try{const o=await e.load({x:t,y:r,z:i,bounds:[-1/0,-1/0,1/0,1/0]});this._vectorData=o.geometry?.userData||{},this._isLoaded=!0,this.dispatchEvent({type:"vector-data-loaded",data:this._vectorData,tile:this})}catch(o){console.error(`数据模式加载失败 ${i}/${t}/${r}:`,o),this._isLoaded=!1}else{const o=await e.load({x:t,y:r,z:i,bounds:[-1/0,-1/0,1/0,1/0]});this.material=o.materials,this.geometry=o.geometry,this.maxZ=this.geometry.boundingBox?.max.z||0,this._isLoaded=!0}return Jn._activeDownloads--,this}_initTile(){this.updateMatrix(),this.updateMatrixWorld(),this.sizeInWorld=ad(this)}update(e){if(console.assert(this.z===0),!this.parent)return this;Ll.setFromProjectionMatrix(gd.multiplyMatrices(e.camera.projectionMatrix,e.camera.matrixWorldInverse));const t=e.camera.getWorldPosition(md);return this.traverse(r=>{r.receiveShadow=this.receiveShadow,r.castShadow=this.castShadow;const i=_d.clone().applyMatrix4(r.matrixWorld);r.inFrustum=Ll.intersectsBox(i),r.distToCamera=od(r,t);const{action:o,newTiles:l}=r._updateLOD(e);this._processLODAction(r,o,l,e)}),this._checkReadyState(),this}_processLODAction(e,t,r,i){return t===un.create?r?.forEach(o=>{o._initTile(),o._isVirtualTile=o.z<i.minLevel,this.dispatchEvent({type:"tile-created",tile:o}),o.isDummy||o._loadData(i.loader).then(()=>{o._checkVisibility(),this.dispatchEvent({type:"tile-loaded",tile:o})})}):t===un.remove&&(e.showing=!0,e._disposeResources(!1,i.loader),this.dispatchEvent({type:"tile-unload",tile:e})),this}reload(e){return this._disposeResources(!0,e),this}_checkReadyState(){return this._isReady||(this._isReady=!0,this.traverse(e=>{if(e.isLeaf&&e.loaded&&!e.isDummy){this._isReady=!1;return}}),this._isReady&&this.dispatchEvent({type:"ready"})),this}_disposeResources(e,t){return e&&this.isTile&&!this.isDummy&&(this.dispatchEvent({type:"unload"}),t?.unload?.(this)),this.children.forEach(r=>r._disposeResources(!0,t)),this.clear(),this}};Ze(Ol,"_activeDownloads",0);let ni=Ol;function vo(s,e){const t=s.getLayers().find(o=>o.isBaseLayer===!0);if(!t||!t._rootTile)return;const r=t._rootTile,i=e.intersectObjects([r]);for(const o of i)if(o.object instanceof ni){const l=o.point.clone(),c=s.unproject(l);return Object.assign(o,{location:c})}}function En(s,e){const t=new f.Vector3(0,-1,0),r=new f.Vector3(e.x,10*1e3,e.z),i=new f.Raycaster(r,t);return vo(s,i)}function wo(s,e,t){const r=new f.Raycaster;return r.setFromCamera(t,s),vo(e,r)}function yd(s,e){const t=s.projectToWorld(e);return En(s,t)}function vd(s,e){return e.getZoom()}var hn=function(){var s=0,e=document.createElement("div");e.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",e.addEventListener("click",function(m){m.preventDefault(),r(++s%e.children.length)},!1);function t(m){return e.appendChild(m.dom),m}function r(m){for(var p=0;p<e.children.length;p++)e.children[p].style.display=p===m?"block":"none";s=m}var i=(performance||Date).now(),o=i,l=0,c=t(new hn.Panel("FPS","#0ff","#002")),u=t(new hn.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var d=t(new hn.Panel("MB","#f08","#201"));return r(0),{REVISION:16,dom:e,addPanel:t,showPanel:r,begin:function(){i=(performance||Date).now()},end:function(){l++;var m=(performance||Date).now();if(u.update(m-i,200),m>=o+1e3&&(c.update(l*1e3/(m-o),100),o=m,l=0,d)){var p=performance.memory;d.update(p.usedJSHeapSize/1048576,p.jsHeapSizeLimit/1048576)}return m},update:function(){i=this.end()},domElement:e,setMode:r}};hn.Panel=function(s,e,t){var r=1/0,i=0,o=Math.round,l=o(window.devicePixelRatio||1),c=80*l,u=48*l,d=3*l,m=2*l,p=3*l,_=15*l,v=74*l,S=30*l,M=document.createElement("canvas");M.width=c,M.height=u,M.style.cssText="width:80px;height:48px";var x=M.getContext("2d");return x.font="bold "+9*l+"px Helvetica,Arial,sans-serif",x.textBaseline="top",x.fillStyle=t,x.fillRect(0,0,c,u),x.fillStyle=e,x.fillText(s,d,m),x.fillRect(p,_,v,S),x.fillStyle=t,x.globalAlpha=.9,x.fillRect(p,_,v,S),{dom:M,update:function(O,P){r=Math.min(r,O),i=Math.max(i,O),x.fillStyle=t,x.globalAlpha=1,x.fillRect(0,0,c,_),x.fillStyle=e,x.fillText(o(O)+" "+s+" ("+o(r)+"-"+o(i)+")",d,m),x.drawImage(M,p+l,_,v-l,S,p,_,v-l,S),x.fillRect(p+v-l,_,l,S),x.fillStyle=t,x.globalAlpha=.9,x.fillRect(p+v-l,_,l,o((1-O/P)*S))}}};const Hn=parseInt(f.REVISION.replace(/\D+/g,"")),bo=Hn>=125?"uv1":"uv2";function Dl(s,e){if(e===f.TrianglesDrawMode)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),s;if(e===f.TriangleFanDrawMode||e===f.TriangleStripDrawMode){let t=s.getIndex();if(t===null){const l=[],c=s.getAttribute("position");if(c!==void 0){for(let u=0;u<c.count;u++)l.push(u);s.setIndex(l),t=s.getIndex()}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),s}const r=t.count-2,i=[];if(t)if(e===f.TriangleFanDrawMode)for(let l=1;l<=r;l++)i.push(t.getX(0)),i.push(t.getX(l)),i.push(t.getX(l+1));else for(let l=0;l<r;l++)l%2===0?(i.push(t.getX(l)),i.push(t.getX(l+1)),i.push(t.getX(l+2))):(i.push(t.getX(l+2)),i.push(t.getX(l+1)),i.push(t.getX(l)));i.length/3!==r&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const o=s.clone();return o.setIndex(i),o.clearGroups(),o}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",e),s}var Tt=Uint8Array,Tr=Uint16Array,xo=Uint32Array,Il=new Tt([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Fl=new Tt([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),wd=new Tt([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Tl=function(s,e){for(var t=new Tr(31),r=0;r<31;++r)t[r]=e+=1<<s[r-1];for(var i=new xo(t[30]),r=1;r<30;++r)for(var o=t[r];o<t[r+1];++o)i[o]=o-t[r]<<5|r;return[t,i]},Bl=Tl(Il,2),Ul=Bl[0],bd=Bl[1];Ul[28]=258,bd[258]=28;for(var xd=Tl(Fl,0),Sd=xd[0],So=new Tr(32768),Ie=0;Ie<32768;++Ie){var Br=(Ie&43690)>>>1|(Ie&21845)<<1;Br=(Br&52428)>>>2|(Br&13107)<<2,Br=(Br&61680)>>>4|(Br&3855)<<4,So[Ie]=((Br&65280)>>>8|(Br&255)<<8)>>>1}for(var fn=(function(s,e,t){for(var r=s.length,i=0,o=new Tr(e);i<r;++i)++o[s[i]-1];var l=new Tr(e);for(i=0;i<e;++i)l[i]=l[i-1]+o[i-1]<<1;var c;if(t){c=new Tr(1<<e);var u=15-e;for(i=0;i<r;++i)if(s[i])for(var d=i<<4|s[i],m=e-s[i],p=l[s[i]-1]++<<m,_=p|(1<<m)-1;p<=_;++p)c[So[p]>>>u]=d}else for(c=new Tr(r),i=0;i<r;++i)s[i]&&(c[i]=So[l[s[i]-1]++]>>>15-s[i]);return c}),dn=new Tt(288),Ie=0;Ie<144;++Ie)dn[Ie]=8;for(var Ie=144;Ie<256;++Ie)dn[Ie]=9;for(var Ie=256;Ie<280;++Ie)dn[Ie]=7;for(var Ie=280;Ie<288;++Ie)dn[Ie]=8;for(var Vl=new Tt(32),Ie=0;Ie<32;++Ie)Vl[Ie]=5;var Md=fn(dn,9,1),Ad=fn(Vl,5,1),Mo=function(s){for(var e=s[0],t=1;t<s.length;++t)s[t]>e&&(e=s[t]);return e},Yt=function(s,e,t){var r=e/8|0;return(s[r]|s[r+1]<<8)>>(e&7)&t},Ao=function(s,e){var t=e/8|0;return(s[t]|s[t+1]<<8|s[t+2]<<16)>>(e&7)},Pd=function(s){return(s/8|0)+(s&7&&1)},Cd=function(s,e,t){(t==null||t>s.length)&&(t=s.length);var r=new(s instanceof Tr?Tr:s instanceof xo?xo:Tt)(t-e);return r.set(s.subarray(e,t)),r},Ld=function(s,e,t){var r=s.length;if(!r||t&&!t.l&&r<5)return e||new Tt(0);var i=!e||t,o=!t||t.i;t||(t={}),e||(e=new Tt(r*3));var l=function(Vt){var Jt=e.length;if(Vt>Jt){var gt=new Tt(Math.max(Jt*2,Vt));gt.set(e),e=gt}},c=t.f||0,u=t.p||0,d=t.b||0,m=t.l,p=t.d,_=t.m,v=t.n,S=r*8;do{if(!m){t.f=c=Yt(s,u,1);var M=Yt(s,u+1,3);if(u+=3,M)if(M==1)m=Md,p=Ad,_=9,v=5;else if(M==2){var C=Yt(s,u,31)+257,T=Yt(s,u+10,15)+4,N=C+Yt(s,u+5,31)+1;u+=14;for(var X=new Tt(N),R=new Tt(19),U=0;U<T;++U)R[wd[U]]=Yt(s,u+U*3,7);u+=T*3;for(var $=Mo(R),z=(1<<$)-1,V=fn(R,$,1),U=0;U<N;){var Y=V[Yt(s,u,z)];u+=Y&15;var x=Y>>>4;if(x<16)X[U++]=x;else{var Q=0,K=0;for(x==16?(K=3+Yt(s,u,3),u+=2,Q=X[U-1]):x==17?(K=3+Yt(s,u,7),u+=3):x==18&&(K=11+Yt(s,u,127),u+=7);K--;)X[U++]=Q}}var te=X.subarray(0,C),H=X.subarray(C);_=Mo(te),v=Mo(H),m=fn(te,_,1),p=fn(H,v,1)}else throw"invalid block type";else{var x=Pd(u)+4,O=s[x-4]|s[x-3]<<8,P=x+O;if(P>r){if(o)throw"unexpected EOF";break}i&&l(d+O),e.set(s.subarray(x,P),d),t.b=d+=O,t.p=u=P*8;continue}if(u>S){if(o)throw"unexpected EOF";break}}i&&l(d+131072);for(var Pe=(1<<_)-1,ve=(1<<v)-1,we=u;;we=u){var Q=m[Ao(s,u)&Pe],me=Q>>>4;if(u+=Q&15,u>S){if(o)throw"unexpected EOF";break}if(!Q)throw"invalid length/literal";if(me<256)e[d++]=me;else if(me==256){we=u,m=null;break}else{var Ce=me-254;if(me>264){var U=me-257,Le=Il[U];Ce=Yt(s,u,(1<<Le)-1)+Ul[U],u+=Le}var Oe=p[Ao(s,u)&ve],lt=Oe>>>4;if(!Oe)throw"invalid distance";u+=Oe&15;var H=Sd[lt];if(lt>3){var Le=Fl[lt];H+=Ao(s,u)&(1<<Le)-1,u+=Le}if(u>S){if(o)throw"unexpected EOF";break}i&&l(d+131072);for(var ct=d+Ce;d<ct;d+=4)e[d]=e[d-H],e[d+1]=e[d+1-H],e[d+2]=e[d+2-H],e[d+3]=e[d+3-H];d=ct}}t.l=m,t.p=we,t.b=d,m&&(c=1,t.m=_,t.d=p,t.n=v)}while(!c);return d==e.length?e:Cd(e,0,d)},Od=new Tt(0),Dd=function(s){if((s[0]&15)!=8||s[0]>>>4>7||(s[0]<<8|s[1])%31)throw"invalid zlib data";if(s[1]&32)throw"invalid zlib data: preset dictionaries not supported"};function Id(s,e){return Ld((Dd(s),s.subarray(2,-4)),e)}var Fd=typeof TextDecoder<"u"&&new TextDecoder,Td=0;try{Fd.decode(Od,{stream:!0}),Td=1}catch{}class Bd extends f.Mesh{constructor(e,t={}){super(e),this.isWater=!0;const r=this,i=t.textureWidth!==void 0?t.textureWidth:512,o=t.textureHeight!==void 0?t.textureHeight:512,l=t.clipBias!==void 0?t.clipBias:0,c=t.alpha!==void 0?t.alpha:1,u=t.time!==void 0?t.time:0,d=t.waterNormals!==void 0?t.waterNormals:null,m=t.sunDirection!==void 0?t.sunDirection:new f.Vector3(.70707,.70707,0),p=new f.Color(t.sunColor!==void 0?t.sunColor:16777215),_=new f.Color(t.waterColor!==void 0?t.waterColor:8355711),v=t.eye!==void 0?t.eye:new f.Vector3(0,0,0),S=t.distortionScale!==void 0?t.distortionScale:20,M=t.side!==void 0?t.side:f.FrontSide,x=t.fog!==void 0?t.fog:!1,O=new f.Plane,P=new f.Vector3,C=new f.Vector3,T=new f.Vector3,N=new f.Matrix4,X=new f.Vector3(0,0,-1),R=new f.Vector4,U=new f.Vector3,$=new f.Vector3,z=new f.Vector4,V=new f.Matrix4,Y=new f.PerspectiveCamera,Q=new f.WebGLRenderTarget(i,o),K={uniforms:f.UniformsUtils.merge([f.UniformsLib.fog,f.UniformsLib.lights,{normalSampler:{value:null},mirrorSampler:{value:null},alpha:{value:1},time:{value:0},size:{value:1},distortionScale:{value:20},textureMatrix:{value:new f.Matrix4},sunColor:{value:new f.Color(8355711)},sunDirection:{value:new f.Vector3(.70707,.70707,0)},eye:{value:new f.Vector3},waterColor:{value:new f.Color(5592405)}}]),vertexShader:`
				uniform mat4 textureMatrix;
				uniform float time;

				varying vec4 mirrorCoord;
				varying vec4 worldPosition;

				#include <common>
				#include <fog_pars_vertex>
				#include <shadowmap_pars_vertex>
				#include <logdepthbuf_pars_vertex>

				void main() {
					mirrorCoord = modelMatrix * vec4( position, 1.0 );
					worldPosition = mirrorCoord.xyzw;
					mirrorCoord = textureMatrix * mirrorCoord;
					vec4 mvPosition =  modelViewMatrix * vec4( position, 1.0 );
					gl_Position = projectionMatrix * mvPosition;

				#include <beginnormal_vertex>
				#include <defaultnormal_vertex>
				#include <logdepthbuf_vertex>
				#include <fog_vertex>
				#include <shadowmap_vertex>
			}`,fragmentShader:`
				uniform sampler2D mirrorSampler;
				uniform float alpha;
				uniform float time;
				uniform float size;
				uniform float distortionScale;
				uniform sampler2D normalSampler;
				uniform vec3 sunColor;
				uniform vec3 sunDirection;
				uniform vec3 eye;
				uniform vec3 waterColor;

				varying vec4 mirrorCoord;
				varying vec4 worldPosition;

				vec4 getNoise( vec2 uv ) {
					vec2 uv0 = ( uv / 103.0 ) + vec2(time / 17.0, time / 29.0);
					vec2 uv1 = uv / 107.0-vec2( time / -19.0, time / 31.0 );
					vec2 uv2 = uv / vec2( 8907.0, 9803.0 ) + vec2( time / 101.0, time / 97.0 );
					vec2 uv3 = uv / vec2( 1091.0, 1027.0 ) - vec2( time / 109.0, time / -113.0 );
					vec4 noise = texture2D( normalSampler, uv0 ) +
						texture2D( normalSampler, uv1 ) +
						texture2D( normalSampler, uv2 ) +
						texture2D( normalSampler, uv3 );
					return noise * 0.5 - 1.0;
				}

				void sunLight( const vec3 surfaceNormal, const vec3 eyeDirection, float shiny, float spec, float diffuse, inout vec3 diffuseColor, inout vec3 specularColor ) {
					vec3 reflection = normalize( reflect( -sunDirection, surfaceNormal ) );
					float direction = max( 0.0, dot( eyeDirection, reflection ) );
					specularColor += pow( direction, shiny ) * sunColor * spec;
					diffuseColor += max( dot( sunDirection, surfaceNormal ), 0.0 ) * sunColor * diffuse;
				}

				#include <common>
				#include <packing>
				#include <bsdfs>
				#include <fog_pars_fragment>
				#include <logdepthbuf_pars_fragment>
				#include <lights_pars_begin>
				#include <shadowmap_pars_fragment>
				#include <shadowmask_pars_fragment>

				void main() {

					#include <logdepthbuf_fragment>
					vec4 noise = getNoise( worldPosition.xz * size );
					vec3 surfaceNormal = normalize( noise.xzy * vec3( 1.5, 1.0, 1.5 ) );

					vec3 diffuseLight = vec3(0.0);
					vec3 specularLight = vec3(0.0);

					vec3 worldToEye = eye-worldPosition.xyz;
					vec3 eyeDirection = normalize( worldToEye );
					sunLight( surfaceNormal, eyeDirection, 100.0, 2.0, 0.5, diffuseLight, specularLight );

					float distance = length(worldToEye);

					vec2 distortion = surfaceNormal.xz * ( 0.001 + 1.0 / distance ) * distortionScale;
					vec3 reflectionSample = vec3( texture2D( mirrorSampler, mirrorCoord.xy / mirrorCoord.w + distortion ) );

					float theta = max( dot( eyeDirection, surfaceNormal ), 0.0 );
					float rf0 = 0.3;
					float reflectance = rf0 + ( 1.0 - rf0 ) * pow( ( 1.0 - theta ), 5.0 );
					vec3 scatter = max( 0.0, dot( surfaceNormal, eyeDirection ) ) * waterColor;
					vec3 albedo = mix( ( sunColor * diffuseLight * 0.3 + scatter ) * getShadowMask(), ( vec3( 0.1 ) + reflectionSample * 0.9 + reflectionSample * specularLight ), reflectance);
					vec3 outgoingLight = albedo;
					gl_FragColor = vec4( outgoingLight, alpha );

					#include <tonemapping_fragment>
					#include <${Hn>=154?"colorspace_fragment":"encodings_fragment"}>
					#include <fog_fragment>	
				}`},te=new f.ShaderMaterial({fragmentShader:K.fragmentShader,vertexShader:K.vertexShader,uniforms:f.UniformsUtils.clone(K.uniforms),lights:!0,side:M,fog:x});te.uniforms.mirrorSampler.value=Q.texture,te.uniforms.textureMatrix.value=V,te.uniforms.alpha.value=c,te.uniforms.time.value=u,te.uniforms.normalSampler.value=d,te.uniforms.sunColor.value=p,te.uniforms.waterColor.value=_,te.uniforms.sunDirection.value=m,te.uniforms.distortionScale.value=S,te.uniforms.eye.value=v,r.material=te,r.onBeforeRender=function(H,Pe,ve){if(C.setFromMatrixPosition(r.matrixWorld),T.setFromMatrixPosition(ve.matrixWorld),N.extractRotation(r.matrixWorld),P.set(0,0,1),P.applyMatrix4(N),U.subVectors(C,T),U.dot(P)>0)return;U.reflect(P).negate(),U.add(C),N.extractRotation(ve.matrixWorld),X.set(0,0,-1),X.applyMatrix4(N),X.add(T),$.subVectors(C,X),$.reflect(P).negate(),$.add(C),Y.position.copy(U),Y.up.set(0,1,0),Y.up.applyMatrix4(N),Y.up.reflect(P),Y.lookAt($),Y.far=ve.far,Y.updateMatrixWorld(),Y.projectionMatrix.copy(ve.projectionMatrix),V.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),V.multiply(Y.projectionMatrix),V.multiply(Y.matrixWorldInverse),O.setFromNormalAndCoplanarPoint(P,C),O.applyMatrix4(Y.matrixWorldInverse),R.set(O.normal.x,O.normal.y,O.normal.z,O.constant);const we=Y.projectionMatrix;z.x=(Math.sign(R.x)+we.elements[8])/we.elements[0],z.y=(Math.sign(R.y)+we.elements[9])/we.elements[5],z.z=-1,z.w=(1+we.elements[10])/we.elements[14],R.multiplyScalar(2/R.dot(z)),we.elements[2]=R.x,we.elements[6]=R.y,we.elements[10]=R.z+1-l,we.elements[14]=R.w,v.setFromMatrixPosition(ve.matrixWorld);const me=H.getRenderTarget(),Ce=H.xr.enabled,Le=H.shadowMap.autoUpdate;r.visible=!1,H.xr.enabled=!1,H.shadowMap.autoUpdate=!1,H.setRenderTarget(Q),H.state.buffers.depth.setMask(!0),H.autoClear===!1&&H.clear(),H.render(Pe,Y),r.visible=!0,H.xr.enabled=Ce,H.shadowMap.autoUpdate=Le,H.setRenderTarget(me);const Oe=ve.viewport;Oe!==void 0&&H.state.viewport(Oe)}}}var Ud=Object.defineProperty,Vd=(s,e,t)=>e in s?Ud(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,kd=(s,e,t)=>(Vd(s,e+"",t),t);class zd{constructor(){kd(this,"_listeners")}addEventListener(e,t){this._listeners===void 0&&(this._listeners={});const r=this._listeners;r[e]===void 0&&(r[e]=[]),r[e].indexOf(t)===-1&&r[e].push(t)}hasEventListener(e,t){if(this._listeners===void 0)return!1;const r=this._listeners;return r[e]!==void 0&&r[e].indexOf(t)!==-1}removeEventListener(e,t){if(this._listeners===void 0)return;const i=this._listeners[e];if(i!==void 0){const o=i.indexOf(t);o!==-1&&i.splice(o,1)}}dispatchEvent(e){if(this._listeners===void 0)return;const r=this._listeners[e.type];if(r!==void 0){e.target=this;const i=r.slice(0);for(let o=0,l=i.length;o<l;o++)i[o].call(this,e);e.target=null}}}var Nd=Object.defineProperty,Wd=(s,e,t)=>e in s?Nd(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,re=(s,e,t)=>(Wd(s,typeof e!="symbol"?e+"":e,t),t);const es=new f.Ray,kl=new f.Plane,Gd=Math.cos(70*(Math.PI/180)),zl=(s,e)=>(s%e+e)%e;class Rd extends zd{constructor(e,t){super(),re(this,"object"),re(this,"domElement"),re(this,"enabled",!0),re(this,"target",new f.Vector3),re(this,"minDistance",0),re(this,"maxDistance",1/0),re(this,"minZoom",0),re(this,"maxZoom",1/0),re(this,"minPolarAngle",0),re(this,"maxPolarAngle",Math.PI),re(this,"minAzimuthAngle",-1/0),re(this,"maxAzimuthAngle",1/0),re(this,"enableDamping",!1),re(this,"dampingFactor",.05),re(this,"enableZoom",!0),re(this,"zoomSpeed",1),re(this,"enableRotate",!0),re(this,"rotateSpeed",1),re(this,"enablePan",!0),re(this,"panSpeed",1),re(this,"screenSpacePanning",!0),re(this,"keyPanSpeed",7),re(this,"zoomToCursor",!1),re(this,"autoRotate",!1),re(this,"autoRotateSpeed",2),re(this,"reverseOrbit",!1),re(this,"reverseHorizontalOrbit",!1),re(this,"reverseVerticalOrbit",!1),re(this,"keys",{LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"}),re(this,"mouseButtons",{LEFT:f.MOUSE.ROTATE,MIDDLE:f.MOUSE.DOLLY,RIGHT:f.MOUSE.PAN}),re(this,"touches",{ONE:f.TOUCH.ROTATE,TWO:f.TOUCH.DOLLY_PAN}),re(this,"target0"),re(this,"position0"),re(this,"zoom0"),re(this,"_domElementKeyEvents",null),re(this,"getPolarAngle"),re(this,"getAzimuthalAngle"),re(this,"setPolarAngle"),re(this,"setAzimuthalAngle"),re(this,"getDistance"),re(this,"getZoomScale"),re(this,"listenToKeyEvents"),re(this,"stopListenToKeyEvents"),re(this,"saveState"),re(this,"reset"),re(this,"update"),re(this,"connect"),re(this,"dispose"),re(this,"dollyIn"),re(this,"dollyOut"),re(this,"getScale"),re(this,"setScale"),this.object=e,this.domElement=t,this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.getPolarAngle=()=>m.phi,this.getAzimuthalAngle=()=>m.theta,this.setPolarAngle=F=>{let Z=zl(F,2*Math.PI),oe=m.phi;oe<0&&(oe+=2*Math.PI),Z<0&&(Z+=2*Math.PI);let ye=Math.abs(Z-oe);2*Math.PI-ye<ye&&(Z<oe?Z+=2*Math.PI:oe+=2*Math.PI),p.phi=Z-oe,r.update()},this.setAzimuthalAngle=F=>{let Z=zl(F,2*Math.PI),oe=m.theta;oe<0&&(oe+=2*Math.PI),Z<0&&(Z+=2*Math.PI);let ye=Math.abs(Z-oe);2*Math.PI-ye<ye&&(Z<oe?Z+=2*Math.PI:oe+=2*Math.PI),p.theta=Z-oe,r.update()},this.getDistance=()=>r.object.position.distanceTo(r.target),this.listenToKeyEvents=F=>{F.addEventListener("keydown",pr),this._domElementKeyEvents=F},this.stopListenToKeyEvents=()=>{this._domElementKeyEvents.removeEventListener("keydown",pr),this._domElementKeyEvents=null},this.saveState=()=>{r.target0.copy(r.target),r.position0.copy(r.object.position),r.zoom0=r.object.zoom},this.reset=()=>{r.target.copy(r.target0),r.object.position.copy(r.position0),r.object.zoom=r.zoom0,r.object.updateProjectionMatrix(),r.dispatchEvent(i),r.update(),u=c.NONE},this.update=(()=>{const F=new f.Vector3,Z=new f.Vector3(0,1,0),oe=new f.Quaternion().setFromUnitVectors(e.up,Z),ye=oe.clone().invert(),Re=new f.Vector3,kt=new f.Quaternion,er=2*Math.PI;return function(){const Ls=r.object.position;oe.setFromUnitVectors(e.up,Z),ye.copy(oe).invert(),F.copy(Ls).sub(r.target),F.applyQuaternion(oe),m.setFromVector3(F),r.autoRotate&&u===c.NONE&&K(Y()),r.enableDamping?(m.theta+=p.theta*r.dampingFactor,m.phi+=p.phi*r.dampingFactor):(m.theta+=p.theta,m.phi+=p.phi);let tr=r.minAzimuthAngle,rr=r.maxAzimuthAngle;isFinite(tr)&&isFinite(rr)&&(tr<-Math.PI?tr+=er:tr>Math.PI&&(tr-=er),rr<-Math.PI?rr+=er:rr>Math.PI&&(rr-=er),tr<=rr?m.theta=Math.max(tr,Math.min(rr,m.theta)):m.theta=m.theta>(tr+rr)/2?Math.max(tr,m.theta):Math.min(rr,m.theta)),m.phi=Math.max(r.minPolarAngle,Math.min(r.maxPolarAngle,m.phi)),m.makeSafe(),r.enableDamping===!0?r.target.addScaledVector(v,r.dampingFactor):r.target.add(v),r.zoomToCursor&&$||r.object.isOrthographicCamera?m.radius=Oe(m.radius):m.radius=Oe(m.radius*_),F.setFromSpherical(m),F.applyQuaternion(ye),Ls.copy(r.target).add(F),r.object.matrixAutoUpdate||r.object.updateMatrix(),r.object.lookAt(r.target),r.enableDamping===!0?(p.theta*=1-r.dampingFactor,p.phi*=1-r.dampingFactor,v.multiplyScalar(1-r.dampingFactor)):(p.set(0,0,0),v.set(0,0,0));let Kr=!1;if(r.zoomToCursor&&$){let bi=null;if(r.object instanceof f.PerspectiveCamera&&r.object.isPerspectiveCamera){const xi=F.length();bi=Oe(xi*_);const Zi=xi-bi;r.object.position.addScaledVector(R,Zi),r.object.updateMatrixWorld()}else if(r.object.isOrthographicCamera){const xi=new f.Vector3(U.x,U.y,0);xi.unproject(r.object),r.object.zoom=Math.max(r.minZoom,Math.min(r.maxZoom,r.object.zoom/_)),r.object.updateProjectionMatrix(),Kr=!0;const Zi=new f.Vector3(U.x,U.y,0);Zi.unproject(r.object),r.object.position.sub(Zi).add(xi),r.object.updateMatrixWorld(),bi=F.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),r.zoomToCursor=!1;bi!==null&&(r.screenSpacePanning?r.target.set(0,0,-1).transformDirection(r.object.matrix).multiplyScalar(bi).add(r.object.position):(es.origin.copy(r.object.position),es.direction.set(0,0,-1).transformDirection(r.object.matrix),Math.abs(r.object.up.dot(es.direction))<Gd?e.lookAt(r.target):(kl.setFromNormalAndCoplanarPoint(r.object.up,r.target),es.intersectPlane(kl,r.target))))}else r.object instanceof f.OrthographicCamera&&r.object.isOrthographicCamera&&(Kr=_!==1,Kr&&(r.object.zoom=Math.max(r.minZoom,Math.min(r.maxZoom,r.object.zoom/_)),r.object.updateProjectionMatrix()));return _=1,$=!1,Kr||Re.distanceToSquared(r.object.position)>d||8*(1-kt.dot(r.object.quaternion))>d?(r.dispatchEvent(i),Re.copy(r.object.position),kt.copy(r.object.quaternion),Kr=!1,!0):!1}})(),this.connect=F=>{r.domElement=F,r.domElement.style.touchAction="none",r.domElement.addEventListener("contextmenu",Xi),r.domElement.addEventListener("pointerdown",Xr),r.domElement.addEventListener("pointercancel",yi),r.domElement.addEventListener("wheel",Zr)},this.dispose=()=>{var F,Z,oe,ye,Re,kt;r.domElement&&(r.domElement.style.touchAction="auto"),(F=r.domElement)==null||F.removeEventListener("contextmenu",Xi),(Z=r.domElement)==null||Z.removeEventListener("pointerdown",Xr),(oe=r.domElement)==null||oe.removeEventListener("pointercancel",yi),(ye=r.domElement)==null||ye.removeEventListener("wheel",Zr),(Re=r.domElement)==null||Re.ownerDocument.removeEventListener("pointermove",Yr),(kt=r.domElement)==null||kt.ownerDocument.removeEventListener("pointerup",yi),r._domElementKeyEvents!==null&&r._domElementKeyEvents.removeEventListener("keydown",pr)};const r=this,i={type:"change"},o={type:"start"},l={type:"end"},c={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let u=c.NONE;const d=1e-6,m=new f.Spherical,p=new f.Spherical;let _=1;const v=new f.Vector3,S=new f.Vector2,M=new f.Vector2,x=new f.Vector2,O=new f.Vector2,P=new f.Vector2,C=new f.Vector2,T=new f.Vector2,N=new f.Vector2,X=new f.Vector2,R=new f.Vector3,U=new f.Vector2;let $=!1;const z=[],V={};function Y(){return 2*Math.PI/60/60*r.autoRotateSpeed}function Q(){return Math.pow(.95,r.zoomSpeed)}function K(F){r.reverseOrbit||r.reverseHorizontalOrbit?p.theta+=F:p.theta-=F}function te(F){r.reverseOrbit||r.reverseVerticalOrbit?p.phi+=F:p.phi-=F}const H=(()=>{const F=new f.Vector3;return function(oe,ye){F.setFromMatrixColumn(ye,0),F.multiplyScalar(-oe),v.add(F)}})(),Pe=(()=>{const F=new f.Vector3;return function(oe,ye){r.screenSpacePanning===!0?F.setFromMatrixColumn(ye,1):(F.setFromMatrixColumn(ye,0),F.crossVectors(r.object.up,F)),F.multiplyScalar(oe),v.add(F)}})(),ve=(()=>{const F=new f.Vector3;return function(oe,ye){const Re=r.domElement;if(Re&&r.object instanceof f.PerspectiveCamera&&r.object.isPerspectiveCamera){const kt=r.object.position;F.copy(kt).sub(r.target);let er=F.length();er*=Math.tan(r.object.fov/2*Math.PI/180),H(2*oe*er/Re.clientHeight,r.object.matrix),Pe(2*ye*er/Re.clientHeight,r.object.matrix)}else Re&&r.object instanceof f.OrthographicCamera&&r.object.isOrthographicCamera?(H(oe*(r.object.right-r.object.left)/r.object.zoom/Re.clientWidth,r.object.matrix),Pe(ye*(r.object.top-r.object.bottom)/r.object.zoom/Re.clientHeight,r.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),r.enablePan=!1)}})();function we(F){r.object instanceof f.PerspectiveCamera&&r.object.isPerspectiveCamera||r.object instanceof f.OrthographicCamera&&r.object.isOrthographicCamera?_=F:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),r.enableZoom=!1)}function me(F){we(_/F)}function Ce(F){we(_*F)}function Le(F){if(!r.zoomToCursor||!r.domElement)return;$=!0;const Z=r.domElement.getBoundingClientRect(),oe=F.clientX-Z.left,ye=F.clientY-Z.top,Re=Z.width,kt=Z.height;U.x=oe/Re*2-1,U.y=-(ye/kt)*2+1,R.set(U.x,U.y,1).unproject(r.object).sub(r.object.position).normalize()}function Oe(F){return Math.max(r.minDistance,Math.min(r.maxDistance,F))}function lt(F){S.set(F.clientX,F.clientY)}function ct(F){Le(F),T.set(F.clientX,F.clientY)}function Vt(F){O.set(F.clientX,F.clientY)}function Jt(F){M.set(F.clientX,F.clientY),x.subVectors(M,S).multiplyScalar(r.rotateSpeed);const Z=r.domElement;Z&&(K(2*Math.PI*x.x/Z.clientHeight),te(2*Math.PI*x.y/Z.clientHeight)),S.copy(M),r.update()}function gt(F){N.set(F.clientX,F.clientY),X.subVectors(N,T),X.y>0?me(Q()):X.y<0&&Ce(Q()),T.copy(N),r.update()}function Et(F){P.set(F.clientX,F.clientY),C.subVectors(P,O).multiplyScalar(r.panSpeed),ve(C.x,C.y),O.copy(P),r.update()}function ji(F){Le(F),F.deltaY<0?Ce(Q()):F.deltaY>0&&me(Q()),r.update()}function xr(F){let Z=!1;switch(F.code){case r.keys.UP:ve(0,r.keyPanSpeed),Z=!0;break;case r.keys.BOTTOM:ve(0,-r.keyPanSpeed),Z=!0;break;case r.keys.LEFT:ve(r.keyPanSpeed,0),Z=!0;break;case r.keys.RIGHT:ve(-r.keyPanSpeed,0),Z=!0;break}Z&&(F.preventDefault(),r.update())}function Ht(){if(z.length==1)S.set(z[0].pageX,z[0].pageY);else{const F=.5*(z[0].pageX+z[1].pageX),Z=.5*(z[0].pageY+z[1].pageY);S.set(F,Z)}}function Sr(){if(z.length==1)O.set(z[0].pageX,z[0].pageY);else{const F=.5*(z[0].pageX+z[1].pageX),Z=.5*(z[0].pageY+z[1].pageY);O.set(F,Z)}}function Ge(){const F=z[0].pageX-z[1].pageX,Z=z[0].pageY-z[1].pageY,oe=Math.sqrt(F*F+Z*Z);T.set(0,oe)}function At(){r.enableZoom&&Ge(),r.enablePan&&Sr()}function mi(){r.enableZoom&&Ge(),r.enableRotate&&Ht()}function _t(F){if(z.length==1)M.set(F.pageX,F.pageY);else{const oe=wi(F),ye=.5*(F.pageX+oe.x),Re=.5*(F.pageY+oe.y);M.set(ye,Re)}x.subVectors(M,S).multiplyScalar(r.rotateSpeed);const Z=r.domElement;Z&&(K(2*Math.PI*x.x/Z.clientHeight),te(2*Math.PI*x.y/Z.clientHeight)),S.copy(M)}function gi(F){if(z.length==1)P.set(F.pageX,F.pageY);else{const Z=wi(F),oe=.5*(F.pageX+Z.x),ye=.5*(F.pageY+Z.y);P.set(oe,ye)}C.subVectors(P,O).multiplyScalar(r.panSpeed),ve(C.x,C.y),O.copy(P)}function $i(F){const Z=wi(F),oe=F.pageX-Z.x,ye=F.pageY-Z.y,Re=Math.sqrt(oe*oe+ye*ye);N.set(0,Re),X.set(0,Math.pow(N.y/T.y,r.zoomSpeed)),me(X.y),T.copy(N)}function _i(F){r.enableZoom&&$i(F),r.enablePan&&gi(F)}function Pt(F){r.enableZoom&&$i(F),r.enableRotate&&_t(F)}function Xr(F){var Z,oe;r.enabled!==!1&&(z.length===0&&((Z=r.domElement)==null||Z.ownerDocument.addEventListener("pointermove",Yr),(oe=r.domElement)==null||oe.ownerDocument.addEventListener("pointerup",yi)),Bn(F),F.pointerType==="touch"?Fn(F):vi(F))}function Yr(F){r.enabled!==!1&&(F.pointerType==="touch"?Tn(F):ma(F))}function yi(F){var Z,oe,ye;Un(F),z.length===0&&((Z=r.domElement)==null||Z.releasePointerCapture(F.pointerId),(oe=r.domElement)==null||oe.ownerDocument.removeEventListener("pointermove",Yr),(ye=r.domElement)==null||ye.ownerDocument.removeEventListener("pointerup",yi)),r.dispatchEvent(l),u=c.NONE}function vi(F){let Z;switch(F.button){case 0:Z=r.mouseButtons.LEFT;break;case 1:Z=r.mouseButtons.MIDDLE;break;case 2:Z=r.mouseButtons.RIGHT;break;default:Z=-1}switch(Z){case f.MOUSE.DOLLY:if(r.enableZoom===!1)return;ct(F),u=c.DOLLY;break;case f.MOUSE.ROTATE:if(F.ctrlKey||F.metaKey||F.shiftKey){if(r.enablePan===!1)return;Vt(F),u=c.PAN}else{if(r.enableRotate===!1)return;lt(F),u=c.ROTATE}break;case f.MOUSE.PAN:if(F.ctrlKey||F.metaKey||F.shiftKey){if(r.enableRotate===!1)return;lt(F),u=c.ROTATE}else{if(r.enablePan===!1)return;Vt(F),u=c.PAN}break;default:u=c.NONE}u!==c.NONE&&r.dispatchEvent(o)}function ma(F){if(r.enabled!==!1)switch(u){case c.ROTATE:if(r.enableRotate===!1)return;Jt(F);break;case c.DOLLY:if(r.enableZoom===!1)return;gt(F);break;case c.PAN:if(r.enablePan===!1)return;Et(F);break}}function Zr(F){r.enabled===!1||r.enableZoom===!1||u!==c.NONE&&u!==c.ROTATE||(F.preventDefault(),r.dispatchEvent(o),ji(F),r.dispatchEvent(l))}function pr(F){r.enabled===!1||r.enablePan===!1||xr(F)}function Fn(F){switch(Yi(F),z.length){case 1:switch(r.touches.ONE){case f.TOUCH.ROTATE:if(r.enableRotate===!1)return;Ht(),u=c.TOUCH_ROTATE;break;case f.TOUCH.PAN:if(r.enablePan===!1)return;Sr(),u=c.TOUCH_PAN;break;default:u=c.NONE}break;case 2:switch(r.touches.TWO){case f.TOUCH.DOLLY_PAN:if(r.enableZoom===!1&&r.enablePan===!1)return;At(),u=c.TOUCH_DOLLY_PAN;break;case f.TOUCH.DOLLY_ROTATE:if(r.enableZoom===!1&&r.enableRotate===!1)return;mi(),u=c.TOUCH_DOLLY_ROTATE;break;default:u=c.NONE}break;default:u=c.NONE}u!==c.NONE&&r.dispatchEvent(o)}function Tn(F){switch(Yi(F),u){case c.TOUCH_ROTATE:if(r.enableRotate===!1)return;_t(F),r.update();break;case c.TOUCH_PAN:if(r.enablePan===!1)return;gi(F),r.update();break;case c.TOUCH_DOLLY_PAN:if(r.enableZoom===!1&&r.enablePan===!1)return;_i(F),r.update();break;case c.TOUCH_DOLLY_ROTATE:if(r.enableZoom===!1&&r.enableRotate===!1)return;Pt(F),r.update();break;default:u=c.NONE}}function Xi(F){r.enabled!==!1&&F.preventDefault()}function Bn(F){z.push(F)}function Un(F){delete V[F.pointerId];for(let Z=0;Z<z.length;Z++)if(z[Z].pointerId==F.pointerId){z.splice(Z,1);return}}function Yi(F){let Z=V[F.pointerId];Z===void 0&&(Z=new f.Vector2,V[F.pointerId]=Z),Z.set(F.pageX,F.pageY)}function wi(F){const Z=F.pointerId===z[0].pointerId?z[1]:z[0];return V[Z.pointerId]}this.dollyIn=(F=Q())=>{Ce(F),r.update()},this.dollyOut=(F=Q())=>{me(F),r.update()},this.getScale=()=>_,this.setScale=F=>{we(F),r.update()},this.getZoomScale=()=>Q(),t!==void 0&&this.connect(t),this.update()}}class jd extends Rd{constructor(e,t){super(e,t),this.screenSpacePanning=!1,this.mouseButtons.LEFT=f.MOUSE.PAN,this.mouseButtons.RIGHT=f.MOUSE.ROTATE,this.touches.ONE=f.TOUCH.PAN,this.touches.TWO=f.TOUCH.DOLLY_ROTATE}}var $d=Object.defineProperty,Xd=(s,e,t)=>e in s?$d(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,si=(s,e,t)=>(Xd(s,typeof e!="symbol"?e+"":e,t),t);class pn{constructor(){si(this,"enabled",!0),si(this,"needsSwap",!0),si(this,"clear",!1),si(this,"renderToScreen",!1)}setSize(e,t){}render(e,t,r,i,o){console.error("THREE.Pass: .render() must be implemented in derived pass.")}dispose(){}}class Nl{constructor(e){si(this,"camera",new f.OrthographicCamera(-1,1,1,-1,0,1)),si(this,"geometry",new f.PlaneGeometry(2,2)),si(this,"mesh"),this.mesh=new f.Mesh(this.geometry,e)}get material(){return this.mesh.material}set material(e){this.mesh.material=e}dispose(){this.mesh.geometry.dispose()}render(e){e.render(this.mesh,this.camera)}}var Yd=Object.defineProperty,Zd=(s,e,t)=>e in s?Yd(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ts=(s,e,t)=>(Zd(s,typeof e!="symbol"?e+"":e,t),t);class Wl extends pn{constructor(e,t="tDiffuse"){super(),ts(this,"textureID"),ts(this,"uniforms"),ts(this,"material"),ts(this,"fsQuad"),this.textureID=t,e instanceof f.ShaderMaterial?(this.uniforms=e.uniforms,this.material=e):(this.uniforms=f.UniformsUtils.clone(e.uniforms),this.material=new f.ShaderMaterial({defines:Object.assign({},e.defines),uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this.fsQuad=new Nl(this.material)}render(e,t,r){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=r.texture),this.fsQuad.material=this.material,this.renderToScreen?(e.setRenderTarget(null),this.fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),this.fsQuad.render(e))}dispose(){this.fsQuad.dispose(),this.material.dispose()}}const Po={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:`
    varying vec2 vUv;

    void main() {

    	vUv = uv;
    	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

    }
  `,fragmentShader:`
    uniform float opacity;

    uniform sampler2D tDiffuse;

    varying vec2 vUv;

    void main() {

    	vec4 texel = texture2D( tDiffuse, vUv );
    	gl_FragColor = opacity * texel;

    }
  `},Kd={uniforms:{tDiffuse:{value:null},luminosityThreshold:{value:1},smoothWidth:{value:1},defaultColor:{value:new f.Color(0)},defaultOpacity:{value:0}},vertexShader:`
    varying vec2 vUv;

    void main() {

    	vUv = uv;

    	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform vec3 defaultColor;
    uniform float defaultOpacity;
    uniform float luminosityThreshold;
    uniform float smoothWidth;

    varying vec2 vUv;

    void main() {

    	vec4 texel = texture2D( tDiffuse, vUv );

    	vec3 luma = vec3( 0.299, 0.587, 0.114 );

    	float v = dot( texel.xyz, luma );

    	vec4 outputColor = vec4( defaultColor.rgb, defaultOpacity );

    	float alpha = smoothstep( luminosityThreshold, luminosityThreshold + smoothWidth, v );

    	gl_FragColor = mix( outputColor, texel, alpha );

    }
  `};var qd=Object.defineProperty,Qd=(s,e,t)=>e in s?qd(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Gl=(s,e,t)=>(Qd(s,typeof e!="symbol"?e+"":e,t),t);const Jd=(()=>{const s=class extends pn{constructor(t,r,i,o){super(),this.strength=r!==void 0?r:1,this.radius=i,this.threshold=o,this.resolution=t!==void 0?new f.Vector2(t.x,t.y):new f.Vector2(256,256),this.clearColor=new f.Color(0,0,0),this.renderTargetsHorizontal=[],this.renderTargetsVertical=[],this.nMips=5;let l=Math.round(this.resolution.x/2),c=Math.round(this.resolution.y/2);this.renderTargetBright=new f.WebGLRenderTarget(l,c,{type:f.HalfFloatType}),this.renderTargetBright.texture.name="UnrealBloomPass.bright",this.renderTargetBright.texture.generateMipmaps=!1;for(let _=0;_<this.nMips;_++){const v=new f.WebGLRenderTarget(l,c,{type:f.HalfFloatType});v.texture.name="UnrealBloomPass.h"+_,v.texture.generateMipmaps=!1,this.renderTargetsHorizontal.push(v);const S=new f.WebGLRenderTarget(l,c,{type:f.HalfFloatType});S.texture.name="UnrealBloomPass.v"+_,S.texture.generateMipmaps=!1,this.renderTargetsVertical.push(S),l=Math.round(l/2),c=Math.round(c/2)}const u=Kd;this.highPassUniforms=f.UniformsUtils.clone(u.uniforms),this.highPassUniforms.luminosityThreshold.value=o,this.highPassUniforms.smoothWidth.value=.01,this.materialHighPassFilter=new f.ShaderMaterial({uniforms:this.highPassUniforms,vertexShader:u.vertexShader,fragmentShader:u.fragmentShader,defines:{}}),this.separableBlurMaterials=[];const d=[3,5,7,9,11];l=Math.round(this.resolution.x/2),c=Math.round(this.resolution.y/2);for(let _=0;_<this.nMips;_++)this.separableBlurMaterials.push(this.getSeperableBlurMaterial(d[_])),this.separableBlurMaterials[_].uniforms.texSize.value=new f.Vector2(l,c),l=Math.round(l/2),c=Math.round(c/2);this.compositeMaterial=this.getCompositeMaterial(this.nMips),this.compositeMaterial.uniforms.blurTexture1.value=this.renderTargetsVertical[0].texture,this.compositeMaterial.uniforms.blurTexture2.value=this.renderTargetsVertical[1].texture,this.compositeMaterial.uniforms.blurTexture3.value=this.renderTargetsVertical[2].texture,this.compositeMaterial.uniforms.blurTexture4.value=this.renderTargetsVertical[3].texture,this.compositeMaterial.uniforms.blurTexture5.value=this.renderTargetsVertical[4].texture,this.compositeMaterial.uniforms.bloomStrength.value=r,this.compositeMaterial.uniforms.bloomRadius.value=.1,this.compositeMaterial.needsUpdate=!0;const m=[1,.8,.6,.4,.2];this.compositeMaterial.uniforms.bloomFactors.value=m,this.bloomTintColors=[new f.Vector3(1,1,1),new f.Vector3(1,1,1),new f.Vector3(1,1,1),new f.Vector3(1,1,1),new f.Vector3(1,1,1)],this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors;const p=Po;this.copyUniforms=f.UniformsUtils.clone(p.uniforms),this.copyUniforms.opacity.value=1,this.materialCopy=new f.ShaderMaterial({uniforms:this.copyUniforms,vertexShader:p.vertexShader,fragmentShader:p.fragmentShader,blending:f.AdditiveBlending,depthTest:!1,depthWrite:!1,transparent:!0}),this.enabled=!0,this.needsSwap=!1,this._oldClearColor=new f.Color,this.oldClearAlpha=1,this.basic=new f.MeshBasicMaterial,this.fsQuad=new Nl(null)}dispose(){for(let t=0;t<this.renderTargetsHorizontal.length;t++)this.renderTargetsHorizontal[t].dispose();for(let t=0;t<this.renderTargetsVertical.length;t++)this.renderTargetsVertical[t].dispose();this.renderTargetBright.dispose();for(let t=0;t<this.separableBlurMaterials.length;t++)this.separableBlurMaterials[t].dispose();this.compositeMaterial.dispose(),this.materialCopy.dispose(),this.basic.dispose(),this.fsQuad.dispose()}setSize(t,r){let i=Math.round(t/2),o=Math.round(r/2);this.renderTargetBright.setSize(i,o);for(let l=0;l<this.nMips;l++)this.renderTargetsHorizontal[l].setSize(i,o),this.renderTargetsVertical[l].setSize(i,o),this.separableBlurMaterials[l].uniforms.texSize.value=new f.Vector2(i,o),i=Math.round(i/2),o=Math.round(o/2)}render(t,r,i,o,l){t.getClearColor(this._oldClearColor),this.oldClearAlpha=t.getClearAlpha();const c=t.autoClear;t.autoClear=!1,t.setClearColor(this.clearColor,0),l&&t.state.buffers.stencil.setTest(!1),this.renderToScreen&&(this.fsQuad.material=this.basic,this.basic.map=i.texture,t.setRenderTarget(null),t.clear(),this.fsQuad.render(t)),this.highPassUniforms.tDiffuse.value=i.texture,this.highPassUniforms.luminosityThreshold.value=this.threshold,this.fsQuad.material=this.materialHighPassFilter,t.setRenderTarget(this.renderTargetBright),t.clear(),this.fsQuad.render(t);let u=this.renderTargetBright;for(let d=0;d<this.nMips;d++)this.fsQuad.material=this.separableBlurMaterials[d],this.separableBlurMaterials[d].uniforms.colorTexture.value=u.texture,this.separableBlurMaterials[d].uniforms.direction.value=s.BlurDirectionX,t.setRenderTarget(this.renderTargetsHorizontal[d]),t.clear(),this.fsQuad.render(t),this.separableBlurMaterials[d].uniforms.colorTexture.value=this.renderTargetsHorizontal[d].texture,this.separableBlurMaterials[d].uniforms.direction.value=s.BlurDirectionY,t.setRenderTarget(this.renderTargetsVertical[d]),t.clear(),this.fsQuad.render(t),u=this.renderTargetsVertical[d];this.fsQuad.material=this.compositeMaterial,this.compositeMaterial.uniforms.bloomStrength.value=this.strength,this.compositeMaterial.uniforms.bloomRadius.value=this.radius,this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors,t.setRenderTarget(this.renderTargetsHorizontal[0]),t.clear(),this.fsQuad.render(t),this.fsQuad.material=this.materialCopy,this.copyUniforms.tDiffuse.value=this.renderTargetsHorizontal[0].texture,l&&t.state.buffers.stencil.setTest(!0),this.renderToScreen?(t.setRenderTarget(null),this.fsQuad.render(t)):(t.setRenderTarget(i),this.fsQuad.render(t)),t.setClearColor(this._oldClearColor,this.oldClearAlpha),t.autoClear=c}getSeperableBlurMaterial(t){return new f.ShaderMaterial({defines:{KERNEL_RADIUS:t,SIGMA:t},uniforms:{colorTexture:{value:null},texSize:{value:new f.Vector2(.5,.5)},direction:{value:new f.Vector2(.5,.5)}},vertexShader:`varying vec2 vUv;
				void main() {
					vUv = uv;
					gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
				}`,fragmentShader:`#include <common>
				varying vec2 vUv;
				uniform sampler2D colorTexture;
				uniform vec2 texSize;
				uniform vec2 direction;

				float gaussianPdf(in float x, in float sigma) {
					return 0.39894 * exp( -0.5 * x * x/( sigma * sigma))/sigma;
				}
				void main() {
					vec2 invSize = 1.0 / texSize;
					float fSigma = float(SIGMA);
					float weightSum = gaussianPdf(0.0, fSigma);
					vec3 diffuseSum = texture2D( colorTexture, vUv).rgb * weightSum;
					for( int i = 1; i < KERNEL_RADIUS; i ++ ) {
						float x = float(i);
						float w = gaussianPdf(x, fSigma);
						vec2 uvOffset = direction * invSize * x;
						vec3 sample1 = texture2D( colorTexture, vUv + uvOffset).rgb;
						vec3 sample2 = texture2D( colorTexture, vUv - uvOffset).rgb;
						diffuseSum += (sample1 + sample2) * w;
						weightSum += 2.0 * w;
					}
					gl_FragColor = vec4(diffuseSum/weightSum, 1.0);
				}`})}getCompositeMaterial(t){return new f.ShaderMaterial({defines:{NUM_MIPS:t},uniforms:{blurTexture1:{value:null},blurTexture2:{value:null},blurTexture3:{value:null},blurTexture4:{value:null},blurTexture5:{value:null},bloomStrength:{value:1},bloomFactors:{value:null},bloomTintColors:{value:null},bloomRadius:{value:0}},vertexShader:`varying vec2 vUv;
				void main() {
					vUv = uv;
					gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
				}`,fragmentShader:`varying vec2 vUv;
				uniform sampler2D blurTexture1;
				uniform sampler2D blurTexture2;
				uniform sampler2D blurTexture3;
				uniform sampler2D blurTexture4;
				uniform sampler2D blurTexture5;
				uniform float bloomStrength;
				uniform float bloomRadius;
				uniform float bloomFactors[NUM_MIPS];
				uniform vec3 bloomTintColors[NUM_MIPS];

				float lerpBloomFactor(const in float factor) {
					float mirrorFactor = 1.2 - factor;
					return mix(factor, mirrorFactor, bloomRadius);
				}

				void main() {
					gl_FragColor = bloomStrength * ( lerpBloomFactor(bloomFactors[0]) * vec4(bloomTintColors[0], 1.0) * texture2D(blurTexture1, vUv) +
						lerpBloomFactor(bloomFactors[1]) * vec4(bloomTintColors[1], 1.0) * texture2D(blurTexture2, vUv) +
						lerpBloomFactor(bloomFactors[2]) * vec4(bloomTintColors[2], 1.0) * texture2D(blurTexture3, vUv) +
						lerpBloomFactor(bloomFactors[3]) * vec4(bloomTintColors[3], 1.0) * texture2D(blurTexture4, vUv) +
						lerpBloomFactor(bloomFactors[4]) * vec4(bloomTintColors[4], 1.0) * texture2D(blurTexture5, vUv) );
				}`})}};let e=s;return Gl(e,"BlurDirectionX",new f.Vector2(1,0)),Gl(e,"BlurDirectionY",new f.Vector2(0,1)),e})();var Ed=Object.defineProperty,Hd=(s,e,t)=>e in s?Ed(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Co=(s,e,t)=>(Hd(s,typeof e!="symbol"?e+"":e,t),t);class Rl extends pn{constructor(e,t){super(),Co(this,"scene"),Co(this,"camera"),Co(this,"inverse"),this.scene=e,this.camera=t,this.clear=!0,this.needsSwap=!1,this.inverse=!1}render(e,t,r){const i=e.getContext(),o=e.state;o.buffers.color.setMask(!1),o.buffers.depth.setMask(!1),o.buffers.color.setLocked(!0),o.buffers.depth.setLocked(!0);let l,c;this.inverse?(l=0,c=1):(l=1,c=0),o.buffers.stencil.setTest(!0),o.buffers.stencil.setOp(i.REPLACE,i.REPLACE,i.REPLACE),o.buffers.stencil.setFunc(i.ALWAYS,l,4294967295),o.buffers.stencil.setClear(c),o.buffers.stencil.setLocked(!0),e.setRenderTarget(r),this.clear&&e.clear(),e.render(this.scene,this.camera),e.setRenderTarget(t),this.clear&&e.clear(),e.render(this.scene,this.camera),o.buffers.color.setLocked(!1),o.buffers.depth.setLocked(!1),o.buffers.stencil.setLocked(!1),o.buffers.stencil.setFunc(i.EQUAL,1,4294967295),o.buffers.stencil.setOp(i.KEEP,i.KEEP,i.KEEP),o.buffers.stencil.setLocked(!0)}}class ep extends pn{constructor(){super(),this.needsSwap=!1}render(e){e.state.buffers.stencil.setLocked(!1),e.state.buffers.stencil.setTest(!1)}}var tp=Object.defineProperty,rp=(s,e,t)=>e in s?tp(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Bt=(s,e,t)=>(rp(s,typeof e!="symbol"?e+"":e,t),t);class ip{constructor(e,t){if(Bt(this,"renderer"),Bt(this,"_pixelRatio"),Bt(this,"_width"),Bt(this,"_height"),Bt(this,"renderTarget1"),Bt(this,"renderTarget2"),Bt(this,"writeBuffer"),Bt(this,"readBuffer"),Bt(this,"renderToScreen"),Bt(this,"passes",[]),Bt(this,"copyPass"),Bt(this,"clock"),this.renderer=e,t===void 0){const r={minFilter:f.LinearFilter,magFilter:f.LinearFilter,format:f.RGBAFormat},i=e.getSize(new f.Vector2);this._pixelRatio=e.getPixelRatio(),this._width=i.width,this._height=i.height,t=new f.WebGLRenderTarget(this._width*this._pixelRatio,this._height*this._pixelRatio,r),t.texture.name="EffectComposer.rt1"}else this._pixelRatio=1,this._width=t.width,this._height=t.height;this.renderTarget1=t,this.renderTarget2=t.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.renderToScreen=!0,Po===void 0&&console.error("THREE.EffectComposer relies on CopyShader"),Wl===void 0&&console.error("THREE.EffectComposer relies on ShaderPass"),this.copyPass=new Wl(Po),this.copyPass.material.blending=f.NoBlending,this.clock=new f.Clock}swapBuffers(){const e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e}addPass(e){this.passes.push(e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}insertPass(e,t){this.passes.splice(t,0,e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}removePass(e){const t=this.passes.indexOf(e);t!==-1&&this.passes.splice(t,1)}isLastEnabledPass(e){for(let t=e+1;t<this.passes.length;t++)if(this.passes[t].enabled)return!1;return!0}render(e){e===void 0&&(e=this.clock.getDelta());const t=this.renderer.getRenderTarget();let r=!1;const i=this.passes.length;for(let o=0;o<i;o++){const l=this.passes[o];if(l.enabled!==!1){if(l.renderToScreen=this.renderToScreen&&this.isLastEnabledPass(o),l.render(this.renderer,this.writeBuffer,this.readBuffer,e,r),l.needsSwap){if(r){const c=this.renderer.getContext(),u=this.renderer.state.buffers.stencil;u.setFunc(c.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),u.setFunc(c.EQUAL,1,4294967295)}this.swapBuffers()}Rl!==void 0&&(l instanceof Rl?r=!0:l instanceof ep&&(r=!1))}}this.renderer.setRenderTarget(t)}reset(e){if(e===void 0){const t=this.renderer.getSize(new f.Vector2);this._pixelRatio=this.renderer.getPixelRatio(),this._width=t.width,this._height=t.height,e=this.renderTarget1.clone(),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=e,this.renderTarget2=e.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2}setSize(e,t){this._width=e,this._height=t;const r=this._width*this._pixelRatio,i=this._height*this._pixelRatio;this.renderTarget1.setSize(r,i),this.renderTarget2.setSize(r,i);for(let o=0;o<this.passes.length;o++)this.passes[o].setSize(r,i)}setPixelRatio(e){this._pixelRatio=e,this.setSize(this._width,this._height)}dispose(){this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.copyPass.dispose()}}var np=Object.defineProperty,sp=(s,e,t)=>e in s?np(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,oi=(s,e,t)=>(sp(s,typeof e!="symbol"?e+"":e,t),t);class op extends pn{constructor(e,t,r,i,o=0){super(),oi(this,"scene"),oi(this,"camera"),oi(this,"overrideMaterial"),oi(this,"clearColor"),oi(this,"clearAlpha"),oi(this,"clearDepth",!1),oi(this,"_oldClearColor",new f.Color),this.scene=e,this.camera=t,this.overrideMaterial=r,this.clearColor=i,this.clearAlpha=o,this.clear=!0,this.needsSwap=!1}render(e,t,r){let i=e.autoClear;e.autoClear=!1;let o,l=null;this.overrideMaterial!==void 0&&(l=this.scene.overrideMaterial,this.scene.overrideMaterial=this.overrideMaterial),this.clearColor&&(e.getClearColor(this._oldClearColor),o=e.getClearAlpha(),e.setClearColor(this.clearColor,this.clearAlpha)),this.clearDepth&&e.clearDepth(),e.setRenderTarget(this.renderToScreen?null:r),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),e.render(this.scene,this.camera),this.clearColor&&e.setClearColor(this._oldClearColor,o),this.overrideMaterial!==void 0&&(this.scene.overrideMaterial=l),e.autoClear=i}}function Bi(s){if(typeof TextDecoder<"u")return new TextDecoder().decode(s);let e="";for(let t=0,r=s.length;t<r;t++)e+=String.fromCharCode(s[t]);try{return decodeURIComponent(escape(e))}catch{return e}}const ai="srgb",yr="srgb-linear",jl=3001,ap=3e3;class lp extends f.Loader{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(t){return new dp(t)}),this.register(function(t){return new pp(t)}),this.register(function(t){return new Sp(t)}),this.register(function(t){return new Mp(t)}),this.register(function(t){return new Ap(t)}),this.register(function(t){return new gp(t)}),this.register(function(t){return new _p(t)}),this.register(function(t){return new yp(t)}),this.register(function(t){return new vp(t)}),this.register(function(t){return new fp(t)}),this.register(function(t){return new wp(t)}),this.register(function(t){return new mp(t)}),this.register(function(t){return new xp(t)}),this.register(function(t){return new bp(t)}),this.register(function(t){return new up(t)}),this.register(function(t){return new Pp(t)}),this.register(function(t){return new Cp(t)})}load(e,t,r,i){const o=this;let l;if(this.resourcePath!=="")l=this.resourcePath;else if(this.path!==""){const d=f.LoaderUtils.extractUrlBase(e);l=f.LoaderUtils.resolveURL(d,this.path)}else l=f.LoaderUtils.extractUrlBase(e);this.manager.itemStart(e);const c=function(d){i?i(d):console.error(d),o.manager.itemError(e),o.manager.itemEnd(e)},u=new f.FileLoader(this.manager);u.setPath(this.path),u.setResponseType("arraybuffer"),u.setRequestHeader(this.requestHeader),u.setWithCredentials(this.withCredentials),u.load(e,function(d){try{o.parse(d,l,function(m){t(m),o.manager.itemEnd(e)},c)}catch(m){c(m)}},r,c)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,r,i){let o;const l={},c={};if(typeof e=="string")o=JSON.parse(e);else if(e instanceof ArrayBuffer)if(Bi(new Uint8Array(e.slice(0,4)))===$l){try{l[fe.KHR_BINARY_GLTF]=new Lp(e)}catch(m){i&&i(m);return}o=JSON.parse(l[fe.KHR_BINARY_GLTF].content)}else o=JSON.parse(Bi(new Uint8Array(e)));else o=e;if(o.asset===void 0||o.asset.version[0]<2){i&&i(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const u=new Gp(o,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});u.fileLoader.setRequestHeader(this.requestHeader);for(let d=0;d<this.pluginCallbacks.length;d++){const m=this.pluginCallbacks[d](u);m.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),c[m.name]=m,l[m.name]=!0}if(o.extensionsUsed)for(let d=0;d<o.extensionsUsed.length;++d){const m=o.extensionsUsed[d],p=o.extensionsRequired||[];switch(m){case fe.KHR_MATERIALS_UNLIT:l[m]=new hp;break;case fe.KHR_DRACO_MESH_COMPRESSION:l[m]=new Op(o,this.dracoLoader);break;case fe.KHR_TEXTURE_TRANSFORM:l[m]=new Dp;break;case fe.KHR_MESH_QUANTIZATION:l[m]=new Ip;break;default:p.indexOf(m)>=0&&c[m]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+m+'".')}}u.setExtensions(l),u.setPlugins(c),u.parse(r,i)}parseAsync(e,t){const r=this;return new Promise(function(i,o){r.parse(e,t,i,o)})}}function cp(){let s={};return{get:function(e){return s[e]},add:function(e,t){s[e]=t},remove:function(e){delete s[e]},removeAll:function(){s={}}}}const fe={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class up{constructor(e){this.parser=e,this.name=fe.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let r=0,i=t.length;r<i;r++){const o=t[r];o.extensions&&o.extensions[this.name]&&o.extensions[this.name].light!==void 0&&e._addNodeRef(this.cache,o.extensions[this.name].light)}}_loadLight(e){const t=this.parser,r="light:"+e;let i=t.cache.get(r);if(i)return i;const o=t.json,u=((o.extensions&&o.extensions[this.name]||{}).lights||[])[e];let d;const m=new f.Color(16777215);u.color!==void 0&&m.setRGB(u.color[0],u.color[1],u.color[2],yr);const p=u.range!==void 0?u.range:0;switch(u.type){case"directional":d=new f.DirectionalLight(m),d.target.position.set(0,0,-1),d.add(d.target);break;case"point":d=new f.PointLight(m),d.distance=p;break;case"spot":d=new f.SpotLight(m),d.distance=p,u.spot=u.spot||{},u.spot.innerConeAngle=u.spot.innerConeAngle!==void 0?u.spot.innerConeAngle:0,u.spot.outerConeAngle=u.spot.outerConeAngle!==void 0?u.spot.outerConeAngle:Math.PI/4,d.angle=u.spot.outerConeAngle,d.penumbra=1-u.spot.innerConeAngle/u.spot.outerConeAngle,d.target.position.set(0,0,-1),d.add(d.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+u.type)}return d.position.set(0,0,0),d.decay=2,vr(d,u),u.intensity!==void 0&&(d.intensity=u.intensity),d.name=t.createUniqueName(u.name||"light_"+e),i=Promise.resolve(d),t.cache.add(r,i),i}getDependency(e,t){if(e==="light")return this._loadLight(t)}createNodeAttachment(e){const t=this,r=this.parser,o=r.json.nodes[e],c=(o.extensions&&o.extensions[this.name]||{}).light;return c===void 0?null:this._loadLight(c).then(function(u){return r._getNodeRef(t.cache,c,u)})}}class hp{constructor(){this.name=fe.KHR_MATERIALS_UNLIT}getMaterialType(){return f.MeshBasicMaterial}extendParams(e,t,r){const i=[];e.color=new f.Color(1,1,1),e.opacity=1;const o=t.pbrMetallicRoughness;if(o){if(Array.isArray(o.baseColorFactor)){const l=o.baseColorFactor;e.color.setRGB(l[0],l[1],l[2],yr),e.opacity=l[3]}o.baseColorTexture!==void 0&&i.push(r.assignTexture(e,"map",o.baseColorTexture,ai))}return Promise.all(i)}}class fp{constructor(e){this.parser=e,this.name=fe.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const i=this.parser.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=i.extensions[this.name].emissiveStrength;return o!==void 0&&(t.emissiveIntensity=o),Promise.resolve()}}class dp{constructor(e){this.parser=e,this.name=fe.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:f.MeshPhysicalMaterial}extendMaterialParams(e,t){const r=this.parser,i=r.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=[],l=i.extensions[this.name];if(l.clearcoatFactor!==void 0&&(t.clearcoat=l.clearcoatFactor),l.clearcoatTexture!==void 0&&o.push(r.assignTexture(t,"clearcoatMap",l.clearcoatTexture)),l.clearcoatRoughnessFactor!==void 0&&(t.clearcoatRoughness=l.clearcoatRoughnessFactor),l.clearcoatRoughnessTexture!==void 0&&o.push(r.assignTexture(t,"clearcoatRoughnessMap",l.clearcoatRoughnessTexture)),l.clearcoatNormalTexture!==void 0&&(o.push(r.assignTexture(t,"clearcoatNormalMap",l.clearcoatNormalTexture)),l.clearcoatNormalTexture.scale!==void 0)){const c=l.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new f.Vector2(c,c)}return Promise.all(o)}}class pp{constructor(e){this.parser=e,this.name=fe.KHR_MATERIALS_DISPERSION}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:f.MeshPhysicalMaterial}extendMaterialParams(e,t){const i=this.parser.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=i.extensions[this.name];return t.dispersion=o.dispersion!==void 0?o.dispersion:0,Promise.resolve()}}class mp{constructor(e){this.parser=e,this.name=fe.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:f.MeshPhysicalMaterial}extendMaterialParams(e,t){const r=this.parser,i=r.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=[],l=i.extensions[this.name];return l.iridescenceFactor!==void 0&&(t.iridescence=l.iridescenceFactor),l.iridescenceTexture!==void 0&&o.push(r.assignTexture(t,"iridescenceMap",l.iridescenceTexture)),l.iridescenceIor!==void 0&&(t.iridescenceIOR=l.iridescenceIor),t.iridescenceThicknessRange===void 0&&(t.iridescenceThicknessRange=[100,400]),l.iridescenceThicknessMinimum!==void 0&&(t.iridescenceThicknessRange[0]=l.iridescenceThicknessMinimum),l.iridescenceThicknessMaximum!==void 0&&(t.iridescenceThicknessRange[1]=l.iridescenceThicknessMaximum),l.iridescenceThicknessTexture!==void 0&&o.push(r.assignTexture(t,"iridescenceThicknessMap",l.iridescenceThicknessTexture)),Promise.all(o)}}class gp{constructor(e){this.parser=e,this.name=fe.KHR_MATERIALS_SHEEN}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:f.MeshPhysicalMaterial}extendMaterialParams(e,t){const r=this.parser,i=r.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=[];t.sheenColor=new f.Color(0,0,0),t.sheenRoughness=0,t.sheen=1;const l=i.extensions[this.name];if(l.sheenColorFactor!==void 0){const c=l.sheenColorFactor;t.sheenColor.setRGB(c[0],c[1],c[2],yr)}return l.sheenRoughnessFactor!==void 0&&(t.sheenRoughness=l.sheenRoughnessFactor),l.sheenColorTexture!==void 0&&o.push(r.assignTexture(t,"sheenColorMap",l.sheenColorTexture,ai)),l.sheenRoughnessTexture!==void 0&&o.push(r.assignTexture(t,"sheenRoughnessMap",l.sheenRoughnessTexture)),Promise.all(o)}}class _p{constructor(e){this.parser=e,this.name=fe.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:f.MeshPhysicalMaterial}extendMaterialParams(e,t){const r=this.parser,i=r.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=[],l=i.extensions[this.name];return l.transmissionFactor!==void 0&&(t.transmission=l.transmissionFactor),l.transmissionTexture!==void 0&&o.push(r.assignTexture(t,"transmissionMap",l.transmissionTexture)),Promise.all(o)}}class yp{constructor(e){this.parser=e,this.name=fe.KHR_MATERIALS_VOLUME}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:f.MeshPhysicalMaterial}extendMaterialParams(e,t){const r=this.parser,i=r.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=[],l=i.extensions[this.name];t.thickness=l.thicknessFactor!==void 0?l.thicknessFactor:0,l.thicknessTexture!==void 0&&o.push(r.assignTexture(t,"thicknessMap",l.thicknessTexture)),t.attenuationDistance=l.attenuationDistance||1/0;const c=l.attenuationColor||[1,1,1];return t.attenuationColor=new f.Color().setRGB(c[0],c[1],c[2],yr),Promise.all(o)}}class vp{constructor(e){this.parser=e,this.name=fe.KHR_MATERIALS_IOR}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:f.MeshPhysicalMaterial}extendMaterialParams(e,t){const i=this.parser.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=i.extensions[this.name];return t.ior=o.ior!==void 0?o.ior:1.5,Promise.resolve()}}class wp{constructor(e){this.parser=e,this.name=fe.KHR_MATERIALS_SPECULAR}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:f.MeshPhysicalMaterial}extendMaterialParams(e,t){const r=this.parser,i=r.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=[],l=i.extensions[this.name];t.specularIntensity=l.specularFactor!==void 0?l.specularFactor:1,l.specularTexture!==void 0&&o.push(r.assignTexture(t,"specularIntensityMap",l.specularTexture));const c=l.specularColorFactor||[1,1,1];return t.specularColor=new f.Color().setRGB(c[0],c[1],c[2],yr),l.specularColorTexture!==void 0&&o.push(r.assignTexture(t,"specularColorMap",l.specularColorTexture,ai)),Promise.all(o)}}class bp{constructor(e){this.parser=e,this.name=fe.EXT_MATERIALS_BUMP}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:f.MeshPhysicalMaterial}extendMaterialParams(e,t){const r=this.parser,i=r.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=[],l=i.extensions[this.name];return t.bumpScale=l.bumpFactor!==void 0?l.bumpFactor:1,l.bumpTexture!==void 0&&o.push(r.assignTexture(t,"bumpMap",l.bumpTexture)),Promise.all(o)}}class xp{constructor(e){this.parser=e,this.name=fe.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:f.MeshPhysicalMaterial}extendMaterialParams(e,t){const r=this.parser,i=r.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=[],l=i.extensions[this.name];return l.anisotropyStrength!==void 0&&(t.anisotropy=l.anisotropyStrength),l.anisotropyRotation!==void 0&&(t.anisotropyRotation=l.anisotropyRotation),l.anisotropyTexture!==void 0&&o.push(r.assignTexture(t,"anisotropyMap",l.anisotropyTexture)),Promise.all(o)}}class Sp{constructor(e){this.parser=e,this.name=fe.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,r=t.json,i=r.textures[e];if(!i.extensions||!i.extensions[this.name])return null;const o=i.extensions[this.name],l=t.options.ktx2Loader;if(!l){if(r.extensionsRequired&&r.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,o.source,l)}}class Mp{constructor(e){this.parser=e,this.name=fe.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,r=this.parser,i=r.json,o=i.textures[e];if(!o.extensions||!o.extensions[t])return null;const l=o.extensions[t],c=i.images[l.source];let u=r.textureLoader;if(c.uri){const d=r.options.manager.getHandler(c.uri);d!==null&&(u=d)}return this.detectSupport().then(function(d){if(d)return r.loadTextureImage(e,l.source,u);if(i.extensionsRequired&&i.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return r.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class Ap{constructor(e){this.parser=e,this.name=fe.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,r=this.parser,i=r.json,o=i.textures[e];if(!o.extensions||!o.extensions[t])return null;const l=o.extensions[t],c=i.images[l.source];let u=r.textureLoader;if(c.uri){const d=r.options.manager.getHandler(c.uri);d!==null&&(u=d)}return this.detectSupport().then(function(d){if(d)return r.loadTextureImage(e,l.source,u);if(i.extensionsRequired&&i.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return r.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class Pp{constructor(e){this.name=fe.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,r=t.bufferViews[e];if(r.extensions&&r.extensions[this.name]){const i=r.extensions[this.name],o=this.parser.getDependency("buffer",i.buffer),l=this.parser.options.meshoptDecoder;if(!l||!l.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return o.then(function(c){const u=i.byteOffset||0,d=i.byteLength||0,m=i.count,p=i.byteStride,_=new Uint8Array(c,u,d);return l.decodeGltfBufferAsync?l.decodeGltfBufferAsync(m,p,_,i.mode,i.filter).then(function(v){return v.buffer}):l.ready.then(function(){const v=new ArrayBuffer(m*p);return l.decodeGltfBuffer(new Uint8Array(v),m,p,_,i.mode,i.filter),v})})}else return null}}class Cp{constructor(e){this.name=fe.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,r=t.nodes[e];if(!r.extensions||!r.extensions[this.name]||r.mesh===void 0)return null;const i=t.meshes[r.mesh];for(const d of i.primitives)if(d.mode!==Ut.TRIANGLES&&d.mode!==Ut.TRIANGLE_STRIP&&d.mode!==Ut.TRIANGLE_FAN&&d.mode!==void 0)return null;const l=r.extensions[this.name].attributes,c=[],u={};for(const d in l)c.push(this.parser.getDependency("accessor",l[d]).then(m=>(u[d]=m,u[d])));return c.length<1?null:(c.push(this.parser.createNodeMesh(e)),Promise.all(c).then(d=>{const m=d.pop(),p=m.isGroup?m.children:[m],_=d[0].count,v=[];for(const S of p){const M=new f.Matrix4,x=new f.Vector3,O=new f.Quaternion,P=new f.Vector3(1,1,1),C=new f.InstancedMesh(S.geometry,S.material,_);for(let T=0;T<_;T++)u.TRANSLATION&&x.fromBufferAttribute(u.TRANSLATION,T),u.ROTATION&&O.fromBufferAttribute(u.ROTATION,T),u.SCALE&&P.fromBufferAttribute(u.SCALE,T),C.setMatrixAt(T,M.compose(x,O,P));for(const T in u)if(T==="_COLOR_0"){const N=u[T];C.instanceColor=new f.InstancedBufferAttribute(N.array,N.itemSize,N.normalized)}else T!=="TRANSLATION"&&T!=="ROTATION"&&T!=="SCALE"&&S.geometry.setAttribute(T,u[T]);f.Object3D.prototype.copy.call(C,S),this.parser.assignFinalMaterial(C),v.push(C)}return m.isGroup?(m.clear(),m.add(...v),m):v[0]}))}}const $l="glTF",mn=12,Xl={JSON:1313821514,BIN:5130562};class Lp{constructor(e){this.name=fe.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,mn);if(this.header={magic:Bi(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==$l)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const r=this.header.length-mn,i=new DataView(e,mn);let o=0;for(;o<r;){const l=i.getUint32(o,!0);o+=4;const c=i.getUint32(o,!0);if(o+=4,c===Xl.JSON){const u=new Uint8Array(e,mn+o,l);this.content=Bi(u)}else if(c===Xl.BIN){const u=mn+o;this.body=e.slice(u,u+l)}o+=l}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class Op{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=fe.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const r=this.json,i=this.dracoLoader,o=e.extensions[this.name].bufferView,l=e.extensions[this.name].attributes,c={},u={},d={};for(const m in l){const p=Oo[m]||m.toLowerCase();c[p]=l[m]}for(const m in e.attributes){const p=Oo[m]||m.toLowerCase();if(l[m]!==void 0){const _=r.accessors[e.attributes[m]],v=Ui[_.componentType];d[p]=v.name,u[p]=_.normalized===!0}}return t.getDependency("bufferView",o).then(function(m){return new Promise(function(p,_){i.decodeDracoFile(m,function(v){for(const S in v.attributes){const M=v.attributes[S],x=u[S];x!==void 0&&(M.normalized=x)}p(v)},c,d,yr,_)})})}}class Dp{constructor(){this.name=fe.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(t.texCoord===void 0||t.texCoord===e.channel)&&t.offset===void 0&&t.rotation===void 0&&t.scale===void 0||(e=e.clone(),t.texCoord!==void 0&&(e.channel=t.texCoord),t.offset!==void 0&&e.offset.fromArray(t.offset),t.rotation!==void 0&&(e.rotation=t.rotation),t.scale!==void 0&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class Ip{constructor(){this.name=fe.KHR_MESH_QUANTIZATION}}class Yl extends f.Interpolant{constructor(e,t,r,i){super(e,t,r,i)}copySampleValue_(e){const t=this.resultBuffer,r=this.sampleValues,i=this.valueSize,o=e*i*3+i;for(let l=0;l!==i;l++)t[l]=r[o+l];return t}interpolate_(e,t,r,i){const o=this.resultBuffer,l=this.sampleValues,c=this.valueSize,u=c*2,d=c*3,m=i-t,p=(r-t)/m,_=p*p,v=_*p,S=e*d,M=S-d,x=-2*v+3*_,O=v-_,P=1-x,C=O-_+p;for(let T=0;T!==c;T++){const N=l[M+T+c],X=l[M+T+u]*m,R=l[S+T+c],U=l[S+T]*m;o[T]=P*N+C*X+x*R+O*U}return o}}const Fp=new f.Quaternion;class Tp extends Yl{interpolate_(e,t,r,i){const o=super.interpolate_(e,t,r,i);return Fp.fromArray(o).normalize().toArray(o),o}}const Ut={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},Ui={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Zl={9728:f.NearestFilter,9729:f.LinearFilter,9984:f.NearestMipmapNearestFilter,9985:f.LinearMipmapNearestFilter,9986:f.NearestMipmapLinearFilter,9987:f.LinearMipmapLinearFilter},Kl={33071:f.ClampToEdgeWrapping,33648:f.MirroredRepeatWrapping,10497:f.RepeatWrapping},Lo={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Oo={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",...Hn>=152?{TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3"}:{TEXCOORD_0:"uv",TEXCOORD_1:"uv2"},COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},Ur={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},Bp={CUBICSPLINE:void 0,LINEAR:f.InterpolateLinear,STEP:f.InterpolateDiscrete},Do={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function Up(s){return s.DefaultMaterial===void 0&&(s.DefaultMaterial=new f.MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:f.FrontSide})),s.DefaultMaterial}function li(s,e,t){for(const r in t.extensions)s[r]===void 0&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[r]=t.extensions[r])}function vr(s,e){e.extras!==void 0&&(typeof e.extras=="object"?Object.assign(s.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function Vp(s,e,t){let r=!1,i=!1,o=!1;for(let d=0,m=e.length;d<m;d++){const p=e[d];if(p.POSITION!==void 0&&(r=!0),p.NORMAL!==void 0&&(i=!0),p.COLOR_0!==void 0&&(o=!0),r&&i&&o)break}if(!r&&!i&&!o)return Promise.resolve(s);const l=[],c=[],u=[];for(let d=0,m=e.length;d<m;d++){const p=e[d];if(r){const _=p.POSITION!==void 0?t.getDependency("accessor",p.POSITION):s.attributes.position;l.push(_)}if(i){const _=p.NORMAL!==void 0?t.getDependency("accessor",p.NORMAL):s.attributes.normal;c.push(_)}if(o){const _=p.COLOR_0!==void 0?t.getDependency("accessor",p.COLOR_0):s.attributes.color;u.push(_)}}return Promise.all([Promise.all(l),Promise.all(c),Promise.all(u)]).then(function(d){const m=d[0],p=d[1],_=d[2];return r&&(s.morphAttributes.position=m),i&&(s.morphAttributes.normal=p),o&&(s.morphAttributes.color=_),s.morphTargetsRelative=!0,s})}function kp(s,e){if(s.updateMorphTargets(),e.weights!==void 0)for(let t=0,r=e.weights.length;t<r;t++)s.morphTargetInfluences[t]=e.weights[t];if(e.extras&&Array.isArray(e.extras.targetNames)){const t=e.extras.targetNames;if(s.morphTargetInfluences.length===t.length){s.morphTargetDictionary={};for(let r=0,i=t.length;r<i;r++)s.morphTargetDictionary[t[r]]=r}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function zp(s){let e;const t=s.extensions&&s.extensions[fe.KHR_DRACO_MESH_COMPRESSION];if(t?e="draco:"+t.bufferView+":"+t.indices+":"+Io(t.attributes):e=s.indices+":"+Io(s.attributes)+":"+s.mode,s.targets!==void 0)for(let r=0,i=s.targets.length;r<i;r++)e+=":"+Io(s.targets[r]);return e}function Io(s){let e="";const t=Object.keys(s).sort();for(let r=0,i=t.length;r<i;r++)e+=t[r]+":"+s[t[r]]+";";return e}function Fo(s){switch(s){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function Np(s){return s.search(/\.jpe?g($|\?)/i)>0||s.search(/^data\:image\/jpeg/)===0?"image/jpeg":s.search(/\.webp($|\?)/i)>0||s.search(/^data\:image\/webp/)===0?"image/webp":"image/png"}const Wp=new f.Matrix4;class Gp{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new cp,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let r=!1,i=!1,o=-1;typeof navigator<"u"&&typeof navigator.userAgent<"u"&&(r=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)===!0,i=navigator.userAgent.indexOf("Firefox")>-1,o=i?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),typeof createImageBitmap>"u"||r||i&&o<98?this.textureLoader=new f.TextureLoader(this.options.manager):this.textureLoader=new f.ImageBitmapLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new f.FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const r=this,i=this.json,o=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(l){return l._markDefs&&l._markDefs()}),Promise.all(this._invokeAll(function(l){return l.beforeRoot&&l.beforeRoot()})).then(function(){return Promise.all([r.getDependencies("scene"),r.getDependencies("animation"),r.getDependencies("camera")])}).then(function(l){const c={scene:l[0][i.scene||0],scenes:l[0],animations:l[1],cameras:l[2],asset:i.asset,parser:r,userData:{}};return li(o,c,i),vr(c,i),Promise.all(r._invokeAll(function(u){return u.afterRoot&&u.afterRoot(c)})).then(function(){for(const u of c.scenes)u.updateMatrixWorld();e(c)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],r=this.json.meshes||[];for(let i=0,o=t.length;i<o;i++){const l=t[i].joints;for(let c=0,u=l.length;c<u;c++)e[l[c]].isBone=!0}for(let i=0,o=e.length;i<o;i++){const l=e[i];l.mesh!==void 0&&(this._addNodeRef(this.meshCache,l.mesh),l.skin!==void 0&&(r[l.mesh].isSkinnedMesh=!0)),l.camera!==void 0&&this._addNodeRef(this.cameraCache,l.camera)}}_addNodeRef(e,t){t!==void 0&&(e.refs[t]===void 0&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,r){if(e.refs[t]<=1)return r;const i=r.clone(),o=(l,c)=>{const u=this.associations.get(l);u!=null&&this.associations.set(c,u);for(const[d,m]of l.children.entries())o(m,c.children[d])};return o(r,i),i.name+="_instance_"+e.uses[t]++,i}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let r=0;r<t.length;r++){const i=e(t[r]);if(i)return i}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const r=[];for(let i=0;i<t.length;i++){const o=e(t[i]);o&&r.push(o)}return r}getDependency(e,t){const r=e+":"+t;let i=this.cache.get(r);if(!i){switch(e){case"scene":i=this.loadScene(t);break;case"node":i=this._invokeOne(function(o){return o.loadNode&&o.loadNode(t)});break;case"mesh":i=this._invokeOne(function(o){return o.loadMesh&&o.loadMesh(t)});break;case"accessor":i=this.loadAccessor(t);break;case"bufferView":i=this._invokeOne(function(o){return o.loadBufferView&&o.loadBufferView(t)});break;case"buffer":i=this.loadBuffer(t);break;case"material":i=this._invokeOne(function(o){return o.loadMaterial&&o.loadMaterial(t)});break;case"texture":i=this._invokeOne(function(o){return o.loadTexture&&o.loadTexture(t)});break;case"skin":i=this.loadSkin(t);break;case"animation":i=this._invokeOne(function(o){return o.loadAnimation&&o.loadAnimation(t)});break;case"camera":i=this.loadCamera(t);break;default:if(i=this._invokeOne(function(o){return o!=this&&o.getDependency&&o.getDependency(e,t)}),!i)throw new Error("Unknown type: "+e);break}this.cache.add(r,i)}return i}getDependencies(e){let t=this.cache.get(e);if(!t){const r=this,i=this.json[e+(e==="mesh"?"es":"s")]||[];t=Promise.all(i.map(function(o,l){return r.getDependency(e,l)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],r=this.fileLoader;if(t.type&&t.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(t.uri===void 0&&e===0)return Promise.resolve(this.extensions[fe.KHR_BINARY_GLTF].body);const i=this.options;return new Promise(function(o,l){r.load(f.LoaderUtils.resolveURL(t.uri,i.path),o,void 0,function(){l(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(r){const i=t.byteLength||0,o=t.byteOffset||0;return r.slice(o,o+i)})}loadAccessor(e){const t=this,r=this.json,i=this.json.accessors[e];if(i.bufferView===void 0&&i.sparse===void 0){const l=Lo[i.type],c=Ui[i.componentType],u=i.normalized===!0,d=new c(i.count*l);return Promise.resolve(new f.BufferAttribute(d,l,u))}const o=[];return i.bufferView!==void 0?o.push(this.getDependency("bufferView",i.bufferView)):o.push(null),i.sparse!==void 0&&(o.push(this.getDependency("bufferView",i.sparse.indices.bufferView)),o.push(this.getDependency("bufferView",i.sparse.values.bufferView))),Promise.all(o).then(function(l){const c=l[0],u=Lo[i.type],d=Ui[i.componentType],m=d.BYTES_PER_ELEMENT,p=m*u,_=i.byteOffset||0,v=i.bufferView!==void 0?r.bufferViews[i.bufferView].byteStride:void 0,S=i.normalized===!0;let M,x;if(v&&v!==p){const O=Math.floor(_/v),P="InterleavedBuffer:"+i.bufferView+":"+i.componentType+":"+O+":"+i.count;let C=t.cache.get(P);C||(M=new d(c,O*v,i.count*v/m),C=new f.InterleavedBuffer(M,v/m),t.cache.add(P,C)),x=new f.InterleavedBufferAttribute(C,u,_%v/m,S)}else c===null?M=new d(i.count*u):M=new d(c,_,i.count*u),x=new f.BufferAttribute(M,u,S);if(i.sparse!==void 0){const O=Lo.SCALAR,P=Ui[i.sparse.indices.componentType],C=i.sparse.indices.byteOffset||0,T=i.sparse.values.byteOffset||0,N=new P(l[1],C,i.sparse.count*O),X=new d(l[2],T,i.sparse.count*u);c!==null&&(x=new f.BufferAttribute(x.array.slice(),x.itemSize,x.normalized));for(let R=0,U=N.length;R<U;R++){const $=N[R];if(x.setX($,X[R*u]),u>=2&&x.setY($,X[R*u+1]),u>=3&&x.setZ($,X[R*u+2]),u>=4&&x.setW($,X[R*u+3]),u>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return x})}loadTexture(e){const t=this.json,r=this.options,o=t.textures[e].source,l=t.images[o];let c=this.textureLoader;if(l.uri){const u=r.manager.getHandler(l.uri);u!==null&&(c=u)}return this.loadTextureImage(e,o,c)}loadTextureImage(e,t,r){const i=this,o=this.json,l=o.textures[e],c=o.images[t],u=(c.uri||c.bufferView)+":"+l.sampler;if(this.textureCache[u])return this.textureCache[u];const d=this.loadImageSource(t,r).then(function(m){m.flipY=!1,m.name=l.name||c.name||"",m.name===""&&typeof c.uri=="string"&&c.uri.startsWith("data:image/")===!1&&(m.name=c.uri);const _=(o.samplers||{})[l.sampler]||{};return m.magFilter=Zl[_.magFilter]||f.LinearFilter,m.minFilter=Zl[_.minFilter]||f.LinearMipmapLinearFilter,m.wrapS=Kl[_.wrapS]||f.RepeatWrapping,m.wrapT=Kl[_.wrapT]||f.RepeatWrapping,i.associations.set(m,{textures:e}),m}).catch(function(){return null});return this.textureCache[u]=d,d}loadImageSource(e,t){const r=this,i=this.json,o=this.options;if(this.sourceCache[e]!==void 0)return this.sourceCache[e].then(p=>p.clone());const l=i.images[e],c=self.URL||self.webkitURL;let u=l.uri||"",d=!1;if(l.bufferView!==void 0)u=r.getDependency("bufferView",l.bufferView).then(function(p){d=!0;const _=new Blob([p],{type:l.mimeType});return u=c.createObjectURL(_),u});else if(l.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const m=Promise.resolve(u).then(function(p){return new Promise(function(_,v){let S=_;t.isImageBitmapLoader===!0&&(S=function(M){const x=new f.Texture(M);x.needsUpdate=!0,_(x)}),t.load(f.LoaderUtils.resolveURL(p,o.path),S,void 0,v)})}).then(function(p){return d===!0&&c.revokeObjectURL(u),vr(p,l),p.userData.mimeType=l.mimeType||Np(l.uri),p}).catch(function(p){throw console.error("THREE.GLTFLoader: Couldn't load texture",u),p});return this.sourceCache[e]=m,m}assignTexture(e,t,r,i){const o=this;return this.getDependency("texture",r.index).then(function(l){if(!l)return null;if(r.texCoord!==void 0&&r.texCoord>0&&(l=l.clone(),l.channel=r.texCoord),o.extensions[fe.KHR_TEXTURE_TRANSFORM]){const c=r.extensions!==void 0?r.extensions[fe.KHR_TEXTURE_TRANSFORM]:void 0;if(c){const u=o.associations.get(l);l=o.extensions[fe.KHR_TEXTURE_TRANSFORM].extendTexture(l,c),o.associations.set(l,u)}}return i!==void 0&&(typeof i=="number"&&(i=i===jl?ai:yr),"colorSpace"in l?l.colorSpace=i:l.encoding=i===ai?jl:ap),e[t]=l,l})}assignFinalMaterial(e){const t=e.geometry;let r=e.material;const i=t.attributes.tangent===void 0,o=t.attributes.color!==void 0,l=t.attributes.normal===void 0;if(e.isPoints){const c="PointsMaterial:"+r.uuid;let u=this.cache.get(c);u||(u=new f.PointsMaterial,f.Material.prototype.copy.call(u,r),u.color.copy(r.color),u.map=r.map,u.sizeAttenuation=!1,this.cache.add(c,u)),r=u}else if(e.isLine){const c="LineBasicMaterial:"+r.uuid;let u=this.cache.get(c);u||(u=new f.LineBasicMaterial,f.Material.prototype.copy.call(u,r),u.color.copy(r.color),u.map=r.map,this.cache.add(c,u)),r=u}if(i||o||l){let c="ClonedMaterial:"+r.uuid+":";i&&(c+="derivative-tangents:"),o&&(c+="vertex-colors:"),l&&(c+="flat-shading:");let u=this.cache.get(c);u||(u=r.clone(),o&&(u.vertexColors=!0),l&&(u.flatShading=!0),i&&(u.normalScale&&(u.normalScale.y*=-1),u.clearcoatNormalScale&&(u.clearcoatNormalScale.y*=-1)),this.cache.add(c,u),this.associations.set(u,this.associations.get(r))),r=u}e.material=r}getMaterialType(){return f.MeshStandardMaterial}loadMaterial(e){const t=this,r=this.json,i=this.extensions,o=r.materials[e];let l;const c={},u=o.extensions||{},d=[];if(u[fe.KHR_MATERIALS_UNLIT]){const p=i[fe.KHR_MATERIALS_UNLIT];l=p.getMaterialType(),d.push(p.extendParams(c,o,t))}else{const p=o.pbrMetallicRoughness||{};if(c.color=new f.Color(1,1,1),c.opacity=1,Array.isArray(p.baseColorFactor)){const _=p.baseColorFactor;c.color.setRGB(_[0],_[1],_[2],yr),c.opacity=_[3]}p.baseColorTexture!==void 0&&d.push(t.assignTexture(c,"map",p.baseColorTexture,ai)),c.metalness=p.metallicFactor!==void 0?p.metallicFactor:1,c.roughness=p.roughnessFactor!==void 0?p.roughnessFactor:1,p.metallicRoughnessTexture!==void 0&&(d.push(t.assignTexture(c,"metalnessMap",p.metallicRoughnessTexture)),d.push(t.assignTexture(c,"roughnessMap",p.metallicRoughnessTexture))),l=this._invokeOne(function(_){return _.getMaterialType&&_.getMaterialType(e)}),d.push(Promise.all(this._invokeAll(function(_){return _.extendMaterialParams&&_.extendMaterialParams(e,c)})))}o.doubleSided===!0&&(c.side=f.DoubleSide);const m=o.alphaMode||Do.OPAQUE;if(m===Do.BLEND?(c.transparent=!0,c.depthWrite=!1):(c.transparent=!1,m===Do.MASK&&(c.alphaTest=o.alphaCutoff!==void 0?o.alphaCutoff:.5)),o.normalTexture!==void 0&&l!==f.MeshBasicMaterial&&(d.push(t.assignTexture(c,"normalMap",o.normalTexture)),c.normalScale=new f.Vector2(1,1),o.normalTexture.scale!==void 0)){const p=o.normalTexture.scale;c.normalScale.set(p,p)}if(o.occlusionTexture!==void 0&&l!==f.MeshBasicMaterial&&(d.push(t.assignTexture(c,"aoMap",o.occlusionTexture)),o.occlusionTexture.strength!==void 0&&(c.aoMapIntensity=o.occlusionTexture.strength)),o.emissiveFactor!==void 0&&l!==f.MeshBasicMaterial){const p=o.emissiveFactor;c.emissive=new f.Color().setRGB(p[0],p[1],p[2],yr)}return o.emissiveTexture!==void 0&&l!==f.MeshBasicMaterial&&d.push(t.assignTexture(c,"emissiveMap",o.emissiveTexture,ai)),Promise.all(d).then(function(){const p=new l(c);return o.name&&(p.name=o.name),vr(p,o),t.associations.set(p,{materials:e}),o.extensions&&li(i,p,o),p})}createUniqueName(e){const t=f.PropertyBinding.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,r=this.extensions,i=this.primitiveCache;function o(c){return r[fe.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(c,t).then(function(u){return ql(u,c,t)})}const l=[];for(let c=0,u=e.length;c<u;c++){const d=e[c],m=zp(d),p=i[m];if(p)l.push(p.promise);else{let _;d.extensions&&d.extensions[fe.KHR_DRACO_MESH_COMPRESSION]?_=o(d):_=ql(new f.BufferGeometry,d,t),i[m]={primitive:d,promise:_},l.push(_)}}return Promise.all(l)}loadMesh(e){const t=this,r=this.json,i=this.extensions,o=r.meshes[e],l=o.primitives,c=[];for(let u=0,d=l.length;u<d;u++){const m=l[u].material===void 0?Up(this.cache):this.getDependency("material",l[u].material);c.push(m)}return c.push(t.loadGeometries(l)),Promise.all(c).then(function(u){const d=u.slice(0,u.length-1),m=u[u.length-1],p=[];for(let v=0,S=m.length;v<S;v++){const M=m[v],x=l[v];let O;const P=d[v];if(x.mode===Ut.TRIANGLES||x.mode===Ut.TRIANGLE_STRIP||x.mode===Ut.TRIANGLE_FAN||x.mode===void 0)O=o.isSkinnedMesh===!0?new f.SkinnedMesh(M,P):new f.Mesh(M,P),O.isSkinnedMesh===!0&&O.normalizeSkinWeights(),x.mode===Ut.TRIANGLE_STRIP?O.geometry=Dl(O.geometry,f.TriangleStripDrawMode):x.mode===Ut.TRIANGLE_FAN&&(O.geometry=Dl(O.geometry,f.TriangleFanDrawMode));else if(x.mode===Ut.LINES)O=new f.LineSegments(M,P);else if(x.mode===Ut.LINE_STRIP)O=new f.Line(M,P);else if(x.mode===Ut.LINE_LOOP)O=new f.LineLoop(M,P);else if(x.mode===Ut.POINTS)O=new f.Points(M,P);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+x.mode);Object.keys(O.geometry.morphAttributes).length>0&&kp(O,o),O.name=t.createUniqueName(o.name||"mesh_"+e),vr(O,o),x.extensions&&li(i,O,x),t.assignFinalMaterial(O),p.push(O)}for(let v=0,S=p.length;v<S;v++)t.associations.set(p[v],{meshes:e,primitives:v});if(p.length===1)return o.extensions&&li(i,p[0],o),p[0];const _=new f.Group;o.extensions&&li(i,_,o),t.associations.set(_,{meshes:e});for(let v=0,S=p.length;v<S;v++)_.add(p[v]);return _})}loadCamera(e){let t;const r=this.json.cameras[e],i=r[r.type];if(!i){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return r.type==="perspective"?t=new f.PerspectiveCamera(f.MathUtils.radToDeg(i.yfov),i.aspectRatio||1,i.znear||1,i.zfar||2e6):r.type==="orthographic"&&(t=new f.OrthographicCamera(-i.xmag,i.xmag,i.ymag,-i.ymag,i.znear,i.zfar)),r.name&&(t.name=this.createUniqueName(r.name)),vr(t,r),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],r=[];for(let i=0,o=t.joints.length;i<o;i++)r.push(this._loadNodeShallow(t.joints[i]));return t.inverseBindMatrices!==void 0?r.push(this.getDependency("accessor",t.inverseBindMatrices)):r.push(null),Promise.all(r).then(function(i){const o=i.pop(),l=i,c=[],u=[];for(let d=0,m=l.length;d<m;d++){const p=l[d];if(p){c.push(p);const _=new f.Matrix4;o!==null&&_.fromArray(o.array,d*16),u.push(_)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[d])}return new f.Skeleton(c,u)})}loadAnimation(e){const t=this.json,r=this,i=t.animations[e],o=i.name?i.name:"animation_"+e,l=[],c=[],u=[],d=[],m=[];for(let p=0,_=i.channels.length;p<_;p++){const v=i.channels[p],S=i.samplers[v.sampler],M=v.target,x=M.node,O=i.parameters!==void 0?i.parameters[S.input]:S.input,P=i.parameters!==void 0?i.parameters[S.output]:S.output;M.node!==void 0&&(l.push(this.getDependency("node",x)),c.push(this.getDependency("accessor",O)),u.push(this.getDependency("accessor",P)),d.push(S),m.push(M))}return Promise.all([Promise.all(l),Promise.all(c),Promise.all(u),Promise.all(d),Promise.all(m)]).then(function(p){const _=p[0],v=p[1],S=p[2],M=p[3],x=p[4],O=[];for(let P=0,C=_.length;P<C;P++){const T=_[P],N=v[P],X=S[P],R=M[P],U=x[P];if(T===void 0)continue;T.updateMatrix&&T.updateMatrix();const $=r._createAnimationTracks(T,N,X,R,U);if($)for(let z=0;z<$.length;z++)O.push($[z])}return new f.AnimationClip(o,void 0,O)})}createNodeMesh(e){const t=this.json,r=this,i=t.nodes[e];return i.mesh===void 0?null:r.getDependency("mesh",i.mesh).then(function(o){const l=r._getNodeRef(r.meshCache,i.mesh,o);return i.weights!==void 0&&l.traverse(function(c){if(c.isMesh)for(let u=0,d=i.weights.length;u<d;u++)c.morphTargetInfluences[u]=i.weights[u]}),l})}loadNode(e){const t=this.json,r=this,i=t.nodes[e],o=r._loadNodeShallow(e),l=[],c=i.children||[];for(let d=0,m=c.length;d<m;d++)l.push(r.getDependency("node",c[d]));const u=i.skin===void 0?Promise.resolve(null):r.getDependency("skin",i.skin);return Promise.all([o,Promise.all(l),u]).then(function(d){const m=d[0],p=d[1],_=d[2];_!==null&&m.traverse(function(v){v.isSkinnedMesh&&v.bind(_,Wp)});for(let v=0,S=p.length;v<S;v++)m.add(p[v]);return m})}_loadNodeShallow(e){const t=this.json,r=this.extensions,i=this;if(this.nodeCache[e]!==void 0)return this.nodeCache[e];const o=t.nodes[e],l=o.name?i.createUniqueName(o.name):"",c=[],u=i._invokeOne(function(d){return d.createNodeMesh&&d.createNodeMesh(e)});return u&&c.push(u),o.camera!==void 0&&c.push(i.getDependency("camera",o.camera).then(function(d){return i._getNodeRef(i.cameraCache,o.camera,d)})),i._invokeAll(function(d){return d.createNodeAttachment&&d.createNodeAttachment(e)}).forEach(function(d){c.push(d)}),this.nodeCache[e]=Promise.all(c).then(function(d){let m;if(o.isBone===!0?m=new f.Bone:d.length>1?m=new f.Group:d.length===1?m=d[0]:m=new f.Object3D,m!==d[0])for(let p=0,_=d.length;p<_;p++)m.add(d[p]);if(o.name&&(m.userData.name=o.name,m.name=l),vr(m,o),o.extensions&&li(r,m,o),o.matrix!==void 0){const p=new f.Matrix4;p.fromArray(o.matrix),m.applyMatrix4(p)}else o.translation!==void 0&&m.position.fromArray(o.translation),o.rotation!==void 0&&m.quaternion.fromArray(o.rotation),o.scale!==void 0&&m.scale.fromArray(o.scale);return i.associations.has(m)||i.associations.set(m,{}),i.associations.get(m).nodes=e,m}),this.nodeCache[e]}loadScene(e){const t=this.extensions,r=this.json.scenes[e],i=this,o=new f.Group;r.name&&(o.name=i.createUniqueName(r.name)),vr(o,r),r.extensions&&li(t,o,r);const l=r.nodes||[],c=[];for(let u=0,d=l.length;u<d;u++)c.push(i.getDependency("node",l[u]));return Promise.all(c).then(function(u){for(let m=0,p=u.length;m<p;m++)o.add(u[m]);const d=m=>{const p=new Map;for(const[_,v]of i.associations)(_ instanceof f.Material||_ instanceof f.Texture)&&p.set(_,v);return m.traverse(_=>{const v=i.associations.get(_);v!=null&&p.set(_,v)}),p};return i.associations=d(o),o})}_createAnimationTracks(e,t,r,i,o){const l=[],c=e.name?e.name:e.uuid,u=[];Ur[o.path]===Ur.weights?e.traverse(function(_){_.morphTargetInfluences&&u.push(_.name?_.name:_.uuid)}):u.push(c);let d;switch(Ur[o.path]){case Ur.weights:d=f.NumberKeyframeTrack;break;case Ur.rotation:d=f.QuaternionKeyframeTrack;break;case Ur.position:case Ur.scale:d=f.VectorKeyframeTrack;break;default:r.itemSize===1?d=f.NumberKeyframeTrack:d=f.VectorKeyframeTrack;break}const m=i.interpolation!==void 0?Bp[i.interpolation]:f.InterpolateLinear,p=this._getArrayFromAccessor(r);for(let _=0,v=u.length;_<v;_++){const S=new d(u[_]+"."+Ur[o.path],t.array,p,m);i.interpolation==="CUBICSPLINE"&&this._createCubicSplineTrackInterpolant(S),l.push(S)}return l}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const r=Fo(t.constructor),i=new Float32Array(t.length);for(let o=0,l=t.length;o<l;o++)i[o]=t[o]*r;t=i}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(r){const i=this instanceof f.QuaternionKeyframeTrack?Tp:Yl;return new i(this.times,this.values,this.getValueSize()/3,r)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function Rp(s,e,t){const r=e.attributes,i=new f.Box3;if(r.POSITION!==void 0){const c=t.json.accessors[r.POSITION],u=c.min,d=c.max;if(u!==void 0&&d!==void 0){if(i.set(new f.Vector3(u[0],u[1],u[2]),new f.Vector3(d[0],d[1],d[2])),c.normalized){const m=Fo(Ui[c.componentType]);i.min.multiplyScalar(m),i.max.multiplyScalar(m)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const o=e.targets;if(o!==void 0){const c=new f.Vector3,u=new f.Vector3;for(let d=0,m=o.length;d<m;d++){const p=o[d];if(p.POSITION!==void 0){const _=t.json.accessors[p.POSITION],v=_.min,S=_.max;if(v!==void 0&&S!==void 0){if(u.setX(Math.max(Math.abs(v[0]),Math.abs(S[0]))),u.setY(Math.max(Math.abs(v[1]),Math.abs(S[1]))),u.setZ(Math.max(Math.abs(v[2]),Math.abs(S[2]))),_.normalized){const M=Fo(Ui[_.componentType]);u.multiplyScalar(M)}c.max(u)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}i.expandByVector(c)}s.boundingBox=i;const l=new f.Sphere;i.getCenter(l.center),l.radius=i.min.distanceTo(i.max)/2,s.boundingSphere=l}function ql(s,e,t){const r=e.attributes,i=[];function o(l,c){return t.getDependency("accessor",l).then(function(u){s.setAttribute(c,u)})}for(const l in r){const c=Oo[l]||l.toLowerCase();c in s.attributes||i.push(o(r[l],c))}if(e.indices!==void 0&&!s.index){const l=t.getDependency("accessor",e.indices).then(function(c){s.setIndex(c)});i.push(l)}return vr(s,e),Rp(s,e,t),Promise.all(i).then(function(){return e.targets!==void 0?Vp(s,e.targets,t):s})}function Ql(s,e,t){const r=t.length-s-1;if(e>=t[r])return r-1;if(e<=t[s])return s;let i=s,o=r,l=Math.floor((i+o)/2);for(;e<t[l]||e>=t[l+1];)e<t[l]?o=l:i=l,l=Math.floor((i+o)/2);return l}function jp(s,e,t,r){const i=[],o=[],l=[];i[0]=1;for(let c=1;c<=t;++c){o[c]=e-r[s+1-c],l[c]=r[s+c]-e;let u=0;for(let d=0;d<c;++d){const m=l[d+1],p=o[c-d],_=i[d]/(m+p);i[d]=u+m*_,u=p*_}i[c]=u}return i}function $p(s,e,t,r){const i=Ql(s,r,e),o=jp(i,r,s,e),l=new f.Vector4(0,0,0,0);for(let c=0;c<=s;++c){const u=t[i-s+c],d=o[c],m=u.w*d;l.x+=u.x*m,l.y+=u.y*m,l.z+=u.z*m,l.w+=u.w*d}return l}function Xp(s,e,t,r,i){const o=[];for(let p=0;p<=t;++p)o[p]=0;const l=[];for(let p=0;p<=r;++p)l[p]=o.slice(0);const c=[];for(let p=0;p<=t;++p)c[p]=o.slice(0);c[0][0]=1;const u=o.slice(0),d=o.slice(0);for(let p=1;p<=t;++p){u[p]=e-i[s+1-p],d[p]=i[s+p]-e;let _=0;for(let v=0;v<p;++v){const S=d[v+1],M=u[p-v];c[p][v]=S+M;const x=c[v][p-1]/c[p][v];c[v][p]=_+S*x,_=M*x}c[p][p]=_}for(let p=0;p<=t;++p)l[0][p]=c[p][t];for(let p=0;p<=t;++p){let _=0,v=1;const S=[];for(let M=0;M<=t;++M)S[M]=o.slice(0);S[0][0]=1;for(let M=1;M<=r;++M){let x=0;const O=p-M,P=t-M;p>=M&&(S[v][0]=S[_][0]/c[P+1][O],x=S[v][0]*c[O][P]);const C=O>=-1?1:-O,T=p-1<=P?M-1:t-p;for(let X=C;X<=T;++X)S[v][X]=(S[_][X]-S[_][X-1])/c[P+1][O+X],x+=S[v][X]*c[O+X][P];p<=P&&(S[v][M]=-S[_][M-1]/c[P+1][p],x+=S[v][M]*c[p][P]),l[M][p]=x;const N=_;_=v,v=N}}let m=t;for(let p=1;p<=r;++p){for(let _=0;_<=t;++_)l[p][_]*=m;m*=t-p}return l}function Yp(s,e,t,r,i){const o=i<s?i:s,l=[],c=Ql(s,r,e),u=Xp(c,r,s,o,e),d=[];for(let m=0;m<t.length;++m){const p=t[m].clone(),_=p.w;p.x*=_,p.y*=_,p.z*=_,d[m]=p}for(let m=0;m<=o;++m){const p=d[c-s].clone().multiplyScalar(u[m][0]);for(let _=1;_<=s;++_)p.add(d[c-s+_].clone().multiplyScalar(u[m][_]));l[m]=p}for(let m=o+1;m<=i+1;++m)l[m]=new f.Vector4(0,0,0);return l}function Zp(s,e){let t=1;for(let i=2;i<=s;++i)t*=i;let r=1;for(let i=2;i<=e;++i)r*=i;for(let i=2;i<=s-e;++i)r*=i;return t/r}function Kp(s){const e=s.length,t=[],r=[];for(let o=0;o<e;++o){const l=s[o];t[o]=new f.Vector3(l.x,l.y,l.z),r[o]=l.w}const i=[];for(let o=0;o<e;++o){const l=t[o].clone();for(let c=1;c<=o;++c)l.sub(i[o-c].clone().multiplyScalar(Zp(o,c)*r[c]));i[o]=l.divideScalar(r[0])}return i}function qp(s,e,t,r,i){const o=Yp(s,e,t,r,i);return Kp(o)}class Jl extends f.Curve{constructor(e,t,r,i,o){super(),this.degree=e,this.knots=t,this.controlPoints=[],this.startKnot=i||0,this.endKnot=o||this.knots.length-1;for(let l=0;l<r.length;++l){const c=r[l];this.controlPoints[l]=new f.Vector4(c.x,c.y,c.z,c.w)}}getPoint(e,t){const r=t||new f.Vector3,i=this.knots[this.startKnot]+e*(this.knots[this.endKnot]-this.knots[this.startKnot]),o=$p(this.degree,this.knots,this.controlPoints,i);return o.w!=1&&o.divideScalar(o.w),r.set(o.x,o.y,o.z)}getTangent(e,t){const r=t||new f.Vector3,i=this.knots[0]+e*(this.knots[this.knots.length-1]-this.knots[0]),o=qp(this.degree,this.knots,this.controlPoints,i,1);return r.copy(o[1]).normalize(),r}}let de,ze,dt;class Qp extends f.Loader{constructor(e){super(e)}load(e,t,r,i){const o=this,l=o.path===""?f.LoaderUtils.extractUrlBase(e):o.path,c=new f.FileLoader(this.manager);c.setPath(o.path),c.setResponseType("arraybuffer"),c.setRequestHeader(o.requestHeader),c.setWithCredentials(o.withCredentials),c.load(e,function(u){try{t(o.parse(u,l))}catch(d){i?i(d):console.error(d),o.manager.itemError(e)}},r,i)}parse(e,t){if(rm(e))de=new tm().parse(e);else{const i=ic(e);if(!im(i))throw new Error("THREE.FBXLoader: Unknown format.");if(ec(i)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+ec(i));de=new em().parse(i)}const r=new f.TextureLoader(this.manager).setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin);return new Jp(r,this.manager).parse(de)}}class Jp{constructor(e,t){this.textureLoader=e,this.manager=t}parse(){ze=this.parseConnections();const e=this.parseImages(),t=this.parseTextures(e),r=this.parseMaterials(t),i=this.parseDeformers(),o=new Ep().parse(i);return this.parseScene(i,o,r),dt}parseConnections(){const e=new Map;return"Connections"in de&&de.Connections.connections.forEach(function(r){const i=r[0],o=r[1],l=r[2];e.has(i)||e.set(i,{parents:[],children:[]});const c={ID:o,relationship:l};e.get(i).parents.push(c),e.has(o)||e.set(o,{parents:[],children:[]});const u={ID:i,relationship:l};e.get(o).children.push(u)}),e}parseImages(){const e={},t={};if("Video"in de.Objects){const r=de.Objects.Video;for(const i in r){const o=r[i],l=parseInt(i);if(e[l]=o.RelativeFilename||o.Filename,"Content"in o){const c=o.Content instanceof ArrayBuffer&&o.Content.byteLength>0,u=typeof o.Content=="string"&&o.Content!=="";if(c||u){const d=this.parseImage(r[i]);t[o.RelativeFilename||o.Filename]=d}}}}for(const r in e){const i=e[r];t[i]!==void 0?e[r]=t[i]:e[r]=e[r].split("\\").pop()}return e}parseImage(e){const t=e.Content,r=e.RelativeFilename||e.Filename,i=r.slice(r.lastIndexOf(".")+1).toLowerCase();let o;switch(i){case"bmp":o="image/bmp";break;case"jpg":case"jpeg":o="image/jpeg";break;case"png":o="image/png";break;case"tif":o="image/tiff";break;case"tga":this.manager.getHandler(".tga")===null&&console.warn("FBXLoader: TGA loader not found, skipping ",r),o="image/tga";break;default:console.warn('FBXLoader: Image type "'+i+'" is not supported.');return}if(typeof t=="string")return"data:"+o+";base64,"+t;{const l=new Uint8Array(t);return window.URL.createObjectURL(new Blob([l],{type:o}))}}parseTextures(e){const t=new Map;if("Texture"in de.Objects){const r=de.Objects.Texture;for(const i in r){const o=this.parseTexture(r[i],e);t.set(parseInt(i),o)}}return t}parseTexture(e,t){const r=this.loadTexture(e,t);r.ID=e.id,r.name=e.attrName;const i=e.WrapModeU,o=e.WrapModeV,l=i!==void 0?i.value:0,c=o!==void 0?o.value:0;if(r.wrapS=l===0?f.RepeatWrapping:f.ClampToEdgeWrapping,r.wrapT=c===0?f.RepeatWrapping:f.ClampToEdgeWrapping,"Scaling"in e){const u=e.Scaling.value;r.repeat.x=u[0],r.repeat.y=u[1]}return r}loadTexture(e,t){let r;const i=this.textureLoader.path,o=ze.get(e.id).children;o!==void 0&&o.length>0&&t[o[0].ID]!==void 0&&(r=t[o[0].ID],(r.indexOf("blob:")===0||r.indexOf("data:")===0)&&this.textureLoader.setPath(void 0));let l;const c=e.FileName.slice(-3).toLowerCase();if(c==="tga"){const u=this.manager.getHandler(".tga");u===null?(console.warn("FBXLoader: TGA loader not found, creating placeholder texture for",e.RelativeFilename),l=new f.Texture):(u.setPath(this.textureLoader.path),l=u.load(r))}else c==="psd"?(console.warn("FBXLoader: PSD textures are not supported, creating placeholder texture for",e.RelativeFilename),l=new f.Texture):l=this.textureLoader.load(r);return this.textureLoader.setPath(i),l}parseMaterials(e){const t=new Map;if("Material"in de.Objects){const r=de.Objects.Material;for(const i in r){const o=this.parseMaterial(r[i],e);o!==null&&t.set(parseInt(i),o)}}return t}parseMaterial(e,t){const r=e.id,i=e.attrName;let o=e.ShadingModel;if(typeof o=="object"&&(o=o.value),!ze.has(r))return null;const l=this.parseParameters(e,t,r);let c;switch(o.toLowerCase()){case"phong":c=new f.MeshPhongMaterial;break;case"lambert":c=new f.MeshLambertMaterial;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',o),c=new f.MeshPhongMaterial;break}return c.setValues(l),c.name=i,c}parseParameters(e,t,r){const i={};e.BumpFactor&&(i.bumpScale=e.BumpFactor.value),e.Diffuse?i.color=new f.Color().fromArray(e.Diffuse.value):e.DiffuseColor&&(e.DiffuseColor.type==="Color"||e.DiffuseColor.type==="ColorRGB")&&(i.color=new f.Color().fromArray(e.DiffuseColor.value)),e.DisplacementFactor&&(i.displacementScale=e.DisplacementFactor.value),e.Emissive?i.emissive=new f.Color().fromArray(e.Emissive.value):e.EmissiveColor&&(e.EmissiveColor.type==="Color"||e.EmissiveColor.type==="ColorRGB")&&(i.emissive=new f.Color().fromArray(e.EmissiveColor.value)),e.EmissiveFactor&&(i.emissiveIntensity=parseFloat(e.EmissiveFactor.value)),e.Opacity&&(i.opacity=parseFloat(e.Opacity.value)),i.opacity<1&&(i.transparent=!0),e.ReflectionFactor&&(i.reflectivity=e.ReflectionFactor.value),e.Shininess&&(i.shininess=e.Shininess.value),e.Specular?i.specular=new f.Color().fromArray(e.Specular.value):e.SpecularColor&&e.SpecularColor.type==="Color"&&(i.specular=new f.Color().fromArray(e.SpecularColor.value));const o=this;return ze.get(r).children.forEach(function(l){const c=l.relationship;switch(c){case"Bump":i.bumpMap=o.getTexture(t,l.ID);break;case"Maya|TEX_ao_map":i.aoMap=o.getTexture(t,l.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":i.map=o.getTexture(t,l.ID),i.map!==void 0&&("colorSpace"in i.map?i.map.colorSpace="srgb":i.map.encoding=3001);break;case"DisplacementColor":i.displacementMap=o.getTexture(t,l.ID);break;case"EmissiveColor":i.emissiveMap=o.getTexture(t,l.ID),i.emissiveMap!==void 0&&("colorSpace"in i.emissiveMap?i.emissiveMap.colorSpace="srgb":i.emissiveMap.encoding=3001);break;case"NormalMap":case"Maya|TEX_normal_map":i.normalMap=o.getTexture(t,l.ID);break;case"ReflectionColor":i.envMap=o.getTexture(t,l.ID),i.envMap!==void 0&&(i.envMap.mapping=f.EquirectangularReflectionMapping,"colorSpace"in i.envMap?i.envMap.colorSpace="srgb":i.envMap.encoding=3001);break;case"SpecularColor":i.specularMap=o.getTexture(t,l.ID),i.specularMap!==void 0&&("colorSpace"in i.specularMap?i.specularMap.colorSpace="srgb":i.specularMap.encoding=3001);break;case"TransparentColor":case"TransparencyFactor":i.alphaMap=o.getTexture(t,l.ID),i.transparent=!0;break;default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",c);break}}),i}getTexture(e,t){return"LayeredTexture"in de.Objects&&t in de.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),t=ze.get(t).children[0].ID),e.get(t)}parseDeformers(){const e={},t={};if("Deformer"in de.Objects){const r=de.Objects.Deformer;for(const i in r){const o=r[i],l=ze.get(parseInt(i));if(o.attrType==="Skin"){const c=this.parseSkeleton(l,r);c.ID=i,l.parents.length>1&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),c.geometryID=l.parents[0].ID,e[i]=c}else if(o.attrType==="BlendShape"){const c={id:i};c.rawTargets=this.parseMorphTargets(l,r),c.id=i,l.parents.length>1&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),t[i]=c}}}return{skeletons:e,morphTargets:t}}parseSkeleton(e,t){const r=[];return e.children.forEach(function(i){const o=t[i.ID];if(o.attrType!=="Cluster")return;const l={ID:i.ID,indices:[],weights:[],transformLink:new f.Matrix4().fromArray(o.TransformLink.a)};"Indexes"in o&&(l.indices=o.Indexes.a,l.weights=o.Weights.a),r.push(l)}),{rawBones:r,bones:[]}}parseMorphTargets(e,t){const r=[];for(let i=0;i<e.children.length;i++){const o=e.children[i],l=t[o.ID],c={name:l.attrName,initialWeight:l.DeformPercent,id:l.id,fullWeights:l.FullWeights.a};if(l.attrType!=="BlendShapeChannel")return;c.geoID=ze.get(parseInt(o.ID)).children.filter(function(u){return u.relationship===void 0})[0].ID,r.push(c)}return r}parseScene(e,t,r){dt=new f.Group;const i=this.parseModels(e.skeletons,t,r),o=de.Objects.Model,l=this;i.forEach(function(u){const d=o[u.ID];l.setLookAtProperties(u,d),ze.get(u.ID).parents.forEach(function(p){const _=i.get(p.ID);_!==void 0&&_.add(u)}),u.parent===null&&dt.add(u)}),this.bindSkeleton(e.skeletons,t,i),this.createAmbientLight(),dt.traverse(function(u){if(u.userData.transformData){u.parent&&(u.userData.transformData.parentMatrix=u.parent.matrix,u.userData.transformData.parentMatrixWorld=u.parent.matrixWorld);const d=tc(u.userData.transformData);u.applyMatrix4(d),u.updateWorldMatrix()}});const c=new Hp().parse();dt.children.length===1&&dt.children[0].isGroup&&(dt.children[0].animations=c,dt=dt.children[0]),dt.animations=c}parseModels(e,t,r){const i=new Map,o=de.Objects.Model;for(const l in o){const c=parseInt(l),u=o[l],d=ze.get(c);let m=this.buildSkeleton(d,e,c,u.attrName);if(!m){switch(u.attrType){case"Camera":m=this.createCamera(d);break;case"Light":m=this.createLight(d);break;case"Mesh":m=this.createMesh(d,t,r);break;case"NurbsCurve":m=this.createCurve(d,t);break;case"LimbNode":case"Root":m=new f.Bone;break;default:m=new f.Group;break}m.name=u.attrName?f.PropertyBinding.sanitizeNodeName(u.attrName):"",m.ID=c}this.getTransformData(m,u),i.set(c,m)}return i}buildSkeleton(e,t,r,i){let o=null;return e.parents.forEach(function(l){for(const c in t){const u=t[c];u.rawBones.forEach(function(d,m){if(d.ID===l.ID){const p=o;o=new f.Bone,o.matrixWorld.copy(d.transformLink),o.name=i?f.PropertyBinding.sanitizeNodeName(i):"",o.ID=r,u.bones[m]=o,p!==null&&o.add(p)}})}}),o}createCamera(e){let t,r;if(e.children.forEach(function(i){const o=de.Objects.NodeAttribute[i.ID];o!==void 0&&(r=o)}),r===void 0)t=new f.Object3D;else{let i=0;r.CameraProjectionType!==void 0&&r.CameraProjectionType.value===1&&(i=1);let o=1;r.NearPlane!==void 0&&(o=r.NearPlane.value/1e3);let l=1e3;r.FarPlane!==void 0&&(l=r.FarPlane.value/1e3);let c=window.innerWidth,u=window.innerHeight;r.AspectWidth!==void 0&&r.AspectHeight!==void 0&&(c=r.AspectWidth.value,u=r.AspectHeight.value);const d=c/u;let m=45;r.FieldOfView!==void 0&&(m=r.FieldOfView.value);const p=r.FocalLength?r.FocalLength.value:null;switch(i){case 0:t=new f.PerspectiveCamera(m,d,o,l),p!==null&&t.setFocalLength(p);break;case 1:t=new f.OrthographicCamera(-c/2,c/2,u/2,-u/2,o,l);break;default:console.warn("THREE.FBXLoader: Unknown camera type "+i+"."),t=new f.Object3D;break}}return t}createLight(e){let t,r;if(e.children.forEach(function(i){const o=de.Objects.NodeAttribute[i.ID];o!==void 0&&(r=o)}),r===void 0)t=new f.Object3D;else{let i;r.LightType===void 0?i=0:i=r.LightType.value;let o=16777215;r.Color!==void 0&&(o=new f.Color().fromArray(r.Color.value));let l=r.Intensity===void 0?1:r.Intensity.value/100;r.CastLightOnObject!==void 0&&r.CastLightOnObject.value===0&&(l=0);let c=0;r.FarAttenuationEnd!==void 0&&(r.EnableFarAttenuation!==void 0&&r.EnableFarAttenuation.value===0?c=0:c=r.FarAttenuationEnd.value);const u=1;switch(i){case 0:t=new f.PointLight(o,l,c,u);break;case 1:t=new f.DirectionalLight(o,l);break;case 2:let d=Math.PI/3;r.InnerAngle!==void 0&&(d=f.MathUtils.degToRad(r.InnerAngle.value));let m=0;r.OuterAngle!==void 0&&(m=f.MathUtils.degToRad(r.OuterAngle.value),m=Math.max(m,1)),t=new f.SpotLight(o,l,c,d,m,u);break;default:console.warn("THREE.FBXLoader: Unknown light type "+r.LightType.value+", defaulting to a PointLight."),t=new f.PointLight(o,l);break}r.CastShadows!==void 0&&r.CastShadows.value===1&&(t.castShadow=!0)}return t}createMesh(e,t,r){let i,o=null,l=null;const c=[];return e.children.forEach(function(u){t.has(u.ID)&&(o=t.get(u.ID)),r.has(u.ID)&&c.push(r.get(u.ID))}),c.length>1?l=c:c.length>0?l=c[0]:(l=new f.MeshPhongMaterial({color:13421772}),c.push(l)),"color"in o.attributes&&c.forEach(function(u){u.vertexColors=!0}),o.FBX_Deformer?(i=new f.SkinnedMesh(o,l),i.normalizeSkinWeights()):i=new f.Mesh(o,l),i}createCurve(e,t){const r=e.children.reduce(function(o,l){return t.has(l.ID)&&(o=t.get(l.ID)),o},null),i=new f.LineBasicMaterial({color:3342591,linewidth:1});return new f.Line(r,i)}getTransformData(e,t){const r={};"InheritType"in t&&(r.inheritType=parseInt(t.InheritType.value)),"RotationOrder"in t?r.eulerOrder=rc(t.RotationOrder.value):r.eulerOrder="ZYX","Lcl_Translation"in t&&(r.translation=t.Lcl_Translation.value),"PreRotation"in t&&(r.preRotation=t.PreRotation.value),"Lcl_Rotation"in t&&(r.rotation=t.Lcl_Rotation.value),"PostRotation"in t&&(r.postRotation=t.PostRotation.value),"Lcl_Scaling"in t&&(r.scale=t.Lcl_Scaling.value),"ScalingOffset"in t&&(r.scalingOffset=t.ScalingOffset.value),"ScalingPivot"in t&&(r.scalingPivot=t.ScalingPivot.value),"RotationOffset"in t&&(r.rotationOffset=t.RotationOffset.value),"RotationPivot"in t&&(r.rotationPivot=t.RotationPivot.value),e.userData.transformData=r}setLookAtProperties(e,t){"LookAtProperty"in t&&ze.get(e.ID).children.forEach(function(i){if(i.relationship==="LookAtProperty"){const o=de.Objects.Model[i.ID];if("Lcl_Translation"in o){const l=o.Lcl_Translation.value;e.target!==void 0?(e.target.position.fromArray(l),dt.add(e.target)):e.lookAt(new f.Vector3().fromArray(l))}}})}bindSkeleton(e,t,r){const i=this.parsePoseNodes();for(const o in e){const l=e[o];ze.get(parseInt(l.ID)).parents.forEach(function(u){if(t.has(u.ID)){const d=u.ID;ze.get(d).parents.forEach(function(p){r.has(p.ID)&&r.get(p.ID).bind(new f.Skeleton(l.bones),i[p.ID])})}})}}parsePoseNodes(){const e={};if("Pose"in de.Objects){const t=de.Objects.Pose;for(const r in t)if(t[r].attrType==="BindPose"&&t[r].NbPoseNodes>0){const i=t[r].PoseNode;Array.isArray(i)?i.forEach(function(o){e[o.Node]=new f.Matrix4().fromArray(o.Matrix.a)}):e[i.Node]=new f.Matrix4().fromArray(i.Matrix.a)}}return e}createAmbientLight(){if("GlobalSettings"in de&&"AmbientColor"in de.GlobalSettings){const e=de.GlobalSettings.AmbientColor.value,t=e[0],r=e[1],i=e[2];if(t!==0||r!==0||i!==0){const o=new f.Color(t,r,i);dt.add(new f.AmbientLight(o,1))}}}}class Ep{parse(e){const t=new Map;if("Geometry"in de.Objects){const r=de.Objects.Geometry;for(const i in r){const o=ze.get(parseInt(i)),l=this.parseGeometry(o,r[i],e);t.set(parseInt(i),l)}}return t}parseGeometry(e,t,r){switch(t.attrType){case"Mesh":return this.parseMeshGeometry(e,t,r);case"NurbsCurve":return this.parseNurbsGeometry(t)}}parseMeshGeometry(e,t,r){const i=r.skeletons,o=[],l=e.parents.map(function(p){return de.Objects.Model[p.ID]});if(l.length===0)return;const c=e.children.reduce(function(p,_){return i[_.ID]!==void 0&&(p=i[_.ID]),p},null);e.children.forEach(function(p){r.morphTargets[p.ID]!==void 0&&o.push(r.morphTargets[p.ID])});const u=l[0],d={};"RotationOrder"in u&&(d.eulerOrder=rc(u.RotationOrder.value)),"InheritType"in u&&(d.inheritType=parseInt(u.InheritType.value)),"GeometricTranslation"in u&&(d.translation=u.GeometricTranslation.value),"GeometricRotation"in u&&(d.rotation=u.GeometricRotation.value),"GeometricScaling"in u&&(d.scale=u.GeometricScaling.value);const m=tc(d);return this.genGeometry(t,c,o,m)}genGeometry(e,t,r,i){const o=new f.BufferGeometry;e.attrName&&(o.name=e.attrName);const l=this.parseGeoNode(e,t),c=this.genBuffers(l),u=new f.Float32BufferAttribute(c.vertex,3);if(u.applyMatrix4(i),o.setAttribute("position",u),c.colors.length>0&&o.setAttribute("color",new f.Float32BufferAttribute(c.colors,3)),t&&(o.setAttribute("skinIndex",new f.Uint16BufferAttribute(c.weightsIndices,4)),o.setAttribute("skinWeight",new f.Float32BufferAttribute(c.vertexWeights,4)),o.FBX_Deformer=t),c.normal.length>0){const d=new f.Matrix3().getNormalMatrix(i),m=new f.Float32BufferAttribute(c.normal,3);m.applyNormalMatrix(d),o.setAttribute("normal",m)}if(c.uvs.forEach(function(d,m){bo==="uv2"&&m++;const p=m===0?"uv":`uv${m}`;o.setAttribute(p,new f.Float32BufferAttribute(c.uvs[m],2))}),l.material&&l.material.mappingType!=="AllSame"){let d=c.materialIndex[0],m=0;if(c.materialIndex.forEach(function(p,_){p!==d&&(o.addGroup(m,_-m,d),d=p,m=_)}),o.groups.length>0){const p=o.groups[o.groups.length-1],_=p.start+p.count;_!==c.materialIndex.length&&o.addGroup(_,c.materialIndex.length-_,d)}o.groups.length===0&&o.addGroup(0,c.materialIndex.length,c.materialIndex[0])}return this.addMorphTargets(o,e,r,i),o}parseGeoNode(e,t){const r={};if(r.vertexPositions=e.Vertices!==void 0?e.Vertices.a:[],r.vertexIndices=e.PolygonVertexIndex!==void 0?e.PolygonVertexIndex.a:[],e.LayerElementColor&&(r.color=this.parseVertexColors(e.LayerElementColor[0])),e.LayerElementMaterial&&(r.material=this.parseMaterialIndices(e.LayerElementMaterial[0])),e.LayerElementNormal&&(r.normal=this.parseNormals(e.LayerElementNormal[0])),e.LayerElementUV){r.uv=[];let i=0;for(;e.LayerElementUV[i];)e.LayerElementUV[i].UV&&r.uv.push(this.parseUVs(e.LayerElementUV[i])),i++}return r.weightTable={},t!==null&&(r.skeleton=t,t.rawBones.forEach(function(i,o){i.indices.forEach(function(l,c){r.weightTable[l]===void 0&&(r.weightTable[l]=[]),r.weightTable[l].push({id:o,weight:i.weights[c]})})})),r}genBuffers(e){const t={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]};let r=0,i=0,o=!1,l=[],c=[],u=[],d=[],m=[],p=[];const _=this;return e.vertexIndices.forEach(function(v,S){let M,x=!1;v<0&&(v=v^-1,x=!0);let O=[],P=[];if(l.push(v*3,v*3+1,v*3+2),e.color){const C=rs(S,r,v,e.color);u.push(C[0],C[1],C[2])}if(e.skeleton){if(e.weightTable[v]!==void 0&&e.weightTable[v].forEach(function(C){P.push(C.weight),O.push(C.id)}),P.length>4){o||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),o=!0);const C=[0,0,0,0],T=[0,0,0,0];P.forEach(function(N,X){let R=N,U=O[X];T.forEach(function($,z,V){if(R>$){V[z]=R,R=$;const Y=C[z];C[z]=U,U=Y}})}),O=C,P=T}for(;P.length<4;)P.push(0),O.push(0);for(let C=0;C<4;++C)m.push(P[C]),p.push(O[C])}if(e.normal){const C=rs(S,r,v,e.normal);c.push(C[0],C[1],C[2])}e.material&&e.material.mappingType!=="AllSame"&&(M=rs(S,r,v,e.material)[0]),e.uv&&e.uv.forEach(function(C,T){const N=rs(S,r,v,C);d[T]===void 0&&(d[T]=[]),d[T].push(N[0]),d[T].push(N[1])}),i++,x&&(_.genFace(t,e,l,M,c,u,d,m,p,i),r++,i=0,l=[],c=[],u=[],d=[],m=[],p=[])}),t}genFace(e,t,r,i,o,l,c,u,d,m){for(let p=2;p<m;p++)e.vertex.push(t.vertexPositions[r[0]]),e.vertex.push(t.vertexPositions[r[1]]),e.vertex.push(t.vertexPositions[r[2]]),e.vertex.push(t.vertexPositions[r[(p-1)*3]]),e.vertex.push(t.vertexPositions[r[(p-1)*3+1]]),e.vertex.push(t.vertexPositions[r[(p-1)*3+2]]),e.vertex.push(t.vertexPositions[r[p*3]]),e.vertex.push(t.vertexPositions[r[p*3+1]]),e.vertex.push(t.vertexPositions[r[p*3+2]]),t.skeleton&&(e.vertexWeights.push(u[0]),e.vertexWeights.push(u[1]),e.vertexWeights.push(u[2]),e.vertexWeights.push(u[3]),e.vertexWeights.push(u[(p-1)*4]),e.vertexWeights.push(u[(p-1)*4+1]),e.vertexWeights.push(u[(p-1)*4+2]),e.vertexWeights.push(u[(p-1)*4+3]),e.vertexWeights.push(u[p*4]),e.vertexWeights.push(u[p*4+1]),e.vertexWeights.push(u[p*4+2]),e.vertexWeights.push(u[p*4+3]),e.weightsIndices.push(d[0]),e.weightsIndices.push(d[1]),e.weightsIndices.push(d[2]),e.weightsIndices.push(d[3]),e.weightsIndices.push(d[(p-1)*4]),e.weightsIndices.push(d[(p-1)*4+1]),e.weightsIndices.push(d[(p-1)*4+2]),e.weightsIndices.push(d[(p-1)*4+3]),e.weightsIndices.push(d[p*4]),e.weightsIndices.push(d[p*4+1]),e.weightsIndices.push(d[p*4+2]),e.weightsIndices.push(d[p*4+3])),t.color&&(e.colors.push(l[0]),e.colors.push(l[1]),e.colors.push(l[2]),e.colors.push(l[(p-1)*3]),e.colors.push(l[(p-1)*3+1]),e.colors.push(l[(p-1)*3+2]),e.colors.push(l[p*3]),e.colors.push(l[p*3+1]),e.colors.push(l[p*3+2])),t.material&&t.material.mappingType!=="AllSame"&&(e.materialIndex.push(i),e.materialIndex.push(i),e.materialIndex.push(i)),t.normal&&(e.normal.push(o[0]),e.normal.push(o[1]),e.normal.push(o[2]),e.normal.push(o[(p-1)*3]),e.normal.push(o[(p-1)*3+1]),e.normal.push(o[(p-1)*3+2]),e.normal.push(o[p*3]),e.normal.push(o[p*3+1]),e.normal.push(o[p*3+2])),t.uv&&t.uv.forEach(function(_,v){e.uvs[v]===void 0&&(e.uvs[v]=[]),e.uvs[v].push(c[v][0]),e.uvs[v].push(c[v][1]),e.uvs[v].push(c[v][(p-1)*2]),e.uvs[v].push(c[v][(p-1)*2+1]),e.uvs[v].push(c[v][p*2]),e.uvs[v].push(c[v][p*2+1])})}addMorphTargets(e,t,r,i){if(r.length===0)return;e.morphTargetsRelative=!0,e.morphAttributes.position=[];const o=this;r.forEach(function(l){l.rawTargets.forEach(function(c){const u=de.Objects.Geometry[c.geoID];u!==void 0&&o.genMorphGeometry(e,t,u,i,c.name)})})}genMorphGeometry(e,t,r,i,o){const l=t.PolygonVertexIndex!==void 0?t.PolygonVertexIndex.a:[],c=r.Vertices!==void 0?r.Vertices.a:[],u=r.Indexes!==void 0?r.Indexes.a:[],d=e.attributes.position.count*3,m=new Float32Array(d);for(let S=0;S<u.length;S++){const M=u[S]*3;m[M]=c[S*3],m[M+1]=c[S*3+1],m[M+2]=c[S*3+2]}const p={vertexIndices:l,vertexPositions:m},_=this.genBuffers(p),v=new f.Float32BufferAttribute(_.vertex,3);v.name=o||r.attrName,v.applyMatrix4(i),e.morphAttributes.position.push(v)}parseNormals(e){const t=e.MappingInformationType,r=e.ReferenceInformationType,i=e.Normals.a;let o=[];return r==="IndexToDirect"&&("NormalIndex"in e?o=e.NormalIndex.a:"NormalsIndex"in e&&(o=e.NormalsIndex.a)),{dataSize:3,buffer:i,indices:o,mappingType:t,referenceType:r}}parseUVs(e){const t=e.MappingInformationType,r=e.ReferenceInformationType,i=e.UV.a;let o=[];return r==="IndexToDirect"&&(o=e.UVIndex.a),{dataSize:2,buffer:i,indices:o,mappingType:t,referenceType:r}}parseVertexColors(e){const t=e.MappingInformationType,r=e.ReferenceInformationType,i=e.Colors.a;let o=[];return r==="IndexToDirect"&&(o=e.ColorIndex.a),{dataSize:4,buffer:i,indices:o,mappingType:t,referenceType:r}}parseMaterialIndices(e){const t=e.MappingInformationType,r=e.ReferenceInformationType;if(t==="NoMappingInformation")return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:r};const i=e.Materials.a,o=[];for(let l=0;l<i.length;++l)o.push(l);return{dataSize:1,buffer:i,indices:o,mappingType:t,referenceType:r}}parseNurbsGeometry(e){if(Jl===void 0)return console.error("THREE.FBXLoader: The loader relies on NURBSCurve for any nurbs present in the model. Nurbs will show up as empty geometry."),new f.BufferGeometry;const t=parseInt(e.Order);if(isNaN(t))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",e.Order,e.id),new f.BufferGeometry;const r=t-1,i=e.KnotVector.a,o=[],l=e.Points.a;for(let p=0,_=l.length;p<_;p+=4)o.push(new f.Vector4().fromArray(l,p));let c,u;if(e.Form==="Closed")o.push(o[0]);else if(e.Form==="Periodic"){c=r,u=i.length-1-c;for(let p=0;p<r;++p)o.push(o[p])}const m=new Jl(r,i,o,c,u).getPoints(o.length*12);return new f.BufferGeometry().setFromPoints(m)}}class Hp{parse(){const e=[],t=this.parseClips();if(t!==void 0)for(const r in t){const i=t[r],o=this.addClip(i);e.push(o)}return e}parseClips(){if(de.Objects.AnimationCurve===void 0)return;const e=this.parseAnimationCurveNodes();this.parseAnimationCurves(e);const t=this.parseAnimationLayers(e);return this.parseAnimStacks(t)}parseAnimationCurveNodes(){const e=de.Objects.AnimationCurveNode,t=new Map;for(const r in e){const i=e[r];if(i.attrName.match(/S|R|T|DeformPercent/)!==null){const o={id:i.id,attr:i.attrName,curves:{}};t.set(o.id,o)}}return t}parseAnimationCurves(e){const t=de.Objects.AnimationCurve;for(const r in t){const i={id:t[r].id,times:t[r].KeyTime.a.map(nm),values:t[r].KeyValueFloat.a},o=ze.get(i.id);if(o!==void 0){const l=o.parents[0].ID,c=o.parents[0].relationship;c.match(/X/)?e.get(l).curves.x=i:c.match(/Y/)?e.get(l).curves.y=i:c.match(/Z/)?e.get(l).curves.z=i:c.match(/d|DeformPercent/)&&e.has(l)&&(e.get(l).curves.morph=i)}}}parseAnimationLayers(e){const t=de.Objects.AnimationLayer,r=new Map;for(const i in t){const o=[],l=ze.get(parseInt(i));l!==void 0&&(l.children.forEach(function(u,d){if(e.has(u.ID)){const m=e.get(u.ID);if(m.curves.x!==void 0||m.curves.y!==void 0||m.curves.z!==void 0){if(o[d]===void 0){const p=ze.get(u.ID).parents.filter(function(_){return _.relationship!==void 0})[0].ID;if(p!==void 0){const _=de.Objects.Model[p.toString()];if(_===void 0){console.warn("THREE.FBXLoader: Encountered a unused curve.",u);return}const v={modelName:_.attrName?f.PropertyBinding.sanitizeNodeName(_.attrName):"",ID:_.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};dt.traverse(function(S){S.ID===_.id&&(v.transform=S.matrix,S.userData.transformData&&(v.eulerOrder=S.userData.transformData.eulerOrder))}),v.transform||(v.transform=new f.Matrix4),"PreRotation"in _&&(v.preRotation=_.PreRotation.value),"PostRotation"in _&&(v.postRotation=_.PostRotation.value),o[d]=v}}o[d]&&(o[d][m.attr]=m)}else if(m.curves.morph!==void 0){if(o[d]===void 0){const p=ze.get(u.ID).parents.filter(function(O){return O.relationship!==void 0})[0].ID,_=ze.get(p).parents[0].ID,v=ze.get(_).parents[0].ID,S=ze.get(v).parents[0].ID,M=de.Objects.Model[S],x={modelName:M.attrName?f.PropertyBinding.sanitizeNodeName(M.attrName):"",morphName:de.Objects.Deformer[p].attrName};o[d]=x}o[d][m.attr]=m}}}),r.set(parseInt(i),o))}return r}parseAnimStacks(e){const t=de.Objects.AnimationStack,r={};for(const i in t){const o=ze.get(parseInt(i)).children;o.length>1&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");const l=e.get(o[0].ID);r[i]={name:t[i].attrName,layer:l}}return r}addClip(e){let t=[];const r=this;return e.layer.forEach(function(i){t=t.concat(r.generateTracks(i))}),new f.AnimationClip(e.name,-1,t)}generateTracks(e){const t=[];let r=new f.Vector3,i=new f.Quaternion,o=new f.Vector3;if(e.transform&&e.transform.decompose(r,i,o),r=r.toArray(),i=new f.Euler().setFromQuaternion(i,e.eulerOrder).toArray(),o=o.toArray(),e.T!==void 0&&Object.keys(e.T.curves).length>0){const l=this.generateVectorTrack(e.modelName,e.T.curves,r,"position");l!==void 0&&t.push(l)}if(e.R!==void 0&&Object.keys(e.R.curves).length>0){const l=this.generateRotationTrack(e.modelName,e.R.curves,i,e.preRotation,e.postRotation,e.eulerOrder);l!==void 0&&t.push(l)}if(e.S!==void 0&&Object.keys(e.S.curves).length>0){const l=this.generateVectorTrack(e.modelName,e.S.curves,o,"scale");l!==void 0&&t.push(l)}if(e.DeformPercent!==void 0){const l=this.generateMorphTrack(e);l!==void 0&&t.push(l)}return t}generateVectorTrack(e,t,r,i){const o=this.getTimesForAllAxes(t),l=this.getKeyframeTrackValues(o,t,r);return new f.VectorKeyframeTrack(e+"."+i,o,l)}generateRotationTrack(e,t,r,i,o,l){t.x!==void 0&&(this.interpolateRotations(t.x),t.x.values=t.x.values.map(f.MathUtils.degToRad)),t.y!==void 0&&(this.interpolateRotations(t.y),t.y.values=t.y.values.map(f.MathUtils.degToRad)),t.z!==void 0&&(this.interpolateRotations(t.z),t.z.values=t.z.values.map(f.MathUtils.degToRad));const c=this.getTimesForAllAxes(t),u=this.getKeyframeTrackValues(c,t,r);i!==void 0&&(i=i.map(f.MathUtils.degToRad),i.push(l),i=new f.Euler().fromArray(i),i=new f.Quaternion().setFromEuler(i)),o!==void 0&&(o=o.map(f.MathUtils.degToRad),o.push(l),o=new f.Euler().fromArray(o),o=new f.Quaternion().setFromEuler(o).invert());const d=new f.Quaternion,m=new f.Euler,p=[];for(let _=0;_<u.length;_+=3)m.set(u[_],u[_+1],u[_+2],l),d.setFromEuler(m),i!==void 0&&d.premultiply(i),o!==void 0&&d.multiply(o),d.toArray(p,_/3*4);return new f.QuaternionKeyframeTrack(e+".quaternion",c,p)}generateMorphTrack(e){const t=e.DeformPercent.curves.morph,r=t.values.map(function(o){return o/100}),i=dt.getObjectByName(e.modelName).morphTargetDictionary[e.morphName];return new f.NumberKeyframeTrack(e.modelName+".morphTargetInfluences["+i+"]",t.times,r)}getTimesForAllAxes(e){let t=[];if(e.x!==void 0&&(t=t.concat(e.x.times)),e.y!==void 0&&(t=t.concat(e.y.times)),e.z!==void 0&&(t=t.concat(e.z.times)),t=t.sort(function(r,i){return r-i}),t.length>1){let r=1,i=t[0];for(let o=1;o<t.length;o++){const l=t[o];l!==i&&(t[r]=l,i=l,r++)}t=t.slice(0,r)}return t}getKeyframeTrackValues(e,t,r){const i=r,o=[];let l=-1,c=-1,u=-1;return e.forEach(function(d){if(t.x&&(l=t.x.times.indexOf(d)),t.y&&(c=t.y.times.indexOf(d)),t.z&&(u=t.z.times.indexOf(d)),l!==-1){const m=t.x.values[l];o.push(m),i[0]=m}else o.push(i[0]);if(c!==-1){const m=t.y.values[c];o.push(m),i[1]=m}else o.push(i[1]);if(u!==-1){const m=t.z.values[u];o.push(m),i[2]=m}else o.push(i[2])}),o}interpolateRotations(e){for(let t=1;t<e.values.length;t++){const r=e.values[t-1],i=e.values[t]-r,o=Math.abs(i);if(o>=180){const l=o/180,c=i/l;let u=r+c;const d=e.times[t-1],p=(e.times[t]-d)/l;let _=d+p;const v=[],S=[];for(;_<e.times[t];)v.push(_),_+=p,S.push(u),u+=c;e.times=nc(e.times,t,v),e.values=nc(e.values,t,S)}}}}class em{getPrevNode(){return this.nodeStack[this.currentIndent-2]}getCurrentNode(){return this.nodeStack[this.currentIndent-1]}getCurrentProp(){return this.currentProp}pushStack(e){this.nodeStack.push(e),this.currentIndent+=1}popStack(){this.nodeStack.pop(),this.currentIndent-=1}setCurrentProp(e,t){this.currentProp=e,this.currentPropName=t}parse(e){this.currentIndent=0,this.allNodes=new Hl,this.nodeStack=[],this.currentProp=[],this.currentPropName="";const t=this,r=e.split(/[\r\n]+/);return r.forEach(function(i,o){const l=i.match(/^[\s\t]*;/),c=i.match(/^[\s\t]*$/);if(l||c)return;const u=i.match("^\\t{"+t.currentIndent+"}(\\w+):(.*){",""),d=i.match("^\\t{"+t.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),m=i.match("^\\t{"+(t.currentIndent-1)+"}}");u?t.parseNodeBegin(i,u):d?t.parseNodeProperty(i,d,r[++o]):m?t.popStack():i.match(/^[^\s\t}]/)&&t.parseNodePropertyContinued(i)}),this.allNodes}parseNodeBegin(e,t){const r=t[1].trim().replace(/^"/,"").replace(/"$/,""),i=t[2].split(",").map(function(u){return u.trim().replace(/^"/,"").replace(/"$/,"")}),o={name:r},l=this.parseNodeAttr(i),c=this.getCurrentNode();this.currentIndent===0?this.allNodes.add(r,o):r in c?(r==="PoseNode"?c.PoseNode.push(o):c[r].id!==void 0&&(c[r]={},c[r][c[r].id]=c[r]),l.id!==""&&(c[r][l.id]=o)):typeof l.id=="number"?(c[r]={},c[r][l.id]=o):r!=="Properties70"&&(r==="PoseNode"?c[r]=[o]:c[r]=o),typeof l.id=="number"&&(o.id=l.id),l.name!==""&&(o.attrName=l.name),l.type!==""&&(o.attrType=l.type),this.pushStack(o)}parseNodeAttr(e){let t=e[0];e[0]!==""&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));let r="",i="";return e.length>1&&(r=e[1].replace(/^(\w+)::/,""),i=e[2]),{id:t,name:r,type:i}}parseNodeProperty(e,t,r){let i=t[1].replace(/^"/,"").replace(/"$/,"").trim(),o=t[2].replace(/^"/,"").replace(/"$/,"").trim();i==="Content"&&o===","&&(o=r.replace(/"/g,"").replace(/,$/,"").trim());const l=this.getCurrentNode();if(l.name==="Properties70"){this.parseNodeSpecialProperty(e,i,o);return}if(i==="C"){const u=o.split(",").slice(1),d=parseInt(u[0]),m=parseInt(u[1]);let p=o.split(",").slice(3);p=p.map(function(_){return _.trim().replace(/^"/,"")}),i="connections",o=[d,m],om(o,p),l[i]===void 0&&(l[i]=[])}i==="Node"&&(l.id=o),i in l&&Array.isArray(l[i])?l[i].push(o):i!=="a"?l[i]=o:l.a=o,this.setCurrentProp(l,i),i==="a"&&o.slice(-1)!==","&&(l.a=Bo(o))}parseNodePropertyContinued(e){const t=this.getCurrentNode();t.a+=e,e.slice(-1)!==","&&(t.a=Bo(t.a))}parseNodeSpecialProperty(e,t,r){const i=r.split('",').map(function(m){return m.trim().replace(/^\"/,"").replace(/\s/,"_")}),o=i[0],l=i[1],c=i[2],u=i[3];let d=i[4];switch(l){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":d=parseFloat(d);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":d=Bo(d);break}this.getPrevNode()[o]={type:l,type2:c,flag:u,value:d},this.setCurrentProp(this.getPrevNode(),o)}}class tm{parse(e){const t=new El(e);t.skip(23);const r=t.getUint32();if(r<6400)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+r);const i=new Hl;for(;!this.endOfContent(t);){const o=this.parseNode(t,r);o!==null&&i.add(o.name,o)}return i}endOfContent(e){return e.size()%16===0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()}parseNode(e,t){const r={},i=t>=7500?e.getUint64():e.getUint32(),o=t>=7500?e.getUint64():e.getUint32();t>=7500?e.getUint64():e.getUint32();const l=e.getUint8(),c=e.getString(l);if(i===0)return null;const u=[];for(let _=0;_<o;_++)u.push(this.parseProperty(e));const d=u.length>0?u[0]:"",m=u.length>1?u[1]:"",p=u.length>2?u[2]:"";for(r.singleProperty=o===1&&e.getOffset()===i;i>e.getOffset();){const _=this.parseNode(e,t);_!==null&&this.parseSubNode(c,r,_)}return r.propertyList=u,typeof d=="number"&&(r.id=d),m!==""&&(r.attrName=m),p!==""&&(r.attrType=p),c!==""&&(r.name=c),r}parseSubNode(e,t,r){if(r.singleProperty===!0){const i=r.propertyList[0];Array.isArray(i)?(t[r.name]=r,r.a=i):t[r.name]=i}else if(e==="Connections"&&r.name==="C"){const i=[];r.propertyList.forEach(function(o,l){l!==0&&i.push(o)}),t.connections===void 0&&(t.connections=[]),t.connections.push(i)}else if(r.name==="Properties70")Object.keys(r).forEach(function(o){t[o]=r[o]});else if(e==="Properties70"&&r.name==="P"){let i=r.propertyList[0],o=r.propertyList[1];const l=r.propertyList[2],c=r.propertyList[3];let u;i.indexOf("Lcl ")===0&&(i=i.replace("Lcl ","Lcl_")),o.indexOf("Lcl ")===0&&(o=o.replace("Lcl ","Lcl_")),o==="Color"||o==="ColorRGB"||o==="Vector"||o==="Vector3D"||o.indexOf("Lcl_")===0?u=[r.propertyList[4],r.propertyList[5],r.propertyList[6]]:u=r.propertyList[4],t[i]={type:o,type2:l,flag:c,value:u}}else t[r.name]===void 0?typeof r.id=="number"?(t[r.name]={},t[r.name][r.id]=r):t[r.name]=r:r.name==="PoseNode"?(Array.isArray(t[r.name])||(t[r.name]=[t[r.name]]),t[r.name].push(r)):t[r.name][r.id]===void 0&&(t[r.name][r.id]=r)}parseProperty(e){const t=e.getString(1);let r;switch(t){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":return r=e.getUint32(),e.getArrayBuffer(r);case"S":return r=e.getUint32(),e.getString(r);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":const i=e.getUint32(),o=e.getUint32(),l=e.getUint32();if(o===0)switch(t){case"b":case"c":return e.getBooleanArray(i);case"d":return e.getFloat64Array(i);case"f":return e.getFloat32Array(i);case"i":return e.getInt32Array(i);case"l":return e.getInt64Array(i)}const c=Id(new Uint8Array(e.getArrayBuffer(l))),u=new El(c.buffer);switch(t){case"b":case"c":return u.getBooleanArray(i);case"d":return u.getFloat64Array(i);case"f":return u.getFloat32Array(i);case"i":return u.getInt32Array(i);case"l":return u.getInt64Array(i)}default:throw new Error("THREE.FBXLoader: Unknown property type "+t)}}}class El{constructor(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=t!==void 0?t:!0}getOffset(){return this.offset}size(){return this.dv.buffer.byteLength}skip(e){this.offset+=e}getBoolean(){return(this.getUint8()&1)===1}getBooleanArray(e){const t=[];for(let r=0;r<e;r++)t.push(this.getBoolean());return t}getUint8(){const e=this.dv.getUint8(this.offset);return this.offset+=1,e}getInt16(){const e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}getInt32(){const e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}getInt32Array(e){const t=[];for(let r=0;r<e;r++)t.push(this.getInt32());return t}getUint32(){const e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}getInt64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),t&2147483648?(t=~t&4294967295,e=~e&4294967295,e===4294967295&&(t=t+1&4294967295),e=e+1&4294967295,-(t*4294967296+e)):t*4294967296+e}getInt64Array(e){const t=[];for(let r=0;r<e;r++)t.push(this.getInt64());return t}getUint64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),t*4294967296+e}getFloat32(){const e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}getFloat32Array(e){const t=[];for(let r=0;r<e;r++)t.push(this.getFloat32());return t}getFloat64(){const e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}getFloat64Array(e){const t=[];for(let r=0;r<e;r++)t.push(this.getFloat64());return t}getArrayBuffer(e){const t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}getString(e){let t=[];for(let i=0;i<e;i++)t[i]=this.getUint8();const r=t.indexOf(0);return r>=0&&(t=t.slice(0,r)),Bi(new Uint8Array(t))}}class Hl{add(e,t){this[e]=t}}function rm(s){const e="Kaydara FBX Binary  \0";return s.byteLength>=e.length&&e===ic(s,0,e.length)}function im(s){const e=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"];let t=0;function r(i){const o=s[i-1];return s=s.slice(t+i),t++,o}for(let i=0;i<e.length;++i)if(r(1)===e[i])return!1;return!0}function ec(s){const e=/FBXVersion: (\d+)/,t=s.match(e);if(t)return parseInt(t[1]);throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function nm(s){return s/46186158e3}const sm=[];function rs(s,e,t,r){let i;switch(r.mappingType){case"ByPolygonVertex":i=s;break;case"ByPolygon":i=e;break;case"ByVertice":i=t;break;case"AllSame":i=r.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+r.mappingType)}r.referenceType==="IndexToDirect"&&(i=r.indices[i]);const o=i*r.dataSize,l=o+r.dataSize;return am(sm,r.buffer,o,l)}const To=new f.Euler,Vi=new f.Vector3;function tc(s){const e=new f.Matrix4,t=new f.Matrix4,r=new f.Matrix4,i=new f.Matrix4,o=new f.Matrix4,l=new f.Matrix4,c=new f.Matrix4,u=new f.Matrix4,d=new f.Matrix4,m=new f.Matrix4,p=new f.Matrix4,_=new f.Matrix4,v=s.inheritType?s.inheritType:0;if(s.translation&&e.setPosition(Vi.fromArray(s.translation)),s.preRotation){const z=s.preRotation.map(f.MathUtils.degToRad);z.push(s.eulerOrder),t.makeRotationFromEuler(To.fromArray(z))}if(s.rotation){const z=s.rotation.map(f.MathUtils.degToRad);z.push(s.eulerOrder),r.makeRotationFromEuler(To.fromArray(z))}if(s.postRotation){const z=s.postRotation.map(f.MathUtils.degToRad);z.push(s.eulerOrder),i.makeRotationFromEuler(To.fromArray(z)),i.invert()}s.scale&&o.scale(Vi.fromArray(s.scale)),s.scalingOffset&&c.setPosition(Vi.fromArray(s.scalingOffset)),s.scalingPivot&&l.setPosition(Vi.fromArray(s.scalingPivot)),s.rotationOffset&&u.setPosition(Vi.fromArray(s.rotationOffset)),s.rotationPivot&&d.setPosition(Vi.fromArray(s.rotationPivot)),s.parentMatrixWorld&&(p.copy(s.parentMatrix),m.copy(s.parentMatrixWorld));const S=t.clone().multiply(r).multiply(i),M=new f.Matrix4;M.extractRotation(m);const x=new f.Matrix4;x.copyPosition(m);const O=x.clone().invert().multiply(m),P=M.clone().invert().multiply(O),C=o,T=new f.Matrix4;if(v===0)T.copy(M).multiply(S).multiply(P).multiply(C);else if(v===1)T.copy(M).multiply(P).multiply(S).multiply(C);else{const V=new f.Matrix4().scale(new f.Vector3().setFromMatrixScale(p)).clone().invert(),Y=P.clone().multiply(V);T.copy(M).multiply(S).multiply(Y).multiply(C)}const N=d.clone().invert(),X=l.clone().invert();let R=e.clone().multiply(u).multiply(d).multiply(t).multiply(r).multiply(i).multiply(N).multiply(c).multiply(l).multiply(o).multiply(X);const U=new f.Matrix4().copyPosition(R),$=m.clone().multiply(U);return _.copyPosition($),R=_.clone().multiply(T),R.premultiply(m.invert()),R}function rc(s){s=s||0;const e=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return s===6?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),e[0]):e[s]}function Bo(s){return s.split(",").map(function(t){return parseFloat(t)})}function ic(s,e,t){return e===void 0&&(e=0),t===void 0&&(t=s.byteLength),Bi(new Uint8Array(s,e,t))}function om(s,e){for(let t=0,r=s.length,i=e.length;t<i;t++,r++)s[r]=e[t]}function am(s,e,t,r){for(let i=t,o=0;i<r;i++,o++)s[o]=e[i];return s}function nc(s,e,t){return s.slice(0,e).concat(t).concat(s.slice(e))}class lm extends f.DataTextureLoader{constructor(e){super(e),this.type=f.HalfFloatType}parse(e){const l=function(U,$){switch(U){case 1:throw new Error("THREE.RGBELoader: Read Error: "+($||""));case 2:throw new Error("THREE.RGBELoader: Write Error: "+($||""));case 3:throw new Error("THREE.RGBELoader: Bad File Format: "+($||""));default:case 4:throw new Error("THREE.RGBELoader: Memory Error: "+($||""))}},p=function(U,$,z){$=$||1024;let Y=U.pos,Q=-1,K=0,te="",H=String.fromCharCode.apply(null,new Uint16Array(U.subarray(Y,Y+128)));for(;0>(Q=H.indexOf(`
`))&&K<$&&Y<U.byteLength;)te+=H,K+=H.length,Y+=128,H+=String.fromCharCode.apply(null,new Uint16Array(U.subarray(Y,Y+128)));return-1<Q?(U.pos+=K+Q+1,te+H.slice(0,Q)):!1},_=function(U){const $=/^#\?(\S+)/,z=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,V=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,Y=/^\s*FORMAT=(\S+)\s*$/,Q=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,K={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let te,H;for((U.pos>=U.byteLength||!(te=p(U)))&&l(1,"no header found"),(H=te.match($))||l(3,"bad initial token"),K.valid|=1,K.programtype=H[1],K.string+=te+`
`;te=p(U),te!==!1;){if(K.string+=te+`
`,te.charAt(0)==="#"){K.comments+=te+`
`;continue}if((H=te.match(z))&&(K.gamma=parseFloat(H[1])),(H=te.match(V))&&(K.exposure=parseFloat(H[1])),(H=te.match(Y))&&(K.valid|=2,K.format=H[1]),(H=te.match(Q))&&(K.valid|=4,K.height=parseInt(H[1],10),K.width=parseInt(H[2],10)),K.valid&2&&K.valid&4)break}return K.valid&2||l(3,"missing format specifier"),K.valid&4||l(3,"missing image size specifier"),K},v=function(U,$,z){const V=$;if(V<8||V>32767||U[0]!==2||U[1]!==2||U[2]&128)return new Uint8Array(U);V!==(U[2]<<8|U[3])&&l(3,"wrong scanline width");const Y=new Uint8Array(4*$*z);Y.length||l(4,"unable to allocate buffer space");let Q=0,K=0;const te=4*V,H=new Uint8Array(4),Pe=new Uint8Array(te);let ve=z;for(;ve>0&&K<U.byteLength;){K+4>U.byteLength&&l(1),H[0]=U[K++],H[1]=U[K++],H[2]=U[K++],H[3]=U[K++],(H[0]!=2||H[1]!=2||(H[2]<<8|H[3])!=V)&&l(3,"bad rgbe scanline format");let we=0,me;for(;we<te&&K<U.byteLength;){me=U[K++];const Le=me>128;if(Le&&(me-=128),(me===0||we+me>te)&&l(3,"bad scanline data"),Le){const Oe=U[K++];for(let lt=0;lt<me;lt++)Pe[we++]=Oe}else Pe.set(U.subarray(K,K+me),we),we+=me,K+=me}const Ce=V;for(let Le=0;Le<Ce;Le++){let Oe=0;Y[Q]=Pe[Le+Oe],Oe+=V,Y[Q+1]=Pe[Le+Oe],Oe+=V,Y[Q+2]=Pe[Le+Oe],Oe+=V,Y[Q+3]=Pe[Le+Oe],Q+=4}ve--}return Y},S=function(U,$,z,V){const Y=U[$+3],Q=Math.pow(2,Y-128)/255;z[V+0]=U[$+0]*Q,z[V+1]=U[$+1]*Q,z[V+2]=U[$+2]*Q,z[V+3]=1},M=function(U,$,z,V){const Y=U[$+3],Q=Math.pow(2,Y-128)/255;z[V+0]=f.DataUtils.toHalfFloat(Math.min(U[$+0]*Q,65504)),z[V+1]=f.DataUtils.toHalfFloat(Math.min(U[$+1]*Q,65504)),z[V+2]=f.DataUtils.toHalfFloat(Math.min(U[$+2]*Q,65504)),z[V+3]=f.DataUtils.toHalfFloat(1)},x=new Uint8Array(e);x.pos=0;const O=_(x),P=O.width,C=O.height,T=v(x.subarray(x.pos),P,C);let N,X,R;switch(this.type){case f.FloatType:R=T.length/4;const U=new Float32Array(R*4);for(let z=0;z<R;z++)S(T,z*4,U,z*4);N=U,X=f.FloatType;break;case f.HalfFloatType:R=T.length/4;const $=new Uint16Array(R*4);for(let z=0;z<R;z++)M(T,z*4,$,z*4);N=$,X=f.HalfFloatType;break;default:throw new Error("THREE.RGBELoader: Unsupported type: "+this.type)}return{width:P,height:C,data:N,header:O.string,gamma:O.gamma,exposure:O.exposure,type:X}}setDataType(e){return this.type=e,this}load(e,t,r,i){function o(l,c){switch(l.type){case f.FloatType:case f.HalfFloatType:"colorSpace"in l?l.colorSpace="srgb-linear":l.encoding=3e3,l.minFilter=f.LinearFilter,l.magFilter=f.LinearFilter,l.generateMipmaps=!1,l.flipY=!0;break}t&&t(l,c)}return super.load(e,o,r,i)}}const Uo=new WeakMap;class cm extends f.Loader{constructor(e){super(e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,t,r,i){const o=new f.FileLoader(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(e,l=>{const c={attributeIDs:this.defaultAttributeIDs,attributeTypes:this.defaultAttributeTypes,useUniqueIDs:!1};this.decodeGeometry(l,c).then(t).catch(i)},r,i)}decodeDracoFile(e,t,r,i){const o={attributeIDs:r||this.defaultAttributeIDs,attributeTypes:i||this.defaultAttributeTypes,useUniqueIDs:!!r};this.decodeGeometry(e,o).then(t)}decodeGeometry(e,t){for(const u in t.attributeTypes){const d=t.attributeTypes[u];d.BYTES_PER_ELEMENT!==void 0&&(t.attributeTypes[u]=d.name)}const r=JSON.stringify(t);if(Uo.has(e)){const u=Uo.get(e);if(u.key===r)return u.promise;if(e.byteLength===0)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let i;const o=this.workerNextTaskID++,l=e.byteLength,c=this._getWorker(o,l).then(u=>(i=u,new Promise((d,m)=>{i._callbacks[o]={resolve:d,reject:m},i.postMessage({type:"decode",id:o,taskConfig:t,buffer:e},[e])}))).then(u=>this._createGeometry(u.geometry));return c.catch(()=>!0).then(()=>{i&&o&&this._releaseTask(i,o)}),Uo.set(e,{key:r,promise:c}),c}_createGeometry(e){const t=new f.BufferGeometry;e.index&&t.setIndex(new f.BufferAttribute(e.index.array,1));for(let r=0;r<e.attributes.length;r++){const i=e.attributes[r],o=i.name,l=i.array,c=i.itemSize;t.setAttribute(o,new f.BufferAttribute(l,c))}return t}_loadLibrary(e,t){const r=new f.FileLoader(this.manager);return r.setPath(this.decoderPath),r.setResponseType(t),r.setWithCredentials(this.withCredentials),new Promise((i,o)=>{r.load(e,i,void 0,o)})}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const e=typeof WebAssembly!="object"||this.decoderConfig.type==="js",t=[];return e?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then(r=>{const i=r[0];e||(this.decoderConfig.wasmBinary=r[1]);const o=um.toString(),l=["/* draco decoder */",i,"","/* worker */",o.substring(o.indexOf("{")+1,o.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([l]))}),this.decoderPending}_getWorker(e,t){return this._initDecoder().then(()=>{if(this.workerPool.length<this.workerLimit){const i=new Worker(this.workerSourceURL);i._callbacks={},i._taskCosts={},i._taskLoad=0,i.postMessage({type:"init",decoderConfig:this.decoderConfig}),i.onmessage=function(o){const l=o.data;switch(l.type){case"decode":i._callbacks[l.id].resolve(l);break;case"error":i._callbacks[l.id].reject(l);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+l.type+'"')}},this.workerPool.push(i)}else this.workerPool.sort(function(i,o){return i._taskLoad>o._taskLoad?-1:1});const r=this.workerPool[this.workerPool.length-1];return r._taskCosts[e]=t,r._taskLoad+=t,r})}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}debug(){console.log("Task load: ",this.workerPool.map(e=>e._taskLoad))}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this}}function um(){let s,e;onmessage=function(l){const c=l.data;switch(c.type){case"init":s=c.decoderConfig,e=new Promise(function(m){s.onModuleLoaded=function(p){m({draco:p})},DracoDecoderModule(s)});break;case"decode":const u=c.buffer,d=c.taskConfig;e.then(m=>{const p=m.draco,_=new p.Decoder,v=new p.DecoderBuffer;v.Init(new Int8Array(u),u.byteLength);try{const S=t(p,_,v,d),M=S.attributes.map(x=>x.array.buffer);S.index&&M.push(S.index.array.buffer),self.postMessage({type:"decode",id:c.id,geometry:S},M)}catch(S){console.error(S),self.postMessage({type:"error",id:c.id,error:S.message})}finally{p.destroy(v),p.destroy(_)}});break}};function t(l,c,u,d){const m=d.attributeIDs,p=d.attributeTypes;let _,v;const S=c.GetEncodedGeometryType(u);if(S===l.TRIANGULAR_MESH)_=new l.Mesh,v=c.DecodeBufferToMesh(u,_);else if(S===l.POINT_CLOUD)_=new l.PointCloud,v=c.DecodeBufferToPointCloud(u,_);else throw new Error("THREE.DRACOLoader: Unexpected geometry type.");if(!v.ok()||_.ptr===0)throw new Error("THREE.DRACOLoader: Decoding failed: "+v.error_msg());const M={index:null,attributes:[]};for(const x in m){const O=self[p[x]];let P,C;if(d.useUniqueIDs)C=m[x],P=c.GetAttributeByUniqueId(_,C);else{if(C=c.GetAttributeId(_,l[m[x]]),C===-1)continue;P=c.GetAttribute(_,C)}M.attributes.push(i(l,c,_,x,O,P))}return S===l.TRIANGULAR_MESH&&(M.index=r(l,c,_)),l.destroy(_),M}function r(l,c,u){const m=u.num_faces()*3,p=m*4,_=l._malloc(p);c.GetTrianglesUInt32Array(u,p,_);const v=new Uint32Array(l.HEAPF32.buffer,_,m).slice();return l._free(_),{array:v,itemSize:1}}function i(l,c,u,d,m,p){const _=p.num_components(),S=u.num_points()*_,M=S*m.BYTES_PER_ELEMENT,x=o(l,m),O=l._malloc(M);c.GetAttributeDataArrayForAllPoints(u,p,x,M,O);const P=new m(l.HEAPF32.buffer,O,S).slice();return l._free(O),{name:d,array:P,itemSize:_}}function o(l,c){switch(c){case Float32Array:return l.DT_FLOAT32;case Int8Array:return l.DT_INT8;case Int16Array:return l.DT_INT16;case Int32Array:return l.DT_INT32;case Uint8Array:return l.DT_UINT8;case Uint16Array:return l.DT_UINT16;case Uint32Array:return l.DT_UINT32}}}const sc=new f.Box3,is=new f.Vector3;class oc extends f.InstancedBufferGeometry{constructor(){super(),this.isLineSegmentsGeometry=!0,this.type="LineSegmentsGeometry";const e=[-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],t=[-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],r=[0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5];this.setIndex(r),this.setAttribute("position",new f.Float32BufferAttribute(e,3)),this.setAttribute("uv",new f.Float32BufferAttribute(t,2))}applyMatrix4(e){const t=this.attributes.instanceStart,r=this.attributes.instanceEnd;return t!==void 0&&(t.applyMatrix4(e),r.applyMatrix4(e),t.needsUpdate=!0),this.boundingBox!==null&&this.computeBoundingBox(),this.boundingSphere!==null&&this.computeBoundingSphere(),this}setPositions(e){let t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));const r=new f.InstancedInterleavedBuffer(t,6,1);return this.setAttribute("instanceStart",new f.InterleavedBufferAttribute(r,3,0)),this.setAttribute("instanceEnd",new f.InterleavedBufferAttribute(r,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this}setColors(e,t=3){let r;e instanceof Float32Array?r=e:Array.isArray(e)&&(r=new Float32Array(e));const i=new f.InstancedInterleavedBuffer(r,t*2,1);return this.setAttribute("instanceColorStart",new f.InterleavedBufferAttribute(i,t,0)),this.setAttribute("instanceColorEnd",new f.InterleavedBufferAttribute(i,t,t)),this}fromWireframeGeometry(e){return this.setPositions(e.attributes.position.array),this}fromEdgesGeometry(e){return this.setPositions(e.attributes.position.array),this}fromMesh(e){return this.fromWireframeGeometry(new f.WireframeGeometry(e.geometry)),this}fromLineSegments(e){const t=e.geometry;return this.setPositions(t.attributes.position.array),this}computeBoundingBox(){this.boundingBox===null&&(this.boundingBox=new f.Box3);const e=this.attributes.instanceStart,t=this.attributes.instanceEnd;e!==void 0&&t!==void 0&&(this.boundingBox.setFromBufferAttribute(e),sc.setFromBufferAttribute(t),this.boundingBox.union(sc))}computeBoundingSphere(){this.boundingSphere===null&&(this.boundingSphere=new f.Sphere),this.boundingBox===null&&this.computeBoundingBox();const e=this.attributes.instanceStart,t=this.attributes.instanceEnd;if(e!==void 0&&t!==void 0){const r=this.boundingSphere.center;this.boundingBox.getCenter(r);let i=0;for(let o=0,l=e.count;o<l;o++)is.fromBufferAttribute(e,o),i=Math.max(i,r.distanceToSquared(is)),is.fromBufferAttribute(t,o),i=Math.max(i,r.distanceToSquared(is));this.boundingSphere.radius=Math.sqrt(i),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}toJSON(){}applyMatrix(e){return console.warn("THREE.LineSegmentsGeometry: applyMatrix() has been renamed to applyMatrix4()."),this.applyMatrix4(e)}}class ns extends oc{constructor(){super(),this.isLineGeometry=!0,this.type="LineGeometry"}setPositions(e){const t=e.length-3,r=new Float32Array(2*t);for(let i=0;i<t;i+=3)r[2*i]=e[i],r[2*i+1]=e[i+1],r[2*i+2]=e[i+2],r[2*i+3]=e[i+3],r[2*i+4]=e[i+4],r[2*i+5]=e[i+5];return super.setPositions(r),this}setColors(e,t=3){const r=e.length-t,i=new Float32Array(2*r);if(t===3)for(let o=0;o<r;o+=t)i[2*o]=e[o],i[2*o+1]=e[o+1],i[2*o+2]=e[o+2],i[2*o+3]=e[o+3],i[2*o+4]=e[o+4],i[2*o+5]=e[o+5];else for(let o=0;o<r;o+=t)i[2*o]=e[o],i[2*o+1]=e[o+1],i[2*o+2]=e[o+2],i[2*o+3]=e[o+3],i[2*o+4]=e[o+4],i[2*o+5]=e[o+5],i[2*o+6]=e[o+6],i[2*o+7]=e[o+7];return super.setColors(i,t),this}fromLine(e){const t=e.geometry;return this.setPositions(t.attributes.position.array),this}}class gn extends f.ShaderMaterial{constructor(e){super({type:"LineMaterial",uniforms:f.UniformsUtils.clone(f.UniformsUtils.merge([f.UniformsLib.common,f.UniformsLib.fog,{worldUnits:{value:1},linewidth:{value:1},resolution:{value:new f.Vector2(1,1)},dashOffset:{value:0},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}}])),vertexShader:`
				#include <common>
				#include <fog_pars_vertex>
				#include <logdepthbuf_pars_vertex>
				#include <clipping_planes_pars_vertex>

				uniform float linewidth;
				uniform vec2 resolution;

				attribute vec3 instanceStart;
				attribute vec3 instanceEnd;

				#ifdef USE_COLOR
					#ifdef USE_LINE_COLOR_ALPHA
						varying vec4 vLineColor;
						attribute vec4 instanceColorStart;
						attribute vec4 instanceColorEnd;
					#else
						varying vec3 vLineColor;
						attribute vec3 instanceColorStart;
						attribute vec3 instanceColorEnd;
					#endif
				#endif

				#ifdef WORLD_UNITS

					varying vec4 worldPos;
					varying vec3 worldStart;
					varying vec3 worldEnd;

					#ifdef USE_DASH

						varying vec2 vUv;

					#endif

				#else

					varying vec2 vUv;

				#endif

				#ifdef USE_DASH

					uniform float dashScale;
					attribute float instanceDistanceStart;
					attribute float instanceDistanceEnd;
					varying float vLineDistance;

				#endif

				void trimSegment( const in vec4 start, inout vec4 end ) {

					// trim end segment so it terminates between the camera plane and the near plane

					// conservative estimate of the near plane
					float a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column
					float b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column
					float nearEstimate = - 0.5 * b / a;

					float alpha = ( nearEstimate - start.z ) / ( end.z - start.z );

					end.xyz = mix( start.xyz, end.xyz, alpha );

				}

				void main() {

					#ifdef USE_COLOR

						vLineColor = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;

					#endif

					#ifdef USE_DASH

						vLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;
						vUv = uv;

					#endif

					float aspect = resolution.x / resolution.y;

					// camera space
					vec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );
					vec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );

					#ifdef WORLD_UNITS

						worldStart = start.xyz;
						worldEnd = end.xyz;

					#else

						vUv = uv;

					#endif

					// special case for perspective projection, and segments that terminate either in, or behind, the camera plane
					// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space
					// but we need to perform ndc-space calculations in the shader, so we must address this issue directly
					// perhaps there is a more elegant solution -- WestLangley

					bool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column

					if ( perspective ) {

						if ( start.z < 0.0 && end.z >= 0.0 ) {

							trimSegment( start, end );

						} else if ( end.z < 0.0 && start.z >= 0.0 ) {

							trimSegment( end, start );

						}

					}

					// clip space
					vec4 clipStart = projectionMatrix * start;
					vec4 clipEnd = projectionMatrix * end;

					// ndc space
					vec3 ndcStart = clipStart.xyz / clipStart.w;
					vec3 ndcEnd = clipEnd.xyz / clipEnd.w;

					// direction
					vec2 dir = ndcEnd.xy - ndcStart.xy;

					// account for clip-space aspect ratio
					dir.x *= aspect;
					dir = normalize( dir );

					#ifdef WORLD_UNITS

						// get the offset direction as perpendicular to the view vector
						vec3 worldDir = normalize( end.xyz - start.xyz );
						vec3 offset;
						if ( position.y < 0.5 ) {

							offset = normalize( cross( start.xyz, worldDir ) );

						} else {

							offset = normalize( cross( end.xyz, worldDir ) );

						}

						// sign flip
						if ( position.x < 0.0 ) offset *= - 1.0;

						float forwardOffset = dot( worldDir, vec3( 0.0, 0.0, 1.0 ) );

						// don't extend the line if we're rendering dashes because we
						// won't be rendering the endcaps
						#ifndef USE_DASH

							// extend the line bounds to encompass  endcaps
							start.xyz += - worldDir * linewidth * 0.5;
							end.xyz += worldDir * linewidth * 0.5;

							// shift the position of the quad so it hugs the forward edge of the line
							offset.xy -= dir * forwardOffset;
							offset.z += 0.5;

						#endif

						// endcaps
						if ( position.y > 1.0 || position.y < 0.0 ) {

							offset.xy += dir * 2.0 * forwardOffset;

						}

						// adjust for linewidth
						offset *= linewidth * 0.5;

						// set the world position
						worldPos = ( position.y < 0.5 ) ? start : end;
						worldPos.xyz += offset;

						// project the worldpos
						vec4 clip = projectionMatrix * worldPos;

						// shift the depth of the projected points so the line
						// segments overlap neatly
						vec3 clipPose = ( position.y < 0.5 ) ? ndcStart : ndcEnd;
						clip.z = clipPose.z * clip.w;

					#else

						vec2 offset = vec2( dir.y, - dir.x );
						// undo aspect ratio adjustment
						dir.x /= aspect;
						offset.x /= aspect;

						// sign flip
						if ( position.x < 0.0 ) offset *= - 1.0;

						// endcaps
						if ( position.y < 0.0 ) {

							offset += - dir;

						} else if ( position.y > 1.0 ) {

							offset += dir;

						}

						// adjust for linewidth
						offset *= linewidth;

						// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...
						offset /= resolution.y;

						// select end
						vec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;

						// back to clip space
						offset *= clip.w;

						clip.xy += offset;

					#endif

					gl_Position = clip;

					vec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation

					#include <logdepthbuf_vertex>
					#include <clipping_planes_vertex>
					#include <fog_vertex>

				}
			`,fragmentShader:`
				uniform vec3 diffuse;
				uniform float opacity;
				uniform float linewidth;

				#ifdef USE_DASH

					uniform float dashOffset;
					uniform float dashSize;
					uniform float gapSize;

				#endif

				varying float vLineDistance;

				#ifdef WORLD_UNITS

					varying vec4 worldPos;
					varying vec3 worldStart;
					varying vec3 worldEnd;

					#ifdef USE_DASH

						varying vec2 vUv;

					#endif

				#else

					varying vec2 vUv;

				#endif

				#include <common>
				#include <fog_pars_fragment>
				#include <logdepthbuf_pars_fragment>
				#include <clipping_planes_pars_fragment>

				#ifdef USE_COLOR
					#ifdef USE_LINE_COLOR_ALPHA
						varying vec4 vLineColor;
					#else
						varying vec3 vLineColor;
					#endif
				#endif

				vec2 closestLineToLine(vec3 p1, vec3 p2, vec3 p3, vec3 p4) {

					float mua;
					float mub;

					vec3 p13 = p1 - p3;
					vec3 p43 = p4 - p3;

					vec3 p21 = p2 - p1;

					float d1343 = dot( p13, p43 );
					float d4321 = dot( p43, p21 );
					float d1321 = dot( p13, p21 );
					float d4343 = dot( p43, p43 );
					float d2121 = dot( p21, p21 );

					float denom = d2121 * d4343 - d4321 * d4321;

					float numer = d1343 * d4321 - d1321 * d4343;

					mua = numer / denom;
					mua = clamp( mua, 0.0, 1.0 );
					mub = ( d1343 + d4321 * ( mua ) ) / d4343;
					mub = clamp( mub, 0.0, 1.0 );

					return vec2( mua, mub );

				}

				void main() {

					#include <clipping_planes_fragment>

					#ifdef USE_DASH

						if ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps

						if ( mod( vLineDistance + dashOffset, dashSize + gapSize ) > dashSize ) discard; // todo - FIX

					#endif

					float alpha = opacity;

					#ifdef WORLD_UNITS

						// Find the closest points on the view ray and the line segment
						vec3 rayEnd = normalize( worldPos.xyz ) * 1e5;
						vec3 lineDir = worldEnd - worldStart;
						vec2 params = closestLineToLine( worldStart, worldEnd, vec3( 0.0, 0.0, 0.0 ), rayEnd );

						vec3 p1 = worldStart + lineDir * params.x;
						vec3 p2 = rayEnd * params.y;
						vec3 delta = p1 - p2;
						float len = length( delta );
						float norm = len / linewidth;

						#ifndef USE_DASH

							#ifdef USE_ALPHA_TO_COVERAGE

								float dnorm = fwidth( norm );
								alpha = 1.0 - smoothstep( 0.5 - dnorm, 0.5 + dnorm, norm );

							#else

								if ( norm > 0.5 ) {

									discard;

								}

							#endif

						#endif

					#else

						#ifdef USE_ALPHA_TO_COVERAGE

							// artifacts appear on some hardware if a derivative is taken within a conditional
							float a = vUv.x;
							float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
							float len2 = a * a + b * b;
							float dlen = fwidth( len2 );

							if ( abs( vUv.y ) > 1.0 ) {

								alpha = 1.0 - smoothstep( 1.0 - dlen, 1.0 + dlen, len2 );

							}

						#else

							if ( abs( vUv.y ) > 1.0 ) {

								float a = vUv.x;
								float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
								float len2 = a * a + b * b;

								if ( len2 > 1.0 ) discard;

							}

						#endif

					#endif

					vec4 diffuseColor = vec4( diffuse, alpha );
					#ifdef USE_COLOR
						#ifdef USE_LINE_COLOR_ALPHA
							diffuseColor *= vLineColor;
						#else
							diffuseColor.rgb *= vLineColor;
						#endif
					#endif

					#include <logdepthbuf_fragment>

					gl_FragColor = diffuseColor;

					#include <tonemapping_fragment>
					#include <${Hn>=154?"colorspace_fragment":"encodings_fragment"}>
					#include <fog_fragment>
					#include <premultiplied_alpha_fragment>

				}
			`,clipping:!0}),this.isLineMaterial=!0,this.onBeforeCompile=function(){this.transparent?this.defines.USE_LINE_COLOR_ALPHA="1":delete this.defines.USE_LINE_COLOR_ALPHA},Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(t){this.uniforms.diffuse.value=t}},worldUnits:{enumerable:!0,get:function(){return"WORLD_UNITS"in this.defines},set:function(t){t===!0?this.defines.WORLD_UNITS="":delete this.defines.WORLD_UNITS}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(t){this.uniforms.linewidth.value=t}},dashed:{enumerable:!0,get:function(){return"USE_DASH"in this.defines},set(t){!!t!="USE_DASH"in this.defines&&(this.needsUpdate=!0),t===!0?this.defines.USE_DASH="":delete this.defines.USE_DASH}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(t){this.uniforms.dashScale.value=t}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(t){this.uniforms.dashSize.value=t}},dashOffset:{enumerable:!0,get:function(){return this.uniforms.dashOffset.value},set:function(t){this.uniforms.dashOffset.value=t}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(t){this.uniforms.gapSize.value=t}},opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(t){this.uniforms.opacity.value=t}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(t){this.uniforms.resolution.value.copy(t)}},alphaToCoverage:{enumerable:!0,get:function(){return"USE_ALPHA_TO_COVERAGE"in this.defines},set:function(t){!!t!="USE_ALPHA_TO_COVERAGE"in this.defines&&(this.needsUpdate=!0),t===!0?(this.defines.USE_ALPHA_TO_COVERAGE="",this.extensions.derivatives=!0):(delete this.defines.USE_ALPHA_TO_COVERAGE,this.extensions.derivatives=!1)}}}),this.setValues(e)}}const Vo=new f.Vector4,ac=new f.Vector3,lc=new f.Vector3,Ke=new f.Vector4,qe=new f.Vector4,ar=new f.Vector4,ko=new f.Vector3,zo=new f.Matrix4,Qe=new f.Line3,cc=new f.Vector3,ss=new f.Box3,os=new f.Sphere,lr=new f.Vector4;let cr,ci;function uc(s,e,t){return lr.set(0,0,-e,1).applyMatrix4(s.projectionMatrix),lr.multiplyScalar(1/lr.w),lr.x=ci/t.width,lr.y=ci/t.height,lr.applyMatrix4(s.projectionMatrixInverse),lr.multiplyScalar(1/lr.w),Math.abs(Math.max(lr.x,lr.y))}function hm(s,e){const t=s.matrixWorld,r=s.geometry,i=r.attributes.instanceStart,o=r.attributes.instanceEnd,l=Math.min(r.instanceCount,i.count);for(let c=0,u=l;c<u;c++){Qe.start.fromBufferAttribute(i,c),Qe.end.fromBufferAttribute(o,c),Qe.applyMatrix4(t);const d=new f.Vector3,m=new f.Vector3;cr.distanceSqToSegment(Qe.start,Qe.end,m,d),m.distanceTo(d)<ci*.5&&e.push({point:m,pointOnLine:d,distance:cr.origin.distanceTo(m),object:s,face:null,faceIndex:c,uv:null,[bo]:null})}}function fm(s,e,t){const r=e.projectionMatrix,o=s.material.resolution,l=s.matrixWorld,c=s.geometry,u=c.attributes.instanceStart,d=c.attributes.instanceEnd,m=Math.min(c.instanceCount,u.count),p=-e.near;cr.at(1,ar),ar.w=1,ar.applyMatrix4(e.matrixWorldInverse),ar.applyMatrix4(r),ar.multiplyScalar(1/ar.w),ar.x*=o.x/2,ar.y*=o.y/2,ar.z=0,ko.copy(ar),zo.multiplyMatrices(e.matrixWorldInverse,l);for(let _=0,v=m;_<v;_++){if(Ke.fromBufferAttribute(u,_),qe.fromBufferAttribute(d,_),Ke.w=1,qe.w=1,Ke.applyMatrix4(zo),qe.applyMatrix4(zo),Ke.z>p&&qe.z>p)continue;if(Ke.z>p){const C=Ke.z-qe.z,T=(Ke.z-p)/C;Ke.lerp(qe,T)}else if(qe.z>p){const C=qe.z-Ke.z,T=(qe.z-p)/C;qe.lerp(Ke,T)}Ke.applyMatrix4(r),qe.applyMatrix4(r),Ke.multiplyScalar(1/Ke.w),qe.multiplyScalar(1/qe.w),Ke.x*=o.x/2,Ke.y*=o.y/2,qe.x*=o.x/2,qe.y*=o.y/2,Qe.start.copy(Ke),Qe.start.z=0,Qe.end.copy(qe),Qe.end.z=0;const M=Qe.closestPointToPointParameter(ko,!0);Qe.at(M,cc);const x=f.MathUtils.lerp(Ke.z,qe.z,M),O=x>=-1&&x<=1,P=ko.distanceTo(cc)<ci*.5;if(O&&P){Qe.start.fromBufferAttribute(u,_),Qe.end.fromBufferAttribute(d,_),Qe.start.applyMatrix4(l),Qe.end.applyMatrix4(l);const C=new f.Vector3,T=new f.Vector3;cr.distanceSqToSegment(Qe.start,Qe.end,T,C),t.push({point:T,pointOnLine:C,distance:cr.origin.distanceTo(T),object:s,face:null,faceIndex:_,uv:null,[bo]:null})}}}class dm extends f.Mesh{constructor(e=new oc,t=new gn({color:Math.random()*16777215})){super(e,t),this.isLineSegments2=!0,this.type="LineSegments2"}computeLineDistances(){const e=this.geometry,t=e.attributes.instanceStart,r=e.attributes.instanceEnd,i=new Float32Array(2*t.count);for(let l=0,c=0,u=t.count;l<u;l++,c+=2)ac.fromBufferAttribute(t,l),lc.fromBufferAttribute(r,l),i[c]=c===0?0:i[c-1],i[c+1]=i[c]+ac.distanceTo(lc);const o=new f.InstancedInterleavedBuffer(i,2,1);return e.setAttribute("instanceDistanceStart",new f.InterleavedBufferAttribute(o,1,0)),e.setAttribute("instanceDistanceEnd",new f.InterleavedBufferAttribute(o,1,1)),this}raycast(e,t){const r=this.material.worldUnits,i=e.camera;i===null&&!r&&console.error('LineSegments2: "Raycaster.camera" needs to be set in order to raycast against LineSegments2 while worldUnits is set to false.');const o=e.params.Line2!==void 0&&e.params.Line2.threshold||0;cr=e.ray;const l=this.matrixWorld,c=this.geometry,u=this.material;ci=u.linewidth+o,c.boundingSphere===null&&c.computeBoundingSphere(),os.copy(c.boundingSphere).applyMatrix4(l);let d;if(r)d=ci*.5;else{const p=Math.max(i.near,os.distanceToPoint(cr.origin));d=uc(i,p,u.resolution)}if(os.radius+=d,cr.intersectsSphere(os)===!1)return;c.boundingBox===null&&c.computeBoundingBox(),ss.copy(c.boundingBox).applyMatrix4(l);let m;if(r)m=ci*.5;else{const p=Math.max(i.near,ss.distanceToPoint(cr.origin));m=uc(i,p,u.resolution)}ss.expandByScalar(m),cr.intersectsBox(ss)!==!1&&(r?hm(this,t):fm(this,i,t))}onBeforeRender(e){const t=this.material.uniforms;t&&t.resolution&&(e.getViewport(Vo),this.material.uniforms.resolution.value.set(Vo.z,Vo.w))}}class as extends dm{constructor(e=new ns,t=new gn({color:Math.random()*16777215})){super(e,t),this.isLine2=!0,this.type="Line2"}}var Vr=Object.freeze({Linear:Object.freeze({None:function(s){return s},In:function(s){return this.None(s)},Out:function(s){return this.None(s)},InOut:function(s){return this.None(s)}}),Quadratic:Object.freeze({In:function(s){return s*s},Out:function(s){return s*(2-s)},InOut:function(s){return(s*=2)<1?.5*s*s:-.5*(--s*(s-2)-1)}}),Cubic:Object.freeze({In:function(s){return s*s*s},Out:function(s){return--s*s*s+1},InOut:function(s){return(s*=2)<1?.5*s*s*s:.5*((s-=2)*s*s+2)}}),Quartic:Object.freeze({In:function(s){return s*s*s*s},Out:function(s){return 1- --s*s*s*s},InOut:function(s){return(s*=2)<1?.5*s*s*s*s:-.5*((s-=2)*s*s*s-2)}}),Quintic:Object.freeze({In:function(s){return s*s*s*s*s},Out:function(s){return--s*s*s*s*s+1},InOut:function(s){return(s*=2)<1?.5*s*s*s*s*s:.5*((s-=2)*s*s*s*s+2)}}),Sinusoidal:Object.freeze({In:function(s){return 1-Math.sin((1-s)*Math.PI/2)},Out:function(s){return Math.sin(s*Math.PI/2)},InOut:function(s){return .5*(1-Math.sin(Math.PI*(.5-s)))}}),Exponential:Object.freeze({In:function(s){return s===0?0:Math.pow(1024,s-1)},Out:function(s){return s===1?1:1-Math.pow(2,-10*s)},InOut:function(s){return s===0?0:s===1?1:(s*=2)<1?.5*Math.pow(1024,s-1):.5*(-Math.pow(2,-10*(s-1))+2)}}),Circular:Object.freeze({In:function(s){return 1-Math.sqrt(1-s*s)},Out:function(s){return Math.sqrt(1- --s*s)},InOut:function(s){return(s*=2)<1?-.5*(Math.sqrt(1-s*s)-1):.5*(Math.sqrt(1-(s-=2)*s)+1)}}),Elastic:Object.freeze({In:function(s){return s===0?0:s===1?1:-Math.pow(2,10*(s-1))*Math.sin((s-1.1)*5*Math.PI)},Out:function(s){return s===0?0:s===1?1:Math.pow(2,-10*s)*Math.sin((s-.1)*5*Math.PI)+1},InOut:function(s){return s===0?0:s===1?1:(s*=2,s<1?-.5*Math.pow(2,10*(s-1))*Math.sin((s-1.1)*5*Math.PI):.5*Math.pow(2,-10*(s-1))*Math.sin((s-1.1)*5*Math.PI)+1)}}),Back:Object.freeze({In:function(s){var e=1.70158;return s===1?1:s*s*((e+1)*s-e)},Out:function(s){var e=1.70158;return s===0?0:--s*s*((e+1)*s+e)+1},InOut:function(s){var e=2.5949095;return(s*=2)<1?.5*(s*s*((e+1)*s-e)):.5*((s-=2)*s*((e+1)*s+e)+2)}}),Bounce:Object.freeze({In:function(s){return 1-Vr.Bounce.Out(1-s)},Out:function(s){return s<1/2.75?7.5625*s*s:s<2/2.75?7.5625*(s-=1.5/2.75)*s+.75:s<2.5/2.75?7.5625*(s-=2.25/2.75)*s+.9375:7.5625*(s-=2.625/2.75)*s+.984375},InOut:function(s){return s<.5?Vr.Bounce.In(s*2)*.5:Vr.Bounce.Out(s*2-1)*.5+.5}}),generatePow:function(s){return s===void 0&&(s=4),s=s<Number.EPSILON?Number.EPSILON:s,s=s>1e4?1e4:s,{In:function(e){return Math.pow(e,s)},Out:function(e){return 1-Math.pow(1-e,s)},InOut:function(e){return e<.5?Math.pow(e*2,s)/2:(1-Math.pow(2-e*2,s))/2+.5}}}}),_n=function(){return performance.now()},pm=(function(){function s(){this._tweens={},this._tweensAddedDuringUpdate={}}return s.prototype.getAll=function(){var e=this;return Object.keys(this._tweens).map(function(t){return e._tweens[t]})},s.prototype.removeAll=function(){this._tweens={}},s.prototype.add=function(e){this._tweens[e.getId()]=e,this._tweensAddedDuringUpdate[e.getId()]=e},s.prototype.remove=function(e){delete this._tweens[e.getId()],delete this._tweensAddedDuringUpdate[e.getId()]},s.prototype.update=function(e,t){e===void 0&&(e=_n()),t===void 0&&(t=!1);var r=Object.keys(this._tweens);if(r.length===0)return!1;for(;r.length>0;){this._tweensAddedDuringUpdate={};for(var i=0;i<r.length;i++){var o=this._tweens[r[i]],l=!t;o&&o.update(e,l)===!1&&!t&&delete this._tweens[r[i]]}r=Object.keys(this._tweensAddedDuringUpdate)}return!0},s})(),No={Linear:function(s,e){var t=s.length-1,r=t*e,i=Math.floor(r),o=No.Utils.Linear;return e<0?o(s[0],s[1],r):e>1?o(s[t],s[t-1],t-r):o(s[i],s[i+1>t?t:i+1],r-i)},Utils:{Linear:function(s,e,t){return(e-s)*t+s}}},hc=(function(){function s(){}return s.nextId=function(){return s._nextId++},s._nextId=0,s})(),Wo=new pm,ls=(function(){function s(e,t){t===void 0&&(t=Wo),this._object=e,this._group=t,this._isPaused=!1,this._pauseStart=0,this._valuesStart={},this._valuesEnd={},this._valuesStartRepeat={},this._duration=1e3,this._isDynamic=!1,this._initialRepeat=0,this._repeat=0,this._yoyo=!1,this._isPlaying=!1,this._reversed=!1,this._delayTime=0,this._startTime=0,this._easingFunction=Vr.Linear.None,this._interpolationFunction=No.Linear,this._chainedTweens=[],this._onStartCallbackFired=!1,this._onEveryStartCallbackFired=!1,this._id=hc.nextId(),this._isChainStopped=!1,this._propertiesAreSetUp=!1,this._goToEnd=!1}return s.prototype.getId=function(){return this._id},s.prototype.isPlaying=function(){return this._isPlaying},s.prototype.isPaused=function(){return this._isPaused},s.prototype.getDuration=function(){return this._duration},s.prototype.to=function(e,t){if(t===void 0&&(t=1e3),this._isPlaying)throw new Error("Can not call Tween.to() while Tween is already started or paused. Stop the Tween first.");return this._valuesEnd=e,this._propertiesAreSetUp=!1,this._duration=t<0?0:t,this},s.prototype.duration=function(e){return e===void 0&&(e=1e3),this._duration=e<0?0:e,this},s.prototype.dynamic=function(e){return e===void 0&&(e=!1),this._isDynamic=e,this},s.prototype.start=function(e,t){if(e===void 0&&(e=_n()),t===void 0&&(t=!1),this._isPlaying)return this;if(this._group&&this._group.add(this),this._repeat=this._initialRepeat,this._reversed){this._reversed=!1;for(var r in this._valuesStartRepeat)this._swapEndStartRepeatValues(r),this._valuesStart[r]=this._valuesStartRepeat[r]}if(this._isPlaying=!0,this._isPaused=!1,this._onStartCallbackFired=!1,this._onEveryStartCallbackFired=!1,this._isChainStopped=!1,this._startTime=e,this._startTime+=this._delayTime,!this._propertiesAreSetUp||t){if(this._propertiesAreSetUp=!0,!this._isDynamic){var i={};for(var o in this._valuesEnd)i[o]=this._valuesEnd[o];this._valuesEnd=i}this._setupProperties(this._object,this._valuesStart,this._valuesEnd,this._valuesStartRepeat,t)}return this},s.prototype.startFromCurrentValues=function(e){return this.start(e,!0)},s.prototype._setupProperties=function(e,t,r,i,o){for(var l in r){var c=e[l],u=Array.isArray(c),d=u?"array":typeof c,m=!u&&Array.isArray(r[l]);if(!(d==="undefined"||d==="function")){if(m){var p=r[l];if(p.length===0)continue;for(var _=[c],v=0,S=p.length;v<S;v+=1){var M=this._handleRelativeValue(c,p[v]);if(isNaN(M)){m=!1,console.warn("Found invalid interpolation list. Skipping.");break}_.push(M)}m&&(r[l]=_)}if((d==="object"||u)&&c&&!m){t[l]=u?[]:{};var x=c;for(var O in x)t[l][O]=x[O];i[l]=u?[]:{};var p=r[l];if(!this._isDynamic){var P={};for(var O in p)P[O]=p[O];r[l]=p=P}this._setupProperties(x,t[l],p,i[l],o)}else(typeof t[l]>"u"||o)&&(t[l]=c),u||(t[l]*=1),m?i[l]=r[l].slice().reverse():i[l]=t[l]||0}}},s.prototype.stop=function(){return this._isChainStopped||(this._isChainStopped=!0,this.stopChainedTweens()),this._isPlaying?(this._group&&this._group.remove(this),this._isPlaying=!1,this._isPaused=!1,this._onStopCallback&&this._onStopCallback(this._object),this):this},s.prototype.end=function(){return this._goToEnd=!0,this.update(1/0),this},s.prototype.pause=function(e){return e===void 0&&(e=_n()),this._isPaused||!this._isPlaying?this:(this._isPaused=!0,this._pauseStart=e,this._group&&this._group.remove(this),this)},s.prototype.resume=function(e){return e===void 0&&(e=_n()),!this._isPaused||!this._isPlaying?this:(this._isPaused=!1,this._startTime+=e-this._pauseStart,this._pauseStart=0,this._group&&this._group.add(this),this)},s.prototype.stopChainedTweens=function(){for(var e=0,t=this._chainedTweens.length;e<t;e++)this._chainedTweens[e].stop();return this},s.prototype.group=function(e){return e===void 0&&(e=Wo),this._group=e,this},s.prototype.delay=function(e){return e===void 0&&(e=0),this._delayTime=e,this},s.prototype.repeat=function(e){return e===void 0&&(e=0),this._initialRepeat=e,this._repeat=e,this},s.prototype.repeatDelay=function(e){return this._repeatDelayTime=e,this},s.prototype.yoyo=function(e){return e===void 0&&(e=!1),this._yoyo=e,this},s.prototype.easing=function(e){return e===void 0&&(e=Vr.Linear.None),this._easingFunction=e,this},s.prototype.interpolation=function(e){return e===void 0&&(e=No.Linear),this._interpolationFunction=e,this},s.prototype.chain=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this._chainedTweens=e,this},s.prototype.onStart=function(e){return this._onStartCallback=e,this},s.prototype.onEveryStart=function(e){return this._onEveryStartCallback=e,this},s.prototype.onUpdate=function(e){return this._onUpdateCallback=e,this},s.prototype.onRepeat=function(e){return this._onRepeatCallback=e,this},s.prototype.onComplete=function(e){return this._onCompleteCallback=e,this},s.prototype.onStop=function(e){return this._onStopCallback=e,this},s.prototype.update=function(e,t){var r=this,i;if(e===void 0&&(e=_n()),t===void 0&&(t=!0),this._isPaused)return!0;var o,l=this._startTime+this._duration;if(!this._goToEnd&&!this._isPlaying){if(e>l)return!1;t&&this.start(e,!0)}if(this._goToEnd=!1,e<this._startTime)return!0;this._onStartCallbackFired===!1&&(this._onStartCallback&&this._onStartCallback(this._object),this._onStartCallbackFired=!0),this._onEveryStartCallbackFired===!1&&(this._onEveryStartCallback&&this._onEveryStartCallback(this._object),this._onEveryStartCallbackFired=!0);var c=e-this._startTime,u=this._duration+((i=this._repeatDelayTime)!==null&&i!==void 0?i:this._delayTime),d=this._duration+this._repeat*u,m=function(){if(r._duration===0||c>d)return 1;var x=Math.trunc(c/u),O=c-x*u,P=Math.min(O/r._duration,1);return P===0&&c===r._duration?1:P},p=m(),_=this._easingFunction(p);if(this._updateProperties(this._object,this._valuesStart,this._valuesEnd,_),this._onUpdateCallback&&this._onUpdateCallback(this._object,p),this._duration===0||c>=this._duration)if(this._repeat>0){var v=Math.min(Math.trunc((c-this._duration)/u)+1,this._repeat);isFinite(this._repeat)&&(this._repeat-=v);for(o in this._valuesStartRepeat)!this._yoyo&&typeof this._valuesEnd[o]=="string"&&(this._valuesStartRepeat[o]=this._valuesStartRepeat[o]+parseFloat(this._valuesEnd[o])),this._yoyo&&this._swapEndStartRepeatValues(o),this._valuesStart[o]=this._valuesStartRepeat[o];return this._yoyo&&(this._reversed=!this._reversed),this._startTime+=u*v,this._onRepeatCallback&&this._onRepeatCallback(this._object),this._onEveryStartCallbackFired=!1,!0}else{this._onCompleteCallback&&this._onCompleteCallback(this._object);for(var S=0,M=this._chainedTweens.length;S<M;S++)this._chainedTweens[S].start(this._startTime+this._duration,!1);return this._isPlaying=!1,!1}return!0},s.prototype._updateProperties=function(e,t,r,i){for(var o in r)if(t[o]!==void 0){var l=t[o]||0,c=r[o],u=Array.isArray(e[o]),d=Array.isArray(c),m=!u&&d;m?e[o]=this._interpolationFunction(c,i):typeof c=="object"&&c?this._updateProperties(e[o],l,c,i):(c=this._handleRelativeValue(l,c),typeof c=="number"&&(e[o]=l+(c-l)*i))}},s.prototype._handleRelativeValue=function(e,t){return typeof t!="string"?t:t.charAt(0)==="+"||t.charAt(0)==="-"?e+parseFloat(t):parseFloat(t)},s.prototype._swapEndStartRepeatValues=function(e){var t=this._valuesStartRepeat[e],r=this._valuesEnd[e];typeof r=="string"?this._valuesStartRepeat[e]=this._valuesStartRepeat[e]+parseFloat(r):this._valuesStartRepeat[e]=this._valuesEnd[e],this._valuesEnd[e]=t},s})();hc.nextId;var ur=Wo;ur.getAll.bind(ur),ur.removeAll.bind(ur),ur.add.bind(ur),ur.remove.bind(ur);var mm=ur.update.bind(ur);function Go(s,e,t){if(s==null||s==="")throw new Error(t||`Parameter "${e}" is required but received: ${s}`);return s}function fc(s,e,t){const r=e.split(".");let i=s;for(const o of r){if(i[o]===void 0||i[o]===null)throw new Error(`Property "${e}" is required but missing at path: "${o}"`);i=i[o]}return i}function gm(s,e,t,r=0,i=1){const o=(s-e)*(i-r)/(t-e)+r,l=Math.min(r,i),c=Math.max(r,i);return o<l?l:o>c?c:o||0}var _m=Object.defineProperty,ym=(s,e,t)=>e in s?_m(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,dc=(s,e,t)=>ym(s,typeof e!="symbol"?e+"":e,t);class Ro{constructor(){dc(this,"_dispatcher",new f.EventDispatcher),dc(this,"_listenerMap",new Map)}on(e,t){const r=i=>t(i.data||i);return this._listenerMap.has(e)||this._listenerMap.set(e,new Map),this._listenerMap.get(e).set(t,r),this._dispatcher.addEventListener(e,r),this}once(e,t){const r=i=>{this.off(e,r),t(i.data||i)};return this.on(e,r)}off(e,t){const r=this._listenerMap.get(e);if(!r)return this;const i=r.get(t);return i&&(this._dispatcher.removeEventListener(e,i),r.delete(t),r.size===0&&this._listenerMap.delete(e)),this}trigger(e,t){const r={type:e,data:t};return this._dispatcher.dispatchEvent(r),this}get threeEventDispatcher(){return this._dispatcher}}function pc(s,e){return s.replace(/\{(\w+)\}/g,(t,r)=>{if(Object.prototype.hasOwnProperty.call(e,r)){const i=e[r];return i!==void 0?String(i):t}throw new Error(`Missing required parameter for template interpolation: "${r}"`)})}function jo(s,...e){return Object.assign(s,...e)}function $o(s){return s==null}function yn(s){return typeof s=="function"}function vm(s=new Date){const e=u=>u.toString().padStart(2,"0"),t=s.getFullYear(),r=e(s.getMonth()+1),i=e(s.getDate()),o=e(s.getHours()),l=e(s.getMinutes()),c=e(s.getSeconds());return`${t}-${r}-${i} ${o}:${l}:${c}`}var wm=Object.defineProperty,bm=(s,e,t)=>e in s?wm(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Xo=(s,e,t)=>bm(s,typeof e!="symbol"?e+"":e,t);class xm{}class cs extends zr(ui(xm)){constructor(e){super(),Xo(this,"target"),Xo(this,"dom"),Xo(this,"_enabled",!1),this.target=e}enable(){return this._enabled?this:(this._enabled=!0,this.addHooks(),this)}disable(){return this._enabled?(this._enabled=!1,this.removeHooks(),this):this}enabled(){return!!this._enabled}remove(){this.disable(),delete this.target,delete this.dom}}const Yo=Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]"&&!process.versions.electron&&!process.versions.nw&&!process.versions["node-webkit"],mc=()=>typeof window>"u"?1:window.devicePixelRatio||window.screen.deviceXDPI/window.screen.logicalXDPI||1,Sm=(()=>{if(Yo)return{IS_NODE:Yo,isTest:!1,ie:!1,ielt9:!1,edge:!1,webkit:!1,gecko:!1,android:!1,android23:!1,chrome:!1,chromeVersion:"0",safari:!1,phantomjs:!1,ie3d:!1,webkit3d:!1,opera12:!1,gecko3d:!1,any3d:!1,iosWeixin:!1,mobile:!1,mobileWebkit:!1,mobileWebkit3d:!1,mobileOpera:!1,mobileGecko:!1,touch:!1,msPointer:!1,pointer:!1,retina:!1,devicePixelRatio:1,language:"en",ie9:!1,ie10:!1,webgl:!1,imageBitMap:!1,resizeObserver:!1,btoa:!1,decodeImageInWorker:!1,monitorDPRChange:!1,supportsPassive:!1,proxy:!1,requestIdleCallback:!1,checkDevicePixelRatio:()=>!1};const s=navigator.userAgent.toLowerCase(),e=document.documentElement||{style:{}},t="ActiveXObject"in window,r=s.includes("webkit"),i=s.includes("phantom"),o=s.search("android [23]")!==-1,l=s.includes("chrome"),c=s.includes("gecko")&&!r&&!("opera"in window)&&!t,u=/iphone/i.test(s)&&/micromessenger/i.test(s),d=typeof orientation<"u"||s.includes("mobile"),m=!window.PointerEvent&&"MSPointerEvent"in window,p=window.PointerEvent&&navigator.pointerEnabled||m,_=t&&"transition"in e.style,v="WebKitCSSMatrix"in window&&"m11"in new window.WebKitCSSMatrix&&!o,S="MozPerspective"in e.style,M="OTransition"in e.style,x=(_||v||S)&&!M&&!i,O=typeof window<"u"&&yn(window.createImageBitmap),P=typeof window<"u"&&yn(window.ResizeObserver),C=typeof window<"u"&&yn(window.btoa),T=typeof window<"u"&&yn(window.Proxy),N=typeof window<"u"&&yn(window.requestIdleCallback);let X="0";if(l){const Q=s.match(/chrome\/([\d.]+)/);X=Q?Q[1]:"0"}const R=!i&&(p||"ontouchstart"in window||"DocumentTouch"in window&&document instanceof window.DocumentTouch),U=typeof window<"u"&&"WebGLRenderingContext"in window,$=mc();let z=!1;try{new OffscreenCanvas(2,2).getContext("2d"),z=!0}catch{z=!1}let V=!1;try{const Q=Object.defineProperty({},"passive",{get:()=>(V=!0,!0)});window.addEventListener("testPassive",()=>{},Q)}catch{}const Y={IS_NODE:Yo,isTest:!1,ie:t,ielt9:t&&!document.addEventListener,edge:"msLaunchUri"in navigator&&!("documentMode"in document),webkit:r,gecko:c,android:s.includes("android"),android23:o,chrome:l,chromeVersion:X,safari:!l&&s.includes("safari"),phantomjs:i,ie3d:_,webkit3d:v,gecko3d:S,opera12:M,any3d:x,iosWeixin:u,mobile:d,mobileWebkit:d&&r,mobileWebkit3d:d&&v,mobileOpera:d&&"opera"in window,mobileGecko:d&&c,touch:!!R,msPointer:!!m,pointer:!!p,retina:$>1,devicePixelRatio:$,language:navigator.browserLanguage||navigator.language,ie9:t&&document.documentMode===9,ie10:t&&document.documentMode===10,webgl:U,imageBitMap:O,resizeObserver:P,btoa:C,decodeImageInWorker:z,monitorDPRChange:!0,supportsPassive:V,proxy:T,requestIdleCallback:N,checkDevicePixelRatio:()=>{if(typeof window<"u"&&Y.monitorDPRChange){const Q=mc(),K=Q!==Y.devicePixelRatio;return K&&(Y.devicePixelRatio=Q),K}return!1}};return Y})();var Mm=Object.defineProperty,Am=(s,e,t)=>e in s?Mm(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,kr=(s,e,t)=>Am(s,typeof e!="symbol"?e+"":e,t);function zr(s){return class extends s{constructor(...e){super(...e),kr(this,"eventClass",new Ro),kr(this,"on",this.eventClass.on.bind(this.eventClass)),kr(this,"trigger",this.eventClass.trigger.bind(this.eventClass)),kr(this,"off",this.eventClass.off.bind(this.eventClass)),this.eventClass=new Ro}}}function ui(s){return class extends s{constructor(...e){super(...e),kr(this,"options"),kr(this,"_isUpdatingOptions"),kr(this,"_initHooksCalled"),kr(this,"_initHooks");const t=Object.getPrototypeOf(this).options||{},r=jo({},t,e[0]||{});this.setOptions(r),this.callInitHooks(),this._isUpdatingOptions=!1}proxyOptions(){return Sm.proxy?(this.options=new Proxy(this.options,{set:(e,t,r)=>{if(t=t,e[t]===r||(e[t]=r,this._isUpdatingOptions))return!0;const i={};return i[t]=r,this.config(i),!0}}),this):this}callInitHooks(){const e=Object.getPrototypeOf(this);return this._visitInitHooks(e),this}setOptions(e){if((!this.hasOwnProperty("options")||$o(this.options))&&(this.options=this.options?Object.create(this.options):{}),!e)return this;for(const t in e)this.options[t]=e[t];return this}config(e,t){if(this._isUpdatingOptions=!0,e){if(arguments.length===2&&typeof e=="string"){const r={};r[e]=t,e=r}e=e;for(const r in e)this.options[r]=e[r],this[r]&&this[r]instanceof cs&&(e[r]?this[r].enable():this[r].disable());this.onConfig(e),this._isUpdatingOptions=!1}else{const r={};for(const i in this.options)this.options.hasOwnProperty(i)&&(r[i]=this.options[i]);return this._isUpdatingOptions=!1,r}return this}onConfig(e){}_visitInitHooks(e){if(this._initHooksCalled)return;const t=Object.getPrototypeOf(e);t._visitInitHooks&&t._visitInitHooks.call(this,t),this._initHooksCalled=!0;const r=e._initHooks;if(r&&r!==t._initHooks)for(let i=0;i<r.length;i++)r[i].call(this)}static mergeOptions(e){const t=this.prototype,r=Object.getPrototypeOf(t);return t.hasOwnProperty("options")?t.options===r.options&&(t.options=Object.create(t.options)):t.options={},jo(t.options,e),this}static addInitHook(e,...t){const r=typeof e=="function"?e:function(){this[e].apply(this,t)},i=this.prototype,o=Object.getPrototypeOf(i);return(!i._initHooks||i._initHooks===o._initHooks)&&(i._initHooks=[]),i._initHooks.push(r),this}static include(...e){for(let t=0;t<e.length;t++)jo(this.prototype,e[t]);return this}}}var Pm=Object.defineProperty,Cm=(s,e,t)=>e in s?Pm(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Te=(s,e,t)=>Cm(s,typeof e!="symbol"?e+"":e,t);const Lm=zr(ui(f.EventDispatcher));class gc extends Lm{constructor(e,t={}){super(),Te(this,"scene"),Te(this,"renderer"),Te(this,"camera"),Te(this,"controls"),Te(this,"ambLight"),Te(this,"dirLight"),Te(this,"auxDirLight"),Te(this,"clouds",null),Te(this,"container"),Te(this,"_clock",new f.Clock),Te(this,"stats"),Te(this,"_animationCallbacks",new Set),Te(this,"_fogFactor",1),Te(this,"_sceneSize",5e4*2),Te(this,"gorund"),Te(this,"map"),Te(this,"centerWorldPos"),Te(this,"_isInteracting",!1),Te(this,"debug",!1),Te(this,"flyTween",null),Te(this,"composer"),Te(this,"renderPass"),Te(this,"bloomPass"),Te(this,"calculateCameraPosition",(_,v,S,M)=>{const x=new f.Vector3(0,v*Math.cos(S),v*Math.sin(S));return x.applyAxisAngle(new f.Vector3(0,1,0),M),new f.Vector3(_.x+x.x,_.y+x.y,_.z+x.z)}),this.setOptions(t);const{antialias:r=!1,stencil:i=!0,logarithmicDepthBuffer:o=!0,skybox:l,map:c,bloom:u,minDistance:d,maxDistance:m,draggable:p=!0}=t;if(this.map=c,this.centerWorldPos=this.map.projectToWorld(new f.Vector3(this.map.center[0],this.map.center[1],0)),this.renderer=this._createRenderer(r,i,o),this.scene=this._createScene(l),this.camera=this._createCamera(),e&&this.addTo(e),this.controls=this._createControls(d,m),this.controls.enabled=p!==!1,this.ambLight=this._createAmbLight(),this.scene.add(this.ambLight),this.dirLight=this._createDirLight(),this.scene.add(this.dirLight),this.scene.add(this.dirLight.target),this.auxDirLight=this._createAuxDirLight(),this.gorund=this._createGorund(),this.scene.add(this.gorund),u&&u.enabled){const _=this.renderer.getPixelRatio(),v=this.container?this.width:window.innerWidth,S=this.container?this.height:window.innerHeight,M=v*_,x=S*_,O=new f.WebGLRenderTarget(M,x,{format:f.RGBAFormat});O.samples=4,this.composer=new ip(this.renderer,O),this.renderPass=new op(this.scene,this.camera),this.composer.addPass(this.renderPass);const P=u?.strength??1.5,C=u?.radius??1,T=u?.threshold??.7;this.bloomPass=new Jd(new f.Vector2(M,x),P,C,T),this.composer.addPass(this.bloomPass)}this.renderer.setAnimationLoop(this.animate.bind(this)),this.debug=t.debug||!1,this.flyTween=null,this.debug&&(this.stats=new hn,document.body.appendChild(this.stats.dom))}get fogFactor(){return this._fogFactor}get isInteracting(){return this._isInteracting}set fogFactor(e){this._fogFactor=e,this.controls.dispatchEvent({type:"change",target:this.controls})}get width(){return this.container?.clientWidth||0}get height(){return this.container?.clientHeight||0}addTo(e){let t=null;if(typeof e=="string"?t=document.getElementById(e)||document.querySelector(e):t=e,t instanceof HTMLElement)this.container=t,t.appendChild(this.renderer.domElement),new ResizeObserver(this.resize.bind(this)).observe(t);else throw`${e} not found!`;return this}_createScene(e){const t=new f.Scene,r=e?.defaultColor||"rgb(21,48,94)";if(t.background=new f.Color(r),t.fog=new f.FogExp2(r,2e-4),e?.files){const i=new f.CubeTextureLoader;e.path&&i.setPath(e.path),i.load(e.files,o=>{t.background=o},void 0,o=>{console.error("Error loading skybox:",o),t.background=new f.Color(r)})}else e?.hdr&&this._loadHDRWithPMREM(t,e);return t}async _loadHDRWithPMREM(e,t){try{if(t){const i=await new lm().setPath(t.path||"").setDataType(f.FloatType).loadAsync(t.hdr);i.colorSpace=this.renderer.outputColorSpace,i.mapping=303,i.needsUpdate=!0,e.background=i,e.environment=i}}catch(r){console.error("加载HDR失败:",r),e.background=new f.Color(t?.defaultColor||14414079)}}_createRenderer(e,t,r){const i=new f.WebGLRenderer({antialias:e,logarithmicDepthBuffer:r,stencil:t,alpha:!0,precision:"highp",powerPreference:"high-performance",failIfMajorPerformanceCaveat:!0});return i.debug.checkShaderErrors=!0,i.sortObjects=!0,i.setPixelRatio(window.devicePixelRatio),i.domElement.tabIndex=0,i.shadowMap.enabled=!0,i.shadowMap.needsUpdate=!0,i.shadowMap.type=f.PCFSoftShadowMap,i.toneMapping=f.ACESFilmicToneMapping,i.toneMappingExposure=1,i.outputColorSpace=f.SRGBColorSpace,i}_createCamera(){return new f.PerspectiveCamera(45,this.getAspect(),.1,this._sceneSize*2)}_createControls(e,t){const r=new jd(this.camera,this.renderer.domElement),i=Math.PI/2.1;return r.screenSpacePanning=!1,r.minDistance=e??.1,r.maxDistance=t??6e4,r.maxPolarAngle=i,r.enableDamping=!0,r.dampingFactor=.08,r.keyPanSpeed=1,r.listenToKeyEvents(this.renderer.domElement),r.addEventListener("change",()=>{const o=Math.max(r.getPolarAngle(),.1),l=Math.max(r.getDistance(),100);r.zoomSpeed=Math.max(Math.log(l/1e3),1)+3;const c=3e5*2;r.maxDistance>c*.95&&(r.maxDistance=c*.95),this.camera.far=f.MathUtils.clamp(l/o*8,100,c),this.camera.near=f.MathUtils.clamp(this.camera.far/1e3,.001,1),this.camera.updateProjectionMatrix(),this.scene.fog instanceof f.FogExp2&&(this.scene.fog.density=o/(l+5)*this.fogFactor*.1);const d=l>6e4;r.minAzimuthAngle=d?0:-1/0,r.maxAzimuthAngle=d?0:1/0,r.maxPolarAngle=gm(r.getDistance(),0,7e4,i,0),this.map?.trigger("control-change",{type:"control-change",control:r,camera:this.camera,target:this.map})}),r.addEventListener("start",()=>{this._isInteracting=!0,this.map?.trigger("control-start",{type:"control-start",control:r,camera:this.camera,target:this.map})}),r.addEventListener("end",()=>{this._isInteracting=!1,this.map?.trigger("control-end",{type:"control-end",control:r,camera:this.camera,target:this.map})}),r}_createAmbLight(){return new f.AmbientLight(16777215,2)}_createDirLight(){const p=new f.DirectionalLight("rgb(255, 255, 255)",10);p.position.set(this.centerWorldPos.x+55e3*1.2,55e3*2,this.centerWorldPos.z+55e3*1);const _=new f.Object3D;if(_.position.copy(this.centerWorldPos),this.scene.add(_),p.target=_,p.castShadow=!0,p.shadow.mapSize.width=1024*10,p.shadow.mapSize.height=1024*10,p.shadow.camera.near=1,p.shadow.camera.far=192500,p.shadow.camera.left=-55e3,p.shadow.camera.bottom=-55e3,p.shadow.camera.top=55e3,p.shadow.camera.right=55e3,p.shadow.radius=1,p.shadow.bias=-0,this.debug){const v=new f.CameraHelper(p.shadow.camera);v.name="dirLightCameraHelper",this.scene.add(v)}return p}_createAuxDirLight(){const l=this._createAuxLightInstance(this.centerWorldPos.x+-66e3,82500,this.centerWorldPos.z+-55e3,.5);l.name="AuxDirLight_BackFill",this.scene.add(l),this.scene.add(l.target);const m=this._createAuxLightInstance(this.centerWorldPos.x+55e3*-1,55e3*1.5,this.centerWorldPos.z+55e3*1.2,.5);m.name="AuxDirLight_LeftRim",this.scene.add(m),this.scene.add(m.target);const v=this._createAuxLightInstance(this.centerWorldPos.x+55e3*1,55e3*1.5,this.centerWorldPos.z+55e3*-1.2,.5);return v.name="AuxDirLight_RightRim",this.scene.add(v),this.scene.add(v.target),l}_createAuxLightInstance(e,t,r,i){const o=new f.DirectionalLight(16777215,i);o.position.set(e,t,r);const l=new f.Object3D;return l.position.copy(this.centerWorldPos),this.scene.add(l),o.target=l,o.castShadow=!1,o}resize(){const e=this.width,t=this.height;if(this.renderer.setSize(e,t),this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.composer){const r=this.renderer.getPixelRatio();this.composer.setSize(e*r,t*r),this.composer.render()}else this.renderer.render(this.scene,this.camera);return this}addAnimationCallback(e){return this._animationCallbacks.add(e),()=>this._animationCallbacks.delete(e)}animate(){const e=this._clock.getDelta(),t=this._clock.getElapsedTime();this._animationCallbacks.forEach(r=>r(e,t,this)),this.controls.update(),this.composer?this.composer.render():this.renderer.render(this.scene,this.camera),mm(),this.stats&&this.stats.update(),this.trigger("update",{delta:e})}flyTo(e,t,r=!0,i){if(this.controls.target.copy(e),r){const o=this.camera.position;new ls(o).to({y:2e7,z:0},500).chain(new ls(o).to(t,2e3).easing(Vr.Quintic.Out).onComplete(l=>i&&i(l))).start()}else this.camera.position.copy(t)}flyToAdvanced(e){const t=this.camera,r=this.controls,i=e.center,o=e.cameraCoord,l=e.duration??2e3,c=e.delay??0,u=e.complete,d=!!e.curvePath;if(!i||!o)return;const m=this.map.projectToWorld(new f.Vector3(i[0],i[1],0)),p=this.map.projectToWorld(new f.Vector3(o[0],o[1],o[2]));if(!t||!r||!m||!p)return;const _=r.target.clone(),v=t.position.clone(),S=new f.Vector3(m.x,m.y,m.z),M=new f.Vector3(p.x,p.y,p.z);if(this.flyTween&&(this.flyTween.stop(),this.flyTween=null),d){const x=[v,v.clone().lerp(M,.33),v.clone().lerp(M,.67),M],O=new f.CubicBezierCurve3(...x),P={t:0,x:_.x,y:_.y,z:_.z};this.flyTween=new ls(P).to({t:1,x:S.x,y:S.y,z:S.z},l).easing(Vr.Quadratic.InOut).onUpdate(()=>{const C=O.getPoint(P.t),T=new f.Vector3(P.x,P.y,P.z);t.position.copy(C),t.lookAt(T),t.updateProjectionMatrix(),r.target.copy(T),r.update()})}else{const x={tx:_.x,ty:_.y,tz:_.z,px:v.x,py:v.y,pz:v.z};this.flyTween=new ls(x).to({tx:S.x,ty:S.y,tz:S.z,px:M.x,py:M.y,pz:M.z},l).easing(Vr.Quadratic.InOut).onUpdate(()=>{const O=new f.Vector3(x.tx,x.ty,x.tz),P=new f.Vector3(x.px,x.py,x.pz);t.position.copy(P),t.lookAt(O),r.target.copy(O),r.update()})}this.flyTween&&(this.flyTween.onComplete(()=>{this.flyTween&&(this.flyTween.stop(),this.flyTween=null),u&&u()}),c>0?setTimeout(()=>{this.flyTween&&this.flyTween.start()},c):this.flyTween.start())}onConfig(e){if("draggable"in e){const t=e.draggable;this.controls&&(this.controls.enabled=t!==!1)}}flyToPoint(e){const{controls:t}=this,r=e.center,i=e.duration??2e3,o=typeof e.distance=="number"?e.distance:typeof e.altitude=="number"?e.altitude:t.getDistance(),l=S=>S*Math.PI/180;let c;if(typeof e.polarDeg=="number"){const S=e.polarDeg<=0?.1:e.polarDeg;c=l(S)}else typeof e.polarAngle=="number"?c=e.polarAngle<=0?l(.1):e.polarAngle:c=t.getPolarAngle();const u=typeof e.azimuthDeg=="number"?l(e.azimuthDeg):e.azimuthAngle||t.getAzimuthalAngle(),d=e.complete,m=!!e.curvePath,p=this.map.projectToWorld(new f.Vector3(r[0],r[1],0)),_=this.calculateCameraPosition(p,o,c,u),v=this.map.unprojectFromWorld(_);this.flyToAdvanced({center:[r[0],r[1],0],cameraCoord:[v.x,v.y,v.z||0],duration:i,complete:d,curvePath:m})}getState(){return{centerPosition:this.controls.target,cameraPosition:this.camera.position}}_bindMap(e){e&&(this.map=e)}getMap(){return this.map?this.map:null}getAspect(){const[e,t]=this.getWidthHeight();return e/t}getWidthHeight(){let e=window.innerWidth,t=window.innerHeight;return[e,t]}_createGorund(){const e=this.centerWorldPos,t=new f.MeshStandardMaterial({transparent:!1,color:new f.Color("rgb(45,52,60)").multiplyScalar(.7),metalness:.2,roughness:1}),r=new f.PlaneGeometry(this._sceneSize*2,this._sceneSize*2),i=new f.Mesh(r,t);return i.name="地面",i.castShadow=!1,i.receiveShadow=!1,i.position.y=0,i.position.add(e),i.rotateX(-Math.PI/2),i.visible=!1,i}destroy(){try{this.renderer.setAnimationLoop(null),this._animationCallbacks.clear(),this.map=null,this.controls&&this.controls.dispose(),this.scene&&(this.scene.traverse(e=>{e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(t=>{this._disposeMaterial(t)}):this._disposeMaterial(e.material))}),this.scene.clear()),this.composer&&(this.bloomPass&&this.bloomPass.dispose?.(),this.renderPass&&this.renderPass.dispose?.(),this.composer=null,this.renderPass=null,this.bloomPass=null),this.renderer&&(this.renderer.dispose(),this.container&&this.renderer.domElement.parentNode===this.container&&this.container.removeChild(this.renderer.domElement)),this.stats&&this.stats.dom.parentNode&&this.stats.dom.parentNode.removeChild(this.stats.dom)}catch(e){console.error("❌ 销毁Viewer时出错:",e)}}_disposeMaterial(e){if(!e)return;["map","lightMap","bumpMap","normalMap","specularMap","envMap","alphaMap","aoMap","displacementMap","emissiveMap","gradientMap","metalnessMap","roughnessMap"].forEach(r=>{e[r]&&e[r].dispose()}),e.dispose()}}var Om=Object.defineProperty,Dm=(s,e,t)=>e in s?Om(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Im=(s,e,t)=>Dm(s,e+"",t);function Zo(s){return class extends s{constructor(...t){super(...t),Im(this,"_handlers"),this._handlers=[]}addHandler(t,r){if(!r)return this;if(this._handlers||(this._handlers=[]),this[t])return this[t].enable(),this;const i=this[t]=new r(this);return this._handlers.push(i),this.options[t]&&i.enable(),this}removeHandler(t){if(!t)return this;const r=this[t];if(r&&this._handlers){const i=this._handlers.indexOf(r);i>=0&&this._handlers.splice(i,1),this[t].remove(),delete this[t]}return this}_clearHandlers(){if(this._handlers){for(let t=0,r=this._handlers.length;t<r;t++)this._handlers[t].remove();this._handlers=[]}}}}var Fm=Object.defineProperty,Tm=(s,e,t)=>e in s?Fm(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,hi=(s,e,t)=>Tm(s,typeof e!="symbol"?e+"":e,t);const Bm={attribution:"",visible:!0,opacity:1,zIndex:0,isSceneLayer:!1,altitude:0};class us extends Zo(zr(ui(f.Group))){constructor(e,t){super(),hi(this,"_layerId"),hi(this,"opacity",1),hi(this,"_animCallbacks",new Set),hi(this,"isSceneLayer",!1),hi(this,"_baseAltitude",0),hi(this,"depthOffset"),hi(this,"_regionConfigs",[]),Go(e,"id","Layer ID must be specified 图层ID必须指定"),t&&(this.setOptions(t),this.opacity=t.opacity||1,this.isSceneLayer=t.isSceneLayer??!1,t.altitude!==void 0&&this.setAltitude(t.altitude)),this._layerId=e,typeof this.animate=="function"&&this._registerAnimate()}getId(){return this._layerId}addTo(e){return e.addLayer(this),this}getZIndex(){const e=this.options||{};return typeof e.zIndex=="number"?e.zIndex:0}getDepthOffset(){const e=this.options||{};return typeof e.depthOffset=="number"?e.depthOffset:0}getOpacity(){return this.opacity}setOpacity(e){this.opacity=e,this.traverse(t=>{"material"in t&&(Array.isArray(t.material)?t.material:[t.material]).forEach(i=>{"opacity"in i&&(i.transparent=e<1,i.opacity=e,i.needsUpdate=!0)}),t instanceof f.Sprite&&(t.material.opacity=e,t.material.transparent=e<1,t.material.needsUpdate=!0)})}getMap(){return this.map?this.map:null}show(){return this.visible||(this.visible=!0,this.options.visible=!0,this.getMap()),this}hide(){return this.visible&&(this.visible=!1,this.options.visible=!1,this.getMap()),this}setAltitude(e){return this.position.y=e,this.updateMatrix(),this.updateMatrixWorld(!0),this}getAltitude(){return this.position.y}_bindMap(e){e&&(this.map=e,typeof this.animate=="function"&&this._registerAnimate())}_registerAnimate(){const e=this.getMap();if(!e?.viewer)return;const t=e.viewer.addAnimationCallback((r,i,o)=>{this.animate?.(r,i,o)});this._animCallbacks.add(t)}_clearAnimationCallbacks(){this._animCallbacks.forEach(e=>e()),this._animCallbacks.clear()}getOptions(){return{...this.options}}setRegionOverlays(e){return this._regionConfigs=(e||[]).map(t=>({id:t.id??this._generateRegionOverlayId(),color:t.color??"#00FF88",opacity:t.opacity??.3,mode:t.mode??"overlay",zIndex:t.zIndex??0,geometry:t.geometry,feature:t.feature})),this}addRegionOverlay(e){const t=e.id??this._generateRegionOverlayId(),r={id:t,color:e.color??"#00FF88",opacity:e.opacity??.3,mode:e.mode??"overlay",zIndex:e.zIndex??0,geometry:e.geometry,feature:e.feature};return this._regionConfigs.push(r),t}removeRegionOverlay(e){return this._regionConfigs=this._regionConfigs.filter(t=>t.id!==e),this}clearRegionOverlays(){return this._regionConfigs=[],this}getRegionOverlays(){return this._regionConfigs.slice()}_generateRegionOverlayId(){return`region-overlay-${Date.now()}-${Math.random().toString(16).slice(2)}`}}us.mergeOptions(Bm);var Um=Object.defineProperty,Vm=(s,e,t)=>e in s?Um(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,vn=(s,e,t)=>Vm(s,typeof e!="symbol"?e+"":e,t);const _c=class td{constructor(e){vn(this,"cache",new Map),vn(this,"gltfLoader"),vn(this,"fbxLoader"),vn(this,"dracoLoader"),this.gltfLoader=new lp(e),this.fbxLoader=new Qp(e)}static getInstance(e){return this.instance||(this.instance=new td(e)),this.instance}clearCache(){this.cache.clear()}async load(e){const t=`${e.type}:${e.url}`;if(this.cache.has(t))return this.cloneCachedModel(t,e);e.type==="gltf"&&e.dracoOptions?.enable&&this.ensureDracoLoader(e.dracoOptions.decoderPath);let r,i;try{if(e.type==="gltf"){const o=await this.gltfLoader.loadAsync(e.url);r=o.scene,i=o.animations}else r=await this.fbxLoader.loadAsync(e.url),i=r.animations;return this.cache.set(t,{model:r,animations:i}),{model:this.processModel(r.clone(),e),animations:this.processAnimations(i)}}catch(o){throw console.error(`[ExternalModelLoader] Failed to load ${e.type} model from ${e.url}:`,o),o}}ensureDracoLoader(e="/draco/"){this.dracoLoader||(this.dracoLoader=new cm,this.dracoLoader.setDecoderPath(e),this.gltfLoader.setDRACOLoader(this.dracoLoader))}cloneCachedModel(e,t){const r=this.cache.get(e),i=r.model.clone();return{model:this.processModel(i,t),animations:this.processAnimations(r.animations)}}processAnimations(e){return e?.map(t=>({...t,name:t.name||"unnamed"}))||[]}processModel(e,t){if(t.position&&e.position.copy(t.position),t.scale)if(typeof t.scale=="number")e.scale.setScalar(t.scale);else{const{x:r,y:i,z:o}=t.scale;r!==void 0&&(e.scale.x=r),i!==void 0&&(e.scale.y=i),o!==void 0&&(e.scale.z=o)}return t.rotation&&e.rotation.setFromVector3(t.rotation),e}};vn(_c,"instance");let Ko=_c;const qo=(s,e)=>{"updateRanges"in s?s.updateRanges[0]=e:s.updateRange=e},yc=new f.Matrix4,hs=new f.Vector3,fs=new f.Quaternion,vc=new f.Vector3,wc=new f.Quaternion,wn=new f.Vector3,km=s=>class extends s{constructor(){super();const e=parseInt(f.REVISION.replace(/\D+/g,""))>=154?"opaque_fragment":"output_fragment";this.onBeforeCompile=t=>{t.vertexShader=`attribute float cloudOpacity;
               varying float vOpacity;
              `+t.vertexShader.replace("#include <fog_vertex>",`#include <fog_vertex>
                 vOpacity = cloudOpacity;
                `),t.fragmentShader=`varying float vOpacity;
              `+t.fragmentShader.replace(`#include <${e}>`,`#include <${e}>
                 gl_FragColor = vec4(outgoingLight, diffuseColor.a * vOpacity);
                `)}}};class zm extends f.Group{constructor({limit:e=200,range:t,material:r=f.MeshLambertMaterial,texture:i,frustumCulled:o=!0}={}){super(),this.name="Clouds",this.ref=this;const l=this,c=new f.PlaneGeometry(1,1),u=new Float32Array(Array.from({length:e},()=>1)),d=new Float32Array(Array.from({length:e},()=>[1,1,1]).flat()),m=new f.InstancedBufferAttribute(u,1);m.setUsage(f.DynamicDrawUsage),c.setAttribute("cloudOpacity",m);const p=km(r),_=new p;_.map=i,_.transparent=!0,_.depthWrite=!1,_.needsUpdate=!0,this.cloudMaterial=_,this.instance=new f.InstancedMesh(c,_,e);const v=this.instance;v.matrixAutoUpdate=!1,v.frustumCulled=o,v.instanceColor=new f.InstancedBufferAttribute(d,3),v.instanceColor.setUsage(f.DynamicDrawUsage),l.add(v);const S=[],M=()=>{const R=S.length;let U=0;for(let $=0;$<this.ref.children.length;$++){const z=this.ref.children[$];z.cloudStateArray&&(U+=z.cloudStateArray.length)}if(R===U)return S;S.length=0;for(let $=0;$<this.ref.children.length;$++){const z=this.ref.children[$];z.cloudStateArray&&S.push(...z.cloudStateArray)}return x(),S},x=()=>{const R=Math.min(e,t!==void 0?t:e,S.length);v.count=R,qo(v.instanceMatrix,{offset:0,count:R*16}),v.instanceColor&&qo(v.instanceColor,{offset:0,count:R*3}),qo(v.geometry.attributes.cloudOpacity,{offset:0,count:R})};let O=0,P=0,C;const T=new f.Quaternion,N=new f.Vector3(0,0,1),X=new f.Vector3;this.update=(R,U,$)=>{O=U,yc.copy(v.matrixWorld).invert(),R.matrixWorld.decompose(vc,wc,wn);const z=M();for(P=0;P<z.length;P++)C=z[P],C.ref.matrixWorld.decompose(hs,fs,wn),hs.add(X.copy(C.position).applyQuaternion(fs).multiply(wn)),fs.copy(wc).multiply(T.setFromAxisAngle(N,C.rotation+=$*C.rotationFactor)),wn.multiplyScalar(C.volume+(1+Math.sin(O*C.density*C.speed))/2*C.growth),C.matrix.compose(hs,fs,wn).premultiply(yc),C.dist=hs.distanceTo(vc);for(z.sort((V,Y)=>Y.dist-V.dist),P=0;P<z.length;P++)C=z[P],u[P]=C.opacity*(C.dist<C.fade-1?C.dist/C.fade:1),v.setMatrixAt(P,C.matrix),v.setColorAt(P,C.color);v.geometry.attributes.cloudOpacity.needsUpdate=!0,v.instanceMatrix.needsUpdate=!0,v.instanceColor&&(v.instanceColor.needsUpdate=!0)}}}let Nm=0;class Wm extends f.Group{constructor({opacity:e=1,speed:t=0,bounds:r=new f.Vector3().fromArray([5,1,1]),segments:i=20,color:o=new f.Color("#ffffff"),fade:l=10,volume:c=6,smallestVolume:u=.25,distribute:d=null,growth:m=4,concentrate:p="inside",seed:_=Math.random()}={}){super(),this.name="cloud_"+Nm++,this.seed=_,this.segments=i,this.bounds=r,this.concentrate=p,this.volume=c,this.smallestVolume=u,this.distribute=d,this.growth=m,this.speed=t,this.fade=l,this.opacity=e,this.color=o,this.ref=this,this.cloudStateArray=[],this.updateCloud()}updateCloudStateArray(){if(this.cloudStateArray.length===this.segments)return;const{segments:e,uuid:t}=this;if(this.cloudStateArray.length>this.segments)this.cloudStateArray.splice(0,this.cloudStateArray.length-this.segments);else for(let r=this.cloudStateArray.length;r<e;r++)this.cloudStateArray.push({segments:e,bounds:new f.Vector3(1,1,1),position:new f.Vector3,uuid:t,index:r,ref:this,dist:0,matrix:new f.Matrix4,volume:0,length:0,speed:0,growth:0,opacity:1,fade:0,density:0,rotation:r*(Math.PI/e),rotationFactor:0,color:new f.Color})}updateCloud(){const{volume:e,color:t,speed:r,growth:i,opacity:o,fade:l,bounds:c,seed:u,cloudStateArray:d,distribute:m,segments:p,concentrate:_,smallestVolume:v}=this;this.updateCloudStateArray();let S=0;function M(){const x=Math.sin(u+S)*1e4;return S++,x-Math.floor(x)}d.forEach((x,O)=>{x.segments=p,x.volume=e,x.color=t,x.speed=r,x.growth=i,x.opacity=o,x.fade=l,x.bounds.copy(c),x.density=Math.max(.5,M()),x.rotationFactor=Math.max(.2,.5*M())*r;const P=m?.(x,O);if(P||p>1){var C;x.position.copy(x.bounds).multiply((C=P?.point)!==null&&C!==void 0?C:{x:M()*2-1,y:M()*2-1,z:M()*2-1})}const T=Math.abs(x.position.x),N=Math.abs(x.position.y),X=Math.abs(x.position.z),R=Math.max(T,N,X);x.length=1,T===R&&(x.length-=T/x.bounds.x),N===R&&(x.length-=N/x.bounds.y),X===R&&(x.length-=X/x.bounds.z),x.volume=(P?.volume!==void 0?P.volume:Math.max(Math.max(0,v),_==="random"?M():_==="inside"?x.length:1-x.length))*e})}}class Qo{constructor(e=4){this.pool=e,this.queue=[],this.workers=[],this.workersResolve=[],this.workerStatus=0}_initWorker(e){if(!this.workers[e]){const t=this.workerCreator();t.addEventListener("message",this._onMessage.bind(this,e)),this.workers[e]=t}}_getIdleWorker(){for(let e=0;e<this.pool;e++)if(!(this.workerStatus&1<<e))return e;return-1}_onMessage(e,t){const r=this.workersResolve[e];if(r&&r(t),this.queue.length){const{resolve:i,msg:o,transfer:l}=this.queue.shift();this.workersResolve[e]=i,this.workers[e].postMessage(o,l)}else this.workerStatus^=1<<e}setWorkerCreator(e){this.workerCreator=e}setWorkerLimit(e){this.pool=e}postMessage(e,t){return new Promise(r=>{const i=this._getIdleWorker();i!==-1?(this._initWorker(i),this.workerStatus|=1<<i,this.workersResolve[i]=r,this.workers[i].postMessage(e,t)):this.queue.push({resolve:r,msg:e,transfer:t})})}dispose(){this.workers.forEach(e=>e.terminate()),this.workersResolve.length=0,this.workers.length=0,this.queue.length=0,this.workerStatus=0}}function bc(s,e){const t=new f.BufferGeometry;t.setAttribute("position",new f.BufferAttribute(new Float32Array([0,0,0]),3));const r=s.sizeAttenuation??!0,i=r?s.size*.002:s.size,o=new f.PointsMaterial({size:i,color:s.color||16777215,sizeAttenuation:r,depthTest:s.depthTest??!0,depthWrite:s.depthWrite??!0});o.onBeforeCompile=c=>{c.fragmentShader=c.fragmentShader.replace("#include <clipping_planes_fragment>",`
            #include <clipping_planes_fragment>
            vec2 coord = gl_PointCoord - vec2(0.5);
            if(length(coord) > 0.5) discard;
            `)};const l=new f.Points(t,o);return l.position.copy(e),l}async function Gm(s,e){let t=null;try{t=await xt._loadTexture(s.url),t.magFilter=f.LinearFilter,t.minFilter=f.LinearMipmapLinearFilter,t.colorSpace=f.SRGBColorSpace,t.generateMipmaps=!0,t.premultiplyAlpha=!1,t.needsUpdate=!0}catch(d){console.error("IconPoint texture load failed:",s.url,d)}const r=new f.SpriteMaterial({map:t??null,color:s.color||16777215,transparent:s.transparent??!0,opacity:s.opacity??1,sizeAttenuation:s.sizeAttenuation??!0,depthTest:s.depthTest??!0,depthWrite:s.depthWrite??!0,premultipliedAlpha:!1,blending:f.NormalBlending}),i=new f.Sprite(r),o=.002,l=s.size;let c,u;if(Array.isArray(l))[c,u]=l;else{const d=typeof l=="number"?l:32;if(t&&t.image?.width&&t.image?.height){const m=t.image,p=m.width/m.height||1;u=d,c=d*p}else c=d,u=d}return i.scale.set(c*o,u*o,1),s.rotation&&(i.rotation.z=s.rotation),s.anchor&&i.center.set(s.anchor[0],s.anchor[1]),i.position.copy(e),i}function Jo(s,e){let t;e instanceof Float32Array?t=Array.from(e):Array.isArray(e)&&typeof e[0]=="number"?t=e:t=e.flatMap(o=>[o.x,o.y,o.z]);const r=new ns;r.setPositions(t);const i=new gn({color:new f.Color(s.color??16777215).getHex(),linewidth:s.width??2,transparent:s.transparent??!0,opacity:s.opacity??1,dashed:!!s.dashArray,dashScale:s.dashArray?.[0]??1,dashSize:s.dashArray?.[0]??1,gapSize:s.dashArray?.[1]??0,resolution:new f.Vector2(window.innerWidth,window.innerHeight),alphaToCoverage:!0,depthTest:s.depthTest??!0,depthWrite:s.depthWrite??!0});return window.addEventListener("resize",()=>{i.resolution.set(window.innerWidth,window.innerHeight)}),new as(r,i)}function xc(s,e){let t=[];if(Array.isArray(e)&&typeof e[0]=="number")for(let M=0;M<e.length;M+=3)t.push(new f.Vector3(e[M],e[M+1],e[M+2]));else if(e instanceof Float32Array)for(let M=0;M<e.length;M+=3)t.push(new f.Vector3(e[M],e[M+1],e[M+2]));else t=e;if(t.length<2)return new f.Mesh;const r=new f.CurvePath,i=s.cornerRadius||5;if(t.length===2||i<=0)for(let M=0;M<t.length-1;M++){const x=new f.LineCurve3(t[M],t[M+1]);r.curves.push(x)}else{let M=t[0];for(let x=1;x<t.length-1;x++){const O=M,P=t[x],C=t[x+1],T=new f.Vector3().subVectors(P,O),N=new f.Vector3().subVectors(C,P),X=T.length(),R=N.length(),U=Math.min(X,R)*.4,$=Math.min(i,U);T.normalize().multiplyScalar(X-$),N.normalize().multiplyScalar($);const z=new f.Vector3().addVectors(O,T),V=new f.Vector3().addVectors(P,N);r.curves.push(new f.LineCurve3(O,z)),r.curves.push(new f.QuadraticBezierCurve3(z,P,V)),M=V}r.curves.push(new f.LineCurve3(M,t[t.length-1]))}const o=s.radius||2,l=s.radialSegments||8,c=s.tubularSegments||64,u=new f.TubeGeometry(r,c,o,l,!1),d=5,m=new f.MeshPhongMaterial({color:s.color||"#19bbd5",side:f.DoubleSide,emissive:new f.Color(s.color||"#19bbd5"),emissiveIntensity:.6*d,transparent:!0});m.defines={USE_UV:""};const _={totalLength:{value:r.getLength()},stripeOffset:{value:0},stripeWidth:{value:s.stripeWidth||10},stripeSpacing:{value:s.stripeSpacing||20},stripeColor:{value:new f.Color(s.stripeColor||"#096be3")},speedFactor:{value:s.speed||10},bloomBoost:{value:d}};m.onBeforeCompile=M=>{M.uniforms.totalLength=_.totalLength,M.uniforms.stripeOffset=_.stripeOffset,M.uniforms.stripeWidth=_.stripeWidth,M.uniforms.stripeSpacing=_.stripeSpacing,M.uniforms.stripeColor=_.stripeColor,M.uniforms.bloomBoost=_.bloomBoost,M.fragmentShader=`
            uniform float totalLength;
            uniform float stripeOffset;
            uniform float stripeWidth;
            uniform float stripeSpacing;
            uniform vec3 stripeColor;
            uniform float bloomBoost;
            ${M.fragmentShader}
        `.replace("#include <color_fragment>",`#include <color_fragment>
            // 计算条纹模式（用于漫反射）
            float pattern = mod((vUv.x - stripeOffset) * totalLength / (stripeWidth + stripeSpacing), 1.0);
            float isStripe = step(pattern, stripeWidth / (stripeWidth + stripeSpacing));
            
            // 混合条纹颜色
            diffuseColor.rgb = mix(diffuseColor.rgb, stripeColor, isStripe);
            
            // 条纹区域再额外提亮，让 bloom 更明显
            if (isStripe > 0.5) {
                diffuseColor.rgb += stripeColor * (3.0 * bloomBoost);
            }
            `).replace("#include <emissivemap_fragment>",`#include <emissivemap_fragment>
            // 计算条纹模式（用于自发光）
            float pattern_e = mod((vUv.x - stripeOffset) * totalLength / (stripeWidth + stripeSpacing), 1.0);
            float isStripe_e = step(pattern_e, stripeWidth / (stripeWidth + stripeSpacing));
            
            // 自发光通道也叠加一遍，进一步抬高亮度
            totalEmissiveRadiance += stripeColor * isStripe_e * (3.0 * bloomBoost);
            `)};const v=new f.Mesh(u,m);let S=0;return v.onBeforeRender=()=>{const M=performance.now(),x=S?(M-S)/1e3:.016;S=M;const O=_.speedFactor.value/_.totalLength.value*10;_.stripeOffset.value-=x*O,_.stripeOffset.value=_.stripeOffset.value%1},v}function Sc(s,e){let t=[];if(Array.isArray(e)&&typeof e[0]=="number")for(let C=0;C<e.length;C+=3)t.push(new f.Vector3(e[C],e[C+1],e[C+2]));else if(e instanceof Float32Array)for(let C=0;C<e.length;C+=3)t.push(new f.Vector3(e[C],e[C+1],e[C+2]));else t=e;if(t.length<2)return new f.Mesh;const r=new f.CurvePath,i=s.cornerRadius||5;if(t.length===2||i<=0)for(let C=0;C<t.length-1;C++){const T=new f.LineCurve3(t[C],t[C+1]);r.curves.push(T)}else{let C=t[0];for(let T=1;T<t.length-1;T++){const N=C,X=t[T],R=t[T+1],U=new f.Vector3().subVectors(X,N),$=new f.Vector3().subVectors(R,X),z=U.length(),V=$.length(),Y=Math.min(z,V)*.4,Q=Math.min(i,Y);U.normalize().multiplyScalar(z-Q),$.normalize().multiplyScalar(Q);const K=new f.Vector3().addVectors(N,U),te=new f.Vector3().addVectors(X,$);r.curves.push(new f.LineCurve3(N,K)),r.curves.push(new f.QuadraticBezierCurve3(K,X,te)),C=te}r.curves.push(new f.LineCurve3(C,t[t.length-1]))}const o=s.width||4,c=r.getPoints(128),u=[],d=[],m=[];let p=0;const _=r.getLength();for(let C=0;C<c.length;C++){const T=c[C];let N;C===0?N=new f.Vector3().subVectors(c[1],c[0]):C===c.length-1?N=new f.Vector3().subVectors(c[C],c[C-1]):N=new f.Vector3().subVectors(c[C+1],c[C-1]),N.y=0,N.normalize();const X=new f.Vector3(-N.z,0,N.x),R=o/2,U=new f.Vector3(T.x+X.x*R,T.y,T.z+X.z*R),$=new f.Vector3(T.x-X.x*R,T.y,T.z-X.z*R);u.push(U.x,U.y,U.z),u.push($.x,$.y,$.z),C>0&&(p+=c[C].distanceTo(c[C-1]));const z=p/_;if(d.push(z,0),d.push(z,1),C<c.length-1){const V=C*2;m.push(V,V+1,V+2),m.push(V+1,V+3,V+2)}}const v=new f.BufferGeometry;v.setAttribute("position",new f.BufferAttribute(new Float32Array(u),3)),v.setAttribute("uv",new f.BufferAttribute(new Float32Array(d),2)),v.setIndex(m),v.computeVertexNormals();const S=5,M=new f.MeshPhongMaterial({color:s.color||"#0ED5FD",side:f.DoubleSide,emissive:new f.Color(s.color||"#0ED5FD"),emissiveIntensity:5,transparent:!0});M.defines={USE_UV:""};const x={totalLength:{value:_},stripeOffset:{value:0},arrowLength:{value:s.arrowLength||20},arrowSpacing:{value:s.arrowSpacing||80},arrowColor:{value:new f.Color(s.color||"#0ED5FD")},speedFactor:{value:s.speed||10},bloomBoost:{value:S}};M.onBeforeCompile=C=>{C.uniforms.totalLength=x.totalLength,C.uniforms.stripeOffset=x.stripeOffset,C.uniforms.arrowLength=x.arrowLength,C.uniforms.arrowSpacing=x.arrowSpacing,C.uniforms.arrowColor=x.arrowColor,C.uniforms.bloomBoost=x.bloomBoost,C.fragmentShader=C.fragmentShader.replace("uniform vec3 diffuse;",`uniform vec3 diffuse;
            uniform float totalLength;
            uniform float stripeOffset;
            uniform float arrowLength;
            uniform float arrowSpacing;
            uniform vec3 arrowColor;
            uniform float bloomBoost;`),C.fragmentShader=C.fragmentShader.replace("#include <color_fragment>",`#include <color_fragment>
            {
                float tpat = arrowLength + arrowSpacing;
                float posi = mod((vUv.x - stripeOffset) * totalLength, tpat);
                float inArrow = step(posi, arrowLength);
                float npos = posi / arrowLength;
                
                float centerDist = abs(vUv.y - 0.5);
                
                float h0 = step(npos, 0.5);
                float headWidth = mix(0.0, 1.5, npos / 0.5);
                float shaftWidth = 0.6;
                float arrowWidth = mix(shaftWidth, headWidth, h0);
                float arrowShape = step(centerDist, arrowWidth * 0.5);
                
                float mask = inArrow * arrowShape;
                mask = clamp(mask, 0.0, 1.0);
                
                diffuseColor.rgb = arrowColor;
                diffuseColor.a = mask;
            }`),C.fragmentShader=C.fragmentShader.replace("#include <emissivemap_fragment>",`#include <emissivemap_fragment>
            {
                float tpat2 = arrowLength + arrowSpacing;
                float posi2 = mod((vUv.x - stripeOffset) * totalLength, tpat2);
                float inArrow2 = step(posi2, arrowLength);
                float npos2 = posi2 / arrowLength;
                
                float centerDist2 = abs(vUv.y - 0.5);
                
                float h02 = step(npos2, 0.5);
                float headWidth2 = mix(0.0, 1.5, npos2 / 0.5);
                float shaftWidth2 = 0.6;
                float arrowWidth2 = mix(shaftWidth2, headWidth2, h02);
                float arrowShape2 = step(centerDist2, arrowWidth2 * 0.5);
                
                float mask2 = inArrow2 * arrowShape2;
                mask2 = clamp(mask2, 0.0, 1.0);
                
                totalEmissiveRadiance += arrowColor * mask2 * 0.5;
            }`)};const O=new f.Mesh(v,M);let P=0;return O.onBeforeRender=()=>{const C=performance.now(),T=P?(C-P)/1e3:.016;P=C;const N=x.speedFactor.value/x.totalLength.value*10;x.stripeOffset.value-=T*N,x.stripeOffset.value=x.stripeOffset.value%1},O}async function Mc(s,e){let t=[];if(Array.isArray(e)&&typeof e[0]=="number"){const V=e;for(let Y=0;Y<V.length;Y+=3)t.push(new f.Vector3(V[Y],V[Y+1],V[Y+2]))}else if(e instanceof Float32Array)for(let V=0;V<e.length;V+=3)t.push(new f.Vector3(e[V],e[V+1],e[V+2]));else t=e;if(t.length<2)return new f.Mesh;const r=(s.width??10)*.5,i=[],o=[],l=[];let c=0;const u=[0];for(let V=1;V<t.length;V++){const Y=t[V].distanceTo(t[V-1]);c+=Y,u.push(c)}if(c===0)return new f.Mesh;const d=s.repeat??1,m=[],p=[];for(let V=0;V<t.length;V++){let Y=new f.Vector3;V===0?Y.subVectors(t[V+1],t[V]):V===t.length-1?Y.subVectors(t[V],t[V-1]):Y.subVectors(t[V+1],t[V-1]),Y.normalize();const Q=new f.Vector3(0,1,0);let K=new f.Vector3().crossVectors(Y,Q);K.lengthSq()<1e-10?K.set(1,0,0):K.normalize(),m.push(t[V].clone().add(K.clone().multiplyScalar(-r))),p.push(t[V].clone().add(K.clone().multiplyScalar(r)))}let _=0,v=0;for(let V=1;V<m.length;V++)_+=m[V].distanceTo(m[V-1]),v+=p[V].distanceTo(p[V-1]);if((_+v)/2===0)return new f.Mesh;for(let V=0;V<t.length;V++){i.push(m[V].x,m[V].y,m[V].z,p[V].x,p[V].y,p[V].z);const Y=u[V]/c*d;o.push(Y,0,Y,1)}const M=t.length-1;for(let V=0;V<M;V++){const Y=V*2,Q=V*2+1,K=(V+1)*2,te=(V+1)*2+1;l.push(Y,K,Q),l.push(K,te,Q)}const x=new f.BufferGeometry;x.setAttribute("position",new f.BufferAttribute(new Float32Array(i),3)),x.setAttribute("uv",new f.BufferAttribute(new Float32Array(o),2)),x.setIndex(l),x.computeBoundingBox(),x.computeVertexNormals();const O=await xt._loadTexture(s.flowTexture);O.wrapS=f.RepeatWrapping,O.wrapT=f.RepeatWrapping,O.anisotropy=4,O.needsUpdate=!0;const P=new f.Color(s.color??16777215),T={uMap:{value:O},uColor:{value:P},uOpacity:{value:s.opacity??1},uOffset:{value:0},uBloomBoost:{value:5}},N=s.depthOffset??1,X=N!==0,R=new f.ShaderMaterial({uniforms:T,vertexShader:`
            varying vec2 vUv;
            void main() {
                vUv = uv;
                gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
            }
        `,fragmentShader:`
            uniform sampler2D uMap;
            uniform vec3 uColor;
            uniform float uOpacity;
            uniform float uOffset;
            uniform float uBloomBoost;
            varying vec2 vUv;

            void main() {
                // 关键修复：修正UV滚动计算，确保方向正确[3](@ref)
                vec2 uv = vec2(fract(vUv.x + uOffset), vUv.y);
                vec4 texColor = texture2D(uMap, uv);
                
                // 添加alpha测试，完全透明的片元直接丢弃
                if (texColor.a < 0.01) discard;
                
                float alpha = texColor.a * uOpacity;
                vec3 baseColor = texColor.rgb * uColor;
                // 使用更自然的颜色增强公式
                vec3 finalColor = baseColor * uBloomBoost;
                
                gl_FragColor = vec4(finalColor, alpha);
            }
        `,transparent:s.transparent??!0,depthTest:s.depthTest??!0,depthWrite:s.depthWrite??!1,blending:f.AdditiveBlending,side:f.DoubleSide,polygonOffset:X,polygonOffsetFactor:-N,polygonOffsetUnits:-N}),U=new f.Mesh(x,R);let $=0;U.onBeforeRender=()=>{const V=performance.now(),Y=$?(V-$)/1e3:.016;$=V;const Q=s.speed??10;T.uOffset.value=z(T.uOffset.value-Y*Q/c)};function z(V){return V-Math.floor(V)}return U}async function Rm(s,e){const t=s.type||(s.url.toLowerCase().endsWith(".fbx")?"fbx":"gltf");return(await Ko.getInstance().load({...s,type:t,position:e})).model}function jm(s,e){const{geometry:t,center:r,avgY:i}=Eo(e),o=s.depthOffset??0,l=o!==0,c=new f.MeshBasicMaterial({color:new f.Color(s.color??16777215),transparent:s.transparent??!0,opacity:s.opacity??1,wireframe:s.wireframe??!1,side:s.side==="back"?f.BackSide:s.side==="double"?f.DoubleSide:f.FrontSide,polygonOffset:l,polygonOffsetFactor:l?o:0,polygonOffsetUnits:l?o:0,depthTest:s.depthTest??!0,depthWrite:s.depthWrite??!0}),u=new f.Mesh(t,c);if(u.rotation.x=-Math.PI/2,u.position.set(r.x,i,r.z),(s.borderWidth??0)>0){const p={color:s.borderColor??s.color??0,width:s.borderWidth},_=[];for(let S=0;S<e.length;S+=3){const M=e[S],x=e[S+2];_.push(M-r.x,-(x-r.z),0)}const v=Jo(p,_);v.position.z+=.1,u.add(v)}return u}function $m(s,e){const t=s.extrude?.height||2e3,r=[],i=[],o=[];for(let p=0;p<e.length;p+=3){const _=e[p],v=e[p+1],S=e[p+2];i.push(new f.Vector3(_,v,S)),o.push(new f.Vector3(_,v+t,S))}r.push(...i,...o);const l=new f.BufferGeometry;l.setFromPoints(r);const c=[],u=i.length;for(let p=0;p<u;p++){const _=(p+1)%u;c.push(p,p+u,_),c.push(_,p+u,_+u)}for(let p=2;p<u;p++)c.push(0,p-1,p),c.push(u,u+p-1,u+p);l.setIndex(c),l.computeVertexNormals();const d=new f.ShaderMaterial({uniforms:{uColor:{value:new f.Color(s.color??16777215)},uOpacity:{value:s.opacity??1},uBrightness:{value:1.2}},vertexShader:`
          varying vec3 vWorldPosition;
          varying vec3 vNormal;
          void main() {
            vNormal = normalize(normalMatrix * normal);
            vWorldPosition = (modelMatrix * vec4(position, 1.0)).xyz;
            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
          }
        `,fragmentShader:`
          uniform vec3 uColor;
          uniform float uOpacity;
          uniform float uBrightness;
          varying vec3 vWorldPosition;
          varying vec3 vNormal;
      
          void main() {
            float fresnel = pow(1.0 - abs(dot(vNormal, vec3(0.0, 0.0, 1.0))), 2.0);
            float innerGlow = smoothstep(0.3, 0.8, length(vWorldPosition - vec3(0.0))) * uBrightness;
            vec3 finalColor = uColor * (1.0 + fresnel * 0.5 + innerGlow);
            gl_FragColor = vec4(finalColor, uOpacity);
            if (uOpacity >= 0.99) gl_FragDepthEXT = gl_FragCoord.z;
          }
        `,transparent:s.transparent??!0,side:f.DoubleSide,depthTest:s.depthTest??!0,depthWrite:s.depthWrite??!0});return new f.Mesh(l,d)}function Xm(s,e,t){const{geometry:r,center:i,avgY:o}=Eo(t),l=new Bd(r,{textureWidth:512,textureHeight:512,waterNormals:new f.TextureLoader().load(s.normalMap,function(d){d.wrapS=d.wrapT=f.RepeatWrapping}),waterColor:s.color||"#19AAEE",sunColor:s.sunColor||"#05FFF8",distortionScale:1,alpha:s.opacity||.8}),c=l.onBeforeRender,u=l.onAfterRender;return l.onBeforeRender=(d,m,p,_,v,S)=>{e.autoUpdate=!1,c.call(l,d,m,p,_,v,S)},l.onAfterRender=(d,m,p,_,v,S)=>{e.autoUpdate=!0,u.call(l,d,m,p,_,v,S)},l.material.uniforms.size.value=.1,l.rotation.x=-Math.PI/2,l.position.set(i.x,o,i.z),e.viewer.addEventListener("update",()=>{l.material.uniforms.time.value+=1/60}),l}function Eo(s){let e=0;for(let l=1;l<s.length;l+=3)e+=s[l];e/=s.length/3;const t={x:0,z:0},r=[];for(let l=0;l<s.length;l+=3)t.x+=s[l],t.z+=s[l+2];t.x/=s.length/3,t.z/=s.length/3;for(let l=0;l<s.length;l+=3)r.push(new f.Vector2(s[l]-t.x,-(s[l+2]-t.z)));const i=new f.Shape(r);return{geometry:new f.ShapeGeometry(i),center:t,avgY:e}}async function Ym(s,e){const{geometry:t,center:r,avgY:i}=Eo(e),o=await xt._loadTexture(s.normalMap),l=await xt._loadTexture(s.normalMap);o.wrapS=o.wrapT=f.RepeatWrapping,l.wrapS=l.wrapT=f.RepeatWrapping,o.repeat.set(.015,.015),l.repeat.set(.005,.005);const c=new f.MeshStandardMaterial({color:new f.Color(s.color).multiplyScalar(3.5),roughness:.1,metalness:.8,transparent:s.transparent??!0,opacity:.9,fog:!1,normalMap:o,normalScale:new f.Vector2(1.5,1.5),envMapIntensity:2,depthTest:s.depthTest??!0,depthWrite:s.depthWrite??!0}),u=new f.Mesh(t,c);u.rotation.x=-Math.PI/2,u.position.set(r.x,i+.15,r.z),u.castShadow=!1,u.receiveShadow=!0;let d=0;return u.onBeforeRender=()=>{const m=performance.now(),p=d?(m-d)/1e3:.016;o.offset.x+=p*.08,o.offset.y+=p*.03,l.offset.x-=p*.12,l.offset.y+=p*.02,u.position.y=i+.5+Math.sin(m*.02)*.02,d=m},u}function Zm(s,e){s.color=new f.Color(s.hexcolor),s.boundstext&&(s.bounds=new f.Vector3(s.boundstext.x,s.boundstext.y,s.boundstext.z));const t=new Wm(s);return t.castShadow=!0,t.scale.setScalar(50),t.position.copy(e),t}async function Km(s,e){const r={...{fontSizeDpi:48,fontFamily:"'Microsoft YaHei', sans-serif",fontWeight:"bold",fontStyle:"normal",textColor:"#ffffff",strokeColor:"#000000",strokeWidth:2,showBackground:!0,bgStyle:1,bgColor:"#3498db",bgOpacity:.8,shadowColor:"rgba(0, 0, 0, 0.5)",shadowBlur:5,shadowOffsetX:3,shadowOffsetY:3,roundRectRadius:20,bubblePointerHeight:10,bubblePointerWidth:15,bubbleBorderColor:"#ffffff",bubbleBorderWidth:3,screenSpaceSize:20,fixedSize:50},...s};r.screenSpaceSize==null&&r.fixedSize!=null&&(r.screenSpaceSize=r.fixedSize);const o=(typeof window<"u"&&window.devicePixelRatio||1)*4,l=s.screenSpaceSize!=null||s.fixedSize!=null;if(s.fontSizeDpi==null&&l){const X=s.screenSpaceSize??s.fixedSize??r.screenSpaceSize;r.fontSizeDpi=X*o}r.fontSizeDpi=Math.min(Math.max(r.fontSizeDpi,8),128);const c=document.createElement("canvas"),u=c.getContext("2d");if(!u)throw new Error("canvas context is null");const d=`${r.fontStyle} ${r.fontWeight} ${r.fontSizeDpi}px ${r.fontFamily}`;u.font=d;const m=r.showBackground?20:0,p=100,_=50,v=u.measureText(r.text),S=Math.max(p,v.width+m*2),M=Math.max(_,r.fontSizeDpi*1.5+m*2);c.width=Math.min(S,2048),c.height=Math.min(M,2048),u.clearRect(0,0,c.width,c.height),u.font=d,r.showBackground&&(r.bgStyle===1?(u.fillStyle=r.bgColor,u.globalAlpha=r.bgOpacity,u.beginPath(),Ac(u,m/2,m/2,c.width-m,c.height-m,r.roundRectRadius),u.fill(),u.globalAlpha=1,u.shadowColor=r.shadowColor,u.shadowBlur=r.shadowBlur,u.shadowOffsetX=r.shadowOffsetX,u.shadowOffsetY=r.shadowOffsetY):(u.fillStyle=r.bgColor,u.globalAlpha=r.bgOpacity,u.beginPath(),Pc(u,c.width/2,c.height/2,c.width*.8,c.height*.8,r.roundRectRadius,r.bubblePointerHeight,r.bubblePointerWidth),u.fill(),u.globalAlpha=1,u.strokeStyle=r.bubbleBorderColor,u.lineWidth=r.bubbleBorderWidth,u.stroke())),u.textAlign="center",u.textBaseline="middle",r.strokeWidth>0&&(u.strokeStyle=r.strokeColor,u.lineWidth=r.strokeWidth,u.lineJoin="round",u.strokeText(r.text,c.width/2,c.height/2)),u.fillStyle=r.textColor,u.fillText(r.text,c.width/2,c.height/2),u.shadowColor="transparent";const x=new f.CanvasTexture(c);x.magFilter=f.NearestFilter,x.minFilter=f.LinearMipmapLinearFilter,x.anisotropy=16;const O=new f.SpriteMaterial({map:x,transparent:s.transparent??!0,depthTest:s.depthTest??!0,depthWrite:s.depthWrite??!0,fog:!1}),P=new f.Sprite(O),C=r.screenSpaceSize??r.fixedSize;P.scale.set(c.width*C/100,c.height*C/100,1);const T=s.anchor||[.5,.5],N=s.textOffset||{x:0,y:0};return P.center.set(T[0]-N.x/c.width,T[1]+N.y/c.height),e&&P.position.copy(e),P}async function qm(s,e,t){const i={...{fontSizeDpi:48,fontFamily:"'Microsoft YaHei', sans-serif",fontWeight:"bold",fontStyle:"normal",textColor:"#ffffff",strokeColor:"#000000",strokeWidth:2,showBackground:!0,bgStyle:1,bgColor:"#3498db",bgOpacity:.8,shadowColor:"rgba(0, 0, 0, 0.5)",shadowBlur:5,shadowOffsetX:3,shadowOffsetY:3,roundRectRadius:20,bubblePointerHeight:10,bubblePointerWidth:15,bubbleBorderColor:"#ffffff",bubbleBorderWidth:3,screenSpaceSize:20,maxVisibleDistance:1/0},...s};i.screenSpaceSize==null&&s.fixedSize!=null&&(i.screenSpaceSize=s.fixedSize);const l=(typeof window<"u"&&window.devicePixelRatio||1)*4;s.fontSizeDpi==null&&(i.fontSizeDpi=i.screenSpaceSize*l),i.fontSizeDpi=Math.max(i.fontSizeDpi,8);const c=document.createElement("canvas"),u=c.getContext("2d");if(!u)throw new Error("Failed to get canvas context");const d=`${i.fontStyle} ${i.fontWeight} ${i.fontSizeDpi}px ${i.fontFamily}`;u.font=d;const m=i.showBackground?20:0,p=100,_=50,v=u.measureText(i.text),S=Math.max(p,v.width+m*2),M=Math.max(_,i.fontSizeDpi*1.5+m*2);c.width=Math.min(S,2048),c.height=Math.min(M,2048),u.clearRect(0,0,c.width,c.height),u.font=d,i.showBackground&&(i.bgStyle===1?(u.fillStyle=i.bgColor,u.globalAlpha=i.bgOpacity,u.beginPath(),Ac(u,m/2,m/2,c.width-m,c.height-m,i.roundRectRadius),u.fill(),u.globalAlpha=1,u.shadowColor=i.shadowColor,u.shadowBlur=i.shadowBlur,u.shadowOffsetX=i.shadowOffsetX,u.shadowOffsetY=i.shadowOffsetY):(u.fillStyle=i.bgColor,u.globalAlpha=i.bgOpacity,u.beginPath(),Pc(u,c.width/2,c.height/2,c.width*.8,c.height*.8,i.roundRectRadius,i.bubblePointerHeight,i.bubblePointerWidth),u.fill(),u.globalAlpha=1,u.strokeStyle=i.bubbleBorderColor,u.lineWidth=i.bubbleBorderWidth,u.stroke())),u.textAlign="center",u.textBaseline="middle",i.strokeWidth>0&&(u.strokeStyle=i.strokeColor,u.lineWidth=i.strokeWidth,u.lineJoin="round",u.strokeText(i.text,c.width/2,c.height/2)),u.fillStyle=i.textColor,u.fillText(i.text,c.width/2,c.height/2),u.shadowColor="transparent";const x=new f.CanvasTexture(c),O=new f.SpriteMaterial({map:x,transparent:s.transparent??!0,depthTest:s.depthTest??!0,depthWrite:s.depthWrite??!0,fog:!1}),P=new f.Sprite(O),C=s.anchor||[.5,.5],T=s.textOffset||{x:0,y:0},N=i.screenSpaceSize,X=N*(c.width/c.height);P.center.set(C[0]-T.x/X,C[1]+T.y/N),P.position.copy(e),P.userData.isLabel=!0;const R=()=>{if(!P.visible)return;const $=t.viewer.camera.position.distanceTo(P.position);if($>i.maxVisibleDistance){P.visible=!1;return}P.visible=!0;const z=new f.Vector2;t.viewer.renderer.getSize(z);const V=z.height,Y=f.MathUtils.degToRad(t.viewer.camera.fov),Q=typeof window<"u"&&window.devicePixelRatio||1,te=i.screenSpaceSize*Q/c.height*(2*$*Math.tan(Y/2)/V);P.scale.set(te*c.width,te*c.height,1),P.lookAt(t.viewer.camera.position)};R();const U=()=>R();return P.addEventListener("dispose",()=>{t.viewer.renderer.domElement.removeEventListener("resize",R)}),t.viewer.renderer.domElement.addEventListener("resize",R),t.viewer.camera.addEventListener("change",R),P.onBeforeRender=U,P}async function Qm(s,e){const t=s.size??s.iconSize,r={text:s.text||"",iconSize:t,fontSize:s.fontSize??12,fontFamily:s.fontFamily||"微软雅黑",fontWeight:s.fontWeight??400,padding:{top:3,right:6,bottom:3,left:6,...s.padding},bgColor:s.bgColor||"#ffffff",bgOpacity:s.bgOpacity??1,textColor:s.textColor||"#000000",strokeColor:s.strokeColor||"#000000",strokeWidth:s.strokeWidth??0,iconScale:s.iconScale??1,renderbg:s.renderbg??!0,textOffset:s.textOffset??{x:-40,y:-19},depthTest:s.depthTest??!1,depthWrite:s.depthWrite??!1,transparent:s.transparent??!0,canvasScale:4};let i=null;if(s.url)try{i=await ig(s.url)}catch{console.error("Label icon load failed:",s.url)}const{canvas:o,width:l,height:c,center:u}=await Jm(r,i),d=new f.Texture(o);d.generateMipmaps=!0,d.minFilter=f.LinearMipmapLinearFilter,d.magFilter=f.LinearFilter,d.colorSpace=f.SRGBColorSpace,d.premultiplyAlpha=!1,d.needsUpdate=!0;const m=new f.SpriteMaterial({map:d,transparent:r.transparent??!0,depthTest:r.depthTest??!0,depthWrite:r.depthWrite??!0,blending:f.NormalBlending,sizeAttenuation:!1,premultipliedAlpha:!1,alphaTest:.05}),p=new f.Sprite(m),_=.002;return p.scale.set(l*_,c*_,1),s.anchor?p.center.set(s.anchor[0],s.anchor[1]):p.center.set(u[0],u[1]),e&&p.position.copy(e),p}async function Jm(s,e){return new Promise(t=>{const{text:r,fontSize:i,fontFamily:o,padding:l,bgColor:c,textColor:u,strokeColor:d,strokeWidth:m,iconScale:p,canvasScale:_,renderbg:v,textOffset:S,iconSize:M,fontWeight:x,bgOpacity:O}=s,P=e!==null;let C=0,T=0;if(P&&e){const Ge=e.naturalWidth||e.width||1,At=e.naturalHeight||e.height||1,mi=Ge/At||1;Array.isArray(M)?(C=M[0],T=M[1]):typeof M=="number"?(T=M,C=M*mi):(C=Ge,T=At)}else Array.isArray(M)?(C=M[0],T=M[1]):typeof M=="number"&&(C=M,T=M);const X=document.createElement("canvas").getContext("2d"),R=`${x} ${i}px ${o}`;X.font=R;const U=Hm(X,r,i),{width:$,ascent:z,descent:V}=U,Y=P?C/2:0,Q=P?T/2:0,K=Y+S.x,te=Q+S.y,H=K-l.left,Pe=K+$+l.right,ve=te-z-l.top,we=te+V+l.bottom;let me,Ce,Le,Oe;P?(me=Math.min(0,H),Ce=Math.min(0,ve),Le=Math.max(C,Pe),Oe=Math.max(T,we)):(me=H,Ce=ve,Le=Pe,Oe=we);const lt=Math.ceil(Le-me),ct=Math.ceil(Oe-Ce),{canvas:Vt,ctx:Jt}=Em(lt,ct,_),gt=-me,Et=-Ce;if(P&&e&&C>0&&T>0){const Ge=C*p,At=T*p,mi=(C-Ge)/2,_t=(T-At)/2,gi=gt+mi,$i=Et+_t;Jt.drawImage(e,gi,$i,Ge,At)}const ji=gt+K,xr=Et+te;v&&c&&c!=="transparent"&&tg(Jt,ji,xr,$,z,V,l,c,O),Jt.font=R,rg(Jt,r,ji,xr,u,m,d);let Ht,Sr;P&&C>0&&T>0?(Ht=(gt+Y)/lt,Sr=(Et+Q)/ct):(Ht=.5,Sr=.5),t({canvas:Vt,width:lt,height:ct,center:[Ht,1-Sr]})})}function Ac(s,e,t,r,i,o){s.beginPath(),s.moveTo(e+o,t),s.lineTo(e+r-o,t),s.quadraticCurveTo(e+r,t,e+r,t+o),s.lineTo(e+r,t+i-o),s.quadraticCurveTo(e+r,t+i,e+r-o,t+i),s.lineTo(e+o,t+i),s.quadraticCurveTo(e,t+i,e,t+i-o),s.lineTo(e,t+o),s.quadraticCurveTo(e,t,e+o,t),s.closePath()}function Pc(s,e,t,r,i,o,l,c){if(r<=0)throw new Error("Width must be positive");if(i<=0)throw new Error("Height must be positive");if(o<0)throw new Error("Radius cannot be negative");const u=r,d=i,m=Math.min(o,r/2,i/2),p=l??10,_=c??15;s.beginPath(),s.moveTo(e-u/2+m,t-d/2),s.lineTo(e+u/2-m,t-d/2),s.quadraticCurveTo(e+u/2,t-d/2,e+u/2,t-d/2+m),s.lineTo(e+u/2,t+d/2-m),s.quadraticCurveTo(e+u/2,t+d/2,e+u/2-m,t+d/2),s.lineTo(e+_/2,t+d/2),s.lineTo(e,t+d/2+p),s.lineTo(e-_/2,t+d/2),s.lineTo(e-u/2+m,t+d/2),s.quadraticCurveTo(e-u/2,t+d/2,e-u/2,t+d/2-m),s.lineTo(e-u/2,t-d/2+m),s.quadraticCurveTo(e-u/2,t-d/2,e-u/2+m,t-d/2),s.closePath()}function Em(s,e,t){const r=document.createElement("canvas");r.width=Math.ceil(s*t),r.height=Math.ceil(e*t);const i=r.getContext("2d",{alpha:!0});return i.scale(t,t),i.imageSmoothingEnabled=!1,{canvas:r,ctx:i}}function Hm(s,e,t){const r=s.measureText(e);return{width:r.width,ascent:r.actualBoundingBoxAscent||t*.8,descent:r.actualBoundingBoxDescent||t*.2,totalHeight:(r.actualBoundingBoxAscent||t*.8)+(r.actualBoundingBoxDescent||t*.2)}}function eg(s,e,t,r,i,o){s.beginPath(),s.moveTo(e+o,t),s.lineTo(e+r-o,t),s.arcTo(e+r,t,e+r,t+o,o),s.lineTo(e+r,t+i-o),s.arcTo(e+r,t+i,e+r-o,t+i,o),s.lineTo(e+o,t+i),s.arcTo(e,t+i,e,t+i-o,o),s.lineTo(e,t+o),s.arcTo(e,t,e+o,t,o),s.closePath()}function tg(s,e,t,r,i,o,l,c,u=1){const d=e-l.left,m=t-i-l.top,p=r+l.left+l.right,_=i+o+l.top+l.bottom;s.save(),s.globalAlpha=u,s.fillStyle=c,eg(s,d,m,p,_,2),s.fill(),s.restore()}function rg(s,e,t,r,i,o,l){s.save(),s.textBaseline="alphabetic",s.textAlign="left",o>0&&(s.strokeStyle=l,s.lineWidth=o,s.lineJoin="round",s.strokeText(e,t,r)),s.fillStyle=i,s.fillText(e,t,r),s.restore()}function ig(s){return new Promise((e,t)=>{const r=new Image;r.crossOrigin="Anonymous",r.onload=()=>e(r),r.onerror=i=>t(new Error(`Failed to load image: ${s} ${i}`)),r.src=s})}async function ng(s,e,t){const i=new f.CylinderGeometry(.2,.2,24,12),o=new f.MeshBasicMaterial({color:s.color}),l=await xt._loadTexture(s.icon),c=new f.PointsMaterial({size:80*window.innerHeight/window.innerHeight,fog:!1,opacity:1,transparent:s.transparent??!0,toneMapped:!1,blending:f.AdditiveBlending,map:l,sizeAttenuation:!0,depthTest:s.depthTest??!0,depthWrite:s.depthWrite??!1}),u=new f.InstancedMesh(i,o,e.length);u.position.add(t.prjcenter),u.castShadow=!0;const d=new f.Object3D,m=[];for(let S=0;S<e.length;S++){const M=e[S],x=new f.Vector3(M.coordinates[0],M.coordinates[1],M.coordinates[2]||0),P=t.projectToWorld(x).sub(t.prjcenter);d.position.copy(P),d.updateMatrix(),u.setMatrixAt(S,d.matrix),m.push(P.x,0,P.z)}const p=new Float32Array(m),_=new f.BufferGeometry;_.setAttribute("position",new f.BufferAttribute(p,3));const v=new f.Points(_,c);return v.position.add(t.prjcenter),v.position.y=1.5*10,v.renderOrder=99999999,v.visible=!0,{points:v,InstancedCol:u}}var sg=Object.defineProperty,og=(s,e,t)=>e in s?sg(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Cc=(s,e,t)=>og(s,typeof e!="symbol"?e+"":e,t);const Ho=class Fi{constructor(e){this.config=e}async applyTo(e){if(!e)return!1;try{switch(e.visible=this.config.visible!==!1,this.config.type){case"basic-point":case"icon-point":case"icon-label-point":return this._applyPointStyle(e);case"basic-line":return this._applyLineStyle(e);case"flow-tube-line":return this._applyFlowLineStyle(e);case"arrow-line":return this._applyArrowLineStyle(e);case"flow-texture-line":return this._applyFlowTextureLineStyle(e);case"gltf":case"fbx":return this._applyModelStyle(e);case"basic-polygon":return this._applyPolygonStyle(e);case"extrude-polygon":return this._applyExtrudeStyle(e);case"water":case"base-water":return this._applyWaterStyle(e);case"cloud":return this._applyCloudStyle(e);case"canvas-label":case"canvas-label-fixed":return this._applyTextSpriteStyle(e);case"light":return this._applyLightStyle(e);case"custom":return this._applyCustomStyle(e);default:throw new Error("Unknown style type")}}catch(t){return console.error("Style apply failed:",t),e.visible=!1,!1}}async _applyPointStyle(e){const t=this.config;return t.type==="icon-point"?await this._applyIconPoint(e,t):t.type==="basic-point"?this._applyBasicPoint(e,t):t.type==="icon-label-point"&&this._applyIconLabelPoint(e,t),!0}async _applyIconPoint(e,t){return!0}_applyBasicPoint(e,t){let r;if(e instanceof f.Points)r=e;else if(r=bc(t,e.position),r.position.copy(e.position),r.rotation.copy(e.rotation),r.scale.copy(e.scale),e.parent){let l=e.parent;l._renderObject=r,l._updateGeometry()}const i=r.material,o=t.sizeAttenuation;i.size=o?t.size*.002:t.size,t.color&&i.color.set(t.color),i.sizeAttenuation=o??!1,i.onBeforeCompile=l=>{l.fragmentShader=l.fragmentShader.replace("#include <clipping_planes_fragment>",`
                #include <clipping_planes_fragment>
                vec2 coord = gl_PointCoord - vec2(0.5);
                if(length(coord) > 0.5) discard;
                `)},i.needsUpdate=!0}_applyIconLabelPoint(e,t){return!0}_applyLineStyle(e){return this.config,!0}_applyFlowLineStyle(e){return!0}_applyArrowLineStyle(e){return!0}_applyFlowTextureLineStyle(e){return!0}_applyPolygonStyle(e){return!0}_applyExtrudeStyle(e){return!0}_applyWaterStyle(e){return!0}_applyCloudStyle(e){return!0}_applyTextSpriteStyle(e){return!0}_applyLightStyle(e){return!0}async _applyModelStyle(e){return!0}async _applyCustomStyle(e){const r=await this.config.build();return e instanceof f.Group&&(e.clear(),e.add(r)),!0}static async _loadTexture(e){if(Fi._textureCache.has(e))return Fi._textureCache.get(e);const t=await new Promise((r,i)=>{Fi._textureLoader.load(e,r,void 0,i)});return t.needsUpdate=!0,Fi._textureCache.set(e,t),t}static create(e){return e instanceof Fi?e:new Fi(e)}};Cc(Ho,"_textureCache",new Map),Cc(Ho,"_textureLoader",new f.TextureLoader);let xt=Ho;const Je=[];for(let s=0;s<256;++s)Je.push((s+256).toString(16).slice(1));function ag(s,e=0){return(Je[s[e+0]]+Je[s[e+1]]+Je[s[e+2]]+Je[s[e+3]]+"-"+Je[s[e+4]]+Je[s[e+5]]+"-"+Je[s[e+6]]+Je[s[e+7]]+"-"+Je[s[e+8]]+Je[s[e+9]]+"-"+Je[s[e+10]]+Je[s[e+11]]+Je[s[e+12]]+Je[s[e+13]]+Je[s[e+14]]+Je[s[e+15]]).toLowerCase()}let ea;const lg=new Uint8Array(16);function cg(){if(!ea){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");ea=crypto.getRandomValues.bind(crypto)}return ea(lg)}const Lc={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function ug(s,e,t){s=s||{};const r=s.random??s.rng?.()??cg();if(r.length<16)throw new Error("Random bytes length must be >= 16");return r[6]=r[6]&15|64,r[8]=r[8]&63|128,ag(r)}function hg(s,e,t){return Lc.randomUUID&&!s?Lc.randomUUID():ug(s)}var Oc=(s=>(s.POINT="point",s.LINE_VERTEX="line_vertex",s.POLYGON_CENTER="polygon_center",s.LABEL="label",s.ICON="icon",s.CLUSTER="cluster",s))(Oc||{}),hr=(s=>(s.NO_COLLISION="no_collision",s.PRIORITY_LOST="priority_lost",s.OUT_OF_VIEWPORT="out_of_viewport",s.ZOOM_FILTERED="zoom_filtered",s.MANUAL_HIDDEN="manual_hidden",s.GROUP_COLLISION="group_collision",s))(hr||{}),fg=Object.defineProperty,dg=(s,e,t)=>e in s?fg(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,bn=(s,e,t)=>dg(s,typeof e!="symbol"?e+"":e,t);class pg extends cs{constructor(){super(...arguments),bn(this,"_isDragging",!1),bn(this,"_lastCoord",null),bn(this,"_boundOnMouseDown",this._onMouseDown.bind(this)),bn(this,"_boundOnMouseMove",this._onMouseMove.bind(this)),bn(this,"_boundOnMouseUp",this._onMouseUp.bind(this))}addHooks(){this.target.on("mousedown",this._boundOnMouseDown)}removeHooks(){this.target.off("mousedown",this._boundOnMouseDown),this._stopDrag()}_onMouseDown(e){const t=this.target.getMap();!t||!this.target.options.draggable||(this._isDragging=!0,this._lastCoord=e.coordinate,t.viewer.config("draggable",!1),t.on("mousemove",this._boundOnMouseMove),t.on("mouseup",this._boundOnMouseUp),this.target.trigger("dragstart",e))}_onMouseMove(e){if(!this._isDragging||!this._lastCoord||!e.coordinate)return;const t=e.coordinate,r=t[0]-this._lastCoord[0],i=t[1]-this._lastCoord[1];Math.abs(r)<1e-8&&Math.abs(i)<1e-8||(this._translate(r,i),this._lastCoord=t,this.target.trigger("dragging",e))}_onMouseUp(e){this._stopDrag(),this.target.trigger("dragend",e)}_stopDrag(){this._isDragging=!1;const e=this.target.getMap();e&&(e.viewer.config("draggable",!0),e.off("mousemove",this._boundOnMouseMove),e.off("mouseup",this._boundOnMouseUp))}_translate(e,t){const r=this.target._geometry;if(!r||!r.coordinates)return;const i=l=>Array.isArray(l[0])?l.map(i):[l[0]+e,l[1]+t],o=i(r.coordinates);r.coordinates=o,this.target._applyCoordinateChanges(!0)}}var mg=Object.defineProperty,gg=(s,e,t)=>e in s?mg(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,St=(s,e,t)=>gg(s,typeof e!="symbol"?e+"":e,t);class tt extends Zo(zr(ui(f.Object3D))){constructor(e){super(),St(this,"_worldCoordinates"),St(this,"_renderObject"),St(this,"_geometry"),St(this,"_layer"),St(this,"_style"),St(this,"_id"),St(this,"_styleQueue",[]),St(this,"_isApplyingStyle",!1),St(this,"_isGeometryInitializing",!1),St(this,"_bloomConfig"),St(this,"_collisionState",{visible:!0,reason:hr.NO_COLLISION,collidedWith:[],timestamp:Date.now()}),St(this,"_collisionConfig",{enabled:!0,priority:50,padding:4,minZoom:0,maxZoom:24}),St(this,"_animationRef",null),Go(e.geometry,"geometry","geometry must be specified"),this._geometry=e.geometry,this._worldCoordinates=new f.Vector3(0,0,0),this._renderObject=new f.Object3D,this.options={draggable:e.draggable||!1,editable:e.editable||!1},e.userData&&(this.userData=Object.assign({},JSON.parse(JSON.stringify(e.userData)))),e.style&&this.setStyle(e.style),e.id?this._id=e.id:this._id=hg(),this.addHandler("draggable",pg)}async initializeGeometry(){if(!(this._isGeometryInitializing||this._renderObject)){this._isGeometryInitializing=!0;try{await this._buildRenderObject(),this._processStyleQueue()}finally{this._isGeometryInitializing=!1}}}_refreshCoordinates(){this._buildRenderObject()}setStyle(e){const t=e instanceof xt?e:new xt(e);this._style=t;const r=JSON.parse(JSON.stringify(t.config));return this._styleQueue.push(r),this._tryProcessQueue(),this}getStyle(){return this._style}setBloom(e,t){const r=this._bloomConfig||{intensity:1,color:"#ffffff"};return this._bloomConfig={enabled:e,intensity:t?.intensity??r.intensity,color:t?.color??r.color},this._renderObject&&this._applyBloomToObject(this._renderObject),this}getBloom(){return this._bloomConfig}_applyBloomToObject(e){if(!this._bloomConfig)return;const{enabled:t,intensity:r,color:i}=this._bloomConfig;e.traverse(o=>{if(o instanceof f.Points&&o.material){const l=o.material;o.userData=o.userData||{},o.userData.__bloomBackup||(o.userData.__bloomBackup={size:l.size,sizeAttenuation:l.sizeAttenuation});const c=o.userData.__bloomBackup;t?(l.size=c.size*(1+r),l.sizeAttenuation=!1):(l.size=c.size,l.sizeAttenuation=c.sizeAttenuation),l.needsUpdate=!0;return}if(o.type==="Sprite"&&o.material){const l=o.material;o.userData=o.userData||{},o.userData.__bloomBackup||(o.userData.__bloomBackup={color:l.color?l.color.clone():null,opacity:l.opacity??1});const c=o.userData.__bloomBackup;t?(l.color&&c.color&&(l.color.copy(c.color),i&&i!=="#ffffff"&&l.color.setStyle(i),l.color.multiplyScalar(1+r*2)),l.opacity=Math.min(1,(c.opacity??1)*(1+r*.3))):(c.color&&l.color&&l.color.copy(c.color),l.opacity=c.opacity),l.needsUpdate=!0;return}if(o.isLine2&&o.material){const l=o.material;o.userData=o.userData||{},o.userData.__bloomBackup||(o.userData.__bloomBackup={color:l.color?l.color.clone():null,opacity:l.opacity??1});const c=o.userData.__bloomBackup;t?(l.color&&c.color&&(l.color.copy(c.color),i&&i!=="#ffffff"&&l.color.setStyle(i),l.color.multiplyScalar(1+r*2)),l.opacity=Math.min(1,(c.opacity??1)*(1+r*.3))):(c.color&&l.color&&l.color.copy(c.color),l.opacity=c.opacity),l.needsUpdate=!0;return}o instanceof f.Mesh&&o.material&&(Array.isArray(o.material)?o.material:[o.material]).forEach(c=>{o.userData=o.userData||{},o.userData.__bloomBackup||(o.userData.__bloomBackup={emissiveIntensity:c.emissiveIntensity??0,emissiveColor:c.emissive?c.emissive.clone():null,color:c.color?c.color.clone():null});const u=o.userData.__bloomBackup;t?"emissive"in c&&c.emissive?(c.emissiveIntensity=r,i&&i!=="#ffffff"&&c.emissive.setStyle?c.emissive.setStyle(i):u.color&&c.emissive&&c.emissive.copy(u.color)):c.color&&(u.color&&c.color.copy(u.color),i&&i!=="#ffffff"?c.color.setStyle(i):c.color.multiplyScalar(1+r*.3)):("emissiveIntensity"in c&&(c.emissiveIntensity=u.emissiveIntensity!==void 0?u.emissiveIntensity:0),u.emissiveColor&&c.emissive&&c.emissive.copy(u.emissiveColor),u.color&&c.color&&c.color.copy(u.color)),c.needsUpdate=!0})})}async _applyStyleWithRetry(e,t=3,r=100){let i=null;for(let o=1;o<=t;o++)try{this._renderObject.parent||(this.add(this._renderObject),await new Promise(c=>requestAnimationFrame(c))),await e.applyTo(this._renderObject);const l=e.config;if(l.bloom!==void 0){const c=l.bloom;typeof c=="boolean"?this._bloomConfig={enabled:c,intensity:1,color:"#ffffff"}:this._bloomConfig={enabled:c.enabled??!0,intensity:c.intensity??1,color:c.color??"#ffffff"}}this._bloomConfig&&this._renderObject&&this._applyBloomToObject(this._renderObject);return}catch(l){if(i=l,o<t){const c=r*Math.pow(2,o-1);await new Promise(u=>setTimeout(u,c))}}throw i||new Error("样式应用失败，重试次数耗尽")}async _processStyleQueue(){if(!this._renderObject||this._isApplyingStyle||this._styleQueue.length===0)return;this._isApplyingStyle=!0;const e=this._styleQueue[0];try{const t=new xt(JSON.parse(JSON.stringify(e)));await this._applyStyleWithRetry(t),this._styleQueue.shift(),this._styleQueue.length>0&&await this._processStyleQueue()}catch(t){throw t}finally{this._isApplyingStyle=!1,this._styleQueue.length>0&&this._tryProcessQueue()}}_tryProcessQueue(){this._renderObject&&!this._isApplyingStyle&&this._styleQueue.length>0?this._processStyleQueue().catch(t=>{this._isApplyingStyle=!1,this._tryProcessQueue(),console.warn(t)}):!this._renderObject&&!this._isGeometryInitializing&&this.initializeGeometry()}addTo(e){return e.addFeature(this),this}getLayer(){return this._layer||null}getMap(){return this._layer?this._layer.getMap():null}setCoordinates(e){return this._geometry.coordinates=e,this._applyCoordinateChanges(),this}_applyCoordinateChanges(e=!1){e&&this._renderObject?this._refreshCoordinates():this._buildRenderObject(),this.trigger("positionchange")}getCenter(){return this._geometry.type==="Point"?this._geometry.coordinates:[0,0]}_bindLayer(e){if(this._layer&&this._layer!==e)throw new Error("Feature cannot be added to multiple layers");this._layer=e}_updateGeometry(){this._disposeGeometry(),this._renderObject&&(this._renderObject.position.copy(this._worldCoordinates),this._renderObject?.userData?._type==="Model"?this._renderObject.renderOrder=0:this._renderObject.renderOrder=99,this.add(this._renderObject),this.updateMatrixWorld(!0),this._tryProcessQueue())}_remove(){return this.getLayer()?(this._unbind(),this):this}_unbind(){const e=this.getLayer();e&&(e.onRemoveFeature&&e.onRemoveFeature(this),delete this._layer)}_disposeGeometry(){this._renderObject&&(this.clear(),"traverse"in this&&this._renderObject.traverse(e=>{e instanceof f.Mesh?(e.geometry?.dispose(),Array.isArray(e.material)?e.material.forEach(t=>t.dispose()):e.material?.dispose()):"isLine"in e&&e.isLine&&(e.geometry?.dispose(),e.material?.dispose())}))}get collidable(){return this._collisionConfig.enabled}get collisionType(){return Oc.POINT}getCollisionPriority(){return this.userData.collisionPriority??this._style?.config.collisionPriority??this._collisionConfig.priority}getScreenBoundingBox(e,t){if(!this.collidable)return null;try{const r=new f.Vector3;this._renderObject.getWorldPosition(r);const i=r.clone().project(e);if(!(i.x>=-1.1&&i.x<=1.1&&i.y>=-1.1&&i.y<=1.1&&i.z>=-1&&i.z<=1))return null;const{width:l,height:c}=t.domElement,u=(i.x*.5+.5)*l,d=(-i.y*.5+.5)*c,m=this._calculateCollisionBoundingBox(e,t);return m?{id:this._id,x:u+m.offsetX,y:d+m.offsetY,width:20+this._collisionConfig.padding*2,height:20+this._collisionConfig.padding*2,priority:this.getCollisionPriority(),featureId:this._id,layerId:this._layer?.getId()||"unknown",type:this.collisionType,data:this.getCollisionData()}:null}catch(r){return console.warn(`Feature ${this._id} 包围盒计算失败:`,r),null}}setCollisionVisibility(e,t=hr.MANUAL_HIDDEN){this._collisionState.visible!==e&&(this._animationRef!==null&&(cancelAnimationFrame(this._animationRef),this._animationRef=null),this.visible=e,this._applyFinalAlpha(e?1:0),this._collisionState={visible:e,reason:t,collidedWith:e?[]:this._collisionState.collidedWith,timestamp:Date.now()})}getCollisionVisibility(){return this._collisionState.visible}setCollisionConfig(e){return Object.assign(this._collisionConfig,e),this}enableCollision(){return this._collisionConfig.enabled=!0,this}disableCollision(){return this._collisionConfig.enabled=!1,this.setCollisionVisibility(!0,hr.MANUAL_HIDDEN),this}_applyVisibilityAlpha(e){this.traverse(t=>{t instanceof f.Mesh&&(Array.isArray(t.material)?t.material.forEach(r=>{r.opacity!==void 0&&(r.opacity=e)}):t.material.opacity!==void 0&&(t.material.opacity=e))})}_applyFinalAlpha(e){this._applyVisibilityAlpha(e),this.traverse(t=>{t instanceof f.Mesh&&(t.material.needsUpdate=!0)})}getCollisionData(){return{featureType:this.constructor.name,userData:this.userData,styleConfig:this._style?.config}}_calculateCollisionBoundingBox(e,t){if(!this.visible||!this._renderObject||!e||!t)return null;try{const r=new f.Box3().setFromObject(this._renderObject);if(r.isEmpty())return this._getFallbackBoundingBox();const i=[new f.Vector3(r.min.x,r.min.y,r.min.z),new f.Vector3(r.max.x,r.min.y,r.min.z),new f.Vector3(r.min.x,r.max.y,r.min.z),new f.Vector3(r.max.x,r.max.y,r.min.z),new f.Vector3(r.min.x,r.min.y,r.max.z),new f.Vector3(r.max.x,r.min.y,r.max.z),new f.Vector3(r.min.x,r.max.y,r.max.z),new f.Vector3(r.max.x,r.max.y,r.max.z)],{width:o,height:l}=t.domElement,c=[];i.forEach(N=>{const X=N.clone().project(e),R=(X.x*.5+.5)*o,U=(-X.y*.5+.5)*l;c.push(new f.Vector2(R,U))});let u=1/0,d=-1/0,m=1/0,p=-1/0;c.forEach(N=>{u=Math.min(u,N.x),d=Math.max(d,N.x),m=Math.min(m,N.y),p=Math.max(p,N.y)});const _=d-u,v=p-m,S=4,M=Math.max(_,S),x=Math.max(v,S),O=new f.Vector3;r.getCenter(O);const P=O.clone().project(e),C=(P.x*.5+.5)*o,T=(-P.y*.5+.5)*l;return{width:M,height:x,offsetX:u-C,offsetY:m-T}}catch(r){return console.warn("Bounding box calculation failed 包围盒计算失败:",r),this._getFallbackBoundingBox()}}_getFallbackBoundingBox(){return{width:20,height:20,offsetX:-10,offsetY:-10}}_tileCoordToLocalWorld(e,t,r,i){const{tileZ:o,tileX:l,tileY:c,extent:u,tileSize:d}=r,m=(e/u-.5)*d,p=(.5-t/u)*d;return i.tileIDToWorldCenter(o,l,c).clone().add(new f.Vector3(m,p,0)).sub(i.prjcenter)}}var _g=Object.defineProperty,yg=(s,e,t)=>e in s?_g(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Dc=(s,e,t)=>yg(s,typeof e!="symbol"?e+"":e,t);class Nr extends us{constructor(e,t){super(e,t),Dc(this,"_feaList"),Dc(this,"_collision",!1),this._feaList=[],t?.collision&&(this._collision=!0)}addFeature(e){const t=Array.isArray(e)?e:[e];for(const r of t)if(!(!r||!(r instanceof tt))&&!r.getLayer()){if(!this.validateFeature(r)){console.error(`Feature ${r.id} does not match the layer's type requirements`);continue}r._bindLayer(this),this._feaList.push(r),r.getMap()&&r._buildRenderObject(),this._clouds&&(this.map.viewer.scene.add(this._clouds),console.log("我是云朵被添加cloud",this.map.viewer.scene)),this.add(r)}return this}getFeatures(e,t){if(!e)return this._feaList.slice(0);const r=[];let i,o;for(let l=0,c=this._feaList.length;l<c;l++)i=this._feaList[l],t?o=e.call(t,i):o=e(i),o&&r.push(i);return r}getCount(){return this._feaList.length}isEmpty(){return!this._feaList.length}removeFeature(e){if(!Array.isArray(e))return this.removeFeature([e]);for(let t=e.length-1;t>=0;t--)e[t]instanceof tt||(e[t]=this.removeFeature(e[t])),!(!e[t]||this!==e[t].getLayer())&&e[t]._remove();return this}clear(){const e=this._feaList.slice();for(const t of e)t._remove();return this}onRemoveFeature(e){if(!e)return;const t=e.getLayer();if(!t||t!==this)return;const r=this._findInList(e);r>=0&&this._feaList.splice(r,1),e.parent&&e.parent===this?this.remove(e):console.warn("Feature parent mismatch:",e.parent),this._disposeFeatureResources(e)}_findInList(e){const t=this._feaList.length;if(t===0)return-1;let r=0,i=t-1,o;for(;r<=i;){if(o=Math.floor((r+i)/2),this._feaList[o]===e)return o;r=o+1}return-1}_disposeFeatureResources(e){try{e.geometry&&e.geometry.dispose&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(t=>t.dispose?.()):e.material.dispose&&e.material.dispose()),e instanceof f.Object3D&&e.traverse(t=>{t!==e&&this._disposeFeatureResources(t)})}catch(t){console.error("Error disposing feature resources:",t)}}_mergedGeometry(){this.traverse(e=>{e.isMesh&&e.geometry&&e.material&&console.log("Merging geometry 几何体合并中",e)})}setCollisionEngine(e){return this._collisionEngine=e,this}}var vg=Object.defineProperty,wg=(s,e,t)=>e in s?vg(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ic=(s,e,t)=>wg(s,typeof e!="symbol"?e+"":e,t);class bg extends f.Group{constructor(){super(...arguments),Ic(this,"_layers",new Set),Ic(this,"_layerids",new Set)}add(...e){return e.forEach(t=>{if(!(t instanceof us))throw new Error("LayerContainer can only contain Layer instances! LayerContainer只能包含Layer实例!");const r=t.getId();if(this._layerids.has(r))throw new Error(`Layer with ID '${r}' already exists in the container! ID为'${r}'的图层已存在于容器中!`);this._layers.add(t),this._layerids.add(r),super.add(t)}),this}remove(...e){return e.forEach(t=>{this._layers.delete(t),this._layerids.delete(t.getId()),super.remove(t)}),this}getLayers(){return Array.from(this._layers)}getLayerById(e){for(const t of this._layers)if(t.getId()===e)return t}clearLayers(){return this._layers.clear(),this._layerids.clear(),super.clear(),this}}var xg=Object.defineProperty,Sg=(s,e,t)=>e in s?xg(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Mg=(s,e,t)=>Sg(s,e+"",t);class Ag{constructor(){Mg(this,"canvasDict",{})}getCanvas(e=40,t=30,r=1,i){const o=Math.ceil(e*r),l=Math.ceil(t*r),c=i?`${o}_${l}_${i}`:`${o}_${l}`;if(!this.canvasDict[c]){const m=document.createElement("canvas");m.width=o,m.height=l,this.canvasDict[c]=m}const u=this.canvasDict[c],d=u.getContext("2d");return d.setTransform(1,0,0,1,0,0),d.clearRect(0,0,u.width,u.height),d.scale(r,r),u}}function Pg(s){const e=+this._x.call(null,s),t=+this._y.call(null,s);return Fc(this.cover(e,t),e,t,s)}function Fc(s,e,t,r){if(isNaN(e)||isNaN(t))return s;var i,o=s._root,l={data:r},c=s._x0,u=s._y0,d=s._x1,m=s._y1,p,_,v,S,M,x,O,P;if(!o)return s._root=l,s;for(;o.length;)if((M=e>=(p=(c+d)/2))?c=p:d=p,(x=t>=(_=(u+m)/2))?u=_:m=_,i=o,!(o=o[O=x<<1|M]))return i[O]=l,s;if(v=+s._x.call(null,o.data),S=+s._y.call(null,o.data),e===v&&t===S)return l.next=o,i?i[O]=l:s._root=l,s;do i=i?i[O]=new Array(4):s._root=new Array(4),(M=e>=(p=(c+d)/2))?c=p:d=p,(x=t>=(_=(u+m)/2))?u=_:m=_;while((O=x<<1|M)===(P=(S>=_)<<1|v>=p));return i[P]=o,i[O]=l,s}function Cg(s){var e,t,r=s.length,i,o,l=new Array(r),c=new Array(r),u=1/0,d=1/0,m=-1/0,p=-1/0;for(t=0;t<r;++t)isNaN(i=+this._x.call(null,e=s[t]))||isNaN(o=+this._y.call(null,e))||(l[t]=i,c[t]=o,i<u&&(u=i),i>m&&(m=i),o<d&&(d=o),o>p&&(p=o));if(u>m||d>p)return this;for(this.cover(u,d).cover(m,p),t=0;t<r;++t)Fc(this,l[t],c[t],s[t]);return this}function Lg(s,e){if(isNaN(s=+s)||isNaN(e=+e))return this;var t=this._x0,r=this._y0,i=this._x1,o=this._y1;if(isNaN(t))i=(t=Math.floor(s))+1,o=(r=Math.floor(e))+1;else{for(var l=i-t||1,c=this._root,u,d;t>s||s>=i||r>e||e>=o;)switch(d=(e<r)<<1|s<t,u=new Array(4),u[d]=c,c=u,l*=2,d){case 0:i=t+l,o=r+l;break;case 1:t=i-l,o=r+l;break;case 2:i=t+l,r=o-l;break;case 3:t=i-l,r=o-l;break}this._root&&this._root.length&&(this._root=c)}return this._x0=t,this._y0=r,this._x1=i,this._y1=o,this}function Og(){var s=[];return this.visit(function(e){if(!e.length)do s.push(e.data);while(e=e.next)}),s}function Dg(s){return arguments.length?this.cover(+s[0][0],+s[0][1]).cover(+s[1][0],+s[1][1]):isNaN(this._x0)?void 0:[[this._x0,this._y0],[this._x1,this._y1]]}function ot(s,e,t,r,i){this.node=s,this.x0=e,this.y0=t,this.x1=r,this.y1=i}function Ig(s,e,t){var r,i=this._x0,o=this._y0,l,c,u,d,m=this._x1,p=this._y1,_=[],v=this._root,S,M;for(v&&_.push(new ot(v,i,o,m,p)),t==null?t=1/0:(i=s-t,o=e-t,m=s+t,p=e+t,t*=t);S=_.pop();)if(!(!(v=S.node)||(l=S.x0)>m||(c=S.y0)>p||(u=S.x1)<i||(d=S.y1)<o))if(v.length){var x=(l+u)/2,O=(c+d)/2;_.push(new ot(v[3],x,O,u,d),new ot(v[2],l,O,x,d),new ot(v[1],x,c,u,O),new ot(v[0],l,c,x,O)),(M=(e>=O)<<1|s>=x)&&(S=_[_.length-1],_[_.length-1]=_[_.length-1-M],_[_.length-1-M]=S)}else{var P=s-+this._x.call(null,v.data),C=e-+this._y.call(null,v.data),T=P*P+C*C;if(T<t){var N=Math.sqrt(t=T);i=s-N,o=e-N,m=s+N,p=e+N,r=v.data}}return r}function Fg(s){if(isNaN(m=+this._x.call(null,s))||isNaN(p=+this._y.call(null,s)))return this;var e,t=this._root,r,i,o,l=this._x0,c=this._y0,u=this._x1,d=this._y1,m,p,_,v,S,M,x,O;if(!t)return this;if(t.length)for(;;){if((S=m>=(_=(l+u)/2))?l=_:u=_,(M=p>=(v=(c+d)/2))?c=v:d=v,e=t,!(t=t[x=M<<1|S]))return this;if(!t.length)break;(e[x+1&3]||e[x+2&3]||e[x+3&3])&&(r=e,O=x)}for(;t.data!==s;)if(i=t,!(t=t.next))return this;return(o=t.next)&&delete t.next,i?(o?i.next=o:delete i.next,this):e?(o?e[x]=o:delete e[x],(t=e[0]||e[1]||e[2]||e[3])&&t===(e[3]||e[2]||e[1]||e[0])&&!t.length&&(r?r[O]=t:this._root=t),this):(this._root=o,this)}function Tg(s){for(var e=0,t=s.length;e<t;++e)this.remove(s[e]);return this}function Bg(){return this._root}function Ug(){var s=0;return this.visit(function(e){if(!e.length)do++s;while(e=e.next)}),s}function Vg(s){var e=[],t,r=this._root,i,o,l,c,u;for(r&&e.push(new ot(r,this._x0,this._y0,this._x1,this._y1));t=e.pop();)if(!s(r=t.node,o=t.x0,l=t.y0,c=t.x1,u=t.y1)&&r.length){var d=(o+c)/2,m=(l+u)/2;(i=r[3])&&e.push(new ot(i,d,m,c,u)),(i=r[2])&&e.push(new ot(i,o,m,d,u)),(i=r[1])&&e.push(new ot(i,d,l,c,m)),(i=r[0])&&e.push(new ot(i,o,l,d,m))}return this}function kg(s){var e=[],t=[],r;for(this._root&&e.push(new ot(this._root,this._x0,this._y0,this._x1,this._y1));r=e.pop();){var i=r.node;if(i.length){var o,l=r.x0,c=r.y0,u=r.x1,d=r.y1,m=(l+u)/2,p=(c+d)/2;(o=i[0])&&e.push(new ot(o,l,c,m,p)),(o=i[1])&&e.push(new ot(o,m,c,u,p)),(o=i[2])&&e.push(new ot(o,l,p,m,d)),(o=i[3])&&e.push(new ot(o,m,p,u,d))}t.push(r)}for(;r=t.pop();)s(r.node,r.x0,r.y0,r.x1,r.y1);return this}function zg(s){return s[0]}function Ng(s){return arguments.length?(this._x=s,this):this._x}function Wg(s){return s[1]}function Gg(s){return arguments.length?(this._y=s,this):this._y}function Tc(s,e,t){var r=new ta(e??zg,t??Wg,NaN,NaN,NaN,NaN);return s==null?r:r.addAll(s)}function ta(s,e,t,r,i,o){this._x=s,this._y=e,this._x0=t,this._y0=r,this._x1=i,this._y1=o,this._root=void 0}function Bc(s){for(var e={data:s.data},t=e;s=s.next;)t=t.next={data:s.data};return e}var at=Tc.prototype=ta.prototype;at.copy=function(){var s=new ta(this._x,this._y,this._x0,this._y0,this._x1,this._y1),e=this._root,t,r;if(!e)return s;if(!e.length)return s._root=Bc(e),s;for(t=[{source:e,target:s._root=new Array(4)}];e=t.pop();)for(var i=0;i<4;++i)(r=e.source[i])&&(r.length?t.push({source:r,target:e.target[i]=new Array(4)}):e.target[i]=Bc(r));return s},at.add=Pg,at.addAll=Cg,at.cover=Lg,at.data=Og,at.extent=Dg,at.find=Ig,at.remove=Fg,at.removeAll=Tg,at.root=Bg,at.size=Ug,at.visit=Vg,at.visitAfter=kg,at.x=Ng,at.y=Gg;var Rg=Object.defineProperty,jg=(s,e,t)=>e in s?Rg(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Uc=(s,e,t)=>jg(s,typeof e!="symbol"?e+"":e,t);class Vc{constructor(e){Uc(this,"_quadtree"),Uc(this,"_viewport"),this._viewport=e,this._rebuildQuadTree()}updateViewport(e){(e.width!==this._viewport.width||e.height!==this._viewport.height)&&(this._viewport=e,this._rebuildQuadTree())}addBoxes(e){e.forEach(t=>{this._isBoxInViewport(t)&&this._quadtree.add(t)})}findCollisions(e){const t=[],r=this._getSearchBounds(e);return this._quadtree.visit((i,o,l,c,u)=>this._checkNodeCollision(r,o,l,c,u)?(i.length||this._getNodeData(i).forEach(m=>{m.id!==e.id&&this._checkBoxCollision(e,m)&&t.push(m)}),!1):void 0),t}clear(){this._rebuildQuadTree()}getAllBoxes(){const e=[];return this._quadtree.visit(t=>{if(!t.length){const r=this._getNodeData(t);e.push(...r)}return!1}),e}_rebuildQuadTree(){this._quadtree=Tc().x(e=>e.x).y(e=>e.y).extent([[0,0],[this._viewport.width,this._viewport.height]])}_isBoxInViewport(e){const t=e.width/2,r=e.height/2;return e.x+t>=0&&e.x-t<=this._viewport.width&&e.y+r>=0&&e.y-r<=this._viewport.height}_getSearchBounds(e){return{x:e.x,y:e.y,width:e.width*2,height:e.height*2}}_checkNodeCollision(e,t,r,i,o){const l=(t+i)/2,c=(r+o)/2,u=i-t,d=o-r;return Math.abs(e.x-l)*2<e.width+u&&Math.abs(e.y-c)*2<e.height+d}_checkBoxCollision(e,t){return Math.abs(e.x-t.x)*2<e.width+t.width&&Math.abs(e.y-t.y)*2<e.height+t.height}_getNodeData(e){return e?Array.isArray(e.data)?e.data:e.data?[e.data]:[]:[]}removeBox(e){const r=this.getAllBoxes().filter(i=>i.id!==e);this.clear(),r.length>0&&this.addBoxes(r)}}var $g=Object.defineProperty,Xg=(s,e,t)=>e in s?$g(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,kc=(s,e,t)=>Xg(s,typeof e!="symbol"?e+"":e,t);class Yg{constructor(){kc(this,"_strategies",new Map),kc(this,"_executionOrder",[])}registerStrategy(e,t){return this._strategies.set(e.name,e),t!==void 0?this._executionOrder.splice(t,0,e.name):this._executionOrder.push(e.name),this}async executeStrategies(e,t){const r=new Map;e.forEach(i=>{r.set(i._id,{featureId:i._id,visible:!0,reason:hr.NO_COLLISION,collidedWith:[],timestamp:t.timestamp})});for(const i of this._executionOrder){const o=this._strategies.get(i);if(o?.enabled)try{const l=await o.execute(e,t,r);this._mergeResults(r,l)}catch(l){console.error(`Strategy ${i} execution failed: 策略 ${i} 执行失败:`,l)}}return r}_mergeResults(e,t){t.forEach(r=>{const i=e.get(r.featureId);i&&!i.visible||e.set(r.featureId,r)})}}var Zg=Object.defineProperty,Kg=(s,e,t)=>e in s?Zg(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,fi=(s,e,t)=>Kg(s,typeof e!="symbol"?e+"":e,t);class qg{constructor(){fi(this,"frameStats",new Map),fi(this,"summaryStats",{totalFrames:0,averageFrameTime:0,averageFPS:0,minFrameTime:1/0,maxFrameTime:0,totalFeaturesProcessed:0}),fi(this,"sampleWindowSize",60),fi(this,"currentFrameId",0),fi(this,"lastReportTime",0),fi(this,"reportInterval",5e3),fi(this,"performanceThresholds",{criticalFrameTime:33,warningFrameTime:16,idealFrameTime:8}),this.lastReportTime=Date.now()}startFrame(e){this.currentFrameId=e;const t={frameId:e,startTime:performance.now(),endTime:0,duration:0,featureCount:0,visibleCount:0,hiddenCount:0,collisionChecks:0,memoryUsage:0,strategyTimes:new Map};this.frameStats.set(e,t),this.cleanupOldFrames()}endFrame(e,t){const r=this.frameStats.get(e);if(!r)return;const i=performance.now();r.endTime=i,r.duration=i-r.startTime,t&&Object.assign(r,t),"memory"in performance&&(r.memoryUsage=performance.memory.usedJSHeapSize),this.updateSummaryStats(r),this.maybeOutputReport()}recordStrategyTime(e,t){const r=this.frameStats.get(this.currentFrameId);r&&r.strategyTimes.set(e,t)}recordCollisionChecks(e){const t=this.frameStats.get(this.currentFrameId);t&&(t.collisionChecks+=e)}getStats(){const e=this.getRecentFrames(this.sampleWindowSize),t=this.calculateFPS(e),r=this.calculateAverageFrameTime(e);return{summary:{...this.summaryStats},recent:{fps:t,frameTime:r,frameTimeStdDev:this.calculateFrameTimeStdDev(e),averageFeaturesPerFrame:this.calculateAverageFeatures(e),performanceLevel:this.getPerformanceLevel(r)},currentFrame:this.frameStats.get(this.currentFrameId)||null,strategies:this.getStrategyPerformance(e),warnings:this.getPerformanceWarnings(e)}}getDetailedReport(){const e=this.getRecentFrames(this.sampleWindowSize),t=this.getStats();return{...t,frameHistory:Array.from(e.values()),trends:this.calculateTrends(e),recommendations:this.getPerformanceRecommendations(t)}}reset(){this.frameStats.clear(),this.summaryStats={totalFrames:0,averageFrameTime:0,averageFPS:0,minFrameTime:1/0,maxFrameTime:0,totalFeaturesProcessed:0},this.currentFrameId=0,this.lastReportTime=Date.now()}cleanupOldFrames(){this.frameStats.size>this.sampleWindowSize*2&&Array.from(this.frameStats.keys()).sort((t,r)=>t-r).slice(0,this.frameStats.size-this.sampleWindowSize).forEach(t=>{this.frameStats.delete(t)})}updateSummaryStats(e){this.summaryStats.totalFrames++,this.summaryStats.totalFeaturesProcessed+=e.featureCount||0,this.summaryStats.averageFrameTime=(this.summaryStats.averageFrameTime*(this.summaryStats.totalFrames-1)+e.duration)/this.summaryStats.totalFrames,this.summaryStats.minFrameTime=Math.min(this.summaryStats.minFrameTime,e.duration),this.summaryStats.maxFrameTime=Math.max(this.summaryStats.maxFrameTime,e.duration),this.summaryStats.averageFPS=1e3/this.summaryStats.averageFrameTime}maybeOutputReport(){const e=Date.now();if(e-this.lastReportTime>=this.reportInterval){const t=this.getStats();t.warnings.length>0?console.warn("避让系统性能报告:",t):console.log("避让系统性能正常:",t),this.lastReportTime=e}}getRecentFrames(e){return Array.from(this.frameStats.values()).slice(-e).filter(r=>r.duration>0)}calculateFPS(e){if(e.length===0)return 0;const t=this.calculateAverageFrameTime(e);return t>0?1e3/t:0}calculateAverageFrameTime(e){return e.length===0?0:e.reduce((t,r)=>t+r.duration,0)/e.length}calculateFrameTimeStdDev(e){if(e.length===0)return 0;const t=this.calculateAverageFrameTime(e),r=e.map(i=>Math.pow(i.duration-t,2));return Math.sqrt(r.reduce((i,o)=>i+o,0)/e.length)}calculateAverageFeatures(e){return e.length===0?0:e.reduce((t,r)=>t+(r.featureCount||0),0)/e.length}getPerformanceLevel(e){return e>this.performanceThresholds.criticalFrameTime?"critical":e>this.performanceThresholds.warningFrameTime?"warning":e>this.performanceThresholds.idealFrameTime?"good":"excellent"}getStrategyPerformance(e){const t=new Map;return e.forEach(r=>{r.strategyTimes.forEach((i,o)=>{t.has(o)||t.set(o,[]),t.get(o).push(i)})}),Array.from(t.entries()).map(([r,i])=>({name:r,averageTime:i.reduce((o,l)=>o+l,0)/i.length,maxTime:Math.max(...i),minTime:Math.min(...i),callCount:i.length}))}getPerformanceWarnings(e){const t=[],r=e.slice(-30);if(r.length===0)return t;const i=this.calculateAverageFrameTime(r);i>this.performanceThresholds.criticalFrameTime?t.push({type:"critical",message:`帧率过低: ${Math.round(1e3/i)}fps`,suggestion:"考虑减少要素数量或简化避让策略"}):i>this.performanceThresholds.warningFrameTime&&t.push({type:"warning",message:`帧率较低: ${Math.round(1e3/i)}fps`,suggestion:"建议优化避让算法或增加更新间隔"});const o=r.map(l=>l.memoryUsage).filter(l=>l>0);if(o.length>0){const l=o.reduce((c,u)=>c+u,0)/o.length;l>100*1024*1024&&t.push({type:"warning",message:`内存使用较高: ${(l/1024/1024).toFixed(1)}MB`,suggestion:"检查内存泄漏，及时清理无用资源"})}return t}calculateTrends(e){if(e.length<2)return{frameTime:"stable",fps:"stable",features:"stable"};const t=e.slice(0,Math.floor(e.length/2)),r=e.slice(Math.floor(e.length/2)),i=this.calculateAverageFrameTime(t),l=(this.calculateAverageFrameTime(r)-i)/i*100;return{frameTime:Math.abs(l)<5?"stable":l>0?"worsening":"improving",fps:Math.abs(l)<5?"stable":l>0?"improving":"worsening",features:"stable"}}getPerformanceRecommendations(e){const t=[];return e.recent.performanceLevel==="critical"&&(t.push("建议启用要素抽样或聚合显示"),t.push("考虑增加避让更新间隔时间"),t.push("检查是否有不必要的避让策略")),e.recent.averageFeaturesPerFrame>5e3&&t.push("要素数量过多，建议启用LOD分级"),e.strategies.forEach(r=>{r.averageTime>10&&t.push(`策略 "${r.name}" 执行时间较长，考虑优化`)}),t}}var Qg=Object.defineProperty,Jg=(s,e,t)=>e in s?Qg(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ds=(s,e,t)=>Jg(s,typeof e!="symbol"?e+"":e,t);class Eg{constructor(){ds(this,"name","priority"),ds(this,"enabled",!0),ds(this,"weight",1),ds(this,"description","Priority-based avoidance strategy, smaller value means higher priority 基于优先级的避让策略，数值越小优先级越高")}async execute(e,t,r){const i=[],o=new Vc(t.viewport),l=[],c=new Map;return e.forEach(u=>{if(!u.collidable)return;const d=u.getScreenBoundingBox(t.camera,t.renderer);d&&(l.push(d),c.set(u._id,u),r?.get(u._id)?.visible)}),l.sort((u,d)=>u.priority-d.priority),l.forEach(u=>{const d=o.findCollisions(u);d.length===0?(o.addBoxes([u]),i.push({featureId:u.featureId,visible:!0,reason:hr.NO_COLLISION,collidedWith:[],timestamp:t.timestamp})):d.some(p=>p.priority<u.priority)?i.push({featureId:u.featureId,visible:!1,reason:hr.PRIORITY_LOST,collidedWith:d.map(p=>p.featureId),timestamp:t.timestamp}):(o.addBoxes([u]),i.push({featureId:u.featureId,visible:!0,reason:hr.NO_COLLISION,collidedWith:[],timestamp:t.timestamp}),d.forEach(p=>{i.push({featureId:p.featureId,visible:!1,reason:hr.PRIORITY_LOST,collidedWith:[u.featureId],timestamp:t.timestamp})}))}),i}}var Hg=Object.defineProperty,e_=(s,e,t)=>e in s?Hg(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Wr=(s,e,t)=>e_(s,typeof e!="symbol"?e+"":e,t);class t_{constructor(e,t={}){this.renderer=e,Wr(this,"_quadTreeManager"),Wr(this,"_strategyOrchestrator"),Wr(this,"_performanceMonitor"),Wr(this,"_layers",new Set),Wr(this,"_config"),Wr(this,"_isUpdating",!1),Wr(this,"_lastUpdateTime",0),Wr(this,"_frameCount",0),this._config={enabled:!0,padding:4,updateInterval:0,animationDuration:300,maxFeaturesPerFrame:2e3,viewportMargin:50,strategies:{priority:!0,grouping:!1,proximity:!1},...t},this._initializeComponents(),this._setupPerformanceMonitoring()}async update(e){if(!this._config.enabled||this._isUpdating)return;const t=Date.now();if(!(this._config.updateInterval>0&&t-this._lastUpdateTime<this._config.updateInterval)){this._isUpdating=!0,this._frameCount++;try{this._resetAllFeaturesVisibility();const r=this._createCollisionContext(e,t),i=this._collectCollidableFeatures();if(i.length===0)return;this._performanceMonitor.startFrame(this._frameCount);const o=await this._strategyOrchestrator.executeStrategies(i,r);await this._applyCollisionResults(o,i),this._performanceMonitor.endFrame(this._frameCount,{featureCount:i.length,visibleCount:Array.from(o.values()).filter(l=>l.visible).length,hiddenCount:Array.from(o.values()).filter(l=>!l.visible).length}),this._lastUpdateTime=t}catch(r){console.error("避让引擎更新失败:",r)}finally{this._isUpdating=!1}}}_resetAllFeaturesVisibility(){this._layers.forEach(e=>{e.getFeatures().filter(r=>r.collidable).forEach(r=>{r.setCollisionVisibility(!0,hr.NO_COLLISION)})})}registerLayer(e){return this._layers.add(e),this}unregisterLayer(e){return this._layers.delete(e),this}setConfig(e){return Object.assign(this._config,e),this}getPerformanceStats(){return this._performanceMonitor.getStats()}_initializeComponents(){const e={width:this.renderer.domElement.width,height:this.renderer.domElement.height};this._quadTreeManager=new Vc(e),this._strategyOrchestrator=new Yg,this._performanceMonitor=new qg,this._strategyOrchestrator.registerStrategy(new Eg,0),this._setupViewportResizeHandler()}_createCollisionContext(e,t){return{camera:e,renderer:this.renderer,viewport:{width:this.renderer.domElement.width,height:this.renderer.domElement.height},zoomLevel:e.position.z,timestamp:t,frameNumber:this._frameCount}}_collectCollidableFeatures(){const e=[];return this._layers.forEach(t=>{const r=t.getFeatures().filter(i=>i.collidable&&i instanceof tt);if(e.length+r.length>this._config.maxFeaturesPerFrame){console.warn(`达到每帧最大要素处理限制: ${this._config.maxFeaturesPerFrame}`);return}e.push(...r)}),e}async _applyCollisionResults(e,t){const r=t.map(i=>{const o=e.get(i._id);return o&&i.setCollisionVisibility(o.visible,o.reason),Promise.resolve()});await Promise.all(r)}_setupViewportResizeHandler(){new ResizeObserver(t=>{t.forEach(r=>{const{width:i,height:o}=r.contentRect;this._quadTreeManager.updateViewport({width:i,height:o})})}).observe(this.renderer.domElement)}_setupPerformanceMonitoring(){setInterval(()=>{const e=this.getPerformanceStats();e.frameRate<30&&console.warn("避让系统性能警告:",e)},5e3)}}var ps=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},xn={exports:{}};var r_=xn.exports,zc;function i_(){return zc||(zc=1,(function(s,e){(function(){var t,r="4.17.21",i=200,o="Unsupported core-js use. Try https://npms.io/search?q=ponyfill.",l="Expected a function",c="Invalid `variable` option passed into `_.template`",u="__lodash_hash_undefined__",d=500,m="__lodash_placeholder__",p=1,_=2,v=4,S=1,M=2,x=1,O=2,P=4,C=8,T=16,N=32,X=64,R=128,U=256,$=512,z=30,V="...",Y=800,Q=16,K=1,te=2,H=3,Pe=1/0,ve=9007199254740991,we=17976931348623157e292,me=NaN,Ce=4294967295,Le=Ce-1,Oe=Ce>>>1,lt=[["ary",R],["bind",x],["bindKey",O],["curry",C],["curryRight",T],["flip",$],["partial",N],["partialRight",X],["rearg",U]],ct="[object Arguments]",Vt="[object Array]",Jt="[object AsyncFunction]",gt="[object Boolean]",Et="[object Date]",ji="[object DOMException]",xr="[object Error]",Ht="[object Function]",Sr="[object GeneratorFunction]",Ge="[object Map]",At="[object Number]",mi="[object Null]",_t="[object Object]",gi="[object Promise]",$i="[object Proxy]",_i="[object RegExp]",Pt="[object Set]",Xr="[object String]",Yr="[object Symbol]",yi="[object Undefined]",vi="[object WeakMap]",ma="[object WeakSet]",Zr="[object ArrayBuffer]",pr="[object DataView]",Fn="[object Float32Array]",Tn="[object Float64Array]",Xi="[object Int8Array]",Bn="[object Int16Array]",Un="[object Int32Array]",Yi="[object Uint8Array]",wi="[object Uint8ClampedArray]",F="[object Uint16Array]",Z="[object Uint32Array]",oe=/\b__p \+= '';/g,ye=/\b(__p \+=) '' \+/g,Re=/(__e\(.*?\)|\b__t\)) \+\n'';/g,kt=/&(?:amp|lt|gt|quot|#39);/g,er=/[&<>"']/g,Cu=RegExp(kt.source),Ls=RegExp(er.source),tr=/<%-([\s\S]+?)%>/g,rr=/<%([\s\S]+?)%>/g,Kr=/<%=([\s\S]+?)%>/g,bi=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,xi=/^\w*$/,Zi=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,ga=/[\\^$.*+?()[\]{}|]/g,Pv=RegExp(ga.source),_a=/^\s+/,Cv=/\s/,Lv=/\{(?:\n\/\* \[wrapped with .+\] \*\/)?\n?/,Ov=/\{\n\/\* \[wrapped with (.+)\] \*/,Dv=/,? & /,Iv=/[^\x00-\x2f\x3a-\x40\x5b-\x60\x7b-\x7f]+/g,Fv=/[()=,{}\[\]\/\s]/,Tv=/\\(\\)?/g,Bv=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g,Lu=/\w*$/,Uv=/^[-+]0x[0-9a-f]+$/i,Vv=/^0b[01]+$/i,kv=/^\[object .+?Constructor\]$/,zv=/^0o[0-7]+$/i,Nv=/^(?:0|[1-9]\d*)$/,Wv=/[\xc0-\xd6\xd8-\xf6\xf8-\xff\u0100-\u017f]/g,Os=/($^)/,Gv=/['\n\r\u2028\u2029\\]/g,Ds="\\ud800-\\udfff",Rv="\\u0300-\\u036f",jv="\\ufe20-\\ufe2f",$v="\\u20d0-\\u20ff",Ou=Rv+jv+$v,Du="\\u2700-\\u27bf",Iu="a-z\\xdf-\\xf6\\xf8-\\xff",Xv="\\xac\\xb1\\xd7\\xf7",Yv="\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf",Zv="\\u2000-\\u206f",Kv=" \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000",Fu="A-Z\\xc0-\\xd6\\xd8-\\xde",Tu="\\ufe0e\\ufe0f",Bu=Xv+Yv+Zv+Kv,ya="['’]",qv="["+Ds+"]",Uu="["+Bu+"]",Is="["+Ou+"]",Vu="\\d+",Qv="["+Du+"]",ku="["+Iu+"]",zu="[^"+Ds+Bu+Vu+Du+Iu+Fu+"]",va="\\ud83c[\\udffb-\\udfff]",Jv="(?:"+Is+"|"+va+")",Nu="[^"+Ds+"]",wa="(?:\\ud83c[\\udde6-\\uddff]){2}",ba="[\\ud800-\\udbff][\\udc00-\\udfff]",Ki="["+Fu+"]",Wu="\\u200d",Gu="(?:"+ku+"|"+zu+")",Ev="(?:"+Ki+"|"+zu+")",Ru="(?:"+ya+"(?:d|ll|m|re|s|t|ve))?",ju="(?:"+ya+"(?:D|LL|M|RE|S|T|VE))?",$u=Jv+"?",Xu="["+Tu+"]?",Hv="(?:"+Wu+"(?:"+[Nu,wa,ba].join("|")+")"+Xu+$u+")*",ew="\\d*(?:1st|2nd|3rd|(?![123])\\dth)(?=\\b|[A-Z_])",tw="\\d*(?:1ST|2ND|3RD|(?![123])\\dTH)(?=\\b|[a-z_])",Yu=Xu+$u+Hv,rw="(?:"+[Qv,wa,ba].join("|")+")"+Yu,iw="(?:"+[Nu+Is+"?",Is,wa,ba,qv].join("|")+")",nw=RegExp(ya,"g"),sw=RegExp(Is,"g"),xa=RegExp(va+"(?="+va+")|"+iw+Yu,"g"),ow=RegExp([Ki+"?"+ku+"+"+Ru+"(?="+[Uu,Ki,"$"].join("|")+")",Ev+"+"+ju+"(?="+[Uu,Ki+Gu,"$"].join("|")+")",Ki+"?"+Gu+"+"+Ru,Ki+"+"+ju,tw,ew,Vu,rw].join("|"),"g"),aw=RegExp("["+Wu+Ds+Ou+Tu+"]"),lw=/[a-z][A-Z]|[A-Z]{2}[a-z]|[0-9][a-zA-Z]|[a-zA-Z][0-9]|[^a-zA-Z0-9 ]/,cw=["Array","Buffer","DataView","Date","Error","Float32Array","Float64Array","Function","Int8Array","Int16Array","Int32Array","Map","Math","Object","Promise","RegExp","Set","String","Symbol","TypeError","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","WeakMap","_","clearTimeout","isFinite","parseInt","setTimeout"],uw=-1,Fe={};Fe[Fn]=Fe[Tn]=Fe[Xi]=Fe[Bn]=Fe[Un]=Fe[Yi]=Fe[wi]=Fe[F]=Fe[Z]=!0,Fe[ct]=Fe[Vt]=Fe[Zr]=Fe[gt]=Fe[pr]=Fe[Et]=Fe[xr]=Fe[Ht]=Fe[Ge]=Fe[At]=Fe[_t]=Fe[_i]=Fe[Pt]=Fe[Xr]=Fe[vi]=!1;var De={};De[ct]=De[Vt]=De[Zr]=De[pr]=De[gt]=De[Et]=De[Fn]=De[Tn]=De[Xi]=De[Bn]=De[Un]=De[Ge]=De[At]=De[_t]=De[_i]=De[Pt]=De[Xr]=De[Yr]=De[Yi]=De[wi]=De[F]=De[Z]=!0,De[xr]=De[Ht]=De[vi]=!1;var hw={À:"A",Á:"A",Â:"A",Ã:"A",Ä:"A",Å:"A",à:"a",á:"a",â:"a",ã:"a",ä:"a",å:"a",Ç:"C",ç:"c",Ð:"D",ð:"d",È:"E",É:"E",Ê:"E",Ë:"E",è:"e",é:"e",ê:"e",ë:"e",Ì:"I",Í:"I",Î:"I",Ï:"I",ì:"i",í:"i",î:"i",ï:"i",Ñ:"N",ñ:"n",Ò:"O",Ó:"O",Ô:"O",Õ:"O",Ö:"O",Ø:"O",ò:"o",ó:"o",ô:"o",õ:"o",ö:"o",ø:"o",Ù:"U",Ú:"U",Û:"U",Ü:"U",ù:"u",ú:"u",û:"u",ü:"u",Ý:"Y",ý:"y",ÿ:"y",Æ:"Ae",æ:"ae",Þ:"Th",þ:"th",ß:"ss",Ā:"A",Ă:"A",Ą:"A",ā:"a",ă:"a",ą:"a",Ć:"C",Ĉ:"C",Ċ:"C",Č:"C",ć:"c",ĉ:"c",ċ:"c",č:"c",Ď:"D",Đ:"D",ď:"d",đ:"d",Ē:"E",Ĕ:"E",Ė:"E",Ę:"E",Ě:"E",ē:"e",ĕ:"e",ė:"e",ę:"e",ě:"e",Ĝ:"G",Ğ:"G",Ġ:"G",Ģ:"G",ĝ:"g",ğ:"g",ġ:"g",ģ:"g",Ĥ:"H",Ħ:"H",ĥ:"h",ħ:"h",Ĩ:"I",Ī:"I",Ĭ:"I",Į:"I",İ:"I",ĩ:"i",ī:"i",ĭ:"i",į:"i",ı:"i",Ĵ:"J",ĵ:"j",Ķ:"K",ķ:"k",ĸ:"k",Ĺ:"L",Ļ:"L",Ľ:"L",Ŀ:"L",Ł:"L",ĺ:"l",ļ:"l",ľ:"l",ŀ:"l",ł:"l",Ń:"N",Ņ:"N",Ň:"N",Ŋ:"N",ń:"n",ņ:"n",ň:"n",ŋ:"n",Ō:"O",Ŏ:"O",Ő:"O",ō:"o",ŏ:"o",ő:"o",Ŕ:"R",Ŗ:"R",Ř:"R",ŕ:"r",ŗ:"r",ř:"r",Ś:"S",Ŝ:"S",Ş:"S",Š:"S",ś:"s",ŝ:"s",ş:"s",š:"s",Ţ:"T",Ť:"T",Ŧ:"T",ţ:"t",ť:"t",ŧ:"t",Ũ:"U",Ū:"U",Ŭ:"U",Ů:"U",Ű:"U",Ų:"U",ũ:"u",ū:"u",ŭ:"u",ů:"u",ű:"u",ų:"u",Ŵ:"W",ŵ:"w",Ŷ:"Y",ŷ:"y",Ÿ:"Y",Ź:"Z",Ż:"Z",Ž:"Z",ź:"z",ż:"z",ž:"z",Ĳ:"IJ",ĳ:"ij",Œ:"Oe",œ:"oe",ŉ:"'n",ſ:"s"},fw={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},dw={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"},pw={"\\":"\\","'":"'","\n":"n","\r":"r","\u2028":"u2028","\u2029":"u2029"},mw=parseFloat,gw=parseInt,Zu=typeof ps=="object"&&ps&&ps.Object===Object&&ps,_w=typeof self=="object"&&self&&self.Object===Object&&self,Ee=Zu||_w||Function("return this")(),Sa=e&&!e.nodeType&&e,Si=Sa&&!0&&s&&!s.nodeType&&s,Ku=Si&&Si.exports===Sa,Ma=Ku&&Zu.process,zt=(function(){try{var D=Si&&Si.require&&Si.require("util").types;return D||Ma&&Ma.binding&&Ma.binding("util")}catch{}})(),qu=zt&&zt.isArrayBuffer,Qu=zt&&zt.isDate,Ju=zt&&zt.isMap,Eu=zt&&zt.isRegExp,Hu=zt&&zt.isSet,eh=zt&&zt.isTypedArray;function Ct(D,k,B){switch(B.length){case 0:return D.call(k);case 1:return D.call(k,B[0]);case 2:return D.call(k,B[0],B[1]);case 3:return D.call(k,B[0],B[1],B[2])}return D.apply(k,B)}function yw(D,k,B,E){for(var ae=-1,be=D==null?0:D.length;++ae<be;){var je=D[ae];k(E,je,B(je),D)}return E}function Nt(D,k){for(var B=-1,E=D==null?0:D.length;++B<E&&k(D[B],B,D)!==!1;);return D}function vw(D,k){for(var B=D==null?0:D.length;B--&&k(D[B],B,D)!==!1;);return D}function th(D,k){for(var B=-1,E=D==null?0:D.length;++B<E;)if(!k(D[B],B,D))return!1;return!0}function qr(D,k){for(var B=-1,E=D==null?0:D.length,ae=0,be=[];++B<E;){var je=D[B];k(je,B,D)&&(be[ae++]=je)}return be}function Fs(D,k){var B=D==null?0:D.length;return!!B&&qi(D,k,0)>-1}function Aa(D,k,B){for(var E=-1,ae=D==null?0:D.length;++E<ae;)if(B(k,D[E]))return!0;return!1}function Be(D,k){for(var B=-1,E=D==null?0:D.length,ae=Array(E);++B<E;)ae[B]=k(D[B],B,D);return ae}function Qr(D,k){for(var B=-1,E=k.length,ae=D.length;++B<E;)D[ae+B]=k[B];return D}function Pa(D,k,B,E){var ae=-1,be=D==null?0:D.length;for(E&&be&&(B=D[++ae]);++ae<be;)B=k(B,D[ae],ae,D);return B}function ww(D,k,B,E){var ae=D==null?0:D.length;for(E&&ae&&(B=D[--ae]);ae--;)B=k(B,D[ae],ae,D);return B}function Ca(D,k){for(var B=-1,E=D==null?0:D.length;++B<E;)if(k(D[B],B,D))return!0;return!1}var bw=La("length");function xw(D){return D.split("")}function Sw(D){return D.match(Iv)||[]}function rh(D,k,B){var E;return B(D,function(ae,be,je){if(k(ae,be,je))return E=be,!1}),E}function Ts(D,k,B,E){for(var ae=D.length,be=B+(E?1:-1);E?be--:++be<ae;)if(k(D[be],be,D))return be;return-1}function qi(D,k,B){return k===k?Uw(D,k,B):Ts(D,ih,B)}function Mw(D,k,B,E){for(var ae=B-1,be=D.length;++ae<be;)if(E(D[ae],k))return ae;return-1}function ih(D){return D!==D}function nh(D,k){var B=D==null?0:D.length;return B?Da(D,k)/B:me}function La(D){return function(k){return k==null?t:k[D]}}function Oa(D){return function(k){return D==null?t:D[k]}}function sh(D,k,B,E,ae){return ae(D,function(be,je,Ae){B=E?(E=!1,be):k(B,be,je,Ae)}),B}function Aw(D,k){var B=D.length;for(D.sort(k);B--;)D[B]=D[B].value;return D}function Da(D,k){for(var B,E=-1,ae=D.length;++E<ae;){var be=k(D[E]);be!==t&&(B=B===t?be:B+be)}return B}function Ia(D,k){for(var B=-1,E=Array(D);++B<D;)E[B]=k(B);return E}function Pw(D,k){return Be(k,function(B){return[B,D[B]]})}function oh(D){return D&&D.slice(0,uh(D)+1).replace(_a,"")}function Lt(D){return function(k){return D(k)}}function Fa(D,k){return Be(k,function(B){return D[B]})}function Vn(D,k){return D.has(k)}function ah(D,k){for(var B=-1,E=D.length;++B<E&&qi(k,D[B],0)>-1;);return B}function lh(D,k){for(var B=D.length;B--&&qi(k,D[B],0)>-1;);return B}function Cw(D,k){for(var B=D.length,E=0;B--;)D[B]===k&&++E;return E}var Lw=Oa(hw),Ow=Oa(fw);function Dw(D){return"\\"+pw[D]}function Iw(D,k){return D==null?t:D[k]}function Qi(D){return aw.test(D)}function Fw(D){return lw.test(D)}function Tw(D){for(var k,B=[];!(k=D.next()).done;)B.push(k.value);return B}function Ta(D){var k=-1,B=Array(D.size);return D.forEach(function(E,ae){B[++k]=[ae,E]}),B}function ch(D,k){return function(B){return D(k(B))}}function Jr(D,k){for(var B=-1,E=D.length,ae=0,be=[];++B<E;){var je=D[B];(je===k||je===m)&&(D[B]=m,be[ae++]=B)}return be}function Bs(D){var k=-1,B=Array(D.size);return D.forEach(function(E){B[++k]=E}),B}function Bw(D){var k=-1,B=Array(D.size);return D.forEach(function(E){B[++k]=[E,E]}),B}function Uw(D,k,B){for(var E=B-1,ae=D.length;++E<ae;)if(D[E]===k)return E;return-1}function Vw(D,k,B){for(var E=B+1;E--;)if(D[E]===k)return E;return E}function Ji(D){return Qi(D)?zw(D):bw(D)}function ir(D){return Qi(D)?Nw(D):xw(D)}function uh(D){for(var k=D.length;k--&&Cv.test(D.charAt(k)););return k}var kw=Oa(dw);function zw(D){for(var k=xa.lastIndex=0;xa.test(D);)++k;return k}function Nw(D){return D.match(xa)||[]}function Ww(D){return D.match(ow)||[]}var Gw=(function D(k){k=k==null?Ee:Ei.defaults(Ee.Object(),k,Ei.pick(Ee,cw));var B=k.Array,E=k.Date,ae=k.Error,be=k.Function,je=k.Math,Ae=k.Object,Ba=k.RegExp,Rw=k.String,Wt=k.TypeError,Us=B.prototype,jw=be.prototype,Hi=Ae.prototype,Vs=k["__core-js_shared__"],ks=jw.toString,Se=Hi.hasOwnProperty,$w=0,hh=(function(){var n=/[^.]+$/.exec(Vs&&Vs.keys&&Vs.keys.IE_PROTO||"");return n?"Symbol(src)_1."+n:""})(),zs=Hi.toString,Xw=ks.call(Ae),Yw=Ee._,Zw=Ba("^"+ks.call(Se).replace(ga,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),Ns=Ku?k.Buffer:t,Er=k.Symbol,Ws=k.Uint8Array,fh=Ns?Ns.allocUnsafe:t,Gs=ch(Ae.getPrototypeOf,Ae),dh=Ae.create,ph=Hi.propertyIsEnumerable,Rs=Us.splice,mh=Er?Er.isConcatSpreadable:t,kn=Er?Er.iterator:t,Mi=Er?Er.toStringTag:t,js=(function(){try{var n=Oi(Ae,"defineProperty");return n({},"",{}),n}catch{}})(),Kw=k.clearTimeout!==Ee.clearTimeout&&k.clearTimeout,qw=E&&E.now!==Ee.Date.now&&E.now,Qw=k.setTimeout!==Ee.setTimeout&&k.setTimeout,$s=je.ceil,Xs=je.floor,Ua=Ae.getOwnPropertySymbols,Jw=Ns?Ns.isBuffer:t,gh=k.isFinite,Ew=Us.join,Hw=ch(Ae.keys,Ae),$e=je.max,nt=je.min,eb=E.now,tb=k.parseInt,_h=je.random,rb=Us.reverse,Va=Oi(k,"DataView"),zn=Oi(k,"Map"),ka=Oi(k,"Promise"),en=Oi(k,"Set"),Nn=Oi(k,"WeakMap"),Wn=Oi(Ae,"create"),Ys=Nn&&new Nn,tn={},ib=Di(Va),nb=Di(zn),sb=Di(ka),ob=Di(en),ab=Di(Nn),Zs=Er?Er.prototype:t,Gn=Zs?Zs.valueOf:t,yh=Zs?Zs.toString:t;function w(n){if(ke(n)&&!le(n)&&!(n instanceof ge)){if(n instanceof Gt)return n;if(Se.call(n,"__wrapped__"))return wf(n)}return new Gt(n)}var rn=(function(){function n(){}return function(a){if(!Ue(a))return{};if(dh)return dh(a);n.prototype=a;var h=new n;return n.prototype=t,h}})();function Ks(){}function Gt(n,a){this.__wrapped__=n,this.__actions__=[],this.__chain__=!!a,this.__index__=0,this.__values__=t}w.templateSettings={escape:tr,evaluate:rr,interpolate:Kr,variable:"",imports:{_:w}},w.prototype=Ks.prototype,w.prototype.constructor=w,Gt.prototype=rn(Ks.prototype),Gt.prototype.constructor=Gt;function ge(n){this.__wrapped__=n,this.__actions__=[],this.__dir__=1,this.__filtered__=!1,this.__iteratees__=[],this.__takeCount__=Ce,this.__views__=[]}function lb(){var n=new ge(this.__wrapped__);return n.__actions__=yt(this.__actions__),n.__dir__=this.__dir__,n.__filtered__=this.__filtered__,n.__iteratees__=yt(this.__iteratees__),n.__takeCount__=this.__takeCount__,n.__views__=yt(this.__views__),n}function cb(){if(this.__filtered__){var n=new ge(this);n.__dir__=-1,n.__filtered__=!0}else n=this.clone(),n.__dir__*=-1;return n}function ub(){var n=this.__wrapped__.value(),a=this.__dir__,h=le(n),g=a<0,y=h?n.length:0,b=x1(0,y,this.__views__),A=b.start,L=b.end,I=L-A,W=g?L:A-1,G=this.__iteratees__,j=G.length,q=0,ee=nt(I,this.__takeCount__);if(!h||!g&&y==I&&ee==I)return Rh(n,this.__actions__);var ne=[];e:for(;I--&&q<ee;){W+=a;for(var ue=-1,se=n[W];++ue<j;){var pe=G[ue],_e=pe.iteratee,It=pe.type,ft=_e(se);if(It==te)se=ft;else if(!ft){if(It==K)continue e;break e}}ne[q++]=se}return ne}ge.prototype=rn(Ks.prototype),ge.prototype.constructor=ge;function Ai(n){var a=-1,h=n==null?0:n.length;for(this.clear();++a<h;){var g=n[a];this.set(g[0],g[1])}}function hb(){this.__data__=Wn?Wn(null):{},this.size=0}function fb(n){var a=this.has(n)&&delete this.__data__[n];return this.size-=a?1:0,a}function db(n){var a=this.__data__;if(Wn){var h=a[n];return h===u?t:h}return Se.call(a,n)?a[n]:t}function pb(n){var a=this.__data__;return Wn?a[n]!==t:Se.call(a,n)}function mb(n,a){var h=this.__data__;return this.size+=this.has(n)?0:1,h[n]=Wn&&a===t?u:a,this}Ai.prototype.clear=hb,Ai.prototype.delete=fb,Ai.prototype.get=db,Ai.prototype.has=pb,Ai.prototype.set=mb;function Mr(n){var a=-1,h=n==null?0:n.length;for(this.clear();++a<h;){var g=n[a];this.set(g[0],g[1])}}function gb(){this.__data__=[],this.size=0}function _b(n){var a=this.__data__,h=qs(a,n);if(h<0)return!1;var g=a.length-1;return h==g?a.pop():Rs.call(a,h,1),--this.size,!0}function yb(n){var a=this.__data__,h=qs(a,n);return h<0?t:a[h][1]}function vb(n){return qs(this.__data__,n)>-1}function wb(n,a){var h=this.__data__,g=qs(h,n);return g<0?(++this.size,h.push([n,a])):h[g][1]=a,this}Mr.prototype.clear=gb,Mr.prototype.delete=_b,Mr.prototype.get=yb,Mr.prototype.has=vb,Mr.prototype.set=wb;function Ar(n){var a=-1,h=n==null?0:n.length;for(this.clear();++a<h;){var g=n[a];this.set(g[0],g[1])}}function bb(){this.size=0,this.__data__={hash:new Ai,map:new(zn||Mr),string:new Ai}}function xb(n){var a=ao(this,n).delete(n);return this.size-=a?1:0,a}function Sb(n){return ao(this,n).get(n)}function Mb(n){return ao(this,n).has(n)}function Ab(n,a){var h=ao(this,n),g=h.size;return h.set(n,a),this.size+=h.size==g?0:1,this}Ar.prototype.clear=bb,Ar.prototype.delete=xb,Ar.prototype.get=Sb,Ar.prototype.has=Mb,Ar.prototype.set=Ab;function Pi(n){var a=-1,h=n==null?0:n.length;for(this.__data__=new Ar;++a<h;)this.add(n[a])}function Pb(n){return this.__data__.set(n,u),this}function Cb(n){return this.__data__.has(n)}Pi.prototype.add=Pi.prototype.push=Pb,Pi.prototype.has=Cb;function nr(n){var a=this.__data__=new Mr(n);this.size=a.size}function Lb(){this.__data__=new Mr,this.size=0}function Ob(n){var a=this.__data__,h=a.delete(n);return this.size=a.size,h}function Db(n){return this.__data__.get(n)}function Ib(n){return this.__data__.has(n)}function Fb(n,a){var h=this.__data__;if(h instanceof Mr){var g=h.__data__;if(!zn||g.length<i-1)return g.push([n,a]),this.size=++h.size,this;h=this.__data__=new Ar(g)}return h.set(n,a),this.size=h.size,this}nr.prototype.clear=Lb,nr.prototype.delete=Ob,nr.prototype.get=Db,nr.prototype.has=Ib,nr.prototype.set=Fb;function vh(n,a){var h=le(n),g=!h&&Ii(n),y=!h&&!g&&ii(n),b=!h&&!g&&!y&&an(n),A=h||g||y||b,L=A?Ia(n.length,Rw):[],I=L.length;for(var W in n)(a||Se.call(n,W))&&!(A&&(W=="length"||y&&(W=="offset"||W=="parent")||b&&(W=="buffer"||W=="byteLength"||W=="byteOffset")||Or(W,I)))&&L.push(W);return L}function wh(n){var a=n.length;return a?n[Ka(0,a-1)]:t}function Tb(n,a){return lo(yt(n),Ci(a,0,n.length))}function Bb(n){return lo(yt(n))}function za(n,a,h){(h!==t&&!sr(n[a],h)||h===t&&!(a in n))&&Pr(n,a,h)}function Rn(n,a,h){var g=n[a];(!(Se.call(n,a)&&sr(g,h))||h===t&&!(a in n))&&Pr(n,a,h)}function qs(n,a){for(var h=n.length;h--;)if(sr(n[h][0],a))return h;return-1}function Ub(n,a,h,g){return Hr(n,function(y,b,A){a(g,y,h(y),A)}),g}function bh(n,a){return n&&gr(a,Ye(a),n)}function Vb(n,a){return n&&gr(a,wt(a),n)}function Pr(n,a,h){a=="__proto__"&&js?js(n,a,{configurable:!0,enumerable:!0,value:h,writable:!0}):n[a]=h}function Na(n,a){for(var h=-1,g=a.length,y=B(g),b=n==null;++h<g;)y[h]=b?t:vl(n,a[h]);return y}function Ci(n,a,h){return n===n&&(h!==t&&(n=n<=h?n:h),a!==t&&(n=n>=a?n:a)),n}function Rt(n,a,h,g,y,b){var A,L=a&p,I=a&_,W=a&v;if(h&&(A=y?h(n,g,y,b):h(n)),A!==t)return A;if(!Ue(n))return n;var G=le(n);if(G){if(A=M1(n),!L)return yt(n,A)}else{var j=st(n),q=j==Ht||j==Sr;if(ii(n))return Xh(n,L);if(j==_t||j==ct||q&&!y){if(A=I||q?{}:hf(n),!L)return I?d1(n,Vb(A,n)):f1(n,bh(A,n))}else{if(!De[j])return y?n:{};A=A1(n,j,L)}}b||(b=new nr);var ee=b.get(n);if(ee)return ee;b.set(n,A),Wf(n)?n.forEach(function(se){A.add(Rt(se,a,h,se,n,b))}):zf(n)&&n.forEach(function(se,pe){A.set(pe,Rt(se,a,h,pe,n,b))});var ne=W?I?sl:nl:I?wt:Ye,ue=G?t:ne(n);return Nt(ue||n,function(se,pe){ue&&(pe=se,se=n[pe]),Rn(A,pe,Rt(se,a,h,pe,n,b))}),A}function kb(n){var a=Ye(n);return function(h){return xh(h,n,a)}}function xh(n,a,h){var g=h.length;if(n==null)return!g;for(n=Ae(n);g--;){var y=h[g],b=a[y],A=n[y];if(A===t&&!(y in n)||!b(A))return!1}return!0}function Sh(n,a,h){if(typeof n!="function")throw new Wt(l);return qn(function(){n.apply(t,h)},a)}function jn(n,a,h,g){var y=-1,b=Fs,A=!0,L=n.length,I=[],W=a.length;if(!L)return I;h&&(a=Be(a,Lt(h))),g?(b=Aa,A=!1):a.length>=i&&(b=Vn,A=!1,a=new Pi(a));e:for(;++y<L;){var G=n[y],j=h==null?G:h(G);if(G=g||G!==0?G:0,A&&j===j){for(var q=W;q--;)if(a[q]===j)continue e;I.push(G)}else b(a,j,g)||I.push(G)}return I}var Hr=Qh(mr),Mh=Qh(Ga,!0);function zb(n,a){var h=!0;return Hr(n,function(g,y,b){return h=!!a(g,y,b),h}),h}function Qs(n,a,h){for(var g=-1,y=n.length;++g<y;){var b=n[g],A=a(b);if(A!=null&&(L===t?A===A&&!Dt(A):h(A,L)))var L=A,I=b}return I}function Nb(n,a,h,g){var y=n.length;for(h=ce(h),h<0&&(h=-h>y?0:y+h),g=g===t||g>y?y:ce(g),g<0&&(g+=y),g=h>g?0:Rf(g);h<g;)n[h++]=a;return n}function Ah(n,a){var h=[];return Hr(n,function(g,y,b){a(g,y,b)&&h.push(g)}),h}function He(n,a,h,g,y){var b=-1,A=n.length;for(h||(h=C1),y||(y=[]);++b<A;){var L=n[b];a>0&&h(L)?a>1?He(L,a-1,h,g,y):Qr(y,L):g||(y[y.length]=L)}return y}var Wa=Jh(),Ph=Jh(!0);function mr(n,a){return n&&Wa(n,a,Ye)}function Ga(n,a){return n&&Ph(n,a,Ye)}function Js(n,a){return qr(a,function(h){return Dr(n[h])})}function Li(n,a){a=ti(a,n);for(var h=0,g=a.length;n!=null&&h<g;)n=n[_r(a[h++])];return h&&h==g?n:t}function Ch(n,a,h){var g=a(n);return le(n)?g:Qr(g,h(n))}function ut(n){return n==null?n===t?yi:mi:Mi&&Mi in Ae(n)?b1(n):B1(n)}function Ra(n,a){return n>a}function Wb(n,a){return n!=null&&Se.call(n,a)}function Gb(n,a){return n!=null&&a in Ae(n)}function Rb(n,a,h){return n>=nt(a,h)&&n<$e(a,h)}function ja(n,a,h){for(var g=h?Aa:Fs,y=n[0].length,b=n.length,A=b,L=B(b),I=1/0,W=[];A--;){var G=n[A];A&&a&&(G=Be(G,Lt(a))),I=nt(G.length,I),L[A]=!h&&(a||y>=120&&G.length>=120)?new Pi(A&&G):t}G=n[0];var j=-1,q=L[0];e:for(;++j<y&&W.length<I;){var ee=G[j],ne=a?a(ee):ee;if(ee=h||ee!==0?ee:0,!(q?Vn(q,ne):g(W,ne,h))){for(A=b;--A;){var ue=L[A];if(!(ue?Vn(ue,ne):g(n[A],ne,h)))continue e}q&&q.push(ne),W.push(ee)}}return W}function jb(n,a,h,g){return mr(n,function(y,b,A){a(g,h(y),b,A)}),g}function $n(n,a,h){a=ti(a,n),n=mf(n,a);var g=n==null?n:n[_r($t(a))];return g==null?t:Ct(g,n,h)}function Lh(n){return ke(n)&&ut(n)==ct}function $b(n){return ke(n)&&ut(n)==Zr}function Xb(n){return ke(n)&&ut(n)==Et}function Xn(n,a,h,g,y){return n===a?!0:n==null||a==null||!ke(n)&&!ke(a)?n!==n&&a!==a:Yb(n,a,h,g,Xn,y)}function Yb(n,a,h,g,y,b){var A=le(n),L=le(a),I=A?Vt:st(n),W=L?Vt:st(a);I=I==ct?_t:I,W=W==ct?_t:W;var G=I==_t,j=W==_t,q=I==W;if(q&&ii(n)){if(!ii(a))return!1;A=!0,G=!1}if(q&&!G)return b||(b=new nr),A||an(n)?lf(n,a,h,g,y,b):v1(n,a,I,h,g,y,b);if(!(h&S)){var ee=G&&Se.call(n,"__wrapped__"),ne=j&&Se.call(a,"__wrapped__");if(ee||ne){var ue=ee?n.value():n,se=ne?a.value():a;return b||(b=new nr),y(ue,se,h,g,b)}}return q?(b||(b=new nr),w1(n,a,h,g,y,b)):!1}function Zb(n){return ke(n)&&st(n)==Ge}function $a(n,a,h,g){var y=h.length,b=y,A=!g;if(n==null)return!b;for(n=Ae(n);y--;){var L=h[y];if(A&&L[2]?L[1]!==n[L[0]]:!(L[0]in n))return!1}for(;++y<b;){L=h[y];var I=L[0],W=n[I],G=L[1];if(A&&L[2]){if(W===t&&!(I in n))return!1}else{var j=new nr;if(g)var q=g(W,G,I,n,a,j);if(!(q===t?Xn(G,W,S|M,g,j):q))return!1}}return!0}function Oh(n){if(!Ue(n)||O1(n))return!1;var a=Dr(n)?Zw:kv;return a.test(Di(n))}function Kb(n){return ke(n)&&ut(n)==_i}function qb(n){return ke(n)&&st(n)==Pt}function Qb(n){return ke(n)&&mo(n.length)&&!!Fe[ut(n)]}function Dh(n){return typeof n=="function"?n:n==null?bt:typeof n=="object"?le(n)?Th(n[0],n[1]):Fh(n):Hf(n)}function Xa(n){if(!Kn(n))return Hw(n);var a=[];for(var h in Ae(n))Se.call(n,h)&&h!="constructor"&&a.push(h);return a}function Jb(n){if(!Ue(n))return T1(n);var a=Kn(n),h=[];for(var g in n)g=="constructor"&&(a||!Se.call(n,g))||h.push(g);return h}function Ya(n,a){return n<a}function Ih(n,a){var h=-1,g=vt(n)?B(n.length):[];return Hr(n,function(y,b,A){g[++h]=a(y,b,A)}),g}function Fh(n){var a=al(n);return a.length==1&&a[0][2]?df(a[0][0],a[0][1]):function(h){return h===n||$a(h,n,a)}}function Th(n,a){return cl(n)&&ff(a)?df(_r(n),a):function(h){var g=vl(h,n);return g===t&&g===a?wl(h,n):Xn(a,g,S|M)}}function Es(n,a,h,g,y){n!==a&&Wa(a,function(b,A){if(y||(y=new nr),Ue(b))Eb(n,a,A,h,Es,g,y);else{var L=g?g(hl(n,A),b,A+"",n,a,y):t;L===t&&(L=b),za(n,A,L)}},wt)}function Eb(n,a,h,g,y,b,A){var L=hl(n,h),I=hl(a,h),W=A.get(I);if(W){za(n,h,W);return}var G=b?b(L,I,h+"",n,a,A):t,j=G===t;if(j){var q=le(I),ee=!q&&ii(I),ne=!q&&!ee&&an(I);G=I,q||ee||ne?le(L)?G=L:Ne(L)?G=yt(L):ee?(j=!1,G=Xh(I,!0)):ne?(j=!1,G=Yh(I,!0)):G=[]:Qn(I)||Ii(I)?(G=L,Ii(L)?G=jf(L):(!Ue(L)||Dr(L))&&(G=hf(I))):j=!1}j&&(A.set(I,G),y(G,I,g,b,A),A.delete(I)),za(n,h,G)}function Bh(n,a){var h=n.length;if(h)return a+=a<0?h:0,Or(a,h)?n[a]:t}function Uh(n,a,h){a.length?a=Be(a,function(b){return le(b)?function(A){return Li(A,b.length===1?b[0]:b)}:b}):a=[bt];var g=-1;a=Be(a,Lt(ie()));var y=Ih(n,function(b,A,L){var I=Be(a,function(W){return W(b)});return{criteria:I,index:++g,value:b}});return Aw(y,function(b,A){return h1(b,A,h)})}function Hb(n,a){return Vh(n,a,function(h,g){return wl(n,g)})}function Vh(n,a,h){for(var g=-1,y=a.length,b={};++g<y;){var A=a[g],L=Li(n,A);h(L,A)&&Yn(b,ti(A,n),L)}return b}function e1(n){return function(a){return Li(a,n)}}function Za(n,a,h,g){var y=g?Mw:qi,b=-1,A=a.length,L=n;for(n===a&&(a=yt(a)),h&&(L=Be(n,Lt(h)));++b<A;)for(var I=0,W=a[b],G=h?h(W):W;(I=y(L,G,I,g))>-1;)L!==n&&Rs.call(L,I,1),Rs.call(n,I,1);return n}function kh(n,a){for(var h=n?a.length:0,g=h-1;h--;){var y=a[h];if(h==g||y!==b){var b=y;Or(y)?Rs.call(n,y,1):Ja(n,y)}}return n}function Ka(n,a){return n+Xs(_h()*(a-n+1))}function t1(n,a,h,g){for(var y=-1,b=$e($s((a-n)/(h||1)),0),A=B(b);b--;)A[g?b:++y]=n,n+=h;return A}function qa(n,a){var h="";if(!n||a<1||a>ve)return h;do a%2&&(h+=n),a=Xs(a/2),a&&(n+=n);while(a);return h}function he(n,a){return fl(pf(n,a,bt),n+"")}function r1(n){return wh(ln(n))}function i1(n,a){var h=ln(n);return lo(h,Ci(a,0,h.length))}function Yn(n,a,h,g){if(!Ue(n))return n;a=ti(a,n);for(var y=-1,b=a.length,A=b-1,L=n;L!=null&&++y<b;){var I=_r(a[y]),W=h;if(I==="__proto__"||I==="constructor"||I==="prototype")return n;if(y!=A){var G=L[I];W=g?g(G,I,L):t,W===t&&(W=Ue(G)?G:Or(a[y+1])?[]:{})}Rn(L,I,W),L=L[I]}return n}var zh=Ys?function(n,a){return Ys.set(n,a),n}:bt,n1=js?function(n,a){return js(n,"toString",{configurable:!0,enumerable:!1,value:xl(a),writable:!0})}:bt;function s1(n){return lo(ln(n))}function jt(n,a,h){var g=-1,y=n.length;a<0&&(a=-a>y?0:y+a),h=h>y?y:h,h<0&&(h+=y),y=a>h?0:h-a>>>0,a>>>=0;for(var b=B(y);++g<y;)b[g]=n[g+a];return b}function o1(n,a){var h;return Hr(n,function(g,y,b){return h=a(g,y,b),!h}),!!h}function Hs(n,a,h){var g=0,y=n==null?g:n.length;if(typeof a=="number"&&a===a&&y<=Oe){for(;g<y;){var b=g+y>>>1,A=n[b];A!==null&&!Dt(A)&&(h?A<=a:A<a)?g=b+1:y=b}return y}return Qa(n,a,bt,h)}function Qa(n,a,h,g){var y=0,b=n==null?0:n.length;if(b===0)return 0;a=h(a);for(var A=a!==a,L=a===null,I=Dt(a),W=a===t;y<b;){var G=Xs((y+b)/2),j=h(n[G]),q=j!==t,ee=j===null,ne=j===j,ue=Dt(j);if(A)var se=g||ne;else W?se=ne&&(g||q):L?se=ne&&q&&(g||!ee):I?se=ne&&q&&!ee&&(g||!ue):ee||ue?se=!1:se=g?j<=a:j<a;se?y=G+1:b=G}return nt(b,Le)}function Nh(n,a){for(var h=-1,g=n.length,y=0,b=[];++h<g;){var A=n[h],L=a?a(A):A;if(!h||!sr(L,I)){var I=L;b[y++]=A===0?0:A}}return b}function Wh(n){return typeof n=="number"?n:Dt(n)?me:+n}function Ot(n){if(typeof n=="string")return n;if(le(n))return Be(n,Ot)+"";if(Dt(n))return yh?yh.call(n):"";var a=n+"";return a=="0"&&1/n==-Pe?"-0":a}function ei(n,a,h){var g=-1,y=Fs,b=n.length,A=!0,L=[],I=L;if(h)A=!1,y=Aa;else if(b>=i){var W=a?null:_1(n);if(W)return Bs(W);A=!1,y=Vn,I=new Pi}else I=a?[]:L;e:for(;++g<b;){var G=n[g],j=a?a(G):G;if(G=h||G!==0?G:0,A&&j===j){for(var q=I.length;q--;)if(I[q]===j)continue e;a&&I.push(j),L.push(G)}else y(I,j,h)||(I!==L&&I.push(j),L.push(G))}return L}function Ja(n,a){return a=ti(a,n),n=mf(n,a),n==null||delete n[_r($t(a))]}function Gh(n,a,h,g){return Yn(n,a,h(Li(n,a)),g)}function eo(n,a,h,g){for(var y=n.length,b=g?y:-1;(g?b--:++b<y)&&a(n[b],b,n););return h?jt(n,g?0:b,g?b+1:y):jt(n,g?b+1:0,g?y:b)}function Rh(n,a){var h=n;return h instanceof ge&&(h=h.value()),Pa(a,function(g,y){return y.func.apply(y.thisArg,Qr([g],y.args))},h)}function Ea(n,a,h){var g=n.length;if(g<2)return g?ei(n[0]):[];for(var y=-1,b=B(g);++y<g;)for(var A=n[y],L=-1;++L<g;)L!=y&&(b[y]=jn(b[y]||A,n[L],a,h));return ei(He(b,1),a,h)}function jh(n,a,h){for(var g=-1,y=n.length,b=a.length,A={};++g<y;){var L=g<b?a[g]:t;h(A,n[g],L)}return A}function Ha(n){return Ne(n)?n:[]}function el(n){return typeof n=="function"?n:bt}function ti(n,a){return le(n)?n:cl(n,a)?[n]:vf(xe(n))}var a1=he;function ri(n,a,h){var g=n.length;return h=h===t?g:h,!a&&h>=g?n:jt(n,a,h)}var $h=Kw||function(n){return Ee.clearTimeout(n)};function Xh(n,a){if(a)return n.slice();var h=n.length,g=fh?fh(h):new n.constructor(h);return n.copy(g),g}function tl(n){var a=new n.constructor(n.byteLength);return new Ws(a).set(new Ws(n)),a}function l1(n,a){var h=a?tl(n.buffer):n.buffer;return new n.constructor(h,n.byteOffset,n.byteLength)}function c1(n){var a=new n.constructor(n.source,Lu.exec(n));return a.lastIndex=n.lastIndex,a}function u1(n){return Gn?Ae(Gn.call(n)):{}}function Yh(n,a){var h=a?tl(n.buffer):n.buffer;return new n.constructor(h,n.byteOffset,n.length)}function Zh(n,a){if(n!==a){var h=n!==t,g=n===null,y=n===n,b=Dt(n),A=a!==t,L=a===null,I=a===a,W=Dt(a);if(!L&&!W&&!b&&n>a||b&&A&&I&&!L&&!W||g&&A&&I||!h&&I||!y)return 1;if(!g&&!b&&!W&&n<a||W&&h&&y&&!g&&!b||L&&h&&y||!A&&y||!I)return-1}return 0}function h1(n,a,h){for(var g=-1,y=n.criteria,b=a.criteria,A=y.length,L=h.length;++g<A;){var I=Zh(y[g],b[g]);if(I){if(g>=L)return I;var W=h[g];return I*(W=="desc"?-1:1)}}return n.index-a.index}function Kh(n,a,h,g){for(var y=-1,b=n.length,A=h.length,L=-1,I=a.length,W=$e(b-A,0),G=B(I+W),j=!g;++L<I;)G[L]=a[L];for(;++y<A;)(j||y<b)&&(G[h[y]]=n[y]);for(;W--;)G[L++]=n[y++];return G}function qh(n,a,h,g){for(var y=-1,b=n.length,A=-1,L=h.length,I=-1,W=a.length,G=$e(b-L,0),j=B(G+W),q=!g;++y<G;)j[y]=n[y];for(var ee=y;++I<W;)j[ee+I]=a[I];for(;++A<L;)(q||y<b)&&(j[ee+h[A]]=n[y++]);return j}function yt(n,a){var h=-1,g=n.length;for(a||(a=B(g));++h<g;)a[h]=n[h];return a}function gr(n,a,h,g){var y=!h;h||(h={});for(var b=-1,A=a.length;++b<A;){var L=a[b],I=g?g(h[L],n[L],L,h,n):t;I===t&&(I=n[L]),y?Pr(h,L,I):Rn(h,L,I)}return h}function f1(n,a){return gr(n,ll(n),a)}function d1(n,a){return gr(n,cf(n),a)}function to(n,a){return function(h,g){var y=le(h)?yw:Ub,b=a?a():{};return y(h,n,ie(g,2),b)}}function nn(n){return he(function(a,h){var g=-1,y=h.length,b=y>1?h[y-1]:t,A=y>2?h[2]:t;for(b=n.length>3&&typeof b=="function"?(y--,b):t,A&&ht(h[0],h[1],A)&&(b=y<3?t:b,y=1),a=Ae(a);++g<y;){var L=h[g];L&&n(a,L,g,b)}return a})}function Qh(n,a){return function(h,g){if(h==null)return h;if(!vt(h))return n(h,g);for(var y=h.length,b=a?y:-1,A=Ae(h);(a?b--:++b<y)&&g(A[b],b,A)!==!1;);return h}}function Jh(n){return function(a,h,g){for(var y=-1,b=Ae(a),A=g(a),L=A.length;L--;){var I=A[n?L:++y];if(h(b[I],I,b)===!1)break}return a}}function p1(n,a,h){var g=a&x,y=Zn(n);function b(){var A=this&&this!==Ee&&this instanceof b?y:n;return A.apply(g?h:this,arguments)}return b}function Eh(n){return function(a){a=xe(a);var h=Qi(a)?ir(a):t,g=h?h[0]:a.charAt(0),y=h?ri(h,1).join(""):a.slice(1);return g[n]()+y}}function sn(n){return function(a){return Pa(Jf(Qf(a).replace(nw,"")),n,"")}}function Zn(n){return function(){var a=arguments;switch(a.length){case 0:return new n;case 1:return new n(a[0]);case 2:return new n(a[0],a[1]);case 3:return new n(a[0],a[1],a[2]);case 4:return new n(a[0],a[1],a[2],a[3]);case 5:return new n(a[0],a[1],a[2],a[3],a[4]);case 6:return new n(a[0],a[1],a[2],a[3],a[4],a[5]);case 7:return new n(a[0],a[1],a[2],a[3],a[4],a[5],a[6])}var h=rn(n.prototype),g=n.apply(h,a);return Ue(g)?g:h}}function m1(n,a,h){var g=Zn(n);function y(){for(var b=arguments.length,A=B(b),L=b,I=on(y);L--;)A[L]=arguments[L];var W=b<3&&A[0]!==I&&A[b-1]!==I?[]:Jr(A,I);if(b-=W.length,b<h)return nf(n,a,ro,y.placeholder,t,A,W,t,t,h-b);var G=this&&this!==Ee&&this instanceof y?g:n;return Ct(G,this,A)}return y}function Hh(n){return function(a,h,g){var y=Ae(a);if(!vt(a)){var b=ie(h,3);a=Ye(a),h=function(L){return b(y[L],L,y)}}var A=n(a,h,g);return A>-1?y[b?a[A]:A]:t}}function ef(n){return Lr(function(a){var h=a.length,g=h,y=Gt.prototype.thru;for(n&&a.reverse();g--;){var b=a[g];if(typeof b!="function")throw new Wt(l);if(y&&!A&&oo(b)=="wrapper")var A=new Gt([],!0)}for(g=A?g:h;++g<h;){b=a[g];var L=oo(b),I=L=="wrapper"?ol(b):t;I&&ul(I[0])&&I[1]==(R|C|N|U)&&!I[4].length&&I[9]==1?A=A[oo(I[0])].apply(A,I[3]):A=b.length==1&&ul(b)?A[L]():A.thru(b)}return function(){var W=arguments,G=W[0];if(A&&W.length==1&&le(G))return A.plant(G).value();for(var j=0,q=h?a[j].apply(this,W):G;++j<h;)q=a[j].call(this,q);return q}})}function ro(n,a,h,g,y,b,A,L,I,W){var G=a&R,j=a&x,q=a&O,ee=a&(C|T),ne=a&$,ue=q?t:Zn(n);function se(){for(var pe=arguments.length,_e=B(pe),It=pe;It--;)_e[It]=arguments[It];if(ee)var ft=on(se),Ft=Cw(_e,ft);if(g&&(_e=Kh(_e,g,y,ee)),b&&(_e=qh(_e,b,A,ee)),pe-=Ft,ee&&pe<W){var We=Jr(_e,ft);return nf(n,a,ro,se.placeholder,h,_e,We,L,I,W-pe)}var or=j?h:this,Fr=q?or[n]:n;return pe=_e.length,L?_e=U1(_e,L):ne&&pe>1&&_e.reverse(),G&&I<pe&&(_e.length=I),this&&this!==Ee&&this instanceof se&&(Fr=ue||Zn(Fr)),Fr.apply(or,_e)}return se}function tf(n,a){return function(h,g){return jb(h,n,a(g),{})}}function io(n,a){return function(h,g){var y;if(h===t&&g===t)return a;if(h!==t&&(y=h),g!==t){if(y===t)return g;typeof h=="string"||typeof g=="string"?(h=Ot(h),g=Ot(g)):(h=Wh(h),g=Wh(g)),y=n(h,g)}return y}}function rl(n){return Lr(function(a){return a=Be(a,Lt(ie())),he(function(h){var g=this;return n(a,function(y){return Ct(y,g,h)})})})}function no(n,a){a=a===t?" ":Ot(a);var h=a.length;if(h<2)return h?qa(a,n):a;var g=qa(a,$s(n/Ji(a)));return Qi(a)?ri(ir(g),0,n).join(""):g.slice(0,n)}function g1(n,a,h,g){var y=a&x,b=Zn(n);function A(){for(var L=-1,I=arguments.length,W=-1,G=g.length,j=B(G+I),q=this&&this!==Ee&&this instanceof A?b:n;++W<G;)j[W]=g[W];for(;I--;)j[W++]=arguments[++L];return Ct(q,y?h:this,j)}return A}function rf(n){return function(a,h,g){return g&&typeof g!="number"&&ht(a,h,g)&&(h=g=t),a=Ir(a),h===t?(h=a,a=0):h=Ir(h),g=g===t?a<h?1:-1:Ir(g),t1(a,h,g,n)}}function so(n){return function(a,h){return typeof a=="string"&&typeof h=="string"||(a=Xt(a),h=Xt(h)),n(a,h)}}function nf(n,a,h,g,y,b,A,L,I,W){var G=a&C,j=G?A:t,q=G?t:A,ee=G?b:t,ne=G?t:b;a|=G?N:X,a&=~(G?X:N),a&P||(a&=-4);var ue=[n,a,y,ee,j,ne,q,L,I,W],se=h.apply(t,ue);return ul(n)&&gf(se,ue),se.placeholder=g,_f(se,n,a)}function il(n){var a=je[n];return function(h,g){if(h=Xt(h),g=g==null?0:nt(ce(g),292),g&&gh(h)){var y=(xe(h)+"e").split("e"),b=a(y[0]+"e"+(+y[1]+g));return y=(xe(b)+"e").split("e"),+(y[0]+"e"+(+y[1]-g))}return a(h)}}var _1=en&&1/Bs(new en([,-0]))[1]==Pe?function(n){return new en(n)}:Al;function sf(n){return function(a){var h=st(a);return h==Ge?Ta(a):h==Pt?Bw(a):Pw(a,n(a))}}function Cr(n,a,h,g,y,b,A,L){var I=a&O;if(!I&&typeof n!="function")throw new Wt(l);var W=g?g.length:0;if(W||(a&=-97,g=y=t),A=A===t?A:$e(ce(A),0),L=L===t?L:ce(L),W-=y?y.length:0,a&X){var G=g,j=y;g=y=t}var q=I?t:ol(n),ee=[n,a,h,g,y,G,j,b,A,L];if(q&&F1(ee,q),n=ee[0],a=ee[1],h=ee[2],g=ee[3],y=ee[4],L=ee[9]=ee[9]===t?I?0:n.length:$e(ee[9]-W,0),!L&&a&(C|T)&&(a&=-25),!a||a==x)var ne=p1(n,a,h);else a==C||a==T?ne=m1(n,a,L):(a==N||a==(x|N))&&!y.length?ne=g1(n,a,h,g):ne=ro.apply(t,ee);var ue=q?zh:gf;return _f(ue(ne,ee),n,a)}function of(n,a,h,g){return n===t||sr(n,Hi[h])&&!Se.call(g,h)?a:n}function af(n,a,h,g,y,b){return Ue(n)&&Ue(a)&&(b.set(a,n),Es(n,a,t,af,b),b.delete(a)),n}function y1(n){return Qn(n)?t:n}function lf(n,a,h,g,y,b){var A=h&S,L=n.length,I=a.length;if(L!=I&&!(A&&I>L))return!1;var W=b.get(n),G=b.get(a);if(W&&G)return W==a&&G==n;var j=-1,q=!0,ee=h&M?new Pi:t;for(b.set(n,a),b.set(a,n);++j<L;){var ne=n[j],ue=a[j];if(g)var se=A?g(ue,ne,j,a,n,b):g(ne,ue,j,n,a,b);if(se!==t){if(se)continue;q=!1;break}if(ee){if(!Ca(a,function(pe,_e){if(!Vn(ee,_e)&&(ne===pe||y(ne,pe,h,g,b)))return ee.push(_e)})){q=!1;break}}else if(!(ne===ue||y(ne,ue,h,g,b))){q=!1;break}}return b.delete(n),b.delete(a),q}function v1(n,a,h,g,y,b,A){switch(h){case pr:if(n.byteLength!=a.byteLength||n.byteOffset!=a.byteOffset)return!1;n=n.buffer,a=a.buffer;case Zr:return!(n.byteLength!=a.byteLength||!b(new Ws(n),new Ws(a)));case gt:case Et:case At:return sr(+n,+a);case xr:return n.name==a.name&&n.message==a.message;case _i:case Xr:return n==a+"";case Ge:var L=Ta;case Pt:var I=g&S;if(L||(L=Bs),n.size!=a.size&&!I)return!1;var W=A.get(n);if(W)return W==a;g|=M,A.set(n,a);var G=lf(L(n),L(a),g,y,b,A);return A.delete(n),G;case Yr:if(Gn)return Gn.call(n)==Gn.call(a)}return!1}function w1(n,a,h,g,y,b){var A=h&S,L=nl(n),I=L.length,W=nl(a),G=W.length;if(I!=G&&!A)return!1;for(var j=I;j--;){var q=L[j];if(!(A?q in a:Se.call(a,q)))return!1}var ee=b.get(n),ne=b.get(a);if(ee&&ne)return ee==a&&ne==n;var ue=!0;b.set(n,a),b.set(a,n);for(var se=A;++j<I;){q=L[j];var pe=n[q],_e=a[q];if(g)var It=A?g(_e,pe,q,a,n,b):g(pe,_e,q,n,a,b);if(!(It===t?pe===_e||y(pe,_e,h,g,b):It)){ue=!1;break}se||(se=q=="constructor")}if(ue&&!se){var ft=n.constructor,Ft=a.constructor;ft!=Ft&&"constructor"in n&&"constructor"in a&&!(typeof ft=="function"&&ft instanceof ft&&typeof Ft=="function"&&Ft instanceof Ft)&&(ue=!1)}return b.delete(n),b.delete(a),ue}function Lr(n){return fl(pf(n,t,Sf),n+"")}function nl(n){return Ch(n,Ye,ll)}function sl(n){return Ch(n,wt,cf)}var ol=Ys?function(n){return Ys.get(n)}:Al;function oo(n){for(var a=n.name+"",h=tn[a],g=Se.call(tn,a)?h.length:0;g--;){var y=h[g],b=y.func;if(b==null||b==n)return y.name}return a}function on(n){var a=Se.call(w,"placeholder")?w:n;return a.placeholder}function ie(){var n=w.iteratee||Sl;return n=n===Sl?Dh:n,arguments.length?n(arguments[0],arguments[1]):n}function ao(n,a){var h=n.__data__;return L1(a)?h[typeof a=="string"?"string":"hash"]:h.map}function al(n){for(var a=Ye(n),h=a.length;h--;){var g=a[h],y=n[g];a[h]=[g,y,ff(y)]}return a}function Oi(n,a){var h=Iw(n,a);return Oh(h)?h:t}function b1(n){var a=Se.call(n,Mi),h=n[Mi];try{n[Mi]=t;var g=!0}catch{}var y=zs.call(n);return g&&(a?n[Mi]=h:delete n[Mi]),y}var ll=Ua?function(n){return n==null?[]:(n=Ae(n),qr(Ua(n),function(a){return ph.call(n,a)}))}:Pl,cf=Ua?function(n){for(var a=[];n;)Qr(a,ll(n)),n=Gs(n);return a}:Pl,st=ut;(Va&&st(new Va(new ArrayBuffer(1)))!=pr||zn&&st(new zn)!=Ge||ka&&st(ka.resolve())!=gi||en&&st(new en)!=Pt||Nn&&st(new Nn)!=vi)&&(st=function(n){var a=ut(n),h=a==_t?n.constructor:t,g=h?Di(h):"";if(g)switch(g){case ib:return pr;case nb:return Ge;case sb:return gi;case ob:return Pt;case ab:return vi}return a});function x1(n,a,h){for(var g=-1,y=h.length;++g<y;){var b=h[g],A=b.size;switch(b.type){case"drop":n+=A;break;case"dropRight":a-=A;break;case"take":a=nt(a,n+A);break;case"takeRight":n=$e(n,a-A);break}}return{start:n,end:a}}function S1(n){var a=n.match(Ov);return a?a[1].split(Dv):[]}function uf(n,a,h){a=ti(a,n);for(var g=-1,y=a.length,b=!1;++g<y;){var A=_r(a[g]);if(!(b=n!=null&&h(n,A)))break;n=n[A]}return b||++g!=y?b:(y=n==null?0:n.length,!!y&&mo(y)&&Or(A,y)&&(le(n)||Ii(n)))}function M1(n){var a=n.length,h=new n.constructor(a);return a&&typeof n[0]=="string"&&Se.call(n,"index")&&(h.index=n.index,h.input=n.input),h}function hf(n){return typeof n.constructor=="function"&&!Kn(n)?rn(Gs(n)):{}}function A1(n,a,h){var g=n.constructor;switch(a){case Zr:return tl(n);case gt:case Et:return new g(+n);case pr:return l1(n,h);case Fn:case Tn:case Xi:case Bn:case Un:case Yi:case wi:case F:case Z:return Yh(n,h);case Ge:return new g;case At:case Xr:return new g(n);case _i:return c1(n);case Pt:return new g;case Yr:return u1(n)}}function P1(n,a){var h=a.length;if(!h)return n;var g=h-1;return a[g]=(h>1?"& ":"")+a[g],a=a.join(h>2?", ":" "),n.replace(Lv,`{
/* [wrapped with `+a+`] */
`)}function C1(n){return le(n)||Ii(n)||!!(mh&&n&&n[mh])}function Or(n,a){var h=typeof n;return a=a??ve,!!a&&(h=="number"||h!="symbol"&&Nv.test(n))&&n>-1&&n%1==0&&n<a}function ht(n,a,h){if(!Ue(h))return!1;var g=typeof a;return(g=="number"?vt(h)&&Or(a,h.length):g=="string"&&a in h)?sr(h[a],n):!1}function cl(n,a){if(le(n))return!1;var h=typeof n;return h=="number"||h=="symbol"||h=="boolean"||n==null||Dt(n)?!0:xi.test(n)||!bi.test(n)||a!=null&&n in Ae(a)}function L1(n){var a=typeof n;return a=="string"||a=="number"||a=="symbol"||a=="boolean"?n!=="__proto__":n===null}function ul(n){var a=oo(n),h=w[a];if(typeof h!="function"||!(a in ge.prototype))return!1;if(n===h)return!0;var g=ol(h);return!!g&&n===g[0]}function O1(n){return!!hh&&hh in n}var D1=Vs?Dr:Cl;function Kn(n){var a=n&&n.constructor,h=typeof a=="function"&&a.prototype||Hi;return n===h}function ff(n){return n===n&&!Ue(n)}function df(n,a){return function(h){return h==null?!1:h[n]===a&&(a!==t||n in Ae(h))}}function I1(n){var a=fo(n,function(g){return h.size===d&&h.clear(),g}),h=a.cache;return a}function F1(n,a){var h=n[1],g=a[1],y=h|g,b=y<(x|O|R),A=g==R&&h==C||g==R&&h==U&&n[7].length<=a[8]||g==(R|U)&&a[7].length<=a[8]&&h==C;if(!(b||A))return n;g&x&&(n[2]=a[2],y|=h&x?0:P);var L=a[3];if(L){var I=n[3];n[3]=I?Kh(I,L,a[4]):L,n[4]=I?Jr(n[3],m):a[4]}return L=a[5],L&&(I=n[5],n[5]=I?qh(I,L,a[6]):L,n[6]=I?Jr(n[5],m):a[6]),L=a[7],L&&(n[7]=L),g&R&&(n[8]=n[8]==null?a[8]:nt(n[8],a[8])),n[9]==null&&(n[9]=a[9]),n[0]=a[0],n[1]=y,n}function T1(n){var a=[];if(n!=null)for(var h in Ae(n))a.push(h);return a}function B1(n){return zs.call(n)}function pf(n,a,h){return a=$e(a===t?n.length-1:a,0),function(){for(var g=arguments,y=-1,b=$e(g.length-a,0),A=B(b);++y<b;)A[y]=g[a+y];y=-1;for(var L=B(a+1);++y<a;)L[y]=g[y];return L[a]=h(A),Ct(n,this,L)}}function mf(n,a){return a.length<2?n:Li(n,jt(a,0,-1))}function U1(n,a){for(var h=n.length,g=nt(a.length,h),y=yt(n);g--;){var b=a[g];n[g]=Or(b,h)?y[b]:t}return n}function hl(n,a){if(!(a==="constructor"&&typeof n[a]=="function")&&a!="__proto__")return n[a]}var gf=yf(zh),qn=Qw||function(n,a){return Ee.setTimeout(n,a)},fl=yf(n1);function _f(n,a,h){var g=a+"";return fl(n,P1(g,V1(S1(g),h)))}function yf(n){var a=0,h=0;return function(){var g=eb(),y=Q-(g-h);if(h=g,y>0){if(++a>=Y)return arguments[0]}else a=0;return n.apply(t,arguments)}}function lo(n,a){var h=-1,g=n.length,y=g-1;for(a=a===t?g:a;++h<a;){var b=Ka(h,y),A=n[b];n[b]=n[h],n[h]=A}return n.length=a,n}var vf=I1(function(n){var a=[];return n.charCodeAt(0)===46&&a.push(""),n.replace(Zi,function(h,g,y,b){a.push(y?b.replace(Tv,"$1"):g||h)}),a});function _r(n){if(typeof n=="string"||Dt(n))return n;var a=n+"";return a=="0"&&1/n==-Pe?"-0":a}function Di(n){if(n!=null){try{return ks.call(n)}catch{}try{return n+""}catch{}}return""}function V1(n,a){return Nt(lt,function(h){var g="_."+h[0];a&h[1]&&!Fs(n,g)&&n.push(g)}),n.sort()}function wf(n){if(n instanceof ge)return n.clone();var a=new Gt(n.__wrapped__,n.__chain__);return a.__actions__=yt(n.__actions__),a.__index__=n.__index__,a.__values__=n.__values__,a}function k1(n,a,h){(h?ht(n,a,h):a===t)?a=1:a=$e(ce(a),0);var g=n==null?0:n.length;if(!g||a<1)return[];for(var y=0,b=0,A=B($s(g/a));y<g;)A[b++]=jt(n,y,y+=a);return A}function z1(n){for(var a=-1,h=n==null?0:n.length,g=0,y=[];++a<h;){var b=n[a];b&&(y[g++]=b)}return y}function N1(){var n=arguments.length;if(!n)return[];for(var a=B(n-1),h=arguments[0],g=n;g--;)a[g-1]=arguments[g];return Qr(le(h)?yt(h):[h],He(a,1))}var W1=he(function(n,a){return Ne(n)?jn(n,He(a,1,Ne,!0)):[]}),G1=he(function(n,a){var h=$t(a);return Ne(h)&&(h=t),Ne(n)?jn(n,He(a,1,Ne,!0),ie(h,2)):[]}),R1=he(function(n,a){var h=$t(a);return Ne(h)&&(h=t),Ne(n)?jn(n,He(a,1,Ne,!0),t,h):[]});function j1(n,a,h){var g=n==null?0:n.length;return g?(a=h||a===t?1:ce(a),jt(n,a<0?0:a,g)):[]}function $1(n,a,h){var g=n==null?0:n.length;return g?(a=h||a===t?1:ce(a),a=g-a,jt(n,0,a<0?0:a)):[]}function X1(n,a){return n&&n.length?eo(n,ie(a,3),!0,!0):[]}function Y1(n,a){return n&&n.length?eo(n,ie(a,3),!0):[]}function Z1(n,a,h,g){var y=n==null?0:n.length;return y?(h&&typeof h!="number"&&ht(n,a,h)&&(h=0,g=y),Nb(n,a,h,g)):[]}function bf(n,a,h){var g=n==null?0:n.length;if(!g)return-1;var y=h==null?0:ce(h);return y<0&&(y=$e(g+y,0)),Ts(n,ie(a,3),y)}function xf(n,a,h){var g=n==null?0:n.length;if(!g)return-1;var y=g-1;return h!==t&&(y=ce(h),y=h<0?$e(g+y,0):nt(y,g-1)),Ts(n,ie(a,3),y,!0)}function Sf(n){var a=n==null?0:n.length;return a?He(n,1):[]}function K1(n){var a=n==null?0:n.length;return a?He(n,Pe):[]}function q1(n,a){var h=n==null?0:n.length;return h?(a=a===t?1:ce(a),He(n,a)):[]}function Q1(n){for(var a=-1,h=n==null?0:n.length,g={};++a<h;){var y=n[a];g[y[0]]=y[1]}return g}function Mf(n){return n&&n.length?n[0]:t}function J1(n,a,h){var g=n==null?0:n.length;if(!g)return-1;var y=h==null?0:ce(h);return y<0&&(y=$e(g+y,0)),qi(n,a,y)}function E1(n){var a=n==null?0:n.length;return a?jt(n,0,-1):[]}var H1=he(function(n){var a=Be(n,Ha);return a.length&&a[0]===n[0]?ja(a):[]}),ex=he(function(n){var a=$t(n),h=Be(n,Ha);return a===$t(h)?a=t:h.pop(),h.length&&h[0]===n[0]?ja(h,ie(a,2)):[]}),tx=he(function(n){var a=$t(n),h=Be(n,Ha);return a=typeof a=="function"?a:t,a&&h.pop(),h.length&&h[0]===n[0]?ja(h,t,a):[]});function rx(n,a){return n==null?"":Ew.call(n,a)}function $t(n){var a=n==null?0:n.length;return a?n[a-1]:t}function ix(n,a,h){var g=n==null?0:n.length;if(!g)return-1;var y=g;return h!==t&&(y=ce(h),y=y<0?$e(g+y,0):nt(y,g-1)),a===a?Vw(n,a,y):Ts(n,ih,y,!0)}function nx(n,a){return n&&n.length?Bh(n,ce(a)):t}var sx=he(Af);function Af(n,a){return n&&n.length&&a&&a.length?Za(n,a):n}function ox(n,a,h){return n&&n.length&&a&&a.length?Za(n,a,ie(h,2)):n}function ax(n,a,h){return n&&n.length&&a&&a.length?Za(n,a,t,h):n}var lx=Lr(function(n,a){var h=n==null?0:n.length,g=Na(n,a);return kh(n,Be(a,function(y){return Or(y,h)?+y:y}).sort(Zh)),g});function cx(n,a){var h=[];if(!(n&&n.length))return h;var g=-1,y=[],b=n.length;for(a=ie(a,3);++g<b;){var A=n[g];a(A,g,n)&&(h.push(A),y.push(g))}return kh(n,y),h}function dl(n){return n==null?n:rb.call(n)}function ux(n,a,h){var g=n==null?0:n.length;return g?(h&&typeof h!="number"&&ht(n,a,h)?(a=0,h=g):(a=a==null?0:ce(a),h=h===t?g:ce(h)),jt(n,a,h)):[]}function hx(n,a){return Hs(n,a)}function fx(n,a,h){return Qa(n,a,ie(h,2))}function dx(n,a){var h=n==null?0:n.length;if(h){var g=Hs(n,a);if(g<h&&sr(n[g],a))return g}return-1}function px(n,a){return Hs(n,a,!0)}function mx(n,a,h){return Qa(n,a,ie(h,2),!0)}function gx(n,a){var h=n==null?0:n.length;if(h){var g=Hs(n,a,!0)-1;if(sr(n[g],a))return g}return-1}function _x(n){return n&&n.length?Nh(n):[]}function yx(n,a){return n&&n.length?Nh(n,ie(a,2)):[]}function vx(n){var a=n==null?0:n.length;return a?jt(n,1,a):[]}function wx(n,a,h){return n&&n.length?(a=h||a===t?1:ce(a),jt(n,0,a<0?0:a)):[]}function bx(n,a,h){var g=n==null?0:n.length;return g?(a=h||a===t?1:ce(a),a=g-a,jt(n,a<0?0:a,g)):[]}function xx(n,a){return n&&n.length?eo(n,ie(a,3),!1,!0):[]}function Sx(n,a){return n&&n.length?eo(n,ie(a,3)):[]}var Mx=he(function(n){return ei(He(n,1,Ne,!0))}),Ax=he(function(n){var a=$t(n);return Ne(a)&&(a=t),ei(He(n,1,Ne,!0),ie(a,2))}),Px=he(function(n){var a=$t(n);return a=typeof a=="function"?a:t,ei(He(n,1,Ne,!0),t,a)});function Cx(n){return n&&n.length?ei(n):[]}function Lx(n,a){return n&&n.length?ei(n,ie(a,2)):[]}function Ox(n,a){return a=typeof a=="function"?a:t,n&&n.length?ei(n,t,a):[]}function pl(n){if(!(n&&n.length))return[];var a=0;return n=qr(n,function(h){if(Ne(h))return a=$e(h.length,a),!0}),Ia(a,function(h){return Be(n,La(h))})}function Pf(n,a){if(!(n&&n.length))return[];var h=pl(n);return a==null?h:Be(h,function(g){return Ct(a,t,g)})}var Dx=he(function(n,a){return Ne(n)?jn(n,a):[]}),Ix=he(function(n){return Ea(qr(n,Ne))}),Fx=he(function(n){var a=$t(n);return Ne(a)&&(a=t),Ea(qr(n,Ne),ie(a,2))}),Tx=he(function(n){var a=$t(n);return a=typeof a=="function"?a:t,Ea(qr(n,Ne),t,a)}),Bx=he(pl);function Ux(n,a){return jh(n||[],a||[],Rn)}function Vx(n,a){return jh(n||[],a||[],Yn)}var kx=he(function(n){var a=n.length,h=a>1?n[a-1]:t;return h=typeof h=="function"?(n.pop(),h):t,Pf(n,h)});function Cf(n){var a=w(n);return a.__chain__=!0,a}function zx(n,a){return a(n),n}function co(n,a){return a(n)}var Nx=Lr(function(n){var a=n.length,h=a?n[0]:0,g=this.__wrapped__,y=function(b){return Na(b,n)};return a>1||this.__actions__.length||!(g instanceof ge)||!Or(h)?this.thru(y):(g=g.slice(h,+h+(a?1:0)),g.__actions__.push({func:co,args:[y],thisArg:t}),new Gt(g,this.__chain__).thru(function(b){return a&&!b.length&&b.push(t),b}))});function Wx(){return Cf(this)}function Gx(){return new Gt(this.value(),this.__chain__)}function Rx(){this.__values__===t&&(this.__values__=Gf(this.value()));var n=this.__index__>=this.__values__.length,a=n?t:this.__values__[this.__index__++];return{done:n,value:a}}function jx(){return this}function $x(n){for(var a,h=this;h instanceof Ks;){var g=wf(h);g.__index__=0,g.__values__=t,a?y.__wrapped__=g:a=g;var y=g;h=h.__wrapped__}return y.__wrapped__=n,a}function Xx(){var n=this.__wrapped__;if(n instanceof ge){var a=n;return this.__actions__.length&&(a=new ge(this)),a=a.reverse(),a.__actions__.push({func:co,args:[dl],thisArg:t}),new Gt(a,this.__chain__)}return this.thru(dl)}function Yx(){return Rh(this.__wrapped__,this.__actions__)}var Zx=to(function(n,a,h){Se.call(n,h)?++n[h]:Pr(n,h,1)});function Kx(n,a,h){var g=le(n)?th:zb;return h&&ht(n,a,h)&&(a=t),g(n,ie(a,3))}function qx(n,a){var h=le(n)?qr:Ah;return h(n,ie(a,3))}var Qx=Hh(bf),Jx=Hh(xf);function Ex(n,a){return He(uo(n,a),1)}function Hx(n,a){return He(uo(n,a),Pe)}function eS(n,a,h){return h=h===t?1:ce(h),He(uo(n,a),h)}function Lf(n,a){var h=le(n)?Nt:Hr;return h(n,ie(a,3))}function Of(n,a){var h=le(n)?vw:Mh;return h(n,ie(a,3))}var tS=to(function(n,a,h){Se.call(n,h)?n[h].push(a):Pr(n,h,[a])});function rS(n,a,h,g){n=vt(n)?n:ln(n),h=h&&!g?ce(h):0;var y=n.length;return h<0&&(h=$e(y+h,0)),go(n)?h<=y&&n.indexOf(a,h)>-1:!!y&&qi(n,a,h)>-1}var iS=he(function(n,a,h){var g=-1,y=typeof a=="function",b=vt(n)?B(n.length):[];return Hr(n,function(A){b[++g]=y?Ct(a,A,h):$n(A,a,h)}),b}),nS=to(function(n,a,h){Pr(n,h,a)});function uo(n,a){var h=le(n)?Be:Ih;return h(n,ie(a,3))}function sS(n,a,h,g){return n==null?[]:(le(a)||(a=a==null?[]:[a]),h=g?t:h,le(h)||(h=h==null?[]:[h]),Uh(n,a,h))}var oS=to(function(n,a,h){n[h?0:1].push(a)},function(){return[[],[]]});function aS(n,a,h){var g=le(n)?Pa:sh,y=arguments.length<3;return g(n,ie(a,4),h,y,Hr)}function lS(n,a,h){var g=le(n)?ww:sh,y=arguments.length<3;return g(n,ie(a,4),h,y,Mh)}function cS(n,a){var h=le(n)?qr:Ah;return h(n,po(ie(a,3)))}function uS(n){var a=le(n)?wh:r1;return a(n)}function hS(n,a,h){(h?ht(n,a,h):a===t)?a=1:a=ce(a);var g=le(n)?Tb:i1;return g(n,a)}function fS(n){var a=le(n)?Bb:s1;return a(n)}function dS(n){if(n==null)return 0;if(vt(n))return go(n)?Ji(n):n.length;var a=st(n);return a==Ge||a==Pt?n.size:Xa(n).length}function pS(n,a,h){var g=le(n)?Ca:o1;return h&&ht(n,a,h)&&(a=t),g(n,ie(a,3))}var mS=he(function(n,a){if(n==null)return[];var h=a.length;return h>1&&ht(n,a[0],a[1])?a=[]:h>2&&ht(a[0],a[1],a[2])&&(a=[a[0]]),Uh(n,He(a,1),[])}),ho=qw||function(){return Ee.Date.now()};function gS(n,a){if(typeof a!="function")throw new Wt(l);return n=ce(n),function(){if(--n<1)return a.apply(this,arguments)}}function Df(n,a,h){return a=h?t:a,a=n&&a==null?n.length:a,Cr(n,R,t,t,t,t,a)}function If(n,a){var h;if(typeof a!="function")throw new Wt(l);return n=ce(n),function(){return--n>0&&(h=a.apply(this,arguments)),n<=1&&(a=t),h}}var ml=he(function(n,a,h){var g=x;if(h.length){var y=Jr(h,on(ml));g|=N}return Cr(n,g,a,h,y)}),Ff=he(function(n,a,h){var g=x|O;if(h.length){var y=Jr(h,on(Ff));g|=N}return Cr(a,g,n,h,y)});function Tf(n,a,h){a=h?t:a;var g=Cr(n,C,t,t,t,t,t,a);return g.placeholder=Tf.placeholder,g}function Bf(n,a,h){a=h?t:a;var g=Cr(n,T,t,t,t,t,t,a);return g.placeholder=Bf.placeholder,g}function Uf(n,a,h){var g,y,b,A,L,I,W=0,G=!1,j=!1,q=!0;if(typeof n!="function")throw new Wt(l);a=Xt(a)||0,Ue(h)&&(G=!!h.leading,j="maxWait"in h,b=j?$e(Xt(h.maxWait)||0,a):b,q="trailing"in h?!!h.trailing:q);function ee(We){var or=g,Fr=y;return g=y=t,W=We,A=n.apply(Fr,or),A}function ne(We){return W=We,L=qn(pe,a),G?ee(We):A}function ue(We){var or=We-I,Fr=We-W,ed=a-or;return j?nt(ed,b-Fr):ed}function se(We){var or=We-I,Fr=We-W;return I===t||or>=a||or<0||j&&Fr>=b}function pe(){var We=ho();if(se(We))return _e(We);L=qn(pe,ue(We))}function _e(We){return L=t,q&&g?ee(We):(g=y=t,A)}function It(){L!==t&&$h(L),W=0,g=I=y=L=t}function ft(){return L===t?A:_e(ho())}function Ft(){var We=ho(),or=se(We);if(g=arguments,y=this,I=We,or){if(L===t)return ne(I);if(j)return $h(L),L=qn(pe,a),ee(I)}return L===t&&(L=qn(pe,a)),A}return Ft.cancel=It,Ft.flush=ft,Ft}var _S=he(function(n,a){return Sh(n,1,a)}),yS=he(function(n,a,h){return Sh(n,Xt(a)||0,h)});function vS(n){return Cr(n,$)}function fo(n,a){if(typeof n!="function"||a!=null&&typeof a!="function")throw new Wt(l);var h=function(){var g=arguments,y=a?a.apply(this,g):g[0],b=h.cache;if(b.has(y))return b.get(y);var A=n.apply(this,g);return h.cache=b.set(y,A)||b,A};return h.cache=new(fo.Cache||Ar),h}fo.Cache=Ar;function po(n){if(typeof n!="function")throw new Wt(l);return function(){var a=arguments;switch(a.length){case 0:return!n.call(this);case 1:return!n.call(this,a[0]);case 2:return!n.call(this,a[0],a[1]);case 3:return!n.call(this,a[0],a[1],a[2])}return!n.apply(this,a)}}function wS(n){return If(2,n)}var bS=a1(function(n,a){a=a.length==1&&le(a[0])?Be(a[0],Lt(ie())):Be(He(a,1),Lt(ie()));var h=a.length;return he(function(g){for(var y=-1,b=nt(g.length,h);++y<b;)g[y]=a[y].call(this,g[y]);return Ct(n,this,g)})}),gl=he(function(n,a){var h=Jr(a,on(gl));return Cr(n,N,t,a,h)}),Vf=he(function(n,a){var h=Jr(a,on(Vf));return Cr(n,X,t,a,h)}),xS=Lr(function(n,a){return Cr(n,U,t,t,t,a)});function SS(n,a){if(typeof n!="function")throw new Wt(l);return a=a===t?a:ce(a),he(n,a)}function MS(n,a){if(typeof n!="function")throw new Wt(l);return a=a==null?0:$e(ce(a),0),he(function(h){var g=h[a],y=ri(h,0,a);return g&&Qr(y,g),Ct(n,this,y)})}function AS(n,a,h){var g=!0,y=!0;if(typeof n!="function")throw new Wt(l);return Ue(h)&&(g="leading"in h?!!h.leading:g,y="trailing"in h?!!h.trailing:y),Uf(n,a,{leading:g,maxWait:a,trailing:y})}function PS(n){return Df(n,1)}function CS(n,a){return gl(el(a),n)}function LS(){if(!arguments.length)return[];var n=arguments[0];return le(n)?n:[n]}function OS(n){return Rt(n,v)}function DS(n,a){return a=typeof a=="function"?a:t,Rt(n,v,a)}function IS(n){return Rt(n,p|v)}function FS(n,a){return a=typeof a=="function"?a:t,Rt(n,p|v,a)}function TS(n,a){return a==null||xh(n,a,Ye(a))}function sr(n,a){return n===a||n!==n&&a!==a}var BS=so(Ra),US=so(function(n,a){return n>=a}),Ii=Lh((function(){return arguments})())?Lh:function(n){return ke(n)&&Se.call(n,"callee")&&!ph.call(n,"callee")},le=B.isArray,VS=qu?Lt(qu):$b;function vt(n){return n!=null&&mo(n.length)&&!Dr(n)}function Ne(n){return ke(n)&&vt(n)}function kS(n){return n===!0||n===!1||ke(n)&&ut(n)==gt}var ii=Jw||Cl,zS=Qu?Lt(Qu):Xb;function NS(n){return ke(n)&&n.nodeType===1&&!Qn(n)}function WS(n){if(n==null)return!0;if(vt(n)&&(le(n)||typeof n=="string"||typeof n.splice=="function"||ii(n)||an(n)||Ii(n)))return!n.length;var a=st(n);if(a==Ge||a==Pt)return!n.size;if(Kn(n))return!Xa(n).length;for(var h in n)if(Se.call(n,h))return!1;return!0}function GS(n,a){return Xn(n,a)}function RS(n,a,h){h=typeof h=="function"?h:t;var g=h?h(n,a):t;return g===t?Xn(n,a,t,h):!!g}function _l(n){if(!ke(n))return!1;var a=ut(n);return a==xr||a==ji||typeof n.message=="string"&&typeof n.name=="string"&&!Qn(n)}function jS(n){return typeof n=="number"&&gh(n)}function Dr(n){if(!Ue(n))return!1;var a=ut(n);return a==Ht||a==Sr||a==Jt||a==$i}function kf(n){return typeof n=="number"&&n==ce(n)}function mo(n){return typeof n=="number"&&n>-1&&n%1==0&&n<=ve}function Ue(n){var a=typeof n;return n!=null&&(a=="object"||a=="function")}function ke(n){return n!=null&&typeof n=="object"}var zf=Ju?Lt(Ju):Zb;function $S(n,a){return n===a||$a(n,a,al(a))}function XS(n,a,h){return h=typeof h=="function"?h:t,$a(n,a,al(a),h)}function YS(n){return Nf(n)&&n!=+n}function ZS(n){if(D1(n))throw new ae(o);return Oh(n)}function KS(n){return n===null}function qS(n){return n==null}function Nf(n){return typeof n=="number"||ke(n)&&ut(n)==At}function Qn(n){if(!ke(n)||ut(n)!=_t)return!1;var a=Gs(n);if(a===null)return!0;var h=Se.call(a,"constructor")&&a.constructor;return typeof h=="function"&&h instanceof h&&ks.call(h)==Xw}var yl=Eu?Lt(Eu):Kb;function QS(n){return kf(n)&&n>=-ve&&n<=ve}var Wf=Hu?Lt(Hu):qb;function go(n){return typeof n=="string"||!le(n)&&ke(n)&&ut(n)==Xr}function Dt(n){return typeof n=="symbol"||ke(n)&&ut(n)==Yr}var an=eh?Lt(eh):Qb;function JS(n){return n===t}function ES(n){return ke(n)&&st(n)==vi}function HS(n){return ke(n)&&ut(n)==ma}var eM=so(Ya),tM=so(function(n,a){return n<=a});function Gf(n){if(!n)return[];if(vt(n))return go(n)?ir(n):yt(n);if(kn&&n[kn])return Tw(n[kn]());var a=st(n),h=a==Ge?Ta:a==Pt?Bs:ln;return h(n)}function Ir(n){if(!n)return n===0?n:0;if(n=Xt(n),n===Pe||n===-Pe){var a=n<0?-1:1;return a*we}return n===n?n:0}function ce(n){var a=Ir(n),h=a%1;return a===a?h?a-h:a:0}function Rf(n){return n?Ci(ce(n),0,Ce):0}function Xt(n){if(typeof n=="number")return n;if(Dt(n))return me;if(Ue(n)){var a=typeof n.valueOf=="function"?n.valueOf():n;n=Ue(a)?a+"":a}if(typeof n!="string")return n===0?n:+n;n=oh(n);var h=Vv.test(n);return h||zv.test(n)?gw(n.slice(2),h?2:8):Uv.test(n)?me:+n}function jf(n){return gr(n,wt(n))}function rM(n){return n?Ci(ce(n),-ve,ve):n===0?n:0}function xe(n){return n==null?"":Ot(n)}var iM=nn(function(n,a){if(Kn(a)||vt(a)){gr(a,Ye(a),n);return}for(var h in a)Se.call(a,h)&&Rn(n,h,a[h])}),$f=nn(function(n,a){gr(a,wt(a),n)}),_o=nn(function(n,a,h,g){gr(a,wt(a),n,g)}),nM=nn(function(n,a,h,g){gr(a,Ye(a),n,g)}),sM=Lr(Na);function oM(n,a){var h=rn(n);return a==null?h:bh(h,a)}var aM=he(function(n,a){n=Ae(n);var h=-1,g=a.length,y=g>2?a[2]:t;for(y&&ht(a[0],a[1],y)&&(g=1);++h<g;)for(var b=a[h],A=wt(b),L=-1,I=A.length;++L<I;){var W=A[L],G=n[W];(G===t||sr(G,Hi[W])&&!Se.call(n,W))&&(n[W]=b[W])}return n}),lM=he(function(n){return n.push(t,af),Ct(Xf,t,n)});function cM(n,a){return rh(n,ie(a,3),mr)}function uM(n,a){return rh(n,ie(a,3),Ga)}function hM(n,a){return n==null?n:Wa(n,ie(a,3),wt)}function fM(n,a){return n==null?n:Ph(n,ie(a,3),wt)}function dM(n,a){return n&&mr(n,ie(a,3))}function pM(n,a){return n&&Ga(n,ie(a,3))}function mM(n){return n==null?[]:Js(n,Ye(n))}function gM(n){return n==null?[]:Js(n,wt(n))}function vl(n,a,h){var g=n==null?t:Li(n,a);return g===t?h:g}function _M(n,a){return n!=null&&uf(n,a,Wb)}function wl(n,a){return n!=null&&uf(n,a,Gb)}var yM=tf(function(n,a,h){a!=null&&typeof a.toString!="function"&&(a=zs.call(a)),n[a]=h},xl(bt)),vM=tf(function(n,a,h){a!=null&&typeof a.toString!="function"&&(a=zs.call(a)),Se.call(n,a)?n[a].push(h):n[a]=[h]},ie),wM=he($n);function Ye(n){return vt(n)?vh(n):Xa(n)}function wt(n){return vt(n)?vh(n,!0):Jb(n)}function bM(n,a){var h={};return a=ie(a,3),mr(n,function(g,y,b){Pr(h,a(g,y,b),g)}),h}function xM(n,a){var h={};return a=ie(a,3),mr(n,function(g,y,b){Pr(h,y,a(g,y,b))}),h}var SM=nn(function(n,a,h){Es(n,a,h)}),Xf=nn(function(n,a,h,g){Es(n,a,h,g)}),MM=Lr(function(n,a){var h={};if(n==null)return h;var g=!1;a=Be(a,function(b){return b=ti(b,n),g||(g=b.length>1),b}),gr(n,sl(n),h),g&&(h=Rt(h,p|_|v,y1));for(var y=a.length;y--;)Ja(h,a[y]);return h});function AM(n,a){return Yf(n,po(ie(a)))}var PM=Lr(function(n,a){return n==null?{}:Hb(n,a)});function Yf(n,a){if(n==null)return{};var h=Be(sl(n),function(g){return[g]});return a=ie(a),Vh(n,h,function(g,y){return a(g,y[0])})}function CM(n,a,h){a=ti(a,n);var g=-1,y=a.length;for(y||(y=1,n=t);++g<y;){var b=n==null?t:n[_r(a[g])];b===t&&(g=y,b=h),n=Dr(b)?b.call(n):b}return n}function LM(n,a,h){return n==null?n:Yn(n,a,h)}function OM(n,a,h,g){return g=typeof g=="function"?g:t,n==null?n:Yn(n,a,h,g)}var Zf=sf(Ye),Kf=sf(wt);function DM(n,a,h){var g=le(n),y=g||ii(n)||an(n);if(a=ie(a,4),h==null){var b=n&&n.constructor;y?h=g?new b:[]:Ue(n)?h=Dr(b)?rn(Gs(n)):{}:h={}}return(y?Nt:mr)(n,function(A,L,I){return a(h,A,L,I)}),h}function IM(n,a){return n==null?!0:Ja(n,a)}function FM(n,a,h){return n==null?n:Gh(n,a,el(h))}function TM(n,a,h,g){return g=typeof g=="function"?g:t,n==null?n:Gh(n,a,el(h),g)}function ln(n){return n==null?[]:Fa(n,Ye(n))}function BM(n){return n==null?[]:Fa(n,wt(n))}function UM(n,a,h){return h===t&&(h=a,a=t),h!==t&&(h=Xt(h),h=h===h?h:0),a!==t&&(a=Xt(a),a=a===a?a:0),Ci(Xt(n),a,h)}function VM(n,a,h){return a=Ir(a),h===t?(h=a,a=0):h=Ir(h),n=Xt(n),Rb(n,a,h)}function kM(n,a,h){if(h&&typeof h!="boolean"&&ht(n,a,h)&&(a=h=t),h===t&&(typeof a=="boolean"?(h=a,a=t):typeof n=="boolean"&&(h=n,n=t)),n===t&&a===t?(n=0,a=1):(n=Ir(n),a===t?(a=n,n=0):a=Ir(a)),n>a){var g=n;n=a,a=g}if(h||n%1||a%1){var y=_h();return nt(n+y*(a-n+mw("1e-"+((y+"").length-1))),a)}return Ka(n,a)}var zM=sn(function(n,a,h){return a=a.toLowerCase(),n+(h?qf(a):a)});function qf(n){return bl(xe(n).toLowerCase())}function Qf(n){return n=xe(n),n&&n.replace(Wv,Lw).replace(sw,"")}function NM(n,a,h){n=xe(n),a=Ot(a);var g=n.length;h=h===t?g:Ci(ce(h),0,g);var y=h;return h-=a.length,h>=0&&n.slice(h,y)==a}function WM(n){return n=xe(n),n&&Ls.test(n)?n.replace(er,Ow):n}function GM(n){return n=xe(n),n&&Pv.test(n)?n.replace(ga,"\\$&"):n}var RM=sn(function(n,a,h){return n+(h?"-":"")+a.toLowerCase()}),jM=sn(function(n,a,h){return n+(h?" ":"")+a.toLowerCase()}),$M=Eh("toLowerCase");function XM(n,a,h){n=xe(n),a=ce(a);var g=a?Ji(n):0;if(!a||g>=a)return n;var y=(a-g)/2;return no(Xs(y),h)+n+no($s(y),h)}function YM(n,a,h){n=xe(n),a=ce(a);var g=a?Ji(n):0;return a&&g<a?n+no(a-g,h):n}function ZM(n,a,h){n=xe(n),a=ce(a);var g=a?Ji(n):0;return a&&g<a?no(a-g,h)+n:n}function KM(n,a,h){return h||a==null?a=0:a&&(a=+a),tb(xe(n).replace(_a,""),a||0)}function qM(n,a,h){return(h?ht(n,a,h):a===t)?a=1:a=ce(a),qa(xe(n),a)}function QM(){var n=arguments,a=xe(n[0]);return n.length<3?a:a.replace(n[1],n[2])}var JM=sn(function(n,a,h){return n+(h?"_":"")+a.toLowerCase()});function EM(n,a,h){return h&&typeof h!="number"&&ht(n,a,h)&&(a=h=t),h=h===t?Ce:h>>>0,h?(n=xe(n),n&&(typeof a=="string"||a!=null&&!yl(a))&&(a=Ot(a),!a&&Qi(n))?ri(ir(n),0,h):n.split(a,h)):[]}var HM=sn(function(n,a,h){return n+(h?" ":"")+bl(a)});function e2(n,a,h){return n=xe(n),h=h==null?0:Ci(ce(h),0,n.length),a=Ot(a),n.slice(h,h+a.length)==a}function t2(n,a,h){var g=w.templateSettings;h&&ht(n,a,h)&&(a=t),n=xe(n),a=_o({},a,g,of);var y=_o({},a.imports,g.imports,of),b=Ye(y),A=Fa(y,b),L,I,W=0,G=a.interpolate||Os,j="__p += '",q=Ba((a.escape||Os).source+"|"+G.source+"|"+(G===Kr?Bv:Os).source+"|"+(a.evaluate||Os).source+"|$","g"),ee="//# sourceURL="+(Se.call(a,"sourceURL")?(a.sourceURL+"").replace(/\s/g," "):"lodash.templateSources["+ ++uw+"]")+`
`;n.replace(q,function(se,pe,_e,It,ft,Ft){return _e||(_e=It),j+=n.slice(W,Ft).replace(Gv,Dw),pe&&(L=!0,j+=`' +
__e(`+pe+`) +
'`),ft&&(I=!0,j+=`';
`+ft+`;
__p += '`),_e&&(j+=`' +
((__t = (`+_e+`)) == null ? '' : __t) +
'`),W=Ft+se.length,se}),j+=`';
`;var ne=Se.call(a,"variable")&&a.variable;if(!ne)j=`with (obj) {
`+j+`
}
`;else if(Fv.test(ne))throw new ae(c);j=(I?j.replace(oe,""):j).replace(ye,"$1").replace(Re,"$1;"),j="function("+(ne||"obj")+`) {
`+(ne?"":`obj || (obj = {});
`)+"var __t, __p = ''"+(L?", __e = _.escape":"")+(I?`, __j = Array.prototype.join;
function print() { __p += __j.call(arguments, '') }
`:`;
`)+j+`return __p
}`;var ue=Ef(function(){return be(b,ee+"return "+j).apply(t,A)});if(ue.source=j,_l(ue))throw ue;return ue}function r2(n){return xe(n).toLowerCase()}function i2(n){return xe(n).toUpperCase()}function n2(n,a,h){if(n=xe(n),n&&(h||a===t))return oh(n);if(!n||!(a=Ot(a)))return n;var g=ir(n),y=ir(a),b=ah(g,y),A=lh(g,y)+1;return ri(g,b,A).join("")}function s2(n,a,h){if(n=xe(n),n&&(h||a===t))return n.slice(0,uh(n)+1);if(!n||!(a=Ot(a)))return n;var g=ir(n),y=lh(g,ir(a))+1;return ri(g,0,y).join("")}function o2(n,a,h){if(n=xe(n),n&&(h||a===t))return n.replace(_a,"");if(!n||!(a=Ot(a)))return n;var g=ir(n),y=ah(g,ir(a));return ri(g,y).join("")}function a2(n,a){var h=z,g=V;if(Ue(a)){var y="separator"in a?a.separator:y;h="length"in a?ce(a.length):h,g="omission"in a?Ot(a.omission):g}n=xe(n);var b=n.length;if(Qi(n)){var A=ir(n);b=A.length}if(h>=b)return n;var L=h-Ji(g);if(L<1)return g;var I=A?ri(A,0,L).join(""):n.slice(0,L);if(y===t)return I+g;if(A&&(L+=I.length-L),yl(y)){if(n.slice(L).search(y)){var W,G=I;for(y.global||(y=Ba(y.source,xe(Lu.exec(y))+"g")),y.lastIndex=0;W=y.exec(G);)var j=W.index;I=I.slice(0,j===t?L:j)}}else if(n.indexOf(Ot(y),L)!=L){var q=I.lastIndexOf(y);q>-1&&(I=I.slice(0,q))}return I+g}function l2(n){return n=xe(n),n&&Cu.test(n)?n.replace(kt,kw):n}var c2=sn(function(n,a,h){return n+(h?" ":"")+a.toUpperCase()}),bl=Eh("toUpperCase");function Jf(n,a,h){return n=xe(n),a=h?t:a,a===t?Fw(n)?Ww(n):Sw(n):n.match(a)||[]}var Ef=he(function(n,a){try{return Ct(n,t,a)}catch(h){return _l(h)?h:new ae(h)}}),u2=Lr(function(n,a){return Nt(a,function(h){h=_r(h),Pr(n,h,ml(n[h],n))}),n});function h2(n){var a=n==null?0:n.length,h=ie();return n=a?Be(n,function(g){if(typeof g[1]!="function")throw new Wt(l);return[h(g[0]),g[1]]}):[],he(function(g){for(var y=-1;++y<a;){var b=n[y];if(Ct(b[0],this,g))return Ct(b[1],this,g)}})}function f2(n){return kb(Rt(n,p))}function xl(n){return function(){return n}}function d2(n,a){return n==null||n!==n?a:n}var p2=ef(),m2=ef(!0);function bt(n){return n}function Sl(n){return Dh(typeof n=="function"?n:Rt(n,p))}function g2(n){return Fh(Rt(n,p))}function _2(n,a){return Th(n,Rt(a,p))}var y2=he(function(n,a){return function(h){return $n(h,n,a)}}),v2=he(function(n,a){return function(h){return $n(n,h,a)}});function Ml(n,a,h){var g=Ye(a),y=Js(a,g);h==null&&!(Ue(a)&&(y.length||!g.length))&&(h=a,a=n,n=this,y=Js(a,Ye(a)));var b=!(Ue(h)&&"chain"in h)||!!h.chain,A=Dr(n);return Nt(y,function(L){var I=a[L];n[L]=I,A&&(n.prototype[L]=function(){var W=this.__chain__;if(b||W){var G=n(this.__wrapped__),j=G.__actions__=yt(this.__actions__);return j.push({func:I,args:arguments,thisArg:n}),G.__chain__=W,G}return I.apply(n,Qr([this.value()],arguments))})}),n}function w2(){return Ee._===this&&(Ee._=Yw),this}function Al(){}function b2(n){return n=ce(n),he(function(a){return Bh(a,n)})}var x2=rl(Be),S2=rl(th),M2=rl(Ca);function Hf(n){return cl(n)?La(_r(n)):e1(n)}function A2(n){return function(a){return n==null?t:Li(n,a)}}var P2=rf(),C2=rf(!0);function Pl(){return[]}function Cl(){return!1}function L2(){return{}}function O2(){return""}function D2(){return!0}function I2(n,a){if(n=ce(n),n<1||n>ve)return[];var h=Ce,g=nt(n,Ce);a=ie(a),n-=Ce;for(var y=Ia(g,a);++h<n;)a(h);return y}function F2(n){return le(n)?Be(n,_r):Dt(n)?[n]:yt(vf(xe(n)))}function T2(n){var a=++$w;return xe(n)+a}var B2=io(function(n,a){return n+a},0),U2=il("ceil"),V2=io(function(n,a){return n/a},1),k2=il("floor");function z2(n){return n&&n.length?Qs(n,bt,Ra):t}function N2(n,a){return n&&n.length?Qs(n,ie(a,2),Ra):t}function W2(n){return nh(n,bt)}function G2(n,a){return nh(n,ie(a,2))}function R2(n){return n&&n.length?Qs(n,bt,Ya):t}function j2(n,a){return n&&n.length?Qs(n,ie(a,2),Ya):t}var $2=io(function(n,a){return n*a},1),X2=il("round"),Y2=io(function(n,a){return n-a},0);function Z2(n){return n&&n.length?Da(n,bt):0}function K2(n,a){return n&&n.length?Da(n,ie(a,2)):0}return w.after=gS,w.ary=Df,w.assign=iM,w.assignIn=$f,w.assignInWith=_o,w.assignWith=nM,w.at=sM,w.before=If,w.bind=ml,w.bindAll=u2,w.bindKey=Ff,w.castArray=LS,w.chain=Cf,w.chunk=k1,w.compact=z1,w.concat=N1,w.cond=h2,w.conforms=f2,w.constant=xl,w.countBy=Zx,w.create=oM,w.curry=Tf,w.curryRight=Bf,w.debounce=Uf,w.defaults=aM,w.defaultsDeep=lM,w.defer=_S,w.delay=yS,w.difference=W1,w.differenceBy=G1,w.differenceWith=R1,w.drop=j1,w.dropRight=$1,w.dropRightWhile=X1,w.dropWhile=Y1,w.fill=Z1,w.filter=qx,w.flatMap=Ex,w.flatMapDeep=Hx,w.flatMapDepth=eS,w.flatten=Sf,w.flattenDeep=K1,w.flattenDepth=q1,w.flip=vS,w.flow=p2,w.flowRight=m2,w.fromPairs=Q1,w.functions=mM,w.functionsIn=gM,w.groupBy=tS,w.initial=E1,w.intersection=H1,w.intersectionBy=ex,w.intersectionWith=tx,w.invert=yM,w.invertBy=vM,w.invokeMap=iS,w.iteratee=Sl,w.keyBy=nS,w.keys=Ye,w.keysIn=wt,w.map=uo,w.mapKeys=bM,w.mapValues=xM,w.matches=g2,w.matchesProperty=_2,w.memoize=fo,w.merge=SM,w.mergeWith=Xf,w.method=y2,w.methodOf=v2,w.mixin=Ml,w.negate=po,w.nthArg=b2,w.omit=MM,w.omitBy=AM,w.once=wS,w.orderBy=sS,w.over=x2,w.overArgs=bS,w.overEvery=S2,w.overSome=M2,w.partial=gl,w.partialRight=Vf,w.partition=oS,w.pick=PM,w.pickBy=Yf,w.property=Hf,w.propertyOf=A2,w.pull=sx,w.pullAll=Af,w.pullAllBy=ox,w.pullAllWith=ax,w.pullAt=lx,w.range=P2,w.rangeRight=C2,w.rearg=xS,w.reject=cS,w.remove=cx,w.rest=SS,w.reverse=dl,w.sampleSize=hS,w.set=LM,w.setWith=OM,w.shuffle=fS,w.slice=ux,w.sortBy=mS,w.sortedUniq=_x,w.sortedUniqBy=yx,w.split=EM,w.spread=MS,w.tail=vx,w.take=wx,w.takeRight=bx,w.takeRightWhile=xx,w.takeWhile=Sx,w.tap=zx,w.throttle=AS,w.thru=co,w.toArray=Gf,w.toPairs=Zf,w.toPairsIn=Kf,w.toPath=F2,w.toPlainObject=jf,w.transform=DM,w.unary=PS,w.union=Mx,w.unionBy=Ax,w.unionWith=Px,w.uniq=Cx,w.uniqBy=Lx,w.uniqWith=Ox,w.unset=IM,w.unzip=pl,w.unzipWith=Pf,w.update=FM,w.updateWith=TM,w.values=ln,w.valuesIn=BM,w.without=Dx,w.words=Jf,w.wrap=CS,w.xor=Ix,w.xorBy=Fx,w.xorWith=Tx,w.zip=Bx,w.zipObject=Ux,w.zipObjectDeep=Vx,w.zipWith=kx,w.entries=Zf,w.entriesIn=Kf,w.extend=$f,w.extendWith=_o,Ml(w,w),w.add=B2,w.attempt=Ef,w.camelCase=zM,w.capitalize=qf,w.ceil=U2,w.clamp=UM,w.clone=OS,w.cloneDeep=IS,w.cloneDeepWith=FS,w.cloneWith=DS,w.conformsTo=TS,w.deburr=Qf,w.defaultTo=d2,w.divide=V2,w.endsWith=NM,w.eq=sr,w.escape=WM,w.escapeRegExp=GM,w.every=Kx,w.find=Qx,w.findIndex=bf,w.findKey=cM,w.findLast=Jx,w.findLastIndex=xf,w.findLastKey=uM,w.floor=k2,w.forEach=Lf,w.forEachRight=Of,w.forIn=hM,w.forInRight=fM,w.forOwn=dM,w.forOwnRight=pM,w.get=vl,w.gt=BS,w.gte=US,w.has=_M,w.hasIn=wl,w.head=Mf,w.identity=bt,w.includes=rS,w.indexOf=J1,w.inRange=VM,w.invoke=wM,w.isArguments=Ii,w.isArray=le,w.isArrayBuffer=VS,w.isArrayLike=vt,w.isArrayLikeObject=Ne,w.isBoolean=kS,w.isBuffer=ii,w.isDate=zS,w.isElement=NS,w.isEmpty=WS,w.isEqual=GS,w.isEqualWith=RS,w.isError=_l,w.isFinite=jS,w.isFunction=Dr,w.isInteger=kf,w.isLength=mo,w.isMap=zf,w.isMatch=$S,w.isMatchWith=XS,w.isNaN=YS,w.isNative=ZS,w.isNil=qS,w.isNull=KS,w.isNumber=Nf,w.isObject=Ue,w.isObjectLike=ke,w.isPlainObject=Qn,w.isRegExp=yl,w.isSafeInteger=QS,w.isSet=Wf,w.isString=go,w.isSymbol=Dt,w.isTypedArray=an,w.isUndefined=JS,w.isWeakMap=ES,w.isWeakSet=HS,w.join=rx,w.kebabCase=RM,w.last=$t,w.lastIndexOf=ix,w.lowerCase=jM,w.lowerFirst=$M,w.lt=eM,w.lte=tM,w.max=z2,w.maxBy=N2,w.mean=W2,w.meanBy=G2,w.min=R2,w.minBy=j2,w.stubArray=Pl,w.stubFalse=Cl,w.stubObject=L2,w.stubString=O2,w.stubTrue=D2,w.multiply=$2,w.nth=nx,w.noConflict=w2,w.noop=Al,w.now=ho,w.pad=XM,w.padEnd=YM,w.padStart=ZM,w.parseInt=KM,w.random=kM,w.reduce=aS,w.reduceRight=lS,w.repeat=qM,w.replace=QM,w.result=CM,w.round=X2,w.runInContext=D,w.sample=uS,w.size=dS,w.snakeCase=JM,w.some=pS,w.sortedIndex=hx,w.sortedIndexBy=fx,w.sortedIndexOf=dx,w.sortedLastIndex=px,w.sortedLastIndexBy=mx,w.sortedLastIndexOf=gx,w.startCase=HM,w.startsWith=e2,w.subtract=Y2,w.sum=Z2,w.sumBy=K2,w.template=t2,w.times=I2,w.toFinite=Ir,w.toInteger=ce,w.toLength=Rf,w.toLower=r2,w.toNumber=Xt,w.toSafeInteger=rM,w.toString=xe,w.toUpper=i2,w.trim=n2,w.trimEnd=s2,w.trimStart=o2,w.truncate=a2,w.unescape=l2,w.uniqueId=T2,w.upperCase=c2,w.upperFirst=bl,w.each=Lf,w.eachRight=Of,w.first=Mf,Ml(w,(function(){var n={};return mr(w,function(a,h){Se.call(w.prototype,h)||(n[h]=a)}),n})(),{chain:!1}),w.VERSION=r,Nt(["bind","bindKey","curry","curryRight","partial","partialRight"],function(n){w[n].placeholder=w}),Nt(["drop","take"],function(n,a){ge.prototype[n]=function(h){h=h===t?1:$e(ce(h),0);var g=this.__filtered__&&!a?new ge(this):this.clone();return g.__filtered__?g.__takeCount__=nt(h,g.__takeCount__):g.__views__.push({size:nt(h,Ce),type:n+(g.__dir__<0?"Right":"")}),g},ge.prototype[n+"Right"]=function(h){return this.reverse()[n](h).reverse()}}),Nt(["filter","map","takeWhile"],function(n,a){var h=a+1,g=h==K||h==H;ge.prototype[n]=function(y){var b=this.clone();return b.__iteratees__.push({iteratee:ie(y,3),type:h}),b.__filtered__=b.__filtered__||g,b}}),Nt(["head","last"],function(n,a){var h="take"+(a?"Right":"");ge.prototype[n]=function(){return this[h](1).value()[0]}}),Nt(["initial","tail"],function(n,a){var h="drop"+(a?"":"Right");ge.prototype[n]=function(){return this.__filtered__?new ge(this):this[h](1)}}),ge.prototype.compact=function(){return this.filter(bt)},ge.prototype.find=function(n){return this.filter(n).head()},ge.prototype.findLast=function(n){return this.reverse().find(n)},ge.prototype.invokeMap=he(function(n,a){return typeof n=="function"?new ge(this):this.map(function(h){return $n(h,n,a)})}),ge.prototype.reject=function(n){return this.filter(po(ie(n)))},ge.prototype.slice=function(n,a){n=ce(n);var h=this;return h.__filtered__&&(n>0||a<0)?new ge(h):(n<0?h=h.takeRight(-n):n&&(h=h.drop(n)),a!==t&&(a=ce(a),h=a<0?h.dropRight(-a):h.take(a-n)),h)},ge.prototype.takeRightWhile=function(n){return this.reverse().takeWhile(n).reverse()},ge.prototype.toArray=function(){return this.take(Ce)},mr(ge.prototype,function(n,a){var h=/^(?:filter|find|map|reject)|While$/.test(a),g=/^(?:head|last)$/.test(a),y=w[g?"take"+(a=="last"?"Right":""):a],b=g||/^find/.test(a);y&&(w.prototype[a]=function(){var A=this.__wrapped__,L=g?[1]:arguments,I=A instanceof ge,W=L[0],G=I||le(A),j=function(pe){var _e=y.apply(w,Qr([pe],L));return g&&q?_e[0]:_e};G&&h&&typeof W=="function"&&W.length!=1&&(I=G=!1);var q=this.__chain__,ee=!!this.__actions__.length,ne=b&&!q,ue=I&&!ee;if(!b&&G){A=ue?A:new ge(this);var se=n.apply(A,L);return se.__actions__.push({func:co,args:[j],thisArg:t}),new Gt(se,q)}return ne&&ue?n.apply(this,L):(se=this.thru(j),ne?g?se.value()[0]:se.value():se)})}),Nt(["pop","push","shift","sort","splice","unshift"],function(n){var a=Us[n],h=/^(?:push|sort|unshift)$/.test(n)?"tap":"thru",g=/^(?:pop|shift)$/.test(n);w.prototype[n]=function(){var y=arguments;if(g&&!this.__chain__){var b=this.value();return a.apply(le(b)?b:[],y)}return this[h](function(A){return a.apply(le(A)?A:[],y)})}}),mr(ge.prototype,function(n,a){var h=w[a];if(h){var g=h.name+"";Se.call(tn,g)||(tn[g]=[]),tn[g].push({name:a,func:h})}}),tn[ro(t,O).name]=[{name:"wrapper",func:t}],ge.prototype.clone=lb,ge.prototype.reverse=cb,ge.prototype.value=ub,w.prototype.at=Nx,w.prototype.chain=Wx,w.prototype.commit=Gx,w.prototype.next=Rx,w.prototype.plant=$x,w.prototype.reverse=Xx,w.prototype.toJSON=w.prototype.valueOf=w.prototype.value=Yx,w.prototype.first=w.prototype.head,kn&&(w.prototype[kn]=jx),w}),Ei=Gw();Si?((Si.exports=Ei)._=Ei,Sa._=Ei):Ee._=Ei}).call(r_)})(xn,xn.exports)),xn.exports}var n_=i_(),s_=Object.defineProperty,o_=(s,e,t)=>e in s?s_(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,a_=(s,e,t)=>o_(s,e+"",t);let Zt=class extends tt{constructor(e){super(e),a_(this,"_baseType","Point"),this._renderObject=this._createRenderObject(),this._style&&this._style.applyTo(this._renderObject)}_coordsTransform(){const e=this.getMap(),t=new f.Vector3(this._geometry.coordinates[0],this._geometry.coordinates[1],this._geometry.coordinates[2]||0);return e?e.projectToWorld(t):t}async _buildRenderObject(){this.map}_refreshCoordinates(){const e=this._coordsTransform();if(this._worldCoordinates=e,this._renderObject){const t=this.getMap();t?.prjcenter?this._renderObject.position.copy(e).sub(t.prjcenter):this._renderObject.position.copy(e),this.children.includes(this._renderObject)||this.add(this._renderObject),this.updateMatrixWorld(!0)}else this._buildRenderObject()}_createRenderObject(){return new f.Points(new f.BufferGeometry,new f.PointsMaterial({size:1,color:8947848}))}};var l_=Object.defineProperty,c_=(s,e,t)=>e in s?l_(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,u_=(s,e,t)=>c_(s,e+"",t);const h_={};class wr extends Zt{constructor(e){super(e),u_(this,"_type","Marker")}async _buildRenderObject(){this._worldCoordinates=this._coordsTransform(),this._style&&(this._renderObject&&this._disposeGeometry(),this._renderObject=await this._createObject(this._style),this._refreshCoordinates())}_refreshCoordinates(){this._worldCoordinates=this._coordsTransform(),this._renderObject?(this._renderObject.position.copy(this._worldCoordinates),this.children.includes(this._renderObject)||this.add(this._renderObject),this.updateMatrixWorld(!0),this._renderObject.updateMatrixWorld(!0)):this._buildRenderObject()}async _createObject(e){switch(e.config.type){case"basic-point":return bc(e.config,new f.Vector3(0,0,0));case"icon-point":return Gm(e.config,this._worldCoordinates);case"icon-label-point":return Qm(e.config,this._worldCoordinates);default:throw new Error(`不支持的样式类型: ${e.config.type}`)}}_calculateCollisionBoundingBox(e,t){if(!this.visible||!this._renderObject||!e||!t)return null;try{return this._style?.config.type==="icon-point"?this._calculateSpriteBoundingBox(this._renderObject):this._getFallbackBoundingBox()}catch(r){return console.warn(`Marker ${this._id} bounding box calculation failed:`,r),console.warn(`Marker ${this._id} 包围盒计算失败:`,r),this._getFallbackBoundingBox()}}_calculateSpriteBoundingBox(e){try{const r=Math.max(Math.abs(e.scale.x),Math.abs(e.scale.y))/.002;return{width:r,height:r,offsetX:-r/2,offsetY:-r/2}}catch{return{width:20,height:20,offsetX:-10,offsetY:-10}}}_getFallbackBoundingBox(){switch(this.getStyle()?.config.type){case"icon-point":case"icon-label-point":return{width:20,height:20,offsetX:-10,offsetY:-10};case"basic-point":return{width:10,height:10,offsetX:-5,offsetY:-5};default:return{width:15,height:15,offsetX:-7.5,offsetY:-7.5}}}}wr.mergeOptions(h_);var f_=Object.defineProperty,d_=(s,e,t)=>e in s?f_(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Nc=(s,e,t)=>d_(s,typeof e!="symbol"?e+"":e,t);class Wc extends tt{constructor(e){super(e),Nc(this,"_baseType","Line"),Nc(this,"_vertexPoints"),this._renderObject=this._createRenderObject(),this._vertexPoints=[0,0,0],this._style&&this._style.applyTo(this._renderObject)}_coordsTransform(){const e=this.getMap(),t=this._geometry,r=e?.prjcenter;if(this._geometry.type==="LineString"){let o=t.coordinates.map(c=>{const u=new f.Vector3(c[0],c[1],c[2]||0);return(e?e.projectToWorld(u):u).sub(r)}),l=o.flatMap(c=>[c.x,c.y,c.z]);return{_worldCoordinates:o,_vertexPoints:l}}}_buildRenderObject(){}_createRenderObject(){const e=new ns,t=new gn({color:8947848,linewidth:.1,dashed:!1,resolution:new f.Vector2(window.innerWidth,window.innerHeight)});return new as(e,t)}}var p_=Object.defineProperty,m_=(s,e,t)=>e in s?p_(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,g_=(s,e,t)=>m_(s,e+"",t);const __={};class pt extends Wc{constructor(e){super(e),g_(this,"_type","LineString")}async _buildRenderObject(){let{_vertexPoints:e}=this._coordsTransform();this._vertexPoints=e,this._style&&(this._renderObject&&this._disposeGeometry(),this._renderObject=await this._createObject(this._style),this._refreshCoordinates())}_refreshCoordinates(){let{_vertexPoints:e}=this._coordsTransform();if(this._vertexPoints=e,this._renderObject&&(this._renderObject.isLine2||this._renderObject instanceof as)){const i=this._renderObject.geometry;i.setPositions(this._vertexPoints),i.computeBoundingSphere(),i.computeBoundingBox();const o=this.getMap();o?.prjcenter&&this._renderObject.position.set(o.prjcenter.x,o.prjcenter.y,o.prjcenter.z),this.children.includes(this._renderObject)||this.add(this._renderObject),this.updateMatrixWorld(!0),this._renderObject.updateMatrixWorld(!0)}else console.warn("[LineString] _updateGeometryPositions: Geometry type mismatch, fallback to full rebuild",{hasGeometry:!!this._renderObject,geometryType:this._renderObject?.constructor?.name,isLine2:this._renderObject?.isLine2}),this._buildRenderObject()}async _createObject(e){switch(e.config.type){case"basic-line":return Jo(e.config,this._vertexPoints);case"flow-tube-line":return xc(e.config,this._vertexPoints);case"arrow-line":return Sc(e.config,this._vertexPoints);case"flow-texture-line":return await Mc(e.config,this._vertexPoints);default:throw new Error(`Unsupported style type: ${e.config.type}`)}}}pt.mergeOptions(__);var y_=Object.defineProperty,v_=(s,e,t)=>e in s?y_(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Gc=(s,e,t)=>v_(s,typeof e!="symbol"?e+"":e,t);class w_ extends tt{constructor(e){super(e),Gc(this,"_baseType","Surface"),Gc(this,"_vertexPoints"),this._buildRenderObject(),this._vertexPoints=[0,0,0],this._style&&this._renderObject&&this._style.applyTo(this._renderObject)}_buildRenderObject(){if(this._renderObject||!this._geometry)return;const{_vertexPoints:t}=this._coordsTransform();this._vertexPoints=t,this._renderObject=this._createRenderObject()}_coordsTransform(){const e=this.getMap(),t=e?.prjcenter,r=this._geometry;if(!r)throw new Error("Geometry data undefined");if(r.type==="Polygon"){const i=r.coordinates;let o=[],l=[];return i.forEach(c=>{const u=c.map(d=>{const m=new f.Vector3(d[0],d[1],d[2]||0);return(e?e.projectToWorld(m):m).sub(t)});o.push(u),l.push(...u.flatMap(d=>[d.x,d.y,d.z]))}),{_worldCoordinates:o,_vertexPoints:l}}else if(r.type==="MultiPolygon"){const i=r.coordinates;let o=[],l=[];return i.forEach(c=>{const u=[];c.forEach(d=>{const m=d.map(p=>{const _=new f.Vector3(p[0],p[1],p[2]||0);return(e?e.projectToWorld(_):_).sub(t)});u.push(m),l.push(...m.flatMap(p=>[p.x,p.y,p.z]))}),o.push(u)}),{_worldCoordinates:o,_vertexPoints:l}}else throw new Error(`Unsupported geometry type: ${r.type}`)}_refreshCoordinates(){const e=this._style?.config.type;if(this.clear(),!this._renderObject||!this._vertexPoints?.length){console.warn("Cannot update geometry: missing geometry or vertex data");return}const t=this.getMap();try{e==="basic-polygon"?(this._renderObject.renderOrder=90,this._renderObject.position.add(t?.prjcenter),this._renderObject.updateMatrix(),this.add(this._renderObject)):(e==="extrude-polygon"||e?.includes("water"))&&(this._renderObject.renderOrder=90,this._renderObject.position.add(t?.prjcenter),this._renderObject.updateMatrix(),this.add(this._renderObject))}catch(r){throw console.error("Failed to update polygon position:",r),r}}_createRenderObject(){const e=new ns,t=new gn({color:8947848,linewidth:.1,dashed:!1,resolution:new f.Vector2(window.innerWidth,window.innerHeight)});return new as(e,t)}}var b_=Object.defineProperty,x_=(s,e,t)=>e in s?b_(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,S_=(s,e,t)=>x_(s,e+"",t);const M_={};class fr extends w_{constructor(e){super(e),S_(this,"_type","Polygon")}async _buildRenderObject(){let{_vertexPoints:e}=this._coordsTransform();this._vertexPoints=e,this._style&&(this._renderObject&&this.remove(this._renderObject),this._renderObject=await this._createObject(this._style),this._refreshCoordinates(),await this._style.applyTo(this._renderObject))}_refreshCoordinates(){const e=this._style?.config.type;console.warn("[Polygon] _refreshCoordinates: Fallback to full rebuild",{styleType:e,hasGeometry:!!this._renderObject}),this._buildRenderObject()}async _createObject(e){switch(e.config.type){case"basic-polygon":return jm(e.config,this._vertexPoints);case"extrude-polygon":return $m(e.config,this._vertexPoints);case"water":return Xm(e.config,this.getMap(),this._vertexPoints);case"base-water":return Ym(e.config,this._vertexPoints);default:throw new Error(`Unsupported style type: ${e.config.type}`)}}_calculateCollisionBoundingBox(){return null}}fr.mergeOptions(M_);var A_=Object.defineProperty,P_=(s,e,t)=>e in s?A_(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ra=(s,e,t)=>P_(s,typeof e!="symbol"?e+"":e,t);const C_={};class Rc extends Wc{constructor(e){super(e),ra(this,"_type","MultiLineString"),ra(this,"_lineObjects",[]),ra(this,"_linesContainer"),this._linesContainer=new f.Group}async _buildRenderObject(){const{_worldCoordinates:e}=this._coordsTransform(),t=this.getMap();if(this.clearLines(),this._disposeGeometry(),this._style){for(const r of e){const i=r.flatMap(l=>[l.x,l.y,l.z]),o=await this._createLineObject(this._style,i);o.position.add(t?.prjcenter),o.updateMatrixWorld(!0),o.renderOrder=99,this._lineObjects.push(o),this._linesContainer.add(o)}this._linesContainer.renderOrder=99,this._renderObject=this._linesContainer,this.add(this._renderObject),this._updateContainer(),this.updateMatrixWorld(!0),this._renderObject.updateMatrixWorld(!0),this._tryProcessQueue()}}async _createLineObject(e,t){switch(e.config.type){case"basic-line":return Jo(e.config,t);case"flow-tube-line":return xc(e.config,t);case"arrow-line":return Sc(e.config,t);case"flow-texture-line":return await Mc(e.config,t);default:throw new Error(`Unsupported style type: ${e.config.type}`)}}_coordsTransform(){const e=this.getMap(),t=this._geometry;if(this._geometry.type==="MultiLineString"){const r=e?.prjcenter;return{_worldCoordinates:t.coordinates.map(o=>o.map(l=>{const c=new f.Vector3(l[0],l[1],l[2]||0);return(e?e.projectToWorld(c):c).sub(r)}))}}}_updateContainer(){this._linesContainer.updateMatrixWorld(!0)}clearLines(){this._lineObjects.forEach(e=>{this._linesContainer.remove(e),e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(t=>t.dispose()):e.material.dispose())}),this._lineObjects=[]}_refreshCoordinates(){this._buildRenderObject()}_disposeObject(){}}Rc.mergeOptions(C_);var L_=Object.defineProperty,O_=(s,e,t)=>e in s?L_(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Sn=(s,e,t)=>O_(s,typeof e!="symbol"?e+"":e,t);const ia=64;class D_ extends et.MeshStandardMaterial{constructor(e={}){const{shaderOption:t,regionOverlay:r,...i}=e;if(super({color:"rgb(58,126,182)",roughness:.7,metalness:.1,transparent:!0,opacity:.9,envMapIntensity:.8,depthWrite:!0,depthTest:!0,...i}),Sn(this,"shaderOption"),Sn(this,"clock"),Sn(this,"time"),Sn(this,"startTime"),Sn(this,"regionOverlay"),r&&r.vertices&&r.vertices.length>0){const o=r.vertices.slice(0,ia).map(c=>c.clone()),l=o.length;for(;o.length<ia;)o.push(new et.Vector2(0,0));this.regionOverlay={color:r.color,opacity:r.opacity,vertices:o,vertexCount:l}}this.shaderOption={minY:0,maxY:100,minRate:.3,maxRate:1.5,effects:{diffusion:{enabled:!1,color:new et.Color("#9ECDEC"),width:20,speed:1,maxDistance:100,center:void 0},flow:{enabled:!1,color:new et.Color("#00E4FF"),range:10,speed:20},sweep:{enabled:!1,color:new et.Color("#FFFFFF"),width:1.5,speed:10}},...t},this.clock=new et.Clock,this.time={value:0},this.startTime={value:0},this.animate()}onBeforeCompile(e){const{minY:t,maxY:r,minRate:i,maxRate:o,effects:l}=this.shaderOption,c=r-t,u=!!this.regionOverlay;e.uniforms={...e.uniforms,time:this.time,uStartTime:this.startTime,uMinY:{value:t},uMaxY:{value:r},uHeightRange:{value:c},uMinRate:{value:i},uMaxRate:{value:o},uDiffusionEnabled:{value:l?.diffusion?.enabled?1:0},uDiffusionColor:{value:l?.diffusion?.color||new et.Color("#9ECDEC")},uDiffusionWidth:{value:l?.diffusion?.width||20},uDiffusionSpeed:{value:l?.diffusion?.speed||1},uDiffusionMaxDistance:{value:l?.diffusion?.maxDistance||100},uDiffusionCenter:{value:l?.diffusion?.center||new et.Vector3(0,0,0)},uFlowEnabled:{value:l?.flow?.enabled?1:0},uFlowColor:{value:l?.flow?.color||new et.Color("#00E4FF")},uFlowRange:{value:l?.flow?.range||10},uFlowSpeed:{value:l?.flow?.speed||20},uSweepEnabled:{value:l?.sweep?.enabled?1:0},uSweepColor:{value:l?.sweep?.color||new et.Color("#FFFFFF")},uSweepWidth:{value:l?.sweep?.width||1.5},uSweepSpeed:{value:l?.sweep?.speed||10},uRegionOverlayEnabled:{value:u?1:0},uRegionOverlayColor:{value:this.regionOverlay?.color||new et.Color("#00FF88")},uRegionOverlayOpacity:{value:this.regionOverlay?.opacity??0},uRegionOverlayVertexCount:{value:this.regionOverlay?.vertexCount??0},uRegionOverlayVertices:{value:this.regionOverlay?.vertices||new Array(ia).fill(0).map(()=>new et.Vector2(0,0))}},e.vertexShader=`
      varying vec3 vWorldPosition;
      varying vec3 vPosition;
      varying float vHeight;
      ${e.vertexShader}
    `.replace("#include <begin_vertex>",`
      #include <begin_vertex>
      vWorldPosition = (modelMatrix * vec4(position, 1.0)).xyz;
      vPosition = position;
      vHeight = position.y;
      `),e.fragmentShader=`
      #define PI 3.141592653589793
      #define REGION_OVERLAY_MAX_VERTS 64
      varying vec3 vWorldPosition;
      varying vec3 vPosition;
      varying float vHeight;
      uniform float uMinY;
      uniform float uMaxY;
      uniform float uHeightRange;
      uniform float uMinRate;
      uniform float uMaxRate;
      uniform float time;
      uniform float uStartTime;
      uniform int uDiffusionEnabled;
      uniform vec3 uDiffusionColor;
      uniform float uDiffusionWidth;
      uniform float uDiffusionSpeed;
      uniform float uDiffusionMaxDistance;
      uniform vec3 uDiffusionCenter;
      uniform int uFlowEnabled;
      uniform vec3 uFlowColor;
      uniform float uFlowRange;
      uniform float uFlowSpeed;
      uniform int uSweepEnabled;
      uniform vec3 uSweepColor;
      uniform float uSweepWidth;
      uniform float uSweepSpeed;

       // 区域多边形外衣相关 uniform 声明（之前缺少）
      uniform int uRegionOverlayEnabled;
      uniform vec3 uRegionOverlayColor;
      uniform float uRegionOverlayOpacity;
      uniform int uRegionOverlayVertexCount;
      uniform vec2 uRegionOverlayVertices[REGION_OVERLAY_MAX_VERTS];
      
      
      float distanceTo(vec2 src, vec2 dst) {
        return distance(src, dst);
      }
      
      ${e.fragmentShader}
    `.replace("#include <color_fragment>",`
      #include <color_fragment>
      
      // 高度渐变计算
      float normalizedHeight = clamp((vWorldPosition.y - uMinY) / uHeightRange, 0.0, 1.0);
      float heightFactor = smoothstep(0.0, 1.0, normalizedHeight);
      diffuseColor.rgb *= mix(uMinRate, uMaxRate, heightFactor);
      
      // 圆环扩散效果
      if (uDiffusionEnabled == 1) {
        vec2 position2D = vec2(vWorldPosition.x, vWorldPosition.z);
        vec2 center2D = vec2(uDiffusionCenter.x, uDiffusionCenter.z);
        float distToCenter = distance(position2D, center2D);
        
        float progress = mod(time * uDiffusionSpeed, 1.0);
        float currentRadius = progress * uDiffusionMaxDistance;
        
        if (distToCenter > currentRadius - uDiffusionWidth && 
            distToCenter < currentRadius) {
            float ringFactor = smoothstep(
                currentRadius - uDiffusionWidth,
                currentRadius,
                distToCenter
            );
            
            vec3 highBrightnessColor = uDiffusionColor * 5.0;
            diffuseColor.rgb += highBrightnessColor * (1.0 - ringFactor);
            diffuseColor.rgb = min(diffuseColor.rgb, vec3(2.0));
        }
      }
      
      // 流光效果
      if (uFlowEnabled == 1) {
        float dTime = mod(time * uFlowSpeed, uFlowRange * 2.0);
        if (vPosition.z > dTime - uFlowRange && vPosition.z < dTime) {
          float dIndex = sin((dTime - vPosition.z) / uFlowRange * PI);
          diffuseColor.rgb = mix(uFlowColor, diffuseColor.rgb, 1.0 - dIndex);
        }
      }
      
      // 扫光效果
      if (uSweepEnabled == 1) {
        float sweepPos = mod(time * uSweepSpeed, 2.0);
        if (vHeight > sweepPos - uSweepWidth && vHeight < sweepPos) {
          float sweepFactor = smoothstep(sweepPos - uSweepWidth, sweepPos, vHeight);
          diffuseColor.rgb = mix(uSweepColor, diffuseColor.rgb, 1.0 - sweepFactor);
        }
      }
    // 区域多边形外衣叠色（Ray casting 判定点是否在多边形内）
      if (uRegionOverlayEnabled == 1 && uRegionOverlayOpacity > 0.0 && uRegionOverlayVertexCount >= 3) {
        vec2 p = vec2(vWorldPosition.x, vWorldPosition.z);
        bool inside = false;
        int j = 0;
        for (int i = 0; i < REGION_OVERLAY_MAX_VERTS; i++) {
          if (i >= uRegionOverlayVertexCount) break;
          if (i == 0) {
            j = uRegionOverlayVertexCount - 1;
          }
          vec2 pi = uRegionOverlayVertices[i];
          vec2 pj = uRegionOverlayVertices[j];

          bool intersect = ((pi.y > p.y) != (pj.y > p.y)) &&
            (p.x < (pj.x - pi.x) * (p.y - pi.y) / (pj.y - pi.y + 1e-6) + pi.x);
          if (intersect) {
            inside = !inside;
          }
          j = i;
        }

        if (inside) {
          diffuseColor.rgb = mix(
            diffuseColor.rgb,
            uRegionOverlayColor,
            clamp(uRegionOverlayOpacity, 0.0, 1.0)
          );
        }
      }
      `)}setDiffusionFromObject(e){if(!this.shaderOption.effects?.diffusion)return;const t=new et.Box3().setFromObject(e);if(t.isEmpty())return;const r=new et.Vector3;t.getCenter(r);const i=[new et.Vector3(t.min.x,t.min.y,t.min.z),new et.Vector3(t.max.x,t.max.y,t.max.z)];let o=0;i.forEach(l=>{const c=r.distanceTo(l);c>o&&(o=c)}),this.shaderOption.effects.diffusion={...this.shaderOption.effects.diffusion,center:r,maxDistance:o},this.needsUpdate=!0}updateBoundingBox(e,t){this.shaderOption.minY=e,this.shaderOption.maxY=t,this.needsUpdate=!0}updateEffects(e){this.shaderOption.effects={...this.shaderOption.effects,...e},this.needsUpdate=!0}animate(){requestAnimationFrame(()=>this.animate()),this.time.value=this.clock.getElapsedTime(),this.startTime.value<1&&(this.startTime.value+=.01)}}var I_=Object.defineProperty,F_=(s,e,t)=>e in s?I_(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Kt=(s,e,t)=>F_(s,typeof e!="symbol"?e+"":e,t);const T_={emissive:!1,emissiveIntensity:1,emissiveColor:"#ffffff"};class jc extends Zt{constructor(e){super(e),Kt(this,"_type","Model"),Kt(this,"_emissive",!1),Kt(this,"_emissiveIntensity",1),Kt(this,"_emissiveColor","#ffffff"),Kt(this,"_mixer",null),Kt(this,"_currentAction",null),Kt(this,"_animations",[]),Kt(this,"_clock",new f.Clock),Kt(this,"_autoUpdate",!0),Kt(this,"_animationRequestId",null),Kt(this,"_iscity",!1),this._emissive=e.emissive||!1,this._emissiveIntensity=e.emissiveIntensity||1,this._emissiveColor=e.emissiveColor||"#ffffff",this.castShadow=e.castShadow||!1,this.receiveShadow=e.receiveShadow||!1,this._iscity=e.iscity||!1}async _buildRenderObject(){if(this._worldCoordinates=this._coordsTransform(),this._style){if(this._renderObject&&this._disposeGeometry(),this.modelunino=await this._createObject(this._style),this._renderObject=this.modelunino.model,!this._renderObject){console.error("Model load failed: model returned by _createObject is undefined"),console.error("模型加载失败：_createObject返回的model为undefined");return}this._renderObject.userData._type="Model",this.modelunino.animations&&this.modelunino.animations.length>0&&(this._animations=this.modelunino.animations,this._mixer=new f.AnimationMixer(this._renderObject),this._startAnimationLoop(),this.playAnimation({name:this._animations[0].name,loop:!0,speed:1.5,fadeInDuration:.5,fadeOutDuration:.3})),this._refreshCoordinates(),this.setShadows({cast:this.castShadow,receive:this.receiveShadow}),this._applyEmissionProperties(),this._iscity&&this._rendercity()}}async _createObject(e){switch(e.config.type){case"fbx":case"gltf":return Rm(e.config,this._worldCoordinates);default:throw new Error(`Unsupported style type: ${e.config.type}`)}}_applyEmissionProperties(){this._renderObject&&this._renderObject.traverse(e=>{if("material"in e){const t=e.material;t&&(t.emissiveIntensity=this._emissive?this._emissiveIntensity:0,t.emissive&&t.emissive.setStyle(this._emissiveColor))}})}get emissive(){return this._emissive}set emissive(e){this._emissive=e,this._applyEmissionProperties()}get emissiveIntensity(){return this._emissiveIntensity}set emissiveIntensity(e){this._emissiveIntensity=e,this._applyEmissionProperties()}get emissiveColor(){return this._emissiveColor}set emissiveColor(e){this._emissiveColor=e,this._applyEmissionProperties()}setEmission(e,t,r){this._emissive=e,t!==void 0&&(this._emissiveIntensity=t),r!==void 0&&(this._emissiveColor=r),this._applyEmissionProperties()}async setShadows(e){this.castShadow=e.cast,this.receiveShadow=e.receive,this._renderObject&&this._renderObject.traverse(t=>{t.isMesh&&t.material&&(t.castShadow=e.cast,t.receiveShadow=e.receive)})}setBloom(e,t){return this.userData.bloom=e,this._renderObject&&this._renderObject.traverse(r=>{r instanceof f.Mesh&&(r.userData.originalMaterial||(r.userData.originalMaterial=r.material),e?Array.isArray(r.material)?r.material.forEach(i=>{"emissive"in i&&(i.emissive.setHex(16777215),i.emissiveIntensity=.5)}):"emissive"in r.material&&(r.material.emissive.setHex(16777215),r.material.emissiveIntensity=.5):Array.isArray(r.material)?r.material.forEach(i=>{"emissive"in i&&(i.emissive.setHex(0),i.emissiveIntensity=0)}):"emissive"in r.material&&(r.material.emissive.setHex(0),r.material.emissiveIntensity=0))}),this}playAnimation(e){if(!this._mixer||this._animations.length===0){console.warn("No available animations for model"),console.warn("模型没有可用的动画");return}this._currentAction&&(e.fadeOutDuration&&e.fadeOutDuration>0?this._currentAction.fadeOut(e.fadeOutDuration):this._currentAction.stop());const t=typeof e.name=="number"?this._animations[e.name]:this._animations.find(r=>r.name===e.name);if(!t){console.warn(`Animation not found: ${e.name}`),console.warn(`找不到动画: ${e.name}`);return}this._currentAction=this._mixer.clipAction(t),this._currentAction.setLoop(e.loop?f.LoopRepeat:f.LoopOnce,e.loop?1/0:1),this._currentAction.timeScale=e.speed||1,this._currentAction.time=e.startAt||0,this._currentAction.setEffectiveWeight(e.weight||1),e.fadeInDuration&&e.fadeInDuration>0&&this._currentAction.fadeIn(e.fadeInDuration),this._currentAction.play(),this._autoUpdate&&this._animationRequestId===null&&this._startAnimationLoop()}stopAnimation(e={}){this._currentAction&&(e.fadeDuration&&e.fadeDuration>0?(this._currentAction.fadeOut(e.fadeDuration),setTimeout(()=>{this._currentAction&&(this._currentAction.stop(),this._currentAction=null)},e.fadeDuration*1e3)):(this._currentAction.stop(),this._currentAction=null))}setAnimationPaused(e){this._currentAction&&(this._currentAction.paused=e.paused)}setAnimationSpeed(e){this._currentAction&&(this._currentAction.timeScale=e.speed)}updateAnimation(e){this._mixer&&this._mixer.update(e.deltaTime)}getAnimationNames(){return this._animations.map(e=>e.name)}getCurrentAnimationName(){return this._currentAction?this._currentAction.getClip().name:null}getAnimationDuration(e){let t;return typeof e.name=="number"?t=this._animations[e.name]:t=this._animations.find(r=>r.name===e.name),t?t.duration:null}dispose(){this._stopAnimationLoop(),this._mixer&&(this._mixer.stopAllAction(),this._mixer.uncacheRoot(this._renderObject)),super.dispose()}_startAnimationLoop(){if(!this._autoUpdate||this._animationRequestId!==null)return;const e=()=>{if(this._mixer){const t=this._clock.getDelta();this._mixer.update(t)}this._animationRequestId=requestAnimationFrame(e)};this._clock.start(),this._animationRequestId=requestAnimationFrame(e)}_stopAnimationLoop(){this._animationRequestId!==null&&(cancelAnimationFrame(this._animationRequestId),this._animationRequestId=null),this._clock.stop()}setAutoUpdate(e){this._autoUpdate=e,e?this._startAnimationLoop():this._stopAnimationLoop()}_computeOverlayVertices(e){const t=e.feature;if(t&&Array.isArray(t._vertexPoints)&&t._vertexPoints.length>=6){const u=t.getMap?.()||this.getMap();if(u&&u.prjcenter){const d=u.prjcenter,m=t._vertexPoints,p=[];for(let _=0;_+2<m.length;_+=3){const v=m[_],S=m[_+2],M=d.x+v,x=d.z+S;p.push(new f.Vector2(M,x))}if(p.length>=3)return p}}const r=this.getMap();if(!r||!e.geometry)return null;const i=e.geometry;let o;if(i.type==="Polygon")o=i.coordinates;else if(i.type==="MultiPolygon"){if(!i.coordinates.length)return null;o=i.coordinates[0]}else return null;if(!o.length||!o[0].length)return null;const l=o[0],c=[];for(const u of l){const d=u[0],m=u[1],p=r.projectToWorld(new f.Vector3(d,m,0));c.push(new f.Vector2(p.x,p.z))}return c.length<3?null:c}_rendercity(){const e=this.getLayer();let t=null;if(e&&e.getRegionOverlays){const r=e.getRegionOverlays()||[];if(r.length){const i=r.filter(l=>(l.mode??"overlay")==="overlay").sort((l,c)=>(l.zIndex??0)-(c.zIndex??0)),o=i[i.length-1];if(o&&(o.geometry||o.feature)){const l=this._computeOverlayVertices(o);l&&l.length>=3&&(t={color:new f.Color(o.color??"#00FF88"),opacity:o.opacity??.3,vertices:l})}}}this.traverse(async r=>{if(r instanceof f.Mesh&&r.material){if(r.castShadow=!0,r.name==="building"){const i=new D_({color:new f.Color("#6BA7EC").multiplyScalar(1.8),opacity:.9,shaderOption:{minY:0,maxY:50,minRate:.3,maxRate:1.5,effects:{diffusion:{enabled:!0,color:new f.Color("#FFFFF"),width:300,speed:.05},flow:{enabled:!1,color:new f.Color("#FFFFF"),range:1e3,speed:3e3},sweep:{enabled:!0,color:new f.Color("#ffffff"),width:3,speed:5}}},regionOverlay:t||void 0}),o=new f.Box3().setFromObject(r);i.updateBoundingBox(o.min.y,o.max.y),i.setDiffusionFromObject(r),r.receiveShadow=!1,r.material=i,r.material.needsUpdate=!0}r.name==="grass"&&(r.castShadow=!1,r.receiveShadow=!0,r.material.color=new f.Color("#81e4d8ff)").multiplyScalar(.7),r.material.metalness=.2,r.material.roughness=.8,["metalnessMap","normalMap","roughnessMap","specularColorMap"].forEach(i=>{const o=r.material[i];o&&(o.wrapS=o.wrapT=f.RepeatWrapping,o.repeat.set(.3,.3),o.needsUpdate=!0)}),r.material.normalScale=new f.Vector2(3,3))}})}}jc.mergeOptions(T_);var B_=Object.defineProperty,U_=(s,e,t)=>e in s?B_(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,V_=(s,e,t)=>U_(s,e+"",t);const k_={};class $c extends Zt{constructor(e){super(e),V_(this,"_type","Cloud")}async _buildRenderObject(){this._worldCoordinates=this._coordsTransform(),this._style&&(this._renderObject&&this._disposeGeometry(),this._renderObject=await this._createObject(this._style),this._refreshCoordinates())}_refreshCoordinates(){this._disposeGeometry();const e=this.getLayer();this._renderObject&&(this._renderObject.position.copy(this._worldCoordinates),this._renderObject.renderOrder=99,e&&(e._clouds.add(this._renderObject),e._clouds.updateMatrixWorld()))}async _createObject(e){if(e.config.type==="cloud")return Zm(e.config,this._worldCoordinates);throw new Error(`Unsupported style type: ${e.config.type}`)}}$c.mergeOptions(k_);var z_=Object.defineProperty,N_=(s,e,t)=>e in s?z_(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,W_=(s,e,t)=>N_(s,e+"",t);const G_={};class Xc extends Zt{constructor(e){super(e),W_(this,"_type","Label")}async _buildRenderObject(){this._worldCoordinates=this._coordsTransform(),this._style&&(this._renderObject&&this._disposeGeometry(),this._renderObject=await this._createObject(this._style),this._refreshCoordinates())}_refreshCoordinates(){this._worldCoordinates=this._coordsTransform(),this._renderObject?(this._renderObject.position.copy(this._worldCoordinates),this.children.includes(this._renderObject)||this.add(this._renderObject),this.updateMatrixWorld(!0),this._renderObject.updateMatrixWorld(!0)):this._buildRenderObject()}async _createObject(e){switch(e.config.type){case"canvas-label-fixed":return qm(e.config,new f.Vector3(0,0,0),this.getMap());case"canvas-label":return Km(e.config,new f.Vector3(0,0,0));default:throw new Error(`Unsupported style type: ${e.config.type}`)}}}Xc.mergeOptions(G_);var R_=Object.defineProperty,j_=(s,e,t)=>e in s?R_(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Yc=(s,e,t)=>j_(s,typeof e!="symbol"?e+"":e,t);const $_={};class Zc extends Zt{constructor(e){super(e),Yc(this,"_type","TPoints"),Yc(this,"_geometries"),this._geometries=e.geometries}async _buildRenderObject(){this._worldCoordinates=this._coordsTransform(),this._style&&(this._renderObject&&this._disposeGeometry(),this._renderObject=await this._createObject(this._style),this._refreshCoordinates())}_refreshCoordinates(){this._renderObject&&(this._renderObject.points&&this.add(this._renderObject.points),this._renderObject.InstancedCol&&this.add(this._renderObject.InstancedCol),this.updateMatrixWorld(!0))}async _createObject(e){if(e.config.type==="light")return ng(e.config,this._geometries,this.getMap());throw new Error(`Unsupported style type: ${e.config.type}`)}}Zc.mergeOptions($_);var X_=Object.defineProperty,Y_=(s,e,t)=>e in s?X_(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Gr=(s,e,t)=>Y_(s,typeof e!="symbol"?e+"":e,t);class Mn extends zr(Object){constructor(e,t){super(),Gr(this,"options"),Gr(this,"map"),Gr(this,"_sprite",null),Gr(this,"_isDragging",!1),Gr(this,"_dragStartPosition",null),Gr(this,"_lastCoordinate",null),Gr(this,"_boundOnMouseMove",null),Gr(this,"_boundOnMouseUp",null),this.map=t,this.options={position:e.position,index:e.index,symbol:e.symbol??0,size:e.size??8,color:e.color??"#ffffff",opacity:e.opacity??.9,draggable:e.draggable??!0},this._createSprite(),this._boundOnMouseMove=this._onMouseMove.bind(this),this._boundOnMouseUp=this._onMouseUp.bind(this)}_createSprite(){const t=document.createElement("canvas"),r=t.getContext("2d");t.width=64,t.height=64;const i=64/2,o=64/2-2;r.clearRect(0,0,t.width,t.height),r.beginPath(),r.arc(i,i,o,0,2*Math.PI),r.fillStyle="#000000",r.fill(),r.beginPath(),r.arc(i,i,o-2,0,2*Math.PI),r.fillStyle=this.options.color,r.fill();const l=new f.CanvasTexture(t);l.needsUpdate=!0;const c=new f.SpriteMaterial({map:l,opacity:this.options.opacity,transparent:!0,depthTest:!1,depthWrite:!1,sizeAttenuation:!0});this._sprite=new f.Sprite(c),this._sprite.position.copy(this.options.position),this._sprite.renderOrder=999999;const u=new f.Vector2;this._sprite.onBeforeRender=(d,m,p)=>{if(!this._sprite||!p)return;const _=p.position.distanceTo(this._sprite.position);d.getSize(u);const v=d.getPixelRatio(),S=this.options.size*v;let M=1;if(p.isPerspectiveCamera){const x=p.fov*Math.PI/180,O=2*Math.tan(x/2)*_;M=S/u.y*O}else if(p.isOrthographicCamera){const x=p.top,O=p.bottom,P=Math.abs(x-O)/p.zoom;M=S/u.y*P}this._sprite.scale.set(M,M,1)},this._sprite._editHandle=this,this.map.viewer.scene.add(this._sprite)}updatePosition(e){this.options.position=e,this._sprite&&this._sprite.position.copy(e)}getPosition(){return this.options.position.clone()}getIndex(){return this.options.index}getSymbol(){return this.options.symbol}getSprite(){return this._sprite}intersect(e){return!this._sprite||!this.options.draggable?!1:e.intersectObject(this._sprite).length>0}startDrag(e){this.options.draggable&&(this._isDragging=!0,this._dragStartPosition=this.options.position.clone(),this._lastCoordinate=e,this.map.viewer.config("draggable",!1),this.map.on("mousemove",this._boundOnMouseMove),this.map.on("mouseup",this._boundOnMouseUp),this.trigger("dragstart",{target:this,coordinate:e,position:this.options.position.clone()}))}_onMouseMove(e){if(!this._isDragging||!this._lastCoordinate)return;const t=e.coordinate,r=t[0]-this._lastCoordinate[0],i=t[1]-this._lastCoordinate[1],o=this.map.unprojectFromWorld(this.options.position),l=this.map.projectToWorld(new f.Vector3(t[0],t[1],o.z));this.updatePosition(l),this._lastCoordinate=t,this.trigger("dragging",{target:this,coordinate:t,position:this.options.position.clone(),offset:{dx:r,dy:i}})}_onMouseUp(e){this._isDragging&&(this._isDragging=!1,this.map.viewer.config("draggable",!0),this.map.off("mousemove",this._boundOnMouseMove),this.map.off("mouseup",this._boundOnMouseUp),this.trigger("dragend",{target:this,coordinate:e.coordinate,position:this.options.position.clone(),startPosition:this._dragStartPosition}),this._dragStartPosition=null,this._lastCoordinate=null)}show(){this._sprite&&(this._sprite.visible=!0)}hide(){this._sprite&&(this._sprite.visible=!1)}remove(){if(this._isDragging&&(this._isDragging=!1,this.map.viewer.config("draggable",!0),this.map.off("mousemove",this._boundOnMouseMove),this.map.off("mouseup",this._boundOnMouseUp)),this._sprite){this.map.viewer.scene.remove(this._sprite);const e=this._sprite.material;e.map&&e.map.dispose(),e.dispose(),this._sprite=null}this._dragStartPosition=null,this._lastCoordinate=null,this._boundOnMouseMove=null,this._boundOnMouseUp=null}}function na(s,e,t){const{currentTarget:r,clientX:i,clientY:o}=s;if(r instanceof HTMLElement){const l=r.clientWidth,c=r.clientHeight,u=new f.Vector2(i/l*2-1,-(o/c)*2+1);return wo(t,e,u)?.location}else return}var Z_=Object.defineProperty,K_=(s,e,t)=>e in s?Z_(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,rt=(s,e,t)=>K_(s,typeof e!="symbol"?e+"":e,t);class q_ extends cs{constructor(e,t){super(e),rt(this,"options"),rt(this,"_handles",[]),rt(this,"_middleHandles",[]),rt(this,"_middleHandleColor","rgba(255, 255, 255, 0.6)"),rt(this,"_editing",!1),rt(this,"_shadow",null),rt(this,"_shadowSnapshot",null),rt(this,"_updating",!1),rt(this,"_history",[]),rt(this,"_historyIndex",-1),rt(this,"_draggableOriginalState",!1),rt(this,"_boundOnMapMouseMove",null),rt(this,"_boundOnMapClick",null),rt(this,"_boundOnMapMouseDown",null),rt(this,"_boundOnFeatureDragging",null),rt(this,"_boundOnFeatureDragEnd",null),this.options={handleSize:t?.handleSize??8,handleColor:t?.handleColor??"#ffffff",showMiddleHandles:t?.showMiddleHandles??!1,maxHistorySize:t?.maxHistorySize??20,removeVertexOn:t?.removeVertexOn??"contextmenu"},this._boundOnMapMouseMove=this._onMapMouseMove.bind(this),this._boundOnMapClick=this._onMapClick.bind(this),this._boundOnMapMouseDown=this._onMapMouseDown.bind(this),this._boundOnFeatureDragging=this._onFeatureDragging.bind(this),this._boundOnFeatureDragEnd=this._onFeatureDragEnd.bind(this)}enable(){return this._editing?this:(super.enable(),this._editing=!0,this._createShadow(),this._saveSnapshot(),this._setFeatureEditingStyle(!0),this._createHandles(),this.target.trigger("editstart"),this._draggableOriginalState=this.target.options.draggable||!1,this._draggableOriginalState||(this.target.options.draggable=!0,this.target.draggable&&this.target.draggable.enable()),this)}disable(){return this._editing?(super.disable(),this._editing=!1,this._clearHandles(),this._setFeatureEditingStyle(!1),this._draggableOriginalState||(this.target.options.draggable=!1,this.target.draggable&&this.target.draggable.disable()),this._draggableOriginalState=!1,this._updateCoordFromShadow(),this._removeShadow(),this.target.trigger("editend"),this):this}addHooks(){const e=this._getMap();e&&(e.on("mousemove",this._boundOnMapMouseMove),e.on("click",this._boundOnMapClick),e.viewer.container&&e.viewer.container.addEventListener("mousedown",this._boundOnMapMouseDown,!0),this.options.removeVertexOn==="contextmenu"&&e.on("contextmenu",this._boundOnMapClick)),this.target.on("dragging",this._boundOnFeatureDragging),this.target.on("dragend",this._boundOnFeatureDragEnd)}removeHooks(){const e=this._getMap();e&&(e.off("mousemove",this._boundOnMapMouseMove),e.off("click",this._boundOnMapClick),e.viewer.container&&e.viewer.container.removeEventListener("mousedown",this._boundOnMapMouseDown,!0),this.options.removeVertexOn==="contextmenu"&&e.off("contextmenu",this._boundOnMapClick)),this.target.off("dragging",this._boundOnFeatureDragging),this.target.off("dragend",this._boundOnFeatureDragEnd)}isEditing(){return this._editing}_createShadow(){this._shadow=null}_removeShadow(){this._shadow&&(this._shadow=null),this._shadowSnapshot=null}_updateCoordFromShadow(e=!1){e&&!this._updating&&this.target._refreshCoordinates()}_saveSnapshot(){const e=this.target._geometry;this._shadowSnapshot={type:e.type,coordinates:JSON.parse(JSON.stringify(e.coordinates))},this._addHistory(e.coordinates)}_addHistory(e){this._historyIndex<this._history.length-1&&(this._history=this._history.slice(0,this._historyIndex+1)),this._history.push({coordinates:JSON.parse(JSON.stringify(e)),timestamp:Date.now()}),this._history.length>this.options.maxHistorySize?this._history.shift():this._historyIndex++}undo(){if(this._historyIndex>0){this._historyIndex--;const e=this._history[this._historyIndex];this._restoreCoordinates(e.coordinates),this.target.trigger("editundo")}return this}redo(){if(this._historyIndex<this._history.length-1){this._historyIndex++;const e=this._history[this._historyIndex];this._restoreCoordinates(e.coordinates),this.target.trigger("editredo")}return this}_restoreCoordinates(e){const t=this.target._geometry;t.coordinates=JSON.parse(JSON.stringify(e)),this.target._refreshCoordinates(),this._updateHandlePositions()}cancel(){return this._shadowSnapshot&&this._restoreCoordinates(this._shadowSnapshot.coordinates),this.disable(),this}_createHandles(){const e=this.target._geometry,t=this._getMap();if(!t){console.warn("[FeatureEditHandler] No map found, cannot create handles");return}this.target instanceof Zt?this._createPointHandles(e,t):this.target instanceof pt?this._createLineStringHandles(e,t):this.target instanceof fr&&this._createPolygonHandles(e,t)}_createPointHandles(e,t){const r=e.coordinates,i=t.projectToWorld(new f.Vector3(r[0],r[1],r[2]||0)),o=new Mn({position:i,index:0,symbol:0,size:this.options.handleSize,color:this.options.handleColor},t);o.on("dragstart",l=>{this._onHandleDragStart(l,0)}),o.on("dragging",l=>{this._onHandleDragging(l,0)}),o.on("dragend",l=>{this._onHandleDragEnd(l,0)}),this._handles.push(o)}_createLineStringHandles(e,t){const r=e.coordinates;r.forEach((i,o)=>{const l=t.projectToWorld(new f.Vector3(i[0],i[1],i[2]||0)),c=new Mn({position:l,index:o,symbol:0,size:this.options.handleSize,color:this.options.handleColor},t);c.on("dragstart",u=>{this._onHandleDragStart(u,o)}),c.on("dragging",u=>{this._onHandleDragging(u,o)}),c.on("dragend",u=>{this._onHandleDragEnd(u,o)}),this._handles.push(c)}),this.options.showMiddleHandles&&this._createLineStringMiddleHandles(r,t)}_onHandleDragging(e,t){this._updating=!0;const i=e.target.getPosition();if(!this._getMap())return;const l=this._fixHandlePointCoordinates(i,t),c=this.target._geometry;this.target instanceof Zt?c.coordinates=[l.x,l.y,l.z]:this.target instanceof pt&&(c.coordinates[t]=[l.x,l.y,l.z]),this.target._refreshCoordinates(),this.target.trigger("handledragging",{index:t,coordinate:[l.x,l.y,l.z]}),this.target.trigger("editing",{index:t,coordinate:[l.x,l.y,l.z]}),this._updating=!1}_onHandleDragStart(e,t){this._updating=!0,this.target.trigger("handledragstart",{index:t,coordinate:e.coordinate})}_onHandleDragEnd(e,t){this._updating=!1;const r=this.target._geometry;this._addHistory(r.coordinates),this.target.trigger("handledragend",{index:t,coordinate:this.target instanceof Zt?r.coordinates:r.coordinates[t]}),this.target.trigger("editvertex",{index:t,coordinate:this.target instanceof Zt?r.coordinates:r.coordinates[t]})}_createPolygonHandles(e,t){const r=e.coordinates;if(!r||!Array.isArray(r)||r.length===0){console.warn("[FeatureEditHandler] Invalid polygon coordinates");return}r.forEach((o,l)=>{if(!o||o.length<3)return;const c=o[0][0]===o[o.length-1][0]&&o[0][1]===o[o.length-1][1]?o.length-1:o.length;for(let u=0;u<c;u++){const d=o[u],m=t.projectToWorld(new f.Vector3(d[0],d[1],d[2]||0)),p=new Mn({position:m,index:u,symbol:0,size:this.options.handleSize,color:this.options.handleColor},t);p._ringIndex=l,p.on("dragstart",_=>{this._onPolygonHandleDragStart(_,u,l)}),p.on("dragging",_=>{this._onPolygonHandleDragging(_,u,l)}),p.on("dragend",_=>{this._onPolygonHandleDragEnd(_,u,l)}),this._handles.push(p)}this.options.showMiddleHandles&&this._createPolygonMiddleHandles(o,l,t)})}_onPolygonHandleDragStart(e,t,r){this._updating=!0,this.target.trigger("handledragstart",{index:t,ringIndex:r,coordinate:e.coordinate})}_onPolygonHandleDragging(e,t,r){const o=e.target.getPosition();if(!this._getMap())return;const c=this._fixHandlePointCoordinates(o,t,r),d=this.target._geometry.coordinates;if(d[r]&&d[r][t]&&(d[r][t]=[c.x,c.y,c.z],t===0&&d[r].length>1)){const m=d[r].length-1;d[r][m]=[c.x,c.y,c.z]}this.target._refreshCoordinates(),this.target.trigger("handledragging",{index:t,ringIndex:r,coordinate:[c.x,c.y,c.z]}),this.target.trigger("editing",{index:t,ringIndex:r,coordinate:[c.x,c.y,c.z]})}_onPolygonHandleDragEnd(e,t,r){this._updating=!1;const i=this.target._geometry,o=i.coordinates;this._addHistory(i.coordinates),this.target.trigger("handledragend",{index:t,ringIndex:r,coordinate:o[r]?.[t]||null}),this.target.trigger("editvertex",{index:t,ringIndex:r,coordinate:o[r]?.[t]||null})}_updateHandlePositions(){const e=this.target._geometry,t=this._getMap();if(t){if(this.target instanceof Zt){const r=e.coordinates,i=t.projectToWorld(new f.Vector3(r[0],r[1],r[2]||0));this._handles[0]&&this._handles[0].updatePosition(i)}else if(this.target instanceof pt)e.coordinates.forEach((i,o)=>{const l=t.projectToWorld(new f.Vector3(i[0],i[1],i[2]||0));this._handles[o]&&this._handles[o].updatePosition(l)});else if(this.target instanceof fr){const r=e.coordinates;let i=0;r.forEach(o=>{const l=o[0][0]===o[o.length-1][0]&&o[0][1]===o[o.length-1][1]?o.length-1:o.length;for(let c=0;c<l;c++){const u=o[c],d=t.projectToWorld(new f.Vector3(u[0],u[1],u[2]||0));this._handles[i]&&this._handles[i].updatePosition(d),i++}})}}}_clearHandles(){this._handles.forEach(e=>e.remove()),this._handles=[],this._middleHandles.forEach(e=>e.remove()),this._middleHandles=[]}_onFeatureDragging(e){this._updateHandlePositions(),this.options.showMiddleHandles&&this._updateMiddleHandlePositions()}_onFeatureDragEnd(e){const t=this.target._geometry;this._addHistory(t.coordinates),this._updateHandlePositions(),this.options.showMiddleHandles&&this._updateMiddleHandlePositions()}_updateMiddleHandlePositions(){const e=this.target._geometry,t=this._getMap();if(!t)return;let r=0;if(this.target instanceof pt){const i=e.coordinates;for(let o=0;o<i.length-1&&!(r>=this._middleHandles.length);o++){const l=i[o],c=i[o+1],u=[(l[0]+c[0])/2,(l[1]+c[1])/2,((l[2]||0)+(c[2]||0))/2],d=t.projectToWorld(new f.Vector3(u[0],u[1],u[2]));this._middleHandles[r].updatePosition(d),r++}}else this.target instanceof fr&&e.coordinates.forEach(o=>{const l=o[0][0]===o[o.length-1][0]&&o[0][1]===o[o.length-1][1]?o.length-1:o.length;for(let c=0;c<l&&!(r>=this._middleHandles.length);c++){const u=(c+1)%l,d=o[c],m=o[u],p=[(d[0]+m[0])/2,(d[1]+m[1])/2,((d[2]||0)+(m[2]||0))/2],_=t.projectToWorld(new f.Vector3(p[0],p[1],p[2]));this._middleHandles[r].updatePosition(_),r++}})}_onMapMouseDown(e){const t=this._getMap();if(!t)return;const r=new f.Raycaster;r.params.Points={threshold:.5};const i=e,o=t.viewer.renderer.domElement,l=o.getBoundingClientRect(),c=new f.Vector2((i.clientX-l.left)/l.width*2-1,-((i.clientY-l.top)/l.height)*2+1);r.setFromCamera(c,t.viewer.camera);const u=[...this._handles,...this._middleHandles];for(const d of u)if(d.intersect(r)){const m=na({currentTarget:o,clientX:i.clientX,clientY:i.clientY},t,t.viewer.camera);m&&(d.startDrag([m.x,m.y]),i.stopPropagation&&i.stopPropagation(),i.stopImmediatePropagation&&i.stopImmediatePropagation(),i.preventDefault&&i.preventDefault());return}}_onMapMouseMove(e){}_onMapClick(e){if(!(e.type===this.options.removeVertexOn))return;const r=this._getMap();if(!r)return;const i=new f.Raycaster;i.params.Points={threshold:.5};const o=e.originEvent;if(!o)return;const l=new f.Vector2(o.offsetX/r.viewer.renderer.domElement.clientWidth*2-1,-(o.offsetY/r.viewer.renderer.domElement.clientHeight)*2+1);i.setFromCamera(l,r.viewer.camera);for(let c=0;c<this._handles.length;c++)if(this._handles[c].intersect(i)){this._removeVertex(c),o.stopPropagation&&o.stopPropagation(),o.preventDefault&&o.preventDefault();return}}_setFeatureEditingStyle(e){const t=this.target._renderObject;t&&t.traverse(r=>{r.material&&(e?Array.isArray(r.material)?r.material.forEach(i=>{i.userData._originalOpacity||(i.userData._originalOpacity=i.opacity),i.opacity=Math.min(i.opacity*.6,.6),i.transparent=!0}):(r.material.userData._originalOpacity||(r.material.userData._originalOpacity=r.material.opacity),r.material.opacity=Math.min(r.material.opacity*.6,.6),r.material.transparent=!0):Array.isArray(r.material)?r.material.forEach(i=>{i.userData._originalOpacity!==void 0&&(i.opacity=i.userData._originalOpacity,delete i.userData._originalOpacity)}):r.material.userData._originalOpacity!==void 0&&(r.material.opacity=r.material.userData._originalOpacity,delete r.material.userData._originalOpacity))})}_removeVertex(e){const t=this.target._geometry,r=this._handles[e],i=r.getIndex(),o=r._ringIndex||0;let l=null;if(this.target instanceof pt){const c=t.coordinates;if(c.length<=2){console.warn("[FeatureEditHandler] LineString requires at least 2 vertices");return}l=c[i],c.splice(i,1)}else if(this.target instanceof fr){const u=t.coordinates[o];if(!u)return;const d=u.length>1&&u[0][0]===u[u.length-1][0]&&u[0][1]===u[u.length-1][1],m=d?4:3;if(u.length<=m){console.warn("[FeatureEditHandler] Polygon ring requires at least 3 vertices");return}l=u[i],u.splice(i,1),d&&i===0&&u.length>0&&(u[u.length-1]=[...u[0]])}else return;this.target._refreshCoordinates(),r.remove(),this._handles.splice(e,1),this._updateHandleIndices(),this._addHistory(t.coordinates),this.target.trigger("handleremove",{index:i,ringIndex:o,coordinate:l})}_createLineStringMiddleHandles(e,t){for(let r=0;r<e.length-1;r++){const i=e[r],o=e[r+1],l=[(i[0]+o[0])/2,(i[1]+o[1])/2,((i[2]||0)+(o[2]||0))/2],c=t.projectToWorld(new f.Vector3(l[0],l[1],l[2])),u=new Mn({position:c,index:r,symbol:1,size:this.options.handleSize,color:this._middleHandleColor,opacity:.6},t);u.on("dragstart",d=>{this._onMiddleHandleClick(r,"LineString",0)}),this._middleHandles.push(u)}}_createPolygonMiddleHandles(e,t,r){const i=e[0][0]===e[e.length-1][0]&&e[0][1]===e[e.length-1][1]?e.length-1:e.length;for(let o=0;o<i;o++){const l=(o+1)%i,c=e[o],u=e[l],d=[(c[0]+u[0])/2,(c[1]+u[1])/2,((c[2]||0)+(u[2]||0))/2],m=r.projectToWorld(new f.Vector3(d[0],d[1],d[2])),p=new Mn({position:m,index:o,symbol:1,size:this.options.handleSize,color:this._middleHandleColor,opacity:.6},r);p._ringIndex=t,p.on("dragstart",_=>{this._onMiddleHandleClick(o,"Polygon",t)}),this._middleHandles.push(p)}}_onMiddleHandleClick(e,t,r){const i=this.target._geometry;if(this._getMap()){if(t==="LineString"){const l=i.coordinates,c=l[e],u=l[e+1],d=[(c[0]+u[0])/2,(c[1]+u[1])/2,((c[2]||0)+(u[2]||0))/2];l.splice(e+1,0,d)}else if(t==="Polygon"){const c=i.coordinates[r];if(!c)return;const u=c[0][0]===c[c.length-1][0]&&c[0][1]===c[c.length-1][1]?c.length-1:c.length,d=(e+1)%u,m=c[e],p=c[d],_=[(m[0]+p[0])/2,(m[1]+p[1])/2,((m[2]||0)+(p[2]||0))/2];c.splice(e+1,0,_),c.length>1&&c[0][0]===c[c.length-1][0]&&c[0][1]===c[c.length-1][1]&&e===u-1&&(c[c.length-1]=[...c[0]])}this.target._applyCoordinateChanges(!0),this._clearHandles(),this._createHandles(),this._addHistory(i.coordinates),this.target.trigger("vertexinsert",{index:e+1,ringIndex:r})}}_updateHandleIndices(){if(this.target instanceof pt)this._handles.forEach((e,t)=>{e._index=t});else if(this.target instanceof fr){let e=0;this.target._geometry.coordinates.forEach((i,o)=>{const l=i[0][0]===i[i.length-1][0]&&i[0][1]===i[i.length-1][1]?i.length-1:i.length;for(let c=0;c<l;c++)this._handles[e]&&(this._handles[e]._index=c,this._handles[e]._ringIndex=o),e++})}}_fixHandlePointCoordinates(e,t,r=0){const i=this._getMap();if(!i)return e;const o=this.target._geometry;let l=null;if(this.target instanceof Zt)l=o.coordinates;else if(this.target instanceof pt)l=o.coordinates[t];else if(this.target instanceof fr){const u=o.coordinates;u[r]&&u[r][t]&&(l=u[r][t])}if(!l||!l[2]||l[2]===0)return i.unprojectFromWorld(e);const c=i.unprojectFromWorld(e);return c.z=l[2],c}_getMap(){return this.target.getMap()}remove(){this.disable(),this._history=[],this._historyIndex=-1,this._shadow=null,this._shadowSnapshot=null,this._boundOnMapMouseMove=null,this._boundOnMapClick=null,this._boundOnMapMouseDown=null}}tt.prototype.startEdit=function(s){return this.options?.editable?(this._editor&&this.endEdit(),this._editor=new q_(this,s),this._editor.enable(),this):(console.warn("Feature is not editable. Set editable option to true."),this)},tt.prototype.endEdit=function(){return this._editor&&(this._editor.disable(),this._editor.remove(),delete this._editor),this},tt.prototype.isEditing=function(){return this._editor?this._editor.isEditing():!1},tt.prototype.cancelEdit=function(){return this._editor&&this._editor.cancel(),this},tt.prototype.undoEdit=function(){return this._editor&&this._editor.undo(),this},tt.prototype.redoEdit=function(){return this._editor&&this._editor.redo(),this};function ms(s,e){if(!s||s===!0)return!0;if(!Array.isArray(s))return!!s;switch(s[0]){case"all":return s.slice(1).every(r=>ms(r,e));case"any":return s.slice(1).some(r=>ms(r,e));case"!":return!ms(s[1],e);case"==":{const r=it(s[1],e),i=it(s[2],e);return gs(r)==gs(i)}case"!=":{const r=it(s[1],e),i=it(s[2],e);return gs(r)!=gs(i)}case">":{const r=it(s[1],e),i=it(s[2],e);return Rr(r)>Rr(i)}case"<":{const r=it(s[1],e),i=it(s[2],e);return Rr(r)<Rr(i)}case">=":{const r=it(s[1],e),i=it(s[2],e);return Rr(r)>=Rr(i)}case"<=":{const r=it(s[1],e),i=it(s[2],e);return Rr(r)<=Rr(i)}case"in":{const r=it(s[1],e);return s.slice(2).map(o=>it(o,e)).includes(r)}case"!in":{const r=it(s[1],e);return!s.slice(2).map(o=>it(o,e)).includes(r)}case"has":{const r=s[1];return e!=null&&Object.prototype.hasOwnProperty.call(e,r)}case"!has":{const r=s[1];return!(e!=null&&Object.prototype.hasOwnProperty.call(e,r))}default:return!0}}function it(s,e){return Array.isArray(s)&&s[0]==="get"?e?e[s[1]]:void 0:s}function gs(s){if(s==null)return null;if(typeof s=="string"){const e=Number(s);if(!isNaN(e)&&s.trim()!=="")return e}return typeof s=="boolean"?s?1:0:s}function Rr(s){if(s==null)return 0;if(typeof s=="number")return s;if(typeof s=="boolean")return s?1:0;if(typeof s=="string"){const e=Number(s);return isNaN(e)?0:e}return Number(s)}var Q_=Object.defineProperty,J_=(s,e,t)=>e in s?Q_(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,An=(s,e,t)=>J_(s,typeof e!="symbol"?e+"":e,t);class sa extends Nr{constructor(e,t){super(e,t),An(this,"TILE_SIZE"),An(this,"EXTENT"),An(this,"style"),An(this,"_tileFeatureMap",new Map),An(this,"_activeFeatureFilter"),this.TILE_SIZE=t.tileSize??256,this.EXTENT=t.extent??4096,this.style=t.style||[],this._onMapUpdate=this._onMapUpdate.bind(this)}processTileData(e,t){const r=this.getMap(),i=`${e.z}-${e.x}-${e.y}`,o=this._tileFeatureMap.get(i);if(o&&o.length>0){o.forEach(d=>{d.visible=!0,this.children.some(m=>m&&d&&m.uuid===d.uuid)||d.addTo(this)});return}const l=t.vectorData;if(!l||!l.layers||!r||this.style.length===0)return;const c=[],u=this.style;Object.keys(l.layers).forEach(d=>{const m=l.layers[d];for(let p=0;p<m.length;p++){const _=m[p],v=_.geometry;if(this._activeFeatureFilter&&!this._activeFeatureFilter(_.properties))continue;let S=null;for(const M of u)if(this._evaluateFilter(M.filter,_.properties,d,_.geometry.type)){S=M.style;break}if(S){const M={isVectorTile:!0,tileZ:e.z,tileX:e.x,tileY:e.y,rawCoordinates:v,extent:this.EXTENT,tileSize:this.TILE_SIZE},x=this._createFeatureInstance(_.geometry,_.geometry.type,S,_.properties);x&&(x.userData.tileData=M,x.style=xt.create(S),x.addTo(this),x.initializeGeometry(),c.push(x))}}}),this._tileFeatureMap.set(i,c)}_evaluateFilter(e,t,r,i){if(!e||e===!0)return!0;const o={...t,$layer:r,$type:i};return ms(e,o)}hideFeaturesByTileKey(e){const t=this._tileFeatureMap.get(e);t&&t.forEach(r=>{r.visible=!1})}removeFeaturesByTileKey(e){this._removeFeaturesByTileKey(e)}_removeFeaturesByTileKey(e){const t=this._tileFeatureMap.get(e);t&&(t.forEach(r=>{r._remove()}),this._tileFeatureMap.delete(e))}_createFeatureInstance(e,t,r,i){const l={geometry:{ismvt:!0,...e},style:r,userData:i};switch(t){case"Point":return new wr(l);case"LineString":return new pt(l);default:return null}}setFeatureFilter(e){this._activeFeatureFilter=e}clearFeatureFilter(){this._activeFeatureFilter=void 0}setOpacity(e){this.opacity=e,this._tileFeatureMap.forEach(t=>{t.forEach(r=>{r.material&&(r.material.opacity=e,r.material.transparent=e<1)})})}_onMapUpdate(){}validateFeature(e){return e instanceof tt}dispose(){this._tileFeatureMap.forEach((e,t)=>{this._removeFeaturesByTileKey(t)}),super.dispose()}}var E_=Object.defineProperty,H_=(s,e,t)=>e in s?E_(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,mt=(s,e,t)=>H_(s,typeof e!="symbol"?e+"":e,t);class Kc extends us{constructor(e,t){super(e,t),this.layerId=e,mt(this,"isTileLayer",!0),mt(this,"layerType","base"),mt(this,"isBaseLayer",!1),mt(this,"_enabled",!0),mt(this,"_visible",!0),mt(this,"_rootTile"),mt(this,"_loader"),mt(this,"_LODThreshold",1),mt(this,"isSceneLayer",!1),mt(this,"opacity",1),mt(this,"source"),mt(this,"projection"),mt(this,"minLevel",2),mt(this,"maxLevel",19),this.source=t.source,this.projection=t.projection,this.minLevel=t.minLevel??2,this.maxLevel=t.maxLevel??19,this._LODThreshold=t.LODThreshold??1,this.opacity=t.opacity??1,this.name=`Layer-${e}`,this._loader=this.createLoader(),this._rootTile=new ni,this._rootTile.matrixAutoUpdate=!0,this._rootTile.scale.set(this.projection.mapWidth,this.projection.mapHeight,1),this.add(this._rootTile),this._rootTile.updateMatrix(),this.layerId=e,this.name==="Layer-label-layer"&&this.position.set(0,0,1)}get LODThreshold(){return this._LODThreshold}set LODThreshold(e){this._LODThreshold=e}get loader(){return this._loader}get enabled(){return this._enabled}set enabled(e){this._enabled=e,this._rootTile&&(this._rootTile.visible=e&&this._visible)}get ivisible(){return this._visible&&super._visible}set ivisible(e){this._visible=e,this._rootTile&&(this._rootTile.visible=e&&this._enabled)}update(e){if(!(!this._enabled||!this._visible)){try{this.updateMatrixWorld(!0),this._rootTile.update({camera:e,loader:this._loader,minLevel:this.minLevel,maxLevel:this.maxLevel,LODThreshold:this.LODThreshold})}catch{}console.groupEnd()}}_debugTileTree(){this._rootTile.traverse(e=>{e.isTile&&(e.loaded,e.visible,e.inFrustum,e.loaded)})}_getLODThreshold(){return 1}_getCurrentTileLevel(){let e=0;return this._rootTile.traverse(t=>{t.isTile&&t.loaded&&(e=Math.max(e,t.z))}),`最大层级: ${e}`}dispose(){this.remove(this._rootTile),this._rootTile.reload(this._loader)}reload(){this._rootTile.reload(this._loader)}setElevation(e){this.position.y=e,this.updateMatrix(),this.updateMatrixWorld(!0)}raiseElevation(e){this.position.z+=e,this.updateMatrix(),this.updateMatrixWorld(!0)}getElevation(){return this.position.y}}class qc extends f.MeshStandardMaterial{constructor(e={}){super({transparent:!0,side:f.FrontSide,...e})}setTexture(e){this.map=e,this.needsUpdate=!0}dispose(){const e=this.map;e&&(e.image instanceof ImageBitmap&&e.image.close(),e.dispose())}}var Xe=(s=>(s[s.Unknown=0]="Unknown",s[s.Point=1]="Point",s[s.Linestring=2]="Linestring",s[s.Polygon=3]="Polygon",s))(Xe||{});class Qc{render(e,t,r,i,o=1){switch(e.lineCap="round",e.lineJoin="round",(i.shadowBlur??0)>0&&(e.shadowBlur=i.shadowBlur??2,e.shadowColor=i.shadowColor??"black",e.shadowOffsetX=i.shadowOffset?i.shadowOffset[0]:0,e.shadowOffsetY=i.shadowOffset?i.shadowOffset[1]:0),t){case Xe.Point:e.textAlign="center",e.textBaseline="middle",e.font=i.font??"14px Arial",e.fillStyle=i.fontColor??"white",this._renderPointText(e,r,o,i.textField??"name",i.fontOffset??[0,-8]);break;case Xe.Linestring:this._renderLineString(e,r,o);break;case Xe.Polygon:this._renderPolygon(e,r,o);break;default:console.warn(`Unknown feature type: ${t}`)}(i.fill||t===Xe.Point)&&(e.globalAlpha=i.fillOpacity||.5,e.fillStyle=i.fillColor||i.color||"#3388ff",e.fill(i.fillRule||"evenodd")),(i.stroke??!0)&&(i.weight??1)>0&&(e.globalAlpha=i.opacity||1,e.lineWidth=i.weight||1,e.strokeStyle=i.color||"#3388ff",e.setLineDash(i.dashArray||[]),e.stroke())}_renderPointText(e,t,r=1,i="name",o=[0,0]){const l=t.geometry;e.beginPath();for(const u of l)for(let d=0;d<u.length;d++){const m=u[d];e.arc(m.x*r,m.y*r,2,0,2*Math.PI)}const c=t.properties;c&&c[i]&&e.fillText(c[i],l[0][0].x*r+o[0],l[0][0].y*r+o[1])}_renderLineString(e,t,r){const i=t.geometry;e.beginPath();for(const o of i)for(let l=0;l<o.length;l++){const{x:c,y:u}=o[l];l===0?e.moveTo(c*r,u*r):e.lineTo(c*r,u*r)}}_renderPolygon(e,t,r){const i=t.geometry;e.beginPath();for(let o=0;o<i.length;o++){const l=i[o];for(let c=0;c<l.length;c++){const{x:u,y:d}=l[c];c===0?e.moveTo(u*r,d*r):e.lineTo(u*r,d*r)}e.closePath()}}}var e0=Object.defineProperty,t0=(s,e,t)=>e in s?e0(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,r0=(s,e,t)=>t0(s,e+"",t);class Jc extends f.LoadingManager{constructor(){super(...arguments),r0(this,"onParseEnd")}parseEnd(e){this.onParseEnd&&this.onParseEnd(e)}}var i0=Object.defineProperty,n0=(s,e,t)=>e in s?i0(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,_s=(s,e,t)=>n0(s,typeof e!="symbol"?e+"":e,t);class Ve{static registerMaterialLoader(e){this.materialLoaders.set(e.dataType,e),this.ensureAuthor(e.info)}static registerGeometryLoader(e){this.geometryLoaders.set(e.dataType,e),this.ensureAuthor(e.info)}static registerMeshLoader(e){this.meshLoaders.set(e.dataType,e),this.ensureAuthor(e.info)}static getMaterialLoader(e){const t=this.materialLoaders.get(e.dataType);if(!t)throw new Error(`[TileLoaderFactory] Unsupported material source type: "${e.dataType}"`);return t}static getGeometryLoader(e){const t=this.geometryLoaders.get(e.dataType);if(!t)throw new Error(`[TileLoaderFactory] Unsupported geometry source type: "${e.dataType}"`);return t}static getMeshLoader(e){const t=this.meshLoaders.get(e.dataType);if(!t)throw new Error(`[TileLoaderFactory] Unsupported mesh source type: "${e.dataType}"`);return t}static ensureAuthor(e){e.author||(e.author="MapOrbis")}}_s(Ve,"manager",new Jc),_s(Ve,"geometryLoaders",new Map),_s(Ve,"materialLoaders",new Map),_s(Ve,"meshLoaders",new Map);class Pn{static getBoundsCoord(e,t){const r=Math.floor(e[0]*t),i=Math.floor(e[1]*t),o=Math.floor((e[2]-e[0])*t),l=Math.floor((e[3]-e[1])*t);return{sx:r,sy:i,sw:o,sh:l}}static getSafeTileUrlAndBounds(e,t,r,i){if(i<e.minLevel)return{url:void 0,clipBounds:[0,0,1,1]};if(i<=e.maxLevel)return{url:e._getUrl(t,r,i),clipBounds:[0,0,1,1]};const o=this.getMaxLevelTileAndBounds(t,r,i,e.maxLevel),l=o.parentNO;return{url:e._getUrl(l.x,l.y,l.z),clipBounds:o.bounds}}static getMaxLevelTileAndBounds(e,t,r,i){const o=r-i,l={x:e>>o,y:t>>o,z:r-o},c=Math.pow(2,o),u=Math.pow(.5,o),d=e%c/c-.5+u/2,m=t%c/c-.5+u/2,p=new f.Vector2(d,m),_=new f.Box2().setFromCenterAndSize(p,new f.Vector2(u,u)),v=[_.min.x+.5,_.min.y+.5,_.max.x+.5,_.max.y+.5];return{parentNO:l,bounds:v}}}var s0=Object.defineProperty,o0=(s,e,t)=>e in s?s0(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,a0=(s,e,t)=>o0(s,e+"",t);class ys{constructor(){a0(this,"info",{version:"1.0.0",description:"Abstract material loader base class"})}async load(e){const{source:t,x:r,y:i,z:o}=e,l=new f.MeshBasicMaterial({transparent:!0}),{url:c,clipBounds:u}=Pn.getSafeTileUrlAndBounds(t,r,i,o);if(c)try{const d=await this.performLoad(c,{...e,bounds:u});l.map=d,Ve.manager.parseEnd(c)}catch(d){console.warn(`[AbstractMaterialLoader] Failed to load texture from ${c}`,d)}return l}unload(e){e.map&&e.map.dispose(),e.dispose()}}var l0=Object.defineProperty,c0=(s,e,t)=>e in s?l0(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,u0=(s,e,t)=>c0(s,e+"",t);class h0 extends ys{constructor(){super(...arguments),u0(this,"info",{version:"1.0.0",description:"Abstract loader for generating procedural canvas textures."})}async load(e){const t=this.createCanvasContext(256,256);this.drawTile(t,e);const r=new f.CanvasTexture(t.canvas.transferToImageBitmap());return new qc({transparent:!0,map:r,opacity:e.source.opacity??1})}async performLoad(e,t){throw new Error("Method not implemented.")}createCanvasContext(e,t){const i=new OffscreenCanvas(e,t).getContext("2d");if(!i)throw new Error("Failed to create OffscreenCanvas context");return i.scale(1,-1),i.translate(0,-t),i}}class ki{static concatenateTypedArrays(...e){if(!e||e.length===0)throw new Error("[GeometryHelper] No arrays provided to concatenate.");const t=e[0].constructor,r=e.reduce((l,c)=>l+c.length,0),i=new t(r);let o=0;for(const l of e)i.set(l,o),o+=l.length;return i}static computeVertexNormals(e,t){const r=new Float32Array(e.length);for(let i=0;i<t.length;i+=3){const o=t[i]*3,l=t[i+1]*3,c=t[i+2]*3,u=e[o],d=e[o+1],m=e[o+2],p=e[l],_=e[l+1],v=e[l+2],S=e[c],M=e[c+1],x=e[c+2],O=p-u,P=_-d,C=v-m,T=S-u,N=M-d,X=x-m,R=P*X-C*N,U=C*T-O*X,$=O*N-P*T;r[o]+=R,r[o+1]+=U,r[o+2]+=$,r[l]+=R,r[l+1]+=U,r[l+2]+=$,r[c]+=R,r[c+1]+=U,r[c+2]+=$}for(let i=0;i<r.length;i+=3){const o=r[i],l=r[i+1],c=r[i+2],u=Math.sqrt(o*o+l*l+c*c);u>0?(r[i]/=u,r[i+1]/=u,r[i+2]/=u):(r[i]=0,r[i+1]=0,r[i+2]=1)}return r}static generateGridIndices(e,t){const r=(e-1)*(t-1)*6,i=e*t>65535?Uint32Array:Uint16Array,o=new i(r);let l=0;for(let c=0;c<e-1;c++)for(let u=0;u<t-1;u++){const d=c*t+u,m=d+1,p=(c+1)*t+u,_=p+1;o[l++]=d,o[l++]=m,o[l++]=p,o[l++]=p,o[l++]=m,o[l++]=_}return o}static fromDEM(e){if(e.length<4)throw new Error("[GeometryHelper] DEM data too small.");const t=Math.floor(Math.sqrt(e.length)),r=t,i=t,o=this.generateGridIndices(i,r),l=r*i,c=new Float32Array(l*3),u=new Float32Array(l*2);let d=0;for(let p=0;p<i;p++)for(let _=0;_<r;_++){const v=_/(r-1),S=p/(i-1);u[d*2]=v,u[d*2+1]=S,c[d*3]=v-.5,c[d*3+1]=S-.5,c[d*3+2]=e[(i-p-1)*r+_],d++}const m=this.computeVertexNormals(c,o);return{attributes:{position:{value:c,size:3},texcoord:{value:u,size:2},normal:{value:m,size:3}},indices:o}}}class Ec{static addSkirt(e,t,r){const i=e.attributes.position.value,o=e.attributes.texcoord.value,l=e.attributes.normal.value,c=e.indices,u=r?this.getEdgesFromIndices(r,i):this.extractBoundaryEdges(c),d=u.length;if(d===0)return e;const m=d*2,p=new Float32Array(m*3),_=new Float32Array(m*2),v=new Float32Array(m*3),M=i.length/3+m>65535?Uint32Array:Uint16Array,x=c instanceof Uint32Array?Uint32Array:M,O=new x(d*6);let P=0,C=0;const T=i.length/3;for(let N=0;N<d;N++){const X=u[N],R=X[0],U=X[1],$=i[R*3],z=i[R*3+1],V=i[R*3+2],Y=i[U*3],Q=i[U*3+1],K=i[U*3+2],te=o[R*2],H=o[R*2+1],Pe=o[U*2],ve=o[U*2+1];p[P*3+0]=$,p[P*3+1]=z,p[P*3+2]=V-t,_[P*2+0]=te,_[P*2+1]=H,v[P*3+0]=0,v[P*3+1]=0,v[P*3+2]=1;const we=T+P;P++,p[P*3+0]=Y,p[P*3+1]=Q,p[P*3+2]=K-t,_[P*2+0]=Pe,_[P*2+1]=ve,v[P*3+0]=0,v[P*3+1]=0,v[P*3+2]=1;const me=T+P;P++,O[C++]=R,O[C++]=me,O[C++]=U,O[C++]=me,O[C++]=R,O[C++]=we}return{attributes:{position:{value:ki.concatenateTypedArrays(i,p),size:3},texcoord:{value:ki.concatenateTypedArrays(o,_),size:2},normal:{value:ki.concatenateTypedArrays(l,v),size:3}},indices:ki.concatenateTypedArrays(c,O)}}static extractBoundaryEdges(e){const t=[];for(let l=0;l<e.length;l+=3){const c=e[l],u=e[l+1],d=e[l+2];t.push([c,u],[u,d],[d,c])}const r=new Map,i=new Map;for(const l of t){const c=l[0]<l[1]?`${l[0]}-${l[1]}`:`${l[1]}-${l[0]}`;r.set(c,(r.get(c)||0)+1),i.has(c)||i.set(c,l)}const o=[];return r.forEach((l,c)=>{l===1&&o.push(i.get(c))}),o}static getEdgesFromIndices(e,t){const r=[],i=(_,v)=>Array.from(_).sort(v),o=_=>t[_*3],l=_=>t[_*3+1],c=i(e.west,(_,v)=>l(_)-l(v)),u=i(e.east,(_,v)=>l(v)-l(_)),d=i(e.south,(_,v)=>o(v)-o(_)),m=i(e.north,(_,v)=>o(_)-o(v)),p=_=>{if(_.length>1)for(let v=0;v<_.length-1;v++)r.push([_[v],_[v+1]])};return p(c),p(u),p(d),p(m),r}}var f0=Object.defineProperty,d0=(s,e,t)=>e in s?f0(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,p0=(s,e,t)=>d0(s,e+"",t);class zi extends f.PlaneGeometry{constructor(){super(...arguments),p0(this,"type","MapTileGeometry")}setTerrainData(e,t=1e3){let r;return e instanceof Float32Array?r=ki.fromDEM(e):r=e,t>0&&(r=Ec.addSkirt(r,t)),this.updateThreeJSAttributes(r),this.computeBoundingBox(),this.computeBoundingSphere(),this}updateThreeJSAttributes(e){const{attributes:t,indices:r}=e;this.setIndex(new f.BufferAttribute(r,1)),this.setAttribute("position",new f.BufferAttribute(t.position.value,t.position.size)),this.setAttribute("uv",new f.BufferAttribute(t.texcoord.value,t.texcoord.size)),this.setAttribute("normal",new f.BufferAttribute(t.normal.value,t.normal.size))}}var m0=Object.defineProperty,g0=(s,e,t)=>e in s?m0(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ni=(s,e,t)=>g0(s,typeof e!="symbol"?e+"":e,t);const Hc=class rd{constructor(e=rd.DEFAULT_GRID_SIZE){Ni(this,"gridSize"),Ni(this,"numTriangles"),Ni(this,"numParentTriangles"),Ni(this,"indices"),Ni(this,"coords"),this.gridSize=e;const t=e-1;if(t&t-1)throw new Error(`[TerrainMeshBuilder] Invalid grid size: ${e}. Expected 2^k + 1.`);this.numTriangles=t*t*2-2,this.numParentTriangles=this.numTriangles-t*t,this.indices=new Uint32Array(this.gridSize*this.gridSize),this.coords=new Uint16Array(this.numTriangles*4),this.precomputeCoords(t)}precomputeCoords(e){for(let t=0;t<this.numTriangles;t++){let r=t+2,i=0,o=0,l=0,c=0,u=0,d=0;for(r&1?l=c=u=e:i=o=d=e;(r>>=1)>1;){const p=i+l>>1,_=o+c>>1;r&1?(l=i,c=o,i=u,o=d):(i=l,o=c,l=u,c=d),u=p,d=_}const m=t*4;this.coords[m+0]=i,this.coords[m+1]=o,this.coords[m+2]=l,this.coords[m+3]=c}}build(e,t=0){const r=this.calculateErrors(e),i=this.generateGeometry(r,t),o=i._vertices,l=i.indices,c=o.length/2,u=new Float32Array(c*3),d=new Float32Array(c*2),m=new Float32Array(c*3),p=this.gridSize;for(let _=0;_<c;_++){const v=o[2*_],S=o[2*_+1];u[3*_+0]=v,u[3*_+1]=S,u[3*_+2]=e[S*p+v],d[2*_+0]=v/(p-1),d[2*_+1]=S/(p-1)}return{attributes:{position:{value:u,size:3},texcoord:{value:d,size:2},normal:{value:m,size:3}},indices:l}}calculateErrors(e){const{gridSize:t,numTriangles:r,numParentTriangles:i,coords:o}=this,l=new Float32Array(e.length);for(let c=r-1;c>=0;c--){const u=c*4,d=o[u+0],m=o[u+1],p=o[u+2],_=o[u+3],v=d+p>>1,S=m+_>>1,M=v+S-m,x=S+v-d,O=(e[m*t+d]+e[_*t+p])/2,P=S*t+v,C=Math.abs(O-e[P]);if(l[P]=Math.max(l[P],C),c<i){const T=(m+x>>1)*t+(d+M>>1),N=(_+x>>1)*t+(p+M>>1);l[P]=Math.max(l[P],l[T],l[N])}}return l}generateGeometry(e,t){const{gridSize:r,indices:i}=this;i.fill(0);let o=0,l=0;const c=r-1,u=(v,S,M,x,O,P)=>{const C=v+M>>1,T=S+x>>1;if(Math.abs(v-O)+Math.abs(S-P)>1&&e[T*r+C]>t)u(O,P,v,S,C,T),u(M,x,O,P,C,T);else{const N=S*r+v,X=x*r+M,R=P*r+O;i[N]===0&&(i[N]=++o),i[X]===0&&(i[X]=++o),i[R]===0&&(i[R]=++o),l++}};u(0,0,c,c,c,0),u(c,c,0,0,0,c);const d=new Uint16Array(o*2),m=new Uint32Array(l*3);let p=0;const _=(v,S,M,x,O,P)=>{const C=v+M>>1,T=S+x>>1;if(Math.abs(v-O)+Math.abs(S-P)>1&&e[T*r+C]>t)_(O,P,v,S,C,T),_(M,x,O,P,C,T);else{const N=i[S*r+v]-1,X=i[x*r+M]-1,R=i[P*r+O]-1;d[2*N]=v,d[2*N+1]=S,d[2*X]=M,d[2*X+1]=x,d[2*R]=O,d[2*R+1]=P,m[p++]=N,m[p++]=X,m[p++]=R}};return _(0,0,c,c,c,0),_(c,c,0,0,0,c),{attributes:{position:{value:new Float32Array(0),size:3},texcoord:{value:new Float32Array(0),size:2},normal:{value:new Float32Array(0),size:3}},indices:m,_vertices:d}}};Ni(Hc,"DEFAULT_GRID_SIZE",257);let _0=Hc;var y0=Object.defineProperty,v0=(s,e,t)=>e in s?y0(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,w0=(s,e,t)=>v0(s,e+"",t);class oa{constructor(){w0(this,"info",{version:"1.0.0",description:"Abstract geometry loader base class"})}async load(e){const{source:t,x:r,y:i,z:o}=e,{url:l,clipBounds:c}=Pn.getSafeTileUrlAndBounds(t,r,i,o);if(!l)return new zi;const u=await this.performLoad(l,{...e,bounds:c});return Ve.manager.parseEnd(l),u}}const eu='(function(){"use strict";var ee=Object.defineProperty,re=(B,d,U)=>d in B?ee(B,d,{enumerable:!0,configurable:!0,writable:!0,value:U}):B[d]=U,j=(B,d,U)=>re(B,typeof d!="symbol"?d+"":d,U);const K=class P{constructor(d=P.DEFAULT_GRID_SIZE){j(this,"gridSize"),j(this,"numTriangles"),j(this,"numParentTriangles"),j(this,"indices"),j(this,"coords"),this.gridSize=d;const U=d-1;if(U&U-1)throw new Error(`[TerrainMeshBuilder] Invalid grid size: ${d}. Expected 2^k + 1.`);this.numTriangles=U*U*2-2,this.numParentTriangles=this.numTriangles-U*U,this.indices=new Uint32Array(this.gridSize*this.gridSize),this.coords=new Uint16Array(this.numTriangles*4),this.precomputeCoords(U)}precomputeCoords(d){for(let U=0;U<this.numTriangles;U++){let F=U+2,a=0,e=0,r=0,f=0,n=0,i=0;for(F&1?r=f=n=d:a=e=i=d;(F>>=1)>1;){const t=a+r>>1,s=e+f>>1;F&1?(r=a,f=e,a=n,e=i):(a=r,e=f,r=n,f=i),n=t,i=s}const m=U*4;this.coords[m+0]=a,this.coords[m+1]=e,this.coords[m+2]=r,this.coords[m+3]=f}}build(d,U=0){const F=this.calculateErrors(d),a=this.generateGeometry(F,U),e=a._vertices,r=a.indices,f=e.length/2,n=new Float32Array(f*3),i=new Float32Array(f*2),m=new Float32Array(f*3),t=this.gridSize;for(let s=0;s<f;s++){const c=e[2*s],o=e[2*s+1];n[3*s+0]=c,n[3*s+1]=o,n[3*s+2]=d[o*t+c],i[2*s+0]=c/(t-1),i[2*s+1]=o/(t-1)}return{attributes:{position:{value:n,size:3},texcoord:{value:i,size:2},normal:{value:m,size:3}},indices:r}}calculateErrors(d){const{gridSize:U,numTriangles:F,numParentTriangles:a,coords:e}=this,r=new Float32Array(d.length);for(let f=F-1;f>=0;f--){const n=f*4,i=e[n+0],m=e[n+1],t=e[n+2],s=e[n+3],c=i+t>>1,o=m+s>>1,h=c+o-m,v=o+c-i,u=(d[m*U+i]+d[s*U+t])/2,l=o*U+c,g=Math.abs(u-d[l]);if(r[l]=Math.max(r[l],g),f<a){const x=(m+v>>1)*U+(i+h>>1),k=(s+v>>1)*U+(t+h>>1);r[l]=Math.max(r[l],r[x],r[k])}}return r}generateGeometry(d,U){const{gridSize:F,indices:a}=this;a.fill(0);let e=0,r=0;const f=F-1,n=(c,o,h,v,u,l)=>{const g=c+h>>1,x=o+v>>1;if(Math.abs(c-u)+Math.abs(o-l)>1&&d[x*F+g]>U)n(u,l,c,o,g,x),n(h,v,u,l,g,x);else{const k=o*F+c,p=v*F+h,y=l*F+u;a[k]===0&&(a[k]=++e),a[p]===0&&(a[p]=++e),a[y]===0&&(a[y]=++e),r++}};n(0,0,f,f,f,0),n(f,f,0,0,0,f);const i=new Uint16Array(e*2),m=new Uint32Array(r*3);let t=0;const s=(c,o,h,v,u,l)=>{const g=c+h>>1,x=o+v>>1;if(Math.abs(c-u)+Math.abs(o-l)>1&&d[x*F+g]>U)s(u,l,c,o,g,x),s(h,v,u,l,g,x);else{const k=a[o*F+c]-1,p=a[v*F+h]-1,y=a[l*F+u]-1;i[2*k]=c,i[2*k+1]=o,i[2*p]=h,i[2*p+1]=v,i[2*y]=u,i[2*y+1]=l,m[t++]=k,m[t++]=p,m[t++]=y}};return s(0,0,f,f,f,0),s(f,f,0,0,0,f),{attributes:{position:{value:new Float32Array(0),size:3},texcoord:{value:new Float32Array(0),size:2},normal:{value:new Float32Array(0),size:3}},indices:m,_vertices:i}}};j(K,"DEFAULT_GRID_SIZE",257);let ie=K;const ne=(function(){var B={};B.defaultNoDataValue=-34027999387901484e22,B.decode=function(r,f){f=f||{};var n=f.encodedMaskData||f.encodedMaskData===null,i=a(r,f.inputOffset||0,n),m=f.noDataValue!==null?f.noDataValue:B.defaultNoDataValue,t=d(i,f.pixelType||Float32Array,f.encodedMaskData,m,f.returnMask),s={width:i.width,height:i.height,pixelData:t.resultPixels,minValue:t.minValue,maxValue:i.pixels.maxValue,noDataValue:m};return t.resultMask&&(s.maskData=t.resultMask),f.returnEncodedMask&&i.mask&&(s.encodedMaskData=i.mask.bitset?i.mask.bitset:null),f.returnFileInfo&&(s.fileInfo=U(i),f.computeUsedBitDepths&&(s.fileInfo.bitDepths=F(i))),s};var d=function(r,f,n,i,m){var t=0,s=r.pixels.numBlocksX,c=r.pixels.numBlocksY,o=Math.floor(r.width/s),h=Math.floor(r.height/c),v=2*r.maxZError,u=Number.MAX_VALUE,l;n=n||(r.mask?r.mask.bitset:null);var g,x;g=new f(r.width*r.height),m&&n&&(x=new Uint8Array(r.width*r.height));for(var k=new Float32Array(o*h),p,y,M=0;M<=c;M++){var S=M!==c?h:r.height%c;if(S!==0)for(var I=0;I<=s;I++){var w=I!==s?o:r.width%s;if(w!==0){var D=M*r.width*h+I*o,V=r.width-w,A=r.pixels.blocks[t],L,T,b;A.encoding<2?(A.encoding===0?L=A.rawData:(e(A.stuffedData,A.bitsPerPixel,A.numValidPixels,A.offset,v,k,r.pixels.maxValue),L=k),T=0):A.encoding===2?b=0:b=A.offset;var z;if(n)for(y=0;y<S;y++){for(D&7&&(z=n[D>>3],z<<=D&7),p=0;p<w;p++)D&7||(z=n[D>>3]),z&128?(x&&(x[D]=1),l=A.encoding<2?L[T++]:b,u=u>l?l:u,g[D++]=l):(x&&(x[D]=0),g[D++]=i),z<<=1;D+=V}else if(A.encoding<2)for(y=0;y<S;y++){for(p=0;p<w;p++)l=L[T++],u=u>l?l:u,g[D++]=l;D+=V}else for(u=u>b?b:u,y=0;y<S;y++){for(p=0;p<w;p++)g[D++]=b;D+=V}if(A.encoding===1&&T!==A.numValidPixels)throw"Block and Mask do not match";t++}}}return{resultPixels:g,resultMask:x,minValue:u}},U=function(r){return{fileIdentifierString:r.fileIdentifierString,fileVersion:r.fileVersion,imageType:r.imageType,height:r.height,width:r.width,maxZError:r.maxZError,eofOffset:r.eofOffset,mask:r.mask?{numBlocksX:r.mask.numBlocksX,numBlocksY:r.mask.numBlocksY,numBytes:r.mask.numBytes,maxValue:r.mask.maxValue}:null,pixels:{numBlocksX:r.pixels.numBlocksX,numBlocksY:r.pixels.numBlocksY,numBytes:r.pixels.numBytes,maxValue:r.pixels.maxValue,noDataValue:r.noDataValue}}},F=function(r){for(var f=r.pixels.numBlocksX*r.pixels.numBlocksY,n={},i=0;i<f;i++){var m=r.pixels.blocks[i];m.encoding===0?n.float32=!0:m.encoding===1?n[m.bitsPerPixel]=!0:n[0]=!0}return Object.keys(n)},a=function(r,f,n){var i={},m=new Uint8Array(r,f,10);if(i.fileIdentifierString=String.fromCharCode.apply(null,m),i.fileIdentifierString.trim()!=="CntZImage")throw"Unexpected file identifier string: "+i.fileIdentifierString;f+=10;var t=new DataView(r,f,24);if(i.fileVersion=t.getInt32(0,!0),i.imageType=t.getInt32(4,!0),i.height=t.getUint32(8,!0),i.width=t.getUint32(12,!0),i.maxZError=t.getFloat64(16,!0),f+=24,!n)if(t=new DataView(r,f,16),i.mask={},i.mask.numBlocksY=t.getUint32(0,!0),i.mask.numBlocksX=t.getUint32(4,!0),i.mask.numBytes=t.getUint32(8,!0),i.mask.maxValue=t.getFloat32(12,!0),f+=16,i.mask.numBytes>0){var s=new Uint8Array(Math.ceil(i.width*i.height/8));t=new DataView(r,f,i.mask.numBytes);var c=t.getInt16(0,!0),o=2,h=0;do{if(c>0)for(;c--;)s[h++]=t.getUint8(o++);else{var v=t.getUint8(o++);for(c=-c;c--;)s[h++]=v}c=t.getInt16(o,!0),o+=2}while(o<i.mask.numBytes);if(c!==-32768||h<s.length)throw"Unexpected end of mask RLE encoding";i.mask.bitset=s,f+=i.mask.numBytes}else(i.mask.numBytes|i.mask.numBlocksY|i.mask.maxValue)===0&&(i.mask.bitset=new Uint8Array(Math.ceil(i.width*i.height/8)));t=new DataView(r,f,16),i.pixels={},i.pixels.numBlocksY=t.getUint32(0,!0),i.pixels.numBlocksX=t.getUint32(4,!0),i.pixels.numBytes=t.getUint32(8,!0),i.pixels.maxValue=t.getFloat32(12,!0),f+=16;var u=i.pixels.numBlocksX,l=i.pixels.numBlocksY,g=u+(i.width%u>0?1:0),x=l+(i.height%l>0?1:0);i.pixels.blocks=new Array(g*x);for(var k=0,p=0;p<x;p++)for(var y=0;y<g;y++){var M=0,S=r.byteLength-f;t=new DataView(r,f,Math.min(10,S));var I={};i.pixels.blocks[k++]=I;var w=t.getUint8(0);if(M++,I.encoding=w&63,I.encoding>3)throw"Invalid block encoding ("+I.encoding+")";if(I.encoding===2){f++;continue}if(w!==0&&w!==2){if(w>>=6,I.offsetType=w,w===2)I.offset=t.getInt8(1),M++;else if(w===1)I.offset=t.getInt16(1,!0),M+=2;else if(w===0)I.offset=t.getFloat32(1,!0),M+=4;else throw"Invalid block offset type";if(I.encoding===1)if(w=t.getUint8(M),M++,I.bitsPerPixel=w&63,w>>=6,I.numValidPixelsType=w,w===2)I.numValidPixels=t.getUint8(M),M++;else if(w===1)I.numValidPixels=t.getUint16(M,!0),M+=2;else if(w===0)I.numValidPixels=t.getUint32(M,!0),M+=4;else throw"Invalid valid pixel count type"}if(f+=M,I.encoding!==3){var D,V;if(I.encoding===0){var A=(i.pixels.numBytes-1)/4;if(A!==Math.floor(A))throw"uncompressed block has invalid length";D=new ArrayBuffer(A*4),V=new Uint8Array(D),V.set(new Uint8Array(r,f,A*4));var L=new Float32Array(D);I.rawData=L,f+=A*4}else if(I.encoding===1){var T=Math.ceil(I.numValidPixels*I.bitsPerPixel/8),b=Math.ceil(T/4);D=new ArrayBuffer(b*4),V=new Uint8Array(D),V.set(new Uint8Array(r,f,T)),I.stuffedData=new Uint32Array(D),f+=T}}}return i.eofOffset=f,i},e=function(r,f,n,i,m,t,s){var c=(1<<f)-1,o=0,h,v=0,u,l,g=Math.ceil((s-i)/m),x=r.length*4-Math.ceil(f*n/8);for(r[r.length-1]<<=8*x,h=0;h<n;h++){if(v===0&&(l=r[o++],v=32),v>=f)u=l>>>v-f&c,v-=f;else{var k=f-v;u=(l&c)<<k&c,l=r[o++],v=32-k,u+=l>>>v}t[h]=u<g?i+u*m:s}return t};return B})(),te=(function(){var B={unstuff:function(a,e,r,f,n,i,m,t){var s=(1<<r)-1,c=0,o,h=0,v,u,l,g,x=a.length*4-Math.ceil(r*f/8);if(a[a.length-1]<<=8*x,n)for(o=0;o<f;o++)h===0&&(u=a[c++],h=32),h>=r?(v=u>>>h-r&s,h-=r):(l=r-h,v=(u&s)<<l&s,u=a[c++],h=32-l,v+=u>>>h),e[o]=n[v];else for(g=Math.ceil((t-i)/m),o=0;o<f;o++)h===0&&(u=a[c++],h=32),h>=r?(v=u>>>h-r&s,h-=r):(l=r-h,v=(u&s)<<l&s,u=a[c++],h=32-l,v+=u>>>h),e[o]=v<g?i+v*m:t},unstuffLUT:function(a,e,r,f,n,i){var m=(1<<e)-1,t=0,s=0,c=0,o=0,h=0,v,u=[],l=a.length*4-Math.ceil(e*r/8);a[a.length-1]<<=8*l;var g=Math.ceil((i-f)/n);for(s=0;s<r;s++)o===0&&(v=a[t++],o=32),o>=e?(h=v>>>o-e&m,o-=e):(c=e-o,h=(v&m)<<c&m,v=a[t++],o=32-c,h+=v>>>o),u[s]=h<g?f+h*n:i;return u.unshift(f),u},unstuff2:function(a,e,r,f,n,i,m,t){var s=(1<<r)-1,c=0,o,h=0,v=0,u,l,g;if(n)for(o=0;o<f;o++)h===0&&(l=a[c++],h=32,v=0),h>=r?(u=l>>>v&s,h-=r,v+=r):(g=r-h,u=l>>>v&s,l=a[c++],h=32-g,u|=(l&(1<<g)-1)<<r-g,v=g),e[o]=n[u];else{var x=Math.ceil((t-i)/m);for(o=0;o<f;o++)h===0&&(l=a[c++],h=32,v=0),h>=r?(u=l>>>v&s,h-=r,v+=r):(g=r-h,u=l>>>v&s,l=a[c++],h=32-g,u|=(l&(1<<g)-1)<<r-g,v=g),e[o]=u<x?i+u*m:t}return e},unstuffLUT2:function(a,e,r,f,n,i){var m=(1<<e)-1,t=0,s=0,c=0,o=0,h=0,v=0,u,l=[],g=Math.ceil((i-f)/n);for(s=0;s<r;s++)o===0&&(u=a[t++],o=32,v=0),o>=e?(h=u>>>v&m,o-=e,v+=e):(c=e-o,h=u>>>v&m,u=a[t++],o=32-c,h|=(u&(1<<c)-1)<<e-c,v=c),l[s]=h<g?f+h*n:i;return l.unshift(f),l},originalUnstuff:function(a,e,r,f){var n=(1<<r)-1,i=0,m,t=0,s,c,o,h=a.length*4-Math.ceil(r*f/8);for(a[a.length-1]<<=8*h,m=0;m<f;m++)t===0&&(c=a[i++],t=32),t>=r?(s=c>>>t-r&n,t-=r):(o=r-t,s=(c&n)<<o&n,c=a[i++],t=32-o,s+=c>>>t),e[m]=s;return e},originalUnstuff2:function(a,e,r,f){var n=(1<<r)-1,i=0,m,t=0,s=0,c,o,h;for(m=0;m<f;m++)t===0&&(o=a[i++],t=32,s=0),t>=r?(c=o>>>s&n,t-=r,s+=r):(h=r-t,c=o>>>s&n,o=a[i++],t=32-h,c|=(o&(1<<h)-1)<<r-h,s=h),e[m]=c;return e}},d={HUFFMAN_LUT_BITS_MAX:12,computeChecksumFletcher32:function(a){for(var e=65535,r=65535,f=a.length,n=Math.floor(f/2),i=0;n;){var m=n>=359?359:n;n-=m;do e+=a[i++]<<8,r+=e+=a[i++];while(--m);e=(e&65535)+(e>>>16),r=(r&65535)+(r>>>16)}return f&1&&(r+=e+=a[i]<<8),e=(e&65535)+(e>>>16),r=(r&65535)+(r>>>16),(r<<16|e)>>>0},readHeaderInfo:function(a,e){var r=e.ptr,f=new Uint8Array(a,r,6),n={};if(n.fileIdentifierString=String.fromCharCode.apply(null,f),n.fileIdentifierString.lastIndexOf("Lerc2",0)!==0)throw"Unexpected file identifier string (expect Lerc2 ): "+n.fileIdentifierString;r+=6;var i=new DataView(a,r,8),m=i.getInt32(0,!0);n.fileVersion=m,r+=4,m>=3&&(n.checksum=i.getUint32(4,!0),r+=4),i=new DataView(a,r,12),n.height=i.getUint32(0,!0),n.width=i.getUint32(4,!0),r+=8,m>=4?(n.numDims=i.getUint32(8,!0),r+=4):n.numDims=1,i=new DataView(a,r,40),n.numValidPixel=i.getUint32(0,!0),n.microBlockSize=i.getInt32(4,!0),n.blobSize=i.getInt32(8,!0),n.imageType=i.getInt32(12,!0),n.maxZError=i.getFloat64(16,!0),n.zMin=i.getFloat64(24,!0),n.zMax=i.getFloat64(32,!0),r+=40,e.headerInfo=n,e.ptr=r;var t,s;if(m>=3&&(s=m>=4?52:48,t=this.computeChecksumFletcher32(new Uint8Array(a,r-s,n.blobSize-14)),t!==n.checksum))throw"Checksum failed.";return!0},checkMinMaxRanges:function(a,e){var r=e.headerInfo,f=this.getDataTypeArray(r.imageType),n=r.numDims*this.getDataTypeSize(r.imageType),i=this.readSubArray(a,e.ptr,f,n),m=this.readSubArray(a,e.ptr+n,f,n);e.ptr+=2*n;var t,s=!0;for(t=0;t<r.numDims;t++)if(i[t]!==m[t]){s=!1;break}return r.minValues=i,r.maxValues=m,s},readSubArray:function(a,e,r,f){var n;if(r===Uint8Array)n=new Uint8Array(a,e,f);else{var i=new ArrayBuffer(f),m=new Uint8Array(i);m.set(new Uint8Array(a,e,f)),n=new r(i)}return n},readMask:function(a,e){var r=e.ptr,f=e.headerInfo,n=f.width*f.height,i=f.numValidPixel,m=new DataView(a,r,4),t={};if(t.numBytes=m.getUint32(0,!0),r+=4,(i===0||n===i)&&t.numBytes!==0)throw"invalid mask";var s,c;if(i===0)s=new Uint8Array(Math.ceil(n/8)),t.bitset=s,c=new Uint8Array(n),e.pixels.resultMask=c,r+=t.numBytes;else if(t.numBytes>0){s=new Uint8Array(Math.ceil(n/8)),m=new DataView(a,r,t.numBytes);var o=m.getInt16(0,!0),h=2,v=0,u=0;do{if(o>0)for(;o--;)s[v++]=m.getUint8(h++);else for(u=m.getUint8(h++),o=-o;o--;)s[v++]=u;o=m.getInt16(h,!0),h+=2}while(h<t.numBytes);if(o!==-32768||v<s.length)throw"Unexpected end of mask RLE encoding";c=new Uint8Array(n);var l=0,g=0;for(g=0;g<n;g++)g&7?(l=s[g>>3],l<<=g&7):l=s[g>>3],l&128&&(c[g]=1);e.pixels.resultMask=c,t.bitset=s,r+=t.numBytes}return e.ptr=r,e.mask=t,!0},readDataOneSweep:function(a,e,r,f){var n=e.ptr,i=e.headerInfo,m=i.numDims,t=i.width*i.height,s=i.imageType,c=i.numValidPixel*d.getDataTypeSize(s)*m,o,h=e.pixels.resultMask;if(r===Uint8Array)o=new Uint8Array(a,n,c);else{var v=new ArrayBuffer(c),u=new Uint8Array(v);u.set(new Uint8Array(a,n,c)),o=new r(v)}if(o.length===t*m)f?e.pixels.resultPixels=d.swapDimensionOrder(o,t,m,r,!0):e.pixels.resultPixels=o;else{e.pixels.resultPixels=new r(t*m);var l=0,g=0,x=0,k=0;if(m>1){if(f){for(g=0;g<t;g++)if(h[g])for(k=g,x=0;x<m;x++,k+=t)e.pixels.resultPixels[k]=o[l++]}else for(g=0;g<t;g++)if(h[g])for(k=g*m,x=0;x<m;x++)e.pixels.resultPixels[k+x]=o[l++]}else for(g=0;g<t;g++)h[g]&&(e.pixels.resultPixels[g]=o[l++])}return n+=c,e.ptr=n,!0},readHuffmanTree:function(a,e){var r=this.HUFFMAN_LUT_BITS_MAX,f=new DataView(a,e.ptr,16);e.ptr+=16;var n=f.getInt32(0,!0);if(n<2)throw"unsupported Huffman version";var i=f.getInt32(4,!0),m=f.getInt32(8,!0),t=f.getInt32(12,!0);if(m>=t)return!1;var s=new Uint32Array(t-m);d.decodeBits(a,e,s);var c=[],o,h,v,u;for(o=m;o<t;o++)h=o-(o<i?0:i),c[h]={first:s[o-m],second:null};var l=a.byteLength-e.ptr,g=Math.ceil(l/4),x=new ArrayBuffer(g*4),k=new Uint8Array(x);k.set(new Uint8Array(a,e.ptr,l));var p=new Uint32Array(x),y=0,M,S=0;for(M=p[0],o=m;o<t;o++)h=o-(o<i?0:i),u=c[h].first,u>0&&(c[h].second=M<<y>>>32-u,32-y>=u?(y+=u,y===32&&(y=0,S++,M=p[S])):(y+=u-32,S++,M=p[S],c[h].second|=M>>>32-y));var I=0,w=0,D=new U;for(o=0;o<c.length;o++)c[o]!==void 0&&(I=Math.max(I,c[o].first));I>=r?w=r:w=I;var V=[],A,L,T,b,z,C;for(o=m;o<t;o++)if(h=o-(o<i?0:i),u=c[h].first,u>0)if(A=[u,h],u<=w)for(L=c[h].second<<w-u,T=1<<w-u,v=0;v<T;v++)V[L|v]=A;else for(L=c[h].second,C=D,b=u-1;b>=0;b--)z=L>>>b&1,z?(C.right||(C.right=new U),C=C.right):(C.left||(C.left=new U),C=C.left),b===0&&!C.val&&(C.val=A[1]);return{decodeLut:V,numBitsLUTQick:w,numBitsLUT:I,tree:D,stuffedData:p,srcPtr:S,bitPos:y}},readHuffman:function(a,e,r,f){var n=e.headerInfo,i=n.numDims,m=e.headerInfo.height,t=e.headerInfo.width,s=t*m,c=this.readHuffmanTree(a,e),o=c.decodeLut,h=c.tree,v=c.stuffedData,u=c.srcPtr,l=c.bitPos,g=c.numBitsLUTQick,x=c.numBitsLUT,k=e.headerInfo.imageType===0?128:0,p,y,M,S=e.pixels.resultMask,I,w,D,V,A,L,T,b=0;l>0&&(u++,l=0);var z=v[u],C=e.encodeMode===1,N=new r(s*i),E=N,X;if(i<2||C){for(X=0;X<i;X++)if(i>1&&(E=new r(N.buffer,s*X,s),b=0),e.headerInfo.numValidPixel===t*m)for(L=0,V=0;V<m;V++)for(A=0;A<t;A++,L++){if(y=0,I=z<<l>>>32-g,w=I,32-l<g&&(I|=v[u+1]>>>64-l-g,w=I),o[w])y=o[w][1],l+=o[w][0];else for(I=z<<l>>>32-x,w=I,32-l<x&&(I|=v[u+1]>>>64-l-x,w=I),p=h,T=0;T<x;T++)if(D=I>>>x-T-1&1,p=D?p.right:p.left,!(p.left||p.right)){y=p.val,l=l+T+1;break}l>=32&&(l-=32,u++,z=v[u]),M=y-k,C?(A>0?M+=b:V>0?M+=E[L-t]:M+=b,M&=255,E[L]=M,b=M):E[L]=M}else for(L=0,V=0;V<m;V++)for(A=0;A<t;A++,L++)if(S[L]){if(y=0,I=z<<l>>>32-g,w=I,32-l<g&&(I|=v[u+1]>>>64-l-g,w=I),o[w])y=o[w][1],l+=o[w][0];else for(I=z<<l>>>32-x,w=I,32-l<x&&(I|=v[u+1]>>>64-l-x,w=I),p=h,T=0;T<x;T++)if(D=I>>>x-T-1&1,p=D?p.right:p.left,!(p.left||p.right)){y=p.val,l=l+T+1;break}l>=32&&(l-=32,u++,z=v[u]),M=y-k,C?(A>0&&S[L-1]?M+=b:V>0&&S[L-t]?M+=E[L-t]:M+=b,M&=255,E[L]=M,b=M):E[L]=M}}else for(L=0,V=0;V<m;V++)for(A=0;A<t;A++)if(L=V*t+A,!S||S[L])for(X=0;X<i;X++,L+=s){if(y=0,I=z<<l>>>32-g,w=I,32-l<g&&(I|=v[u+1]>>>64-l-g,w=I),o[w])y=o[w][1],l+=o[w][0];else for(I=z<<l>>>32-x,w=I,32-l<x&&(I|=v[u+1]>>>64-l-x,w=I),p=h,T=0;T<x;T++)if(D=I>>>x-T-1&1,p=D?p.right:p.left,!(p.left||p.right)){y=p.val,l=l+T+1;break}l>=32&&(l-=32,u++,z=v[u]),M=y-k,E[L]=M}e.ptr=e.ptr+(u+1)*4+(l>0?4:0),e.pixels.resultPixels=N,i>1&&!f&&(e.pixels.resultPixels=d.swapDimensionOrder(N,s,i,r))},decodeBits:function(a,e,r,f,n){{var i=e.headerInfo,m=i.fileVersion,t=0,s=a.byteLength-e.ptr>=5?5:a.byteLength-e.ptr,c=new DataView(a,e.ptr,s),o=c.getUint8(0);t++;var h=o>>6,v=h===0?4:3-h,u=(o&32)>0,l=o&31,g=0;if(v===1)g=c.getUint8(t),t++;else if(v===2)g=c.getUint16(t,!0),t+=2;else if(v===4)g=c.getUint32(t,!0),t+=4;else throw"Invalid valid pixel count type";var x=2*i.maxZError,k,p,y,M,S,I,w,D,V,A=i.numDims>1?i.maxValues[n]:i.zMax;if(u){for(e.counter.lut++,D=c.getUint8(t),t++,M=Math.ceil((D-1)*l/8),S=Math.ceil(M/4),p=new ArrayBuffer(S*4),y=new Uint8Array(p),e.ptr+=t,y.set(new Uint8Array(a,e.ptr,M)),w=new Uint32Array(p),e.ptr+=M,V=0;D-1>>>V;)V++;M=Math.ceil(g*V/8),S=Math.ceil(M/4),p=new ArrayBuffer(S*4),y=new Uint8Array(p),y.set(new Uint8Array(a,e.ptr,M)),k=new Uint32Array(p),e.ptr+=M,m>=3?I=B.unstuffLUT2(w,l,D-1,f,x,A):I=B.unstuffLUT(w,l,D-1,f,x,A),m>=3?B.unstuff2(k,r,V,g,I):B.unstuff(k,r,V,g,I)}else e.counter.bitstuffer++,V=l,e.ptr+=t,V>0&&(M=Math.ceil(g*V/8),S=Math.ceil(M/4),p=new ArrayBuffer(S*4),y=new Uint8Array(p),y.set(new Uint8Array(a,e.ptr,M)),k=new Uint32Array(p),e.ptr+=M,m>=3?f==null?B.originalUnstuff2(k,r,V,g):B.unstuff2(k,r,V,g,!1,f,x,A):f==null?B.originalUnstuff(k,r,V,g):B.unstuff(k,r,V,g,!1,f,x,A))}},readTiles:function(a,e,r,f){var n=e.headerInfo,i=n.width,m=n.height,t=i*m,s=n.microBlockSize,c=n.imageType,o=d.getDataTypeSize(c),h=Math.ceil(i/s),v=Math.ceil(m/s);e.pixels.numBlocksY=v,e.pixels.numBlocksX=h,e.pixels.ptr=0;var u=0,l=0,g=0,x=0,k=0,p=0,y=0,M=0,S=0,I=0,w=0,D=0,V=0,A=0,L=0,T=0,b,z,C,N,E,X,Q=new r(s*s),le=m%s||s,oe=i%s||s,$,R,q=n.numDims,H,Y=e.pixels.resultMask,O=e.pixels.resultPixels,ue=n.fileVersion,W=ue>=5?14:15,_,J=n.zMax,Z;for(g=0;g<v;g++)for(k=g!==v-1?s:le,x=0;x<h;x++)for(p=x!==h-1?s:oe,w=g*i*s+x*s,D=i-p,H=0;H<q;H++){if(q>1?(Z=O,w=g*i*s+x*s,O=new r(e.pixels.resultPixels.buffer,t*H*o,t),J=n.maxValues[H]):Z=null,y=a.byteLength-e.ptr,b=new DataView(a,e.ptr,Math.min(10,y)),z={},T=0,M=b.getUint8(0),T++,_=n.fileVersion>=5?M&4:0,S=M>>6&255,I=M>>2&W,I!==(x*s>>3&W)||_&&H===0)throw"integrity issue";if(X=M&3,X>3)throw e.ptr+=T,"Invalid block encoding ("+X+")";if(X===2){if(_)if(Y)for(u=0;u<k;u++)for(l=0;l<p;l++)Y[w]&&(O[w]=Z[w]),w++;else for(u=0;u<k;u++)for(l=0;l<p;l++)O[w]=Z[w],w++;e.counter.constant++,e.ptr+=T;continue}else if(X===0){if(_)throw"integrity issue";if(e.counter.uncompressed++,e.ptr+=T,V=k*p*o,A=a.byteLength-e.ptr,V=V<A?V:A,C=new ArrayBuffer(V%o===0?V:V+o-V%o),N=new Uint8Array(C),N.set(new Uint8Array(a,e.ptr,V)),E=new r(C),L=0,Y)for(u=0;u<k;u++){for(l=0;l<p;l++)Y[w]&&(O[w]=E[L++]),w++;w+=D}else for(u=0;u<k;u++){for(l=0;l<p;l++)O[w++]=E[L++];w+=D}e.ptr+=L*o}else if($=d.getDataTypeUsed(_&&c<6?4:c,S),R=d.getOnePixel(z,T,$,b),T+=d.getDataTypeSize($),X===3)if(e.ptr+=T,e.counter.constantoffset++,Y)for(u=0;u<k;u++){for(l=0;l<p;l++)Y[w]&&(O[w]=_?Math.min(J,Z[w]+R):R),w++;w+=D}else for(u=0;u<k;u++){for(l=0;l<p;l++)O[w]=_?Math.min(J,Z[w]+R):R,w++;w+=D}else if(e.ptr+=T,d.decodeBits(a,e,Q,R,H),T=0,_)if(Y)for(u=0;u<k;u++){for(l=0;l<p;l++)Y[w]&&(O[w]=Q[T++]+Z[w]),w++;w+=D}else for(u=0;u<k;u++){for(l=0;l<p;l++)O[w]=Q[T++]+Z[w],w++;w+=D}else if(Y)for(u=0;u<k;u++){for(l=0;l<p;l++)Y[w]&&(O[w]=Q[T++]),w++;w+=D}else for(u=0;u<k;u++){for(l=0;l<p;l++)O[w++]=Q[T++];w+=D}}q>1&&!f&&(e.pixels.resultPixels=d.swapDimensionOrder(e.pixels.resultPixels,t,q,r))},formatFileInfo:function(a){return{fileIdentifierString:a.headerInfo.fileIdentifierString,fileVersion:a.headerInfo.fileVersion,imageType:a.headerInfo.imageType,height:a.headerInfo.height,width:a.headerInfo.width,numValidPixel:a.headerInfo.numValidPixel,microBlockSize:a.headerInfo.microBlockSize,blobSize:a.headerInfo.blobSize,maxZError:a.headerInfo.maxZError,pixelType:d.getPixelType(a.headerInfo.imageType),eofOffset:a.eofOffset,mask:a.mask?{numBytes:a.mask.numBytes}:null,pixels:{numBlocksX:a.pixels.numBlocksX,numBlocksY:a.pixels.numBlocksY,maxValue:a.headerInfo.zMax,minValue:a.headerInfo.zMin,noDataValue:a.noDataValue}}},constructConstantSurface:function(a,e){var r=a.headerInfo.zMax,f=a.headerInfo.zMin,n=a.headerInfo.maxValues,i=a.headerInfo.numDims,m=a.headerInfo.height*a.headerInfo.width,t=0,s=0,c=0,o=a.pixels.resultMask,h=a.pixels.resultPixels;if(o)if(i>1){if(e)for(t=0;t<i;t++)for(c=t*m,r=n[t],s=0;s<m;s++)o[s]&&(h[c+s]=r);else for(s=0;s<m;s++)if(o[s])for(c=s*i,t=0;t<i;t++)h[c+i]=n[t]}else for(s=0;s<m;s++)o[s]&&(h[s]=r);else if(i>1&&f!==r)if(e)for(t=0;t<i;t++)for(c=t*m,r=n[t],s=0;s<m;s++)h[c+s]=r;else for(s=0;s<m;s++)for(c=s*i,t=0;t<i;t++)h[c+t]=n[t];else for(s=0;s<m*i;s++)h[s]=r},getDataTypeArray:function(a){var e;switch(a){case 0:e=Int8Array;break;case 1:e=Uint8Array;break;case 2:e=Int16Array;break;case 3:e=Uint16Array;break;case 4:e=Int32Array;break;case 5:e=Uint32Array;break;case 6:e=Float32Array;break;case 7:e=Float64Array;break;default:e=Float32Array}return e},getPixelType:function(a){var e;switch(a){case 0:e="S8";break;case 1:e="U8";break;case 2:e="S16";break;case 3:e="U16";break;case 4:e="S32";break;case 5:e="U32";break;case 6:e="F32";break;case 7:e="F64";break;default:e="F32"}return e},isValidPixelValue:function(a,e){if(e==null)return!1;var r;switch(a){case 0:r=e>=-128&&e<=127;break;case 1:r=e>=0&&e<=255;break;case 2:r=e>=-32768&&e<=32767;break;case 3:r=e>=0&&e<=65536;break;case 4:r=e>=-2147483648&&e<=2147483647;break;case 5:r=e>=0&&e<=4294967296;break;case 6:r=e>=-34027999387901484e22&&e<=34027999387901484e22;break;case 7:r=e>=-17976931348623157e292&&e<=17976931348623157e292;break;default:r=!1}return r},getDataTypeSize:function(a){var e=0;switch(a){case 0:case 1:e=1;break;case 2:case 3:e=2;break;case 4:case 5:case 6:e=4;break;case 7:e=8;break;default:e=a}return e},getDataTypeUsed:function(a,e){var r=a;switch(a){case 2:case 4:r=a-e;break;case 3:case 5:r=a-2*e;break;case 6:e===0?r=a:e===1?r=2:r=1;break;case 7:e===0?r=a:r=a-2*e+1;break;default:r=a;break}return r},getOnePixel:function(a,e,r,f){var n=0;switch(r){case 0:n=f.getInt8(e);break;case 1:n=f.getUint8(e);break;case 2:n=f.getInt16(e,!0);break;case 3:n=f.getUint16(e,!0);break;case 4:n=f.getInt32(e,!0);break;case 5:n=f.getUInt32(e,!0);break;case 6:n=f.getFloat32(e,!0);break;case 7:n=f.getFloat64(e,!0);break;default:throw"the decoder does not understand this pixel type"}return n},swapDimensionOrder:function(a,e,r,f,n){var i=0,m=0,t=0,s=0,c=a;if(r>1)if(c=new f(e*r),n)for(i=0;i<e;i++)for(s=i,t=0;t<r;t++,s+=e)c[s]=a[m++];else for(i=0;i<e;i++)for(s=i,t=0;t<r;t++,s+=e)c[m++]=a[s];return c}},U=function(a,e,r){this.val=a,this.left=e,this.right=r},F={decode:function(a,e){e=e||{};var r=e.noDataValue,f=0,n={};if(n.ptr=e.inputOffset||0,n.pixels={},!!d.readHeaderInfo(a,n)){var i=n.headerInfo,m=i.fileVersion,t=d.getDataTypeArray(i.imageType);if(m>5)throw"unsupported lerc version 2."+m;d.readMask(a,n),i.numValidPixel!==i.width*i.height&&!n.pixels.resultMask&&(n.pixels.resultMask=e.maskData);var s=i.width*i.height;n.pixels.resultPixels=new t(s*i.numDims),n.counter={onesweep:0,uncompressed:0,lut:0,bitstuffer:0,constant:0,constantoffset:0};var c=!e.returnPixelInterleavedDims;if(i.numValidPixel!==0)if(i.zMax===i.zMin)d.constructConstantSurface(n,c);else if(m>=4&&d.checkMinMaxRanges(a,n))d.constructConstantSurface(n,c);else{var o=new DataView(a,n.ptr,2),h=o.getUint8(0);if(n.ptr++,h)d.readDataOneSweep(a,n,t,c);else if(m>1&&i.imageType<=1&&Math.abs(i.maxZError-.5)<1e-5){var v=o.getUint8(1);if(n.ptr++,n.encodeMode=v,v>2||m<4&&v>1)throw"Invalid Huffman flag "+v;v?d.readHuffman(a,n,t,c):d.readTiles(a,n,t,c)}else d.readTiles(a,n,t,c)}n.eofOffset=n.ptr;var u;e.inputOffset?(u=n.headerInfo.blobSize+e.inputOffset-n.ptr,Math.abs(u)>=1&&(n.eofOffset=e.inputOffset+n.headerInfo.blobSize)):(u=n.headerInfo.blobSize-n.ptr,Math.abs(u)>=1&&(n.eofOffset=n.headerInfo.blobSize));var l={width:i.width,height:i.height,pixelData:n.pixels.resultPixels,minValue:i.zMin,maxValue:i.zMax,validPixelCount:i.numValidPixel,dimCount:i.numDims,dimStats:{minValues:i.minValues,maxValues:i.maxValues},maskData:n.pixels.resultMask};if(n.pixels.resultMask&&d.isValidPixelValue(i.imageType,r)){var g=n.pixels.resultMask;for(f=0;f<s;f++)g[f]||(l.pixelData[f]=r);l.noDataValue=r}return n.noDataValue=r,e.returnFileInfo&&(l.fileInfo=d.formatFileInfo(n)),l}},getBandCount:function(a){var e=0,r=0,f={};for(f.ptr=0,f.pixels={};r<a.byteLength-58;)d.readHeaderInfo(a,f),r+=f.headerInfo.blobSize,e++,f.ptr=r;return e}};return F})();var ae=(function(){var B=new ArrayBuffer(4),d=new Uint8Array(B),U=new Uint32Array(B);return U[0]=1,d[0]===1})(),se={decode:function(B,d){if(!ae)throw"Big endian system is not supported.";d=d||{};var U=d.inputOffset||0,F=new Uint8Array(B,U,10),a=String.fromCharCode.apply(null,F),e,r;if(a.trim()==="CntZImage")e=ne,r=1;else if(a.substring(0,5)==="Lerc2")e=te,r=2;else throw"Unexpected file identifier string: "+a;for(var f=0,n=B.byteLength-10,i,m=[],t,s,c={width:0,height:0,pixels:[],pixelType:d.pixelType,mask:null,statistics:[]},o=0;U<n;){var h=e.decode(B,{inputOffset:U,encodedMaskData:i,maskData:s,returnMask:f===0,returnEncodedMask:f===0,returnFileInfo:!0,returnPixelInterleavedDims:d.returnPixelInterleavedDims,pixelType:d.pixelType||null,noDataValue:d.noDataValue||null});U=h.fileInfo.eofOffset,s=h.maskData,f===0&&(i=h.encodedMaskData,c.width=h.width,c.height=h.height,c.dimCount=h.dimCount||1,c.pixelType=h.pixelType||h.fileInfo.pixelType,c.mask=s),r>1&&(s&&m.push(s),h.fileInfo.mask&&h.fileInfo.mask.numBytes>0&&o++),f++,c.pixels.push(h.pixelData),c.statistics.push({minValue:h.minValue,maxValue:h.maxValue,noDataValue:h.noDataValue,dimStats:h.dimStats})}var v,u,l;if(r>1&&o>1){for(l=c.width*c.height,c.bandMasks=m,s=new Uint8Array(l),s.set(m[0]),v=1;v<m.length;v++)for(t=m[v],u=0;u<l;u++)s[u]=s[u]&t[u];c.maskData=s}return c}};const fe={0:7e3,1:6e3,2:5e3,3:4e3,4:3e3,5:2500,6:2e3,7:1500,8:800,9:500,10:200,11:100,12:40,13:12,14:5,15:2,16:1,17:.5,18:.2,19:.1,20:.01};class G{static parse(d,U,F){let a=G.decode(d);F[2]-F[0]<1&&(a=G.getSubDEM(a,F));const{array:e,width:r}=a,f=new ie(r),n=fe[U]||0;return f.build(e,n)}static decode(d){const{height:U,width:F,pixels:a}=se.decode(d),e=new Float32Array(U*F);for(let r=0;r<e.length;r++)e[r]=a[0][r];return{array:e,width:F,height:U}}static getSubDEM(d,U){function F(s,c,o,h,v,u,l,g){const x=new Float32Array(v*u);for(let p=0;p<u;p++)for(let y=0;y<v;y++){const M=(p+h)*c+(y+o),S=p*v+y;x[S]=s[M]}const k=new Float32Array(g*l);if(v===l&&u===g)k.set(x);else{const p=v/l,y=u/g;for(let M=0;M<g;M++)for(let S=0;S<l;S++){const I=Math.floor(S*p),D=Math.floor(M*y)*v+I;k[M*l+S]=x[D]}}return k}const{array:a,width:e}=d,{sx:r,sy:f,sw:n,sh:i}=G.getBoundsCoord(U,e),m=e;return{array:F(a,e,r,f,n,i,m,m),width:m,height:m}}static getBoundsCoord(d,U){const F=Math.floor(d[0]*U),a=Math.floor(d[1]*U),e=Math.floor((d[2]-d[0])*U),r=Math.floor((d[3]-d[1])*U);return{sx:F,sy:a,sw:e,sh:r}}}self.onmessage=B=>{const d=B.data,U=G.parse(d.demData,d.z,d.clipBounds);self.postMessage(U)}})();\n',tu=typeof self<"u"&&self.Blob&&new Blob(["(self.URL || self.webkitURL).revokeObjectURL(self.location.href);",eu],{type:"text/javascript;charset=utf-8"});function b0(s){let e;try{if(e=tu&&(self.URL||self.webkitURL).createObjectURL(tu),!e)throw"";const t=new Worker(e,{name:s?.name});return t.addEventListener("error",()=>{(self.URL||self.webkitURL).revokeObjectURL(e)}),t}catch{return new Worker("data:text/javascript;charset=utf-8,"+encodeURIComponent(eu),{name:s?.name})}}var x0=Object.defineProperty,S0=(s,e,t)=>e in s?x0(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,vs=(s,e,t)=>S0(s,typeof e!="symbol"?e+"":e,t);const M0=10;class ru extends oa{constructor(){super(),vs(this,"info",{version:"1.0.0",description:"Loader for ArcGIS LERC compressed terrain data."}),vs(this,"dataType","lerc"),vs(this,"fileLoader",new f.FileLoader(Ve.manager)),vs(this,"workerPool",new Qo(0)),this.fileLoader.setResponseType("arraybuffer"),this.workerPool.setWorkerCreator(()=>new b0)}async performLoad(e,t){this.workerPool.pool===0&&this.workerPool.setWorkerLimit(M0);const r=await this.fileLoader.loadAsync(e).catch(()=>new Float32Array(256*256).buffer),i={demData:r,z:t.z,clipBounds:t.bounds},l=(await this.workerPool.postMessage(i,[r])).data,c=new zi;return c.setTerrainData(l),c}}var A0=Object.defineProperty,P0=(s,e,t)=>e in s?A0(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ws=(s,e,t)=>P0(s,typeof e!="symbol"?e+"":e,t);class bs{constructor(){ws(this,"_imgSources",[]),ws(this,"_demSource"),ws(this,"_vtSource"),ws(this,"manager",Ve.manager)}get imgSource(){return this._imgSources}set imgSource(e){this._imgSources=e}get demSource(){return this._demSource}set demSource(e){this._demSource=e}get vtSource(){return this._vtSource}set vtSource(e){this._vtSource=e}async load(e){const[t,r]=await Promise.all([this.loadGeometry(e),this.loadMaterials(e)]);if(t&&r)for(let i=0;i<r.length;i++)t.addGroup(0,1/0,i);return{geometry:t,materials:r}}unload(e){const t=e.material,r=e.geometry;Array.isArray(t)?t.forEach(i=>i.dispose()):t&&t.dispose(),r&&r.dispose()}async loadGeometry(e){const{z:t,bounds:r}=e;return this.demSource&&t>=this.demSource.minLevel&&this.isBoundsInSource(this.demSource,r)?this.loadFromSource(this.demSource,e,Ve.getGeometryLoader(this.demSource)):this.vtSource&&t>=this.vtSource.minLevel&&this.isBoundsInSource(this.vtSource,r)?this.loadFromSource(this.vtSource,e,Ve.getMeshLoader(this.vtSource)):new f.PlaneGeometry}async loadMaterials(e){const{z:t,bounds:r}=e,o=this._imgSources.filter(l=>t>=l.minLevel&&this.isBoundsInSource(l,r)).map(async l=>{const c=Ve.getMaterialLoader(l);try{const u=await c.load({source:l,...e}),d=m=>{c.unload&&c.unload(m.target),m.target.removeEventListener("dispose",d)};return u instanceof f.MeshBasicMaterial||u.addEventListener("dispose",d),u}catch(u){return console.error(`[CompositeTileLoader] Material load failed for source ${l.dataType}:`,u),new f.MeshBasicMaterial}});return Promise.all(o)}async loadFromSource(e,t,r){try{const i=await r.load({source:e,...t});return i.addEventListener("dispose",()=>{r.unload&&r.unload(i)}),i}catch(i){return console.error(`[CompositeTileLoader] Geometry load failed for source ${e.dataType}:`,i),new f.PlaneGeometry}}isBoundsInSource(e,t){const[r,i,o,l]=e._projectionBounds,[c,u,d,m]=t;return!(d<r||m<i||c>o||u>l)}}const iu=`(function(){"use strict";class s{static parse(t){return s.getDEMFromImage(t.data)}static getDEMFromImage(t){function c(e,g){const a=g*4,[i,u,l,m]=e.slice(a,a+4);return m===0?0:-1e4+(i<<16|u<<8|l)*.1}const n=t.length>>>2,r=new Float32Array(n);for(let e=0;e<n;e++)r[e]=c(t,e);return r}}self.onmessage=o=>{const t=s.parse(o.data.imgData);self.postMessage(t)}})();
`,nu=typeof self<"u"&&self.Blob&&new Blob(["(self.URL || self.webkitURL).revokeObjectURL(self.location.href);",iu],{type:"text/javascript;charset=utf-8"});function C0(s){let e;try{if(e=nu&&(self.URL||self.webkitURL).createObjectURL(nu),!e)throw"";const t=new Worker(e,{name:s?.name});return t.addEventListener("error",()=>{(self.URL||self.webkitURL).revokeObjectURL(e)}),t}catch{return new Worker("data:text/javascript;charset=utf-8,"+encodeURIComponent(iu),{name:s?.name})}}var L0=Object.defineProperty,O0=(s,e,t)=>e in s?L0(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,xs=(s,e,t)=>O0(s,typeof e!="symbol"?e+"":e,t);const D0=10;class su extends oa{constructor(){super(),xs(this,"info",{version:"1.0.0",description:"Mapbox-RGB terrain loader for loading elevation data encoded in RGB textures."}),xs(this,"dataType","terrain-rgb"),xs(this,"imageLoader",new f.ImageLoader(Ve.manager)),xs(this,"workerPool",new Qo(0)),this.workerPool.setWorkerCreator(()=>new C0)}async performLoad(e,t){const r=await this.imageLoader.loadAsync(e).catch(()=>new Image),i=f.MathUtils.clamp((t.z+2)*3,2,64),o=this.extractSubImageData(r,t.bounds,i);this.workerPool.pool===0&&this.workerPool.setWorkerLimit(D0);const c=(await this.workerPool.postMessage({imgData:o},[o.data.buffer])).data,u=new zi;return u.setTerrainData(c),u}extractSubImageData(e,t,r){const i=Pn.getBoundsCoord(t,e.width),o=Math.min(r,i.sw),c=new OffscreenCanvas(o,o).getContext("2d");return c.imageSmoothingEnabled=!1,c.drawImage(e,i.sx,i.sy,i.sw,i.sh,0,0,o,o),c.getImageData(0,0,o,o)}}const ou='(function(){"use strict";const P=23283064365386963e-26,M=12,S=typeof TextDecoder>"u"?null:new TextDecoder("utf-8"),g=0,y=1,F=2,p=5;class E{constructor(t=new Uint8Array(16)){this.buf=ArrayBuffer.isView(t)?t:new Uint8Array(t),this.dataView=new DataView(this.buf.buffer),this.pos=0,this.type=0,this.length=this.buf.length}readFields(t,e,r=this.length){for(;this.pos<r;){const s=this.readVarint(),n=s>>3,o=this.pos;this.type=s&7,t(n,e,this),this.pos===o&&this.skip(s)}return e}readMessage(t,e){return this.readFields(t,e,this.readVarint()+this.pos)}readFixed32(){const t=this.dataView.getUint32(this.pos,!0);return this.pos+=4,t}readSFixed32(){const t=this.dataView.getInt32(this.pos,!0);return this.pos+=4,t}readFixed64(){const t=this.dataView.getUint32(this.pos,!0)+this.dataView.getUint32(this.pos+4,!0)*4294967296;return this.pos+=8,t}readSFixed64(){const t=this.dataView.getUint32(this.pos,!0)+this.dataView.getInt32(this.pos+4,!0)*4294967296;return this.pos+=8,t}readFloat(){const t=this.dataView.getFloat32(this.pos,!0);return this.pos+=4,t}readDouble(){const t=this.dataView.getFloat64(this.pos,!0);return this.pos+=8,t}readVarint(t){const e=this.buf;let r,s;return s=e[this.pos++],r=s&127,s<128||(s=e[this.pos++],r|=(s&127)<<7,s<128)||(s=e[this.pos++],r|=(s&127)<<14,s<128)||(s=e[this.pos++],r|=(s&127)<<21,s<128)?r:(s=e[this.pos],r|=(s&15)<<28,B(r,t,this))}readVarint64(){return this.readVarint(!0)}readSVarint(){const t=this.readVarint();return t%2===1?(t+1)/-2:t/2}readBoolean(){return!!this.readVarint()}readString(){const t=this.readVarint()+this.pos,e=this.pos;return this.pos=t,t-e>=M&&S?S.decode(this.buf.subarray(e,t)):q(this.buf,e,t)}readBytes(){const t=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,t);return this.pos=t,e}readPackedVarint(t=[],e){const r=this.readPackedEnd();for(;this.pos<r;)t.push(this.readVarint(e));return t}readPackedSVarint(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readSVarint());return t}readPackedBoolean(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readBoolean());return t}readPackedFloat(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readFloat());return t}readPackedDouble(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readDouble());return t}readPackedFixed32(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readFixed32());return t}readPackedSFixed32(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readSFixed32());return t}readPackedFixed64(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readFixed64());return t}readPackedSFixed64(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readSFixed64());return t}readPackedEnd(){return this.type===F?this.readVarint()+this.pos:this.pos+1}skip(t){const e=t&7;if(e===g)for(;this.buf[this.pos++]>127;);else if(e===F)this.pos=this.readVarint()+this.pos;else if(e===p)this.pos+=4;else if(e===y)this.pos+=8;else throw new Error(`Unimplemented type: ${e}`)}writeTag(t,e){this.writeVarint(t<<3|e)}realloc(t){let e=this.length||16;for(;e<this.pos+t;)e*=2;if(e!==this.length){const r=new Uint8Array(e);r.set(this.buf),this.buf=r,this.dataView=new DataView(r.buffer),this.length=e}}finish(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)}writeFixed32(t){this.realloc(4),this.dataView.setInt32(this.pos,t,!0),this.pos+=4}writeSFixed32(t){this.realloc(4),this.dataView.setInt32(this.pos,t,!0),this.pos+=4}writeFixed64(t){this.realloc(8),this.dataView.setInt32(this.pos,t&-1,!0),this.dataView.setInt32(this.pos+4,Math.floor(t*P),!0),this.pos+=8}writeSFixed64(t){this.realloc(8),this.dataView.setInt32(this.pos,t&-1,!0),this.dataView.setInt32(this.pos+4,Math.floor(t*P),!0),this.pos+=8}writeVarint(t){if(t=+t||0,t>268435455||t<0){T(t,this);return}this.realloc(4),this.buf[this.pos++]=t&127|(t>127?128:0),!(t<=127)&&(this.buf[this.pos++]=(t>>>=7)&127|(t>127?128:0),!(t<=127)&&(this.buf[this.pos++]=(t>>>=7)&127|(t>127?128:0),!(t<=127)&&(this.buf[this.pos++]=t>>>7&127)))}writeSVarint(t){this.writeVarint(t<0?-t*2-1:t*2)}writeBoolean(t){this.writeVarint(+t)}writeString(t){t=String(t),this.realloc(t.length*4),this.pos++;const e=this.pos;this.pos=O(this.buf,t,this.pos);const r=this.pos-e;r>=128&&k(e,r,this),this.pos=e-1,this.writeVarint(r),this.pos+=r}writeFloat(t){this.realloc(4),this.dataView.setFloat32(this.pos,t,!0),this.pos+=4}writeDouble(t){this.realloc(8),this.dataView.setFloat64(this.pos,t,!0),this.pos+=8}writeBytes(t){const e=t.length;this.writeVarint(e),this.realloc(e);for(let r=0;r<e;r++)this.buf[this.pos++]=t[r]}writeRawMessage(t,e){this.pos++;const r=this.pos;t(e,this);const s=this.pos-r;s>=128&&k(r,s,this),this.pos=r-1,this.writeVarint(s),this.pos+=s}writeMessage(t,e,r){this.writeTag(t,F),this.writeRawMessage(e,r)}writePackedVarint(t,e){e.length&&this.writeMessage(t,C,e)}writePackedSVarint(t,e){e.length&&this.writeMessage(t,L,e)}writePackedBoolean(t,e){e.length&&this.writeMessage(t,U,e)}writePackedFloat(t,e){e.length&&this.writeMessage(t,A,e)}writePackedDouble(t,e){e.length&&this.writeMessage(t,v,e)}writePackedFixed32(t,e){e.length&&this.writeMessage(t,N,e)}writePackedSFixed32(t,e){e.length&&this.writeMessage(t,G,e)}writePackedFixed64(t,e){e.length&&this.writeMessage(t,H,e)}writePackedSFixed64(t,e){e.length&&this.writeMessage(t,R,e)}writeBytesField(t,e){this.writeTag(t,F),this.writeBytes(e)}writeFixed32Field(t,e){this.writeTag(t,p),this.writeFixed32(e)}writeSFixed32Field(t,e){this.writeTag(t,p),this.writeSFixed32(e)}writeFixed64Field(t,e){this.writeTag(t,y),this.writeFixed64(e)}writeSFixed64Field(t,e){this.writeTag(t,y),this.writeSFixed64(e)}writeVarintField(t,e){this.writeTag(t,g),this.writeVarint(e)}writeSVarintField(t,e){this.writeTag(t,g),this.writeSVarint(e)}writeStringField(t,e){this.writeTag(t,F),this.writeString(e)}writeFloatField(t,e){this.writeTag(t,p),this.writeFloat(e)}writeDoubleField(t,e){this.writeTag(t,y),this.writeDouble(e)}writeBooleanField(t,e){this.writeVarintField(t,+e)}}function B(i,t,e){const r=e.buf;let s,n;if(n=r[e.pos++],s=(n&112)>>4,n<128||(n=r[e.pos++],s|=(n&127)<<3,n<128)||(n=r[e.pos++],s|=(n&127)<<10,n<128)||(n=r[e.pos++],s|=(n&127)<<17,n<128)||(n=r[e.pos++],s|=(n&127)<<24,n<128)||(n=r[e.pos++],s|=(n&1)<<31,n<128))return w(i,s,t);throw new Error("Expected varint not more than 10 bytes")}function w(i,t,e){return e?t*4294967296+(i>>>0):(t>>>0)*4294967296+(i>>>0)}function T(i,t){let e,r;if(i>=0?(e=i%4294967296|0,r=i/4294967296|0):(e=~(-i%4294967296),r=~(-i/4294967296),e^4294967295?e=e+1|0:(e=0,r=r+1|0)),i>=18446744073709552e3||i<-18446744073709552e3)throw new Error("Given varint doesn\'t fit into 10 bytes");t.realloc(10),D(e,r,t),I(r,t)}function D(i,t,e){e.buf[e.pos++]=i&127|128,i>>>=7,e.buf[e.pos++]=i&127|128,i>>>=7,e.buf[e.pos++]=i&127|128,i>>>=7,e.buf[e.pos++]=i&127|128,i>>>=7,e.buf[e.pos]=i&127}function I(i,t){const e=(i&7)<<4;t.buf[t.pos++]|=e|((i>>>=3)?128:0),i&&(t.buf[t.pos++]=i&127|((i>>>=7)?128:0),i&&(t.buf[t.pos++]=i&127|((i>>>=7)?128:0),i&&(t.buf[t.pos++]=i&127|((i>>>=7)?128:0),i&&(t.buf[t.pos++]=i&127|((i>>>=7)?128:0),i&&(t.buf[t.pos++]=i&127)))))}function k(i,t,e){const r=t<=16383?1:t<=2097151?2:t<=268435455?3:Math.floor(Math.log(t)/(Math.LN2*7));e.realloc(r);for(let s=e.pos-1;s>=i;s--)e.buf[s+r]=e.buf[s]}function C(i,t){for(let e=0;e<i.length;e++)t.writeVarint(i[e])}function L(i,t){for(let e=0;e<i.length;e++)t.writeSVarint(i[e])}function A(i,t){for(let e=0;e<i.length;e++)t.writeFloat(i[e])}function v(i,t){for(let e=0;e<i.length;e++)t.writeDouble(i[e])}function U(i,t){for(let e=0;e<i.length;e++)t.writeBoolean(i[e])}function N(i,t){for(let e=0;e<i.length;e++)t.writeFixed32(i[e])}function G(i,t){for(let e=0;e<i.length;e++)t.writeSFixed32(i[e])}function H(i,t){for(let e=0;e<i.length;e++)t.writeFixed64(i[e])}function R(i,t){for(let e=0;e<i.length;e++)t.writeSFixed64(i[e])}function q(i,t,e){let r="",s=t;for(;s<e;){const n=i[s];let o=null,h=n>239?4:n>223?3:n>191?2:1;if(s+h>e)break;let a,d,l;h===1?n<128&&(o=n):h===2?(a=i[s+1],(a&192)===128&&(o=(n&31)<<6|a&63,o<=127&&(o=null))):h===3?(a=i[s+1],d=i[s+2],(a&192)===128&&(d&192)===128&&(o=(n&15)<<12|(a&63)<<6|d&63,(o<=2047||o>=55296&&o<=57343)&&(o=null))):h===4&&(a=i[s+1],d=i[s+2],l=i[s+3],(a&192)===128&&(d&192)===128&&(l&192)===128&&(o=(n&15)<<18|(a&63)<<12|(d&63)<<6|l&63,(o<=65535||o>=1114112)&&(o=null))),o===null?(o=65533,h=1):o>65535&&(o-=65536,r+=String.fromCharCode(o>>>10&1023|55296),o=56320|o&1023),r+=String.fromCharCode(o),s+=h}return r}function O(i,t,e){for(let r=0,s,n;r<t.length;r++){if(s=t.charCodeAt(r),s>55295&&s<57344)if(n)if(s<56320){i[e++]=239,i[e++]=191,i[e++]=189,n=s;continue}else s=n-55296<<10|s-56320|65536,n=null;else{s>56319||r+1===t.length?(i[e++]=239,i[e++]=191,i[e++]=189):n=s;continue}else n&&(i[e++]=239,i[e++]=191,i[e++]=189,n=null);s<128?i[e++]=s:(s<2048?i[e++]=s>>6|192:(s<65536?i[e++]=s>>12|224:(i[e++]=s>>18|240,i[e++]=s>>12&63|128),i[e++]=s>>6&63|128),i[e++]=s&63|128)}return e}function f(i,t){this.x=i,this.y=t}f.prototype={clone(){return new f(this.x,this.y)},add(i){return this.clone()._add(i)},sub(i){return this.clone()._sub(i)},multByPoint(i){return this.clone()._multByPoint(i)},divByPoint(i){return this.clone()._divByPoint(i)},mult(i){return this.clone()._mult(i)},div(i){return this.clone()._div(i)},rotate(i){return this.clone()._rotate(i)},rotateAround(i,t){return this.clone()._rotateAround(i,t)},matMult(i){return this.clone()._matMult(i)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(i){return this.x===i.x&&this.y===i.y},dist(i){return Math.sqrt(this.distSqr(i))},distSqr(i){const t=i.x-this.x,e=i.y-this.y;return t*t+e*e},angle(){return Math.atan2(this.y,this.x)},angleTo(i){return Math.atan2(this.y-i.y,this.x-i.x)},angleWith(i){return this.angleWithSep(i.x,i.y)},angleWithSep(i,t){return Math.atan2(this.x*t-this.y*i,this.x*i+this.y*t)},_matMult(i){const t=i[0]*this.x+i[1]*this.y,e=i[2]*this.x+i[3]*this.y;return this.x=t,this.y=e,this},_add(i){return this.x+=i.x,this.y+=i.y,this},_sub(i){return this.x-=i.x,this.y-=i.y,this},_mult(i){return this.x*=i,this.y*=i,this},_div(i){return this.x/=i,this.y/=i,this},_multByPoint(i){return this.x*=i.x,this.y*=i.y,this},_divByPoint(i){return this.x/=i.x,this.y/=i.y,this},_unit(){return this._div(this.mag()),this},_perp(){const i=this.y;return this.y=this.x,this.x=-i,this},_rotate(i){const t=Math.cos(i),e=Math.sin(i),r=t*this.x-e*this.y,s=e*this.x+t*this.y;return this.x=r,this.y=s,this},_rotateAround(i,t){const e=Math.cos(i),r=Math.sin(i),s=t.x+e*(this.x-t.x)-r*(this.y-t.y),n=t.y+r*(this.x-t.x)+e*(this.y-t.y);return this.x=s,this.y=n,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:f},f.convert=function(i){if(i instanceof f)return i;if(Array.isArray(i))return new f(+i[0],+i[1]);if(i.x!==void 0&&i.y!==void 0)return new f(+i.x,+i.y);throw new Error("Expected [x, y] or {x, y} point format")};class m{constructor(t,e,r,s,n){this.properties={},this.extent=r,this.type=0,this.id=void 0,this._pbf=t,this._geometry=-1,this._keys=s,this._values=n,t.readFields(j,this,e)}loadGeometry(){const t=this._pbf;t.pos=this._geometry;const e=t.readVarint()+t.pos,r=[];let s,n=1,o=0,h=0,a=0;for(;t.pos<e;){if(o<=0){const d=t.readVarint();n=d&7,o=d>>3}if(o--,n===1||n===2)h+=t.readSVarint(),a+=t.readSVarint(),n===1&&(s&&r.push(s),s=[]),s&&s.push(new f(h,a));else if(n===7)s&&s.push(s[0].clone());else throw new Error(`unknown command ${n}`)}return s&&r.push(s),r}bbox(){const t=this._pbf;t.pos=this._geometry;const e=t.readVarint()+t.pos;let r=1,s=0,n=0,o=0,h=1/0,a=-1/0,d=1/0,l=-1/0;for(;t.pos<e;){if(s<=0){const x=t.readVarint();r=x&7,s=x>>3}if(s--,r===1||r===2)n+=t.readSVarint(),o+=t.readSVarint(),n<h&&(h=n),n>a&&(a=n),o<d&&(d=o),o>l&&(l=o);else if(r!==7)throw new Error(`unknown command ${r}`)}return[h,d,a,l]}toGeoJSON(t,e,r){const s=this.extent*Math.pow(2,r),n=this.extent*t,o=this.extent*e,h=this.loadGeometry();function a(u){return[(u.x+n)*360/s-180,360/Math.PI*Math.atan(Math.exp((1-(u.y+o)*2/s)*Math.PI))-90]}function d(u){return u.map(a)}let l;if(this.type===1){const u=[];for(const _ of h)u.push(_[0]);const c=d(u);l=u.length===1?{type:"Point",coordinates:c[0]}:{type:"MultiPoint",coordinates:c}}else if(this.type===2){const u=h.map(d);l=u.length===1?{type:"LineString",coordinates:u[0]}:{type:"MultiLineString",coordinates:u}}else if(this.type===3){const u=W(h),c=[];for(const _ of u)c.push(_.map(d));l=c.length===1?{type:"Polygon",coordinates:c[0]}:{type:"MultiPolygon",coordinates:c}}else throw new Error("unknown feature type");const x={type:"Feature",geometry:l,properties:this.properties};return this.id!=null&&(x.id=this.id),x}}m.types=["Unknown","Point","LineString","Polygon"];function j(i,t,e){i===1?t.id=e.readVarint():i===2?J(e,t):i===3?t.type=e.readVarint():i===4&&(t._geometry=e.pos)}function J(i,t){const e=i.readVarint()+i.pos;for(;i.pos<e;){const r=t._keys[i.readVarint()],s=t._values[i.readVarint()];t.properties[r]=s}}function W(i){const t=i.length;if(t<=1)return[i];const e=[];let r,s;for(let n=0;n<t;n++){const o=X(i[n]);o!==0&&(s===void 0&&(s=o<0),s===o<0?(r&&e.push(r),r=[i[n]]):r&&r.push(i[n]))}return r&&e.push(r),e}function X(i){let t=0;for(let e=0,r=i.length,s=r-1,n,o;e<r;s=e++)n=i[e],o=i[s],t+=(o.x-n.x)*(n.y+o.y);return t}class ${constructor(t,e){this.version=1,this.name="",this.extent=4096,this.length=0,this._pbf=t,this._keys=[],this._values=[],this._features=[],t.readFields(b,this,e),this.length=this._features.length}feature(t){if(t<0||t>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[t];const e=this._pbf.readVarint()+this._pbf.pos;return new m(this._pbf,e,this.extent,this._keys,this._values)}}function b(i,t,e){i===15?t.version=e.readVarint():i===1?t.name=e.readString():i===5?t.extent=e.readVarint():i===2?t._features.push(e.pos):i===3?t._keys.push(e.readString()):i===4&&t._values.push(z(e))}function z(i){let t=null;const e=i.readVarint()+i.pos;for(;i.pos<e;){const r=i.readVarint()>>3;t=r===1?i.readString():r===2?i.readFloat():r===3?i.readDouble():r===4?i.readVarint64():r===5?i.readVarint():r===6?i.readSVarint():r===7?i.readBoolean():null}if(t==null)throw new Error("unknown feature value");return t}class Y{constructor(t,e){this.layers=t.readFields(K,{},e)}}function K(i,t,e){if(i===3){const r=new $(e,e.readVarint()+e.pos);r.length&&(t[r.name]=r)}}class V{static async parse(t,e,r,s){try{const n=V.mvt2GeoJSON(t,e,r,s);return{x:e,y:r,z:s,layers:n,timestamp:Date.now(),dataFormat:"mvt"}}catch(n){throw console.error("[MVTParser] Error parsing vector tile data:",n),n}}static mvt2GeoJSON(t,e,r,s){const n=new E(t),o=new Y(n),h={};for(const a in o.layers){const d=o.layers[a],l=[];for(let x=0;x<d.length;x++){const c=d.feature(x).toGeoJSON(e,r,s);l.push(c)}h[a]=l}return h}}self.onmessage=async i=>{const t=i.data;try{const e=await V.parse(t.arrayBuffer,t.x,t.y,t.z);self.postMessage(e)}catch(e){console.error("Worker MVT Parse Failed:",e),self.postMessage({error:e.message})}}})();\n',au=typeof self<"u"&&self.Blob&&new Blob(["(self.URL || self.webkitURL).revokeObjectURL(self.location.href);",ou],{type:"text/javascript;charset=utf-8"});function I0(s){let e;try{if(e=au&&(self.URL||self.webkitURL).createObjectURL(au),!e)throw"";const t=new Worker(e,{name:s?.name});return t.addEventListener("error",()=>{(self.URL||self.webkitURL).revokeObjectURL(e)}),t}catch{return new Worker("data:text/javascript;charset=utf-8,"+encodeURIComponent(ou),{name:s?.name})}}var F0=Object.defineProperty,T0=(s,e,t)=>e in s?F0(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ss=(s,e,t)=>T0(s,typeof e!="symbol"?e+"":e,t);const B0=10;class lu{constructor(){Ss(this,"info",{version:"2.0.0",description:"Mapbox Vector Tile Geometry Loader (Refactored)"}),Ss(this,"dataType","vector-tile"),Ss(this,"fileLoader",new f.FileLoader(Ve.manager)),Ss(this,"_workerPool",new Qo(0)),this.fileLoader.setResponseType("arraybuffer"),this._workerPool.setWorkerCreator(()=>new I0)}async load(e){const{source:t,x:r,y:i,z:o}=e,l=typeof t._getUrl=="function"?t._getUrl(r,i,o):this.buildTileUrl(t.url,r,i,o);if(!l)return this.createErrorGeometry(r,i,o,new Error("Source returned empty URL"));this._workerPool.pool===0&&this._workerPool.setWorkerLimit(B0);try{const c=await this.fetchVectorData(l),u={arrayBuffer:c,x:r,y:i,z:o},m=(await this._workerPool.postMessage(u,[c])).data;if(m.error)throw new Error(m.error);const p=this.createGeometryWithVectorData(m,e);return Ve.manager.parseEnd(l),p}catch(c){return this.createErrorGeometry(r,i,o,c)}}async fetchVectorData(e){try{const t=await this.fileLoader.loadAsync(e);if(!t||t.byteLength===0)throw new Error("Empty response");return t}catch(t){throw new Error(`Failed to fetch vector tile: ${t.message}`)}}buildTileUrl(e,t,r,i){return e?e.replace("{x}",t.toString()).replace("{y}",r.toString()).replace("{z}",i.toString()).replace("{-y}",(Math.pow(2,i)-1-r).toString()):""}createGeometryWithVectorData(e,t){const r=new zi;return r.userData={vectorData:e,tileInfo:{x:t.x,y:t.y,z:t.z,bounds:t.bounds},metadata:{dataType:this.dataType,version:this.info.version,loadedAt:Date.now()}},r}createErrorGeometry(e,t,r,i){const o=new zi,l=4007501668557849e-8/Math.pow(2,r);return o.userData={vectorData:{x:e,y:t,z:r,layers:{},totalFeatures:0,bounds:{world:{x:l,y:l}},error:i.message||"Unknown error",timestamp:Date.now(),dataFormat:"error"},tileInfo:{x:e,y:t,z:r,bounds:[0,0,0,0]},metadata:{dataType:"vector-tile-error",error:!0,errorMessage:i.message}},o}unload(e){e.userData?.vectorData&&(e.userData.vectorData=null),e.dispose()}}function jr(s,e){this.x=s,this.y=e}jr.prototype={clone(){return new jr(this.x,this.y)},add(s){return this.clone()._add(s)},sub(s){return this.clone()._sub(s)},multByPoint(s){return this.clone()._multByPoint(s)},divByPoint(s){return this.clone()._divByPoint(s)},mult(s){return this.clone()._mult(s)},div(s){return this.clone()._div(s)},rotate(s){return this.clone()._rotate(s)},rotateAround(s,e){return this.clone()._rotateAround(s,e)},matMult(s){return this.clone()._matMult(s)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(s){return this.x===s.x&&this.y===s.y},dist(s){return Math.sqrt(this.distSqr(s))},distSqr(s){const e=s.x-this.x,t=s.y-this.y;return e*e+t*t},angle(){return Math.atan2(this.y,this.x)},angleTo(s){return Math.atan2(this.y-s.y,this.x-s.x)},angleWith(s){return this.angleWithSep(s.x,s.y)},angleWithSep(s,e){return Math.atan2(this.x*e-this.y*s,this.x*s+this.y*e)},_matMult(s){const e=s[0]*this.x+s[1]*this.y,t=s[2]*this.x+s[3]*this.y;return this.x=e,this.y=t,this},_add(s){return this.x+=s.x,this.y+=s.y,this},_sub(s){return this.x-=s.x,this.y-=s.y,this},_mult(s){return this.x*=s,this.y*=s,this},_div(s){return this.x/=s,this.y/=s,this},_multByPoint(s){return this.x*=s.x,this.y*=s.y,this},_divByPoint(s){return this.x/=s.x,this.y/=s.y,this},_unit(){return this._div(this.mag()),this},_perp(){const s=this.y;return this.y=this.x,this.x=-s,this},_rotate(s){const e=Math.cos(s),t=Math.sin(s),r=e*this.x-t*this.y,i=t*this.x+e*this.y;return this.x=r,this.y=i,this},_rotateAround(s,e){const t=Math.cos(s),r=Math.sin(s),i=e.x+t*(this.x-e.x)-r*(this.y-e.y),o=e.y+r*(this.x-e.x)+t*(this.y-e.y);return this.x=i,this.y=o,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:jr},jr.convert=function(s){if(s instanceof jr)return s;if(Array.isArray(s))return new jr(+s[0],+s[1]);if(s.x!==void 0&&s.y!==void 0)return new jr(+s.x,+s.y);throw new Error("Expected [x, y] or {x, y} point format")};class cu{constructor(e,t,r,i,o){this.properties={},this.extent=r,this.type=0,this.id=void 0,this._pbf=e,this._geometry=-1,this._keys=i,this._values=o,e.readFields(U0,this,t)}loadGeometry(){const e=this._pbf;e.pos=this._geometry;const t=e.readVarint()+e.pos,r=[];let i,o=1,l=0,c=0,u=0;for(;e.pos<t;){if(l<=0){const d=e.readVarint();o=d&7,l=d>>3}if(l--,o===1||o===2)c+=e.readSVarint(),u+=e.readSVarint(),o===1&&(i&&r.push(i),i=[]),i&&i.push(new jr(c,u));else if(o===7)i&&i.push(i[0].clone());else throw new Error(`unknown command ${o}`)}return i&&r.push(i),r}bbox(){const e=this._pbf;e.pos=this._geometry;const t=e.readVarint()+e.pos;let r=1,i=0,o=0,l=0,c=1/0,u=-1/0,d=1/0,m=-1/0;for(;e.pos<t;){if(i<=0){const p=e.readVarint();r=p&7,i=p>>3}if(i--,r===1||r===2)o+=e.readSVarint(),l+=e.readSVarint(),o<c&&(c=o),o>u&&(u=o),l<d&&(d=l),l>m&&(m=l);else if(r!==7)throw new Error(`unknown command ${r}`)}return[c,d,u,m]}toGeoJSON(e,t,r){const i=this.extent*Math.pow(2,r),o=this.extent*e,l=this.extent*t,c=this.loadGeometry();function u(_){return[(_.x+o)*360/i-180,360/Math.PI*Math.atan(Math.exp((1-(_.y+l)*2/i)*Math.PI))-90]}function d(_){return _.map(u)}let m;if(this.type===1){const _=[];for(const S of c)_.push(S[0]);const v=d(_);m=_.length===1?{type:"Point",coordinates:v[0]}:{type:"MultiPoint",coordinates:v}}else if(this.type===2){const _=c.map(d);m=_.length===1?{type:"LineString",coordinates:_[0]}:{type:"MultiLineString",coordinates:_}}else if(this.type===3){const _=k0(c),v=[];for(const S of _)v.push(S.map(d));m=v.length===1?{type:"Polygon",coordinates:v[0]}:{type:"MultiPolygon",coordinates:v}}else throw new Error("unknown feature type");const p={type:"Feature",geometry:m,properties:this.properties};return this.id!=null&&(p.id=this.id),p}}cu.types=["Unknown","Point","LineString","Polygon"];function U0(s,e,t){s===1?e.id=t.readVarint():s===2?V0(t,e):s===3?e.type=t.readVarint():s===4&&(e._geometry=t.pos)}function V0(s,e){const t=s.readVarint()+s.pos;for(;s.pos<t;){const r=e._keys[s.readVarint()],i=e._values[s.readVarint()];e.properties[r]=i}}function k0(s){const e=s.length;if(e<=1)return[s];const t=[];let r,i;for(let o=0;o<e;o++){const l=z0(s[o]);l!==0&&(i===void 0&&(i=l<0),i===l<0?(r&&t.push(r),r=[s[o]]):r&&r.push(s[o]))}return r&&t.push(r),t}function z0(s){let e=0;for(let t=0,r=s.length,i=r-1,o,l;t<r;i=t++)o=s[t],l=s[i],e+=(l.x-o.x)*(o.y+l.y);return e}let N0=class{constructor(e,t){this.version=1,this.name="",this.extent=4096,this.length=0,this._pbf=e,this._keys=[],this._values=[],this._features=[],e.readFields(W0,this,t),this.length=this._features.length}feature(e){if(e<0||e>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[e];const t=this._pbf.readVarint()+this._pbf.pos;return new cu(this._pbf,t,this.extent,this._keys,this._values)}};function W0(s,e,t){s===15?e.version=t.readVarint():s===1?e.name=t.readString():s===5?e.extent=t.readVarint():s===2?e._features.push(t.pos):s===3?e._keys.push(t.readString()):s===4&&e._values.push(G0(t))}function G0(s){let e=null;const t=s.readVarint()+s.pos;for(;s.pos<t;){const r=s.readVarint()>>3;e=r===1?s.readString():r===2?s.readFloat():r===3?s.readDouble():r===4?s.readVarint64():r===5?s.readVarint():r===6?s.readSVarint():r===7?s.readBoolean():null}if(e==null)throw new Error("unknown feature value");return e}class R0{constructor(e,t){this.layers=e.readFields(j0,{},t)}}function j0(s,e,t){if(s===3){const r=new N0(t,t.readVarint()+t.pos);r.length&&(e[r.name]=r)}}const aa=65536*65536,uu=1/aa,$0=12,hu=typeof TextDecoder>"u"?null:new TextDecoder("utf-8"),la=0,Ms=1,Cn=2,As=5;class X0{constructor(e=new Uint8Array(16)){this.buf=ArrayBuffer.isView(e)?e:new Uint8Array(e),this.dataView=new DataView(this.buf.buffer),this.pos=0,this.type=0,this.length=this.buf.length}readFields(e,t,r=this.length){for(;this.pos<r;){const i=this.readVarint(),o=i>>3,l=this.pos;this.type=i&7,e(o,t,this),this.pos===l&&this.skip(i)}return t}readMessage(e,t){return this.readFields(e,t,this.readVarint()+this.pos)}readFixed32(){const e=this.dataView.getUint32(this.pos,!0);return this.pos+=4,e}readSFixed32(){const e=this.dataView.getInt32(this.pos,!0);return this.pos+=4,e}readFixed64(){const e=this.dataView.getUint32(this.pos,!0)+this.dataView.getUint32(this.pos+4,!0)*aa;return this.pos+=8,e}readSFixed64(){const e=this.dataView.getUint32(this.pos,!0)+this.dataView.getInt32(this.pos+4,!0)*aa;return this.pos+=8,e}readFloat(){const e=this.dataView.getFloat32(this.pos,!0);return this.pos+=4,e}readDouble(){const e=this.dataView.getFloat64(this.pos,!0);return this.pos+=8,e}readVarint(e){const t=this.buf;let r,i;return i=t[this.pos++],r=i&127,i<128||(i=t[this.pos++],r|=(i&127)<<7,i<128)||(i=t[this.pos++],r|=(i&127)<<14,i<128)||(i=t[this.pos++],r|=(i&127)<<21,i<128)?r:(i=t[this.pos],r|=(i&15)<<28,Y0(r,e,this))}readVarint64(){return this.readVarint(!0)}readSVarint(){const e=this.readVarint();return e%2===1?(e+1)/-2:e/2}readBoolean(){return!!this.readVarint()}readString(){const e=this.readVarint()+this.pos,t=this.pos;return this.pos=e,e-t>=$0&&hu?hu.decode(this.buf.subarray(t,e)):sy(this.buf,t,e)}readBytes(){const e=this.readVarint()+this.pos,t=this.buf.subarray(this.pos,e);return this.pos=e,t}readPackedVarint(e=[],t){const r=this.readPackedEnd();for(;this.pos<r;)e.push(this.readVarint(t));return e}readPackedSVarint(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readSVarint());return e}readPackedBoolean(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readBoolean());return e}readPackedFloat(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readFloat());return e}readPackedDouble(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readDouble());return e}readPackedFixed32(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readFixed32());return e}readPackedSFixed32(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readSFixed32());return e}readPackedFixed64(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readFixed64());return e}readPackedSFixed64(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readSFixed64());return e}readPackedEnd(){return this.type===Cn?this.readVarint()+this.pos:this.pos+1}skip(e){const t=e&7;if(t===la)for(;this.buf[this.pos++]>127;);else if(t===Cn)this.pos=this.readVarint()+this.pos;else if(t===As)this.pos+=4;else if(t===Ms)this.pos+=8;else throw new Error(`Unimplemented type: ${t}`)}writeTag(e,t){this.writeVarint(e<<3|t)}realloc(e){let t=this.length||16;for(;t<this.pos+e;)t*=2;if(t!==this.length){const r=new Uint8Array(t);r.set(this.buf),this.buf=r,this.dataView=new DataView(r.buffer),this.length=t}}finish(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)}writeFixed32(e){this.realloc(4),this.dataView.setInt32(this.pos,e,!0),this.pos+=4}writeSFixed32(e){this.realloc(4),this.dataView.setInt32(this.pos,e,!0),this.pos+=4}writeFixed64(e){this.realloc(8),this.dataView.setInt32(this.pos,e&-1,!0),this.dataView.setInt32(this.pos+4,Math.floor(e*uu),!0),this.pos+=8}writeSFixed64(e){this.realloc(8),this.dataView.setInt32(this.pos,e&-1,!0),this.dataView.setInt32(this.pos+4,Math.floor(e*uu),!0),this.pos+=8}writeVarint(e){if(e=+e||0,e>268435455||e<0){Z0(e,this);return}this.realloc(4),this.buf[this.pos++]=e&127|(e>127?128:0),!(e<=127)&&(this.buf[this.pos++]=(e>>>=7)&127|(e>127?128:0),!(e<=127)&&(this.buf[this.pos++]=(e>>>=7)&127|(e>127?128:0),!(e<=127)&&(this.buf[this.pos++]=e>>>7&127)))}writeSVarint(e){this.writeVarint(e<0?-e*2-1:e*2)}writeBoolean(e){this.writeVarint(+e)}writeString(e){e=String(e),this.realloc(e.length*4),this.pos++;const t=this.pos;this.pos=oy(this.buf,e,this.pos);const r=this.pos-t;r>=128&&fu(t,r,this),this.pos=t-1,this.writeVarint(r),this.pos+=r}writeFloat(e){this.realloc(4),this.dataView.setFloat32(this.pos,e,!0),this.pos+=4}writeDouble(e){this.realloc(8),this.dataView.setFloat64(this.pos,e,!0),this.pos+=8}writeBytes(e){const t=e.length;this.writeVarint(t),this.realloc(t);for(let r=0;r<t;r++)this.buf[this.pos++]=e[r]}writeRawMessage(e,t){this.pos++;const r=this.pos;e(t,this);const i=this.pos-r;i>=128&&fu(r,i,this),this.pos=r-1,this.writeVarint(i),this.pos+=i}writeMessage(e,t,r){this.writeTag(e,Cn),this.writeRawMessage(t,r)}writePackedVarint(e,t){t.length&&this.writeMessage(e,Q0,t)}writePackedSVarint(e,t){t.length&&this.writeMessage(e,J0,t)}writePackedBoolean(e,t){t.length&&this.writeMessage(e,ey,t)}writePackedFloat(e,t){t.length&&this.writeMessage(e,E0,t)}writePackedDouble(e,t){t.length&&this.writeMessage(e,H0,t)}writePackedFixed32(e,t){t.length&&this.writeMessage(e,ty,t)}writePackedSFixed32(e,t){t.length&&this.writeMessage(e,ry,t)}writePackedFixed64(e,t){t.length&&this.writeMessage(e,iy,t)}writePackedSFixed64(e,t){t.length&&this.writeMessage(e,ny,t)}writeBytesField(e,t){this.writeTag(e,Cn),this.writeBytes(t)}writeFixed32Field(e,t){this.writeTag(e,As),this.writeFixed32(t)}writeSFixed32Field(e,t){this.writeTag(e,As),this.writeSFixed32(t)}writeFixed64Field(e,t){this.writeTag(e,Ms),this.writeFixed64(t)}writeSFixed64Field(e,t){this.writeTag(e,Ms),this.writeSFixed64(t)}writeVarintField(e,t){this.writeTag(e,la),this.writeVarint(t)}writeSVarintField(e,t){this.writeTag(e,la),this.writeSVarint(t)}writeStringField(e,t){this.writeTag(e,Cn),this.writeString(t)}writeFloatField(e,t){this.writeTag(e,As),this.writeFloat(t)}writeDoubleField(e,t){this.writeTag(e,Ms),this.writeDouble(t)}writeBooleanField(e,t){this.writeVarintField(e,+t)}}function Y0(s,e,t){const r=t.buf;let i,o;if(o=r[t.pos++],i=(o&112)>>4,o<128||(o=r[t.pos++],i|=(o&127)<<3,o<128)||(o=r[t.pos++],i|=(o&127)<<10,o<128)||(o=r[t.pos++],i|=(o&127)<<17,o<128)||(o=r[t.pos++],i|=(o&127)<<24,o<128)||(o=r[t.pos++],i|=(o&1)<<31,o<128))return Wi(s,i,e);throw new Error("Expected varint not more than 10 bytes")}function Wi(s,e,t){return t?e*4294967296+(s>>>0):(e>>>0)*4294967296+(s>>>0)}function Z0(s,e){let t,r;if(s>=0?(t=s%4294967296|0,r=s/4294967296|0):(t=~(-s%4294967296),r=~(-s/4294967296),t^4294967295?t=t+1|0:(t=0,r=r+1|0)),s>=18446744073709552e3||s<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");e.realloc(10),K0(t,r,e),q0(r,e)}function K0(s,e,t){t.buf[t.pos++]=s&127|128,s>>>=7,t.buf[t.pos++]=s&127|128,s>>>=7,t.buf[t.pos++]=s&127|128,s>>>=7,t.buf[t.pos++]=s&127|128,s>>>=7,t.buf[t.pos]=s&127}function q0(s,e){const t=(s&7)<<4;e.buf[e.pos++]|=t|((s>>>=3)?128:0),s&&(e.buf[e.pos++]=s&127|((s>>>=7)?128:0),s&&(e.buf[e.pos++]=s&127|((s>>>=7)?128:0),s&&(e.buf[e.pos++]=s&127|((s>>>=7)?128:0),s&&(e.buf[e.pos++]=s&127|((s>>>=7)?128:0),s&&(e.buf[e.pos++]=s&127)))))}function fu(s,e,t){const r=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(Math.LN2*7));t.realloc(r);for(let i=t.pos-1;i>=s;i--)t.buf[i+r]=t.buf[i]}function Q0(s,e){for(let t=0;t<s.length;t++)e.writeVarint(s[t])}function J0(s,e){for(let t=0;t<s.length;t++)e.writeSVarint(s[t])}function E0(s,e){for(let t=0;t<s.length;t++)e.writeFloat(s[t])}function H0(s,e){for(let t=0;t<s.length;t++)e.writeDouble(s[t])}function ey(s,e){for(let t=0;t<s.length;t++)e.writeBoolean(s[t])}function ty(s,e){for(let t=0;t<s.length;t++)e.writeFixed32(s[t])}function ry(s,e){for(let t=0;t<s.length;t++)e.writeSFixed32(s[t])}function iy(s,e){for(let t=0;t<s.length;t++)e.writeFixed64(s[t])}function ny(s,e){for(let t=0;t<s.length;t++)e.writeSFixed64(s[t])}function sy(s,e,t){let r="",i=e;for(;i<t;){const o=s[i];let l=null,c=o>239?4:o>223?3:o>191?2:1;if(i+c>t)break;let u,d,m;c===1?o<128&&(l=o):c===2?(u=s[i+1],(u&192)===128&&(l=(o&31)<<6|u&63,l<=127&&(l=null))):c===3?(u=s[i+1],d=s[i+2],(u&192)===128&&(d&192)===128&&(l=(o&15)<<12|(u&63)<<6|d&63,(l<=2047||l>=55296&&l<=57343)&&(l=null))):c===4&&(u=s[i+1],d=s[i+2],m=s[i+3],(u&192)===128&&(d&192)===128&&(m&192)===128&&(l=(o&15)<<18|(u&63)<<12|(d&63)<<6|m&63,(l<=65535||l>=1114112)&&(l=null))),l===null?(l=65533,c=1):l>65535&&(l-=65536,r+=String.fromCharCode(l>>>10&1023|55296),l=56320|l&1023),r+=String.fromCharCode(l),i+=c}return r}function oy(s,e,t){for(let r=0,i,o;r<e.length;r++){if(i=e.charCodeAt(r),i>55295&&i<57344)if(o)if(i<56320){s[t++]=239,s[t++]=191,s[t++]=189,o=i;continue}else i=o-55296<<10|i-56320|65536,o=null;else{i>56319||r+1===e.length?(s[t++]=239,s[t++]=191,s[t++]=189):o=i;continue}else o&&(s[t++]=239,s[t++]=191,s[t++]=189,o=null);i<128?s[t++]=i:(i<2048?s[t++]=i>>6|192:(i<65536?s[t++]=i>>12|224:(s[t++]=i>>18|240,s[t++]=i>>12&63|128),s[t++]=i>>6&63|128),s[t++]=i&63|128)}return t}var ay=Object.defineProperty,ly=(s,e,t)=>e in s?ay(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ps=(s,e,t)=>ly(s,typeof e!="symbol"?e+"":e,t);class du extends ys{constructor(){super(),Ps(this,"info",{version:"2.0.0",description:"Vector Tile Texture Loader (Refactored)"}),Ps(this,"dataType","mvt"),Ps(this,"_loader",new f.FileLoader(Ve.manager)),Ps(this,"_render",new Qc),this._loader.setResponseType("arraybuffer")}async performLoad(e,t){const r=await this._loader.loadAsync(e),i=new R0(new X0(r)),o=t.source.style,l=this.drawTile(i,o,t.z);return new f.CanvasTexture(l)}drawTile(e,t,r){const l=new OffscreenCanvas(256,256),c=l.getContext("2d");if(!c)throw new Error("Canvas context is not available");if(t)for(const u in t.layer){const d=t.layer[u];if(r<(d.minLevel??1)||r>(d.maxLevel??20))continue;const m=e.layers[u];if(m){const p=256/m.extent;this._renderLayer(c,m,d,p)}}else for(const u in e.layers){const d=e.layers[u],m=256/d.extent;this._renderLayer(c,d,void 0,m)}return l}_renderLayer(e,t,r,i=1){e.save();for(let o=0;o<t.length;o++){const l=t.feature(o);this._renderFeature(e,l,r,i)}e.restore()}_renderFeature(e,t,r={},i=1){const o=[Xe.Unknown,Xe.Point,Xe.Linestring,Xe.Polygon][t.type],l={geometry:t.loadGeometry(),properties:t.properties};this._render.render(e,o,l,r,i)}convertVectorTileToGeoJSON(e){const t=[];for(const r in e.layers){const i=e.layers[r];for(let o=0;o<i.length;o++){const l=i.feature(o),c=[Xe.Unknown,Xe.Point,Xe.Linestring,Xe.Polygon,Xe.Unknown][l.type],u={geometry:l.loadGeometry(),properties:l.properties},d=this._convertToGeoJSONFeature(u,c);d&&(d.properties._layer=r,t.push(d))}}return{type:"FeatureCollection",features:t}}_convertToGeoJSONFeature(e,t){const r=this._convertGeometryToGeoJSON(e.geometry,t);return r?{type:"Feature",geometry:r,properties:e.properties||{},id:e.id}:null}_convertGeometryToGeoJSON(e,t){switch(t){case Xe.Point:return this._convertPointGeometry(e);case Xe.Linestring:return this._convertLineGeometry(e);case Xe.Polygon:return this._convertPolygonGeometry(e);default:return console.warn("Unknown geometry type:",t),null}}_convertPointGeometry(e){const t=[];for(const r of e)for(const i of r)t.push([i.x,i.y]);return t.length===0?null:t.length===1?{type:"Point",coordinates:t[0]}:{type:"MultiPoint",coordinates:t}}_convertLineGeometry(e){const t=[];for(const r of e){const i=[];for(const o of r)i.push([o.x,o.y]);i.length>=2&&t.push(i)}return t.length===0?null:t.length===1?{type:"LineString",coordinates:t[0]}:{type:"MultiLineString",coordinates:t}}_convertPolygonGeometry(e){const t=[];let r=[];for(const i of e){const o=[];for(const l of i)o.push([l.x,l.y]);o.length>=4&&(this._isRingClockwise(o)||r.length===0?(r.length>0&&t.push(r),r=[o]):r.push(o))}return r.length>0&&t.push(r),t.length===0?null:t.length===1?{type:"Polygon",coordinates:t[0]}:{type:"MultiPolygon",coordinates:t}}_isRingClockwise(e){let t=0;for(let r=0;r<e.length-1;r++){const[i,o]=e[r],[l,c]=e[r+1];t+=(l-i)*(c+o)}return t>0}}var cy=Object.defineProperty,uy=(s,e,t)=>e in s?cy(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ca=(s,e,t)=>uy(s,typeof e!="symbol"?e+"":e,t);class pu extends ys{constructor(){super(...arguments),ca(this,"info",{version:"1.0.0",description:"Loader for standard web images (XYZ tiles)."}),ca(this,"dataType","image"),ca(this,"loader",new f.ImageLoader(Ve.manager))}async performLoad(e,t){const r=await this.loader.loadAsync(e).catch(()=>new Image(1,1)),i=new f.Texture;i.colorSpace=f.SRGBColorSpace;const{bounds:o}=t;return o[2]-o[0]<1||o[3]-o[1]<1?i.image=this.extractSubImage(r,o):i.image=r,i.needsUpdate=!0,i}extractSubImage(e,t){const r=e.width,i=new OffscreenCanvas(r,r),o=i.getContext("2d"),{sx:l,sy:c,sw:u,sh:d}=Pn.getBoundsCoord(t,r);return o.drawImage(e,l,c,u,d,0,0,r,r),i}}function mu(){Ve.registerMaterialLoader(new pu),Ve.registerMaterialLoader(new du),Ve.registerGeometryLoader(new su),Ve.registerGeometryLoader(new ru),Ve.registerMeshLoader(new lu),console.log("[TileLoaderFactory] Default loaders registered.")}var hy=Object.defineProperty,fy=(s,e,t)=>e in s?hy(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,di=(s,e,t)=>fy(s,typeof e!="symbol"?e+"":e,t);class ua extends Kc{constructor(e,t){if(super(e,t),di(this,"layerType","vector"),di(this,"_tileDataMap",new Map),di(this,"_renderer"),di(this,"_style"),di(this,"_feaList",[]),di(this,"_collision",!1),di(this,"_renderAltitude",0),!t.style)throw new Error("VectorTileLayer must provide style configuration! VectorTileLayer 必须提供样式配置");this._style=t.style,this._collision=t.collision||!1,this._featureFilter=t.featureFilter,this._renderAltitude=t.altitude||0,this._rootTile.setDataOnlyMode(!0),this._setupDataModeAndListenersForChildren(),this._setupLifeCycleListeners()}createLoader(){const e=new bs;return Array.isArray(this.source)?e.vtSource=this.source[0]:e.vtSource=this.source,e}_setupDataModeAndListenersForChildren(){const e=t=>{t!==this._rootTile&&t.setDataOnlyMode(!0),this._addShownListenerToTile(t),this._addUnloadListenerToTile(t)};this._rootTile.addEventListener("tile-created",t=>{const r=t.tile;e(r)}),this._rootTile.traverse(t=>{t.isTile&&e(t)})}_addShownListenerToTile(e){const t=r=>{const i=r.tile,o=`${i.z}-${i.x}-${i.y}`,l=!!this._renderer,c=this._tileDataMap.get(o);l&&c&&this._renderer.processTileData(i,c.data)};e.addEventListener("tile-shown",t)}_addUnloadListenerToTile(e){const t=r=>{const i=r.tile||r.target,o=`${i.z}-${i.x}-${i.y}`;if(this._renderer)try{this._renderer.removeFeaturesByTileKey(o)}catch{}this._tileDataMap.delete(o)};e.addEventListener("unload",t)}setAltitude(e){return super.setAltitude(0),this._renderAltitude=e,this._renderer&&this._renderer.setAltitude(e),this}getAltitude(){return this._renderAltitude}_addHiddenListenerToTile(e){const t=r=>{const i=r.tile,o=`${i.z}-${i.x}-${i.y}`;if(this._renderer)try{this._renderer.hideFeaturesByTileKey(o)}catch{}};e.addEventListener("tile-hidden",t)}_setupLifeCycleListeners(){this._rootTile.addEventListener("tile-loaded",e=>{const t=e.tile,r=`${t.z}-${t.x}-${t.y}`,i=this.getVectorDataFromTile(t);if(!i){console.warn(`[VectorTileLayer] Tile ${r} loaded but has no vector data.`);return}if(i.vectorData?.dataFormat==="mvt"&&this._tileDataMap.set(r,{data:i,tile:t,timestamp:Date.now(),pending:!1}),t.showing&&this._renderer&&i.vectorData?.dataFormat==="mvt")try{this._renderer.processTileData(t,i)}catch{}})}getVectorDataFromTile(e){return!e.geometry||!e.getVectorData()?null:e.getVectorData()}getVisibleVectorTiles(){const e=[];return this._rootTile.traverse(t=>{if(t.isTile&&t.loaded&&t.inFrustum){const r=`${t.z}-${t.x}-${t.y}`,i=this._tileDataMap.get(r);i&&e.push({tileKey:r,data:i.data,tile:i.tile})}}),e}getAllVectorData(){return new Map(this._tileDataMap)}getVectorData(e,t,r){const i=`${r}-${e}-${t}`,o=this._tileDataMap.get(i);return o?o.data:null}setFeatureFilter(e){this._featureFilter=e,this._renderer&&this._renderer.setFeatureFilter(e)}clearFeatureFilter(){this._featureFilter=void 0,this._renderer&&this._renderer.clearFeatureFilter()}setOpacity(e){this.opacity=e,this._renderer&&this._renderer.setOpacity(e)}update(e){!this.enabled||!this.visible||super.update(e)}dispose(){this._renderer&&this._renderer.dispose(),super.dispose()}_setRenderer(e){this._renderer=e}_getRenderer(){return this._renderer||null}getStyle(){return this._style}}var dy=Object.defineProperty,py=(s,e,t)=>e in s?dy(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,my=(s,e,t)=>py(s,e+"",t);class gu{constructor(e=0){my(this,"_centralMeridian",0),this._centralMeridian=e}get centralMeridian(){return this._centralMeridian}adjustTileXWithCentralMeridian(e,t){const r=Math.pow(2,t),i=Math.round(r/360*this._centralMeridian);let o=e+i;return o>=r?o-=r:o<0&&(o+=r),o}getTileOrigin(e,t,r){const i=Math.pow(2,r),o=this.mapWidth,l=this.mapHeight/2,c=e/i*o-o/2,u=l-t/i*this.mapHeight;return{x:c,y:u}}getProjectedBoundsFromGeoBounds(e){const[t,r,i,o]=e,l=this.project(t,r),c=this.project(i,o);return[l.x,l.y,c.x,c.y]}getTileProjectedBounds(e,t,r){const i=this.getTileOrigin(e,t,r),o=this.getTileOrigin(e+1,t+1,r);return[Math.min(i.x,o.x),Math.min(i.y,o.y),Math.max(i.x,o.x),Math.max(i.y,o.y)]}getTileGeoBounds(e,t,r){const[i,o,l,c]=this.getTileProjectedBounds(e,t,r),u=this.unProject(i,o),d=this.unProject(l,c);return[Math.min(u.lon,d.lon),Math.min(u.lat,d.lat),Math.max(u.lon,d.lon),Math.max(u.lat,d.lat)]}}var gy=Object.defineProperty,_y=(s,e,t)=>e in s?gy(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ln=(s,e,t)=>_y(s,typeof e!="symbol"?e+"":e,t);const _u=class yo extends gu{constructor(e=0){super(e),Ln(this,"ID","3857"),Ln(this,"mapWidth",2*Math.PI*yo.LEGACY_EARTH_RADIUS),Ln(this,"mapHeight",this.mapWidth),Ln(this,"mapDepth",1)}project(e,t){const r=Math.PI/180,i=yo.LEGACY_EARTH_RADIUS,o=(e-this.centralMeridian)*r,l=t*r,c=i*o,u=i*Math.log(Math.tan(Math.PI/4+l/2));return{x:c,y:u}}unProject(e,t){const r=180/Math.PI,i=yo.LEGACY_EARTH_RADIUS;let o=e/i*r+this.centralMeridian;o>180&&(o-=360),o<-180&&(o+=360);const c=(2*Math.atan(Math.exp(t/i))-Math.PI/2)*r;return{lon:o,lat:c}}};Ln(_u,"LEGACY_EARTH_RADIUS",6378e3);let yu=_u;var yy=Object.defineProperty,vy=(s,e,t)=>e in s?yy(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,On=(s,e,t)=>vy(s,typeof e!="symbol"?e+"":e,t);const vu=class Ti extends gu{constructor(e=0){super(e),On(this,"ID","4326"),On(this,"mapWidth",360*Ti.SCALE_FACTOR),On(this,"mapHeight",180*Ti.SCALE_FACTOR),On(this,"mapDepth",1)}project(e,t){return{x:(e-this.centralMeridian)*Ti.SCALE_FACTOR,y:t*Ti.SCALE_FACTOR}}unProject(e,t){return{lon:e/Ti.SCALE_FACTOR+this.centralMeridian,lat:t/Ti.SCALE_FACTOR}}};On(vu,"SCALE_FACTOR",100);let wy=vu;class by{static create(e="3857",t=0){switch(e){case"3857":return new yu(t);case"4326":return new wy(t);default:throw new Error(`[ProjectionFactory] Unsupported projection type: ${e}`)}}}var xy=Object.defineProperty,Sy=(s,e,t)=>e in s?xy(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Me=(s,e,t)=>Sy(s,typeof e!="symbol"?e+"":e,t);class My{constructor(...e){}}const Ay={};let pi=class id extends Zo(zr(ui(My))){constructor(e,t){Go(e,"container","Map container element must be specified");const r=["center","basemap"];for(const T of r)fc(t,T);const o={...t,viewer:{...{viewer:{antialias:!0,stencil:!0,logarithmicDepthBuffer:!0}}.viewer,...t.viewer}};super(o),Me(this,"viewer"),Me(this,"_rootGroup",new f.Group),Me(this,"_layers",new globalThis.Map),Me(this,"_mapProjection",new yu(0)),Me(this,"_animationClock",new f.Clock),Me(this,"autoUpdate",!0),Me(this,"updateInterval",100),Me(this,"minLevel",2),Me(this,"maxLevel",19),Me(this,"center"),Me(this,"prjcenter"),Me(this,"_layerContainer"),Me(this,"_eventState",{loaded:{listened:!1}}),Me(this,"_canvasMgr",new Ag),Me(this,"_collisionEngine"),Me(this,"_onLoadHooks"),Me(this,"_minZoom",0),Me(this,"_maxZoom",22),Me(this,"_ZOOM_MIN_CONST",0),Me(this,"_ZOOM_MAX_CONST",22),Me(this,"_minZoomDistance",500),Me(this,"_maxZoomDistance",8e4),Me(this,"_isZooming",!1),Me(this,"_zoomStartValue",0),Me(this,"_lastZoomForControls",0),Me(this,"_overZoom",0),Me(this,"_lastCameraDistance",0),this.initMap(o.basemap),mu(),this.center=this.options.center,this.viewer=new gc(e,{...o.viewer,map:this}),this._rootGroup.receiveShadow=!0,this._rootGroup.up.set(0,0,1),this._rootGroup.rotation.x=-Math.PI/2,this.viewer.scene.add(this._rootGroup);const l=this.projectToWorld(new f.Vector3(this.center[0],this.center[1],0));this.prjcenter=l,this.viewer.on("update",()=>{this.update(this.viewer.camera)});const c=this.options.viewer??{};this.viewer.flyToPoint({center:this.center,distance:typeof this.center[2]=="number"?this.center[2]:void 0,polarDeg:typeof c.polarDeg=="number"?c.polarDeg:void 0,azimuthDeg:typeof c.azimuthDeg=="number"?c.azimuthDeg:void 0,polarAngle:c.polarAngle,azimuthAngle:c.azimuthAngle,duration:0,curvePath:!1}),this._minZoomDistance=this.viewer.controls.minDistance,this._maxZoomDistance=this.viewer.controls.maxDistance;const u=this._getCameraDistance();this._lastCameraDistance=u,this._layerGroup=new bg,this.viewer.scene.add(this._layerGroup);const d=this.viewer.controls;this._minZoomDistance=typeof d?.minDistance=="number"?d.minDistance:500,this._maxZoomDistance=typeof d?.maxDistance=="number"?d.maxDistance:8e4;const p=this.getLayers().find(T=>T.isBaseLayer===!0)?.minLevel??this.minLevel;this._minZoom=Math.max(this._ZOOM_MIN_CONST,Math.min(this._ZOOM_MAX_CONST,p)),this._maxZoom=this._ZOOM_MAX_CONST;const _=this.prjcenter,S=this.viewer.camera.position.clone().clone().sub(_).normalize(),x=$o(t.zoom)?13:t.zoom,O=Math.max(this._minZoom,Math.min(this._maxZoom,x)),P=this._computeDistanceFromZoom(O);l.clone().addScaledVector(S,P);const C=this.getZoom();this._lastZoomForControls=C,this._zoomStartValue=C,this._collisionEngine=new t_(this.viewer.renderer,{padding:8,updateInterval:16,animationDuration:200,maxFeaturesPerFrame:2e4,strategies:{priority:!0,grouping:!0,proximity:!0}}),this.on("control-change",n_.debounce(T=>{if(!this._rootGroup||!this._collisionEngine)return;const N=this.getDataZoom(),R=this.getLayers().find(K=>K.isBaseLayer===!0)?.maxLevel??this.maxLevel,U=this._getCameraDistance(),$=U-this._lastCameraDistance;this._lastCameraDistance=U;const{max:z}=this._getViewZoomRange(),V=Math.max(0,z-R);N<R?this._overZoom=0:$<-.001?this._overZoom=Math.min(this._overZoom+1,V):$>.001&&(this._overZoom=Math.max(this._overZoom-1,0));const Y=this.getZoom();Math.abs(Y-this._lastZoomForControls)>.001&&(this._isZooming?this.trigger("zooming",{from:this._zoomStartValue,to:Y}):(this._isZooming=!0,this._zoomStartValue=this._lastZoomForControls,this.trigger("zoomstart",{from:this._zoomStartValue,to:Y})),this._lastZoomForControls=Y),this._collisionEngine.update(T.camera)},10,{leading:!1,trailing:!0})),this.on("control-end",()=>{this._isZooming&&(this._isZooming=!1,this.trigger("zoomend",{from:this._zoomStartValue,to:this.getZoom()}))}),this._callOnLoadHooks()}get projection(){return this._mapProjection}get lon0(){return this.projection.centralMeridian}project(e){const t=this.projection.project(e.x,e.y);return new f.Vector3(t.x,t.y,e.z)}projectToWorld(e){return this._rootGroup.localToWorld(this.project(e))}unproject(e){const t=this.projection.unProject(e.x,e.y);return new f.Vector3(t.lon,t.lat,e.z)}unprojectFromWorld(e){return this.unproject(this._rootGroup.worldToLocal(e.clone()))}pickFromGeo(e){const t=this.projectToWorld(e);return En(this,t)}pickFromWorld(e){return En(this,e)}pickFromPixel(e,t){return wo(e,this,t)}static addOnLoadHook(e,...t){const r=typeof e=="function"?e:function(){this[e].apply(this,t)},i=this.prototype;return i._onLoadHooks=i._onLoadHooks||[],i._onLoadHooks.push(r),this}_callOnLoadHooks(){const e=id.prototype;if(e._onLoadHooks)for(let t=0,r=e._onLoadHooks.length;t<r;t++)e._onLoadHooks[t].call(this)}getZoom(){const e=this.getDataZoom(),r=this.getLayers().find(i=>i.isBaseLayer===!0)?.maxLevel??this.maxLevel;return e<r?e:r+this._overZoom}getDataZoom(){let e=this.minLevel;const t=this.getLayers().find(i=>i.isBaseLayer===!0);return!t||!t._rootTile||t._rootTile.traverseVisible(i=>{i.showing&&i.inFrustum&&(e=Math.max(e,i.z))}),e}getMinZoom(){return this._minZoom}getMaxZoom(){return this._maxZoom}setZoomRange(e,t){if(e>t){const i=e;e=t,t=i}this._minZoom=e,this._maxZoom=t;const r=this.viewer.controls;if(r){const i=this._computeDistanceFromZoom(this._maxZoom),o=this._computeDistanceFromZoom(this._minZoom);r.minDistance=i,r.maxDistance=o}return this}setMinZoom(e){return this.setZoomRange(e,this._maxZoom)}setMaxZoom(e){return this.setZoomRange(this._minZoom,e)}setZoom(e){const t=this.getMinZoom(),r=this.getMaxZoom(),i=Math.max(t,Math.min(r,e)),o=this.getZoom(),l=this._computeDistanceFromZoom(i),c=this.viewer.controls,u=c?.target??this.prjcenter,d=this.viewer.camera,m=d.position.clone().sub(u).normalize();return d.position.copy(u).addScaledVector(m,l),d.updateProjectionMatrix(),typeof c?.update=="function"&&c.update(),this._lastZoomForControls=i,this.trigger("zoomend",{from:o,to:this.getZoom()}),this}zoomIn(e=1){return this.setZoom(this.getZoom()+e)}zoomOut(e=1){return this.setZoom(this.getZoom()-e)}_computeDistanceFromZoom(e){const t=this._ZOOM_MIN_CONST,r=this._ZOOM_MAX_CONST,i=this._minZoomDistance,o=this._maxZoomDistance;if(i<=0||i>=o){const m=Math.max(t,Math.min(r,e)),p=(r-m)/(r-t);return i+p*(o-i)}const c=(Math.max(t,Math.min(r,e))-t)/(r-t),u=i/o;return o*Math.pow(u,c)}initMap(e){if(this.minLevel=e.minLevel??2,this.maxLevel=e.maxLevel??19,e.Baselayers?.length)for(const t of e.Baselayers)t.isBaseLayer=!0,this.addTileLayer(t);setTimeout(()=>{const t={timestamp:vm(),targrt:this};this._eventState.loaded={listened:!0},this.trigger("loaded",t)},0)}update(e){if(!this.autoUpdate)return;this._animationClock.getElapsedTime()>this.updateInterval/1e3&&(this._layers.forEach(r=>{r.enabled&&r.visible&&r.update(e)}),this._animationClock.start())}addLayer(e,...t){if(!e)return this;Array.isArray(e)||(e=[e]),t?.length&&(e=e.concat(t)),t?.length&&(e=e.concat(t));for(let r=0,i=e.length;r<i;r++){const o=e[r],l=o.getId();if($o(l))throw new Error("Invalid id for the layer: "+l);o.isTileLayer?this.addTileLayer(o):this.addRegularLayer(o)}return this}removeLayer(e){const t=this._layers.get(e);if(t){if(t instanceof ua){const i=t._getRenderer();i&&this._layerGroup.remove(i)}return this._layers.delete(e),this._rootGroup.remove(t),!0}const r=this._layerGroup.getLayerById(e);return r?(this._layerContainer.remove(r),r instanceof Nr&&r?._collision,!0):(console.warn(`⚠️ Layer does not exist 图层不存在: ${e}`),!1)}addRegularLayer(e){this._layerGroup.add(e),e._bindMap(this),e instanceof Nr&&e?._collision&&(this._collisionEngine.registerLayer(e),e.setCollisionEngine(this._collisionEngine))}addTileLayer(e){if(this._layers.set(e.getId(),e),this._rootGroup.add(e),e._bindMap(this),e instanceof ua){const t=e.options||{},r=new sa(e.getId()+"-vtrender",{altitude:e.getAltitude(),style:e.getStyle(),collision:e._collision,zIndex:typeof t.zIndex=="number"?t.zIndex:void 0,depthOffset:typeof t.depthOffset=="number"?t.depthOffset:void 0});e._setRenderer(r),this.addRegularLayer(r)}return this}clearLayers(){return this._layerGroup.clear(),this._layers.forEach(e=>{this._rootGroup.remove(e)}),this._layers.clear(),this}getLayers(){const e=this._layerGroup.getLayers().filter(r=>!(r instanceof sa)),t=Array.from(this._layers.values());return[...e,...t]}getLayerById(e){if(this._layers.has(e))return this._layers.get(e);const t=this._layerGroup.getLayerById(e);if(t)return t instanceof sa?void 0:t}_getCanvas(e=40,t=30,r){return this._canvasMgr.getCanvas(e,t,1,r)}getContainer(){return this.viewer.container}getRenderer(){return this.viewer.renderer}getCamera(){return this.viewer.camera}_findFeaturesAt(e){const t=this,r=t.getRenderer(),i=t.getCamera(),o=r.domElement.getBoundingClientRect(),l=e.x/o.width*2-1,c=-(e.y/o.height)*2+1,u=new f.Raycaster;u.setFromCamera(new f.Vector2(l,c),i);const d=t.getLayers().filter(_=>!_?.isSceneLayer&&_?.visible===!0),p=u.intersectObjects(d,!0).map(_=>{let v=_.object,S=null;for(;v;){if(v instanceof tt){S=v;break}v=v.parent}return!S||S.visible===!1?null:{feature:S,distance:_.distance,object:_.object}}).filter(_=>!!_);return p.length?p.sort((_,v)=>_.distance-v.distance):[]}getCenter(){const e=this.viewer.controls.target.clone(),t=this.unprojectFromWorld(e);return[t.x,t.y,t.z]}_getEventPosition(e){let t,r;if("touches"in e){if(e.touches.length===0)return null;t=e.touches[0].clientX,r=e.touches[0].clientY}else t=e.clientX,r=e.clientY;const i=this.getContainer();if(!i)return null;const o=i.getBoundingClientRect();return{x:t-o.left,y:r-o.top}}get isInteracting(){return this.viewer?this.viewer.isInteracting:!1}_getCameraDistance(){const e=this.viewer.controls,t=this.viewer.camera,r=e?.target??this.prjcenter;return e&&typeof e.getDistance=="function"?e.getDistance():t.position.distanceTo(r)}_getViewZoomRange(){const e=this.viewer.controls,t=typeof e?.minDistance=="number"?e.minDistance:this._minZoomDistance,r=typeof e?.maxDistance=="number"?e.maxDistance:this._maxZoomDistance;if(t<=0||t>=r){const p=this.getDataZoom();return{min:p,max:p}}const i=r/t,o=Math.log2(i),l=this.getLayers().find(p=>p.isBaseLayer===!0),c=l?.minLevel??this.minLevel,u=l?.maxLevel??this.maxLevel,d=c,m=u+o;return{min:d,max:m}}flyTo(e){this.viewer.flyToAdvanced(e)}flyToPoint(e){this.viewer.flyToPoint(e)}destroy(){try{this._clearHandlers(),["control-change","control-start","control-end","zoomstart","zooming","zoomend","loaded"].forEach(t=>{const r=this._listenerMap?.get(t);r&&r.forEach((i,o)=>{this.off(t,o)})}),this.clearLayers(),Ko.getInstance().clearCache(),this._collisionEngine&&(this._collisionEngine=null),this._layerGroup&&(this._layerGroup.clear(),this._layerGroup=null),this._canvasMgr&&(this._canvasMgr=null),this.viewer&&(this.viewer.destroy(),this.viewer=null),this._eventState={loaded:{listened:!1}}}catch(e){console.error("Error destroying map 销毁地图时出错:",e)}}};pi.mergeOptions(Ay);const Py=["click","dblclick","mousedown","mouseup","mousemove","mouseenter","mouseleave","mouseover","mouseout"];pi.prototype._removeDomEvents=function(){},pi.prototype._registerDomEvents=function(){const s=this.viewer.container;if(s){let t=null;Py.forEach(r=>{s.addEventListener(r,i=>{if(!this.viewer)return;if(r==="mousedown"&&(t={x:i.clientX,y:i.clientY}),r==="click"&&t){const c=i.clientX-t.x,u=i.clientY-t.y;if(Math.sqrt(c*c+u*u)>5)return}let o=na(i,this,this.viewer.camera),l={target:this,originEvent:i,eventName:r,screenXY:{X:i.screenX,Y:i.screenY}};if(o){let c=[o.x,o.y,o.z];l={target:this,originEvent:i,coordinate:c,eventName:r,screenXY:{X:i.screenX,Y:i.screenY}}}this.trigger(r,l)})})}},pi.addOnLoadHook("_registerDomEvents");var Cy=Object.defineProperty,Ly=(s,e,t)=>e in s?Cy(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ha=(s,e,t)=>Ly(s,typeof e!="symbol"?e+"":e,t);const Oy=["click","dblclick","mousedown","mouseup","mousemove","mouseenter","mouseleave","mouseover","mouseout","contextmenu","touchstart","touchmove","touchend"];class Dy extends cs{constructor(){super(...arguments),ha(this,"_registeredEvents",[]),ha(this,"_mouseDownTime",0),ha(this,"_eventCommon",e=>{(e.type==="mousedown"||e.type==="touchstart")&&(this._mouseDownTime=Date.now()),!(e.type==="click"&&Date.now()-this._mouseDownTime>300)&&this._handleEvent(e,e.type)})}addHooks(){const t=this.target.getContainer();t&&Oy.forEach(r=>{t.addEventListener(r,this._eventCommon),this._registeredEvents.push(r)})}removeHooks(){const t=this.target.getContainer();t&&this._registeredEvents.length>0&&(this._registeredEvents.forEach(r=>{const i=r;t.removeEventListener(i,this._eventCommon)}),this._registeredEvents=[])}_handleEvent(e,t){const r=this.target;if(!r||!r.viewer||this._shouldIgnoreEvent(t)||(t==="mousemove"||t==="mouseenter"||t==="mouseleave"||t==="mouseover"||t==="mouseout"||t==="touchmove")&&!r.getLayers().some(u=>!u.isSceneLayer&&u._feaList?.length>0))return;const i=r._getEventPosition(e);if(!i)return;const o=r._findFeaturesAt(i);if(o.length===0)return;const l=o[0].feature;switch(t){case"click":this._handleClickEvent(l,e);break;case"mousemove":case"mouseenter":case"mouseleave":case"mouseover":case"mouseout":case"touchmove":this.handleMoveEvent(l,e);break;default:if(l){this._fireFeatureEvent(l,t,e);const c=l.getLayer();c&&c.trigger("feature"+t,{feature:l,domEvent:e,type:"feature"+t})}}}_handleClickEvent(e,t){if(!e)return;this._fireFeatureEvent(e,"click",t);const r=e.getLayer();r&&r.trigger("featureclick",{feature:e,domEvent:t,type:"featureclick"})}handleMoveEvent(e,t){if(!e)return;this._fireFeatureEvent(e,t.type,t);const r=e.getLayer();r&&r.trigger("feature"+t.type,{feature:e,domEvent:t,type:"feature"+t.type})}_fireFeatureEvent(e,t,r){const i=this.target;if(!i||!i.viewer)return;let o=r,l,c;if("touches"in r){const p=r.touches[0]||r.changedTouches[0];if(!p)return;o={currentTarget:r.currentTarget,clientX:p.clientX,clientY:p.clientY},l=p.screenX,c=p.screenY}else{const p=r;o=p,l=p.screenX,c=p.screenY}const u=na(o,i,i.viewer.camera);if(!u)return;const d=[u.x,u.y,u.z],m={target:e,originEvent:r,coordinate:d,eventName:t,screenXY:{X:l,Y:c}};e.trigger(t,m)}_shouldIgnoreEvent(e){const t=this.target;return t.viewer?e==="mousedown"||e==="touchstart"?!1:!!t.isInteracting:!0}}pi.mergeOptions({FeatureEvents:!0,onlyVisibleFeatureEvents:!0}),pi.addOnLoadHook("addHandler","FeatureEvents",Dy);var Iy=Object.defineProperty,Fy=(s,e,t)=>e in s?Iy(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,dr=(s,e,t)=>Fy(s,typeof e!="symbol"?e+"":e,t);let Ty=class{constructor(...e){}};const wu=class cn extends zr(ui(Ty)){constructor(e={}){super(e),dr(this,"_owner"),dr(this,"_map"),dr(this,"_worldPosition"),dr(this,"_coordinate"),dr(this,"_dom"),dr(this,"_visible",!1),dr(this,"_boundMapHandlers",new Map),dr(this,"_viewerUpdateHandler"),dr(this,"_positionedOnce",!1)}_getClassName(){return"UIComponent"}getOffset(){return{x:this.options.dx??0,y:this.options.dy??0}}addTo(e){if(!e)return this;this._owner=e;const t=typeof e.getMap=="function"?e.getMap():e;return t?(this._map=t,this._bindMapEvents(!0),this.options.single&&(cn._singletons.forEach(r=>{r!==this&&r.options.single&&r._map===t&&r.hide()}),cn._singletons.add(this)),this.onAdd&&this.onAdd(),this.trigger("add",{owner:e,map:t}),this):this}remove(){const e=this._map;return this.hideDom(),this._bindMapEvents(!1),this.options.single&&cn._singletons.delete(this),this.onRemove&&this.onRemove(),this.trigger("remove",{owner:this._owner,map:e}),this._owner=void 0,this._map=void 0,this}show(e){const t=this._map??(this._owner&&typeof this._owner.getMap=="function"?this._owner.getMap():void 0);if(!t)return this;if(this._map=t,this.options.single&&(cn._singletons.forEach(r=>{r!==this&&r.options.single&&r._map===t&&r.isVisible()&&r.hide()}),cn._singletons.add(this)),!this._dom){const r=this.buildOn();this._dom=r,r.style.position="absolute",typeof this.options.zIndex=="number"&&(r.style.zIndex=String(this.options.zIndex));const i=t.getContainer();if(!i)return this;i.appendChild(r)}return this._coordinate=e?[...e]:void 0,this._visible=!0,this._positionedOnce=!1,this._dom&&(this._dom.style.display="none"),this.trigger("show",{owner:this._owner,map:t}),this}hide(){return this._visible=!1,this._dom&&(this._dom.style.display="none"),this._coordinate=void 0,this.trigger("hide",{owner:this._owner,map:this._map}),this}hideDom(){return this._dom&&this._dom.parentElement&&(this._dom.parentElement.removeChild(this._dom),this.onDomRemove&&this.onDomRemove()),this._dom=void 0,this._visible=!1,this._coordinate=void 0,this}getMap(){return this._map}isVisible(){return this._visible}_bindMapEvents(e){const t=this._map;if(!t)return;const r=t,i=e?"on":"off",o=(l,c)=>{e?this._boundMapHandlers.set(l,c):this._boundMapHandlers.delete(l)};if(e){const l=()=>{this._visible&&this._refreshDomPosition()};r[i]("control-change",l),o("control-change",l);const c=t.viewer;if(c&&!this._viewerUpdateHandler){const u=()=>{this._visible&&this._refreshDomPosition()};this._viewerUpdateHandler=u,c.addEventListener("update",u)}}else{this._boundMapHandlers.forEach((c,u)=>{r[i](u,c)}),this._boundMapHandlers.clear();const l=t.viewer;l&&this._viewerUpdateHandler&&(l.removeEventListener("update",this._viewerUpdateHandler),this._viewerUpdateHandler=void 0)}}_resolveWorldPosition(){const e=this._map;if(!e)return;if(this._coordinate){const[r,i,o=0]=this._coordinate,l=new f.Vector3(r,i,o);return e.projectToWorld(l)}const t=this._owner;if(t&&t._geometry){const r=t._geometry;if(r&&(r.type==="Point"||r.type==="MultiPoint")){let i;if(r.type==="Point"?i=r.coordinates:r.type==="MultiPoint"&&Array.isArray(r.coordinates)&&r.coordinates.length>0&&(i=r.coordinates[0]),i&&i.length>=2){const o=new f.Vector3(i[0],i[1],i[2]??0);return e.projectToWorld(o)}}if(t._renderObject&&typeof t._renderObject.getWorldPosition=="function"){const i=new f.Vector3;if(t._renderObject.getWorldPosition(i),!(i.x===0&&i.y===0&&i.z===0))return i}if(t._worldCoordinates instanceof f.Vector3){const i=t._worldCoordinates;if(!(i.x===0&&i.y===0&&i.z===0))return i.clone()}}if(t&&typeof t.getWorldPosition=="function"){const r=new f.Vector3;return t.getWorldPosition(r),r}return e.prjcenter?.clone?.()??void 0}_refreshDomPosition(){if(!this._dom||!this._map)return;if(this._visible){const u=this._resolveWorldPosition();if(!u){this._dom.style.display="none";return}this._worldPosition=u}if(!this._worldPosition)return;const e=this._map.viewer,t=e.camera,r=this._dom.style.display==="none";r&&(this._dom.style.visibility="hidden",this._dom.style.display=""),t.updateMatrixWorld();const i=this._worldPosition.clone().project(t);if(i.x<-1.1||i.x>1.1||i.y<-1.1||i.y>1.1||i.z<-1||i.z>1){this._dom.style.display="none",r&&(this._dom.style.visibility="");return}const o=(i.x*.5+.5)*e.width,l=(-i.y*.5+.5)*e.height,c=this.getOffset();if(this._dom.style.left=`${o+c.x}px`,this._dom.style.top=`${l+c.y}px`,r&&(this._dom.style.visibility=""),!this._positionedOnce){this._positionedOnce=!0,this._dom.style.display="none";return}this._dom.style.display=""}};dr(wu,"_singletons",new Set);let bu=wu;var By=Object.defineProperty,Uy=(s,e,t)=>e in s?By(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,xu=(s,e,t)=>Uy(s,typeof e!="symbol"?e+"":e,t);class fa extends bu{constructor(e){super({single:!0,...e}),xu(this,"_titleEl"),xu(this,"_contentEl")}_getClassName(){return"InfoWindow"}buildOn(){if(this.options.custom){let c;this.options.content instanceof HTMLElement?c=this.options.content:(c=document.createElement("div"),typeof this.options.content=="string"&&(c.innerHTML=this.options.content));const u=this.options.containerClass;return u&&(Array.isArray(u)?u:[u]).forEach(m=>{c.classList.add(m)}),this.options.minWidth&&(c.style.minWidth=`${this.options.minWidth}px`),this.options.minHeight&&(c.style.minHeight=`${this.options.minHeight}px`),this._titleEl=void 0,this._contentEl=c,c}const e=document.createElement("div");e.className="maporbis-infowindow";const t=this.options.containerClass;t&&(Array.isArray(t)?t:[t]).forEach(u=>{e.classList.add(u)}),typeof this.options.zIndex=="number"&&(e.style.zIndex=String(this.options.zIndex)),this.options.minWidth&&(e.style.minWidth=`${this.options.minWidth}px`),this.options.minHeight&&(e.style.minHeight=`${this.options.minHeight}px`);const r=document.createElement("div");r.className="maporbis-infowindow-header";const i=document.createElement("div");i.className="maporbis-infowindow-title",this.options.title&&(i.innerText=this.options.title);const o=document.createElement("span");o.className="maporbis-infowindow-close",o.innerHTML="×",o.title="关闭",o.addEventListener("click",c=>{c.stopPropagation(),c.preventDefault(),this.close()}),o.addEventListener("mousedown",c=>{c.preventDefault()}),o.style.cursor="pointer",o.style.userSelect="none",r.appendChild(i),r.appendChild(o);const l=document.createElement("div");return l.className="maporbis-infowindow-content",this.options.content instanceof HTMLElement?l.appendChild(this.options.content):typeof this.options.content=="string"&&(l.innerHTML=this.options.content),e.appendChild(r),e.appendChild(l),this._titleEl=i,this._contentEl=l,e}getOffset(){const e=super.getOffset(),t=this._dom;if(!t)return e;const r=t.offsetWidth,i=t.offsetHeight,o=10;let l=e.x-r/2,c=e.y-i-o;const u=this._owner,d=this.getMap();if(u&&typeof u.getStyle=="function"&&d?.viewer){const p=u.getStyle?.()?.config,_=p?.type;if(p&&(_==="icon-point"||_==="icon-label-point")){const v=Array.isArray(p.anchor)?p.anchor:[.5,.5],S=typeof v[1]=="number"?v[1]:.5;let M=0;const x=u._renderObject;if(x&&x instanceof f.Sprite&&(M=this._getSpriteScreenHeight(x,d.viewer)),M<=0){let O=0;if(_==="icon-point"){const P=p.size;Array.isArray(P)?O=P[1]:typeof P=="number"&&(O=P)}else if(_==="icon-label-point"){const P=p.size??p.iconSize;Array.isArray(P)?O=P[1]:typeof P=="number"&&(O=P)}M=O*(1-S)}else M=M*(1-S);M>0&&(c-=M)}}return{x:l,y:c}}_getSpriteScreenHeight(e,t){try{const r=t.camera,i=t.renderer;if(!r||!i)return 0;const o=t.height||i.domElement.clientHeight;if(!(e.material.sizeAttenuation!==!1)){const N=r.projectionMatrix.elements[5];return e.scale.y*N*o/2}const u=new f.Vector3;e.getWorldPosition(u);const d=r.position.clone(),m=u.clone().sub(d).normalize(),p=new f.Vector3;p.crossVectors(r.up,m).normalize();const _=new f.Vector3;_.crossVectors(m,p).normalize();const v=e.scale.y*(1-e.center.y),S=e.scale.y*e.center.y,M=u.clone().add(_.clone().multiplyScalar(v)),x=u.clone().sub(_.clone().multiplyScalar(S)),O=M.clone().project(r),P=x.clone().project(r),C=(-O.y*.5+.5)*o,T=(-P.y*.5+.5)*o;return Math.abs(T-C)}catch(r){return console.warn("Failed to calculate sprite screen height: // 计算 sprite 屏幕高度失败:",r),0}}setTitle(e){return this.options.title=e,this._titleEl&&(this._titleEl.innerText=e??""),this}setContent(e){return this.options.content=e,this._contentEl?(this._contentEl.innerHTML="",e instanceof HTMLElement?this._contentEl.appendChild(e):this._contentEl.innerHTML=e,this):this}open(e){super.show(e);const t=this,r=()=>{!t._dom||!t._map||!t._visible||(t._positionedOnce=!0,t._refreshDomPosition())},o=this.getMap()?.viewer;if(o&&typeof o.addEventListener=="function"){const l=()=>{o.removeEventListener("update",l),r()};o.addEventListener("update",l)}else requestAnimationFrame(r);return this}close(){return this.hide()}}tt.include({setInfoWindow(s){this.removeInfoWindow();let e;return s instanceof fa?e=s:e=new fa(s),this._infoWindow=e,this.getMap()&&e.addTo(this),this},getInfoWindow(){return this._infoWindow},openInfoWindow(s){const e=this._infoWindow;return e?(e.getMap()||this.getMap()&&e.addTo(this),requestAnimationFrame(()=>{e.open(s)}),this):this},closeInfoWindow(){return this._infoWindow&&this._infoWindow.close(),this},removeInfoWindow(){return this._infoWindow&&(this._infoWindow.remove(),this._infoWindow=void 0),this}});var Vy=Object.defineProperty,ky=(s,e,t)=>e in s?Vy(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,da=(s,e,t)=>ky(s,typeof e!="symbol"?e+"":e,t);class zy{constructor(...e){}}class Su extends zr(ui(zy)){constructor(e={}){super(e),da(this,"_map"),da(this,"_enabled",!1),da(this,"_boundHandlers",new Map)}addTo(e){if(!e)return this;const t=e;return t._activeMapTool&&t._activeMapTool!==this&&t._activeMapTool.disable(),t._activeMapTool=this,this._map=e,this.onAdd&&this.onAdd(),this.enable(),this.trigger("add",{map:e}),this}getMap(){return this._map}enable(){return!this._map||this._enabled?this:(this._enabled=!0,this._bindEvents(),this.onEnable&&this.onEnable(),this.trigger("enable",{map:this._map}),this)}disable(){return!this._map||!this._enabled?this:(this._enabled=!1,this._unbindEvents(),this.onDisable&&this.onDisable(),this.trigger("disable",{map:this._map}),this)}isEnabled(){return!!this._enabled}remove(){if(!this._map)return this;this.disable();const e=this._map;return e._activeMapTool===this&&delete e._activeMapTool,this._map=void 0,this.trigger("remove"),this}_bindEvents(){const e=this._map;if(!e)return;const t=this.getEvents()||{};Object.keys(t).forEach(r=>{const i=t[r];if(!i)return;const o=l=>i.call(this,l);this._boundHandlers.set(r,o),e.on(r,o)})}_unbindEvents(){const e=this._map;e&&(this._boundHandlers.forEach((t,r)=>{e.off(r,t)}),this._boundHandlers.clear())}}var Ny=Object.defineProperty,Wy=(s,e,t)=>e in s?Ny(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Dn=(s,e,t)=>Wy(s,typeof e!="symbol"?e+"":e,t);class Gy extends Nr{constructor(e){super(e,{altitude:1})}validateFeature(e){return!!e}}const Mu={};class Gi extends Su{constructor(e){super(e),Dn(this,"_modeDef"),Dn(this,"_clickCoords",[]),Dn(this,"_isDrawing",!1),Dn(this,"_geometry"),Dn(this,"_draftLayer"),this.options.once=this.options.once??!1,this._ensureMode()}static registerMode(e,t){Mu[e.toLowerCase()]=t}static getModeDefinition(e){return Mu[e.toLowerCase()]}getMode(){return(this.options.mode||"").toLowerCase()}setMode(e){return this._finishDrawingSilently(),this.options.mode=e,this._ensureMode(),this}setStyle(e){return e.geometryStyle!==void 0&&(this.options.geometryStyle=e.geometryStyle),Object.prototype.hasOwnProperty.call(e,"vertexStyle")&&(this.options.vertexStyle=e.vertexStyle??null),this}getEvents(){return{click:this._handleClick.bind(this),mousemove:this._handleMouseMove.bind(this),dblclick:this._handleDblClick.bind(this)}}onEnable(){this._ensureMode()}onDisable(){this._finishDrawingSilently(),this._destroyDraftLayer()}_ensureMode(){const e=this.getMode(),t=Gi.getModeDefinition(e);if(!t)throw new Error(`DrawTool: mode "${e}" 未注册，请先调用 DrawTool.registerMode`);this._modeDef=t}_handleClick(e){if(!this._modeDef||!e.coordinate)return;const t=e.coordinate,r=this._modeDef,i={...e,drawTool:this};this._isDrawing?(this._clickCoords.push(t),r.update(this._clickCoords,this._geometry,i),this.trigger("drawvertex",{coordinate:t,geometry:this._geometry,coords:[...this._clickCoords],originEvent:i})):(this._isDrawing=!0,this._clickCoords=[t],this._geometry=r.create(t,i),this.trigger("drawstart",{coordinate:t,geometry:this._geometry,coords:[...this._clickCoords],originEvent:i})),r.clickLimit&&this._clickCoords.length>=r.clickLimit&&this._finishDrawing(i)}_handleMouseMove(e){if(!this._modeDef||!this._isDrawing||!e.coordinate)return;const t=this._modeDef,r=[...this._clickCoords,e.coordinate],i={...e,drawTool:this};t.update(r,this._geometry,i),this.trigger("drawing",{coordinate:e.coordinate,geometry:this._geometry,coords:r,originEvent:i})}_handleDblClick(e){if(!this._modeDef||!this._isDrawing)return;const t={...e,drawTool:this};this._finishDrawing(t)}_finishDrawing(e){if(!this._modeDef||!this._isDrawing)return;const r=this._modeDef.generate(this._geometry,[...this._clickCoords]);this.trigger("drawend",{geometry:r,coords:[...this._clickCoords],originEvent:e}),this._isDrawing=!1,this._clickCoords=[],this._geometry=void 0,this.options.once&&this.disable()}_finishDrawingSilently(){this._isDrawing=!1,this._clickCoords=[],this._geometry=void 0}_getOrCreateDraftLayer(){if(this._draftLayer)return this._draftLayer;const e=this.getMap();if(!e)throw new Error("DrawTool: 尚未绑定地图，请先调用 addTo(map)");const t=`__draw_draft_${Date.now().toString(36)}`,r=new Gy(t);return e.addLayer(r),this._draftLayer=r,r}_destroyDraftLayer(){const e=this.getMap();e&&this._draftLayer&&e.removeLayer(this._draftLayer.getId()),this._draftLayer=void 0}}const Ry={actions:["click","mousemove"],create(s,e){const t=e.drawTool,r=t._getOrCreateDraftLayer(),i=$r(t.options.geometryStyle,{type:"basic-point",size:10,color:"#00ffff"}),o={type:"Point",coordinates:s},l=new wr({geometry:o,style:i});return l.addTo(r),l.initializeGeometry(),{tool:t,draftLayer:r,draftMarker:l}},update(s,e,t){const r=e?.draftMarker;if(!r)return;const i=s[s.length-1];r._geometry={type:"Point",coordinates:i},r._worldCoordinates=r._coordsTransform(),r._buildRenderObject&&r._buildRenderObject()},generate(s,e){const t=s.tool;if(!e.length)return null;s.draftMarker&&(s.draftMarker._remove(),s.draftMarker=null);const r=$r(t.options.geometryStyle,{type:"basic-point",size:10,color:"#00ffff"}),i=e[e.length-1];return new wr({geometry:{type:"Point",coordinates:i},style:r})},clickLimit:1},jy={actions:["click","mousemove","dblclick"],create(s,e){const t=e.drawTool,r=t._getOrCreateDraftLayer(),i=$r(t.options.geometryStyle,{type:"basic-line",color:"#ff0000",width:2}),o=t.options.vertexStyle===null?void 0:$r(t.options.vertexStyle,{type:"basic-point",size:8,color:"#00ffff"}),l={type:"LineString",coordinates:[s]},c=new pt({geometry:l,style:i});c.addTo(r);const u=[];if(o){const d={type:"Point",coordinates:s},m=new wr({geometry:d,style:o});m.addTo(r),u.push(m)}return{tool:t,draftLayer:r,draftLine:c,draftAnchors:u,lineStyle:i,vertexStyle:o}},update(s,e,t){if(!e)return;const r=e.draftLayer;if(!s||s.length<2)return;e.draftLine&&(e.draftLine._remove(),e.draftLine=null);const i={type:"LineString",coordinates:s},o=new pt({geometry:i,style:e.lineStyle});if(o.addTo(r),e.draftLine=o,t.eventName==="click"&&e.vertexStyle){const c={type:"Point",coordinates:s[s.length-1]},u=new wr({geometry:c,style:e.vertexStyle});u.addTo(r),e.draftAnchors.push(u)}},generate(s,e){const t=s.tool;if(!e.length)return null;if(s.draftLine&&(s.draftLine._remove(),s.draftLine=null),Array.isArray(s.draftAnchors)){for(const o of s.draftAnchors)o?._remove();s.draftAnchors=[]}const r=$r(t.options.geometryStyle,{type:"basic-line",color:"#ff0000",width:2});return new pt({geometry:{type:"LineString",coordinates:e},style:r})}},$y={actions:["click","mousemove","dblclick"],create(s,e){const t=e.drawTool,r=t._getOrCreateDraftLayer(),i=$r(t.options.geometryStyle,{type:"basic-polygon",color:"#00ff00",opacity:.5}),o=t.options.vertexStyle===null?void 0:$r(t.options.vertexStyle,{type:"basic-point",size:8,color:"#00ffff"}),l=[];if(o){const c={type:"Point",coordinates:s},u=new wr({geometry:c,style:o});u.addTo(r),u.initializeGeometry(),l.push(u)}return{tool:t,draftLayer:r,draftPolygon:null,draftEdgeLine:null,draftAnchors:l,polygonStyle:i,vertexStyle:o}},update(s,e,t){if(!e)return;const r=e.draftLayer;if(t.eventName==="click"&&e.vertexStyle){const m={type:"Point",coordinates:s[s.length-1]},p=new wr({geometry:m,style:e.vertexStyle});p.addTo(r),p.initializeGeometry(),e.draftAnchors.push(p)}if(!s||s.length<2){e.draftEdgeLine&&(e.draftEdgeLine._remove(),e.draftEdgeLine=null),e.draftPolygon&&(e.draftPolygon._remove(),e.draftPolygon=null);return}if(s.length===2){e.draftPolygon&&(e.draftPolygon._remove(),e.draftPolygon=null),e.draftEdgeLine&&(e.draftEdgeLine._remove(),e.draftEdgeLine=null);const d={type:"LineString",coordinates:s},m=e.polygonStyle?.config&&e.polygonStyle.config.color||"#00ff00",p=new xt({type:"basic-line",color:m,width:2}),_=new pt({geometry:d,style:p});_.addTo(r),e.draftEdgeLine=_;return}e.draftEdgeLine&&(e.draftEdgeLine._remove(),e.draftEdgeLine=null);const i=s.slice(),o=i[0],l=i[i.length-1];(o[0]!==l[0]||o[1]!==l[1]||(o[2]||0)!==(l[2]||0))&&i.push(o),e.draftPolygon&&(e.draftPolygon._remove(),e.draftPolygon=null);const c={type:"Polygon",coordinates:[i]},u=new fr({geometry:c,style:e.polygonStyle});u.addTo(r),e.draftPolygon=u},generate(s,e){const t=s.tool;if(e.length<3)return null;if(s.draftPolygon&&(s.draftPolygon._remove(),s.draftPolygon=null),s.draftEdgeLine&&(s.draftEdgeLine._remove(),s.draftEdgeLine=null),Array.isArray(s.draftAnchors)){for(const u of s.draftAnchors)u?._remove();s.draftAnchors=[]}const r=$r(t.options.geometryStyle,{type:"basic-polygon",color:"#00ff00",opacity:.5}),i=e.slice(),o=i[0],l=i[i.length-1];return(o[0]!==l[0]||o[1]!==l[1]||(o[2]||0)!==(l[2]||0))&&i.push(o),new fr({geometry:{type:"Polygon",coordinates:[i]},style:r})}};Gi.registerMode("point",Ry),Gi.registerMode("line",jy),Gi.registerMode("polygon",$y);function $r(s,e){return xt.create(s||e)}var Xy=Object.defineProperty,Yy=(s,e,t)=>e in s?Xy(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Mt=(s,e,t)=>Yy(s,typeof e!="symbol"?e+"":e,t);class qt{constructor(e){Mt(this,"dataType","image"),Mt(this,"attribution","isource"),Mt(this,"minLevel",0),Mt(this,"maxLevel",18),Mt(this,"projectionID","3857"),Mt(this,"url",""),Mt(this,"subdomains",[]),Mt(this,"s",""),Mt(this,"opacity",1),Mt(this,"isTMS",!1),Mt(this,"bounds",[-180,-85,180,85]),Mt(this,"_projectionBounds",[-1/0,-1/0,1/0,1/0]),Mt(this,"tileMaterial"),Object.assign(this,e)}getUrl(e,t,r){const i={...this,x:e,y:t,z:r};return pc(this.url,i)}_getUrl(e,t,r){const i=this.subdomains.length;if(i>0){const l=Math.floor(Math.random()*i);this.s=this.subdomains[l]}const o=this.isTMS?Math.pow(2,r)-1-t:t;return this.getUrl(e,o,r)}static create(e){return new qt(e)}}var Zy=Object.defineProperty,Ky=(s,e,t)=>e in s?Zy(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Qt=(s,e,t)=>Ky(s,typeof e!="symbol"?e+"":e,t);class qy extends qt{constructor(e){if(super(e),Qt(this,"dataType","image"),Qt(this,"attribution","天地图"),Qt(this,"token",""),Qt(this,"style","img_w"),Qt(this,"subdomains","01234"),Qt(this,"url","https://t{s}.tianditu.gov.cn/DataServer?T={style}&x={x}&y={y}&l={z}&tk={token}"),Object.assign(this,e),!this.token)throw new Error("天地图访问令牌(token)是必填参数")}}class Qy extends qt{constructor(e){if(super(e),Qt(this,"dataType","quantized-mesh"),Qt(this,"attribution","天地图"),Qt(this,"token",""),Qt(this,"subdomains","01234"),Qt(this,"url","https://t{s}.tianditu.gov.cn/mapservice/swdx?T=elv_c&tk={token}&x={x}&y={y}&l={z}"),Object.assign(this,e),!this.token)throw new Error("天地图访问令牌(token)是必填参数")}}var Jy=Object.defineProperty,Ey=(s,e,t)=>e in s?Jy(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Au=(s,e,t)=>Ey(s,typeof e!="symbol"?e+"":e,t);class Hy extends qt{constructor(e){super({...e,url:e.urlTemplate,isTMS:e.isTMS||!1}),Au(this,"minLevel",2),Au(this,"maxLevel",24)}getUrl(e,t,r){const i=this.isTMS?Math.pow(2,r)-1-t:t;return pc(this.url,{...this,x:e,y:i,z:r,tileMatrix:r,tileRow:i,tileCol:e})}}var ev=Object.defineProperty,tv=(s,e,t)=>e in s?ev(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,br=(s,e,t)=>tv(s,typeof e!="symbol"?e+"":e,t);class rv extends qt{constructor(e){super(e),br(this,"dataType","image"),br(this,"attribution","ArcGIS"),br(this,"style","World_Imagery"),br(this,"url","https://services.arcgisonline.com/arcgis/rest/services/{style}/MapServer/tile/{z}/{y}/{x}"),Object.assign(this,e)}}class iv extends qt{constructor(e){super(e),br(this,"dataType","lerc"),br(this,"attribution","ArcGIS"),br(this,"minLevel",6),br(this,"maxLevel",13),br(this,"url","https://elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/Terrain3D/ImageServer/tile/{z}/{y}/{x}"),Object.assign(this,e)}}var nv=Object.defineProperty,sv=(s,e,t)=>e in s?nv(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ri=(s,e,t)=>sv(s,typeof e!="symbol"?e+"":e,t);class ov extends qt{constructor(e){if(super(e),Ri(this,"token",""),Ri(this,"format","webp"),Ri(this,"style","cm2myr6qx001t01pi0sf7estf"),Ri(this,"attribution","MapBox"),Ri(this,"maxLevel",25),Ri(this,"url","https://api.mapbox.com/styles/v1/criska/cm2myr6qx001t01pi0sf7estf/tiles/256/{z}/{x}/{y}?access_token={token}&format={format}"),Object.assign(this,e),!this.token)throw new Error("MapBox访问令牌(token)是必填参数")}}var av=Object.defineProperty,lv=(s,e,t)=>e in s?av(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Pu=(s,e,t)=>lv(s,typeof e!="symbol"?e+"":e,t);class cv extends qt{constructor(e){super(e),Pu(this,"dataType","mvt"),Pu(this,"style",{layer:{}}),Object.assign(this,e)}}var uv=Object.defineProperty,hv=(s,e,t)=>e in s?uv(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,In=(s,e,t)=>hv(s,typeof e!="symbol"?e+"":e,t);class fv extends qt{constructor(e){super(e),In(this,"dataType","VectorTile"),In(this,"attribution","ArcGIS"),In(this,"minLevel",1),In(this,"maxLevel",21),In(this,"url","https://api.maptiler.com/tiles/v3/{z}/{x}/{y}.pbf?key=uKYsZQZpm72WlbSgH9B7"),Object.assign(this,e)}}class dv extends Nr{constructor(e,t){super(e,t)}validateFeature(e){return e._baseType==="Line"}}class pv extends Nr{constructor(e,t){super(e,t)}validateFeature(e){return e._baseType==="Point"}}class mv extends Nr{constructor(e,t){super(e,t)}validateFeature(e){return e._baseType==="Surface"}}var gv=Object.defineProperty,_v=(s,e,t)=>e in s?gv(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,yv=(s,e,t)=>_v(s,e+"",t);class vv extends Nr{constructor(e,t){super(e,t),yv(this,"_clouds",null);const r=["texture"];for(const i of r)fc(t,i);this._createClouds(t.texture)}async _createClouds(e){const t=await xt._loadTexture(e),r=new zm({texture:t,material:f.MeshBasicMaterial});r.castShadow=!0,this._clouds=r}validateFeature(e){return e._type==="Cloud"}animate(e,t){this._clouds&&this._clouds.update(this.map.viewer.camera,t,e)}}var wv=Object.defineProperty,bv=(s,e,t)=>e in s?wv(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,xv=(s,e,t)=>bv(s,e+"",t);class pa extends Kc{constructor(e,t){super(e,t),xv(this,"layerType","raster")}createLoader(){const e=new bs;return Array.isArray(this.source)?e.imgSource=this.source:e.imgSource=[this.source],e}}var Sv=Object.defineProperty,Mv=(s,e,t)=>e in s?Sv(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Cs=(s,e,t)=>Mv(s,typeof e!="symbol"?e+"":e,t);class Av extends pa{constructor(e,t){super(e,t),Cs(this,"layerType","wmts"),Cs(this,"_layerName"),Cs(this,"_style"),Cs(this,"_matrixSet"),this._layerName=t.layerName,this._style=t.style||"default",this._matrixSet=t.matrixSet||"GoogleMapsCompatible"}get layerName(){return this._layerName}get style(){return this._style}get matrixSet(){return this._matrixSet}createLoader(){const e=new bs;return Array.isArray(this.source)?e.imgSource=this.source:e.imgSource=[this.source],e}update(e){this.loader&&super.update(e)}}console.log("%c✨ MapOrbis V"+sd+" ","color:rgb(255, 255, 255); font-weight: bold; background: linear-gradient(90deg, #ffb6c1, #ff69b4); padding: 5px; border-radius: 5px;"),J.AbstractCanvasMaterialLoader=h0,J.AbstractGeometryLoader=oa,J.AbstractMaterialLoader=ys,J.ArcGISLercLoader=ru,J.ArcGisDemSource=iv,J.ArcGisSource=rv,J.CloudsLayer=vv,J.CompositeTileLoader=bs,J.DrawTool=Gi,J.EventClass=Ro,J.ExternalModelLoader=Ko,J.Feature=tt,J.GeometryHelper=ki,J.GeometrySkirtUtils=Ec,J.ICloud=$c,J.InfoWindow=fa,J.Label=Xc,J.LineLayer=dv,J.LineString=pt,J.LoaderUtils=Pn,J.MVTGeoSource=fv,J.MVTSource=cv,J.Map=pi,J.MapBoxSource=ov,J.MapTileGeometry=zi,J.MapTool=Su,J.MapboxRGBLoader=su,J.MapboxVectorTileGeometryLoader=lu,J.Marker=wr,J.Model=jc,J.MultiLineString=Rc,J.PointLayer=pv,J.Polygon=fr,J.PolygonLayer=mv,J.ProjectionFactory=by,J.RasterTileLayer=pa,J.Style=xt,J.TDTQMSource=Qy,J.TDTSource=qy,J.TPoints=Zc,J.TerrainMeshBuilder=_0,J.Tile=ni,J.TileLayer=pa,J.TileLoaderFactory=Ve,J.TileLoadingManager=Jc,J.TileMaterial=qc,J.TileSource=qt,J.UIComponent=bu,J.VectorFeatureTypes=Xe,J.VectorTileLayer=ua,J.VectorTileRender=Qc,J.VectorTileTextureLoader=du,J.Viewer=gc,J.WMTSSource=Hy,J.WMTSTileLayer=Av,J.WebImageLoader=pu,J.getApproxZoomLevel=vd,J.getLocalInfoFromGeo=yd,J.getLocalInfoFromRay=vo,J.getLocalInfoFromScreen=wo,J.getLocalInfoFromWorld=En,J.registerDefaultLoaders=mu,Object.defineProperty(J,Symbol.toStringTag,{value:"Module"})}));
