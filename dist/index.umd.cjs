(function(Q,f){typeof exports=="object"&&typeof module<"u"?f(exports,require("three")):typeof define=="function"&&define.amd?define(["exports","three"],f):(Q=typeof globalThis<"u"?globalThis:Q||self,f(Q.maporbis={},Q.THREE))})(this,(function(Q,f){"use strict";function cd(s){const e=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(s){for(const t in s)if(t!=="default"){const r=Object.getOwnPropertyDescriptor(s,t);Object.defineProperty(e,t,r.get?r:{enumerable:!0,get:()=>s[t]})}}return e.default=s,Object.freeze(e)}const tt=cd(f),ud="0.1.0-beta";var dn=(s=>(s[s.none=0]="none",s[s.create=1]="create",s[s.remove=2]="remove",s))(dn||{});function hd(s,e){const t=s.position.clone().setZ(s.maxZ).applyMatrix4(s.matrixWorld);return e.distanceTo(t)}function fd(s){const e=s.scale,t=new f.Vector3(-e.x,-e.y,0).applyMatrix4(s.matrixWorld),r=new f.Vector3(e.x,e.y,0).applyMatrix4(s.matrixWorld);return t.sub(r).length()}function dd(s){return s.distToCamera/s.sizeInWorld*.8}function pd(s,e,t,r){const i=dd(s);if(s.isLeaf){if(s.inFrustum&&s.z<t&&(s.z<e||s.showing)&&(s.z<e||i<r))return 1}else if(s.z>=e&&(s.z>t||i>r))return 2;return 0}function md(s,e,t,r){const i=[],o=r+1,l=e*2,c=0,u=.25;{const d=t*2,m=new f.Vector3(.5,.5,1),p=new ni(l,d,o),_=new ni(l+1,d,o),v=new ni(l,d+1,o),M=new ni(l+1,d+1,o);p.position.set(-u,u,c),p.scale.copy(m),_.position.set(u,u,c),_.scale.copy(m),v.position.set(-u,-u,c),v.scale.copy(m),M.position.set(u,-u,c),M.scale.copy(m),i.push(p,_,v,M)}return i}var gd=Object.defineProperty,_d=(s,e,t)=>e in s?gd(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ze=(s,e,t)=>_d(s,typeof e!="symbol"?e+"":e,t);const yd=10,vd=new f.InstancedBufferGeometry,wd=new f.Vector3,bd=new f.Matrix4,xd=new f.Box3(new f.Vector3(-.5,-.5,0),new f.Vector3(.5,.5,1)),Fl=new f.Frustum,Bl=class es extends f.Mesh{constructor(e=0,t=0,r=0){super(vd,[]),Ze(this,"_dataMode",!1),Ze(this,"_vectorData",null),Ze(this,"x"),Ze(this,"y"),Ze(this,"z"),Ze(this,"isTile",!0),Ze(this,"parent",null),Ze(this,"children",[]),Ze(this,"_isReady",!1),Ze(this,"_isVirtualTile",!1),Ze(this,"_isVisible",!1),Ze(this,"_maxHeight",0),Ze(this,"distToCamera",0),Ze(this,"sizeInWorld",0),Ze(this,"_isLoaded",!1),Ze(this,"_inFrustum",!1),this.x=e,this.y=t,this.z=r,this.name=`Tile ${r}-${e}-${t}`,this.up.set(0,0,1),this.matrixAutoUpdate=!1}setDataOnlyMode(e){return this._dataMode=e,e&&(this.visible=!1),this}isDataOnlyMode(){return this._dataMode}getVectorData(){return this._vectorData}static get downloadThreads(){return es._activeDownloads}get isDummy(){return this._isVirtualTile}get showing(){return this._isVisible}set showing(e){const t=this._isVisible;this._isVisible=e,this.material.forEach(r=>r.visible=e),t===!1&&this._isVisible===!0&&this._isLoaded&&this.dispatchEvent({type:"tile-shown",tile:this}),t===!0&&this._isVisible===!1&&this.dispatchEvent({type:"tile-hidden",tile:this})}get maxZ(){return this._maxHeight}set maxZ(e){this._maxHeight=e}get index(){return this.parent?this.parent.children.indexOf(this):-1}get loaded(){return this._isLoaded}get inFrustum(){return this._inFrustum}set inFrustum(e){this._inFrustum=e}get isLeaf(){return this.children.filter(e=>e.isTile).length===0}traverse(e){e(this),this.children.forEach(t=>{t.isTile&&t.traverse(e)})}traverseVisible(e){this.visible&&(e(this),this.children.forEach(t=>{t.isTile&&t.traverseVisible(e)}))}raycast(e,t){this.showing&&this.loaded&&this.isTile&&super.raycast(e,t)}_updateLOD(e){if(es.downloadThreads>yd)return{action:dn.none};let t=[];const{loader:r,minLevel:i,maxLevel:o,LODThreshold:l}=e,c=pd(this,i,o,l);return c===dn.create&&(t=md(r,this.x,this.y,this.z),this.add(...t)),{action:c,newTiles:t}}_checkVisibility(){const e=this.parent;if(e&&e.isTile){const t=e.children.filter(i=>i.isTile),r=t.every(i=>i.loaded);e.showing=!r,t.forEach(i=>i.showing=r)}return this}async _loadData(e){es._activeDownloads++;const{x:t,y:r,z:i}=this;if(this._dataMode)try{const o=await e.load({x:t,y:r,z:i,bounds:[-1/0,-1/0,1/0,1/0]});this._vectorData=o.geometry?.userData||{},this._isLoaded=!0,this.dispatchEvent({type:"vector-data-loaded",data:this._vectorData,tile:this})}catch(o){console.error(`数据模式加载失败 ${i}/${t}/${r}:`,o),this._isLoaded=!1}else{const o=await e.load({x:t,y:r,z:i,bounds:[-1/0,-1/0,1/0,1/0]});this.material=o.materials,this.geometry=o.geometry,this.maxZ=this.geometry.boundingBox?.max.z||0,this._isLoaded=!0}return es._activeDownloads--,this}_initTile(){this.updateMatrix(),this.updateMatrixWorld(),this.sizeInWorld=fd(this)}update(e){if(console.assert(this.z===0),!this.parent)return this;Fl.setFromProjectionMatrix(bd.multiplyMatrices(e.camera.projectionMatrix,e.camera.matrixWorldInverse));const t=e.camera.getWorldPosition(wd);return this.traverse(r=>{r.receiveShadow=this.receiveShadow,r.castShadow=this.castShadow;const i=xd.clone().applyMatrix4(r.matrixWorld);r.inFrustum=Fl.intersectsBox(i),r.distToCamera=hd(r,t);const{action:o,newTiles:l}=r._updateLOD(e);this._processLODAction(r,o,l,e)}),this._checkReadyState(),this}_processLODAction(e,t,r,i){return t===dn.create?r?.forEach(o=>{o._initTile(),o._isVirtualTile=o.z<i.minLevel,this.dispatchEvent({type:"tile-created",tile:o}),o.isDummy||o._loadData(i.loader).then(()=>{o._checkVisibility(),this.dispatchEvent({type:"tile-loaded",tile:o})})}):t===dn.remove&&(e.showing=!0,e._disposeResources(!1,i.loader),this.dispatchEvent({type:"tile-unload",tile:e})),this}reload(e){return this._disposeResources(!0,e),this}_checkReadyState(){return this._isReady||(this._isReady=!0,this.traverse(e=>{if(e.isLeaf&&e.loaded&&!e.isDummy){this._isReady=!1;return}}),this._isReady&&this.dispatchEvent({type:"ready"})),this}_disposeResources(e,t){return e&&this.isTile&&!this.isDummy&&(this.dispatchEvent({type:"unload"}),t?.unload?.(this)),this.children.forEach(r=>r._disposeResources(!0,t)),this.clear(),this}};Ze(Bl,"_activeDownloads",0);let ni=Bl;function Mo(s,e){const t=s.getLayers().find(o=>o.isBaseLayer===!0);if(!t||!t._rootTile)return;const r=t._rootTile,i=e.intersectObjects([r]);for(const o of i)if(o.object instanceof ni){const l=o.point.clone(),c=s.pointToLngLat(l);return Object.assign(o,{location:c})}}function ts(s,e){const t=new f.Vector3(0,-1,0),r=new f.Vector3(e.x,10*1e3,e.z),i=new f.Raycaster(r,t);return Mo(s,i)}function So(s,e,t){const r=new f.Raycaster;return r.setFromCamera(t,s),Mo(e,r)}function Md(s,e){const t=s.lngLatToWorld(e);return ts(s,t)}function Sd(s,e){return e.getZoom()}var pn=function(){var s=0,e=document.createElement("div");e.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",e.addEventListener("click",function(m){m.preventDefault(),r(++s%e.children.length)},!1);function t(m){return e.appendChild(m.dom),m}function r(m){for(var p=0;p<e.children.length;p++)e.children[p].style.display=p===m?"block":"none";s=m}var i=(performance||Date).now(),o=i,l=0,c=t(new pn.Panel("FPS","#0ff","#002")),u=t(new pn.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var d=t(new pn.Panel("MB","#f08","#201"));return r(0),{REVISION:16,dom:e,addPanel:t,showPanel:r,begin:function(){i=(performance||Date).now()},end:function(){l++;var m=(performance||Date).now();if(u.update(m-i,200),m>=o+1e3&&(c.update(l*1e3/(m-o),100),o=m,l=0,d)){var p=performance.memory;d.update(p.usedJSHeapSize/1048576,p.jsHeapSizeLimit/1048576)}return m},update:function(){i=this.end()},domElement:e,setMode:r}};pn.Panel=function(s,e,t){var r=1/0,i=0,o=Math.round,l=o(window.devicePixelRatio||1),c=80*l,u=48*l,d=3*l,m=2*l,p=3*l,_=15*l,v=74*l,M=30*l,S=document.createElement("canvas");S.width=c,S.height=u,S.style.cssText="width:80px;height:48px";var x=S.getContext("2d");return x.font="bold "+9*l+"px Helvetica,Arial,sans-serif",x.textBaseline="top",x.fillStyle=t,x.fillRect(0,0,c,u),x.fillStyle=e,x.fillText(s,d,m),x.fillRect(p,_,v,M),x.fillStyle=t,x.globalAlpha=.9,x.fillRect(p,_,v,M),{dom:S,update:function(O,P){r=Math.min(r,O),i=Math.max(i,O),x.fillStyle=t,x.globalAlpha=1,x.fillRect(0,0,c,_),x.fillStyle=e,x.fillText(o(O)+" "+s+" ("+o(r)+"-"+o(i)+")",d,m),x.drawImage(S,p+l,_,v-l,M,p,_,v-l,M),x.fillRect(p+v-l,_,l,M),x.fillStyle=t,x.globalAlpha=.9,x.fillRect(p+v-l,_,l,o((1-O/P)*M))}}};const rs=parseInt(f.REVISION.replace(/\D+/g,"")),Ao=rs>=125?"uv1":"uv2";function Ul(s,e){if(e===f.TrianglesDrawMode)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),s;if(e===f.TriangleFanDrawMode||e===f.TriangleStripDrawMode){let t=s.getIndex();if(t===null){const l=[],c=s.getAttribute("position");if(c!==void 0){for(let u=0;u<c.count;u++)l.push(u);s.setIndex(l),t=s.getIndex()}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),s}const r=t.count-2,i=[];if(t)if(e===f.TriangleFanDrawMode)for(let l=1;l<=r;l++)i.push(t.getX(0)),i.push(t.getX(l)),i.push(t.getX(l+1));else for(let l=0;l<r;l++)l%2===0?(i.push(t.getX(l)),i.push(t.getX(l+1)),i.push(t.getX(l+2))):(i.push(t.getX(l+2)),i.push(t.getX(l+1)),i.push(t.getX(l)));i.length/3!==r&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const o=s.clone();return o.setIndex(i),o.clearGroups(),o}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",e),s}var It=Uint8Array,Fr=Uint16Array,Po=Uint32Array,Vl=new It([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),kl=new It([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Ad=new It([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),zl=function(s,e){for(var t=new Fr(31),r=0;r<31;++r)t[r]=e+=1<<s[r-1];for(var i=new Po(t[30]),r=1;r<30;++r)for(var o=t[r];o<t[r+1];++o)i[o]=o-t[r]<<5|r;return[t,i]},Nl=zl(Vl,2),Rl=Nl[0],Pd=Nl[1];Rl[28]=258,Pd[258]=28;for(var Ld=zl(kl,0),Cd=Ld[0],Lo=new Fr(32768),De=0;De<32768;++De){var Br=(De&43690)>>>1|(De&21845)<<1;Br=(Br&52428)>>>2|(Br&13107)<<2,Br=(Br&61680)>>>4|(Br&3855)<<4,Lo[De]=((Br&65280)>>>8|(Br&255)<<8)>>>1}for(var mn=(function(s,e,t){for(var r=s.length,i=0,o=new Fr(e);i<r;++i)++o[s[i]-1];var l=new Fr(e);for(i=0;i<e;++i)l[i]=l[i-1]+o[i-1]<<1;var c;if(t){c=new Fr(1<<e);var u=15-e;for(i=0;i<r;++i)if(s[i])for(var d=i<<4|s[i],m=e-s[i],p=l[s[i]-1]++<<m,_=p|(1<<m)-1;p<=_;++p)c[Lo[p]>>>u]=d}else for(c=new Fr(r),i=0;i<r;++i)s[i]&&(c[i]=Lo[l[s[i]-1]++]>>>15-s[i]);return c}),gn=new It(288),De=0;De<144;++De)gn[De]=8;for(var De=144;De<256;++De)gn[De]=9;for(var De=256;De<280;++De)gn[De]=7;for(var De=280;De<288;++De)gn[De]=8;for(var Wl=new It(32),De=0;De<32;++De)Wl[De]=5;var Od=mn(gn,9,1),Td=mn(Wl,5,1),Co=function(s){for(var e=s[0],t=1;t<s.length;++t)s[t]>e&&(e=s[t]);return e},Yt=function(s,e,t){var r=e/8|0;return(s[r]|s[r+1]<<8)>>(e&7)&t},Oo=function(s,e){var t=e/8|0;return(s[t]|s[t+1]<<8|s[t+2]<<16)>>(e&7)},Dd=function(s){return(s/8|0)+(s&7&&1)},Id=function(s,e,t){(t==null||t>s.length)&&(t=s.length);var r=new(s instanceof Fr?Fr:s instanceof Po?Po:It)(t-e);return r.set(s.subarray(e,t)),r},Fd=function(s,e,t){var r=s.length;if(!r||t&&!t.l&&r<5)return e||new It(0);var i=!e||t,o=!t||t.i;t||(t={}),e||(e=new It(r*3));var l=function(Vt){var Et=e.length;if(Vt>Et){var gt=new It(Math.max(Et*2,Vt));gt.set(e),e=gt}},c=t.f||0,u=t.p||0,d=t.b||0,m=t.l,p=t.d,_=t.m,v=t.n,M=r*8;do{if(!m){t.f=c=Yt(s,u,1);var S=Yt(s,u+1,3);if(u+=3,S)if(S==1)m=Od,p=Td,_=9,v=5;else if(S==2){var L=Yt(s,u,31)+257,F=Yt(s,u+10,15)+4,z=L+Yt(s,u+5,31)+1;u+=14;for(var j=new It(z),G=new It(19),U=0;U<F;++U)G[Ad[U]]=Yt(s,u+U*3,7);u+=F*3;for(var X=Co(G),N=(1<<X)-1,k=mn(G,X,1),U=0;U<z;){var Z=k[Yt(s,u,N)];u+=Z&15;var x=Z>>>4;if(x<16)j[U++]=x;else{var E=0,q=0;for(x==16?(q=3+Yt(s,u,3),u+=2,E=j[U-1]):x==17?(q=3+Yt(s,u,7),u+=3):x==18&&(q=11+Yt(s,u,127),u+=7);q--;)j[U++]=E}}var te=j.subarray(0,L),H=j.subarray(L);_=Co(te),v=Co(H),m=mn(te,_,1),p=mn(H,v,1)}else throw"invalid block type";else{var x=Dd(u)+4,O=s[x-4]|s[x-3]<<8,P=x+O;if(P>r){if(o)throw"unexpected EOF";break}i&&l(d+O),e.set(s.subarray(x,P),d),t.b=d+=O,t.p=u=P*8;continue}if(u>M){if(o)throw"unexpected EOF";break}}i&&l(d+131072);for(var Pe=(1<<_)-1,ve=(1<<v)-1,we=u;;we=u){var E=m[Oo(s,u)&Pe],me=E>>>4;if(u+=E&15,u>M){if(o)throw"unexpected EOF";break}if(!E)throw"invalid length/literal";if(me<256)e[d++]=me;else if(me==256){we=u,m=null;break}else{var Le=me-254;if(me>264){var U=me-257,Ce=Vl[U];Le=Yt(s,u,(1<<Ce)-1)+Rl[U],u+=Ce}var Oe=p[Oo(s,u)&ve],lt=Oe>>>4;if(!Oe)throw"invalid distance";u+=Oe&15;var H=Cd[lt];if(lt>3){var Ce=kl[lt];H+=Oo(s,u)&(1<<Ce)-1,u+=Ce}if(u>M){if(o)throw"unexpected EOF";break}i&&l(d+131072);for(var ct=d+Le;d<ct;d+=4)e[d]=e[d-H],e[d+1]=e[d+1-H],e[d+2]=e[d+2-H],e[d+3]=e[d+3-H];d=ct}}t.l=m,t.p=we,t.b=d,m&&(c=1,t.m=_,t.d=p,t.n=v)}while(!c);return d==e.length?e:Id(e,0,d)},Bd=new It(0),Ud=function(s){if((s[0]&15)!=8||s[0]>>>4>7||(s[0]<<8|s[1])%31)throw"invalid zlib data";if(s[1]&32)throw"invalid zlib data: preset dictionaries not supported"};function Vd(s,e){return Fd((Ud(s),s.subarray(2,-4)),e)}var kd=typeof TextDecoder<"u"&&new TextDecoder,zd=0;try{kd.decode(Bd,{stream:!0}),zd=1}catch{}class Nd extends f.Mesh{constructor(e,t={}){super(e),this.isWater=!0;const r=this,i=t.textureWidth!==void 0?t.textureWidth:512,o=t.textureHeight!==void 0?t.textureHeight:512,l=t.clipBias!==void 0?t.clipBias:0,c=t.alpha!==void 0?t.alpha:1,u=t.time!==void 0?t.time:0,d=t.waterNormals!==void 0?t.waterNormals:null,m=t.sunDirection!==void 0?t.sunDirection:new f.Vector3(.70707,.70707,0),p=new f.Color(t.sunColor!==void 0?t.sunColor:16777215),_=new f.Color(t.waterColor!==void 0?t.waterColor:8355711),v=t.eye!==void 0?t.eye:new f.Vector3(0,0,0),M=t.distortionScale!==void 0?t.distortionScale:20,S=t.side!==void 0?t.side:f.FrontSide,x=t.fog!==void 0?t.fog:!1,O=new f.Plane,P=new f.Vector3,L=new f.Vector3,F=new f.Vector3,z=new f.Matrix4,j=new f.Vector3(0,0,-1),G=new f.Vector4,U=new f.Vector3,X=new f.Vector3,N=new f.Vector4,k=new f.Matrix4,Z=new f.PerspectiveCamera,E=new f.WebGLRenderTarget(i,o),q={uniforms:f.UniformsUtils.merge([f.UniformsLib.fog,f.UniformsLib.lights,{normalSampler:{value:null},mirrorSampler:{value:null},alpha:{value:1},time:{value:0},size:{value:1},distortionScale:{value:20},textureMatrix:{value:new f.Matrix4},sunColor:{value:new f.Color(8355711)},sunDirection:{value:new f.Vector3(.70707,.70707,0)},eye:{value:new f.Vector3},waterColor:{value:new f.Color(5592405)}}]),vertexShader:`
				uniform mat4 textureMatrix;
				uniform float time;

				varying vec4 mirrorCoord;
				varying vec4 worldPosition;

				#include <common>
				#include <fog_pars_vertex>
				#include <shadowmap_pars_vertex>
				#include <logdepthbuf_pars_vertex>

				void main() {
					mirrorCoord = modelMatrix * vec4( position, 1.0 );
					worldPosition = mirrorCoord.xyzw;
					mirrorCoord = textureMatrix * mirrorCoord;
					vec4 mvPosition =  modelViewMatrix * vec4( position, 1.0 );
					gl_Position = projectionMatrix * mvPosition;

				#include <beginnormal_vertex>
				#include <defaultnormal_vertex>
				#include <logdepthbuf_vertex>
				#include <fog_vertex>
				#include <shadowmap_vertex>
			}`,fragmentShader:`
				uniform sampler2D mirrorSampler;
				uniform float alpha;
				uniform float time;
				uniform float size;
				uniform float distortionScale;
				uniform sampler2D normalSampler;
				uniform vec3 sunColor;
				uniform vec3 sunDirection;
				uniform vec3 eye;
				uniform vec3 waterColor;

				varying vec4 mirrorCoord;
				varying vec4 worldPosition;

				vec4 getNoise( vec2 uv ) {
					vec2 uv0 = ( uv / 103.0 ) + vec2(time / 17.0, time / 29.0);
					vec2 uv1 = uv / 107.0-vec2( time / -19.0, time / 31.0 );
					vec2 uv2 = uv / vec2( 8907.0, 9803.0 ) + vec2( time / 101.0, time / 97.0 );
					vec2 uv3 = uv / vec2( 1091.0, 1027.0 ) - vec2( time / 109.0, time / -113.0 );
					vec4 noise = texture2D( normalSampler, uv0 ) +
						texture2D( normalSampler, uv1 ) +
						texture2D( normalSampler, uv2 ) +
						texture2D( normalSampler, uv3 );
					return noise * 0.5 - 1.0;
				}

				void sunLight( const vec3 surfaceNormal, const vec3 eyeDirection, float shiny, float spec, float diffuse, inout vec3 diffuseColor, inout vec3 specularColor ) {
					vec3 reflection = normalize( reflect( -sunDirection, surfaceNormal ) );
					float direction = max( 0.0, dot( eyeDirection, reflection ) );
					specularColor += pow( direction, shiny ) * sunColor * spec;
					diffuseColor += max( dot( sunDirection, surfaceNormal ), 0.0 ) * sunColor * diffuse;
				}

				#include <common>
				#include <packing>
				#include <bsdfs>
				#include <fog_pars_fragment>
				#include <logdepthbuf_pars_fragment>
				#include <lights_pars_begin>
				#include <shadowmap_pars_fragment>
				#include <shadowmask_pars_fragment>

				void main() {

					#include <logdepthbuf_fragment>
					vec4 noise = getNoise( worldPosition.xz * size );
					vec3 surfaceNormal = normalize( noise.xzy * vec3( 1.5, 1.0, 1.5 ) );

					vec3 diffuseLight = vec3(0.0);
					vec3 specularLight = vec3(0.0);

					vec3 worldToEye = eye-worldPosition.xyz;
					vec3 eyeDirection = normalize( worldToEye );
					sunLight( surfaceNormal, eyeDirection, 100.0, 2.0, 0.5, diffuseLight, specularLight );

					float distance = length(worldToEye);

					vec2 distortion = surfaceNormal.xz * ( 0.001 + 1.0 / distance ) * distortionScale;
					vec3 reflectionSample = vec3( texture2D( mirrorSampler, mirrorCoord.xy / mirrorCoord.w + distortion ) );

					float theta = max( dot( eyeDirection, surfaceNormal ), 0.0 );
					float rf0 = 0.3;
					float reflectance = rf0 + ( 1.0 - rf0 ) * pow( ( 1.0 - theta ), 5.0 );
					vec3 scatter = max( 0.0, dot( surfaceNormal, eyeDirection ) ) * waterColor;
					vec3 albedo = mix( ( sunColor * diffuseLight * 0.3 + scatter ) * getShadowMask(), ( vec3( 0.1 ) + reflectionSample * 0.9 + reflectionSample * specularLight ), reflectance);
					vec3 outgoingLight = albedo;
					gl_FragColor = vec4( outgoingLight, alpha );

					#include <tonemapping_fragment>
					#include <${rs>=154?"colorspace_fragment":"encodings_fragment"}>
					#include <fog_fragment>	
				}`},te=new f.ShaderMaterial({fragmentShader:q.fragmentShader,vertexShader:q.vertexShader,uniforms:f.UniformsUtils.clone(q.uniforms),lights:!0,side:S,fog:x});te.uniforms.mirrorSampler.value=E.texture,te.uniforms.textureMatrix.value=k,te.uniforms.alpha.value=c,te.uniforms.time.value=u,te.uniforms.normalSampler.value=d,te.uniforms.sunColor.value=p,te.uniforms.waterColor.value=_,te.uniforms.sunDirection.value=m,te.uniforms.distortionScale.value=M,te.uniforms.eye.value=v,r.material=te,r.onBeforeRender=function(H,Pe,ve){if(L.setFromMatrixPosition(r.matrixWorld),F.setFromMatrixPosition(ve.matrixWorld),z.extractRotation(r.matrixWorld),P.set(0,0,1),P.applyMatrix4(z),U.subVectors(L,F),U.dot(P)>0)return;U.reflect(P).negate(),U.add(L),z.extractRotation(ve.matrixWorld),j.set(0,0,-1),j.applyMatrix4(z),j.add(F),X.subVectors(L,j),X.reflect(P).negate(),X.add(L),Z.position.copy(U),Z.up.set(0,1,0),Z.up.applyMatrix4(z),Z.up.reflect(P),Z.lookAt(X),Z.far=ve.far,Z.updateMatrixWorld(),Z.projectionMatrix.copy(ve.projectionMatrix),k.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),k.multiply(Z.projectionMatrix),k.multiply(Z.matrixWorldInverse),O.setFromNormalAndCoplanarPoint(P,L),O.applyMatrix4(Z.matrixWorldInverse),G.set(O.normal.x,O.normal.y,O.normal.z,O.constant);const we=Z.projectionMatrix;N.x=(Math.sign(G.x)+we.elements[8])/we.elements[0],N.y=(Math.sign(G.y)+we.elements[9])/we.elements[5],N.z=-1,N.w=(1+we.elements[10])/we.elements[14],G.multiplyScalar(2/G.dot(N)),we.elements[2]=G.x,we.elements[6]=G.y,we.elements[10]=G.z+1-l,we.elements[14]=G.w,v.setFromMatrixPosition(ve.matrixWorld);const me=H.getRenderTarget(),Le=H.xr.enabled,Ce=H.shadowMap.autoUpdate;r.visible=!1,H.xr.enabled=!1,H.shadowMap.autoUpdate=!1,H.setRenderTarget(E),H.state.buffers.depth.setMask(!0),H.autoClear===!1&&H.clear(),H.render(Pe,Z),r.visible=!0,H.xr.enabled=Le,H.shadowMap.autoUpdate=Ce,H.setRenderTarget(me);const Oe=ve.viewport;Oe!==void 0&&H.state.viewport(Oe)}}}var Rd=Object.defineProperty,Wd=(s,e,t)=>e in s?Rd(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Gd=(s,e,t)=>(Wd(s,e+"",t),t);class $d{constructor(){Gd(this,"_listeners")}addEventListener(e,t){this._listeners===void 0&&(this._listeners={});const r=this._listeners;r[e]===void 0&&(r[e]=[]),r[e].indexOf(t)===-1&&r[e].push(t)}hasEventListener(e,t){if(this._listeners===void 0)return!1;const r=this._listeners;return r[e]!==void 0&&r[e].indexOf(t)!==-1}removeEventListener(e,t){if(this._listeners===void 0)return;const i=this._listeners[e];if(i!==void 0){const o=i.indexOf(t);o!==-1&&i.splice(o,1)}}dispatchEvent(e){if(this._listeners===void 0)return;const r=this._listeners[e.type];if(r!==void 0){e.target=this;const i=r.slice(0);for(let o=0,l=i.length;o<l;o++)i[o].call(this,e);e.target=null}}}var jd=Object.defineProperty,Xd=(s,e,t)=>e in s?jd(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,re=(s,e,t)=>(Xd(s,typeof e!="symbol"?e+"":e,t),t);const is=new f.Ray,Gl=new f.Plane,Yd=Math.cos(70*(Math.PI/180)),$l=(s,e)=>(s%e+e)%e;class Zd extends $d{constructor(e,t){super(),re(this,"object"),re(this,"domElement"),re(this,"enabled",!0),re(this,"target",new f.Vector3),re(this,"minDistance",0),re(this,"maxDistance",1/0),re(this,"minZoom",0),re(this,"maxZoom",1/0),re(this,"minPolarAngle",0),re(this,"maxPolarAngle",Math.PI),re(this,"minAzimuthAngle",-1/0),re(this,"maxAzimuthAngle",1/0),re(this,"enableDamping",!1),re(this,"dampingFactor",.05),re(this,"enableZoom",!0),re(this,"zoomSpeed",1),re(this,"enableRotate",!0),re(this,"rotateSpeed",1),re(this,"enablePan",!0),re(this,"panSpeed",1),re(this,"screenSpacePanning",!0),re(this,"keyPanSpeed",7),re(this,"zoomToCursor",!1),re(this,"autoRotate",!1),re(this,"autoRotateSpeed",2),re(this,"reverseOrbit",!1),re(this,"reverseHorizontalOrbit",!1),re(this,"reverseVerticalOrbit",!1),re(this,"keys",{LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"}),re(this,"mouseButtons",{LEFT:f.MOUSE.ROTATE,MIDDLE:f.MOUSE.DOLLY,RIGHT:f.MOUSE.PAN}),re(this,"touches",{ONE:f.TOUCH.ROTATE,TWO:f.TOUCH.DOLLY_PAN}),re(this,"target0"),re(this,"position0"),re(this,"zoom0"),re(this,"_domElementKeyEvents",null),re(this,"getPolarAngle"),re(this,"getAzimuthalAngle"),re(this,"setPolarAngle"),re(this,"setAzimuthalAngle"),re(this,"getDistance"),re(this,"getZoomScale"),re(this,"listenToKeyEvents"),re(this,"stopListenToKeyEvents"),re(this,"saveState"),re(this,"reset"),re(this,"update"),re(this,"connect"),re(this,"dispose"),re(this,"dollyIn"),re(this,"dollyOut"),re(this,"getScale"),re(this,"setScale"),this.object=e,this.domElement=t,this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.getPolarAngle=()=>m.phi,this.getAzimuthalAngle=()=>m.theta,this.setPolarAngle=I=>{let Y=$l(I,2*Math.PI),oe=m.phi;oe<0&&(oe+=2*Math.PI),Y<0&&(Y+=2*Math.PI);let ye=Math.abs(Y-oe);2*Math.PI-ye<ye&&(Y<oe?Y+=2*Math.PI:oe+=2*Math.PI),p.phi=Y-oe,r.update()},this.setAzimuthalAngle=I=>{let Y=$l(I,2*Math.PI),oe=m.theta;oe<0&&(oe+=2*Math.PI),Y<0&&(Y+=2*Math.PI);let ye=Math.abs(Y-oe);2*Math.PI-ye<ye&&(Y<oe?Y+=2*Math.PI:oe+=2*Math.PI),p.theta=Y-oe,r.update()},this.getDistance=()=>r.object.position.distanceTo(r.target),this.listenToKeyEvents=I=>{I.addEventListener("keydown",pr),this._domElementKeyEvents=I},this.stopListenToKeyEvents=()=>{this._domElementKeyEvents.removeEventListener("keydown",pr),this._domElementKeyEvents=null},this.saveState=()=>{r.target0.copy(r.target),r.position0.copy(r.object.position),r.zoom0=r.object.zoom},this.reset=()=>{r.target.copy(r.target0),r.object.position.copy(r.position0),r.object.zoom=r.zoom0,r.object.updateProjectionMatrix(),r.dispatchEvent(i),r.update(),u=c.NONE},this.update=(()=>{const I=new f.Vector3,Y=new f.Vector3(0,1,0),oe=new f.Quaternion().setFromUnitVectors(e.up,Y),ye=oe.clone().invert(),Ge=new f.Vector3,kt=new f.Quaternion,er=2*Math.PI;return function(){const Is=r.object.position;oe.setFromUnitVectors(e.up,Y),ye.copy(oe).invert(),I.copy(Is).sub(r.target),I.applyQuaternion(oe),m.setFromVector3(I),r.autoRotate&&u===c.NONE&&q(Z()),r.enableDamping?(m.theta+=p.theta*r.dampingFactor,m.phi+=p.phi*r.dampingFactor):(m.theta+=p.theta,m.phi+=p.phi);let tr=r.minAzimuthAngle,rr=r.maxAzimuthAngle;isFinite(tr)&&isFinite(rr)&&(tr<-Math.PI?tr+=er:tr>Math.PI&&(tr-=er),rr<-Math.PI?rr+=er:rr>Math.PI&&(rr-=er),tr<=rr?m.theta=Math.max(tr,Math.min(rr,m.theta)):m.theta=m.theta>(tr+rr)/2?Math.max(tr,m.theta):Math.min(rr,m.theta)),m.phi=Math.max(r.minPolarAngle,Math.min(r.maxPolarAngle,m.phi)),m.makeSafe(),r.enableDamping===!0?r.target.addScaledVector(v,r.dampingFactor):r.target.add(v),r.zoomToCursor&&X||r.object.isOrthographicCamera?m.radius=Oe(m.radius):m.radius=Oe(m.radius*_),I.setFromSpherical(m),I.applyQuaternion(ye),Is.copy(r.target).add(I),r.object.matrixAutoUpdate||r.object.updateMatrix(),r.object.lookAt(r.target),r.enableDamping===!0?(p.theta*=1-r.dampingFactor,p.phi*=1-r.dampingFactor,v.multiplyScalar(1-r.dampingFactor)):(p.set(0,0,0),v.set(0,0,0));let Kr=!1;if(r.zoomToCursor&&X){let bi=null;if(r.object instanceof f.PerspectiveCamera&&r.object.isPerspectiveCamera){const xi=I.length();bi=Oe(xi*_);const Qi=xi-bi;r.object.position.addScaledVector(G,Qi),r.object.updateMatrixWorld()}else if(r.object.isOrthographicCamera){const xi=new f.Vector3(U.x,U.y,0);xi.unproject(r.object),r.object.zoom=Math.max(r.minZoom,Math.min(r.maxZoom,r.object.zoom/_)),r.object.updateProjectionMatrix(),Kr=!0;const Qi=new f.Vector3(U.x,U.y,0);Qi.unproject(r.object),r.object.position.sub(Qi).add(xi),r.object.updateMatrixWorld(),bi=I.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),r.zoomToCursor=!1;bi!==null&&(r.screenSpacePanning?r.target.set(0,0,-1).transformDirection(r.object.matrix).multiplyScalar(bi).add(r.object.position):(is.origin.copy(r.object.position),is.direction.set(0,0,-1).transformDirection(r.object.matrix),Math.abs(r.object.up.dot(is.direction))<Yd?e.lookAt(r.target):(Gl.setFromNormalAndCoplanarPoint(r.object.up,r.target),is.intersectPlane(Gl,r.target))))}else r.object instanceof f.OrthographicCamera&&r.object.isOrthographicCamera&&(Kr=_!==1,Kr&&(r.object.zoom=Math.max(r.minZoom,Math.min(r.maxZoom,r.object.zoom/_)),r.object.updateProjectionMatrix()));return _=1,X=!1,Kr||Ge.distanceToSquared(r.object.position)>d||8*(1-kt.dot(r.object.quaternion))>d?(r.dispatchEvent(i),Ge.copy(r.object.position),kt.copy(r.object.quaternion),Kr=!1,!0):!1}})(),this.connect=I=>{r.domElement=I,r.domElement.style.touchAction="none",r.domElement.addEventListener("contextmenu",Ki),r.domElement.addEventListener("pointerdown",Xr),r.domElement.addEventListener("pointercancel",yi),r.domElement.addEventListener("wheel",Zr)},this.dispose=()=>{var I,Y,oe,ye,Ge,kt;r.domElement&&(r.domElement.style.touchAction="auto"),(I=r.domElement)==null||I.removeEventListener("contextmenu",Ki),(Y=r.domElement)==null||Y.removeEventListener("pointerdown",Xr),(oe=r.domElement)==null||oe.removeEventListener("pointercancel",yi),(ye=r.domElement)==null||ye.removeEventListener("wheel",Zr),(Ge=r.domElement)==null||Ge.ownerDocument.removeEventListener("pointermove",Yr),(kt=r.domElement)==null||kt.ownerDocument.removeEventListener("pointerup",yi),r._domElementKeyEvents!==null&&r._domElementKeyEvents.removeEventListener("keydown",pr)};const r=this,i={type:"change"},o={type:"start"},l={type:"end"},c={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let u=c.NONE;const d=1e-6,m=new f.Spherical,p=new f.Spherical;let _=1;const v=new f.Vector3,M=new f.Vector2,S=new f.Vector2,x=new f.Vector2,O=new f.Vector2,P=new f.Vector2,L=new f.Vector2,F=new f.Vector2,z=new f.Vector2,j=new f.Vector2,G=new f.Vector3,U=new f.Vector2;let X=!1;const N=[],k={};function Z(){return 2*Math.PI/60/60*r.autoRotateSpeed}function E(){return Math.pow(.95,r.zoomSpeed)}function q(I){r.reverseOrbit||r.reverseHorizontalOrbit?p.theta+=I:p.theta-=I}function te(I){r.reverseOrbit||r.reverseVerticalOrbit?p.phi+=I:p.phi-=I}const H=(()=>{const I=new f.Vector3;return function(oe,ye){I.setFromMatrixColumn(ye,0),I.multiplyScalar(-oe),v.add(I)}})(),Pe=(()=>{const I=new f.Vector3;return function(oe,ye){r.screenSpacePanning===!0?I.setFromMatrixColumn(ye,1):(I.setFromMatrixColumn(ye,0),I.crossVectors(r.object.up,I)),I.multiplyScalar(oe),v.add(I)}})(),ve=(()=>{const I=new f.Vector3;return function(oe,ye){const Ge=r.domElement;if(Ge&&r.object instanceof f.PerspectiveCamera&&r.object.isPerspectiveCamera){const kt=r.object.position;I.copy(kt).sub(r.target);let er=I.length();er*=Math.tan(r.object.fov/2*Math.PI/180),H(2*oe*er/Ge.clientHeight,r.object.matrix),Pe(2*ye*er/Ge.clientHeight,r.object.matrix)}else Ge&&r.object instanceof f.OrthographicCamera&&r.object.isOrthographicCamera?(H(oe*(r.object.right-r.object.left)/r.object.zoom/Ge.clientWidth,r.object.matrix),Pe(ye*(r.object.top-r.object.bottom)/r.object.zoom/Ge.clientHeight,r.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),r.enablePan=!1)}})();function we(I){r.object instanceof f.PerspectiveCamera&&r.object.isPerspectiveCamera||r.object instanceof f.OrthographicCamera&&r.object.isOrthographicCamera?_=I:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),r.enableZoom=!1)}function me(I){we(_/I)}function Le(I){we(_*I)}function Ce(I){if(!r.zoomToCursor||!r.domElement)return;X=!0;const Y=r.domElement.getBoundingClientRect(),oe=I.clientX-Y.left,ye=I.clientY-Y.top,Ge=Y.width,kt=Y.height;U.x=oe/Ge*2-1,U.y=-(ye/kt)*2+1,G.set(U.x,U.y,1).unproject(r.object).sub(r.object.position).normalize()}function Oe(I){return Math.max(r.minDistance,Math.min(r.maxDistance,I))}function lt(I){M.set(I.clientX,I.clientY)}function ct(I){Ce(I),F.set(I.clientX,I.clientY)}function Vt(I){O.set(I.clientX,I.clientY)}function Et(I){S.set(I.clientX,I.clientY),x.subVectors(S,M).multiplyScalar(r.rotateSpeed);const Y=r.domElement;Y&&(q(2*Math.PI*x.x/Y.clientHeight),te(2*Math.PI*x.y/Y.clientHeight)),M.copy(S),r.update()}function gt(I){z.set(I.clientX,I.clientY),j.subVectors(z,F),j.y>0?me(E()):j.y<0&&Le(E()),F.copy(z),r.update()}function Jt(I){P.set(I.clientX,I.clientY),L.subVectors(P,O).multiplyScalar(r.panSpeed),ve(L.x,L.y),O.copy(P),r.update()}function Yi(I){Ce(I),I.deltaY<0?Le(E()):I.deltaY>0&&me(E()),r.update()}function xr(I){let Y=!1;switch(I.code){case r.keys.UP:ve(0,r.keyPanSpeed),Y=!0;break;case r.keys.BOTTOM:ve(0,-r.keyPanSpeed),Y=!0;break;case r.keys.LEFT:ve(r.keyPanSpeed,0),Y=!0;break;case r.keys.RIGHT:ve(-r.keyPanSpeed,0),Y=!0;break}Y&&(I.preventDefault(),r.update())}function Ht(){if(N.length==1)M.set(N[0].pageX,N[0].pageY);else{const I=.5*(N[0].pageX+N[1].pageX),Y=.5*(N[0].pageY+N[1].pageY);M.set(I,Y)}}function Mr(){if(N.length==1)O.set(N[0].pageX,N[0].pageY);else{const I=.5*(N[0].pageX+N[1].pageX),Y=.5*(N[0].pageY+N[1].pageY);O.set(I,Y)}}function We(){const I=N[0].pageX-N[1].pageX,Y=N[0].pageY-N[1].pageY,oe=Math.sqrt(I*I+Y*Y);F.set(0,oe)}function St(){r.enableZoom&&We(),r.enablePan&&Mr()}function mi(){r.enableZoom&&We(),r.enableRotate&&Ht()}function _t(I){if(N.length==1)S.set(I.pageX,I.pageY);else{const oe=wi(I),ye=.5*(I.pageX+oe.x),Ge=.5*(I.pageY+oe.y);S.set(ye,Ge)}x.subVectors(S,M).multiplyScalar(r.rotateSpeed);const Y=r.domElement;Y&&(q(2*Math.PI*x.x/Y.clientHeight),te(2*Math.PI*x.y/Y.clientHeight)),M.copy(S)}function gi(I){if(N.length==1)P.set(I.pageX,I.pageY);else{const Y=wi(I),oe=.5*(I.pageX+Y.x),ye=.5*(I.pageY+Y.y);P.set(oe,ye)}L.subVectors(P,O).multiplyScalar(r.panSpeed),ve(L.x,L.y),O.copy(P)}function Zi(I){const Y=wi(I),oe=I.pageX-Y.x,ye=I.pageY-Y.y,Ge=Math.sqrt(oe*oe+ye*ye);z.set(0,Ge),j.set(0,Math.pow(z.y/F.y,r.zoomSpeed)),me(j.y),F.copy(z)}function _i(I){r.enableZoom&&Zi(I),r.enablePan&&gi(I)}function At(I){r.enableZoom&&Zi(I),r.enableRotate&&_t(I)}function Xr(I){var Y,oe;r.enabled!==!1&&(N.length===0&&((Y=r.domElement)==null||Y.ownerDocument.addEventListener("pointermove",Yr),(oe=r.domElement)==null||oe.ownerDocument.addEventListener("pointerup",yi)),kn(I),I.pointerType==="touch"?Un(I):vi(I))}function Yr(I){r.enabled!==!1&&(I.pointerType==="touch"?Vn(I):wa(I))}function yi(I){var Y,oe,ye;zn(I),N.length===0&&((Y=r.domElement)==null||Y.releasePointerCapture(I.pointerId),(oe=r.domElement)==null||oe.ownerDocument.removeEventListener("pointermove",Yr),(ye=r.domElement)==null||ye.ownerDocument.removeEventListener("pointerup",yi)),r.dispatchEvent(l),u=c.NONE}function vi(I){let Y;switch(I.button){case 0:Y=r.mouseButtons.LEFT;break;case 1:Y=r.mouseButtons.MIDDLE;break;case 2:Y=r.mouseButtons.RIGHT;break;default:Y=-1}switch(Y){case f.MOUSE.DOLLY:if(r.enableZoom===!1)return;ct(I),u=c.DOLLY;break;case f.MOUSE.ROTATE:if(I.ctrlKey||I.metaKey||I.shiftKey){if(r.enablePan===!1)return;Vt(I),u=c.PAN}else{if(r.enableRotate===!1)return;lt(I),u=c.ROTATE}break;case f.MOUSE.PAN:if(I.ctrlKey||I.metaKey||I.shiftKey){if(r.enableRotate===!1)return;lt(I),u=c.ROTATE}else{if(r.enablePan===!1)return;Vt(I),u=c.PAN}break;default:u=c.NONE}u!==c.NONE&&r.dispatchEvent(o)}function wa(I){if(r.enabled!==!1)switch(u){case c.ROTATE:if(r.enableRotate===!1)return;Et(I);break;case c.DOLLY:if(r.enableZoom===!1)return;gt(I);break;case c.PAN:if(r.enablePan===!1)return;Jt(I);break}}function Zr(I){r.enabled===!1||r.enableZoom===!1||u!==c.NONE&&u!==c.ROTATE||(I.preventDefault(),r.dispatchEvent(o),Yi(I),r.dispatchEvent(l))}function pr(I){r.enabled===!1||r.enablePan===!1||xr(I)}function Un(I){switch(qi(I),N.length){case 1:switch(r.touches.ONE){case f.TOUCH.ROTATE:if(r.enableRotate===!1)return;Ht(),u=c.TOUCH_ROTATE;break;case f.TOUCH.PAN:if(r.enablePan===!1)return;Mr(),u=c.TOUCH_PAN;break;default:u=c.NONE}break;case 2:switch(r.touches.TWO){case f.TOUCH.DOLLY_PAN:if(r.enableZoom===!1&&r.enablePan===!1)return;St(),u=c.TOUCH_DOLLY_PAN;break;case f.TOUCH.DOLLY_ROTATE:if(r.enableZoom===!1&&r.enableRotate===!1)return;mi(),u=c.TOUCH_DOLLY_ROTATE;break;default:u=c.NONE}break;default:u=c.NONE}u!==c.NONE&&r.dispatchEvent(o)}function Vn(I){switch(qi(I),u){case c.TOUCH_ROTATE:if(r.enableRotate===!1)return;_t(I),r.update();break;case c.TOUCH_PAN:if(r.enablePan===!1)return;gi(I),r.update();break;case c.TOUCH_DOLLY_PAN:if(r.enableZoom===!1&&r.enablePan===!1)return;_i(I),r.update();break;case c.TOUCH_DOLLY_ROTATE:if(r.enableZoom===!1&&r.enableRotate===!1)return;At(I),r.update();break;default:u=c.NONE}}function Ki(I){r.enabled!==!1&&I.preventDefault()}function kn(I){N.push(I)}function zn(I){delete k[I.pointerId];for(let Y=0;Y<N.length;Y++)if(N[Y].pointerId==I.pointerId){N.splice(Y,1);return}}function qi(I){let Y=k[I.pointerId];Y===void 0&&(Y=new f.Vector2,k[I.pointerId]=Y),Y.set(I.pageX,I.pageY)}function wi(I){const Y=I.pointerId===N[0].pointerId?N[1]:N[0];return k[Y.pointerId]}this.dollyIn=(I=E())=>{Le(I),r.update()},this.dollyOut=(I=E())=>{me(I),r.update()},this.getScale=()=>_,this.setScale=I=>{we(I),r.update()},this.getZoomScale=()=>E(),t!==void 0&&this.connect(t),this.update()}}class Kd extends Zd{constructor(e,t){super(e,t),this.screenSpacePanning=!1,this.mouseButtons.LEFT=f.MOUSE.PAN,this.mouseButtons.RIGHT=f.MOUSE.ROTATE,this.touches.ONE=f.TOUCH.PAN,this.touches.TWO=f.TOUCH.DOLLY_ROTATE}}var qd=Object.defineProperty,Qd=(s,e,t)=>e in s?qd(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,si=(s,e,t)=>(Qd(s,typeof e!="symbol"?e+"":e,t),t);class _n{constructor(){si(this,"enabled",!0),si(this,"needsSwap",!0),si(this,"clear",!1),si(this,"renderToScreen",!1)}setSize(e,t){}render(e,t,r,i,o){console.error("THREE.Pass: .render() must be implemented in derived pass.")}dispose(){}}class jl{constructor(e){si(this,"camera",new f.OrthographicCamera(-1,1,1,-1,0,1)),si(this,"geometry",new f.PlaneGeometry(2,2)),si(this,"mesh"),this.mesh=new f.Mesh(this.geometry,e)}get material(){return this.mesh.material}set material(e){this.mesh.material=e}dispose(){this.mesh.geometry.dispose()}render(e){e.render(this.mesh,this.camera)}}var Ed=Object.defineProperty,Jd=(s,e,t)=>e in s?Ed(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ns=(s,e,t)=>(Jd(s,typeof e!="symbol"?e+"":e,t),t);class Xl extends _n{constructor(e,t="tDiffuse"){super(),ns(this,"textureID"),ns(this,"uniforms"),ns(this,"material"),ns(this,"fsQuad"),this.textureID=t,e instanceof f.ShaderMaterial?(this.uniforms=e.uniforms,this.material=e):(this.uniforms=f.UniformsUtils.clone(e.uniforms),this.material=new f.ShaderMaterial({defines:Object.assign({},e.defines),uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this.fsQuad=new jl(this.material)}render(e,t,r){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=r.texture),this.fsQuad.material=this.material,this.renderToScreen?(e.setRenderTarget(null),this.fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),this.fsQuad.render(e))}dispose(){this.fsQuad.dispose(),this.material.dispose()}}const To={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:`
    varying vec2 vUv;

    void main() {

    	vUv = uv;
    	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

    }
  `,fragmentShader:`
    uniform float opacity;

    uniform sampler2D tDiffuse;

    varying vec2 vUv;

    void main() {

    	vec4 texel = texture2D( tDiffuse, vUv );
    	gl_FragColor = opacity * texel;

    }
  `},Hd={uniforms:{tDiffuse:{value:null},luminosityThreshold:{value:1},smoothWidth:{value:1},defaultColor:{value:new f.Color(0)},defaultOpacity:{value:0}},vertexShader:`
    varying vec2 vUv;

    void main() {

    	vUv = uv;

    	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform vec3 defaultColor;
    uniform float defaultOpacity;
    uniform float luminosityThreshold;
    uniform float smoothWidth;

    varying vec2 vUv;

    void main() {

    	vec4 texel = texture2D( tDiffuse, vUv );

    	vec3 luma = vec3( 0.299, 0.587, 0.114 );

    	float v = dot( texel.xyz, luma );

    	vec4 outputColor = vec4( defaultColor.rgb, defaultOpacity );

    	float alpha = smoothstep( luminosityThreshold, luminosityThreshold + smoothWidth, v );

    	gl_FragColor = mix( outputColor, texel, alpha );

    }
  `};var ep=Object.defineProperty,tp=(s,e,t)=>e in s?ep(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Yl=(s,e,t)=>(tp(s,typeof e!="symbol"?e+"":e,t),t);const rp=(()=>{const s=class extends _n{constructor(t,r,i,o){super(),this.strength=r!==void 0?r:1,this.radius=i,this.threshold=o,this.resolution=t!==void 0?new f.Vector2(t.x,t.y):new f.Vector2(256,256),this.clearColor=new f.Color(0,0,0),this.renderTargetsHorizontal=[],this.renderTargetsVertical=[],this.nMips=5;let l=Math.round(this.resolution.x/2),c=Math.round(this.resolution.y/2);this.renderTargetBright=new f.WebGLRenderTarget(l,c,{type:f.HalfFloatType}),this.renderTargetBright.texture.name="UnrealBloomPass.bright",this.renderTargetBright.texture.generateMipmaps=!1;for(let _=0;_<this.nMips;_++){const v=new f.WebGLRenderTarget(l,c,{type:f.HalfFloatType});v.texture.name="UnrealBloomPass.h"+_,v.texture.generateMipmaps=!1,this.renderTargetsHorizontal.push(v);const M=new f.WebGLRenderTarget(l,c,{type:f.HalfFloatType});M.texture.name="UnrealBloomPass.v"+_,M.texture.generateMipmaps=!1,this.renderTargetsVertical.push(M),l=Math.round(l/2),c=Math.round(c/2)}const u=Hd;this.highPassUniforms=f.UniformsUtils.clone(u.uniforms),this.highPassUniforms.luminosityThreshold.value=o,this.highPassUniforms.smoothWidth.value=.01,this.materialHighPassFilter=new f.ShaderMaterial({uniforms:this.highPassUniforms,vertexShader:u.vertexShader,fragmentShader:u.fragmentShader,defines:{}}),this.separableBlurMaterials=[];const d=[3,5,7,9,11];l=Math.round(this.resolution.x/2),c=Math.round(this.resolution.y/2);for(let _=0;_<this.nMips;_++)this.separableBlurMaterials.push(this.getSeperableBlurMaterial(d[_])),this.separableBlurMaterials[_].uniforms.texSize.value=new f.Vector2(l,c),l=Math.round(l/2),c=Math.round(c/2);this.compositeMaterial=this.getCompositeMaterial(this.nMips),this.compositeMaterial.uniforms.blurTexture1.value=this.renderTargetsVertical[0].texture,this.compositeMaterial.uniforms.blurTexture2.value=this.renderTargetsVertical[1].texture,this.compositeMaterial.uniforms.blurTexture3.value=this.renderTargetsVertical[2].texture,this.compositeMaterial.uniforms.blurTexture4.value=this.renderTargetsVertical[3].texture,this.compositeMaterial.uniforms.blurTexture5.value=this.renderTargetsVertical[4].texture,this.compositeMaterial.uniforms.bloomStrength.value=r,this.compositeMaterial.uniforms.bloomRadius.value=.1,this.compositeMaterial.needsUpdate=!0;const m=[1,.8,.6,.4,.2];this.compositeMaterial.uniforms.bloomFactors.value=m,this.bloomTintColors=[new f.Vector3(1,1,1),new f.Vector3(1,1,1),new f.Vector3(1,1,1),new f.Vector3(1,1,1),new f.Vector3(1,1,1)],this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors;const p=To;this.copyUniforms=f.UniformsUtils.clone(p.uniforms),this.copyUniforms.opacity.value=1,this.materialCopy=new f.ShaderMaterial({uniforms:this.copyUniforms,vertexShader:p.vertexShader,fragmentShader:p.fragmentShader,blending:f.AdditiveBlending,depthTest:!1,depthWrite:!1,transparent:!0}),this.enabled=!0,this.needsSwap=!1,this._oldClearColor=new f.Color,this.oldClearAlpha=1,this.basic=new f.MeshBasicMaterial,this.fsQuad=new jl(null)}dispose(){for(let t=0;t<this.renderTargetsHorizontal.length;t++)this.renderTargetsHorizontal[t].dispose();for(let t=0;t<this.renderTargetsVertical.length;t++)this.renderTargetsVertical[t].dispose();this.renderTargetBright.dispose();for(let t=0;t<this.separableBlurMaterials.length;t++)this.separableBlurMaterials[t].dispose();this.compositeMaterial.dispose(),this.materialCopy.dispose(),this.basic.dispose(),this.fsQuad.dispose()}setSize(t,r){let i=Math.round(t/2),o=Math.round(r/2);this.renderTargetBright.setSize(i,o);for(let l=0;l<this.nMips;l++)this.renderTargetsHorizontal[l].setSize(i,o),this.renderTargetsVertical[l].setSize(i,o),this.separableBlurMaterials[l].uniforms.texSize.value=new f.Vector2(i,o),i=Math.round(i/2),o=Math.round(o/2)}render(t,r,i,o,l){t.getClearColor(this._oldClearColor),this.oldClearAlpha=t.getClearAlpha();const c=t.autoClear;t.autoClear=!1,t.setClearColor(this.clearColor,0),l&&t.state.buffers.stencil.setTest(!1),this.renderToScreen&&(this.fsQuad.material=this.basic,this.basic.map=i.texture,t.setRenderTarget(null),t.clear(),this.fsQuad.render(t)),this.highPassUniforms.tDiffuse.value=i.texture,this.highPassUniforms.luminosityThreshold.value=this.threshold,this.fsQuad.material=this.materialHighPassFilter,t.setRenderTarget(this.renderTargetBright),t.clear(),this.fsQuad.render(t);let u=this.renderTargetBright;for(let d=0;d<this.nMips;d++)this.fsQuad.material=this.separableBlurMaterials[d],this.separableBlurMaterials[d].uniforms.colorTexture.value=u.texture,this.separableBlurMaterials[d].uniforms.direction.value=s.BlurDirectionX,t.setRenderTarget(this.renderTargetsHorizontal[d]),t.clear(),this.fsQuad.render(t),this.separableBlurMaterials[d].uniforms.colorTexture.value=this.renderTargetsHorizontal[d].texture,this.separableBlurMaterials[d].uniforms.direction.value=s.BlurDirectionY,t.setRenderTarget(this.renderTargetsVertical[d]),t.clear(),this.fsQuad.render(t),u=this.renderTargetsVertical[d];this.fsQuad.material=this.compositeMaterial,this.compositeMaterial.uniforms.bloomStrength.value=this.strength,this.compositeMaterial.uniforms.bloomRadius.value=this.radius,this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors,t.setRenderTarget(this.renderTargetsHorizontal[0]),t.clear(),this.fsQuad.render(t),this.fsQuad.material=this.materialCopy,this.copyUniforms.tDiffuse.value=this.renderTargetsHorizontal[0].texture,l&&t.state.buffers.stencil.setTest(!0),this.renderToScreen?(t.setRenderTarget(null),this.fsQuad.render(t)):(t.setRenderTarget(i),this.fsQuad.render(t)),t.setClearColor(this._oldClearColor,this.oldClearAlpha),t.autoClear=c}getSeperableBlurMaterial(t){return new f.ShaderMaterial({defines:{KERNEL_RADIUS:t,SIGMA:t},uniforms:{colorTexture:{value:null},texSize:{value:new f.Vector2(.5,.5)},direction:{value:new f.Vector2(.5,.5)}},vertexShader:`varying vec2 vUv;
				void main() {
					vUv = uv;
					gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
				}`,fragmentShader:`#include <common>
				varying vec2 vUv;
				uniform sampler2D colorTexture;
				uniform vec2 texSize;
				uniform vec2 direction;

				float gaussianPdf(in float x, in float sigma) {
					return 0.39894 * exp( -0.5 * x * x/( sigma * sigma))/sigma;
				}
				void main() {
					vec2 invSize = 1.0 / texSize;
					float fSigma = float(SIGMA);
					float weightSum = gaussianPdf(0.0, fSigma);
					vec3 diffuseSum = texture2D( colorTexture, vUv).rgb * weightSum;
					for( int i = 1; i < KERNEL_RADIUS; i ++ ) {
						float x = float(i);
						float w = gaussianPdf(x, fSigma);
						vec2 uvOffset = direction * invSize * x;
						vec3 sample1 = texture2D( colorTexture, vUv + uvOffset).rgb;
						vec3 sample2 = texture2D( colorTexture, vUv - uvOffset).rgb;
						diffuseSum += (sample1 + sample2) * w;
						weightSum += 2.0 * w;
					}
					gl_FragColor = vec4(diffuseSum/weightSum, 1.0);
				}`})}getCompositeMaterial(t){return new f.ShaderMaterial({defines:{NUM_MIPS:t},uniforms:{blurTexture1:{value:null},blurTexture2:{value:null},blurTexture3:{value:null},blurTexture4:{value:null},blurTexture5:{value:null},bloomStrength:{value:1},bloomFactors:{value:null},bloomTintColors:{value:null},bloomRadius:{value:0}},vertexShader:`varying vec2 vUv;
				void main() {
					vUv = uv;
					gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
				}`,fragmentShader:`varying vec2 vUv;
				uniform sampler2D blurTexture1;
				uniform sampler2D blurTexture2;
				uniform sampler2D blurTexture3;
				uniform sampler2D blurTexture4;
				uniform sampler2D blurTexture5;
				uniform float bloomStrength;
				uniform float bloomRadius;
				uniform float bloomFactors[NUM_MIPS];
				uniform vec3 bloomTintColors[NUM_MIPS];

				float lerpBloomFactor(const in float factor) {
					float mirrorFactor = 1.2 - factor;
					return mix(factor, mirrorFactor, bloomRadius);
				}

				void main() {
					gl_FragColor = bloomStrength * ( lerpBloomFactor(bloomFactors[0]) * vec4(bloomTintColors[0], 1.0) * texture2D(blurTexture1, vUv) +
						lerpBloomFactor(bloomFactors[1]) * vec4(bloomTintColors[1], 1.0) * texture2D(blurTexture2, vUv) +
						lerpBloomFactor(bloomFactors[2]) * vec4(bloomTintColors[2], 1.0) * texture2D(blurTexture3, vUv) +
						lerpBloomFactor(bloomFactors[3]) * vec4(bloomTintColors[3], 1.0) * texture2D(blurTexture4, vUv) +
						lerpBloomFactor(bloomFactors[4]) * vec4(bloomTintColors[4], 1.0) * texture2D(blurTexture5, vUv) );
				}`})}};let e=s;return Yl(e,"BlurDirectionX",new f.Vector2(1,0)),Yl(e,"BlurDirectionY",new f.Vector2(0,1)),e})();var ip=Object.defineProperty,np=(s,e,t)=>e in s?ip(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Do=(s,e,t)=>(np(s,typeof e!="symbol"?e+"":e,t),t);class Zl extends _n{constructor(e,t){super(),Do(this,"scene"),Do(this,"camera"),Do(this,"inverse"),this.scene=e,this.camera=t,this.clear=!0,this.needsSwap=!1,this.inverse=!1}render(e,t,r){const i=e.getContext(),o=e.state;o.buffers.color.setMask(!1),o.buffers.depth.setMask(!1),o.buffers.color.setLocked(!0),o.buffers.depth.setLocked(!0);let l,c;this.inverse?(l=0,c=1):(l=1,c=0),o.buffers.stencil.setTest(!0),o.buffers.stencil.setOp(i.REPLACE,i.REPLACE,i.REPLACE),o.buffers.stencil.setFunc(i.ALWAYS,l,4294967295),o.buffers.stencil.setClear(c),o.buffers.stencil.setLocked(!0),e.setRenderTarget(r),this.clear&&e.clear(),e.render(this.scene,this.camera),e.setRenderTarget(t),this.clear&&e.clear(),e.render(this.scene,this.camera),o.buffers.color.setLocked(!1),o.buffers.depth.setLocked(!1),o.buffers.stencil.setLocked(!1),o.buffers.stencil.setFunc(i.EQUAL,1,4294967295),o.buffers.stencil.setOp(i.KEEP,i.KEEP,i.KEEP),o.buffers.stencil.setLocked(!0)}}class sp extends _n{constructor(){super(),this.needsSwap=!1}render(e){e.state.buffers.stencil.setLocked(!1),e.state.buffers.stencil.setTest(!1)}}var op=Object.defineProperty,ap=(s,e,t)=>e in s?op(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ft=(s,e,t)=>(ap(s,typeof e!="symbol"?e+"":e,t),t);class lp{constructor(e,t){if(Ft(this,"renderer"),Ft(this,"_pixelRatio"),Ft(this,"_width"),Ft(this,"_height"),Ft(this,"renderTarget1"),Ft(this,"renderTarget2"),Ft(this,"writeBuffer"),Ft(this,"readBuffer"),Ft(this,"renderToScreen"),Ft(this,"passes",[]),Ft(this,"copyPass"),Ft(this,"clock"),this.renderer=e,t===void 0){const r={minFilter:f.LinearFilter,magFilter:f.LinearFilter,format:f.RGBAFormat},i=e.getSize(new f.Vector2);this._pixelRatio=e.getPixelRatio(),this._width=i.width,this._height=i.height,t=new f.WebGLRenderTarget(this._width*this._pixelRatio,this._height*this._pixelRatio,r),t.texture.name="EffectComposer.rt1"}else this._pixelRatio=1,this._width=t.width,this._height=t.height;this.renderTarget1=t,this.renderTarget2=t.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.renderToScreen=!0,To===void 0&&console.error("THREE.EffectComposer relies on CopyShader"),Xl===void 0&&console.error("THREE.EffectComposer relies on ShaderPass"),this.copyPass=new Xl(To),this.copyPass.material.blending=f.NoBlending,this.clock=new f.Clock}swapBuffers(){const e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e}addPass(e){this.passes.push(e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}insertPass(e,t){this.passes.splice(t,0,e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}removePass(e){const t=this.passes.indexOf(e);t!==-1&&this.passes.splice(t,1)}isLastEnabledPass(e){for(let t=e+1;t<this.passes.length;t++)if(this.passes[t].enabled)return!1;return!0}render(e){e===void 0&&(e=this.clock.getDelta());const t=this.renderer.getRenderTarget();let r=!1;const i=this.passes.length;for(let o=0;o<i;o++){const l=this.passes[o];if(l.enabled!==!1){if(l.renderToScreen=this.renderToScreen&&this.isLastEnabledPass(o),l.render(this.renderer,this.writeBuffer,this.readBuffer,e,r),l.needsSwap){if(r){const c=this.renderer.getContext(),u=this.renderer.state.buffers.stencil;u.setFunc(c.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),u.setFunc(c.EQUAL,1,4294967295)}this.swapBuffers()}Zl!==void 0&&(l instanceof Zl?r=!0:l instanceof sp&&(r=!1))}}this.renderer.setRenderTarget(t)}reset(e){if(e===void 0){const t=this.renderer.getSize(new f.Vector2);this._pixelRatio=this.renderer.getPixelRatio(),this._width=t.width,this._height=t.height,e=this.renderTarget1.clone(),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=e,this.renderTarget2=e.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2}setSize(e,t){this._width=e,this._height=t;const r=this._width*this._pixelRatio,i=this._height*this._pixelRatio;this.renderTarget1.setSize(r,i),this.renderTarget2.setSize(r,i);for(let o=0;o<this.passes.length;o++)this.passes[o].setSize(r,i)}setPixelRatio(e){this._pixelRatio=e,this.setSize(this._width,this._height)}dispose(){this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.copyPass.dispose()}}var cp=Object.defineProperty,up=(s,e,t)=>e in s?cp(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,oi=(s,e,t)=>(up(s,typeof e!="symbol"?e+"":e,t),t);class hp extends _n{constructor(e,t,r,i,o=0){super(),oi(this,"scene"),oi(this,"camera"),oi(this,"overrideMaterial"),oi(this,"clearColor"),oi(this,"clearAlpha"),oi(this,"clearDepth",!1),oi(this,"_oldClearColor",new f.Color),this.scene=e,this.camera=t,this.overrideMaterial=r,this.clearColor=i,this.clearAlpha=o,this.clear=!0,this.needsSwap=!1}render(e,t,r){let i=e.autoClear;e.autoClear=!1;let o,l=null;this.overrideMaterial!==void 0&&(l=this.scene.overrideMaterial,this.scene.overrideMaterial=this.overrideMaterial),this.clearColor&&(e.getClearColor(this._oldClearColor),o=e.getClearAlpha(),e.setClearColor(this.clearColor,this.clearAlpha)),this.clearDepth&&e.clearDepth(),e.setRenderTarget(this.renderToScreen?null:r),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),e.render(this.scene,this.camera),this.clearColor&&e.setClearColor(this._oldClearColor,o),this.overrideMaterial!==void 0&&(this.scene.overrideMaterial=l),e.autoClear=i}}function Bi(s){if(typeof TextDecoder<"u")return new TextDecoder().decode(s);let e="";for(let t=0,r=s.length;t<r;t++)e+=String.fromCharCode(s[t]);try{return decodeURIComponent(escape(e))}catch{return e}}const ai="srgb",yr="srgb-linear",Kl=3001,fp=3e3;class dp extends f.Loader{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(t){return new yp(t)}),this.register(function(t){return new vp(t)}),this.register(function(t){return new Cp(t)}),this.register(function(t){return new Op(t)}),this.register(function(t){return new Tp(t)}),this.register(function(t){return new bp(t)}),this.register(function(t){return new xp(t)}),this.register(function(t){return new Mp(t)}),this.register(function(t){return new Sp(t)}),this.register(function(t){return new _p(t)}),this.register(function(t){return new Ap(t)}),this.register(function(t){return new wp(t)}),this.register(function(t){return new Lp(t)}),this.register(function(t){return new Pp(t)}),this.register(function(t){return new mp(t)}),this.register(function(t){return new Dp(t)}),this.register(function(t){return new Ip(t)})}load(e,t,r,i){const o=this;let l;if(this.resourcePath!=="")l=this.resourcePath;else if(this.path!==""){const d=f.LoaderUtils.extractUrlBase(e);l=f.LoaderUtils.resolveURL(d,this.path)}else l=f.LoaderUtils.extractUrlBase(e);this.manager.itemStart(e);const c=function(d){i?i(d):console.error(d),o.manager.itemError(e),o.manager.itemEnd(e)},u=new f.FileLoader(this.manager);u.setPath(this.path),u.setResponseType("arraybuffer"),u.setRequestHeader(this.requestHeader),u.setWithCredentials(this.withCredentials),u.load(e,function(d){try{o.parse(d,l,function(m){t(m),o.manager.itemEnd(e)},c)}catch(m){c(m)}},r,c)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,r,i){let o;const l={},c={};if(typeof e=="string")o=JSON.parse(e);else if(e instanceof ArrayBuffer)if(Bi(new Uint8Array(e.slice(0,4)))===ql){try{l[fe.KHR_BINARY_GLTF]=new Fp(e)}catch(m){i&&i(m);return}o=JSON.parse(l[fe.KHR_BINARY_GLTF].content)}else o=JSON.parse(Bi(new Uint8Array(e)));else o=e;if(o.asset===void 0||o.asset.version[0]<2){i&&i(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const u=new Yp(o,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});u.fileLoader.setRequestHeader(this.requestHeader);for(let d=0;d<this.pluginCallbacks.length;d++){const m=this.pluginCallbacks[d](u);m.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),c[m.name]=m,l[m.name]=!0}if(o.extensionsUsed)for(let d=0;d<o.extensionsUsed.length;++d){const m=o.extensionsUsed[d],p=o.extensionsRequired||[];switch(m){case fe.KHR_MATERIALS_UNLIT:l[m]=new gp;break;case fe.KHR_DRACO_MESH_COMPRESSION:l[m]=new Bp(o,this.dracoLoader);break;case fe.KHR_TEXTURE_TRANSFORM:l[m]=new Up;break;case fe.KHR_MESH_QUANTIZATION:l[m]=new Vp;break;default:p.indexOf(m)>=0&&c[m]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+m+'".')}}u.setExtensions(l),u.setPlugins(c),u.parse(r,i)}parseAsync(e,t){const r=this;return new Promise(function(i,o){r.parse(e,t,i,o)})}}function pp(){let s={};return{get:function(e){return s[e]},add:function(e,t){s[e]=t},remove:function(e){delete s[e]},removeAll:function(){s={}}}}const fe={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class mp{constructor(e){this.parser=e,this.name=fe.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let r=0,i=t.length;r<i;r++){const o=t[r];o.extensions&&o.extensions[this.name]&&o.extensions[this.name].light!==void 0&&e._addNodeRef(this.cache,o.extensions[this.name].light)}}_loadLight(e){const t=this.parser,r="light:"+e;let i=t.cache.get(r);if(i)return i;const o=t.json,u=((o.extensions&&o.extensions[this.name]||{}).lights||[])[e];let d;const m=new f.Color(16777215);u.color!==void 0&&m.setRGB(u.color[0],u.color[1],u.color[2],yr);const p=u.range!==void 0?u.range:0;switch(u.type){case"directional":d=new f.DirectionalLight(m),d.target.position.set(0,0,-1),d.add(d.target);break;case"point":d=new f.PointLight(m),d.distance=p;break;case"spot":d=new f.SpotLight(m),d.distance=p,u.spot=u.spot||{},u.spot.innerConeAngle=u.spot.innerConeAngle!==void 0?u.spot.innerConeAngle:0,u.spot.outerConeAngle=u.spot.outerConeAngle!==void 0?u.spot.outerConeAngle:Math.PI/4,d.angle=u.spot.outerConeAngle,d.penumbra=1-u.spot.innerConeAngle/u.spot.outerConeAngle,d.target.position.set(0,0,-1),d.add(d.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+u.type)}return d.position.set(0,0,0),d.decay=2,vr(d,u),u.intensity!==void 0&&(d.intensity=u.intensity),d.name=t.createUniqueName(u.name||"light_"+e),i=Promise.resolve(d),t.cache.add(r,i),i}getDependency(e,t){if(e==="light")return this._loadLight(t)}createNodeAttachment(e){const t=this,r=this.parser,o=r.json.nodes[e],c=(o.extensions&&o.extensions[this.name]||{}).light;return c===void 0?null:this._loadLight(c).then(function(u){return r._getNodeRef(t.cache,c,u)})}}class gp{constructor(){this.name=fe.KHR_MATERIALS_UNLIT}getMaterialType(){return f.MeshBasicMaterial}extendParams(e,t,r){const i=[];e.color=new f.Color(1,1,1),e.opacity=1;const o=t.pbrMetallicRoughness;if(o){if(Array.isArray(o.baseColorFactor)){const l=o.baseColorFactor;e.color.setRGB(l[0],l[1],l[2],yr),e.opacity=l[3]}o.baseColorTexture!==void 0&&i.push(r.assignTexture(e,"map",o.baseColorTexture,ai))}return Promise.all(i)}}class _p{constructor(e){this.parser=e,this.name=fe.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const i=this.parser.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=i.extensions[this.name].emissiveStrength;return o!==void 0&&(t.emissiveIntensity=o),Promise.resolve()}}class yp{constructor(e){this.parser=e,this.name=fe.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:f.MeshPhysicalMaterial}extendMaterialParams(e,t){const r=this.parser,i=r.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=[],l=i.extensions[this.name];if(l.clearcoatFactor!==void 0&&(t.clearcoat=l.clearcoatFactor),l.clearcoatTexture!==void 0&&o.push(r.assignTexture(t,"clearcoatMap",l.clearcoatTexture)),l.clearcoatRoughnessFactor!==void 0&&(t.clearcoatRoughness=l.clearcoatRoughnessFactor),l.clearcoatRoughnessTexture!==void 0&&o.push(r.assignTexture(t,"clearcoatRoughnessMap",l.clearcoatRoughnessTexture)),l.clearcoatNormalTexture!==void 0&&(o.push(r.assignTexture(t,"clearcoatNormalMap",l.clearcoatNormalTexture)),l.clearcoatNormalTexture.scale!==void 0)){const c=l.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new f.Vector2(c,c)}return Promise.all(o)}}class vp{constructor(e){this.parser=e,this.name=fe.KHR_MATERIALS_DISPERSION}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:f.MeshPhysicalMaterial}extendMaterialParams(e,t){const i=this.parser.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=i.extensions[this.name];return t.dispersion=o.dispersion!==void 0?o.dispersion:0,Promise.resolve()}}class wp{constructor(e){this.parser=e,this.name=fe.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:f.MeshPhysicalMaterial}extendMaterialParams(e,t){const r=this.parser,i=r.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=[],l=i.extensions[this.name];return l.iridescenceFactor!==void 0&&(t.iridescence=l.iridescenceFactor),l.iridescenceTexture!==void 0&&o.push(r.assignTexture(t,"iridescenceMap",l.iridescenceTexture)),l.iridescenceIor!==void 0&&(t.iridescenceIOR=l.iridescenceIor),t.iridescenceThicknessRange===void 0&&(t.iridescenceThicknessRange=[100,400]),l.iridescenceThicknessMinimum!==void 0&&(t.iridescenceThicknessRange[0]=l.iridescenceThicknessMinimum),l.iridescenceThicknessMaximum!==void 0&&(t.iridescenceThicknessRange[1]=l.iridescenceThicknessMaximum),l.iridescenceThicknessTexture!==void 0&&o.push(r.assignTexture(t,"iridescenceThicknessMap",l.iridescenceThicknessTexture)),Promise.all(o)}}class bp{constructor(e){this.parser=e,this.name=fe.KHR_MATERIALS_SHEEN}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:f.MeshPhysicalMaterial}extendMaterialParams(e,t){const r=this.parser,i=r.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=[];t.sheenColor=new f.Color(0,0,0),t.sheenRoughness=0,t.sheen=1;const l=i.extensions[this.name];if(l.sheenColorFactor!==void 0){const c=l.sheenColorFactor;t.sheenColor.setRGB(c[0],c[1],c[2],yr)}return l.sheenRoughnessFactor!==void 0&&(t.sheenRoughness=l.sheenRoughnessFactor),l.sheenColorTexture!==void 0&&o.push(r.assignTexture(t,"sheenColorMap",l.sheenColorTexture,ai)),l.sheenRoughnessTexture!==void 0&&o.push(r.assignTexture(t,"sheenRoughnessMap",l.sheenRoughnessTexture)),Promise.all(o)}}class xp{constructor(e){this.parser=e,this.name=fe.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:f.MeshPhysicalMaterial}extendMaterialParams(e,t){const r=this.parser,i=r.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=[],l=i.extensions[this.name];return l.transmissionFactor!==void 0&&(t.transmission=l.transmissionFactor),l.transmissionTexture!==void 0&&o.push(r.assignTexture(t,"transmissionMap",l.transmissionTexture)),Promise.all(o)}}class Mp{constructor(e){this.parser=e,this.name=fe.KHR_MATERIALS_VOLUME}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:f.MeshPhysicalMaterial}extendMaterialParams(e,t){const r=this.parser,i=r.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=[],l=i.extensions[this.name];t.thickness=l.thicknessFactor!==void 0?l.thicknessFactor:0,l.thicknessTexture!==void 0&&o.push(r.assignTexture(t,"thicknessMap",l.thicknessTexture)),t.attenuationDistance=l.attenuationDistance||1/0;const c=l.attenuationColor||[1,1,1];return t.attenuationColor=new f.Color().setRGB(c[0],c[1],c[2],yr),Promise.all(o)}}class Sp{constructor(e){this.parser=e,this.name=fe.KHR_MATERIALS_IOR}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:f.MeshPhysicalMaterial}extendMaterialParams(e,t){const i=this.parser.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=i.extensions[this.name];return t.ior=o.ior!==void 0?o.ior:1.5,Promise.resolve()}}class Ap{constructor(e){this.parser=e,this.name=fe.KHR_MATERIALS_SPECULAR}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:f.MeshPhysicalMaterial}extendMaterialParams(e,t){const r=this.parser,i=r.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=[],l=i.extensions[this.name];t.specularIntensity=l.specularFactor!==void 0?l.specularFactor:1,l.specularTexture!==void 0&&o.push(r.assignTexture(t,"specularIntensityMap",l.specularTexture));const c=l.specularColorFactor||[1,1,1];return t.specularColor=new f.Color().setRGB(c[0],c[1],c[2],yr),l.specularColorTexture!==void 0&&o.push(r.assignTexture(t,"specularColorMap",l.specularColorTexture,ai)),Promise.all(o)}}class Pp{constructor(e){this.parser=e,this.name=fe.EXT_MATERIALS_BUMP}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:f.MeshPhysicalMaterial}extendMaterialParams(e,t){const r=this.parser,i=r.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=[],l=i.extensions[this.name];return t.bumpScale=l.bumpFactor!==void 0?l.bumpFactor:1,l.bumpTexture!==void 0&&o.push(r.assignTexture(t,"bumpMap",l.bumpTexture)),Promise.all(o)}}class Lp{constructor(e){this.parser=e,this.name=fe.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:f.MeshPhysicalMaterial}extendMaterialParams(e,t){const r=this.parser,i=r.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=[],l=i.extensions[this.name];return l.anisotropyStrength!==void 0&&(t.anisotropy=l.anisotropyStrength),l.anisotropyRotation!==void 0&&(t.anisotropyRotation=l.anisotropyRotation),l.anisotropyTexture!==void 0&&o.push(r.assignTexture(t,"anisotropyMap",l.anisotropyTexture)),Promise.all(o)}}class Cp{constructor(e){this.parser=e,this.name=fe.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,r=t.json,i=r.textures[e];if(!i.extensions||!i.extensions[this.name])return null;const o=i.extensions[this.name],l=t.options.ktx2Loader;if(!l){if(r.extensionsRequired&&r.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,o.source,l)}}class Op{constructor(e){this.parser=e,this.name=fe.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,r=this.parser,i=r.json,o=i.textures[e];if(!o.extensions||!o.extensions[t])return null;const l=o.extensions[t],c=i.images[l.source];let u=r.textureLoader;if(c.uri){const d=r.options.manager.getHandler(c.uri);d!==null&&(u=d)}return this.detectSupport().then(function(d){if(d)return r.loadTextureImage(e,l.source,u);if(i.extensionsRequired&&i.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return r.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class Tp{constructor(e){this.parser=e,this.name=fe.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,r=this.parser,i=r.json,o=i.textures[e];if(!o.extensions||!o.extensions[t])return null;const l=o.extensions[t],c=i.images[l.source];let u=r.textureLoader;if(c.uri){const d=r.options.manager.getHandler(c.uri);d!==null&&(u=d)}return this.detectSupport().then(function(d){if(d)return r.loadTextureImage(e,l.source,u);if(i.extensionsRequired&&i.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return r.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class Dp{constructor(e){this.name=fe.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,r=t.bufferViews[e];if(r.extensions&&r.extensions[this.name]){const i=r.extensions[this.name],o=this.parser.getDependency("buffer",i.buffer),l=this.parser.options.meshoptDecoder;if(!l||!l.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return o.then(function(c){const u=i.byteOffset||0,d=i.byteLength||0,m=i.count,p=i.byteStride,_=new Uint8Array(c,u,d);return l.decodeGltfBufferAsync?l.decodeGltfBufferAsync(m,p,_,i.mode,i.filter).then(function(v){return v.buffer}):l.ready.then(function(){const v=new ArrayBuffer(m*p);return l.decodeGltfBuffer(new Uint8Array(v),m,p,_,i.mode,i.filter),v})})}else return null}}class Ip{constructor(e){this.name=fe.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,r=t.nodes[e];if(!r.extensions||!r.extensions[this.name]||r.mesh===void 0)return null;const i=t.meshes[r.mesh];for(const d of i.primitives)if(d.mode!==Bt.TRIANGLES&&d.mode!==Bt.TRIANGLE_STRIP&&d.mode!==Bt.TRIANGLE_FAN&&d.mode!==void 0)return null;const l=r.extensions[this.name].attributes,c=[],u={};for(const d in l)c.push(this.parser.getDependency("accessor",l[d]).then(m=>(u[d]=m,u[d])));return c.length<1?null:(c.push(this.parser.createNodeMesh(e)),Promise.all(c).then(d=>{const m=d.pop(),p=m.isGroup?m.children:[m],_=d[0].count,v=[];for(const M of p){const S=new f.Matrix4,x=new f.Vector3,O=new f.Quaternion,P=new f.Vector3(1,1,1),L=new f.InstancedMesh(M.geometry,M.material,_);for(let F=0;F<_;F++)u.TRANSLATION&&x.fromBufferAttribute(u.TRANSLATION,F),u.ROTATION&&O.fromBufferAttribute(u.ROTATION,F),u.SCALE&&P.fromBufferAttribute(u.SCALE,F),L.setMatrixAt(F,S.compose(x,O,P));for(const F in u)if(F==="_COLOR_0"){const z=u[F];L.instanceColor=new f.InstancedBufferAttribute(z.array,z.itemSize,z.normalized)}else F!=="TRANSLATION"&&F!=="ROTATION"&&F!=="SCALE"&&M.geometry.setAttribute(F,u[F]);f.Object3D.prototype.copy.call(L,M),this.parser.assignFinalMaterial(L),v.push(L)}return m.isGroup?(m.clear(),m.add(...v),m):v[0]}))}}const ql="glTF",yn=12,Ql={JSON:1313821514,BIN:5130562};class Fp{constructor(e){this.name=fe.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,yn);if(this.header={magic:Bi(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==ql)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const r=this.header.length-yn,i=new DataView(e,yn);let o=0;for(;o<r;){const l=i.getUint32(o,!0);o+=4;const c=i.getUint32(o,!0);if(o+=4,c===Ql.JSON){const u=new Uint8Array(e,yn+o,l);this.content=Bi(u)}else if(c===Ql.BIN){const u=yn+o;this.body=e.slice(u,u+l)}o+=l}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class Bp{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=fe.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const r=this.json,i=this.dracoLoader,o=e.extensions[this.name].bufferView,l=e.extensions[this.name].attributes,c={},u={},d={};for(const m in l){const p=Fo[m]||m.toLowerCase();c[p]=l[m]}for(const m in e.attributes){const p=Fo[m]||m.toLowerCase();if(l[m]!==void 0){const _=r.accessors[e.attributes[m]],v=Ui[_.componentType];d[p]=v.name,u[p]=_.normalized===!0}}return t.getDependency("bufferView",o).then(function(m){return new Promise(function(p,_){i.decodeDracoFile(m,function(v){for(const M in v.attributes){const S=v.attributes[M],x=u[M];x!==void 0&&(S.normalized=x)}p(v)},c,d,yr,_)})})}}class Up{constructor(){this.name=fe.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(t.texCoord===void 0||t.texCoord===e.channel)&&t.offset===void 0&&t.rotation===void 0&&t.scale===void 0||(e=e.clone(),t.texCoord!==void 0&&(e.channel=t.texCoord),t.offset!==void 0&&e.offset.fromArray(t.offset),t.rotation!==void 0&&(e.rotation=t.rotation),t.scale!==void 0&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class Vp{constructor(){this.name=fe.KHR_MESH_QUANTIZATION}}class El extends f.Interpolant{constructor(e,t,r,i){super(e,t,r,i)}copySampleValue_(e){const t=this.resultBuffer,r=this.sampleValues,i=this.valueSize,o=e*i*3+i;for(let l=0;l!==i;l++)t[l]=r[o+l];return t}interpolate_(e,t,r,i){const o=this.resultBuffer,l=this.sampleValues,c=this.valueSize,u=c*2,d=c*3,m=i-t,p=(r-t)/m,_=p*p,v=_*p,M=e*d,S=M-d,x=-2*v+3*_,O=v-_,P=1-x,L=O-_+p;for(let F=0;F!==c;F++){const z=l[S+F+c],j=l[S+F+u]*m,G=l[M+F+c],U=l[M+F]*m;o[F]=P*z+L*j+x*G+O*U}return o}}const kp=new f.Quaternion;class zp extends El{interpolate_(e,t,r,i){const o=super.interpolate_(e,t,r,i);return kp.fromArray(o).normalize().toArray(o),o}}const Bt={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},Ui={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Jl={9728:f.NearestFilter,9729:f.LinearFilter,9984:f.NearestMipmapNearestFilter,9985:f.LinearMipmapNearestFilter,9986:f.NearestMipmapLinearFilter,9987:f.LinearMipmapLinearFilter},Hl={33071:f.ClampToEdgeWrapping,33648:f.MirroredRepeatWrapping,10497:f.RepeatWrapping},Io={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Fo={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",...rs>=152?{TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3"}:{TEXCOORD_0:"uv",TEXCOORD_1:"uv2"},COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},Ur={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},Np={CUBICSPLINE:void 0,LINEAR:f.InterpolateLinear,STEP:f.InterpolateDiscrete},Bo={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function Rp(s){return s.DefaultMaterial===void 0&&(s.DefaultMaterial=new f.MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:f.FrontSide})),s.DefaultMaterial}function li(s,e,t){for(const r in t.extensions)s[r]===void 0&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[r]=t.extensions[r])}function vr(s,e){e.extras!==void 0&&(typeof e.extras=="object"?Object.assign(s.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function Wp(s,e,t){let r=!1,i=!1,o=!1;for(let d=0,m=e.length;d<m;d++){const p=e[d];if(p.POSITION!==void 0&&(r=!0),p.NORMAL!==void 0&&(i=!0),p.COLOR_0!==void 0&&(o=!0),r&&i&&o)break}if(!r&&!i&&!o)return Promise.resolve(s);const l=[],c=[],u=[];for(let d=0,m=e.length;d<m;d++){const p=e[d];if(r){const _=p.POSITION!==void 0?t.getDependency("accessor",p.POSITION):s.attributes.position;l.push(_)}if(i){const _=p.NORMAL!==void 0?t.getDependency("accessor",p.NORMAL):s.attributes.normal;c.push(_)}if(o){const _=p.COLOR_0!==void 0?t.getDependency("accessor",p.COLOR_0):s.attributes.color;u.push(_)}}return Promise.all([Promise.all(l),Promise.all(c),Promise.all(u)]).then(function(d){const m=d[0],p=d[1],_=d[2];return r&&(s.morphAttributes.position=m),i&&(s.morphAttributes.normal=p),o&&(s.morphAttributes.color=_),s.morphTargetsRelative=!0,s})}function Gp(s,e){if(s.updateMorphTargets(),e.weights!==void 0)for(let t=0,r=e.weights.length;t<r;t++)s.morphTargetInfluences[t]=e.weights[t];if(e.extras&&Array.isArray(e.extras.targetNames)){const t=e.extras.targetNames;if(s.morphTargetInfluences.length===t.length){s.morphTargetDictionary={};for(let r=0,i=t.length;r<i;r++)s.morphTargetDictionary[t[r]]=r}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function $p(s){let e;const t=s.extensions&&s.extensions[fe.KHR_DRACO_MESH_COMPRESSION];if(t?e="draco:"+t.bufferView+":"+t.indices+":"+Uo(t.attributes):e=s.indices+":"+Uo(s.attributes)+":"+s.mode,s.targets!==void 0)for(let r=0,i=s.targets.length;r<i;r++)e+=":"+Uo(s.targets[r]);return e}function Uo(s){let e="";const t=Object.keys(s).sort();for(let r=0,i=t.length;r<i;r++)e+=t[r]+":"+s[t[r]]+";";return e}function Vo(s){switch(s){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function jp(s){return s.search(/\.jpe?g($|\?)/i)>0||s.search(/^data\:image\/jpeg/)===0?"image/jpeg":s.search(/\.webp($|\?)/i)>0||s.search(/^data\:image\/webp/)===0?"image/webp":"image/png"}const Xp=new f.Matrix4;class Yp{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new pp,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let r=!1,i=!1,o=-1;typeof navigator<"u"&&typeof navigator.userAgent<"u"&&(r=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)===!0,i=navigator.userAgent.indexOf("Firefox")>-1,o=i?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),typeof createImageBitmap>"u"||r||i&&o<98?this.textureLoader=new f.TextureLoader(this.options.manager):this.textureLoader=new f.ImageBitmapLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new f.FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const r=this,i=this.json,o=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(l){return l._markDefs&&l._markDefs()}),Promise.all(this._invokeAll(function(l){return l.beforeRoot&&l.beforeRoot()})).then(function(){return Promise.all([r.getDependencies("scene"),r.getDependencies("animation"),r.getDependencies("camera")])}).then(function(l){const c={scene:l[0][i.scene||0],scenes:l[0],animations:l[1],cameras:l[2],asset:i.asset,parser:r,userData:{}};return li(o,c,i),vr(c,i),Promise.all(r._invokeAll(function(u){return u.afterRoot&&u.afterRoot(c)})).then(function(){for(const u of c.scenes)u.updateMatrixWorld();e(c)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],r=this.json.meshes||[];for(let i=0,o=t.length;i<o;i++){const l=t[i].joints;for(let c=0,u=l.length;c<u;c++)e[l[c]].isBone=!0}for(let i=0,o=e.length;i<o;i++){const l=e[i];l.mesh!==void 0&&(this._addNodeRef(this.meshCache,l.mesh),l.skin!==void 0&&(r[l.mesh].isSkinnedMesh=!0)),l.camera!==void 0&&this._addNodeRef(this.cameraCache,l.camera)}}_addNodeRef(e,t){t!==void 0&&(e.refs[t]===void 0&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,r){if(e.refs[t]<=1)return r;const i=r.clone(),o=(l,c)=>{const u=this.associations.get(l);u!=null&&this.associations.set(c,u);for(const[d,m]of l.children.entries())o(m,c.children[d])};return o(r,i),i.name+="_instance_"+e.uses[t]++,i}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let r=0;r<t.length;r++){const i=e(t[r]);if(i)return i}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const r=[];for(let i=0;i<t.length;i++){const o=e(t[i]);o&&r.push(o)}return r}getDependency(e,t){const r=e+":"+t;let i=this.cache.get(r);if(!i){switch(e){case"scene":i=this.loadScene(t);break;case"node":i=this._invokeOne(function(o){return o.loadNode&&o.loadNode(t)});break;case"mesh":i=this._invokeOne(function(o){return o.loadMesh&&o.loadMesh(t)});break;case"accessor":i=this.loadAccessor(t);break;case"bufferView":i=this._invokeOne(function(o){return o.loadBufferView&&o.loadBufferView(t)});break;case"buffer":i=this.loadBuffer(t);break;case"material":i=this._invokeOne(function(o){return o.loadMaterial&&o.loadMaterial(t)});break;case"texture":i=this._invokeOne(function(o){return o.loadTexture&&o.loadTexture(t)});break;case"skin":i=this.loadSkin(t);break;case"animation":i=this._invokeOne(function(o){return o.loadAnimation&&o.loadAnimation(t)});break;case"camera":i=this.loadCamera(t);break;default:if(i=this._invokeOne(function(o){return o!=this&&o.getDependency&&o.getDependency(e,t)}),!i)throw new Error("Unknown type: "+e);break}this.cache.add(r,i)}return i}getDependencies(e){let t=this.cache.get(e);if(!t){const r=this,i=this.json[e+(e==="mesh"?"es":"s")]||[];t=Promise.all(i.map(function(o,l){return r.getDependency(e,l)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],r=this.fileLoader;if(t.type&&t.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(t.uri===void 0&&e===0)return Promise.resolve(this.extensions[fe.KHR_BINARY_GLTF].body);const i=this.options;return new Promise(function(o,l){r.load(f.LoaderUtils.resolveURL(t.uri,i.path),o,void 0,function(){l(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(r){const i=t.byteLength||0,o=t.byteOffset||0;return r.slice(o,o+i)})}loadAccessor(e){const t=this,r=this.json,i=this.json.accessors[e];if(i.bufferView===void 0&&i.sparse===void 0){const l=Io[i.type],c=Ui[i.componentType],u=i.normalized===!0,d=new c(i.count*l);return Promise.resolve(new f.BufferAttribute(d,l,u))}const o=[];return i.bufferView!==void 0?o.push(this.getDependency("bufferView",i.bufferView)):o.push(null),i.sparse!==void 0&&(o.push(this.getDependency("bufferView",i.sparse.indices.bufferView)),o.push(this.getDependency("bufferView",i.sparse.values.bufferView))),Promise.all(o).then(function(l){const c=l[0],u=Io[i.type],d=Ui[i.componentType],m=d.BYTES_PER_ELEMENT,p=m*u,_=i.byteOffset||0,v=i.bufferView!==void 0?r.bufferViews[i.bufferView].byteStride:void 0,M=i.normalized===!0;let S,x;if(v&&v!==p){const O=Math.floor(_/v),P="InterleavedBuffer:"+i.bufferView+":"+i.componentType+":"+O+":"+i.count;let L=t.cache.get(P);L||(S=new d(c,O*v,i.count*v/m),L=new f.InterleavedBuffer(S,v/m),t.cache.add(P,L)),x=new f.InterleavedBufferAttribute(L,u,_%v/m,M)}else c===null?S=new d(i.count*u):S=new d(c,_,i.count*u),x=new f.BufferAttribute(S,u,M);if(i.sparse!==void 0){const O=Io.SCALAR,P=Ui[i.sparse.indices.componentType],L=i.sparse.indices.byteOffset||0,F=i.sparse.values.byteOffset||0,z=new P(l[1],L,i.sparse.count*O),j=new d(l[2],F,i.sparse.count*u);c!==null&&(x=new f.BufferAttribute(x.array.slice(),x.itemSize,x.normalized));for(let G=0,U=z.length;G<U;G++){const X=z[G];if(x.setX(X,j[G*u]),u>=2&&x.setY(X,j[G*u+1]),u>=3&&x.setZ(X,j[G*u+2]),u>=4&&x.setW(X,j[G*u+3]),u>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return x})}loadTexture(e){const t=this.json,r=this.options,o=t.textures[e].source,l=t.images[o];let c=this.textureLoader;if(l.uri){const u=r.manager.getHandler(l.uri);u!==null&&(c=u)}return this.loadTextureImage(e,o,c)}loadTextureImage(e,t,r){const i=this,o=this.json,l=o.textures[e],c=o.images[t],u=(c.uri||c.bufferView)+":"+l.sampler;if(this.textureCache[u])return this.textureCache[u];const d=this.loadImageSource(t,r).then(function(m){m.flipY=!1,m.name=l.name||c.name||"",m.name===""&&typeof c.uri=="string"&&c.uri.startsWith("data:image/")===!1&&(m.name=c.uri);const _=(o.samplers||{})[l.sampler]||{};return m.magFilter=Jl[_.magFilter]||f.LinearFilter,m.minFilter=Jl[_.minFilter]||f.LinearMipmapLinearFilter,m.wrapS=Hl[_.wrapS]||f.RepeatWrapping,m.wrapT=Hl[_.wrapT]||f.RepeatWrapping,i.associations.set(m,{textures:e}),m}).catch(function(){return null});return this.textureCache[u]=d,d}loadImageSource(e,t){const r=this,i=this.json,o=this.options;if(this.sourceCache[e]!==void 0)return this.sourceCache[e].then(p=>p.clone());const l=i.images[e],c=self.URL||self.webkitURL;let u=l.uri||"",d=!1;if(l.bufferView!==void 0)u=r.getDependency("bufferView",l.bufferView).then(function(p){d=!0;const _=new Blob([p],{type:l.mimeType});return u=c.createObjectURL(_),u});else if(l.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const m=Promise.resolve(u).then(function(p){return new Promise(function(_,v){let M=_;t.isImageBitmapLoader===!0&&(M=function(S){const x=new f.Texture(S);x.needsUpdate=!0,_(x)}),t.load(f.LoaderUtils.resolveURL(p,o.path),M,void 0,v)})}).then(function(p){return d===!0&&c.revokeObjectURL(u),vr(p,l),p.userData.mimeType=l.mimeType||jp(l.uri),p}).catch(function(p){throw console.error("THREE.GLTFLoader: Couldn't load texture",u),p});return this.sourceCache[e]=m,m}assignTexture(e,t,r,i){const o=this;return this.getDependency("texture",r.index).then(function(l){if(!l)return null;if(r.texCoord!==void 0&&r.texCoord>0&&(l=l.clone(),l.channel=r.texCoord),o.extensions[fe.KHR_TEXTURE_TRANSFORM]){const c=r.extensions!==void 0?r.extensions[fe.KHR_TEXTURE_TRANSFORM]:void 0;if(c){const u=o.associations.get(l);l=o.extensions[fe.KHR_TEXTURE_TRANSFORM].extendTexture(l,c),o.associations.set(l,u)}}return i!==void 0&&(typeof i=="number"&&(i=i===Kl?ai:yr),"colorSpace"in l?l.colorSpace=i:l.encoding=i===ai?Kl:fp),e[t]=l,l})}assignFinalMaterial(e){const t=e.geometry;let r=e.material;const i=t.attributes.tangent===void 0,o=t.attributes.color!==void 0,l=t.attributes.normal===void 0;if(e.isPoints){const c="PointsMaterial:"+r.uuid;let u=this.cache.get(c);u||(u=new f.PointsMaterial,f.Material.prototype.copy.call(u,r),u.color.copy(r.color),u.map=r.map,u.sizeAttenuation=!1,this.cache.add(c,u)),r=u}else if(e.isLine){const c="LineBasicMaterial:"+r.uuid;let u=this.cache.get(c);u||(u=new f.LineBasicMaterial,f.Material.prototype.copy.call(u,r),u.color.copy(r.color),u.map=r.map,this.cache.add(c,u)),r=u}if(i||o||l){let c="ClonedMaterial:"+r.uuid+":";i&&(c+="derivative-tangents:"),o&&(c+="vertex-colors:"),l&&(c+="flat-shading:");let u=this.cache.get(c);u||(u=r.clone(),o&&(u.vertexColors=!0),l&&(u.flatShading=!0),i&&(u.normalScale&&(u.normalScale.y*=-1),u.clearcoatNormalScale&&(u.clearcoatNormalScale.y*=-1)),this.cache.add(c,u),this.associations.set(u,this.associations.get(r))),r=u}e.material=r}getMaterialType(){return f.MeshStandardMaterial}loadMaterial(e){const t=this,r=this.json,i=this.extensions,o=r.materials[e];let l;const c={},u=o.extensions||{},d=[];if(u[fe.KHR_MATERIALS_UNLIT]){const p=i[fe.KHR_MATERIALS_UNLIT];l=p.getMaterialType(),d.push(p.extendParams(c,o,t))}else{const p=o.pbrMetallicRoughness||{};if(c.color=new f.Color(1,1,1),c.opacity=1,Array.isArray(p.baseColorFactor)){const _=p.baseColorFactor;c.color.setRGB(_[0],_[1],_[2],yr),c.opacity=_[3]}p.baseColorTexture!==void 0&&d.push(t.assignTexture(c,"map",p.baseColorTexture,ai)),c.metalness=p.metallicFactor!==void 0?p.metallicFactor:1,c.roughness=p.roughnessFactor!==void 0?p.roughnessFactor:1,p.metallicRoughnessTexture!==void 0&&(d.push(t.assignTexture(c,"metalnessMap",p.metallicRoughnessTexture)),d.push(t.assignTexture(c,"roughnessMap",p.metallicRoughnessTexture))),l=this._invokeOne(function(_){return _.getMaterialType&&_.getMaterialType(e)}),d.push(Promise.all(this._invokeAll(function(_){return _.extendMaterialParams&&_.extendMaterialParams(e,c)})))}o.doubleSided===!0&&(c.side=f.DoubleSide);const m=o.alphaMode||Bo.OPAQUE;if(m===Bo.BLEND?(c.transparent=!0,c.depthWrite=!1):(c.transparent=!1,m===Bo.MASK&&(c.alphaTest=o.alphaCutoff!==void 0?o.alphaCutoff:.5)),o.normalTexture!==void 0&&l!==f.MeshBasicMaterial&&(d.push(t.assignTexture(c,"normalMap",o.normalTexture)),c.normalScale=new f.Vector2(1,1),o.normalTexture.scale!==void 0)){const p=o.normalTexture.scale;c.normalScale.set(p,p)}if(o.occlusionTexture!==void 0&&l!==f.MeshBasicMaterial&&(d.push(t.assignTexture(c,"aoMap",o.occlusionTexture)),o.occlusionTexture.strength!==void 0&&(c.aoMapIntensity=o.occlusionTexture.strength)),o.emissiveFactor!==void 0&&l!==f.MeshBasicMaterial){const p=o.emissiveFactor;c.emissive=new f.Color().setRGB(p[0],p[1],p[2],yr)}return o.emissiveTexture!==void 0&&l!==f.MeshBasicMaterial&&d.push(t.assignTexture(c,"emissiveMap",o.emissiveTexture,ai)),Promise.all(d).then(function(){const p=new l(c);return o.name&&(p.name=o.name),vr(p,o),t.associations.set(p,{materials:e}),o.extensions&&li(i,p,o),p})}createUniqueName(e){const t=f.PropertyBinding.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,r=this.extensions,i=this.primitiveCache;function o(c){return r[fe.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(c,t).then(function(u){return ec(u,c,t)})}const l=[];for(let c=0,u=e.length;c<u;c++){const d=e[c],m=$p(d),p=i[m];if(p)l.push(p.promise);else{let _;d.extensions&&d.extensions[fe.KHR_DRACO_MESH_COMPRESSION]?_=o(d):_=ec(new f.BufferGeometry,d,t),i[m]={primitive:d,promise:_},l.push(_)}}return Promise.all(l)}loadMesh(e){const t=this,r=this.json,i=this.extensions,o=r.meshes[e],l=o.primitives,c=[];for(let u=0,d=l.length;u<d;u++){const m=l[u].material===void 0?Rp(this.cache):this.getDependency("material",l[u].material);c.push(m)}return c.push(t.loadGeometries(l)),Promise.all(c).then(function(u){const d=u.slice(0,u.length-1),m=u[u.length-1],p=[];for(let v=0,M=m.length;v<M;v++){const S=m[v],x=l[v];let O;const P=d[v];if(x.mode===Bt.TRIANGLES||x.mode===Bt.TRIANGLE_STRIP||x.mode===Bt.TRIANGLE_FAN||x.mode===void 0)O=o.isSkinnedMesh===!0?new f.SkinnedMesh(S,P):new f.Mesh(S,P),O.isSkinnedMesh===!0&&O.normalizeSkinWeights(),x.mode===Bt.TRIANGLE_STRIP?O.geometry=Ul(O.geometry,f.TriangleStripDrawMode):x.mode===Bt.TRIANGLE_FAN&&(O.geometry=Ul(O.geometry,f.TriangleFanDrawMode));else if(x.mode===Bt.LINES)O=new f.LineSegments(S,P);else if(x.mode===Bt.LINE_STRIP)O=new f.Line(S,P);else if(x.mode===Bt.LINE_LOOP)O=new f.LineLoop(S,P);else if(x.mode===Bt.POINTS)O=new f.Points(S,P);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+x.mode);Object.keys(O.geometry.morphAttributes).length>0&&Gp(O,o),O.name=t.createUniqueName(o.name||"mesh_"+e),vr(O,o),x.extensions&&li(i,O,x),t.assignFinalMaterial(O),p.push(O)}for(let v=0,M=p.length;v<M;v++)t.associations.set(p[v],{meshes:e,primitives:v});if(p.length===1)return o.extensions&&li(i,p[0],o),p[0];const _=new f.Group;o.extensions&&li(i,_,o),t.associations.set(_,{meshes:e});for(let v=0,M=p.length;v<M;v++)_.add(p[v]);return _})}loadCamera(e){let t;const r=this.json.cameras[e],i=r[r.type];if(!i){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return r.type==="perspective"?t=new f.PerspectiveCamera(f.MathUtils.radToDeg(i.yfov),i.aspectRatio||1,i.znear||1,i.zfar||2e6):r.type==="orthographic"&&(t=new f.OrthographicCamera(-i.xmag,i.xmag,i.ymag,-i.ymag,i.znear,i.zfar)),r.name&&(t.name=this.createUniqueName(r.name)),vr(t,r),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],r=[];for(let i=0,o=t.joints.length;i<o;i++)r.push(this._loadNodeShallow(t.joints[i]));return t.inverseBindMatrices!==void 0?r.push(this.getDependency("accessor",t.inverseBindMatrices)):r.push(null),Promise.all(r).then(function(i){const o=i.pop(),l=i,c=[],u=[];for(let d=0,m=l.length;d<m;d++){const p=l[d];if(p){c.push(p);const _=new f.Matrix4;o!==null&&_.fromArray(o.array,d*16),u.push(_)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[d])}return new f.Skeleton(c,u)})}loadAnimation(e){const t=this.json,r=this,i=t.animations[e],o=i.name?i.name:"animation_"+e,l=[],c=[],u=[],d=[],m=[];for(let p=0,_=i.channels.length;p<_;p++){const v=i.channels[p],M=i.samplers[v.sampler],S=v.target,x=S.node,O=i.parameters!==void 0?i.parameters[M.input]:M.input,P=i.parameters!==void 0?i.parameters[M.output]:M.output;S.node!==void 0&&(l.push(this.getDependency("node",x)),c.push(this.getDependency("accessor",O)),u.push(this.getDependency("accessor",P)),d.push(M),m.push(S))}return Promise.all([Promise.all(l),Promise.all(c),Promise.all(u),Promise.all(d),Promise.all(m)]).then(function(p){const _=p[0],v=p[1],M=p[2],S=p[3],x=p[4],O=[];for(let P=0,L=_.length;P<L;P++){const F=_[P],z=v[P],j=M[P],G=S[P],U=x[P];if(F===void 0)continue;F.updateMatrix&&F.updateMatrix();const X=r._createAnimationTracks(F,z,j,G,U);if(X)for(let N=0;N<X.length;N++)O.push(X[N])}return new f.AnimationClip(o,void 0,O)})}createNodeMesh(e){const t=this.json,r=this,i=t.nodes[e];return i.mesh===void 0?null:r.getDependency("mesh",i.mesh).then(function(o){const l=r._getNodeRef(r.meshCache,i.mesh,o);return i.weights!==void 0&&l.traverse(function(c){if(c.isMesh)for(let u=0,d=i.weights.length;u<d;u++)c.morphTargetInfluences[u]=i.weights[u]}),l})}loadNode(e){const t=this.json,r=this,i=t.nodes[e],o=r._loadNodeShallow(e),l=[],c=i.children||[];for(let d=0,m=c.length;d<m;d++)l.push(r.getDependency("node",c[d]));const u=i.skin===void 0?Promise.resolve(null):r.getDependency("skin",i.skin);return Promise.all([o,Promise.all(l),u]).then(function(d){const m=d[0],p=d[1],_=d[2];_!==null&&m.traverse(function(v){v.isSkinnedMesh&&v.bind(_,Xp)});for(let v=0,M=p.length;v<M;v++)m.add(p[v]);return m})}_loadNodeShallow(e){const t=this.json,r=this.extensions,i=this;if(this.nodeCache[e]!==void 0)return this.nodeCache[e];const o=t.nodes[e],l=o.name?i.createUniqueName(o.name):"",c=[],u=i._invokeOne(function(d){return d.createNodeMesh&&d.createNodeMesh(e)});return u&&c.push(u),o.camera!==void 0&&c.push(i.getDependency("camera",o.camera).then(function(d){return i._getNodeRef(i.cameraCache,o.camera,d)})),i._invokeAll(function(d){return d.createNodeAttachment&&d.createNodeAttachment(e)}).forEach(function(d){c.push(d)}),this.nodeCache[e]=Promise.all(c).then(function(d){let m;if(o.isBone===!0?m=new f.Bone:d.length>1?m=new f.Group:d.length===1?m=d[0]:m=new f.Object3D,m!==d[0])for(let p=0,_=d.length;p<_;p++)m.add(d[p]);if(o.name&&(m.userData.name=o.name,m.name=l),vr(m,o),o.extensions&&li(r,m,o),o.matrix!==void 0){const p=new f.Matrix4;p.fromArray(o.matrix),m.applyMatrix4(p)}else o.translation!==void 0&&m.position.fromArray(o.translation),o.rotation!==void 0&&m.quaternion.fromArray(o.rotation),o.scale!==void 0&&m.scale.fromArray(o.scale);return i.associations.has(m)||i.associations.set(m,{}),i.associations.get(m).nodes=e,m}),this.nodeCache[e]}loadScene(e){const t=this.extensions,r=this.json.scenes[e],i=this,o=new f.Group;r.name&&(o.name=i.createUniqueName(r.name)),vr(o,r),r.extensions&&li(t,o,r);const l=r.nodes||[],c=[];for(let u=0,d=l.length;u<d;u++)c.push(i.getDependency("node",l[u]));return Promise.all(c).then(function(u){for(let m=0,p=u.length;m<p;m++)o.add(u[m]);const d=m=>{const p=new Map;for(const[_,v]of i.associations)(_ instanceof f.Material||_ instanceof f.Texture)&&p.set(_,v);return m.traverse(_=>{const v=i.associations.get(_);v!=null&&p.set(_,v)}),p};return i.associations=d(o),o})}_createAnimationTracks(e,t,r,i,o){const l=[],c=e.name?e.name:e.uuid,u=[];Ur[o.path]===Ur.weights?e.traverse(function(_){_.morphTargetInfluences&&u.push(_.name?_.name:_.uuid)}):u.push(c);let d;switch(Ur[o.path]){case Ur.weights:d=f.NumberKeyframeTrack;break;case Ur.rotation:d=f.QuaternionKeyframeTrack;break;case Ur.position:case Ur.scale:d=f.VectorKeyframeTrack;break;default:r.itemSize===1?d=f.NumberKeyframeTrack:d=f.VectorKeyframeTrack;break}const m=i.interpolation!==void 0?Np[i.interpolation]:f.InterpolateLinear,p=this._getArrayFromAccessor(r);for(let _=0,v=u.length;_<v;_++){const M=new d(u[_]+"."+Ur[o.path],t.array,p,m);i.interpolation==="CUBICSPLINE"&&this._createCubicSplineTrackInterpolant(M),l.push(M)}return l}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const r=Vo(t.constructor),i=new Float32Array(t.length);for(let o=0,l=t.length;o<l;o++)i[o]=t[o]*r;t=i}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(r){const i=this instanceof f.QuaternionKeyframeTrack?zp:El;return new i(this.times,this.values,this.getValueSize()/3,r)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function Zp(s,e,t){const r=e.attributes,i=new f.Box3;if(r.POSITION!==void 0){const c=t.json.accessors[r.POSITION],u=c.min,d=c.max;if(u!==void 0&&d!==void 0){if(i.set(new f.Vector3(u[0],u[1],u[2]),new f.Vector3(d[0],d[1],d[2])),c.normalized){const m=Vo(Ui[c.componentType]);i.min.multiplyScalar(m),i.max.multiplyScalar(m)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const o=e.targets;if(o!==void 0){const c=new f.Vector3,u=new f.Vector3;for(let d=0,m=o.length;d<m;d++){const p=o[d];if(p.POSITION!==void 0){const _=t.json.accessors[p.POSITION],v=_.min,M=_.max;if(v!==void 0&&M!==void 0){if(u.setX(Math.max(Math.abs(v[0]),Math.abs(M[0]))),u.setY(Math.max(Math.abs(v[1]),Math.abs(M[1]))),u.setZ(Math.max(Math.abs(v[2]),Math.abs(M[2]))),_.normalized){const S=Vo(Ui[_.componentType]);u.multiplyScalar(S)}c.max(u)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}i.expandByVector(c)}s.boundingBox=i;const l=new f.Sphere;i.getCenter(l.center),l.radius=i.min.distanceTo(i.max)/2,s.boundingSphere=l}function ec(s,e,t){const r=e.attributes,i=[];function o(l,c){return t.getDependency("accessor",l).then(function(u){s.setAttribute(c,u)})}for(const l in r){const c=Fo[l]||l.toLowerCase();c in s.attributes||i.push(o(r[l],c))}if(e.indices!==void 0&&!s.index){const l=t.getDependency("accessor",e.indices).then(function(c){s.setIndex(c)});i.push(l)}return vr(s,e),Zp(s,e,t),Promise.all(i).then(function(){return e.targets!==void 0?Wp(s,e.targets,t):s})}function tc(s,e,t){const r=t.length-s-1;if(e>=t[r])return r-1;if(e<=t[s])return s;let i=s,o=r,l=Math.floor((i+o)/2);for(;e<t[l]||e>=t[l+1];)e<t[l]?o=l:i=l,l=Math.floor((i+o)/2);return l}function Kp(s,e,t,r){const i=[],o=[],l=[];i[0]=1;for(let c=1;c<=t;++c){o[c]=e-r[s+1-c],l[c]=r[s+c]-e;let u=0;for(let d=0;d<c;++d){const m=l[d+1],p=o[c-d],_=i[d]/(m+p);i[d]=u+m*_,u=p*_}i[c]=u}return i}function qp(s,e,t,r){const i=tc(s,r,e),o=Kp(i,r,s,e),l=new f.Vector4(0,0,0,0);for(let c=0;c<=s;++c){const u=t[i-s+c],d=o[c],m=u.w*d;l.x+=u.x*m,l.y+=u.y*m,l.z+=u.z*m,l.w+=u.w*d}return l}function Qp(s,e,t,r,i){const o=[];for(let p=0;p<=t;++p)o[p]=0;const l=[];for(let p=0;p<=r;++p)l[p]=o.slice(0);const c=[];for(let p=0;p<=t;++p)c[p]=o.slice(0);c[0][0]=1;const u=o.slice(0),d=o.slice(0);for(let p=1;p<=t;++p){u[p]=e-i[s+1-p],d[p]=i[s+p]-e;let _=0;for(let v=0;v<p;++v){const M=d[v+1],S=u[p-v];c[p][v]=M+S;const x=c[v][p-1]/c[p][v];c[v][p]=_+M*x,_=S*x}c[p][p]=_}for(let p=0;p<=t;++p)l[0][p]=c[p][t];for(let p=0;p<=t;++p){let _=0,v=1;const M=[];for(let S=0;S<=t;++S)M[S]=o.slice(0);M[0][0]=1;for(let S=1;S<=r;++S){let x=0;const O=p-S,P=t-S;p>=S&&(M[v][0]=M[_][0]/c[P+1][O],x=M[v][0]*c[O][P]);const L=O>=-1?1:-O,F=p-1<=P?S-1:t-p;for(let j=L;j<=F;++j)M[v][j]=(M[_][j]-M[_][j-1])/c[P+1][O+j],x+=M[v][j]*c[O+j][P];p<=P&&(M[v][S]=-M[_][S-1]/c[P+1][p],x+=M[v][S]*c[p][P]),l[S][p]=x;const z=_;_=v,v=z}}let m=t;for(let p=1;p<=r;++p){for(let _=0;_<=t;++_)l[p][_]*=m;m*=t-p}return l}function Ep(s,e,t,r,i){const o=i<s?i:s,l=[],c=tc(s,r,e),u=Qp(c,r,s,o,e),d=[];for(let m=0;m<t.length;++m){const p=t[m].clone(),_=p.w;p.x*=_,p.y*=_,p.z*=_,d[m]=p}for(let m=0;m<=o;++m){const p=d[c-s].clone().multiplyScalar(u[m][0]);for(let _=1;_<=s;++_)p.add(d[c-s+_].clone().multiplyScalar(u[m][_]));l[m]=p}for(let m=o+1;m<=i+1;++m)l[m]=new f.Vector4(0,0,0);return l}function Jp(s,e){let t=1;for(let i=2;i<=s;++i)t*=i;let r=1;for(let i=2;i<=e;++i)r*=i;for(let i=2;i<=s-e;++i)r*=i;return t/r}function Hp(s){const e=s.length,t=[],r=[];for(let o=0;o<e;++o){const l=s[o];t[o]=new f.Vector3(l.x,l.y,l.z),r[o]=l.w}const i=[];for(let o=0;o<e;++o){const l=t[o].clone();for(let c=1;c<=o;++c)l.sub(i[o-c].clone().multiplyScalar(Jp(o,c)*r[c]));i[o]=l.divideScalar(r[0])}return i}function em(s,e,t,r,i){const o=Ep(s,e,t,r,i);return Hp(o)}class rc extends f.Curve{constructor(e,t,r,i,o){super(),this.degree=e,this.knots=t,this.controlPoints=[],this.startKnot=i||0,this.endKnot=o||this.knots.length-1;for(let l=0;l<r.length;++l){const c=r[l];this.controlPoints[l]=new f.Vector4(c.x,c.y,c.z,c.w)}}getPoint(e,t){const r=t||new f.Vector3,i=this.knots[this.startKnot]+e*(this.knots[this.endKnot]-this.knots[this.startKnot]),o=qp(this.degree,this.knots,this.controlPoints,i);return o.w!=1&&o.divideScalar(o.w),r.set(o.x,o.y,o.z)}getTangent(e,t){const r=t||new f.Vector3,i=this.knots[0]+e*(this.knots[this.knots.length-1]-this.knots[0]),o=em(this.degree,this.knots,this.controlPoints,i,1);return r.copy(o[1]).normalize(),r}}let de,ze,dt;class tm extends f.Loader{constructor(e){super(e)}load(e,t,r,i){const o=this,l=o.path===""?f.LoaderUtils.extractUrlBase(e):o.path,c=new f.FileLoader(this.manager);c.setPath(o.path),c.setResponseType("arraybuffer"),c.setRequestHeader(o.requestHeader),c.setWithCredentials(o.withCredentials),c.load(e,function(u){try{t(o.parse(u,l))}catch(d){i?i(d):console.error(d),o.manager.itemError(e)}},r,i)}parse(e,t){if(am(e))de=new om().parse(e);else{const i=lc(e);if(!lm(i))throw new Error("THREE.FBXLoader: Unknown format.");if(sc(i)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+sc(i));de=new sm().parse(i)}const r=new f.TextureLoader(this.manager).setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin);return new rm(r,this.manager).parse(de)}}class rm{constructor(e,t){this.textureLoader=e,this.manager=t}parse(){ze=this.parseConnections();const e=this.parseImages(),t=this.parseTextures(e),r=this.parseMaterials(t),i=this.parseDeformers(),o=new im().parse(i);return this.parseScene(i,o,r),dt}parseConnections(){const e=new Map;return"Connections"in de&&de.Connections.connections.forEach(function(r){const i=r[0],o=r[1],l=r[2];e.has(i)||e.set(i,{parents:[],children:[]});const c={ID:o,relationship:l};e.get(i).parents.push(c),e.has(o)||e.set(o,{parents:[],children:[]});const u={ID:i,relationship:l};e.get(o).children.push(u)}),e}parseImages(){const e={},t={};if("Video"in de.Objects){const r=de.Objects.Video;for(const i in r){const o=r[i],l=parseInt(i);if(e[l]=o.RelativeFilename||o.Filename,"Content"in o){const c=o.Content instanceof ArrayBuffer&&o.Content.byteLength>0,u=typeof o.Content=="string"&&o.Content!=="";if(c||u){const d=this.parseImage(r[i]);t[o.RelativeFilename||o.Filename]=d}}}}for(const r in e){const i=e[r];t[i]!==void 0?e[r]=t[i]:e[r]=e[r].split("\\").pop()}return e}parseImage(e){const t=e.Content,r=e.RelativeFilename||e.Filename,i=r.slice(r.lastIndexOf(".")+1).toLowerCase();let o;switch(i){case"bmp":o="image/bmp";break;case"jpg":case"jpeg":o="image/jpeg";break;case"png":o="image/png";break;case"tif":o="image/tiff";break;case"tga":this.manager.getHandler(".tga")===null&&console.warn("FBXLoader: TGA loader not found, skipping ",r),o="image/tga";break;default:console.warn('FBXLoader: Image type "'+i+'" is not supported.');return}if(typeof t=="string")return"data:"+o+";base64,"+t;{const l=new Uint8Array(t);return window.URL.createObjectURL(new Blob([l],{type:o}))}}parseTextures(e){const t=new Map;if("Texture"in de.Objects){const r=de.Objects.Texture;for(const i in r){const o=this.parseTexture(r[i],e);t.set(parseInt(i),o)}}return t}parseTexture(e,t){const r=this.loadTexture(e,t);r.ID=e.id,r.name=e.attrName;const i=e.WrapModeU,o=e.WrapModeV,l=i!==void 0?i.value:0,c=o!==void 0?o.value:0;if(r.wrapS=l===0?f.RepeatWrapping:f.ClampToEdgeWrapping,r.wrapT=c===0?f.RepeatWrapping:f.ClampToEdgeWrapping,"Scaling"in e){const u=e.Scaling.value;r.repeat.x=u[0],r.repeat.y=u[1]}return r}loadTexture(e,t){let r;const i=this.textureLoader.path,o=ze.get(e.id).children;o!==void 0&&o.length>0&&t[o[0].ID]!==void 0&&(r=t[o[0].ID],(r.indexOf("blob:")===0||r.indexOf("data:")===0)&&this.textureLoader.setPath(void 0));let l;const c=e.FileName.slice(-3).toLowerCase();if(c==="tga"){const u=this.manager.getHandler(".tga");u===null?(console.warn("FBXLoader: TGA loader not found, creating placeholder texture for",e.RelativeFilename),l=new f.Texture):(u.setPath(this.textureLoader.path),l=u.load(r))}else c==="psd"?(console.warn("FBXLoader: PSD textures are not supported, creating placeholder texture for",e.RelativeFilename),l=new f.Texture):l=this.textureLoader.load(r);return this.textureLoader.setPath(i),l}parseMaterials(e){const t=new Map;if("Material"in de.Objects){const r=de.Objects.Material;for(const i in r){const o=this.parseMaterial(r[i],e);o!==null&&t.set(parseInt(i),o)}}return t}parseMaterial(e,t){const r=e.id,i=e.attrName;let o=e.ShadingModel;if(typeof o=="object"&&(o=o.value),!ze.has(r))return null;const l=this.parseParameters(e,t,r);let c;switch(o.toLowerCase()){case"phong":c=new f.MeshPhongMaterial;break;case"lambert":c=new f.MeshLambertMaterial;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',o),c=new f.MeshPhongMaterial;break}return c.setValues(l),c.name=i,c}parseParameters(e,t,r){const i={};e.BumpFactor&&(i.bumpScale=e.BumpFactor.value),e.Diffuse?i.color=new f.Color().fromArray(e.Diffuse.value):e.DiffuseColor&&(e.DiffuseColor.type==="Color"||e.DiffuseColor.type==="ColorRGB")&&(i.color=new f.Color().fromArray(e.DiffuseColor.value)),e.DisplacementFactor&&(i.displacementScale=e.DisplacementFactor.value),e.Emissive?i.emissive=new f.Color().fromArray(e.Emissive.value):e.EmissiveColor&&(e.EmissiveColor.type==="Color"||e.EmissiveColor.type==="ColorRGB")&&(i.emissive=new f.Color().fromArray(e.EmissiveColor.value)),e.EmissiveFactor&&(i.emissiveIntensity=parseFloat(e.EmissiveFactor.value)),e.Opacity&&(i.opacity=parseFloat(e.Opacity.value)),i.opacity<1&&(i.transparent=!0),e.ReflectionFactor&&(i.reflectivity=e.ReflectionFactor.value),e.Shininess&&(i.shininess=e.Shininess.value),e.Specular?i.specular=new f.Color().fromArray(e.Specular.value):e.SpecularColor&&e.SpecularColor.type==="Color"&&(i.specular=new f.Color().fromArray(e.SpecularColor.value));const o=this;return ze.get(r).children.forEach(function(l){const c=l.relationship;switch(c){case"Bump":i.bumpMap=o.getTexture(t,l.ID);break;case"Maya|TEX_ao_map":i.aoMap=o.getTexture(t,l.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":i.map=o.getTexture(t,l.ID),i.map!==void 0&&("colorSpace"in i.map?i.map.colorSpace="srgb":i.map.encoding=3001);break;case"DisplacementColor":i.displacementMap=o.getTexture(t,l.ID);break;case"EmissiveColor":i.emissiveMap=o.getTexture(t,l.ID),i.emissiveMap!==void 0&&("colorSpace"in i.emissiveMap?i.emissiveMap.colorSpace="srgb":i.emissiveMap.encoding=3001);break;case"NormalMap":case"Maya|TEX_normal_map":i.normalMap=o.getTexture(t,l.ID);break;case"ReflectionColor":i.envMap=o.getTexture(t,l.ID),i.envMap!==void 0&&(i.envMap.mapping=f.EquirectangularReflectionMapping,"colorSpace"in i.envMap?i.envMap.colorSpace="srgb":i.envMap.encoding=3001);break;case"SpecularColor":i.specularMap=o.getTexture(t,l.ID),i.specularMap!==void 0&&("colorSpace"in i.specularMap?i.specularMap.colorSpace="srgb":i.specularMap.encoding=3001);break;case"TransparentColor":case"TransparencyFactor":i.alphaMap=o.getTexture(t,l.ID),i.transparent=!0;break;default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",c);break}}),i}getTexture(e,t){return"LayeredTexture"in de.Objects&&t in de.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),t=ze.get(t).children[0].ID),e.get(t)}parseDeformers(){const e={},t={};if("Deformer"in de.Objects){const r=de.Objects.Deformer;for(const i in r){const o=r[i],l=ze.get(parseInt(i));if(o.attrType==="Skin"){const c=this.parseSkeleton(l,r);c.ID=i,l.parents.length>1&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),c.geometryID=l.parents[0].ID,e[i]=c}else if(o.attrType==="BlendShape"){const c={id:i};c.rawTargets=this.parseMorphTargets(l,r),c.id=i,l.parents.length>1&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),t[i]=c}}}return{skeletons:e,morphTargets:t}}parseSkeleton(e,t){const r=[];return e.children.forEach(function(i){const o=t[i.ID];if(o.attrType!=="Cluster")return;const l={ID:i.ID,indices:[],weights:[],transformLink:new f.Matrix4().fromArray(o.TransformLink.a)};"Indexes"in o&&(l.indices=o.Indexes.a,l.weights=o.Weights.a),r.push(l)}),{rawBones:r,bones:[]}}parseMorphTargets(e,t){const r=[];for(let i=0;i<e.children.length;i++){const o=e.children[i],l=t[o.ID],c={name:l.attrName,initialWeight:l.DeformPercent,id:l.id,fullWeights:l.FullWeights.a};if(l.attrType!=="BlendShapeChannel")return;c.geoID=ze.get(parseInt(o.ID)).children.filter(function(u){return u.relationship===void 0})[0].ID,r.push(c)}return r}parseScene(e,t,r){dt=new f.Group;const i=this.parseModels(e.skeletons,t,r),o=de.Objects.Model,l=this;i.forEach(function(u){const d=o[u.ID];l.setLookAtProperties(u,d),ze.get(u.ID).parents.forEach(function(p){const _=i.get(p.ID);_!==void 0&&_.add(u)}),u.parent===null&&dt.add(u)}),this.bindSkeleton(e.skeletons,t,i),this.createAmbientLight(),dt.traverse(function(u){if(u.userData.transformData){u.parent&&(u.userData.transformData.parentMatrix=u.parent.matrix,u.userData.transformData.parentMatrixWorld=u.parent.matrixWorld);const d=oc(u.userData.transformData);u.applyMatrix4(d),u.updateWorldMatrix()}});const c=new nm().parse();dt.children.length===1&&dt.children[0].isGroup&&(dt.children[0].animations=c,dt=dt.children[0]),dt.animations=c}parseModels(e,t,r){const i=new Map,o=de.Objects.Model;for(const l in o){const c=parseInt(l),u=o[l],d=ze.get(c);let m=this.buildSkeleton(d,e,c,u.attrName);if(!m){switch(u.attrType){case"Camera":m=this.createCamera(d);break;case"Light":m=this.createLight(d);break;case"Mesh":m=this.createMesh(d,t,r);break;case"NurbsCurve":m=this.createCurve(d,t);break;case"LimbNode":case"Root":m=new f.Bone;break;default:m=new f.Group;break}m.name=u.attrName?f.PropertyBinding.sanitizeNodeName(u.attrName):"",m.ID=c}this.getTransformData(m,u),i.set(c,m)}return i}buildSkeleton(e,t,r,i){let o=null;return e.parents.forEach(function(l){for(const c in t){const u=t[c];u.rawBones.forEach(function(d,m){if(d.ID===l.ID){const p=o;o=new f.Bone,o.matrixWorld.copy(d.transformLink),o.name=i?f.PropertyBinding.sanitizeNodeName(i):"",o.ID=r,u.bones[m]=o,p!==null&&o.add(p)}})}}),o}createCamera(e){let t,r;if(e.children.forEach(function(i){const o=de.Objects.NodeAttribute[i.ID];o!==void 0&&(r=o)}),r===void 0)t=new f.Object3D;else{let i=0;r.CameraProjectionType!==void 0&&r.CameraProjectionType.value===1&&(i=1);let o=1;r.NearPlane!==void 0&&(o=r.NearPlane.value/1e3);let l=1e3;r.FarPlane!==void 0&&(l=r.FarPlane.value/1e3);let c=window.innerWidth,u=window.innerHeight;r.AspectWidth!==void 0&&r.AspectHeight!==void 0&&(c=r.AspectWidth.value,u=r.AspectHeight.value);const d=c/u;let m=45;r.FieldOfView!==void 0&&(m=r.FieldOfView.value);const p=r.FocalLength?r.FocalLength.value:null;switch(i){case 0:t=new f.PerspectiveCamera(m,d,o,l),p!==null&&t.setFocalLength(p);break;case 1:t=new f.OrthographicCamera(-c/2,c/2,u/2,-u/2,o,l);break;default:console.warn("THREE.FBXLoader: Unknown camera type "+i+"."),t=new f.Object3D;break}}return t}createLight(e){let t,r;if(e.children.forEach(function(i){const o=de.Objects.NodeAttribute[i.ID];o!==void 0&&(r=o)}),r===void 0)t=new f.Object3D;else{let i;r.LightType===void 0?i=0:i=r.LightType.value;let o=16777215;r.Color!==void 0&&(o=new f.Color().fromArray(r.Color.value));let l=r.Intensity===void 0?1:r.Intensity.value/100;r.CastLightOnObject!==void 0&&r.CastLightOnObject.value===0&&(l=0);let c=0;r.FarAttenuationEnd!==void 0&&(r.EnableFarAttenuation!==void 0&&r.EnableFarAttenuation.value===0?c=0:c=r.FarAttenuationEnd.value);const u=1;switch(i){case 0:t=new f.PointLight(o,l,c,u);break;case 1:t=new f.DirectionalLight(o,l);break;case 2:let d=Math.PI/3;r.InnerAngle!==void 0&&(d=f.MathUtils.degToRad(r.InnerAngle.value));let m=0;r.OuterAngle!==void 0&&(m=f.MathUtils.degToRad(r.OuterAngle.value),m=Math.max(m,1)),t=new f.SpotLight(o,l,c,d,m,u);break;default:console.warn("THREE.FBXLoader: Unknown light type "+r.LightType.value+", defaulting to a PointLight."),t=new f.PointLight(o,l);break}r.CastShadows!==void 0&&r.CastShadows.value===1&&(t.castShadow=!0)}return t}createMesh(e,t,r){let i,o=null,l=null;const c=[];return e.children.forEach(function(u){t.has(u.ID)&&(o=t.get(u.ID)),r.has(u.ID)&&c.push(r.get(u.ID))}),c.length>1?l=c:c.length>0?l=c[0]:(l=new f.MeshPhongMaterial({color:13421772}),c.push(l)),"color"in o.attributes&&c.forEach(function(u){u.vertexColors=!0}),o.FBX_Deformer?(i=new f.SkinnedMesh(o,l),i.normalizeSkinWeights()):i=new f.Mesh(o,l),i}createCurve(e,t){const r=e.children.reduce(function(o,l){return t.has(l.ID)&&(o=t.get(l.ID)),o},null),i=new f.LineBasicMaterial({color:3342591,linewidth:1});return new f.Line(r,i)}getTransformData(e,t){const r={};"InheritType"in t&&(r.inheritType=parseInt(t.InheritType.value)),"RotationOrder"in t?r.eulerOrder=ac(t.RotationOrder.value):r.eulerOrder="ZYX","Lcl_Translation"in t&&(r.translation=t.Lcl_Translation.value),"PreRotation"in t&&(r.preRotation=t.PreRotation.value),"Lcl_Rotation"in t&&(r.rotation=t.Lcl_Rotation.value),"PostRotation"in t&&(r.postRotation=t.PostRotation.value),"Lcl_Scaling"in t&&(r.scale=t.Lcl_Scaling.value),"ScalingOffset"in t&&(r.scalingOffset=t.ScalingOffset.value),"ScalingPivot"in t&&(r.scalingPivot=t.ScalingPivot.value),"RotationOffset"in t&&(r.rotationOffset=t.RotationOffset.value),"RotationPivot"in t&&(r.rotationPivot=t.RotationPivot.value),e.userData.transformData=r}setLookAtProperties(e,t){"LookAtProperty"in t&&ze.get(e.ID).children.forEach(function(i){if(i.relationship==="LookAtProperty"){const o=de.Objects.Model[i.ID];if("Lcl_Translation"in o){const l=o.Lcl_Translation.value;e.target!==void 0?(e.target.position.fromArray(l),dt.add(e.target)):e.lookAt(new f.Vector3().fromArray(l))}}})}bindSkeleton(e,t,r){const i=this.parsePoseNodes();for(const o in e){const l=e[o];ze.get(parseInt(l.ID)).parents.forEach(function(u){if(t.has(u.ID)){const d=u.ID;ze.get(d).parents.forEach(function(p){r.has(p.ID)&&r.get(p.ID).bind(new f.Skeleton(l.bones),i[p.ID])})}})}}parsePoseNodes(){const e={};if("Pose"in de.Objects){const t=de.Objects.Pose;for(const r in t)if(t[r].attrType==="BindPose"&&t[r].NbPoseNodes>0){const i=t[r].PoseNode;Array.isArray(i)?i.forEach(function(o){e[o.Node]=new f.Matrix4().fromArray(o.Matrix.a)}):e[i.Node]=new f.Matrix4().fromArray(i.Matrix.a)}}return e}createAmbientLight(){if("GlobalSettings"in de&&"AmbientColor"in de.GlobalSettings){const e=de.GlobalSettings.AmbientColor.value,t=e[0],r=e[1],i=e[2];if(t!==0||r!==0||i!==0){const o=new f.Color(t,r,i);dt.add(new f.AmbientLight(o,1))}}}}class im{parse(e){const t=new Map;if("Geometry"in de.Objects){const r=de.Objects.Geometry;for(const i in r){const o=ze.get(parseInt(i)),l=this.parseGeometry(o,r[i],e);t.set(parseInt(i),l)}}return t}parseGeometry(e,t,r){switch(t.attrType){case"Mesh":return this.parseMeshGeometry(e,t,r);case"NurbsCurve":return this.parseNurbsGeometry(t)}}parseMeshGeometry(e,t,r){const i=r.skeletons,o=[],l=e.parents.map(function(p){return de.Objects.Model[p.ID]});if(l.length===0)return;const c=e.children.reduce(function(p,_){return i[_.ID]!==void 0&&(p=i[_.ID]),p},null);e.children.forEach(function(p){r.morphTargets[p.ID]!==void 0&&o.push(r.morphTargets[p.ID])});const u=l[0],d={};"RotationOrder"in u&&(d.eulerOrder=ac(u.RotationOrder.value)),"InheritType"in u&&(d.inheritType=parseInt(u.InheritType.value)),"GeometricTranslation"in u&&(d.translation=u.GeometricTranslation.value),"GeometricRotation"in u&&(d.rotation=u.GeometricRotation.value),"GeometricScaling"in u&&(d.scale=u.GeometricScaling.value);const m=oc(d);return this.genGeometry(t,c,o,m)}genGeometry(e,t,r,i){const o=new f.BufferGeometry;e.attrName&&(o.name=e.attrName);const l=this.parseGeoNode(e,t),c=this.genBuffers(l),u=new f.Float32BufferAttribute(c.vertex,3);if(u.applyMatrix4(i),o.setAttribute("position",u),c.colors.length>0&&o.setAttribute("color",new f.Float32BufferAttribute(c.colors,3)),t&&(o.setAttribute("skinIndex",new f.Uint16BufferAttribute(c.weightsIndices,4)),o.setAttribute("skinWeight",new f.Float32BufferAttribute(c.vertexWeights,4)),o.FBX_Deformer=t),c.normal.length>0){const d=new f.Matrix3().getNormalMatrix(i),m=new f.Float32BufferAttribute(c.normal,3);m.applyNormalMatrix(d),o.setAttribute("normal",m)}if(c.uvs.forEach(function(d,m){Ao==="uv2"&&m++;const p=m===0?"uv":`uv${m}`;o.setAttribute(p,new f.Float32BufferAttribute(c.uvs[m],2))}),l.material&&l.material.mappingType!=="AllSame"){let d=c.materialIndex[0],m=0;if(c.materialIndex.forEach(function(p,_){p!==d&&(o.addGroup(m,_-m,d),d=p,m=_)}),o.groups.length>0){const p=o.groups[o.groups.length-1],_=p.start+p.count;_!==c.materialIndex.length&&o.addGroup(_,c.materialIndex.length-_,d)}o.groups.length===0&&o.addGroup(0,c.materialIndex.length,c.materialIndex[0])}return this.addMorphTargets(o,e,r,i),o}parseGeoNode(e,t){const r={};if(r.vertexPositions=e.Vertices!==void 0?e.Vertices.a:[],r.vertexIndices=e.PolygonVertexIndex!==void 0?e.PolygonVertexIndex.a:[],e.LayerElementColor&&(r.color=this.parseVertexColors(e.LayerElementColor[0])),e.LayerElementMaterial&&(r.material=this.parseMaterialIndices(e.LayerElementMaterial[0])),e.LayerElementNormal&&(r.normal=this.parseNormals(e.LayerElementNormal[0])),e.LayerElementUV){r.uv=[];let i=0;for(;e.LayerElementUV[i];)e.LayerElementUV[i].UV&&r.uv.push(this.parseUVs(e.LayerElementUV[i])),i++}return r.weightTable={},t!==null&&(r.skeleton=t,t.rawBones.forEach(function(i,o){i.indices.forEach(function(l,c){r.weightTable[l]===void 0&&(r.weightTable[l]=[]),r.weightTable[l].push({id:o,weight:i.weights[c]})})})),r}genBuffers(e){const t={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]};let r=0,i=0,o=!1,l=[],c=[],u=[],d=[],m=[],p=[];const _=this;return e.vertexIndices.forEach(function(v,M){let S,x=!1;v<0&&(v=v^-1,x=!0);let O=[],P=[];if(l.push(v*3,v*3+1,v*3+2),e.color){const L=ss(M,r,v,e.color);u.push(L[0],L[1],L[2])}if(e.skeleton){if(e.weightTable[v]!==void 0&&e.weightTable[v].forEach(function(L){P.push(L.weight),O.push(L.id)}),P.length>4){o||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),o=!0);const L=[0,0,0,0],F=[0,0,0,0];P.forEach(function(z,j){let G=z,U=O[j];F.forEach(function(X,N,k){if(G>X){k[N]=G,G=X;const Z=L[N];L[N]=U,U=Z}})}),O=L,P=F}for(;P.length<4;)P.push(0),O.push(0);for(let L=0;L<4;++L)m.push(P[L]),p.push(O[L])}if(e.normal){const L=ss(M,r,v,e.normal);c.push(L[0],L[1],L[2])}e.material&&e.material.mappingType!=="AllSame"&&(S=ss(M,r,v,e.material)[0]),e.uv&&e.uv.forEach(function(L,F){const z=ss(M,r,v,L);d[F]===void 0&&(d[F]=[]),d[F].push(z[0]),d[F].push(z[1])}),i++,x&&(_.genFace(t,e,l,S,c,u,d,m,p,i),r++,i=0,l=[],c=[],u=[],d=[],m=[],p=[])}),t}genFace(e,t,r,i,o,l,c,u,d,m){for(let p=2;p<m;p++)e.vertex.push(t.vertexPositions[r[0]]),e.vertex.push(t.vertexPositions[r[1]]),e.vertex.push(t.vertexPositions[r[2]]),e.vertex.push(t.vertexPositions[r[(p-1)*3]]),e.vertex.push(t.vertexPositions[r[(p-1)*3+1]]),e.vertex.push(t.vertexPositions[r[(p-1)*3+2]]),e.vertex.push(t.vertexPositions[r[p*3]]),e.vertex.push(t.vertexPositions[r[p*3+1]]),e.vertex.push(t.vertexPositions[r[p*3+2]]),t.skeleton&&(e.vertexWeights.push(u[0]),e.vertexWeights.push(u[1]),e.vertexWeights.push(u[2]),e.vertexWeights.push(u[3]),e.vertexWeights.push(u[(p-1)*4]),e.vertexWeights.push(u[(p-1)*4+1]),e.vertexWeights.push(u[(p-1)*4+2]),e.vertexWeights.push(u[(p-1)*4+3]),e.vertexWeights.push(u[p*4]),e.vertexWeights.push(u[p*4+1]),e.vertexWeights.push(u[p*4+2]),e.vertexWeights.push(u[p*4+3]),e.weightsIndices.push(d[0]),e.weightsIndices.push(d[1]),e.weightsIndices.push(d[2]),e.weightsIndices.push(d[3]),e.weightsIndices.push(d[(p-1)*4]),e.weightsIndices.push(d[(p-1)*4+1]),e.weightsIndices.push(d[(p-1)*4+2]),e.weightsIndices.push(d[(p-1)*4+3]),e.weightsIndices.push(d[p*4]),e.weightsIndices.push(d[p*4+1]),e.weightsIndices.push(d[p*4+2]),e.weightsIndices.push(d[p*4+3])),t.color&&(e.colors.push(l[0]),e.colors.push(l[1]),e.colors.push(l[2]),e.colors.push(l[(p-1)*3]),e.colors.push(l[(p-1)*3+1]),e.colors.push(l[(p-1)*3+2]),e.colors.push(l[p*3]),e.colors.push(l[p*3+1]),e.colors.push(l[p*3+2])),t.material&&t.material.mappingType!=="AllSame"&&(e.materialIndex.push(i),e.materialIndex.push(i),e.materialIndex.push(i)),t.normal&&(e.normal.push(o[0]),e.normal.push(o[1]),e.normal.push(o[2]),e.normal.push(o[(p-1)*3]),e.normal.push(o[(p-1)*3+1]),e.normal.push(o[(p-1)*3+2]),e.normal.push(o[p*3]),e.normal.push(o[p*3+1]),e.normal.push(o[p*3+2])),t.uv&&t.uv.forEach(function(_,v){e.uvs[v]===void 0&&(e.uvs[v]=[]),e.uvs[v].push(c[v][0]),e.uvs[v].push(c[v][1]),e.uvs[v].push(c[v][(p-1)*2]),e.uvs[v].push(c[v][(p-1)*2+1]),e.uvs[v].push(c[v][p*2]),e.uvs[v].push(c[v][p*2+1])})}addMorphTargets(e,t,r,i){if(r.length===0)return;e.morphTargetsRelative=!0,e.morphAttributes.position=[];const o=this;r.forEach(function(l){l.rawTargets.forEach(function(c){const u=de.Objects.Geometry[c.geoID];u!==void 0&&o.genMorphGeometry(e,t,u,i,c.name)})})}genMorphGeometry(e,t,r,i,o){const l=t.PolygonVertexIndex!==void 0?t.PolygonVertexIndex.a:[],c=r.Vertices!==void 0?r.Vertices.a:[],u=r.Indexes!==void 0?r.Indexes.a:[],d=e.attributes.position.count*3,m=new Float32Array(d);for(let M=0;M<u.length;M++){const S=u[M]*3;m[S]=c[M*3],m[S+1]=c[M*3+1],m[S+2]=c[M*3+2]}const p={vertexIndices:l,vertexPositions:m},_=this.genBuffers(p),v=new f.Float32BufferAttribute(_.vertex,3);v.name=o||r.attrName,v.applyMatrix4(i),e.morphAttributes.position.push(v)}parseNormals(e){const t=e.MappingInformationType,r=e.ReferenceInformationType,i=e.Normals.a;let o=[];return r==="IndexToDirect"&&("NormalIndex"in e?o=e.NormalIndex.a:"NormalsIndex"in e&&(o=e.NormalsIndex.a)),{dataSize:3,buffer:i,indices:o,mappingType:t,referenceType:r}}parseUVs(e){const t=e.MappingInformationType,r=e.ReferenceInformationType,i=e.UV.a;let o=[];return r==="IndexToDirect"&&(o=e.UVIndex.a),{dataSize:2,buffer:i,indices:o,mappingType:t,referenceType:r}}parseVertexColors(e){const t=e.MappingInformationType,r=e.ReferenceInformationType,i=e.Colors.a;let o=[];return r==="IndexToDirect"&&(o=e.ColorIndex.a),{dataSize:4,buffer:i,indices:o,mappingType:t,referenceType:r}}parseMaterialIndices(e){const t=e.MappingInformationType,r=e.ReferenceInformationType;if(t==="NoMappingInformation")return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:r};const i=e.Materials.a,o=[];for(let l=0;l<i.length;++l)o.push(l);return{dataSize:1,buffer:i,indices:o,mappingType:t,referenceType:r}}parseNurbsGeometry(e){if(rc===void 0)return console.error("THREE.FBXLoader: The loader relies on NURBSCurve for any nurbs present in the model. Nurbs will show up as empty geometry."),new f.BufferGeometry;const t=parseInt(e.Order);if(isNaN(t))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",e.Order,e.id),new f.BufferGeometry;const r=t-1,i=e.KnotVector.a,o=[],l=e.Points.a;for(let p=0,_=l.length;p<_;p+=4)o.push(new f.Vector4().fromArray(l,p));let c,u;if(e.Form==="Closed")o.push(o[0]);else if(e.Form==="Periodic"){c=r,u=i.length-1-c;for(let p=0;p<r;++p)o.push(o[p])}const m=new rc(r,i,o,c,u).getPoints(o.length*12);return new f.BufferGeometry().setFromPoints(m)}}class nm{parse(){const e=[],t=this.parseClips();if(t!==void 0)for(const r in t){const i=t[r],o=this.addClip(i);e.push(o)}return e}parseClips(){if(de.Objects.AnimationCurve===void 0)return;const e=this.parseAnimationCurveNodes();this.parseAnimationCurves(e);const t=this.parseAnimationLayers(e);return this.parseAnimStacks(t)}parseAnimationCurveNodes(){const e=de.Objects.AnimationCurveNode,t=new Map;for(const r in e){const i=e[r];if(i.attrName.match(/S|R|T|DeformPercent/)!==null){const o={id:i.id,attr:i.attrName,curves:{}};t.set(o.id,o)}}return t}parseAnimationCurves(e){const t=de.Objects.AnimationCurve;for(const r in t){const i={id:t[r].id,times:t[r].KeyTime.a.map(cm),values:t[r].KeyValueFloat.a},o=ze.get(i.id);if(o!==void 0){const l=o.parents[0].ID,c=o.parents[0].relationship;c.match(/X/)?e.get(l).curves.x=i:c.match(/Y/)?e.get(l).curves.y=i:c.match(/Z/)?e.get(l).curves.z=i:c.match(/d|DeformPercent/)&&e.has(l)&&(e.get(l).curves.morph=i)}}}parseAnimationLayers(e){const t=de.Objects.AnimationLayer,r=new Map;for(const i in t){const o=[],l=ze.get(parseInt(i));l!==void 0&&(l.children.forEach(function(u,d){if(e.has(u.ID)){const m=e.get(u.ID);if(m.curves.x!==void 0||m.curves.y!==void 0||m.curves.z!==void 0){if(o[d]===void 0){const p=ze.get(u.ID).parents.filter(function(_){return _.relationship!==void 0})[0].ID;if(p!==void 0){const _=de.Objects.Model[p.toString()];if(_===void 0){console.warn("THREE.FBXLoader: Encountered a unused curve.",u);return}const v={modelName:_.attrName?f.PropertyBinding.sanitizeNodeName(_.attrName):"",ID:_.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};dt.traverse(function(M){M.ID===_.id&&(v.transform=M.matrix,M.userData.transformData&&(v.eulerOrder=M.userData.transformData.eulerOrder))}),v.transform||(v.transform=new f.Matrix4),"PreRotation"in _&&(v.preRotation=_.PreRotation.value),"PostRotation"in _&&(v.postRotation=_.PostRotation.value),o[d]=v}}o[d]&&(o[d][m.attr]=m)}else if(m.curves.morph!==void 0){if(o[d]===void 0){const p=ze.get(u.ID).parents.filter(function(O){return O.relationship!==void 0})[0].ID,_=ze.get(p).parents[0].ID,v=ze.get(_).parents[0].ID,M=ze.get(v).parents[0].ID,S=de.Objects.Model[M],x={modelName:S.attrName?f.PropertyBinding.sanitizeNodeName(S.attrName):"",morphName:de.Objects.Deformer[p].attrName};o[d]=x}o[d][m.attr]=m}}}),r.set(parseInt(i),o))}return r}parseAnimStacks(e){const t=de.Objects.AnimationStack,r={};for(const i in t){const o=ze.get(parseInt(i)).children;o.length>1&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");const l=e.get(o[0].ID);r[i]={name:t[i].attrName,layer:l}}return r}addClip(e){let t=[];const r=this;return e.layer.forEach(function(i){t=t.concat(r.generateTracks(i))}),new f.AnimationClip(e.name,-1,t)}generateTracks(e){const t=[];let r=new f.Vector3,i=new f.Quaternion,o=new f.Vector3;if(e.transform&&e.transform.decompose(r,i,o),r=r.toArray(),i=new f.Euler().setFromQuaternion(i,e.eulerOrder).toArray(),o=o.toArray(),e.T!==void 0&&Object.keys(e.T.curves).length>0){const l=this.generateVectorTrack(e.modelName,e.T.curves,r,"position");l!==void 0&&t.push(l)}if(e.R!==void 0&&Object.keys(e.R.curves).length>0){const l=this.generateRotationTrack(e.modelName,e.R.curves,i,e.preRotation,e.postRotation,e.eulerOrder);l!==void 0&&t.push(l)}if(e.S!==void 0&&Object.keys(e.S.curves).length>0){const l=this.generateVectorTrack(e.modelName,e.S.curves,o,"scale");l!==void 0&&t.push(l)}if(e.DeformPercent!==void 0){const l=this.generateMorphTrack(e);l!==void 0&&t.push(l)}return t}generateVectorTrack(e,t,r,i){const o=this.getTimesForAllAxes(t),l=this.getKeyframeTrackValues(o,t,r);return new f.VectorKeyframeTrack(e+"."+i,o,l)}generateRotationTrack(e,t,r,i,o,l){t.x!==void 0&&(this.interpolateRotations(t.x),t.x.values=t.x.values.map(f.MathUtils.degToRad)),t.y!==void 0&&(this.interpolateRotations(t.y),t.y.values=t.y.values.map(f.MathUtils.degToRad)),t.z!==void 0&&(this.interpolateRotations(t.z),t.z.values=t.z.values.map(f.MathUtils.degToRad));const c=this.getTimesForAllAxes(t),u=this.getKeyframeTrackValues(c,t,r);i!==void 0&&(i=i.map(f.MathUtils.degToRad),i.push(l),i=new f.Euler().fromArray(i),i=new f.Quaternion().setFromEuler(i)),o!==void 0&&(o=o.map(f.MathUtils.degToRad),o.push(l),o=new f.Euler().fromArray(o),o=new f.Quaternion().setFromEuler(o).invert());const d=new f.Quaternion,m=new f.Euler,p=[];for(let _=0;_<u.length;_+=3)m.set(u[_],u[_+1],u[_+2],l),d.setFromEuler(m),i!==void 0&&d.premultiply(i),o!==void 0&&d.multiply(o),d.toArray(p,_/3*4);return new f.QuaternionKeyframeTrack(e+".quaternion",c,p)}generateMorphTrack(e){const t=e.DeformPercent.curves.morph,r=t.values.map(function(o){return o/100}),i=dt.getObjectByName(e.modelName).morphTargetDictionary[e.morphName];return new f.NumberKeyframeTrack(e.modelName+".morphTargetInfluences["+i+"]",t.times,r)}getTimesForAllAxes(e){let t=[];if(e.x!==void 0&&(t=t.concat(e.x.times)),e.y!==void 0&&(t=t.concat(e.y.times)),e.z!==void 0&&(t=t.concat(e.z.times)),t=t.sort(function(r,i){return r-i}),t.length>1){let r=1,i=t[0];for(let o=1;o<t.length;o++){const l=t[o];l!==i&&(t[r]=l,i=l,r++)}t=t.slice(0,r)}return t}getKeyframeTrackValues(e,t,r){const i=r,o=[];let l=-1,c=-1,u=-1;return e.forEach(function(d){if(t.x&&(l=t.x.times.indexOf(d)),t.y&&(c=t.y.times.indexOf(d)),t.z&&(u=t.z.times.indexOf(d)),l!==-1){const m=t.x.values[l];o.push(m),i[0]=m}else o.push(i[0]);if(c!==-1){const m=t.y.values[c];o.push(m),i[1]=m}else o.push(i[1]);if(u!==-1){const m=t.z.values[u];o.push(m),i[2]=m}else o.push(i[2])}),o}interpolateRotations(e){for(let t=1;t<e.values.length;t++){const r=e.values[t-1],i=e.values[t]-r,o=Math.abs(i);if(o>=180){const l=o/180,c=i/l;let u=r+c;const d=e.times[t-1],p=(e.times[t]-d)/l;let _=d+p;const v=[],M=[];for(;_<e.times[t];)v.push(_),_+=p,M.push(u),u+=c;e.times=cc(e.times,t,v),e.values=cc(e.values,t,M)}}}}class sm{getPrevNode(){return this.nodeStack[this.currentIndent-2]}getCurrentNode(){return this.nodeStack[this.currentIndent-1]}getCurrentProp(){return this.currentProp}pushStack(e){this.nodeStack.push(e),this.currentIndent+=1}popStack(){this.nodeStack.pop(),this.currentIndent-=1}setCurrentProp(e,t){this.currentProp=e,this.currentPropName=t}parse(e){this.currentIndent=0,this.allNodes=new nc,this.nodeStack=[],this.currentProp=[],this.currentPropName="";const t=this,r=e.split(/[\r\n]+/);return r.forEach(function(i,o){const l=i.match(/^[\s\t]*;/),c=i.match(/^[\s\t]*$/);if(l||c)return;const u=i.match("^\\t{"+t.currentIndent+"}(\\w+):(.*){",""),d=i.match("^\\t{"+t.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),m=i.match("^\\t{"+(t.currentIndent-1)+"}}");u?t.parseNodeBegin(i,u):d?t.parseNodeProperty(i,d,r[++o]):m?t.popStack():i.match(/^[^\s\t}]/)&&t.parseNodePropertyContinued(i)}),this.allNodes}parseNodeBegin(e,t){const r=t[1].trim().replace(/^"/,"").replace(/"$/,""),i=t[2].split(",").map(function(u){return u.trim().replace(/^"/,"").replace(/"$/,"")}),o={name:r},l=this.parseNodeAttr(i),c=this.getCurrentNode();this.currentIndent===0?this.allNodes.add(r,o):r in c?(r==="PoseNode"?c.PoseNode.push(o):c[r].id!==void 0&&(c[r]={},c[r][c[r].id]=c[r]),l.id!==""&&(c[r][l.id]=o)):typeof l.id=="number"?(c[r]={},c[r][l.id]=o):r!=="Properties70"&&(r==="PoseNode"?c[r]=[o]:c[r]=o),typeof l.id=="number"&&(o.id=l.id),l.name!==""&&(o.attrName=l.name),l.type!==""&&(o.attrType=l.type),this.pushStack(o)}parseNodeAttr(e){let t=e[0];e[0]!==""&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));let r="",i="";return e.length>1&&(r=e[1].replace(/^(\w+)::/,""),i=e[2]),{id:t,name:r,type:i}}parseNodeProperty(e,t,r){let i=t[1].replace(/^"/,"").replace(/"$/,"").trim(),o=t[2].replace(/^"/,"").replace(/"$/,"").trim();i==="Content"&&o===","&&(o=r.replace(/"/g,"").replace(/,$/,"").trim());const l=this.getCurrentNode();if(l.name==="Properties70"){this.parseNodeSpecialProperty(e,i,o);return}if(i==="C"){const u=o.split(",").slice(1),d=parseInt(u[0]),m=parseInt(u[1]);let p=o.split(",").slice(3);p=p.map(function(_){return _.trim().replace(/^"/,"")}),i="connections",o=[d,m],hm(o,p),l[i]===void 0&&(l[i]=[])}i==="Node"&&(l.id=o),i in l&&Array.isArray(l[i])?l[i].push(o):i!=="a"?l[i]=o:l.a=o,this.setCurrentProp(l,i),i==="a"&&o.slice(-1)!==","&&(l.a=zo(o))}parseNodePropertyContinued(e){const t=this.getCurrentNode();t.a+=e,e.slice(-1)!==","&&(t.a=zo(t.a))}parseNodeSpecialProperty(e,t,r){const i=r.split('",').map(function(m){return m.trim().replace(/^\"/,"").replace(/\s/,"_")}),o=i[0],l=i[1],c=i[2],u=i[3];let d=i[4];switch(l){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":d=parseFloat(d);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":d=zo(d);break}this.getPrevNode()[o]={type:l,type2:c,flag:u,value:d},this.setCurrentProp(this.getPrevNode(),o)}}class om{parse(e){const t=new ic(e);t.skip(23);const r=t.getUint32();if(r<6400)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+r);const i=new nc;for(;!this.endOfContent(t);){const o=this.parseNode(t,r);o!==null&&i.add(o.name,o)}return i}endOfContent(e){return e.size()%16===0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()}parseNode(e,t){const r={},i=t>=7500?e.getUint64():e.getUint32(),o=t>=7500?e.getUint64():e.getUint32();t>=7500?e.getUint64():e.getUint32();const l=e.getUint8(),c=e.getString(l);if(i===0)return null;const u=[];for(let _=0;_<o;_++)u.push(this.parseProperty(e));const d=u.length>0?u[0]:"",m=u.length>1?u[1]:"",p=u.length>2?u[2]:"";for(r.singleProperty=o===1&&e.getOffset()===i;i>e.getOffset();){const _=this.parseNode(e,t);_!==null&&this.parseSubNode(c,r,_)}return r.propertyList=u,typeof d=="number"&&(r.id=d),m!==""&&(r.attrName=m),p!==""&&(r.attrType=p),c!==""&&(r.name=c),r}parseSubNode(e,t,r){if(r.singleProperty===!0){const i=r.propertyList[0];Array.isArray(i)?(t[r.name]=r,r.a=i):t[r.name]=i}else if(e==="Connections"&&r.name==="C"){const i=[];r.propertyList.forEach(function(o,l){l!==0&&i.push(o)}),t.connections===void 0&&(t.connections=[]),t.connections.push(i)}else if(r.name==="Properties70")Object.keys(r).forEach(function(o){t[o]=r[o]});else if(e==="Properties70"&&r.name==="P"){let i=r.propertyList[0],o=r.propertyList[1];const l=r.propertyList[2],c=r.propertyList[3];let u;i.indexOf("Lcl ")===0&&(i=i.replace("Lcl ","Lcl_")),o.indexOf("Lcl ")===0&&(o=o.replace("Lcl ","Lcl_")),o==="Color"||o==="ColorRGB"||o==="Vector"||o==="Vector3D"||o.indexOf("Lcl_")===0?u=[r.propertyList[4],r.propertyList[5],r.propertyList[6]]:u=r.propertyList[4],t[i]={type:o,type2:l,flag:c,value:u}}else t[r.name]===void 0?typeof r.id=="number"?(t[r.name]={},t[r.name][r.id]=r):t[r.name]=r:r.name==="PoseNode"?(Array.isArray(t[r.name])||(t[r.name]=[t[r.name]]),t[r.name].push(r)):t[r.name][r.id]===void 0&&(t[r.name][r.id]=r)}parseProperty(e){const t=e.getString(1);let r;switch(t){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":return r=e.getUint32(),e.getArrayBuffer(r);case"S":return r=e.getUint32(),e.getString(r);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":const i=e.getUint32(),o=e.getUint32(),l=e.getUint32();if(o===0)switch(t){case"b":case"c":return e.getBooleanArray(i);case"d":return e.getFloat64Array(i);case"f":return e.getFloat32Array(i);case"i":return e.getInt32Array(i);case"l":return e.getInt64Array(i)}const c=Vd(new Uint8Array(e.getArrayBuffer(l))),u=new ic(c.buffer);switch(t){case"b":case"c":return u.getBooleanArray(i);case"d":return u.getFloat64Array(i);case"f":return u.getFloat32Array(i);case"i":return u.getInt32Array(i);case"l":return u.getInt64Array(i)}default:throw new Error("THREE.FBXLoader: Unknown property type "+t)}}}class ic{constructor(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=t!==void 0?t:!0}getOffset(){return this.offset}size(){return this.dv.buffer.byteLength}skip(e){this.offset+=e}getBoolean(){return(this.getUint8()&1)===1}getBooleanArray(e){const t=[];for(let r=0;r<e;r++)t.push(this.getBoolean());return t}getUint8(){const e=this.dv.getUint8(this.offset);return this.offset+=1,e}getInt16(){const e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}getInt32(){const e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}getInt32Array(e){const t=[];for(let r=0;r<e;r++)t.push(this.getInt32());return t}getUint32(){const e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}getInt64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),t&2147483648?(t=~t&4294967295,e=~e&4294967295,e===4294967295&&(t=t+1&4294967295),e=e+1&4294967295,-(t*4294967296+e)):t*4294967296+e}getInt64Array(e){const t=[];for(let r=0;r<e;r++)t.push(this.getInt64());return t}getUint64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),t*4294967296+e}getFloat32(){const e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}getFloat32Array(e){const t=[];for(let r=0;r<e;r++)t.push(this.getFloat32());return t}getFloat64(){const e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}getFloat64Array(e){const t=[];for(let r=0;r<e;r++)t.push(this.getFloat64());return t}getArrayBuffer(e){const t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}getString(e){let t=[];for(let i=0;i<e;i++)t[i]=this.getUint8();const r=t.indexOf(0);return r>=0&&(t=t.slice(0,r)),Bi(new Uint8Array(t))}}class nc{add(e,t){this[e]=t}}function am(s){const e="Kaydara FBX Binary  \0";return s.byteLength>=e.length&&e===lc(s,0,e.length)}function lm(s){const e=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"];let t=0;function r(i){const o=s[i-1];return s=s.slice(t+i),t++,o}for(let i=0;i<e.length;++i)if(r(1)===e[i])return!1;return!0}function sc(s){const e=/FBXVersion: (\d+)/,t=s.match(e);if(t)return parseInt(t[1]);throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function cm(s){return s/46186158e3}const um=[];function ss(s,e,t,r){let i;switch(r.mappingType){case"ByPolygonVertex":i=s;break;case"ByPolygon":i=e;break;case"ByVertice":i=t;break;case"AllSame":i=r.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+r.mappingType)}r.referenceType==="IndexToDirect"&&(i=r.indices[i]);const o=i*r.dataSize,l=o+r.dataSize;return fm(um,r.buffer,o,l)}const ko=new f.Euler,Vi=new f.Vector3;function oc(s){const e=new f.Matrix4,t=new f.Matrix4,r=new f.Matrix4,i=new f.Matrix4,o=new f.Matrix4,l=new f.Matrix4,c=new f.Matrix4,u=new f.Matrix4,d=new f.Matrix4,m=new f.Matrix4,p=new f.Matrix4,_=new f.Matrix4,v=s.inheritType?s.inheritType:0;if(s.translation&&e.setPosition(Vi.fromArray(s.translation)),s.preRotation){const N=s.preRotation.map(f.MathUtils.degToRad);N.push(s.eulerOrder),t.makeRotationFromEuler(ko.fromArray(N))}if(s.rotation){const N=s.rotation.map(f.MathUtils.degToRad);N.push(s.eulerOrder),r.makeRotationFromEuler(ko.fromArray(N))}if(s.postRotation){const N=s.postRotation.map(f.MathUtils.degToRad);N.push(s.eulerOrder),i.makeRotationFromEuler(ko.fromArray(N)),i.invert()}s.scale&&o.scale(Vi.fromArray(s.scale)),s.scalingOffset&&c.setPosition(Vi.fromArray(s.scalingOffset)),s.scalingPivot&&l.setPosition(Vi.fromArray(s.scalingPivot)),s.rotationOffset&&u.setPosition(Vi.fromArray(s.rotationOffset)),s.rotationPivot&&d.setPosition(Vi.fromArray(s.rotationPivot)),s.parentMatrixWorld&&(p.copy(s.parentMatrix),m.copy(s.parentMatrixWorld));const M=t.clone().multiply(r).multiply(i),S=new f.Matrix4;S.extractRotation(m);const x=new f.Matrix4;x.copyPosition(m);const O=x.clone().invert().multiply(m),P=S.clone().invert().multiply(O),L=o,F=new f.Matrix4;if(v===0)F.copy(S).multiply(M).multiply(P).multiply(L);else if(v===1)F.copy(S).multiply(P).multiply(M).multiply(L);else{const k=new f.Matrix4().scale(new f.Vector3().setFromMatrixScale(p)).clone().invert(),Z=P.clone().multiply(k);F.copy(S).multiply(M).multiply(Z).multiply(L)}const z=d.clone().invert(),j=l.clone().invert();let G=e.clone().multiply(u).multiply(d).multiply(t).multiply(r).multiply(i).multiply(z).multiply(c).multiply(l).multiply(o).multiply(j);const U=new f.Matrix4().copyPosition(G),X=m.clone().multiply(U);return _.copyPosition(X),G=_.clone().multiply(F),G.premultiply(m.invert()),G}function ac(s){s=s||0;const e=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return s===6?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),e[0]):e[s]}function zo(s){return s.split(",").map(function(t){return parseFloat(t)})}function lc(s,e,t){return e===void 0&&(e=0),t===void 0&&(t=s.byteLength),Bi(new Uint8Array(s,e,t))}function hm(s,e){for(let t=0,r=s.length,i=e.length;t<i;t++,r++)s[r]=e[t]}function fm(s,e,t,r){for(let i=t,o=0;i<r;i++,o++)s[o]=e[i];return s}function cc(s,e,t){return s.slice(0,e).concat(t).concat(s.slice(e))}class dm extends f.DataTextureLoader{constructor(e){super(e),this.type=f.HalfFloatType}parse(e){const l=function(U,X){switch(U){case 1:throw new Error("THREE.RGBELoader: Read Error: "+(X||""));case 2:throw new Error("THREE.RGBELoader: Write Error: "+(X||""));case 3:throw new Error("THREE.RGBELoader: Bad File Format: "+(X||""));default:case 4:throw new Error("THREE.RGBELoader: Memory Error: "+(X||""))}},p=function(U,X,N){X=X||1024;let Z=U.pos,E=-1,q=0,te="",H=String.fromCharCode.apply(null,new Uint16Array(U.subarray(Z,Z+128)));for(;0>(E=H.indexOf(`
`))&&q<X&&Z<U.byteLength;)te+=H,q+=H.length,Z+=128,H+=String.fromCharCode.apply(null,new Uint16Array(U.subarray(Z,Z+128)));return-1<E?(U.pos+=q+E+1,te+H.slice(0,E)):!1},_=function(U){const X=/^#\?(\S+)/,N=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,k=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,Z=/^\s*FORMAT=(\S+)\s*$/,E=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,q={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let te,H;for((U.pos>=U.byteLength||!(te=p(U)))&&l(1,"no header found"),(H=te.match(X))||l(3,"bad initial token"),q.valid|=1,q.programtype=H[1],q.string+=te+`
`;te=p(U),te!==!1;){if(q.string+=te+`
`,te.charAt(0)==="#"){q.comments+=te+`
`;continue}if((H=te.match(N))&&(q.gamma=parseFloat(H[1])),(H=te.match(k))&&(q.exposure=parseFloat(H[1])),(H=te.match(Z))&&(q.valid|=2,q.format=H[1]),(H=te.match(E))&&(q.valid|=4,q.height=parseInt(H[1],10),q.width=parseInt(H[2],10)),q.valid&2&&q.valid&4)break}return q.valid&2||l(3,"missing format specifier"),q.valid&4||l(3,"missing image size specifier"),q},v=function(U,X,N){const k=X;if(k<8||k>32767||U[0]!==2||U[1]!==2||U[2]&128)return new Uint8Array(U);k!==(U[2]<<8|U[3])&&l(3,"wrong scanline width");const Z=new Uint8Array(4*X*N);Z.length||l(4,"unable to allocate buffer space");let E=0,q=0;const te=4*k,H=new Uint8Array(4),Pe=new Uint8Array(te);let ve=N;for(;ve>0&&q<U.byteLength;){q+4>U.byteLength&&l(1),H[0]=U[q++],H[1]=U[q++],H[2]=U[q++],H[3]=U[q++],(H[0]!=2||H[1]!=2||(H[2]<<8|H[3])!=k)&&l(3,"bad rgbe scanline format");let we=0,me;for(;we<te&&q<U.byteLength;){me=U[q++];const Ce=me>128;if(Ce&&(me-=128),(me===0||we+me>te)&&l(3,"bad scanline data"),Ce){const Oe=U[q++];for(let lt=0;lt<me;lt++)Pe[we++]=Oe}else Pe.set(U.subarray(q,q+me),we),we+=me,q+=me}const Le=k;for(let Ce=0;Ce<Le;Ce++){let Oe=0;Z[E]=Pe[Ce+Oe],Oe+=k,Z[E+1]=Pe[Ce+Oe],Oe+=k,Z[E+2]=Pe[Ce+Oe],Oe+=k,Z[E+3]=Pe[Ce+Oe],E+=4}ve--}return Z},M=function(U,X,N,k){const Z=U[X+3],E=Math.pow(2,Z-128)/255;N[k+0]=U[X+0]*E,N[k+1]=U[X+1]*E,N[k+2]=U[X+2]*E,N[k+3]=1},S=function(U,X,N,k){const Z=U[X+3],E=Math.pow(2,Z-128)/255;N[k+0]=f.DataUtils.toHalfFloat(Math.min(U[X+0]*E,65504)),N[k+1]=f.DataUtils.toHalfFloat(Math.min(U[X+1]*E,65504)),N[k+2]=f.DataUtils.toHalfFloat(Math.min(U[X+2]*E,65504)),N[k+3]=f.DataUtils.toHalfFloat(1)},x=new Uint8Array(e);x.pos=0;const O=_(x),P=O.width,L=O.height,F=v(x.subarray(x.pos),P,L);let z,j,G;switch(this.type){case f.FloatType:G=F.length/4;const U=new Float32Array(G*4);for(let N=0;N<G;N++)M(F,N*4,U,N*4);z=U,j=f.FloatType;break;case f.HalfFloatType:G=F.length/4;const X=new Uint16Array(G*4);for(let N=0;N<G;N++)S(F,N*4,X,N*4);z=X,j=f.HalfFloatType;break;default:throw new Error("THREE.RGBELoader: Unsupported type: "+this.type)}return{width:P,height:L,data:z,header:O.string,gamma:O.gamma,exposure:O.exposure,type:j}}setDataType(e){return this.type=e,this}load(e,t,r,i){function o(l,c){switch(l.type){case f.FloatType:case f.HalfFloatType:"colorSpace"in l?l.colorSpace="srgb-linear":l.encoding=3e3,l.minFilter=f.LinearFilter,l.magFilter=f.LinearFilter,l.generateMipmaps=!1,l.flipY=!0;break}t&&t(l,c)}return super.load(e,o,r,i)}}const No=new WeakMap;class pm extends f.Loader{constructor(e){super(e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,t,r,i){const o=new f.FileLoader(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(e,l=>{const c={attributeIDs:this.defaultAttributeIDs,attributeTypes:this.defaultAttributeTypes,useUniqueIDs:!1};this.decodeGeometry(l,c).then(t).catch(i)},r,i)}decodeDracoFile(e,t,r,i){const o={attributeIDs:r||this.defaultAttributeIDs,attributeTypes:i||this.defaultAttributeTypes,useUniqueIDs:!!r};this.decodeGeometry(e,o).then(t)}decodeGeometry(e,t){for(const u in t.attributeTypes){const d=t.attributeTypes[u];d.BYTES_PER_ELEMENT!==void 0&&(t.attributeTypes[u]=d.name)}const r=JSON.stringify(t);if(No.has(e)){const u=No.get(e);if(u.key===r)return u.promise;if(e.byteLength===0)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let i;const o=this.workerNextTaskID++,l=e.byteLength,c=this._getWorker(o,l).then(u=>(i=u,new Promise((d,m)=>{i._callbacks[o]={resolve:d,reject:m},i.postMessage({type:"decode",id:o,taskConfig:t,buffer:e},[e])}))).then(u=>this._createGeometry(u.geometry));return c.catch(()=>!0).then(()=>{i&&o&&this._releaseTask(i,o)}),No.set(e,{key:r,promise:c}),c}_createGeometry(e){const t=new f.BufferGeometry;e.index&&t.setIndex(new f.BufferAttribute(e.index.array,1));for(let r=0;r<e.attributes.length;r++){const i=e.attributes[r],o=i.name,l=i.array,c=i.itemSize;t.setAttribute(o,new f.BufferAttribute(l,c))}return t}_loadLibrary(e,t){const r=new f.FileLoader(this.manager);return r.setPath(this.decoderPath),r.setResponseType(t),r.setWithCredentials(this.withCredentials),new Promise((i,o)=>{r.load(e,i,void 0,o)})}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const e=typeof WebAssembly!="object"||this.decoderConfig.type==="js",t=[];return e?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then(r=>{const i=r[0];e||(this.decoderConfig.wasmBinary=r[1]);const o=mm.toString(),l=["/* draco decoder */",i,"","/* worker */",o.substring(o.indexOf("{")+1,o.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([l]))}),this.decoderPending}_getWorker(e,t){return this._initDecoder().then(()=>{if(this.workerPool.length<this.workerLimit){const i=new Worker(this.workerSourceURL);i._callbacks={},i._taskCosts={},i._taskLoad=0,i.postMessage({type:"init",decoderConfig:this.decoderConfig}),i.onmessage=function(o){const l=o.data;switch(l.type){case"decode":i._callbacks[l.id].resolve(l);break;case"error":i._callbacks[l.id].reject(l);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+l.type+'"')}},this.workerPool.push(i)}else this.workerPool.sort(function(i,o){return i._taskLoad>o._taskLoad?-1:1});const r=this.workerPool[this.workerPool.length-1];return r._taskCosts[e]=t,r._taskLoad+=t,r})}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}debug(){console.log("Task load: ",this.workerPool.map(e=>e._taskLoad))}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this}}function mm(){let s,e;onmessage=function(l){const c=l.data;switch(c.type){case"init":s=c.decoderConfig,e=new Promise(function(m){s.onModuleLoaded=function(p){m({draco:p})},DracoDecoderModule(s)});break;case"decode":const u=c.buffer,d=c.taskConfig;e.then(m=>{const p=m.draco,_=new p.Decoder,v=new p.DecoderBuffer;v.Init(new Int8Array(u),u.byteLength);try{const M=t(p,_,v,d),S=M.attributes.map(x=>x.array.buffer);M.index&&S.push(M.index.array.buffer),self.postMessage({type:"decode",id:c.id,geometry:M},S)}catch(M){console.error(M),self.postMessage({type:"error",id:c.id,error:M.message})}finally{p.destroy(v),p.destroy(_)}});break}};function t(l,c,u,d){const m=d.attributeIDs,p=d.attributeTypes;let _,v;const M=c.GetEncodedGeometryType(u);if(M===l.TRIANGULAR_MESH)_=new l.Mesh,v=c.DecodeBufferToMesh(u,_);else if(M===l.POINT_CLOUD)_=new l.PointCloud,v=c.DecodeBufferToPointCloud(u,_);else throw new Error("THREE.DRACOLoader: Unexpected geometry type.");if(!v.ok()||_.ptr===0)throw new Error("THREE.DRACOLoader: Decoding failed: "+v.error_msg());const S={index:null,attributes:[]};for(const x in m){const O=self[p[x]];let P,L;if(d.useUniqueIDs)L=m[x],P=c.GetAttributeByUniqueId(_,L);else{if(L=c.GetAttributeId(_,l[m[x]]),L===-1)continue;P=c.GetAttribute(_,L)}S.attributes.push(i(l,c,_,x,O,P))}return M===l.TRIANGULAR_MESH&&(S.index=r(l,c,_)),l.destroy(_),S}function r(l,c,u){const m=u.num_faces()*3,p=m*4,_=l._malloc(p);c.GetTrianglesUInt32Array(u,p,_);const v=new Uint32Array(l.HEAPF32.buffer,_,m).slice();return l._free(_),{array:v,itemSize:1}}function i(l,c,u,d,m,p){const _=p.num_components(),M=u.num_points()*_,S=M*m.BYTES_PER_ELEMENT,x=o(l,m),O=l._malloc(S);c.GetAttributeDataArrayForAllPoints(u,p,x,S,O);const P=new m(l.HEAPF32.buffer,O,M).slice();return l._free(O),{name:d,array:P,itemSize:_}}function o(l,c){switch(c){case Float32Array:return l.DT_FLOAT32;case Int8Array:return l.DT_INT8;case Int16Array:return l.DT_INT16;case Int32Array:return l.DT_INT32;case Uint8Array:return l.DT_UINT8;case Uint16Array:return l.DT_UINT16;case Uint32Array:return l.DT_UINT32}}}const uc=new f.Box3,os=new f.Vector3;class hc extends f.InstancedBufferGeometry{constructor(){super(),this.isLineSegmentsGeometry=!0,this.type="LineSegmentsGeometry";const e=[-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],t=[-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],r=[0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5];this.setIndex(r),this.setAttribute("position",new f.Float32BufferAttribute(e,3)),this.setAttribute("uv",new f.Float32BufferAttribute(t,2))}applyMatrix4(e){const t=this.attributes.instanceStart,r=this.attributes.instanceEnd;return t!==void 0&&(t.applyMatrix4(e),r.applyMatrix4(e),t.needsUpdate=!0),this.boundingBox!==null&&this.computeBoundingBox(),this.boundingSphere!==null&&this.computeBoundingSphere(),this}setPositions(e){let t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));const r=new f.InstancedInterleavedBuffer(t,6,1);return this.setAttribute("instanceStart",new f.InterleavedBufferAttribute(r,3,0)),this.setAttribute("instanceEnd",new f.InterleavedBufferAttribute(r,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this}setColors(e,t=3){let r;e instanceof Float32Array?r=e:Array.isArray(e)&&(r=new Float32Array(e));const i=new f.InstancedInterleavedBuffer(r,t*2,1);return this.setAttribute("instanceColorStart",new f.InterleavedBufferAttribute(i,t,0)),this.setAttribute("instanceColorEnd",new f.InterleavedBufferAttribute(i,t,t)),this}fromWireframeGeometry(e){return this.setPositions(e.attributes.position.array),this}fromEdgesGeometry(e){return this.setPositions(e.attributes.position.array),this}fromMesh(e){return this.fromWireframeGeometry(new f.WireframeGeometry(e.geometry)),this}fromLineSegments(e){const t=e.geometry;return this.setPositions(t.attributes.position.array),this}computeBoundingBox(){this.boundingBox===null&&(this.boundingBox=new f.Box3);const e=this.attributes.instanceStart,t=this.attributes.instanceEnd;e!==void 0&&t!==void 0&&(this.boundingBox.setFromBufferAttribute(e),uc.setFromBufferAttribute(t),this.boundingBox.union(uc))}computeBoundingSphere(){this.boundingSphere===null&&(this.boundingSphere=new f.Sphere),this.boundingBox===null&&this.computeBoundingBox();const e=this.attributes.instanceStart,t=this.attributes.instanceEnd;if(e!==void 0&&t!==void 0){const r=this.boundingSphere.center;this.boundingBox.getCenter(r);let i=0;for(let o=0,l=e.count;o<l;o++)os.fromBufferAttribute(e,o),i=Math.max(i,r.distanceToSquared(os)),os.fromBufferAttribute(t,o),i=Math.max(i,r.distanceToSquared(os));this.boundingSphere.radius=Math.sqrt(i),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}toJSON(){}applyMatrix(e){return console.warn("THREE.LineSegmentsGeometry: applyMatrix() has been renamed to applyMatrix4()."),this.applyMatrix4(e)}}class as extends hc{constructor(){super(),this.isLineGeometry=!0,this.type="LineGeometry"}setPositions(e){const t=e.length-3,r=new Float32Array(2*t);for(let i=0;i<t;i+=3)r[2*i]=e[i],r[2*i+1]=e[i+1],r[2*i+2]=e[i+2],r[2*i+3]=e[i+3],r[2*i+4]=e[i+4],r[2*i+5]=e[i+5];return super.setPositions(r),this}setColors(e,t=3){const r=e.length-t,i=new Float32Array(2*r);if(t===3)for(let o=0;o<r;o+=t)i[2*o]=e[o],i[2*o+1]=e[o+1],i[2*o+2]=e[o+2],i[2*o+3]=e[o+3],i[2*o+4]=e[o+4],i[2*o+5]=e[o+5];else for(let o=0;o<r;o+=t)i[2*o]=e[o],i[2*o+1]=e[o+1],i[2*o+2]=e[o+2],i[2*o+3]=e[o+3],i[2*o+4]=e[o+4],i[2*o+5]=e[o+5],i[2*o+6]=e[o+6],i[2*o+7]=e[o+7];return super.setColors(i,t),this}fromLine(e){const t=e.geometry;return this.setPositions(t.attributes.position.array),this}}class vn extends f.ShaderMaterial{constructor(e){super({type:"LineMaterial",uniforms:f.UniformsUtils.clone(f.UniformsUtils.merge([f.UniformsLib.common,f.UniformsLib.fog,{worldUnits:{value:1},linewidth:{value:1},resolution:{value:new f.Vector2(1,1)},dashOffset:{value:0},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}}])),vertexShader:`
				#include <common>
				#include <fog_pars_vertex>
				#include <logdepthbuf_pars_vertex>
				#include <clipping_planes_pars_vertex>

				uniform float linewidth;
				uniform vec2 resolution;

				attribute vec3 instanceStart;
				attribute vec3 instanceEnd;

				#ifdef USE_COLOR
					#ifdef USE_LINE_COLOR_ALPHA
						varying vec4 vLineColor;
						attribute vec4 instanceColorStart;
						attribute vec4 instanceColorEnd;
					#else
						varying vec3 vLineColor;
						attribute vec3 instanceColorStart;
						attribute vec3 instanceColorEnd;
					#endif
				#endif

				#ifdef WORLD_UNITS

					varying vec4 worldPos;
					varying vec3 worldStart;
					varying vec3 worldEnd;

					#ifdef USE_DASH

						varying vec2 vUv;

					#endif

				#else

					varying vec2 vUv;

				#endif

				#ifdef USE_DASH

					uniform float dashScale;
					attribute float instanceDistanceStart;
					attribute float instanceDistanceEnd;
					varying float vLineDistance;

				#endif

				void trimSegment( const in vec4 start, inout vec4 end ) {

					// trim end segment so it terminates between the camera plane and the near plane

					// conservative estimate of the near plane
					float a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column
					float b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column
					float nearEstimate = - 0.5 * b / a;

					float alpha = ( nearEstimate - start.z ) / ( end.z - start.z );

					end.xyz = mix( start.xyz, end.xyz, alpha );

				}

				void main() {

					#ifdef USE_COLOR

						vLineColor = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;

					#endif

					#ifdef USE_DASH

						vLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;
						vUv = uv;

					#endif

					float aspect = resolution.x / resolution.y;

					// camera space
					vec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );
					vec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );

					#ifdef WORLD_UNITS

						worldStart = start.xyz;
						worldEnd = end.xyz;

					#else

						vUv = uv;

					#endif

					// special case for perspective projection, and segments that terminate either in, or behind, the camera plane
					// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space
					// but we need to perform ndc-space calculations in the shader, so we must address this issue directly
					// perhaps there is a more elegant solution -- WestLangley

					bool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column

					if ( perspective ) {

						if ( start.z < 0.0 && end.z >= 0.0 ) {

							trimSegment( start, end );

						} else if ( end.z < 0.0 && start.z >= 0.0 ) {

							trimSegment( end, start );

						}

					}

					// clip space
					vec4 clipStart = projectionMatrix * start;
					vec4 clipEnd = projectionMatrix * end;

					// ndc space
					vec3 ndcStart = clipStart.xyz / clipStart.w;
					vec3 ndcEnd = clipEnd.xyz / clipEnd.w;

					// direction
					vec2 dir = ndcEnd.xy - ndcStart.xy;

					// account for clip-space aspect ratio
					dir.x *= aspect;
					dir = normalize( dir );

					#ifdef WORLD_UNITS

						// get the offset direction as perpendicular to the view vector
						vec3 worldDir = normalize( end.xyz - start.xyz );
						vec3 offset;
						if ( position.y < 0.5 ) {

							offset = normalize( cross( start.xyz, worldDir ) );

						} else {

							offset = normalize( cross( end.xyz, worldDir ) );

						}

						// sign flip
						if ( position.x < 0.0 ) offset *= - 1.0;

						float forwardOffset = dot( worldDir, vec3( 0.0, 0.0, 1.0 ) );

						// don't extend the line if we're rendering dashes because we
						// won't be rendering the endcaps
						#ifndef USE_DASH

							// extend the line bounds to encompass  endcaps
							start.xyz += - worldDir * linewidth * 0.5;
							end.xyz += worldDir * linewidth * 0.5;

							// shift the position of the quad so it hugs the forward edge of the line
							offset.xy -= dir * forwardOffset;
							offset.z += 0.5;

						#endif

						// endcaps
						if ( position.y > 1.0 || position.y < 0.0 ) {

							offset.xy += dir * 2.0 * forwardOffset;

						}

						// adjust for linewidth
						offset *= linewidth * 0.5;

						// set the world position
						worldPos = ( position.y < 0.5 ) ? start : end;
						worldPos.xyz += offset;

						// project the worldpos
						vec4 clip = projectionMatrix * worldPos;

						// shift the depth of the projected points so the line
						// segments overlap neatly
						vec3 clipPose = ( position.y < 0.5 ) ? ndcStart : ndcEnd;
						clip.z = clipPose.z * clip.w;

					#else

						vec2 offset = vec2( dir.y, - dir.x );
						// undo aspect ratio adjustment
						dir.x /= aspect;
						offset.x /= aspect;

						// sign flip
						if ( position.x < 0.0 ) offset *= - 1.0;

						// endcaps
						if ( position.y < 0.0 ) {

							offset += - dir;

						} else if ( position.y > 1.0 ) {

							offset += dir;

						}

						// adjust for linewidth
						offset *= linewidth;

						// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...
						offset /= resolution.y;

						// select end
						vec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;

						// back to clip space
						offset *= clip.w;

						clip.xy += offset;

					#endif

					gl_Position = clip;

					vec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation

					#include <logdepthbuf_vertex>
					#include <clipping_planes_vertex>
					#include <fog_vertex>

				}
			`,fragmentShader:`
				uniform vec3 diffuse;
				uniform float opacity;
				uniform float linewidth;

				#ifdef USE_DASH

					uniform float dashOffset;
					uniform float dashSize;
					uniform float gapSize;

				#endif

				varying float vLineDistance;

				#ifdef WORLD_UNITS

					varying vec4 worldPos;
					varying vec3 worldStart;
					varying vec3 worldEnd;

					#ifdef USE_DASH

						varying vec2 vUv;

					#endif

				#else

					varying vec2 vUv;

				#endif

				#include <common>
				#include <fog_pars_fragment>
				#include <logdepthbuf_pars_fragment>
				#include <clipping_planes_pars_fragment>

				#ifdef USE_COLOR
					#ifdef USE_LINE_COLOR_ALPHA
						varying vec4 vLineColor;
					#else
						varying vec3 vLineColor;
					#endif
				#endif

				vec2 closestLineToLine(vec3 p1, vec3 p2, vec3 p3, vec3 p4) {

					float mua;
					float mub;

					vec3 p13 = p1 - p3;
					vec3 p43 = p4 - p3;

					vec3 p21 = p2 - p1;

					float d1343 = dot( p13, p43 );
					float d4321 = dot( p43, p21 );
					float d1321 = dot( p13, p21 );
					float d4343 = dot( p43, p43 );
					float d2121 = dot( p21, p21 );

					float denom = d2121 * d4343 - d4321 * d4321;

					float numer = d1343 * d4321 - d1321 * d4343;

					mua = numer / denom;
					mua = clamp( mua, 0.0, 1.0 );
					mub = ( d1343 + d4321 * ( mua ) ) / d4343;
					mub = clamp( mub, 0.0, 1.0 );

					return vec2( mua, mub );

				}

				void main() {

					#include <clipping_planes_fragment>

					#ifdef USE_DASH

						if ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps

						if ( mod( vLineDistance + dashOffset, dashSize + gapSize ) > dashSize ) discard; // todo - FIX

					#endif

					float alpha = opacity;

					#ifdef WORLD_UNITS

						// Find the closest points on the view ray and the line segment
						vec3 rayEnd = normalize( worldPos.xyz ) * 1e5;
						vec3 lineDir = worldEnd - worldStart;
						vec2 params = closestLineToLine( worldStart, worldEnd, vec3( 0.0, 0.0, 0.0 ), rayEnd );

						vec3 p1 = worldStart + lineDir * params.x;
						vec3 p2 = rayEnd * params.y;
						vec3 delta = p1 - p2;
						float len = length( delta );
						float norm = len / linewidth;

						#ifndef USE_DASH

							#ifdef USE_ALPHA_TO_COVERAGE

								float dnorm = fwidth( norm );
								alpha = 1.0 - smoothstep( 0.5 - dnorm, 0.5 + dnorm, norm );

							#else

								if ( norm > 0.5 ) {

									discard;

								}

							#endif

						#endif

					#else

						#ifdef USE_ALPHA_TO_COVERAGE

							// artifacts appear on some hardware if a derivative is taken within a conditional
							float a = vUv.x;
							float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
							float len2 = a * a + b * b;
							float dlen = fwidth( len2 );

							if ( abs( vUv.y ) > 1.0 ) {

								alpha = 1.0 - smoothstep( 1.0 - dlen, 1.0 + dlen, len2 );

							}

						#else

							if ( abs( vUv.y ) > 1.0 ) {

								float a = vUv.x;
								float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
								float len2 = a * a + b * b;

								if ( len2 > 1.0 ) discard;

							}

						#endif

					#endif

					vec4 diffuseColor = vec4( diffuse, alpha );
					#ifdef USE_COLOR
						#ifdef USE_LINE_COLOR_ALPHA
							diffuseColor *= vLineColor;
						#else
							diffuseColor.rgb *= vLineColor;
						#endif
					#endif

					#include <logdepthbuf_fragment>

					gl_FragColor = diffuseColor;

					#include <tonemapping_fragment>
					#include <${rs>=154?"colorspace_fragment":"encodings_fragment"}>
					#include <fog_fragment>
					#include <premultiplied_alpha_fragment>

				}
			`,clipping:!0}),this.isLineMaterial=!0,this.onBeforeCompile=function(){this.transparent?this.defines.USE_LINE_COLOR_ALPHA="1":delete this.defines.USE_LINE_COLOR_ALPHA},Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(t){this.uniforms.diffuse.value=t}},worldUnits:{enumerable:!0,get:function(){return"WORLD_UNITS"in this.defines},set:function(t){t===!0?this.defines.WORLD_UNITS="":delete this.defines.WORLD_UNITS}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(t){this.uniforms.linewidth.value=t}},dashed:{enumerable:!0,get:function(){return"USE_DASH"in this.defines},set(t){!!t!="USE_DASH"in this.defines&&(this.needsUpdate=!0),t===!0?this.defines.USE_DASH="":delete this.defines.USE_DASH}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(t){this.uniforms.dashScale.value=t}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(t){this.uniforms.dashSize.value=t}},dashOffset:{enumerable:!0,get:function(){return this.uniforms.dashOffset.value},set:function(t){this.uniforms.dashOffset.value=t}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(t){this.uniforms.gapSize.value=t}},opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(t){this.uniforms.opacity.value=t}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(t){this.uniforms.resolution.value.copy(t)}},alphaToCoverage:{enumerable:!0,get:function(){return"USE_ALPHA_TO_COVERAGE"in this.defines},set:function(t){!!t!="USE_ALPHA_TO_COVERAGE"in this.defines&&(this.needsUpdate=!0),t===!0?(this.defines.USE_ALPHA_TO_COVERAGE="",this.extensions.derivatives=!0):(delete this.defines.USE_ALPHA_TO_COVERAGE,this.extensions.derivatives=!1)}}}),this.setValues(e)}}const Ro=new f.Vector4,fc=new f.Vector3,dc=new f.Vector3,Ke=new f.Vector4,qe=new f.Vector4,ar=new f.Vector4,Wo=new f.Vector3,Go=new f.Matrix4,Qe=new f.Line3,pc=new f.Vector3,ls=new f.Box3,cs=new f.Sphere,lr=new f.Vector4;let cr,ci;function mc(s,e,t){return lr.set(0,0,-e,1).applyMatrix4(s.projectionMatrix),lr.multiplyScalar(1/lr.w),lr.x=ci/t.width,lr.y=ci/t.height,lr.applyMatrix4(s.projectionMatrixInverse),lr.multiplyScalar(1/lr.w),Math.abs(Math.max(lr.x,lr.y))}function gm(s,e){const t=s.matrixWorld,r=s.geometry,i=r.attributes.instanceStart,o=r.attributes.instanceEnd,l=Math.min(r.instanceCount,i.count);for(let c=0,u=l;c<u;c++){Qe.start.fromBufferAttribute(i,c),Qe.end.fromBufferAttribute(o,c),Qe.applyMatrix4(t);const d=new f.Vector3,m=new f.Vector3;cr.distanceSqToSegment(Qe.start,Qe.end,m,d),m.distanceTo(d)<ci*.5&&e.push({point:m,pointOnLine:d,distance:cr.origin.distanceTo(m),object:s,face:null,faceIndex:c,uv:null,[Ao]:null})}}function _m(s,e,t){const r=e.projectionMatrix,o=s.material.resolution,l=s.matrixWorld,c=s.geometry,u=c.attributes.instanceStart,d=c.attributes.instanceEnd,m=Math.min(c.instanceCount,u.count),p=-e.near;cr.at(1,ar),ar.w=1,ar.applyMatrix4(e.matrixWorldInverse),ar.applyMatrix4(r),ar.multiplyScalar(1/ar.w),ar.x*=o.x/2,ar.y*=o.y/2,ar.z=0,Wo.copy(ar),Go.multiplyMatrices(e.matrixWorldInverse,l);for(let _=0,v=m;_<v;_++){if(Ke.fromBufferAttribute(u,_),qe.fromBufferAttribute(d,_),Ke.w=1,qe.w=1,Ke.applyMatrix4(Go),qe.applyMatrix4(Go),Ke.z>p&&qe.z>p)continue;if(Ke.z>p){const L=Ke.z-qe.z,F=(Ke.z-p)/L;Ke.lerp(qe,F)}else if(qe.z>p){const L=qe.z-Ke.z,F=(qe.z-p)/L;qe.lerp(Ke,F)}Ke.applyMatrix4(r),qe.applyMatrix4(r),Ke.multiplyScalar(1/Ke.w),qe.multiplyScalar(1/qe.w),Ke.x*=o.x/2,Ke.y*=o.y/2,qe.x*=o.x/2,qe.y*=o.y/2,Qe.start.copy(Ke),Qe.start.z=0,Qe.end.copy(qe),Qe.end.z=0;const S=Qe.closestPointToPointParameter(Wo,!0);Qe.at(S,pc);const x=f.MathUtils.lerp(Ke.z,qe.z,S),O=x>=-1&&x<=1,P=Wo.distanceTo(pc)<ci*.5;if(O&&P){Qe.start.fromBufferAttribute(u,_),Qe.end.fromBufferAttribute(d,_),Qe.start.applyMatrix4(l),Qe.end.applyMatrix4(l);const L=new f.Vector3,F=new f.Vector3;cr.distanceSqToSegment(Qe.start,Qe.end,F,L),t.push({point:F,pointOnLine:L,distance:cr.origin.distanceTo(F),object:s,face:null,faceIndex:_,uv:null,[Ao]:null})}}}class ym extends f.Mesh{constructor(e=new hc,t=new vn({color:Math.random()*16777215})){super(e,t),this.isLineSegments2=!0,this.type="LineSegments2"}computeLineDistances(){const e=this.geometry,t=e.attributes.instanceStart,r=e.attributes.instanceEnd,i=new Float32Array(2*t.count);for(let l=0,c=0,u=t.count;l<u;l++,c+=2)fc.fromBufferAttribute(t,l),dc.fromBufferAttribute(r,l),i[c]=c===0?0:i[c-1],i[c+1]=i[c]+fc.distanceTo(dc);const o=new f.InstancedInterleavedBuffer(i,2,1);return e.setAttribute("instanceDistanceStart",new f.InterleavedBufferAttribute(o,1,0)),e.setAttribute("instanceDistanceEnd",new f.InterleavedBufferAttribute(o,1,1)),this}raycast(e,t){const r=this.material.worldUnits,i=e.camera;i===null&&!r&&console.error('LineSegments2: "Raycaster.camera" needs to be set in order to raycast against LineSegments2 while worldUnits is set to false.');const o=e.params.Line2!==void 0&&e.params.Line2.threshold||0;cr=e.ray;const l=this.matrixWorld,c=this.geometry,u=this.material;ci=u.linewidth+o,c.boundingSphere===null&&c.computeBoundingSphere(),cs.copy(c.boundingSphere).applyMatrix4(l);let d;if(r)d=ci*.5;else{const p=Math.max(i.near,cs.distanceToPoint(cr.origin));d=mc(i,p,u.resolution)}if(cs.radius+=d,cr.intersectsSphere(cs)===!1)return;c.boundingBox===null&&c.computeBoundingBox(),ls.copy(c.boundingBox).applyMatrix4(l);let m;if(r)m=ci*.5;else{const p=Math.max(i.near,ls.distanceToPoint(cr.origin));m=mc(i,p,u.resolution)}ls.expandByScalar(m),cr.intersectsBox(ls)!==!1&&(r?gm(this,t):_m(this,i,t))}onBeforeRender(e){const t=this.material.uniforms;t&&t.resolution&&(e.getViewport(Ro),this.material.uniforms.resolution.value.set(Ro.z,Ro.w))}}class us extends ym{constructor(e=new as,t=new vn({color:Math.random()*16777215})){super(e,t),this.isLine2=!0,this.type="Line2"}}var Vr=Object.freeze({Linear:Object.freeze({None:function(s){return s},In:function(s){return this.None(s)},Out:function(s){return this.None(s)},InOut:function(s){return this.None(s)}}),Quadratic:Object.freeze({In:function(s){return s*s},Out:function(s){return s*(2-s)},InOut:function(s){return(s*=2)<1?.5*s*s:-.5*(--s*(s-2)-1)}}),Cubic:Object.freeze({In:function(s){return s*s*s},Out:function(s){return--s*s*s+1},InOut:function(s){return(s*=2)<1?.5*s*s*s:.5*((s-=2)*s*s+2)}}),Quartic:Object.freeze({In:function(s){return s*s*s*s},Out:function(s){return 1- --s*s*s*s},InOut:function(s){return(s*=2)<1?.5*s*s*s*s:-.5*((s-=2)*s*s*s-2)}}),Quintic:Object.freeze({In:function(s){return s*s*s*s*s},Out:function(s){return--s*s*s*s*s+1},InOut:function(s){return(s*=2)<1?.5*s*s*s*s*s:.5*((s-=2)*s*s*s*s+2)}}),Sinusoidal:Object.freeze({In:function(s){return 1-Math.sin((1-s)*Math.PI/2)},Out:function(s){return Math.sin(s*Math.PI/2)},InOut:function(s){return .5*(1-Math.sin(Math.PI*(.5-s)))}}),Exponential:Object.freeze({In:function(s){return s===0?0:Math.pow(1024,s-1)},Out:function(s){return s===1?1:1-Math.pow(2,-10*s)},InOut:function(s){return s===0?0:s===1?1:(s*=2)<1?.5*Math.pow(1024,s-1):.5*(-Math.pow(2,-10*(s-1))+2)}}),Circular:Object.freeze({In:function(s){return 1-Math.sqrt(1-s*s)},Out:function(s){return Math.sqrt(1- --s*s)},InOut:function(s){return(s*=2)<1?-.5*(Math.sqrt(1-s*s)-1):.5*(Math.sqrt(1-(s-=2)*s)+1)}}),Elastic:Object.freeze({In:function(s){return s===0?0:s===1?1:-Math.pow(2,10*(s-1))*Math.sin((s-1.1)*5*Math.PI)},Out:function(s){return s===0?0:s===1?1:Math.pow(2,-10*s)*Math.sin((s-.1)*5*Math.PI)+1},InOut:function(s){return s===0?0:s===1?1:(s*=2,s<1?-.5*Math.pow(2,10*(s-1))*Math.sin((s-1.1)*5*Math.PI):.5*Math.pow(2,-10*(s-1))*Math.sin((s-1.1)*5*Math.PI)+1)}}),Back:Object.freeze({In:function(s){var e=1.70158;return s===1?1:s*s*((e+1)*s-e)},Out:function(s){var e=1.70158;return s===0?0:--s*s*((e+1)*s+e)+1},InOut:function(s){var e=2.5949095;return(s*=2)<1?.5*(s*s*((e+1)*s-e)):.5*((s-=2)*s*((e+1)*s+e)+2)}}),Bounce:Object.freeze({In:function(s){return 1-Vr.Bounce.Out(1-s)},Out:function(s){return s<1/2.75?7.5625*s*s:s<2/2.75?7.5625*(s-=1.5/2.75)*s+.75:s<2.5/2.75?7.5625*(s-=2.25/2.75)*s+.9375:7.5625*(s-=2.625/2.75)*s+.984375},InOut:function(s){return s<.5?Vr.Bounce.In(s*2)*.5:Vr.Bounce.Out(s*2-1)*.5+.5}}),generatePow:function(s){return s===void 0&&(s=4),s=s<Number.EPSILON?Number.EPSILON:s,s=s>1e4?1e4:s,{In:function(e){return Math.pow(e,s)},Out:function(e){return 1-Math.pow(1-e,s)},InOut:function(e){return e<.5?Math.pow(e*2,s)/2:(1-Math.pow(2-e*2,s))/2+.5}}}}),wn=function(){return performance.now()},vm=(function(){function s(){this._tweens={},this._tweensAddedDuringUpdate={}}return s.prototype.getAll=function(){var e=this;return Object.keys(this._tweens).map(function(t){return e._tweens[t]})},s.prototype.removeAll=function(){this._tweens={}},s.prototype.add=function(e){this._tweens[e.getId()]=e,this._tweensAddedDuringUpdate[e.getId()]=e},s.prototype.remove=function(e){delete this._tweens[e.getId()],delete this._tweensAddedDuringUpdate[e.getId()]},s.prototype.update=function(e,t){e===void 0&&(e=wn()),t===void 0&&(t=!1);var r=Object.keys(this._tweens);if(r.length===0)return!1;for(;r.length>0;){this._tweensAddedDuringUpdate={};for(var i=0;i<r.length;i++){var o=this._tweens[r[i]],l=!t;o&&o.update(e,l)===!1&&!t&&delete this._tweens[r[i]]}r=Object.keys(this._tweensAddedDuringUpdate)}return!0},s})(),$o={Linear:function(s,e){var t=s.length-1,r=t*e,i=Math.floor(r),o=$o.Utils.Linear;return e<0?o(s[0],s[1],r):e>1?o(s[t],s[t-1],t-r):o(s[i],s[i+1>t?t:i+1],r-i)},Utils:{Linear:function(s,e,t){return(e-s)*t+s}}},gc=(function(){function s(){}return s.nextId=function(){return s._nextId++},s._nextId=0,s})(),jo=new vm,hs=(function(){function s(e,t){t===void 0&&(t=jo),this._object=e,this._group=t,this._isPaused=!1,this._pauseStart=0,this._valuesStart={},this._valuesEnd={},this._valuesStartRepeat={},this._duration=1e3,this._isDynamic=!1,this._initialRepeat=0,this._repeat=0,this._yoyo=!1,this._isPlaying=!1,this._reversed=!1,this._delayTime=0,this._startTime=0,this._easingFunction=Vr.Linear.None,this._interpolationFunction=$o.Linear,this._chainedTweens=[],this._onStartCallbackFired=!1,this._onEveryStartCallbackFired=!1,this._id=gc.nextId(),this._isChainStopped=!1,this._propertiesAreSetUp=!1,this._goToEnd=!1}return s.prototype.getId=function(){return this._id},s.prototype.isPlaying=function(){return this._isPlaying},s.prototype.isPaused=function(){return this._isPaused},s.prototype.getDuration=function(){return this._duration},s.prototype.to=function(e,t){if(t===void 0&&(t=1e3),this._isPlaying)throw new Error("Can not call Tween.to() while Tween is already started or paused. Stop the Tween first.");return this._valuesEnd=e,this._propertiesAreSetUp=!1,this._duration=t<0?0:t,this},s.prototype.duration=function(e){return e===void 0&&(e=1e3),this._duration=e<0?0:e,this},s.prototype.dynamic=function(e){return e===void 0&&(e=!1),this._isDynamic=e,this},s.prototype.start=function(e,t){if(e===void 0&&(e=wn()),t===void 0&&(t=!1),this._isPlaying)return this;if(this._group&&this._group.add(this),this._repeat=this._initialRepeat,this._reversed){this._reversed=!1;for(var r in this._valuesStartRepeat)this._swapEndStartRepeatValues(r),this._valuesStart[r]=this._valuesStartRepeat[r]}if(this._isPlaying=!0,this._isPaused=!1,this._onStartCallbackFired=!1,this._onEveryStartCallbackFired=!1,this._isChainStopped=!1,this._startTime=e,this._startTime+=this._delayTime,!this._propertiesAreSetUp||t){if(this._propertiesAreSetUp=!0,!this._isDynamic){var i={};for(var o in this._valuesEnd)i[o]=this._valuesEnd[o];this._valuesEnd=i}this._setupProperties(this._object,this._valuesStart,this._valuesEnd,this._valuesStartRepeat,t)}return this},s.prototype.startFromCurrentValues=function(e){return this.start(e,!0)},s.prototype._setupProperties=function(e,t,r,i,o){for(var l in r){var c=e[l],u=Array.isArray(c),d=u?"array":typeof c,m=!u&&Array.isArray(r[l]);if(!(d==="undefined"||d==="function")){if(m){var p=r[l];if(p.length===0)continue;for(var _=[c],v=0,M=p.length;v<M;v+=1){var S=this._handleRelativeValue(c,p[v]);if(isNaN(S)){m=!1,console.warn("Found invalid interpolation list. Skipping.");break}_.push(S)}m&&(r[l]=_)}if((d==="object"||u)&&c&&!m){t[l]=u?[]:{};var x=c;for(var O in x)t[l][O]=x[O];i[l]=u?[]:{};var p=r[l];if(!this._isDynamic){var P={};for(var O in p)P[O]=p[O];r[l]=p=P}this._setupProperties(x,t[l],p,i[l],o)}else(typeof t[l]>"u"||o)&&(t[l]=c),u||(t[l]*=1),m?i[l]=r[l].slice().reverse():i[l]=t[l]||0}}},s.prototype.stop=function(){return this._isChainStopped||(this._isChainStopped=!0,this.stopChainedTweens()),this._isPlaying?(this._group&&this._group.remove(this),this._isPlaying=!1,this._isPaused=!1,this._onStopCallback&&this._onStopCallback(this._object),this):this},s.prototype.end=function(){return this._goToEnd=!0,this.update(1/0),this},s.prototype.pause=function(e){return e===void 0&&(e=wn()),this._isPaused||!this._isPlaying?this:(this._isPaused=!0,this._pauseStart=e,this._group&&this._group.remove(this),this)},s.prototype.resume=function(e){return e===void 0&&(e=wn()),!this._isPaused||!this._isPlaying?this:(this._isPaused=!1,this._startTime+=e-this._pauseStart,this._pauseStart=0,this._group&&this._group.add(this),this)},s.prototype.stopChainedTweens=function(){for(var e=0,t=this._chainedTweens.length;e<t;e++)this._chainedTweens[e].stop();return this},s.prototype.group=function(e){return e===void 0&&(e=jo),this._group=e,this},s.prototype.delay=function(e){return e===void 0&&(e=0),this._delayTime=e,this},s.prototype.repeat=function(e){return e===void 0&&(e=0),this._initialRepeat=e,this._repeat=e,this},s.prototype.repeatDelay=function(e){return this._repeatDelayTime=e,this},s.prototype.yoyo=function(e){return e===void 0&&(e=!1),this._yoyo=e,this},s.prototype.easing=function(e){return e===void 0&&(e=Vr.Linear.None),this._easingFunction=e,this},s.prototype.interpolation=function(e){return e===void 0&&(e=$o.Linear),this._interpolationFunction=e,this},s.prototype.chain=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this._chainedTweens=e,this},s.prototype.onStart=function(e){return this._onStartCallback=e,this},s.prototype.onEveryStart=function(e){return this._onEveryStartCallback=e,this},s.prototype.onUpdate=function(e){return this._onUpdateCallback=e,this},s.prototype.onRepeat=function(e){return this._onRepeatCallback=e,this},s.prototype.onComplete=function(e){return this._onCompleteCallback=e,this},s.prototype.onStop=function(e){return this._onStopCallback=e,this},s.prototype.update=function(e,t){var r=this,i;if(e===void 0&&(e=wn()),t===void 0&&(t=!0),this._isPaused)return!0;var o,l=this._startTime+this._duration;if(!this._goToEnd&&!this._isPlaying){if(e>l)return!1;t&&this.start(e,!0)}if(this._goToEnd=!1,e<this._startTime)return!0;this._onStartCallbackFired===!1&&(this._onStartCallback&&this._onStartCallback(this._object),this._onStartCallbackFired=!0),this._onEveryStartCallbackFired===!1&&(this._onEveryStartCallback&&this._onEveryStartCallback(this._object),this._onEveryStartCallbackFired=!0);var c=e-this._startTime,u=this._duration+((i=this._repeatDelayTime)!==null&&i!==void 0?i:this._delayTime),d=this._duration+this._repeat*u,m=function(){if(r._duration===0||c>d)return 1;var x=Math.trunc(c/u),O=c-x*u,P=Math.min(O/r._duration,1);return P===0&&c===r._duration?1:P},p=m(),_=this._easingFunction(p);if(this._updateProperties(this._object,this._valuesStart,this._valuesEnd,_),this._onUpdateCallback&&this._onUpdateCallback(this._object,p),this._duration===0||c>=this._duration)if(this._repeat>0){var v=Math.min(Math.trunc((c-this._duration)/u)+1,this._repeat);isFinite(this._repeat)&&(this._repeat-=v);for(o in this._valuesStartRepeat)!this._yoyo&&typeof this._valuesEnd[o]=="string"&&(this._valuesStartRepeat[o]=this._valuesStartRepeat[o]+parseFloat(this._valuesEnd[o])),this._yoyo&&this._swapEndStartRepeatValues(o),this._valuesStart[o]=this._valuesStartRepeat[o];return this._yoyo&&(this._reversed=!this._reversed),this._startTime+=u*v,this._onRepeatCallback&&this._onRepeatCallback(this._object),this._onEveryStartCallbackFired=!1,!0}else{this._onCompleteCallback&&this._onCompleteCallback(this._object);for(var M=0,S=this._chainedTweens.length;M<S;M++)this._chainedTweens[M].start(this._startTime+this._duration,!1);return this._isPlaying=!1,!1}return!0},s.prototype._updateProperties=function(e,t,r,i){for(var o in r)if(t[o]!==void 0){var l=t[o]||0,c=r[o],u=Array.isArray(e[o]),d=Array.isArray(c),m=!u&&d;m?e[o]=this._interpolationFunction(c,i):typeof c=="object"&&c?this._updateProperties(e[o],l,c,i):(c=this._handleRelativeValue(l,c),typeof c=="number"&&(e[o]=l+(c-l)*i))}},s.prototype._handleRelativeValue=function(e,t){return typeof t!="string"?t:t.charAt(0)==="+"||t.charAt(0)==="-"?e+parseFloat(t):parseFloat(t)},s.prototype._swapEndStartRepeatValues=function(e){var t=this._valuesStartRepeat[e],r=this._valuesEnd[e];typeof r=="string"?this._valuesStartRepeat[e]=this._valuesStartRepeat[e]+parseFloat(r):this._valuesStartRepeat[e]=this._valuesEnd[e],this._valuesEnd[e]=t},s})();gc.nextId;var ur=jo;ur.getAll.bind(ur),ur.removeAll.bind(ur),ur.add.bind(ur),ur.remove.bind(ur);var wm=ur.update.bind(ur);function Xo(s,e,t){if(s==null||s==="")throw new Error(t||`Parameter "${e}" is required but received: ${s}`);return s}function Yo(s,e,t){const r=e.split(".");let i=s;for(const o of r){if(i[o]===void 0||i[o]===null)throw new Error(`Property "${e}" is required but missing at path: "${o}"`);i=i[o]}return i}function bm(s,e,t,r=0,i=1){const o=(s-e)*(i-r)/(t-e)+r,l=Math.min(r,i),c=Math.max(r,i);return o<l?l:o>c?c:o||0}var xm=Object.defineProperty,Mm=(s,e,t)=>e in s?xm(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,_c=(s,e,t)=>Mm(s,typeof e!="symbol"?e+"":e,t);class Zo{constructor(){_c(this,"_dispatcher",new f.EventDispatcher),_c(this,"_listenerMap",new Map)}on(e,t){const r=i=>t(i.data||i);return this._listenerMap.has(e)||this._listenerMap.set(e,new Map),this._listenerMap.get(e).set(t,r),this._dispatcher.addEventListener(e,r),this}once(e,t){const r=i=>{this.off(e,r),t(i.data||i)};return this.on(e,r)}off(e,t){const r=this._listenerMap.get(e);if(!r)return this;const i=r.get(t);return i&&(this._dispatcher.removeEventListener(e,i),r.delete(t),r.size===0&&this._listenerMap.delete(e)),this}fire(e,t){const r={type:e,data:t};return this._dispatcher.dispatchEvent(r),this}get threeEventDispatcher(){return this._dispatcher}}function yc(s,e){return s.replace(/\{(\w+)\}/g,(t,r)=>{if(Object.prototype.hasOwnProperty.call(e,r)){const i=e[r];return i!==void 0?String(i):t}throw new Error(`Missing required parameter for template interpolation: "${r}"`)})}function Ko(s,...e){return Object.assign(s,...e)}function vc(s){return s==null}function bn(s){return typeof s=="function"}function Sm(s=new Date){const e=u=>u.toString().padStart(2,"0"),t=s.getFullYear(),r=e(s.getMonth()+1),i=e(s.getDate()),o=e(s.getHours()),l=e(s.getMinutes()),c=e(s.getSeconds());return`${t}-${r}-${i} ${o}:${l}:${c}`}var Am=Object.defineProperty,Pm=(s,e,t)=>e in s?Am(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,qo=(s,e,t)=>Pm(s,typeof e!="symbol"?e+"":e,t);class Lm{}class fs extends zr(ui(Lm)){constructor(e){super(),qo(this,"target"),qo(this,"dom"),qo(this,"_enabled",!1),this.target=e}enable(){return this._enabled?this:(this._enabled=!0,this.addHooks(),this)}disable(){return this._enabled?(this._enabled=!1,this.removeHooks(),this):this}enabled(){return!!this._enabled}remove(){this.disable(),delete this.target,delete this.dom}}const Qo=Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]"&&!process.versions.electron&&!process.versions.nw&&!process.versions["node-webkit"],wc=()=>typeof window>"u"?1:window.devicePixelRatio||window.screen.deviceXDPI/window.screen.logicalXDPI||1,Cm=(()=>{if(Qo)return{IS_NODE:Qo,isTest:!1,ie:!1,ielt9:!1,edge:!1,webkit:!1,gecko:!1,android:!1,android23:!1,chrome:!1,chromeVersion:"0",safari:!1,phantomjs:!1,ie3d:!1,webkit3d:!1,opera12:!1,gecko3d:!1,any3d:!1,iosWeixin:!1,mobile:!1,mobileWebkit:!1,mobileWebkit3d:!1,mobileOpera:!1,mobileGecko:!1,touch:!1,msPointer:!1,pointer:!1,retina:!1,devicePixelRatio:1,language:"en",ie9:!1,ie10:!1,webgl:!1,imageBitMap:!1,resizeObserver:!1,btoa:!1,decodeImageInWorker:!1,monitorDPRChange:!1,supportsPassive:!1,proxy:!1,requestIdleCallback:!1,checkDevicePixelRatio:()=>!1};const s=navigator.userAgent.toLowerCase(),e=document.documentElement||{style:{}},t="ActiveXObject"in window,r=s.includes("webkit"),i=s.includes("phantom"),o=s.search("android [23]")!==-1,l=s.includes("chrome"),c=s.includes("gecko")&&!r&&!("opera"in window)&&!t,u=/iphone/i.test(s)&&/micromessenger/i.test(s),d=typeof orientation<"u"||s.includes("mobile"),m=!window.PointerEvent&&"MSPointerEvent"in window,p=window.PointerEvent&&navigator.pointerEnabled||m,_=t&&"transition"in e.style,v="WebKitCSSMatrix"in window&&"m11"in new window.WebKitCSSMatrix&&!o,M="MozPerspective"in e.style,S="OTransition"in e.style,x=(_||v||M)&&!S&&!i,O=typeof window<"u"&&bn(window.createImageBitmap),P=typeof window<"u"&&bn(window.ResizeObserver),L=typeof window<"u"&&bn(window.btoa),F=typeof window<"u"&&bn(window.Proxy),z=typeof window<"u"&&bn(window.requestIdleCallback);let j="0";if(l){const E=s.match(/chrome\/([\d.]+)/);j=E?E[1]:"0"}const G=!i&&(p||"ontouchstart"in window||"DocumentTouch"in window&&document instanceof window.DocumentTouch),U=typeof window<"u"&&"WebGLRenderingContext"in window,X=wc();let N=!1;try{new OffscreenCanvas(2,2).getContext("2d"),N=!0}catch{N=!1}let k=!1;try{const E=Object.defineProperty({},"passive",{get:()=>(k=!0,!0)});window.addEventListener("testPassive",()=>{},E)}catch{}const Z={IS_NODE:Qo,isTest:!1,ie:t,ielt9:t&&!document.addEventListener,edge:"msLaunchUri"in navigator&&!("documentMode"in document),webkit:r,gecko:c,android:s.includes("android"),android23:o,chrome:l,chromeVersion:j,safari:!l&&s.includes("safari"),phantomjs:i,ie3d:_,webkit3d:v,gecko3d:M,opera12:S,any3d:x,iosWeixin:u,mobile:d,mobileWebkit:d&&r,mobileWebkit3d:d&&v,mobileOpera:d&&"opera"in window,mobileGecko:d&&c,touch:!!G,msPointer:!!m,pointer:!!p,retina:X>1,devicePixelRatio:X,language:navigator.browserLanguage||navigator.language,ie9:t&&document.documentMode===9,ie10:t&&document.documentMode===10,webgl:U,imageBitMap:O,resizeObserver:P,btoa:L,decodeImageInWorker:N,monitorDPRChange:!0,supportsPassive:k,proxy:F,requestIdleCallback:z,checkDevicePixelRatio:()=>{if(typeof window<"u"&&Z.monitorDPRChange){const E=wc(),q=E!==Z.devicePixelRatio;return q&&(Z.devicePixelRatio=E),q}return!1}};return Z})();var Om=Object.defineProperty,Tm=(s,e,t)=>e in s?Om(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,kr=(s,e,t)=>Tm(s,typeof e!="symbol"?e+"":e,t);function zr(s){return class extends s{constructor(...e){super(...e),kr(this,"eventClass",new Zo),kr(this,"on",this.eventClass.on.bind(this.eventClass)),kr(this,"fire",this.eventClass.fire.bind(this.eventClass)),kr(this,"off",this.eventClass.off.bind(this.eventClass)),this.eventClass=new Zo}}}function ui(s){return class extends s{constructor(...e){super(...e),kr(this,"options"),kr(this,"_isUpdatingOptions"),kr(this,"_initHooksCalled"),kr(this,"_initHooks");const t=Object.getPrototypeOf(this).options||{},r=Ko({},t,e[0]||{});this.setOptions(r),this._callInitHooks(),this._isUpdatingOptions=!1}_proxyOptions(){return Cm.proxy?(this.options=new Proxy(this.options,{set:(e,t,r)=>{if(t=t,e[t]===r||(e[t]=r,this._isUpdatingOptions))return!0;const i={};return i[t]=r,this.configure(i),!0}}),this):this}_callInitHooks(){const e=Object.getPrototypeOf(this);return this._visitInitHooks(e),this}setOptions(e){if((!this.hasOwnProperty("options")||vc(this.options))&&(this.options=this.options?Object.create(this.options):{}),!e)return this;for(const t in e)this.options[t]=e[t];return this}configure(e,t){if(this._isUpdatingOptions=!0,e){if(arguments.length===2&&typeof e=="string"){const r={};r[e]=t,e=r}e=e;for(const r in e)this.options[r]=e[r],this[r]&&this[r]instanceof fs&&(e[r]?this[r].enable():this[r].disable());this.onOptionsChange(e),this._isUpdatingOptions=!1}else{const r={};for(const i in this.options)this.options.hasOwnProperty(i)&&(r[i]=this.options[i]);return this._isUpdatingOptions=!1,r}return this}onOptionsChange(e){}_visitInitHooks(e){if(this._initHooksCalled)return;const t=Object.getPrototypeOf(e);t._visitInitHooks&&t._visitInitHooks.call(this,t),this._initHooksCalled=!0;const r=e._initHooks;if(r&&r!==t._initHooks)for(let i=0;i<r.length;i++)r[i].call(this)}static mergeOptions(e){const t=this.prototype,r=Object.getPrototypeOf(t);return t.hasOwnProperty("options")?t.options===r.options&&(t.options=Object.create(t.options)):t.options={},Ko(t.options,e),this}static addInitHook(e,...t){const r=typeof e=="function"?e:function(){this[e].apply(this,t)},i=this.prototype,o=Object.getPrototypeOf(i);return(!i._initHooks||i._initHooks===o._initHooks)&&(i._initHooks=[]),i._initHooks.push(r),this}static include(...e){for(let t=0;t<e.length;t++)Ko(this.prototype,e[t]);return this}}}var Dm=Object.defineProperty,Im=(s,e,t)=>e in s?Dm(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Be=(s,e,t)=>Im(s,typeof e!="symbol"?e+"":e,t);const Fm=zr(ui(f.EventDispatcher));class bc extends Fm{constructor(e,t={}){super(),Be(this,"scene"),Be(this,"renderer"),Be(this,"camera"),Be(this,"controls"),Be(this,"ambLight"),Be(this,"dirLight"),Be(this,"clouds",null),Be(this,"container"),Be(this,"_clock",new f.Clock),Be(this,"stats"),Be(this,"_animationCallbacks",new Set),Be(this,"_fogFactor",1),Be(this,"_sceneSize",5e4*2),Be(this,"_defaultGround"),Be(this,"map"),Be(this,"centerWorldPos"),Be(this,"_isInteracting",!1),Be(this,"debug",!1),Be(this,"flyTween",null),Be(this,"composer"),Be(this,"renderPass"),Be(this,"bloomPass"),Be(this,"calculateCameraPosition",(v,M,S,x)=>{const O=new f.Vector3(0,M*Math.cos(S),M*Math.sin(S));return O.applyAxisAngle(new f.Vector3(0,1,0),x),new f.Vector3(v.x+O.x,v.y+O.y,v.z+O.z)}),this.setOptions(t);const{antialias:r=!1,stencil:i=!0,logarithmicDepthBuffer:o=!0,skybox:l,map:c,bloom:u,minDistance:d,maxDistance:m,draggable:p=!0,defaultGround:_}=t;if(this.map=c,this.centerWorldPos=this.map.lngLatToWorld(new f.Vector3(this.map.center[0],this.map.center[1],0)),this.renderer=this._createRenderer(r,i,o),this.scene=this._createScene(l),this.camera=this._createCamera(),e&&this.addTo(e),this.controls=this._createControls(d,m),this.controls.enabled=p!==!1,this.ambLight=this._createAmbLight(),this.scene.add(this.ambLight),this.dirLight=this._createDirLight(),this.scene.add(this.dirLight),this.scene.add(this.dirLight.target),this._defaultGround=this._createDefaultGround(_),_?.enabled&&this.scene.add(this._defaultGround),u&&u.enabled){const v=this.renderer.getPixelRatio(),M=this.container?this.width:window.innerWidth,S=this.container?this.height:window.innerHeight,x=M*v,O=S*v,P=new f.WebGLRenderTarget(x,O,{format:f.RGBAFormat});P.samples=4,this.composer=new lp(this.renderer,P),this.renderPass=new hp(this.scene,this.camera),this.composer.addPass(this.renderPass);const L=u?.strength??1.5,F=u?.radius??1,z=u?.threshold??.7;this.bloomPass=new rp(new f.Vector2(x,O),L,F,z),this.composer.addPass(this.bloomPass)}this.renderer.setAnimationLoop(this.animate.bind(this)),this.debug=t.debug||!1,this.flyTween=null,this.debug&&(this.stats=new pn,document.body.appendChild(this.stats.dom))}get fogFactor(){return this._fogFactor}get isInteracting(){return this._isInteracting}set fogFactor(e){this._fogFactor=e,this.controls.dispatchEvent({type:"change",target:this.controls})}get width(){return this.container?.clientWidth||0}get height(){return this.container?.clientHeight||0}addTo(e){let t=null;if(typeof e=="string"?t=document.getElementById(e)||document.querySelector(e):t=e,t instanceof HTMLElement)this.container=t,t.appendChild(this.renderer.domElement),new ResizeObserver(this.resize.bind(this)).observe(t);else throw`${e} not found!`;return this}_createScene(e){const t=new f.Scene,r=e?.defaultColor||"rgb(21,48,94)";if(t.background=new f.Color(r),t.fog=new f.FogExp2(r,2e-4),e?.files){const i=new f.CubeTextureLoader;e.path&&i.setPath(e.path),i.load(e.files,o=>{t.background=o},void 0,o=>{console.error("Error loading skybox:",o),t.background=new f.Color(r)})}else e?.hdr&&this._loadHDRWithPMREM(t,e);return t}async _loadHDRWithPMREM(e,t){try{if(t){const i=await new dm().setPath(t.path||"").setDataType(f.FloatType).loadAsync(t.hdr);i.colorSpace=this.renderer.outputColorSpace,i.mapping=303,i.needsUpdate=!0,this.scene.environment=i,this.scene.background=i,this.scene.backgroundIntensity=1.1}}catch(r){console.error("加载HDR失败:",r),e.background=new f.Color(t?.defaultColor||14414079)}}_createRenderer(e,t,r){const i=new f.WebGLRenderer({antialias:e,logarithmicDepthBuffer:r,stencil:t,alpha:!0,precision:"highp",powerPreference:"high-performance",failIfMajorPerformanceCaveat:!0});return i.debug.checkShaderErrors=!0,i.sortObjects=!0,i.setPixelRatio(window.devicePixelRatio),i.domElement.tabIndex=0,i.shadowMap.enabled=!0,i.shadowMap.needsUpdate=!0,i.shadowMap.type=f.PCFSoftShadowMap,i.toneMapping=f.ACESFilmicToneMapping,i.toneMappingExposure=1,i.outputColorSpace=f.SRGBColorSpace,i}_createCamera(){return new f.PerspectiveCamera(45,this.getAspect(),.1,this._sceneSize*2)}_createControls(e,t){const r=new Kd(this.camera,this.renderer.domElement),i=Math.PI/2.1;return r.screenSpacePanning=!1,r.minDistance=e??.1,r.maxDistance=t??6e4,r.maxPolarAngle=i,r.enableDamping=!0,r.dampingFactor=.08,r.keyPanSpeed=1,r.listenToKeyEvents(this.renderer.domElement),r.addEventListener("change",()=>{const o=Math.max(r.getPolarAngle(),.1),l=Math.max(r.getDistance(),100);r.zoomSpeed=Math.max(Math.log(l/1e3),1)+3;const c=3e5*2;r.maxDistance>c*.95&&(r.maxDistance=c*.95),this.camera.far=f.MathUtils.clamp(l/o*8,100,c),this.camera.near=f.MathUtils.clamp(this.camera.far/1e3,.001,1),this.camera.updateProjectionMatrix(),this.scene.fog instanceof f.FogExp2&&(this.scene.fog.density=o/(l+5)*this.fogFactor*.1);const d=l>6e4;r.minAzimuthAngle=d?0:-1/0,r.maxAzimuthAngle=d?0:1/0,r.maxPolarAngle=bm(r.getDistance(),0,7e4,i,0),this.map?.fire("viewchange",{type:"control-change",control:r,camera:this.camera,target:this.map})}),r.addEventListener("start",()=>{this._isInteracting=!0,this.map?.fire("movestart",{type:"control-start",control:r,camera:this.camera,target:this.map})}),r.addEventListener("end",()=>{this._isInteracting=!1,this.map?.fire("moveend",{type:"control-end",control:r,camera:this.camera,target:this.map})}),r}_createAmbLight(){return new f.AmbientLight(16777215,2)}_createDirLight(){const p=new f.DirectionalLight("rgba(248, 167, 16, 1)",10);p.position.set(this.centerWorldPos.x+55e3*1.2,55e3*2,this.centerWorldPos.z+55e3*1);const _=new f.Object3D;if(_.position.copy(this.centerWorldPos),this.scene.add(_),p.target=_,p.castShadow=!0,p.shadow.mapSize.width=1024*10,p.shadow.mapSize.height=1024*10,p.shadow.camera.near=1,p.shadow.camera.far=192500,p.shadow.camera.left=-55e3,p.shadow.camera.bottom=-55e3,p.shadow.camera.top=55e3,p.shadow.camera.right=55e3,p.shadow.radius=1,p.shadow.bias=-0,this.debug){const v=new f.CameraHelper(p.shadow.camera);v.name="dirLightCameraHelper",this.scene.add(v)}return p}_createAuxDirLight(){const l=this._createAuxLightInstance(this.centerWorldPos.x+-66e3,82500,this.centerWorldPos.z+-55e3,.5);l.name="AuxDirLight_BackFill",this.scene.add(l),this.scene.add(l.target);const m=this._createAuxLightInstance(this.centerWorldPos.x+55e3*-1,55e3*1.5,this.centerWorldPos.z+55e3*1.2,.5);m.name="AuxDirLight_LeftRim",this.scene.add(m),this.scene.add(m.target);const v=this._createAuxLightInstance(this.centerWorldPos.x+55e3*1,55e3*1.5,this.centerWorldPos.z+55e3*-1.2,.5);return v.name="AuxDirLight_RightRim",this.scene.add(v),this.scene.add(v.target),l}_createAuxLightInstance(e,t,r,i){const o=new f.DirectionalLight(16777215,i);o.position.set(e,t,r);const l=new f.Object3D;return l.position.copy(this.centerWorldPos),this.scene.add(l),o.target=l,o.castShadow=!1,o}resize(){const e=this.width,t=this.height;if(this.renderer.setSize(e,t),this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.composer){const r=this.renderer.getPixelRatio();this.composer.setSize(e*r,t*r),this.composer.render()}else this.renderer.render(this.scene,this.camera);return this}addAnimationCallback(e){return this._animationCallbacks.add(e),()=>this._animationCallbacks.delete(e)}animate(){const e=this._clock.getDelta(),t=this._clock.getElapsedTime();this._animationCallbacks.forEach(r=>r(e,t,this)),this.controls.update(),this.composer?this.composer.render():this.renderer.render(this.scene,this.camera),wm(),this.stats&&this.stats.update(),this.fire("update",{delta:e})}flyTo(e,t,r=!0,i){if(this.controls.target.copy(e),r){const o=this.camera.position;new hs(o).to({y:2e7,z:0},500).chain(new hs(o).to(t,2e3).easing(Vr.Quintic.Out).onComplete(l=>i&&i(l))).start()}else this.camera.position.copy(t)}flyToAdvanced(e){const t=this.camera,r=this.controls,i=e.center,o=e.cameraCoord,l=e.duration??2e3,c=e.delay??0,u=e.complete,d=!!e.curvePath;if(!i||!o)return;const m=this.map.lngLatToWorld(new f.Vector3(i[0],i[1],0)),p=this.map.lngLatToWorld(new f.Vector3(o[0],o[1],o[2]));if(!t||!r||!m||!p)return;const _=r.target.clone(),v=t.position.clone(),M=new f.Vector3(m.x,m.y,m.z),S=new f.Vector3(p.x,p.y,p.z);if(this.flyTween&&(this.flyTween.stop(),this.flyTween=null),d){const x=[v,v.clone().lerp(S,.33),v.clone().lerp(S,.67),S],O=new f.CubicBezierCurve3(...x),P={t:0,x:_.x,y:_.y,z:_.z};this.flyTween=new hs(P).to({t:1,x:M.x,y:M.y,z:M.z},l).easing(Vr.Quadratic.InOut).onUpdate(()=>{const L=O.getPoint(P.t),F=new f.Vector3(P.x,P.y,P.z);t.position.copy(L),t.lookAt(F),t.updateProjectionMatrix(),r.target.copy(F),r.update()})}else{const x={tx:_.x,ty:_.y,tz:_.z,px:v.x,py:v.y,pz:v.z};this.flyTween=new hs(x).to({tx:M.x,ty:M.y,tz:M.z,px:S.x,py:S.y,pz:S.z},l).easing(Vr.Quadratic.InOut).onUpdate(()=>{const O=new f.Vector3(x.tx,x.ty,x.tz),P=new f.Vector3(x.px,x.py,x.pz);t.position.copy(P),t.lookAt(O),r.target.copy(O),r.update()})}this.flyTween&&(this.flyTween.onComplete(()=>{this.flyTween&&(this.flyTween.stop(),this.flyTween=null),u&&u()}),c>0?setTimeout(()=>{this.flyTween&&this.flyTween.start()},c):this.flyTween.start())}onOptionsChange(e){if("draggable"in e){const t=e.draggable;this.controls&&(this.controls.enabled=t!==!1)}}easeTo(e){const{controls:t}=this,r=e.center,i=e.duration??2e3,o=typeof e.distance=="number"?e.distance:typeof e.altitude=="number"?e.altitude:t.getDistance(),l=M=>M*Math.PI/180;let c;if(typeof e.pitch=="number"){const M=e.pitch<=0?.1:e.pitch;c=l(M)}else c=t.getPolarAngle();const u=typeof e.bearing=="number"?l(e.bearing):t.getAzimuthalAngle(),d=e.complete,m=!!e.curvePath,p=this.map.lngLatToWorld(new f.Vector3(r[0],r[1],0)),_=this.calculateCameraPosition(p,o,c,u),v=this.map.worldToLngLat(_);this.flyToAdvanced({center:[r[0],r[1],0],cameraCoord:[v.x,v.y,v.z||0],duration:i,complete:d,curvePath:m})}getState(){return{centerPosition:this.controls.target,cameraPosition:this.camera.position}}_bindMap(e){e&&(this.map=e)}getMap(){return this.map?this.map:null}getAspect(){const[e,t]=this.getWidthHeight();return e/t}getWidthHeight(){let e=window.innerWidth,t=window.innerHeight;return[e,t]}_createDefaultGround(e){const t=this.centerWorldPos,r=e?.color??"rgb(45,52,60)",i=e?.opacity??1,o=e?.visible??!1,l=new f.MeshStandardMaterial({transparent:i<1,opacity:i,color:new f.Color(r),metalness:.2,roughness:1,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1}),c=new f.PlaneGeometry(this._sceneSize*2,this._sceneSize*2),u=new f.Mesh(c,l);return u.name="DefaultGround",u.castShadow=!1,u.receiveShadow=!0,u.position.y=-.1,u.position.add(t),u.rotateX(-Math.PI/2),u.visible=o,u}showDefaultGround(){this._defaultGround&&(this._defaultGround.visible=!0)}_updateDefaultGroundPosition(){if(!this._defaultGround||!this.map)return;const e=this.map.lngLatToWorld(new f.Vector3(this.map.center[0],this.map.center[1],0));this.centerWorldPos=e,this._defaultGround.position.copy(e),this._defaultGround.position.y-=.1}hideDefaultGround(){this._defaultGround&&(this._defaultGround.visible=!1)}isDefaultGroundVisible(){return this._defaultGround?.visible??!1}setDefaultGroundVisible(e){this._defaultGround&&(this._defaultGround.visible=e)}setDefaultGroundStyle(e){if(!this._defaultGround)return;const t=this._defaultGround.material;e.color!==void 0&&t.color.set(e.color),e.opacity!==void 0&&(t.opacity=e.opacity,t.transparent=e.opacity<1)}destroy(){try{this.renderer.setAnimationLoop(null),this._animationCallbacks.clear(),this.map=null,this.controls&&this.controls.dispose(),this.scene&&(this.scene.traverse(e=>{e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(t=>{this._disposeMaterial(t)}):this._disposeMaterial(e.material))}),this.scene.clear()),this.composer&&(this.bloomPass&&this.bloomPass.dispose?.(),this.renderPass&&this.renderPass.dispose?.(),this.composer=null,this.renderPass=null,this.bloomPass=null),this.renderer&&(this.renderer.dispose(),this.container&&this.renderer.domElement.parentNode===this.container&&this.container.removeChild(this.renderer.domElement)),this.stats&&this.stats.dom.parentNode&&this.stats.dom.parentNode.removeChild(this.stats.dom)}catch(e){console.error("❌ 销毁SceneRenderer时出错:",e)}}_disposeMaterial(e){if(!e)return;["map","lightMap","bumpMap","normalMap","specularMap","envMap","alphaMap","aoMap","displacementMap","emissiveMap","gradientMap","metalnessMap","roughnessMap"].forEach(r=>{e[r]&&e[r].dispose()}),e.dispose()}}var Bm=Object.defineProperty,Um=(s,e,t)=>e in s?Bm(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Vm=(s,e,t)=>Um(s,e+"",t);function Eo(s){return class extends s{constructor(...t){super(...t),Vm(this,"_handlers"),this._handlers=[]}addHandler(t,r){if(!r)return this;if(this._handlers||(this._handlers=[]),this[t])return this[t].enable(),this;const i=this[t]=new r(this);return this._handlers.push(i),this.options[t]&&i.enable(),this}removeHandler(t){if(!t)return this;const r=this[t];if(r&&this._handlers){const i=this._handlers.indexOf(r);i>=0&&this._handlers.splice(i,1),this[t].remove(),delete this[t]}return this}_clearHandlers(){if(this._handlers){for(let t=0,r=this._handlers.length;t<r;t++)this._handlers[t].remove();this._handlers=[]}}}}var km=Object.defineProperty,zm=(s,e,t)=>e in s?km(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,hi=(s,e,t)=>zm(s,typeof e!="symbol"?e+"":e,t);const Nm={attribution:"",visible:!0,opacity:1,zIndex:0,isSceneLayer:!1,altitude:0};class ds extends Eo(zr(ui(f.Group))){constructor(e,t){super(),hi(this,"_layerId"),hi(this,"opacity",1),hi(this,"_animCallbacks",new Set),hi(this,"isSceneLayer",!1),hi(this,"_baseAltitude",0),hi(this,"depthOffset"),hi(this,"_regionConfigs",[]),Xo(e,"id","Layer ID must be specified 图层ID必须指定"),t&&(this.setOptions(t),this.opacity=t.opacity||1,this.isSceneLayer=t.isSceneLayer??!1,t.altitude!==void 0&&this.setAltitude(t.altitude)),this._layerId=e,typeof this.animate=="function"&&this._registerAnimate()}getId(){return this._layerId}addTo(e){return e.addLayer(this),this}getZIndex(){const e=this.options||{};return typeof e.zIndex=="number"?e.zIndex:0}getDepthOffset(){const e=this.options||{};return typeof e.depthOffset=="number"?e.depthOffset:0}getOpacity(){return this.opacity}setOpacity(e){this.opacity=e,this.traverse(t=>{"material"in t&&(Array.isArray(t.material)?t.material:[t.material]).forEach(i=>{"opacity"in i&&(i.transparent=e<1,i.opacity=e,i.needsUpdate=!0)}),t instanceof f.Sprite&&(t.material.opacity=e,t.material.transparent=e<1,t.material.needsUpdate=!0)})}getMap(){return this.map?this.map:null}show(){return this.visible||(this.visible=!0,this.options.visible=!0,this.getMap()),this}hide(){return this.visible&&(this.visible=!1,this.options.visible=!1,this.getMap()),this}setAltitude(e){return this.position.y=e,this.updateMatrix(),this.updateMatrixWorld(!0),this}getAltitude(){return this.position.y}_bindMap(e){e&&(this.map=e,typeof this.animate=="function"&&this._registerAnimate())}_registerAnimate(){const e=this.getMap();if(!e?.sceneRenderer)return;const t=e.sceneRenderer.addAnimationCallback((r,i,o)=>{this.animate?.(r,i,o)});this._animCallbacks.add(t)}_clearAnimationCallbacks(){this._animCallbacks.forEach(e=>e()),this._animCallbacks.clear()}getOptions(){return{...this.options}}setRegionOverlays(e){return this._regionConfigs=(e||[]).map(t=>({id:t.id??this._generateRegionOverlayId(),color:t.color??"#00FF88",opacity:t.opacity??.3,mode:t.mode??"overlay",zIndex:t.zIndex??0,geometry:t.geometry,feature:t.feature})),this}addRegionOverlay(e){const t=e.id??this._generateRegionOverlayId(),r={id:t,color:e.color??"#00FF88",opacity:e.opacity??.3,mode:e.mode??"overlay",zIndex:e.zIndex??0,geometry:e.geometry,feature:e.feature};return this._regionConfigs.push(r),t}removeRegionOverlay(e){return this._regionConfigs=this._regionConfigs.filter(t=>t.id!==e),this}clearRegionOverlays(){return this._regionConfigs=[],this}getRegionOverlays(){return this._regionConfigs.slice()}_generateRegionOverlayId(){return`region-overlay-${Date.now()}-${Math.random().toString(16).slice(2)}`}}ds.mergeOptions(Nm);const Ee=[];for(let s=0;s<256;++s)Ee.push((s+256).toString(16).slice(1));function Rm(s,e=0){return(Ee[s[e+0]]+Ee[s[e+1]]+Ee[s[e+2]]+Ee[s[e+3]]+"-"+Ee[s[e+4]]+Ee[s[e+5]]+"-"+Ee[s[e+6]]+Ee[s[e+7]]+"-"+Ee[s[e+8]]+Ee[s[e+9]]+"-"+Ee[s[e+10]]+Ee[s[e+11]]+Ee[s[e+12]]+Ee[s[e+13]]+Ee[s[e+14]]+Ee[s[e+15]]).toLowerCase()}let Jo;const Wm=new Uint8Array(16);function Gm(){if(!Jo){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");Jo=crypto.getRandomValues.bind(crypto)}return Jo(Wm)}const xc={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function $m(s,e,t){s=s||{};const r=s.random??s.rng?.()??Gm();if(r.length<16)throw new Error("Random bytes length must be >= 16");return r[6]=r[6]&15|64,r[8]=r[8]&63|128,Rm(r)}function jm(s,e,t){return xc.randomUUID&&!s?xc.randomUUID():$m(s)}var Mc=(s=>(s.POINT="point",s.LINE_VERTEX="line_vertex",s.POLYGON_CENTER="polygon_center",s.LABEL="label",s.ICON="icon",s.CLUSTER="cluster",s))(Mc||{}),hr=(s=>(s.NO_COLLISION="no_collision",s.PRIORITY_LOST="priority_lost",s.OUT_OF_VIEWPORT="out_of_viewport",s.ZOOM_FILTERED="zoom_filtered",s.MANUAL_HIDDEN="manual_hidden",s.GROUP_COLLISION="group_collision",s))(hr||{}),Xm=Object.defineProperty,Ym=(s,e,t)=>e in s?Xm(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,xn=(s,e,t)=>Ym(s,typeof e!="symbol"?e+"":e,t);class Zm extends fs{constructor(){super(...arguments),xn(this,"_isDragging",!1),xn(this,"_lastCoord",null),xn(this,"_boundOnMouseDown",this._onMouseDown.bind(this)),xn(this,"_boundOnMouseMove",this._onMouseMove.bind(this)),xn(this,"_boundOnMouseUp",this._onMouseUp.bind(this))}addHooks(){this.target.on("mousedown",this._boundOnMouseDown)}removeHooks(){this.target.off("mousedown",this._boundOnMouseDown),this._stopDrag()}_onMouseDown(e){const t=this.target.getMap();!t||!this.target.options.draggable||(this._isDragging=!0,this._lastCoord=e.coordinate,t.sceneRenderer.configure("draggable",!1),t.on("mousemove",this._boundOnMouseMove),t.on("mouseup",this._boundOnMouseUp),this.target.fire("dragstart",e))}_onMouseMove(e){if(!this._isDragging||!this._lastCoord||!e.coordinate)return;const t=e.coordinate,r=t[0]-this._lastCoord[0],i=t[1]-this._lastCoord[1];Math.abs(r)<1e-8&&Math.abs(i)<1e-8||(this._translate(r,i),this._lastCoord=t,this.target.fire("dragging",e))}_onMouseUp(e){this._stopDrag(),this.target.fire("dragend",e)}_stopDrag(){this._isDragging=!1;const e=this.target.getMap();e&&(e.sceneRenderer.configure("draggable",!0),e.off("mousemove",this._boundOnMouseMove),e.off("mouseup",this._boundOnMouseUp))}_translate(e,t){const r=this.target._geometry;if(!r||!r.coordinates)return;const i=l=>Array.isArray(l[0])?l.map(i):[l[0]+e,l[1]+t],o=i(r.coordinates);r.coordinates=o,this.target._applyCoordinateChanges(!0)}}var Km=Object.defineProperty,qm=(s,e,t)=>e in s?Km(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Mn=(s,e,t)=>qm(s,typeof e!="symbol"?e+"":e,t);const Sc=class od{constructor(e){Mn(this,"cache",new Map),Mn(this,"gltfLoader"),Mn(this,"fbxLoader"),Mn(this,"dracoLoader"),this.gltfLoader=new dp(e),this.fbxLoader=new tm(e)}static getInstance(e){return this.instance||(this.instance=new od(e)),this.instance}clearCache(){this.cache.clear()}async load(e){const t=`${e.type}:${e.url}`;if(this.cache.has(t))return this.cloneCachedModel(t,e);e.type==="model-gltf"&&e.dracoOptions?.enable&&this.ensureDracoLoader(e.dracoOptions.decoderPath);let r,i;try{if(e.type==="model-gltf"){const o=await this.gltfLoader.loadAsync(e.url);r=o.scene,i=o.animations}else r=await this.fbxLoader.loadAsync(e.url),i=r.animations;return this.cache.set(t,{model:r,animations:i}),{model:this.processModel(r.clone(),e),animations:this.processAnimations(i)}}catch(o){throw console.error(`[ExternalModelLoader] Failed to load ${e.type} model from ${e.url}:`,o),o}}ensureDracoLoader(e="/draco/"){this.dracoLoader||(this.dracoLoader=new pm,this.dracoLoader.setDecoderPath(e),this.gltfLoader.setDRACOLoader(this.dracoLoader))}cloneCachedModel(e,t){const r=this.cache.get(e),i=r.model.clone();return{model:this.processModel(i,t),animations:this.processAnimations(r.animations)}}processAnimations(e){return e?.map(t=>({...t,name:t.name||"unnamed"}))||[]}processModel(e,t){if(t.position&&e.position.copy(t.position),t.scale)if(typeof t.scale=="number")e.scale.setScalar(t.scale);else{const{x:r,y:i,z:o}=t.scale;r!==void 0&&(e.scale.x=r),i!==void 0&&(e.scale.y=i),o!==void 0&&(e.scale.z=o)}return t.rotation&&e.rotation.setFromVector3(t.rotation),e}};Mn(Sc,"instance");let Ho=Sc;const ea=(s,e)=>{"updateRanges"in s?s.updateRanges[0]=e:s.updateRange=e},Ac=new f.Matrix4,ps=new f.Vector3,ms=new f.Quaternion,Pc=new f.Vector3,Lc=new f.Quaternion,Sn=new f.Vector3,Qm=s=>class extends s{constructor(){super();const e=parseInt(f.REVISION.replace(/\D+/g,""))>=154?"opaque_fragment":"output_fragment";this.onBeforeCompile=t=>{t.vertexShader=`attribute float cloudOpacity;
               varying float vOpacity;
              `+t.vertexShader.replace("#include <fog_vertex>",`#include <fog_vertex>
                 vOpacity = cloudOpacity;
                `),t.fragmentShader=`varying float vOpacity;
              `+t.fragmentShader.replace(`#include <${e}>`,`#include <${e}>
                 gl_FragColor = vec4(outgoingLight, diffuseColor.a * vOpacity);
                `)}}};class Em extends f.Group{constructor({limit:e=200,range:t,material:r=f.MeshLambertMaterial,texture:i,frustumCulled:o=!0}={}){super(),this.name="Clouds",this.ref=this;const l=this,c=new f.PlaneGeometry(1,1),u=new Float32Array(Array.from({length:e},()=>1)),d=new Float32Array(Array.from({length:e},()=>[1,1,1]).flat()),m=new f.InstancedBufferAttribute(u,1);m.setUsage(f.DynamicDrawUsage),c.setAttribute("cloudOpacity",m);const p=Qm(r),_=new p;_.map=i,_.transparent=!0,_.depthWrite=!1,_.needsUpdate=!0,this.cloudMaterial=_,this.instance=new f.InstancedMesh(c,_,e);const v=this.instance;v.matrixAutoUpdate=!1,v.frustumCulled=o,v.instanceColor=new f.InstancedBufferAttribute(d,3),v.instanceColor.setUsage(f.DynamicDrawUsage),l.add(v);const M=[],S=()=>{const G=M.length;let U=0;for(let X=0;X<this.ref.children.length;X++){const N=this.ref.children[X];N.cloudStateArray&&(U+=N.cloudStateArray.length)}if(G===U)return M;M.length=0;for(let X=0;X<this.ref.children.length;X++){const N=this.ref.children[X];N.cloudStateArray&&M.push(...N.cloudStateArray)}return x(),M},x=()=>{const G=Math.min(e,t!==void 0?t:e,M.length);v.count=G,ea(v.instanceMatrix,{offset:0,count:G*16}),v.instanceColor&&ea(v.instanceColor,{offset:0,count:G*3}),ea(v.geometry.attributes.cloudOpacity,{offset:0,count:G})};let O=0,P=0,L;const F=new f.Quaternion,z=new f.Vector3(0,0,1),j=new f.Vector3;this.update=(G,U,X)=>{O=U,Ac.copy(v.matrixWorld).invert(),G.matrixWorld.decompose(Pc,Lc,Sn);const N=S();for(P=0;P<N.length;P++)L=N[P],L.ref.matrixWorld.decompose(ps,ms,Sn),ps.add(j.copy(L.position).applyQuaternion(ms).multiply(Sn)),ms.copy(Lc).multiply(F.setFromAxisAngle(z,L.rotation+=X*L.rotationFactor)),Sn.multiplyScalar(L.volume+(1+Math.sin(O*L.density*L.speed))/2*L.growth),L.matrix.compose(ps,ms,Sn).premultiply(Ac),L.dist=ps.distanceTo(Pc);for(N.sort((k,Z)=>Z.dist-k.dist),P=0;P<N.length;P++)L=N[P],u[P]=L.opacity*(L.dist<L.fade-1?L.dist/L.fade:1),v.setMatrixAt(P,L.matrix),v.setColorAt(P,L.color);v.geometry.attributes.cloudOpacity.needsUpdate=!0,v.instanceMatrix.needsUpdate=!0,v.instanceColor&&(v.instanceColor.needsUpdate=!0)}}}let Jm=0;class Hm extends f.Group{constructor({opacity:e=1,speed:t=0,bounds:r=new f.Vector3().fromArray([5,1,1]),segments:i=20,color:o=new f.Color("#ffffff"),fade:l=10,volume:c=6,smallestVolume:u=.25,distribute:d=null,growth:m=4,concentrate:p="inside",seed:_=Math.random()}={}){super(),this.name="cloud_"+Jm++,this.seed=_,this.segments=i,this.bounds=r,this.concentrate=p,this.volume=c,this.smallestVolume=u,this.distribute=d,this.growth=m,this.speed=t,this.fade=l,this.opacity=e,this.color=o,this.ref=this,this.cloudStateArray=[],this.updateCloud()}updateCloudStateArray(){if(this.cloudStateArray.length===this.segments)return;const{segments:e,uuid:t}=this;if(this.cloudStateArray.length>this.segments)this.cloudStateArray.splice(0,this.cloudStateArray.length-this.segments);else for(let r=this.cloudStateArray.length;r<e;r++)this.cloudStateArray.push({segments:e,bounds:new f.Vector3(1,1,1),position:new f.Vector3,uuid:t,index:r,ref:this,dist:0,matrix:new f.Matrix4,volume:0,length:0,speed:0,growth:0,opacity:1,fade:0,density:0,rotation:r*(Math.PI/e),rotationFactor:0,color:new f.Color})}updateCloud(){const{volume:e,color:t,speed:r,growth:i,opacity:o,fade:l,bounds:c,seed:u,cloudStateArray:d,distribute:m,segments:p,concentrate:_,smallestVolume:v}=this;this.updateCloudStateArray();let M=0;function S(){const x=Math.sin(u+M)*1e4;return M++,x-Math.floor(x)}d.forEach((x,O)=>{x.segments=p,x.volume=e,x.color=t,x.speed=r,x.growth=i,x.opacity=o,x.fade=l,x.bounds.copy(c),x.density=Math.max(.5,S()),x.rotationFactor=Math.max(.2,.5*S())*r;const P=m?.(x,O);if(P||p>1){var L;x.position.copy(x.bounds).multiply((L=P?.point)!==null&&L!==void 0?L:{x:S()*2-1,y:S()*2-1,z:S()*2-1})}const F=Math.abs(x.position.x),z=Math.abs(x.position.y),j=Math.abs(x.position.z),G=Math.max(F,z,j);x.length=1,F===G&&(x.length-=F/x.bounds.x),z===G&&(x.length-=z/x.bounds.y),j===G&&(x.length-=j/x.bounds.z),x.volume=(P?.volume!==void 0?P.volume:Math.max(Math.max(0,v),_==="random"?S():_==="inside"?x.length:1-x.length))*e})}}class ta{constructor(e=4){this.pool=e,this.queue=[],this.workers=[],this.workersResolve=[],this.workerStatus=0}_initWorker(e){if(!this.workers[e]){const t=this.workerCreator();t.addEventListener("message",this._onMessage.bind(this,e)),this.workers[e]=t}}_getIdleWorker(){for(let e=0;e<this.pool;e++)if(!(this.workerStatus&1<<e))return e;return-1}_onMessage(e,t){const r=this.workersResolve[e];if(r&&r(t),this.queue.length){const{resolve:i,msg:o,transfer:l}=this.queue.shift();this.workersResolve[e]=i,this.workers[e].postMessage(o,l)}else this.workerStatus^=1<<e}setWorkerCreator(e){this.workerCreator=e}setWorkerLimit(e){this.pool=e}postMessage(e,t){return new Promise(r=>{const i=this._getIdleWorker();i!==-1?(this._initWorker(i),this.workerStatus|=1<<i,this.workersResolve[i]=r,this.workers[i].postMessage(e,t)):this.queue.push({resolve:r,msg:e,transfer:t})})}dispose(){this.workers.forEach(e=>e.terminate()),this.workersResolve.length=0,this.workers.length=0,this.queue.length=0,this.workerStatus=0}}function ki(s){if(!s)return[.5,.5];if(Array.isArray(s))return s;switch(s){case"top-left":return[0,1];case"top":return[.5,1];case"top-right":return[1,1];case"left":return[0,.5];case"center":return[.5,.5];case"right":return[1,.5];case"bottom-left":return[0,0];case"bottom":return[.5,0];case"bottom-right":return[1,0];default:return[.5,.5]}}function Cc(s,e){const t=new f.BufferGeometry;t.setAttribute("position",new f.BufferAttribute(new Float32Array([0,0,0]),3));const r=s.sizeAttenuation??!0,i=r?s.size*.002:s.size,o=new f.PointsMaterial({size:i,color:s.color||16777215,sizeAttenuation:r,depthTest:s.depthTest??!0,depthWrite:s.depthWrite??!0});o.onBeforeCompile=c=>{c.fragmentShader=c.fragmentShader.replace("#include <clipping_planes_fragment>",`
            #include <clipping_planes_fragment>
            vec2 coord = gl_PointCoord - vec2(0.5);
            if(length(coord) > 0.5) discard;
            `)};const l=new f.Points(t,o);return l.position.copy(e),l}async function eg(s,e){let t=null;try{t=await xt._loadTexture(s.url),t.magFilter=f.LinearFilter,t.minFilter=f.LinearMipmapLinearFilter,t.colorSpace=f.SRGBColorSpace,t.generateMipmaps=!0,t.premultiplyAlpha=!1,t.needsUpdate=!0}catch(d){console.error("IconPoint texture load failed:",s.url,d)}const r=new f.SpriteMaterial({map:t??null,color:s.color||16777215,transparent:s.transparent??!0,opacity:s.opacity??1,sizeAttenuation:s.sizeAttenuation??!0,depthTest:s.depthTest??!0,depthWrite:s.depthWrite??!0,alphaTest:s.alphaTest??.05,premultipliedAlpha:!1,blending:f.NormalBlending}),i=new f.Sprite(r),o=.002,l=s.size;let c,u;if(Array.isArray(l))[c,u]=l;else{const d=typeof l=="number"?l:32;if(t&&t.image?.width&&t.image?.height){const m=t.image,p=m.width/m.height||1;u=d,c=d*p}else c=d,u=d}if(i.scale.set(c*o,u*o,1),s.rotation&&(i.rotation.z=s.rotation),s.anchor){const d=ki(s.anchor);i.center.set(d[0],d[1])}return i.position.copy(e),i.renderOrder=99,i}function ra(s,e){let t;e instanceof Float32Array?t=Array.from(e):Array.isArray(e)&&typeof e[0]=="number"?t=e:t=e.flatMap(o=>[o.x,o.y,o.z]);const r=new as;r.setPositions(t);const i=new vn({color:new f.Color(s.color??16777215).getHex(),linewidth:s.width??2,transparent:s.transparent??!0,opacity:s.opacity??1,dashed:!!s.dashArray,dashScale:s.dashArray?.[0]??1,dashSize:s.dashArray?.[0]??1,gapSize:s.dashArray?.[1]??0,resolution:new f.Vector2(window.innerWidth,window.innerHeight),alphaToCoverage:!0,depthTest:s.depthTest??!0,depthWrite:s.depthWrite??!0});return window.addEventListener("resize",()=>{i.resolution.set(window.innerWidth,window.innerHeight)}),new us(r,i)}function Oc(s,e){let t=[];if(Array.isArray(e)&&typeof e[0]=="number")for(let S=0;S<e.length;S+=3)t.push(new f.Vector3(e[S],e[S+1],e[S+2]));else if(e instanceof Float32Array)for(let S=0;S<e.length;S+=3)t.push(new f.Vector3(e[S],e[S+1],e[S+2]));else t=e;if(t.length<2)return new f.Mesh;const r=new f.CurvePath,i=s.cornerRadius||5;if(t.length===2||i<=0)for(let S=0;S<t.length-1;S++){const x=new f.LineCurve3(t[S],t[S+1]);r.curves.push(x)}else{let S=t[0];for(let x=1;x<t.length-1;x++){const O=S,P=t[x],L=t[x+1],F=new f.Vector3().subVectors(P,O),z=new f.Vector3().subVectors(L,P),j=F.length(),G=z.length(),U=Math.min(j,G)*.4,X=Math.min(i,U);F.normalize().multiplyScalar(j-X),z.normalize().multiplyScalar(X);const N=new f.Vector3().addVectors(O,F),k=new f.Vector3().addVectors(P,z);r.curves.push(new f.LineCurve3(O,N)),r.curves.push(new f.QuadraticBezierCurve3(N,P,k)),S=k}r.curves.push(new f.LineCurve3(S,t[t.length-1]))}const o=s.radius||2,l=s.radialSegments||8,c=s.tubularSegments||64,u=new f.TubeGeometry(r,c,o,l,!1),d=5,m=new f.MeshPhongMaterial({color:s.color||"#19bbd5",side:f.DoubleSide,emissive:new f.Color(s.color||"#19bbd5"),emissiveIntensity:.6*d,transparent:!0});m.defines={USE_UV:""};const _={totalLength:{value:r.getLength()},stripeOffset:{value:0},stripeWidth:{value:s.stripeWidth||10},stripeSpacing:{value:s.stripeSpacing||20},stripeColor:{value:new f.Color(s.stripeColor||"#096be3")},speedFactor:{value:s.speed||10},bloomBoost:{value:d}};m.onBeforeCompile=S=>{S.uniforms.totalLength=_.totalLength,S.uniforms.stripeOffset=_.stripeOffset,S.uniforms.stripeWidth=_.stripeWidth,S.uniforms.stripeSpacing=_.stripeSpacing,S.uniforms.stripeColor=_.stripeColor,S.uniforms.bloomBoost=_.bloomBoost,S.fragmentShader=`
            uniform float totalLength;
            uniform float stripeOffset;
            uniform float stripeWidth;
            uniform float stripeSpacing;
            uniform vec3 stripeColor;
            uniform float bloomBoost;
            ${S.fragmentShader}
        `.replace("#include <color_fragment>",`#include <color_fragment>
            // 计算条纹模式（用于漫反射）
            float pattern = mod((vUv.x - stripeOffset) * totalLength / (stripeWidth + stripeSpacing), 1.0);
            float isStripe = step(pattern, stripeWidth / (stripeWidth + stripeSpacing));
            
            // 混合条纹颜色
            diffuseColor.rgb = mix(diffuseColor.rgb, stripeColor, isStripe);
            
            // 条纹区域再额外提亮，让 bloom 更明显
            if (isStripe > 0.5) {
                diffuseColor.rgb += stripeColor * (3.0 * bloomBoost);
            }
            `).replace("#include <emissivemap_fragment>",`#include <emissivemap_fragment>
            // 计算条纹模式（用于自发光）
            float pattern_e = mod((vUv.x - stripeOffset) * totalLength / (stripeWidth + stripeSpacing), 1.0);
            float isStripe_e = step(pattern_e, stripeWidth / (stripeWidth + stripeSpacing));
            
            // 自发光通道也叠加一遍，进一步抬高亮度
            totalEmissiveRadiance += stripeColor * isStripe_e * (3.0 * bloomBoost);
            `)};const v=new f.Mesh(u,m);let M=0;return v.onBeforeRender=()=>{const S=performance.now(),x=M?(S-M)/1e3:.016;M=S;const O=_.speedFactor.value/_.totalLength.value*10;_.stripeOffset.value-=x*O,_.stripeOffset.value=_.stripeOffset.value%1},v}function Tc(s,e){let t=[];if(Array.isArray(e)&&typeof e[0]=="number")for(let L=0;L<e.length;L+=3)t.push(new f.Vector3(e[L],e[L+1],e[L+2]));else if(e instanceof Float32Array)for(let L=0;L<e.length;L+=3)t.push(new f.Vector3(e[L],e[L+1],e[L+2]));else t=e;if(t.length<2)return new f.Mesh;const r=new f.CurvePath,i=s.cornerRadius||5;if(t.length===2||i<=0)for(let L=0;L<t.length-1;L++){const F=new f.LineCurve3(t[L],t[L+1]);r.curves.push(F)}else{let L=t[0];for(let F=1;F<t.length-1;F++){const z=L,j=t[F],G=t[F+1],U=new f.Vector3().subVectors(j,z),X=new f.Vector3().subVectors(G,j),N=U.length(),k=X.length(),Z=Math.min(N,k)*.4,E=Math.min(i,Z);U.normalize().multiplyScalar(N-E),X.normalize().multiplyScalar(E);const q=new f.Vector3().addVectors(z,U),te=new f.Vector3().addVectors(j,X);r.curves.push(new f.LineCurve3(z,q)),r.curves.push(new f.QuadraticBezierCurve3(q,j,te)),L=te}r.curves.push(new f.LineCurve3(L,t[t.length-1]))}const o=s.width||4,c=r.getPoints(128),u=[],d=[],m=[];let p=0;const _=r.getLength();for(let L=0;L<c.length;L++){const F=c[L];let z;L===0?z=new f.Vector3().subVectors(c[1],c[0]):L===c.length-1?z=new f.Vector3().subVectors(c[L],c[L-1]):z=new f.Vector3().subVectors(c[L+1],c[L-1]),z.y=0,z.normalize();const j=new f.Vector3(-z.z,0,z.x),G=o/2,U=new f.Vector3(F.x+j.x*G,F.y,F.z+j.z*G),X=new f.Vector3(F.x-j.x*G,F.y,F.z-j.z*G);u.push(U.x,U.y,U.z),u.push(X.x,X.y,X.z),L>0&&(p+=c[L].distanceTo(c[L-1]));const N=p/_;if(d.push(N,0),d.push(N,1),L<c.length-1){const k=L*2;m.push(k,k+1,k+2),m.push(k+1,k+3,k+2)}}const v=new f.BufferGeometry;v.setAttribute("position",new f.BufferAttribute(new Float32Array(u),3)),v.setAttribute("uv",new f.BufferAttribute(new Float32Array(d),2)),v.setIndex(m),v.computeVertexNormals();const M=5,S=new f.MeshPhongMaterial({color:s.color||"#0ED5FD",side:f.DoubleSide,emissive:new f.Color(s.color||"#0ED5FD"),emissiveIntensity:5,transparent:!0});S.defines={USE_UV:""};const x={totalLength:{value:_},stripeOffset:{value:0},arrowLength:{value:s.arrowLength||20},arrowSpacing:{value:s.arrowSpacing||80},arrowColor:{value:new f.Color(s.color||"#0ED5FD")},speedFactor:{value:s.speed||10},bloomBoost:{value:M}};S.onBeforeCompile=L=>{L.uniforms.totalLength=x.totalLength,L.uniforms.stripeOffset=x.stripeOffset,L.uniforms.arrowLength=x.arrowLength,L.uniforms.arrowSpacing=x.arrowSpacing,L.uniforms.arrowColor=x.arrowColor,L.uniforms.bloomBoost=x.bloomBoost,L.fragmentShader=L.fragmentShader.replace("uniform vec3 diffuse;",`uniform vec3 diffuse;
            uniform float totalLength;
            uniform float stripeOffset;
            uniform float arrowLength;
            uniform float arrowSpacing;
            uniform vec3 arrowColor;
            uniform float bloomBoost;`),L.fragmentShader=L.fragmentShader.replace("#include <color_fragment>",`#include <color_fragment>
            {
                float tpat = arrowLength + arrowSpacing;
                float posi = mod((vUv.x - stripeOffset) * totalLength, tpat);
                float inArrow = step(posi, arrowLength);
                float npos = posi / arrowLength;
                
                float centerDist = abs(vUv.y - 0.5);
                
                float h0 = step(npos, 0.5);
                float headWidth = mix(0.0, 1.5, npos / 0.5);
                float shaftWidth = 0.6;
                float arrowWidth = mix(shaftWidth, headWidth, h0);
                float arrowShape = step(centerDist, arrowWidth * 0.5);
                
                float mask = inArrow * arrowShape;
                mask = clamp(mask, 0.0, 1.0);
                
                diffuseColor.rgb = arrowColor;
                diffuseColor.a = mask;
            }`),L.fragmentShader=L.fragmentShader.replace("#include <emissivemap_fragment>",`#include <emissivemap_fragment>
            {
                float tpat2 = arrowLength + arrowSpacing;
                float posi2 = mod((vUv.x - stripeOffset) * totalLength, tpat2);
                float inArrow2 = step(posi2, arrowLength);
                float npos2 = posi2 / arrowLength;
                
                float centerDist2 = abs(vUv.y - 0.5);
                
                float h02 = step(npos2, 0.5);
                float headWidth2 = mix(0.0, 1.5, npos2 / 0.5);
                float shaftWidth2 = 0.6;
                float arrowWidth2 = mix(shaftWidth2, headWidth2, h02);
                float arrowShape2 = step(centerDist2, arrowWidth2 * 0.5);
                
                float mask2 = inArrow2 * arrowShape2;
                mask2 = clamp(mask2, 0.0, 1.0);
                
                totalEmissiveRadiance += arrowColor * mask2 * 0.5;
            }`)};const O=new f.Mesh(v,S);let P=0;return O.onBeforeRender=()=>{const L=performance.now(),F=P?(L-P)/1e3:.016;P=L;const z=x.speedFactor.value/x.totalLength.value*10;x.stripeOffset.value-=F*z,x.stripeOffset.value=x.stripeOffset.value%1},O}async function Dc(s,e){let t=[];if(Array.isArray(e)&&typeof e[0]=="number"){const k=e;for(let Z=0;Z<k.length;Z+=3)t.push(new f.Vector3(k[Z],k[Z+1],k[Z+2]))}else if(e instanceof Float32Array)for(let k=0;k<e.length;k+=3)t.push(new f.Vector3(e[k],e[k+1],e[k+2]));else t=e;if(t.length<2)return new f.Mesh;const r=(s.width??10)*.5,i=[],o=[],l=[];let c=0;const u=[0];for(let k=1;k<t.length;k++){const Z=t[k].distanceTo(t[k-1]);c+=Z,u.push(c)}if(c===0)return new f.Mesh;const d=s.repeat??1,m=[],p=[];for(let k=0;k<t.length;k++){let Z=new f.Vector3;k===0?Z.subVectors(t[k+1],t[k]):k===t.length-1?Z.subVectors(t[k],t[k-1]):Z.subVectors(t[k+1],t[k-1]),Z.normalize();const E=new f.Vector3(0,1,0);let q=new f.Vector3().crossVectors(Z,E);q.lengthSq()<1e-10?q.set(1,0,0):q.normalize(),m.push(t[k].clone().add(q.clone().multiplyScalar(-r))),p.push(t[k].clone().add(q.clone().multiplyScalar(r)))}let _=0,v=0;for(let k=1;k<m.length;k++)_+=m[k].distanceTo(m[k-1]),v+=p[k].distanceTo(p[k-1]);if((_+v)/2===0)return new f.Mesh;for(let k=0;k<t.length;k++){i.push(m[k].x,m[k].y,m[k].z,p[k].x,p[k].y,p[k].z);const Z=u[k]/c*d;o.push(Z,0,Z,1)}const S=t.length-1;for(let k=0;k<S;k++){const Z=k*2,E=k*2+1,q=(k+1)*2,te=(k+1)*2+1;l.push(Z,q,E),l.push(q,te,E)}const x=new f.BufferGeometry;x.setAttribute("position",new f.BufferAttribute(new Float32Array(i),3)),x.setAttribute("uv",new f.BufferAttribute(new Float32Array(o),2)),x.setIndex(l),x.computeBoundingBox(),x.computeVertexNormals();const O=await xt._loadTexture(s.flowTexture);O.wrapS=f.RepeatWrapping,O.wrapT=f.RepeatWrapping,O.anisotropy=4,O.needsUpdate=!0;const P=new f.Color(s.color??16777215),F={uMap:{value:O},uColor:{value:P},uOpacity:{value:s.opacity??1},uOffset:{value:0},uBloomBoost:{value:5}},z=s.depthOffset??1,j=z!==0,G=new f.ShaderMaterial({uniforms:F,vertexShader:`
            varying vec2 vUv;
            void main() {
                vUv = uv;
                gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
            }
        `,fragmentShader:`
            uniform sampler2D uMap;
            uniform vec3 uColor;
            uniform float uOpacity;
            uniform float uOffset;
            uniform float uBloomBoost;
            varying vec2 vUv;

            void main() {
                // 关键修复：修正UV滚动计算，确保方向正确[3](@ref)
                vec2 uv = vec2(fract(vUv.x + uOffset), vUv.y);
                vec4 texColor = texture2D(uMap, uv);
                
                // 添加alpha测试，完全透明的片元直接丢弃
                if (texColor.a < 0.01) discard;
                
                float alpha = texColor.a * uOpacity;
                vec3 baseColor = texColor.rgb * uColor;
                // 使用更自然的颜色增强公式
                vec3 finalColor = baseColor * uBloomBoost;
                
                gl_FragColor = vec4(finalColor, alpha);
            }
        `,transparent:s.transparent??!0,depthTest:s.depthTest??!0,depthWrite:s.depthWrite??!1,blending:f.AdditiveBlending,side:f.DoubleSide,polygonOffset:j,polygonOffsetFactor:-z,polygonOffsetUnits:-z}),U=new f.Mesh(x,G);let X=0;U.onBeforeRender=()=>{const k=performance.now(),Z=X?(k-X)/1e3:.016;X=k;const E=s.speed??10;F.uOffset.value=N(F.uOffset.value-Z*E/c)};function N(k){return k-Math.floor(k)}return U}async function tg(s,e){const t=s.type||(s.url.toLowerCase().endsWith(".fbx")?"fbx":"gltf");return(await Ho.getInstance().load({...s,type:t,position:e})).model}function rg(s,e){const{geometry:t,center:r,avgY:i}=ia(e),o=s.depthOffset??0,l=o!==0,c=new f.MeshBasicMaterial({color:new f.Color(s.color??16777215),transparent:s.transparent??!0,opacity:s.opacity??1,wireframe:s.wireframe??!1,side:s.side==="back"?f.BackSide:s.side==="double"?f.DoubleSide:f.FrontSide,polygonOffset:l,polygonOffsetFactor:l?o:0,polygonOffsetUnits:l?o:0,depthTest:s.depthTest??!0,depthWrite:s.depthWrite??!0}),u=new f.Mesh(t,c);if(u.rotation.x=-Math.PI/2,u.position.set(r.x,i,r.z),(s.borderWidth??0)>0){const p={color:s.borderColor??s.color??0,width:s.borderWidth},_=[];for(let M=0;M<e.length;M+=3){const S=e[M],x=e[M+2];_.push(S-r.x,-(x-r.z),0)}const v=ra(p,_);v.position.z+=.1,u.add(v)}return u}function ig(s,e){const t=s.extrude?.height||2e3,r=[],i=[],o=[];for(let p=0;p<e.length;p+=3){const _=e[p],v=e[p+1],M=e[p+2];i.push(new f.Vector3(_,v,M)),o.push(new f.Vector3(_,v+t,M))}r.push(...i,...o);const l=new f.BufferGeometry;l.setFromPoints(r);const c=[],u=i.length;for(let p=0;p<u;p++){const _=(p+1)%u;c.push(p,p+u,_),c.push(_,p+u,_+u)}for(let p=2;p<u;p++)c.push(0,p-1,p),c.push(u,u+p-1,u+p);l.setIndex(c),l.computeVertexNormals();const d=new f.ShaderMaterial({uniforms:{uColor:{value:new f.Color(s.color??16777215)},uOpacity:{value:s.opacity??1},uBrightness:{value:1.2}},vertexShader:`
          varying vec3 vWorldPosition;
          varying vec3 vNormal;
          void main() {
            vNormal = normalize(normalMatrix * normal);
            vWorldPosition = (modelMatrix * vec4(position, 1.0)).xyz;
            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
          }
        `,fragmentShader:`
          uniform vec3 uColor;
          uniform float uOpacity;
          uniform float uBrightness;
          varying vec3 vWorldPosition;
          varying vec3 vNormal;
      
          void main() {
            float fresnel = pow(1.0 - abs(dot(vNormal, vec3(0.0, 0.0, 1.0))), 2.0);
            float innerGlow = smoothstep(0.3, 0.8, length(vWorldPosition - vec3(0.0))) * uBrightness;
            vec3 finalColor = uColor * (1.0 + fresnel * 0.5 + innerGlow);
            gl_FragColor = vec4(finalColor, uOpacity);
            if (uOpacity >= 0.99) gl_FragDepthEXT = gl_FragCoord.z;
          }
        `,transparent:s.transparent??!0,side:f.DoubleSide,depthTest:s.depthTest??!0,depthWrite:s.depthWrite??!0});return new f.Mesh(l,d)}function ng(s,e,t){const{geometry:r,center:i,avgY:o}=ia(t),l=new Nd(r,{textureWidth:512,textureHeight:512,waterNormals:new f.TextureLoader().load(s.normalMap,function(d){d.wrapS=d.wrapT=f.RepeatWrapping}),waterColor:s.color||"#19AAEE",sunColor:s.sunColor||"#05FFF8",distortionScale:1,alpha:s.opacity||.8}),c=l.onBeforeRender,u=l.onAfterRender;return l.onBeforeRender=(d,m,p,_,v,M)=>{e.autoUpdate=!1,c.call(l,d,m,p,_,v,M)},l.onAfterRender=(d,m,p,_,v,M)=>{e.autoUpdate=!0,u.call(l,d,m,p,_,v,M)},l.material.uniforms.size.value=.1,l.rotation.x=-Math.PI/2,l.position.set(i.x,o,i.z),e.sceneRenderer.addEventListener("update",()=>{l.material.uniforms.time.value+=1/60}),l}function ia(s){let e=0;for(let l=1;l<s.length;l+=3)e+=s[l];e/=s.length/3;const t={x:0,z:0},r=[];for(let l=0;l<s.length;l+=3)t.x+=s[l],t.z+=s[l+2];t.x/=s.length/3,t.z/=s.length/3;for(let l=0;l<s.length;l+=3)r.push(new f.Vector2(s[l]-t.x,-(s[l+2]-t.z)));const i=new f.Shape(r);return{geometry:new f.ShapeGeometry(i),center:t,avgY:e}}async function sg(s,e){const{geometry:t,center:r,avgY:i}=ia(e),o=await xt._loadTexture(s.normalMap),l=await xt._loadTexture(s.normalMap);o.wrapS=o.wrapT=f.RepeatWrapping,l.wrapS=l.wrapT=f.RepeatWrapping,o.repeat.set(.015,.015),l.repeat.set(.005,.005);const c=new f.MeshStandardMaterial({color:new f.Color(s.color).multiplyScalar(3.5),roughness:.1,metalness:.8,transparent:s.transparent??!0,opacity:.9,fog:!1,normalMap:o,normalScale:new f.Vector2(1.5,1.5),envMapIntensity:2,depthTest:s.depthTest??!0,depthWrite:s.depthWrite??!0}),u=new f.Mesh(t,c);u.rotation.x=-Math.PI/2,u.position.set(r.x,i+.15,r.z),u.castShadow=!1,u.receiveShadow=!0;let d=0;return u.onBeforeRender=()=>{const m=performance.now(),p=d?(m-d)/1e3:.016;o.offset.x+=p*.08,o.offset.y+=p*.03,l.offset.x-=p*.12,l.offset.y+=p*.02,u.position.y=i+.5+Math.sin(m*.02)*.02,d=m},u}function og(s,e){s.color=new f.Color(s.hexcolor),s.boundstext&&(s.bounds=new f.Vector3(s.boundstext.x,s.boundstext.y,s.boundstext.z));const t=new Hm(s);return t.castShadow=!0,t.scale.setScalar(50),t.position.copy(e),t}async function ag(s,e){const r={...{fontSizeDpi:48,fontFamily:"'Microsoft YaHei', sans-serif",fontWeight:"bold",fontStyle:"normal",textColor:"#ffffff",strokeColor:"#000000",strokeWidth:2,showBackground:!0,bgStyle:1,bgColor:"#3498db",bgOpacity:.8,shadowColor:"rgba(0, 0, 0, 0.5)",shadowBlur:5,shadowOffsetX:3,shadowOffsetY:3,roundRectRadius:20,bubblePointerHeight:10,bubblePointerWidth:15,bubbleBorderColor:"#ffffff",bubbleBorderWidth:3,screenSpaceSize:20,fixedSize:50},...s};r.screenSpaceSize==null&&r.fixedSize!=null&&(r.screenSpaceSize=r.fixedSize);const o=(typeof window<"u"&&window.devicePixelRatio||1)*4,l=s.screenSpaceSize!=null||s.fixedSize!=null;if(s.fontSizeDpi==null&&l){const j=s.screenSpaceSize??s.fixedSize??r.screenSpaceSize;r.fontSizeDpi=j*o}r.fontSizeDpi=Math.min(Math.max(r.fontSizeDpi,8),128);const c=document.createElement("canvas"),u=c.getContext("2d");if(!u)throw new Error("canvas context is null");const d=`${r.fontStyle} ${r.fontWeight} ${r.fontSizeDpi}px ${r.fontFamily}`;u.font=d;const m=r.showBackground?20:0,p=100,_=50,v=u.measureText(r.text),M=Math.max(p,v.width+m*2),S=Math.max(_,r.fontSizeDpi*1.5+m*2);c.width=Math.min(M,2048),c.height=Math.min(S,2048),u.clearRect(0,0,c.width,c.height),u.font=d,r.showBackground&&(r.bgStyle===1?(u.fillStyle=r.bgColor,u.globalAlpha=r.bgOpacity,u.beginPath(),Ic(u,m/2,m/2,c.width-m,c.height-m,r.roundRectRadius),u.fill(),u.globalAlpha=1,u.shadowColor=r.shadowColor,u.shadowBlur=r.shadowBlur,u.shadowOffsetX=r.shadowOffsetX,u.shadowOffsetY=r.shadowOffsetY):(u.fillStyle=r.bgColor,u.globalAlpha=r.bgOpacity,u.beginPath(),Fc(u,c.width/2,c.height/2,c.width*.8,c.height*.8,r.roundRectRadius,r.bubblePointerHeight,r.bubblePointerWidth),u.fill(),u.globalAlpha=1,u.strokeStyle=r.bubbleBorderColor,u.lineWidth=r.bubbleBorderWidth,u.stroke())),u.textAlign="center",u.textBaseline="middle",r.strokeWidth>0&&(u.strokeStyle=r.strokeColor,u.lineWidth=r.strokeWidth,u.lineJoin="round",u.strokeText(r.text,c.width/2,c.height/2)),u.fillStyle=r.textColor,u.fillText(r.text,c.width/2,c.height/2),u.shadowColor="transparent";const x=new f.CanvasTexture(c);x.magFilter=f.NearestFilter,x.minFilter=f.LinearMipmapLinearFilter,x.anisotropy=16;const O=new f.SpriteMaterial({map:x,transparent:s.transparent??!0,depthTest:s.depthTest??!0,depthWrite:s.depthWrite??!0,alphaTest:s.alphaTest??.1,fog:!1}),P=new f.Sprite(O),L=r.screenSpaceSize??r.fixedSize;P.scale.set(c.width*L/100,c.height*L/100,1);const F=ki(s.anchor),z=s.textOffset||{x:0,y:0};return P.center.set(F[0]-z.x/c.width,F[1]+z.y/c.height),e&&P.position.copy(e),P.renderOrder=99,P}async function lg(s,e,t){const i={...{fontSizeDpi:48,fontFamily:"'Microsoft YaHei', sans-serif",fontWeight:"bold",fontStyle:"normal",textColor:"#ffffff",strokeColor:"#000000",strokeWidth:2,showBackground:!0,bgStyle:1,bgColor:"#3498db",bgOpacity:.8,shadowColor:"rgba(0, 0, 0, 0.5)",shadowBlur:5,shadowOffsetX:3,shadowOffsetY:3,roundRectRadius:20,bubblePointerHeight:10,bubblePointerWidth:15,bubbleBorderColor:"#ffffff",bubbleBorderWidth:3,screenSpaceSize:20,maxVisibleDistance:1/0},...s};i.screenSpaceSize==null&&s.fixedSize!=null&&(i.screenSpaceSize=s.fixedSize);const l=(typeof window<"u"&&window.devicePixelRatio||1)*4;s.fontSizeDpi==null&&(i.fontSizeDpi=i.screenSpaceSize*l),i.fontSizeDpi=Math.max(i.fontSizeDpi,8);const c=document.createElement("canvas"),u=c.getContext("2d");if(!u)throw new Error("Failed to get canvas context");const d=`${i.fontStyle} ${i.fontWeight} ${i.fontSizeDpi}px ${i.fontFamily}`;u.font=d;const m=i.showBackground?20:0,p=100,_=50,v=u.measureText(i.text),M=Math.max(p,v.width+m*2),S=Math.max(_,i.fontSizeDpi*1.5+m*2);c.width=Math.min(M,2048),c.height=Math.min(S,2048),u.clearRect(0,0,c.width,c.height),u.font=d,i.showBackground&&(i.bgStyle===1?(u.fillStyle=i.bgColor,u.globalAlpha=i.bgOpacity,u.beginPath(),Ic(u,m/2,m/2,c.width-m,c.height-m,i.roundRectRadius),u.fill(),u.globalAlpha=1,u.shadowColor=i.shadowColor,u.shadowBlur=i.shadowBlur,u.shadowOffsetX=i.shadowOffsetX,u.shadowOffsetY=i.shadowOffsetY):(u.fillStyle=i.bgColor,u.globalAlpha=i.bgOpacity,u.beginPath(),Fc(u,c.width/2,c.height/2,c.width*.8,c.height*.8,i.roundRectRadius,i.bubblePointerHeight,i.bubblePointerWidth),u.fill(),u.globalAlpha=1,u.strokeStyle=i.bubbleBorderColor,u.lineWidth=i.bubbleBorderWidth,u.stroke())),u.textAlign="center",u.textBaseline="middle",i.strokeWidth>0&&(u.strokeStyle=i.strokeColor,u.lineWidth=i.strokeWidth,u.lineJoin="round",u.strokeText(i.text,c.width/2,c.height/2)),u.fillStyle=i.textColor,u.fillText(i.text,c.width/2,c.height/2),u.shadowColor="transparent";const x=new f.CanvasTexture(c),O=new f.SpriteMaterial({map:x,transparent:s.transparent??!0,depthTest:s.depthTest??!0,depthWrite:s.depthWrite??!0,alphaTest:s.alphaTest??.1,fog:!1}),P=new f.Sprite(O),L=ki(s.anchor),F=s.textOffset||{x:0,y:0},z=i.screenSpaceSize,j=z*(c.width/c.height);P.center.set(L[0]-F.x/j,L[1]+F.y/z),P.position.copy(e),P.renderOrder=99,P.userData.isLabel=!0;const G=()=>{if(!P.visible)return;const X=t.sceneRenderer.camera.position.distanceTo(P.position);if(X>i.maxVisibleDistance){P.visible=!1;return}P.visible=!0;const N=new f.Vector2;t.sceneRenderer.renderer.getSize(N);const k=N.height,Z=f.MathUtils.degToRad(t.sceneRenderer.camera.fov),E=typeof window<"u"&&window.devicePixelRatio||1,te=i.screenSpaceSize*E/c.height*(2*X*Math.tan(Z/2)/k);P.scale.set(te*c.width,te*c.height,1),P.lookAt(t.sceneRenderer.camera.position)};G();const U=()=>G();return P.addEventListener("dispose",()=>{t.sceneRenderer.renderer.domElement.removeEventListener("resize",G)}),t.sceneRenderer.renderer.domElement.addEventListener("resize",G),t.sceneRenderer.camera.addEventListener("change",G),P.onBeforeRender=U,P}async function cg(s,e){const t=s.size??s.iconSize,r={text:s.text||"",iconSize:t,fontSize:s.fontSize??12,fontFamily:s.fontFamily||"微软雅黑",fontWeight:s.fontWeight??400,padding:{top:3,right:6,bottom:3,left:6,...s.padding},bgColor:s.bgColor||"#ffffff",bgOpacity:s.bgOpacity??1,textColor:s.textColor||"#000000",strokeColor:s.strokeColor||"#000000",strokeWidth:s.strokeWidth??0,iconScale:s.iconScale??1,renderbg:s.renderbg??!0,textOffset:s.textOffset??{x:-40,y:-19},depthTest:s.depthTest??!1,depthWrite:s.depthWrite??!1,transparent:s.transparent??!0,canvasScale:4};let i=null;if(s.url)try{i=await gg(s.url)}catch{console.error("Label icon load failed:",s.url)}const{canvas:o,width:l,height:c,center:u}=await ug(r,i),d=new f.Texture(o);d.generateMipmaps=!0,d.minFilter=f.LinearMipmapLinearFilter,d.magFilter=f.LinearFilter,d.colorSpace=f.SRGBColorSpace,d.premultiplyAlpha=!1,d.needsUpdate=!0;const m=new f.SpriteMaterial({map:d,transparent:r.transparent??!0,depthTest:r.depthTest??!0,depthWrite:r.depthWrite??!0,blending:f.NormalBlending,sizeAttenuation:!1,premultipliedAlpha:!1,alphaTest:.05}),p=new f.Sprite(m),_=.002;if(p.scale.set(l*_,c*_,1),s.anchor){const v=ki(s.anchor);p.center.set(v[0],v[1])}else p.center.set(u[0],u[1]);return e&&p.position.copy(e),p.renderOrder=99,p}async function ug(s,e){return new Promise(t=>{const{text:r,fontSize:i,fontFamily:o,padding:l,bgColor:c,textColor:u,strokeColor:d,strokeWidth:m,iconScale:p,canvasScale:_,renderbg:v,textOffset:M,iconSize:S,fontWeight:x,bgOpacity:O}=s,P=e!==null;let L=0,F=0;if(P&&e){const We=e.naturalWidth||e.width||1,St=e.naturalHeight||e.height||1,mi=We/St||1;Array.isArray(S)?(L=S[0],F=S[1]):typeof S=="number"?(F=S,L=S*mi):(L=We,F=St)}else Array.isArray(S)?(L=S[0],F=S[1]):typeof S=="number"&&(L=S,F=S);const j=document.createElement("canvas").getContext("2d"),G=`${x} ${i}px ${o}`;j.font=G;const U=fg(j,r,i),{width:X,ascent:N,descent:k}=U,Z=P?L/2:0,E=P?F/2:0,q=Z+M.x,te=E+M.y,H=q-l.left,Pe=q+X+l.right,ve=te-N-l.top,we=te+k+l.bottom;let me,Le,Ce,Oe;P?(me=Math.min(0,H),Le=Math.min(0,ve),Ce=Math.max(L,Pe),Oe=Math.max(F,we)):(me=H,Le=ve,Ce=Pe,Oe=we);const lt=Math.ceil(Ce-me),ct=Math.ceil(Oe-Le),{canvas:Vt,ctx:Et}=hg(lt,ct,_),gt=-me,Jt=-Le;if(P&&e&&L>0&&F>0){const We=L*p,St=F*p,mi=(L-We)/2,_t=(F-St)/2,gi=gt+mi,Zi=Jt+_t;Et.drawImage(e,gi,Zi,We,St)}const Yi=gt+q,xr=Jt+te;v&&c&&c!=="transparent"&&pg(Et,Yi,xr,X,N,k,l,c,O),Et.font=G,mg(Et,r,Yi,xr,u,m,d);let Ht,Mr;P&&L>0&&F>0?(Ht=(gt+Z)/lt,Mr=(Jt+E)/ct):(Ht=.5,Mr=.5),t({canvas:Vt,width:lt,height:ct,center:[Ht,1-Mr]})})}function Ic(s,e,t,r,i,o){s.beginPath(),s.moveTo(e+o,t),s.lineTo(e+r-o,t),s.quadraticCurveTo(e+r,t,e+r,t+o),s.lineTo(e+r,t+i-o),s.quadraticCurveTo(e+r,t+i,e+r-o,t+i),s.lineTo(e+o,t+i),s.quadraticCurveTo(e,t+i,e,t+i-o),s.lineTo(e,t+o),s.quadraticCurveTo(e,t,e+o,t),s.closePath()}function Fc(s,e,t,r,i,o,l,c){if(r<=0)throw new Error("Width must be positive");if(i<=0)throw new Error("Height must be positive");if(o<0)throw new Error("Radius cannot be negative");const u=r,d=i,m=Math.min(o,r/2,i/2),p=l??10,_=c??15;s.beginPath(),s.moveTo(e-u/2+m,t-d/2),s.lineTo(e+u/2-m,t-d/2),s.quadraticCurveTo(e+u/2,t-d/2,e+u/2,t-d/2+m),s.lineTo(e+u/2,t+d/2-m),s.quadraticCurveTo(e+u/2,t+d/2,e+u/2-m,t+d/2),s.lineTo(e+_/2,t+d/2),s.lineTo(e,t+d/2+p),s.lineTo(e-_/2,t+d/2),s.lineTo(e-u/2+m,t+d/2),s.quadraticCurveTo(e-u/2,t+d/2,e-u/2,t+d/2-m),s.lineTo(e-u/2,t-d/2+m),s.quadraticCurveTo(e-u/2,t-d/2,e-u/2+m,t-d/2),s.closePath()}function hg(s,e,t){const r=document.createElement("canvas");r.width=Math.ceil(s*t),r.height=Math.ceil(e*t);const i=r.getContext("2d",{alpha:!0});return i.scale(t,t),i.imageSmoothingEnabled=!1,{canvas:r,ctx:i}}function fg(s,e,t){const r=s.measureText(e);return{width:r.width,ascent:r.actualBoundingBoxAscent||t*.8,descent:r.actualBoundingBoxDescent||t*.2,totalHeight:(r.actualBoundingBoxAscent||t*.8)+(r.actualBoundingBoxDescent||t*.2)}}function dg(s,e,t,r,i,o){s.beginPath(),s.moveTo(e+o,t),s.lineTo(e+r-o,t),s.arcTo(e+r,t,e+r,t+o,o),s.lineTo(e+r,t+i-o),s.arcTo(e+r,t+i,e+r-o,t+i,o),s.lineTo(e+o,t+i),s.arcTo(e,t+i,e,t+i-o,o),s.lineTo(e,t+o),s.arcTo(e,t,e+o,t,o),s.closePath()}function pg(s,e,t,r,i,o,l,c,u=1){const d=e-l.left,m=t-i-l.top,p=r+l.left+l.right,_=i+o+l.top+l.bottom;s.save(),s.globalAlpha=u,s.fillStyle=c,dg(s,d,m,p,_,2),s.fill(),s.restore()}function mg(s,e,t,r,i,o,l){s.save(),s.textBaseline="alphabetic",s.textAlign="left",o>0&&(s.strokeStyle=l,s.lineWidth=o,s.lineJoin="round",s.strokeText(e,t,r)),s.fillStyle=i,s.fillText(e,t,r),s.restore()}function gg(s){return new Promise((e,t)=>{const r=new Image;r.crossOrigin="Anonymous",r.onload=()=>e(r),r.onerror=i=>t(new Error(`Failed to load image: ${s} ${i}`)),r.src=s})}async function _g(s,e,t){const i=new f.CylinderGeometry(.2,.2,24,12),o=new f.MeshBasicMaterial({color:s.color}),l=await xt._loadTexture(s.icon),c=new f.PointsMaterial({size:80*window.innerHeight/window.innerHeight,fog:!1,opacity:1,transparent:s.transparent??!0,toneMapped:!1,blending:f.AdditiveBlending,map:l,sizeAttenuation:!0,depthTest:s.depthTest??!0,depthWrite:s.depthWrite??!1}),u=new f.InstancedMesh(i,o,e.length);u.position.add(t.prjcenter),u.castShadow=!0;const d=new f.Object3D,m=[];for(let M=0;M<e.length;M++){const S=e[M],x=new f.Vector3(S.coordinates[0],S.coordinates[1],S.coordinates[2]||0),P=t.lngLatToWorld(x).sub(t.prjcenter);d.position.copy(P),d.updateMatrix(),u.setMatrixAt(M,d.matrix),m.push(P.x,0,P.z)}const p=new Float32Array(m),_=new f.BufferGeometry;_.setAttribute("position",new f.BufferAttribute(p,3));const v=new f.Points(_,c);return v.position.add(t.prjcenter),v.position.y=1.5*10,v.renderOrder=99999999,v.visible=!0,{points:v,InstancedCol:u}}var yg=Object.defineProperty,vg=(s,e,t)=>e in s?yg(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Bc=(s,e,t)=>vg(s,typeof e!="symbol"?e+"":e,t);const na=class Ii{constructor(e){this.config=e}async applyTo(e){if(!e)return!1;try{switch(e.visible=this.config.visible!==!1,this.config.type){case"circle":case"icon":case"symbol":return this._applyPointPaint(e);case"line":return this._applyLinePaint(e);case"flow-tube":return this._applyFlowTubePaint(e);case"arrow":return this._applyArrowPaint(e);case"flow-texture":return this._applyFlowTexturePaint(e);case"model-gltf":case"model-fbx":return this._applyModelPaint(e);case"fill":return this._applyFillPaint(e);case"extrusion":return this._applyExtrusionPaint(e);case"water":case"water-simple":return this._applyWaterPaint(e);case"cloud":return this._applyCloudPaint(e);case"text":case"text-fixed":return this._applyTextPaint(e);case"light":return this._applyLightPaint(e);case"custom":return this._applyCustomPaint(e);default:throw new Error("Unknown paint type")}}catch(t){return console.error("Paint apply failed:",t),e.visible=!1,!1}}async _applyPointPaint(e){const t=this.config;return t.type==="icon"?await this._applyIconPaint(e,t):t.type==="circle"?this._applyCirclePaint(e,t):t.type==="symbol"&&this._applySymbolPaint(e,t),!0}async _applyIconPaint(e,t){return!0}_applyCirclePaint(e,t){let r;if(e instanceof f.Points)r=e;else if(r=Cc(t,e.position),r.position.copy(e.position),r.rotation.copy(e.rotation),r.scale.copy(e.scale),e.parent){let l=e.parent;l._renderObject=r,l._updateGeometry()}const i=r.material,o=t.sizeAttenuation;i.size=o?t.size*.002:t.size,t.color&&i.color.set(t.color),i.sizeAttenuation=o??!1,i.onBeforeCompile=l=>{l.fragmentShader=l.fragmentShader.replace("#include <clipping_planes_fragment>",`
                #include <clipping_planes_fragment>
                vec2 coord = gl_PointCoord - vec2(0.5);
                if(length(coord) > 0.5) discard;
                `)},i.needsUpdate=!0}_applySymbolPaint(e,t){return!0}_applyLinePaint(e){return this.config,!0}_applyFlowTubePaint(e){return!0}_applyArrowPaint(e){return!0}_applyFlowTexturePaint(e){return!0}_applyFillPaint(e){return!0}_applyExtrusionPaint(e){return!0}_applyWaterPaint(e){return!0}_applyCloudPaint(e){return!0}_applyTextPaint(e){return!0}_applyLightPaint(e){return!0}async _applyModelPaint(e){return!0}async _applyCustomPaint(e){const r=await this.config.build();return e instanceof f.Group&&(e.clear(),e.add(r)),!0}static async _loadTexture(e){if(Ii._textureCache.has(e))return Ii._textureCache.get(e);const t=await new Promise((r,i)=>{Ii._textureLoader.load(e,r,void 0,i)});return t.needsUpdate=!0,Ii._textureCache.set(e,t),t}static create(e){return e instanceof Ii?e:new Ii(e)}};Bc(na,"_textureCache",new Map),Bc(na,"_textureLoader",new f.TextureLoader);let xt=na;var wg=Object.defineProperty,bg=(s,e,t)=>e in s?wg(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,zi=(s,e,t)=>bg(s,typeof e!="symbol"?e+"":e,t);class xg{constructor(e,t){zi(this,"_paintQueue",[]),zi(this,"_isApplyingPaint",!1),zi(this,"_currentPaint"),zi(this,"_onPaintApplied"),zi(this,"_getRenderObject"),zi(this,"_addRenderObject"),this._getRenderObject=e,this._addRenderObject=t}setOnPaintApplied(e){this._onPaintApplied=e}getCurrentPaint(){return this._currentPaint}enqueuePaint(e){const t=e instanceof xt?e:new xt(e);this._currentPaint=t;const r=JSON.parse(JSON.stringify(t.config));return this._paintQueue.push(r),this._tryProcessPaintQueue(),t}canProcessQueue(){return this._getRenderObject()!==null&&!this._isApplyingPaint&&this._paintQueue.length>0}_tryProcessPaintQueue(){this.canProcessQueue()&&this._processPaintQueue().catch(e=>{this._isApplyingPaint=!1,this._tryProcessPaintQueue(),console.warn("Paint application failed:",e)})}async _processPaintQueue(){const e=this._getRenderObject();if(!e||this._isApplyingPaint||this._paintQueue.length===0)return;this._isApplyingPaint=!0;const t=this._paintQueue[0];try{const r=new xt(JSON.parse(JSON.stringify(t)));await this._applyPaintWithRetry(r,e),this._paintQueue.shift(),this._paintQueue.length>0&&await this._processPaintQueue()}catch(r){throw r}finally{this._isApplyingPaint=!1,this._paintQueue.length>0&&this._tryProcessPaintQueue()}}async _applyPaintWithRetry(e,t,r=3,i=100){let o=null;for(let l=1;l<=r;l++)try{t.parent||(this._addRenderObject(),await new Promise(c=>requestAnimationFrame(c))),await e.applyTo(t),this._onPaintApplied&&this._onPaintApplied(e);return}catch(c){if(o=c,l<r){const u=i*Math.pow(2,l-1);await new Promise(d=>setTimeout(d,u))}}throw o||new Error("Paint application failed after retries")}get isApplyingPaint(){return this._isApplyingPaint}get hasPendingPaints(){return this._paintQueue.length>0}}var Mg=Object.defineProperty,Sg=(s,e,t)=>e in s?Mg(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ag=(s,e,t)=>Sg(s,e+"",t);class Pg{constructor(){Ag(this,"_bloomConfig")}getBloomConfig(){return this._bloomConfig}setBloomConfig(e,t){const r=this._bloomConfig||{intensity:1,color:"#ffffff"};return this._bloomConfig={enabled:e,intensity:t?.intensity??r.intensity,color:t?.color??r.color},this._bloomConfig}applyStyleBloom(e){e!==void 0&&(typeof e=="boolean"?this._bloomConfig={enabled:e,intensity:1,color:"#ffffff"}:this._bloomConfig={enabled:e.enabled??!0,intensity:e.intensity??1,color:e.color??"#ffffff"})}applyBloomToObject(e){if(!this._bloomConfig)return;const{enabled:t,intensity:r,color:i}=this._bloomConfig;e.traverse(o=>{if(o instanceof f.Points&&o.material){this._applyBloomToPoints(o,t,r);return}if(o.type==="Sprite"&&o.material){this._applyBloomToSprite(o,t,r,i);return}if(o.isLine2&&o.material){this._applyBloomToLine2(o,t,r,i);return}o instanceof f.Mesh&&o.material&&this._applyBloomToMesh(o,t,r,i)})}_applyBloomToPoints(e,t,r){const i=e.material;e.userData=e.userData||{},e.userData.__bloomBackup||(e.userData.__bloomBackup={size:i.size,sizeAttenuation:i.sizeAttenuation});const o=e.userData.__bloomBackup;t?(i.size=o.size*(1+r),i.sizeAttenuation=!1):(i.size=o.size,i.sizeAttenuation=o.sizeAttenuation),i.needsUpdate=!0}_applyBloomToSprite(e,t,r,i){const o=e.material;e.userData=e.userData||{},e.userData.__bloomBackup||(e.userData.__bloomBackup={color:o.color?o.color.clone():null,opacity:o.opacity??1});const l=e.userData.__bloomBackup;t?(o.color&&l.color&&(o.color.copy(l.color),i&&i!=="#ffffff"&&o.color.setStyle(i),o.color.multiplyScalar(1+r*2)),o.opacity=Math.min(1,(l.opacity??1)*(1+r*.3))):(l.color&&o.color&&o.color.copy(l.color),o.opacity=l.opacity),o.needsUpdate=!0}_applyBloomToLine2(e,t,r,i){const o=e.material;e.userData=e.userData||{},e.userData.__bloomBackup||(e.userData.__bloomBackup={color:o.color?o.color.clone():null,opacity:o.opacity??1});const l=e.userData.__bloomBackup;t?(o.color&&l.color&&(o.color.copy(l.color),i&&i!=="#ffffff"&&o.color.setStyle(i),o.color.multiplyScalar(1+r*2)),o.opacity=Math.min(1,(l.opacity??1)*(1+r*.3))):(l.color&&o.color&&o.color.copy(l.color),o.opacity=l.opacity),o.needsUpdate=!0}_applyBloomToMesh(e,t,r,i){(Array.isArray(e.material)?e.material:[e.material]).forEach(l=>{e.userData=e.userData||{},e.userData.__bloomBackup||(e.userData.__bloomBackup={emissiveIntensity:l.emissiveIntensity??0,emissiveColor:l.emissive?l.emissive.clone():null,color:l.color?l.color.clone():null});const c=e.userData.__bloomBackup;t?"emissive"in l&&l.emissive?(l.emissiveIntensity=r,i&&i!=="#ffffff"&&l.emissive.setStyle?l.emissive.setStyle(i):c.color&&l.emissive&&l.emissive.copy(c.color)):l.color&&(c.color&&l.color.copy(c.color),i&&i!=="#ffffff"?l.color.setStyle(i):l.color.multiplyScalar(1+r*.3)):("emissiveIntensity"in l&&(l.emissiveIntensity=c.emissiveIntensity!==void 0?c.emissiveIntensity:0),c.emissiveColor&&l.emissive&&l.emissive.copy(c.emissiveColor),c.color&&l.color&&l.color.copy(c.color)),l.needsUpdate=!0})}}var Lg=Object.defineProperty,Cg=(s,e,t)=>e in s?Lg(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ut=(s,e,t)=>Cg(s,typeof e!="symbol"?e+"":e,t);class Je extends Eo(zr(ui(f.Object3D))){constructor(e){super(),Ut(this,"_worldCoordinates"),Ut(this,"_renderObject"),Ut(this,"_geometry"),Ut(this,"_layer"),Ut(this,"_paint"),Ut(this,"_id"),Ut(this,"_paintManager"),Ut(this,"_bloomHelper"),Ut(this,"_isGeometryInitializing",!1),Ut(this,"_collisionConfig",{enabled:!1,priority:50,padding:4}),Ut(this,"_collisionState",{visible:!0,reason:hr.NO_COLLISION,collidedWith:[],timestamp:Date.now()}),Ut(this,"_animationRef",null),Xo(e.geometry,"geometry","geometry must be specified"),this._geometry=e.geometry,this._worldCoordinates=new f.Vector3(0,0,0),this._renderObject=new f.Object3D,this.options={draggable:e.draggable||!1,editable:e.editable||!1},e.id?this._id=e.id:this._id=jm(),this._paintManager=new xg(()=>this._renderObject,()=>this._ensureRenderObjectInScene()),this._paintManager.setOnPaintApplied(t=>{this._onPaintApplied(t)}),this._bloomHelper=new Pg,e.userData&&(this.userData=Object.assign({},JSON.parse(JSON.stringify(e.userData)))),e.paint&&this.setPaint(e.paint),this.addHandler("draggable",Zm)}_ensureRenderObjectInScene(){this._renderObject&&!this._renderObject.parent&&this.add(this._renderObject)}_applyAlphaToObject(e){this._renderObject?.traverse?.(t=>{t.material&&(Array.isArray(t.material)?t.material:[t.material]).forEach(i=>{i&&typeof i.opacity<"u"&&(i.opacity=e*(i.userData?.originalOpacity??1),i.transparent=i.opacity<1,i.needsUpdate=!0)})})}_onPaintApplied(e){e.config.bloom!==void 0&&(this._bloomHelper.applyStyleBloom(e.config.bloom),this._bloomHelper.applyBloomToObject(this._renderObject))}async initializeGeometry(){if(!(this._isGeometryInitializing||this._renderObject)){this._isGeometryInitializing=!0;try{await this._buildRenderObject(),this._paintManager._tryProcessPaintQueue()}finally{this._isGeometryInitializing=!1}}}_refreshCoordinates(){this._buildRenderObject()}setPaint(e){return this._paint=this._paintManager.enqueuePaint(e),this}getPaint(){return this._paint}get paint(){return this._paint}set paint(e){e&&this.setPaint(e)}setBloom(e,t){return this._bloomHelper.setBloomConfig(e,t),this._bloomHelper.applyBloomToObject(this._renderObject),this}getBloom(){return this._bloomHelper.getBloomConfig()}addTo(e){return e.addFeature(this),this}getLayer(){return this._layer||null}getMap(){return this._layer?this._layer.getMap():null}setCoordinates(e){return this._geometry.coordinates=e,this._applyCoordinateChanges(),this}_applyCoordinateChanges(e=!1){e&&this._renderObject?this._refreshCoordinates():this._buildRenderObject(),this.fire("move")}getCenter(){return this._geometry.type==="Point"?this._geometry.coordinates:[0,0]}_bindLayer(e){if(this._layer&&this._layer!==e)throw new Error("Feature cannot be added to multiple layers");this._layer=e}_updateGeometry(){this._disposeGeometry(),this._renderObject&&(this._renderObject.position.copy(this._worldCoordinates),this._renderObject?.userData?._type==="Model"?this._renderObject.renderOrder=0:this._renderObject.renderOrder=99,this.add(this._renderObject),this.updateMatrixWorld(!0),this._tryProcessQueue())}_tryProcessQueue(){this._paintManager._tryProcessPaintQueue()}_remove(){return this.getLayer()?(this._unbind(),this):this}_unbind(){const e=this.getLayer();e&&(e.onRemoveFeature&&e.onRemoveFeature(this),delete this._layer)}_disposeGeometry(){this._renderObject&&(this.clear(),"traverse"in this&&this._renderObject.traverse(e=>{e instanceof f.Mesh?(e.geometry?.dispose(),Array.isArray(e.material)?e.material.forEach(t=>t.dispose()):e.material?.dispose()):"isLine"in e&&e.isLine&&(e.geometry?.dispose(),e.material?.dispose())}))}get collidable(){return this._collisionConfig.enabled}get collisionType(){return Mc.POINT}getCollisionPriority(){return this.userData.collisionPriority??this._paint?.config.collisionPriority??this._collisionConfig.priority}getScreenBoundingBox(e,t){if(!this.collidable||!this._renderObject)return null;try{const r=new f.Vector3;this._renderObject.getWorldPosition(r);const i=r.clone().project(e);if(!(i.x>=-1.1&&i.x<=1.1&&i.y>=-1.1&&i.y<=1.1&&i.z>=-1&&i.z<=1))return null;const{width:l,height:c}=t.domElement,u=(i.x*.5+.5)*l,d=(-i.y*.5+.5)*c,m=this._calculateCollisionBoundingBox(e,t);return m?{id:this._id,x:u+m.offsetX,y:d+m.offsetY,width:m.width+this._collisionConfig.padding*2,height:m.height+this._collisionConfig.padding*2,priority:this.getCollisionPriority(),featureId:this._id,layerId:this._layer?.getId()||"unknown",type:this.collisionType,data:this.getCollisionData()}:null}catch(r){return console.warn(`Feature ${this._id} 包围盒计算失败:`,r),null}}setCollisionVisibility(e,t=hr.MANUAL_HIDDEN){this._collisionState.visible!==e&&(this._animationRef!==null&&(cancelAnimationFrame(this._animationRef),this._animationRef=null),this.visible=e,this._applyFinalAlpha(e?1:0),this._collisionState={visible:e,reason:t,collidedWith:e?[]:this._collisionState.collidedWith,timestamp:Date.now()})}getCollisionVisibility(){return this._collisionState.visible}setCollisionConfig(e){return Object.assign(this._collisionConfig,e),this}enableCollision(){return this._collisionConfig.enabled=!0,this}disableCollision(){return this._collisionConfig.enabled=!1,this.setCollisionVisibility(!0,hr.MANUAL_HIDDEN),this}_applyVisibilityAlpha(e){this.traverse(t=>{t instanceof f.Mesh&&(Array.isArray(t.material)?t.material.forEach(r=>{r.opacity!==void 0&&(r.opacity=e)}):t.material.opacity!==void 0&&(t.material.opacity=e))})}_applyFinalAlpha(e){this._applyVisibilityAlpha(e),this.traverse(t=>{t instanceof f.Mesh&&(t.material.needsUpdate=!0)})}getCollisionData(){return{featureType:this.constructor.name,userData:this.userData,paintConfig:this._paint?.config}}_calculateCollisionBoundingBox(e,t){if(!this.visible||!this._renderObject||!e||!t)return null;try{const r=new f.Box3().setFromObject(this._renderObject);if(r.isEmpty())return this._getFallbackBoundingBox();const i=[new f.Vector3(r.min.x,r.min.y,r.min.z),new f.Vector3(r.max.x,r.min.y,r.min.z),new f.Vector3(r.min.x,r.max.y,r.min.z),new f.Vector3(r.max.x,r.max.y,r.min.z),new f.Vector3(r.min.x,r.min.y,r.max.z),new f.Vector3(r.max.x,r.min.y,r.max.z),new f.Vector3(r.min.x,r.max.y,r.max.z),new f.Vector3(r.max.x,r.max.y,r.max.z)],{width:o,height:l}=t.domElement,c=[];i.forEach(z=>{const j=z.clone().project(e),G=(j.x*.5+.5)*o,U=(-j.y*.5+.5)*l;c.push(new f.Vector2(G,U))});let u=1/0,d=-1/0,m=1/0,p=-1/0;c.forEach(z=>{u=Math.min(u,z.x),d=Math.max(d,z.x),m=Math.min(m,z.y),p=Math.max(p,z.y)});const _=d-u,v=p-m,M=4,S=Math.max(_,M),x=Math.max(v,M),O=new f.Vector3;r.getCenter(O);const P=O.clone().project(e),L=(P.x*.5+.5)*o,F=(-P.y*.5+.5)*l;return{width:S,height:x,offsetX:u-L,offsetY:m-F}}catch(r){return console.warn("Bounding box calculation failed 包围盒计算失败:",r),this._getFallbackBoundingBox()}}_getFallbackBoundingBox(){return{width:20,height:20,offsetX:-10,offsetY:-10}}_tileCoordToLocalWorld(e,t,r,i){const{tileZ:o,tileX:l,tileY:c,extent:u,tileSize:d}=r,m=(e/u-.5)*d,p=(.5-t/u)*d;return i.tileIDToWorldCenter(o,l,c).clone().add(new f.Vector3(m,p,0)).sub(i.prjcenter)}}var Og=Object.defineProperty,Tg=(s,e,t)=>e in s?Og(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Uc=(s,e,t)=>Tg(s,typeof e!="symbol"?e+"":e,t);class Nr extends ds{constructor(e,t){super(e,t),Uc(this,"_feaList"),Uc(this,"_collision",!1),this._feaList=[],t?.collision&&(this._collision=!0)}addFeature(e){const t=Array.isArray(e)?e:[e];for(const r of t)if(!(!r||!(r instanceof Je))&&!r.getLayer()){if(!this.validateFeature(r)){console.error(`Feature ${r.id} does not match the layer's type requirements`);continue}r._bindLayer(this),this._feaList.push(r),r.getMap()&&r._buildRenderObject(),this._clouds&&(this.map.sceneRenderer.scene.add(this._clouds),console.log("我是云朵被添加cloud",this.map.sceneRenderer.scene)),this.add(r)}return this}getFeatures(e,t){if(!e)return this._feaList.slice(0);const r=[];let i,o;for(let l=0,c=this._feaList.length;l<c;l++)i=this._feaList[l],t?o=e.call(t,i):o=e(i),o&&r.push(i);return r}getCount(){return this._feaList.length}isEmpty(){return!this._feaList.length}removeFeature(e){if(!Array.isArray(e))return this.removeFeature([e]);for(let t=e.length-1;t>=0;t--)e[t]instanceof Je||(e[t]=this.removeFeature(e[t])),!(!e[t]||this!==e[t].getLayer())&&e[t]._remove();return this}clear(){const e=this._feaList.slice();for(const t of e)t._remove();return this}onRemoveFeature(e){if(!e)return;const t=e.getLayer();if(!t||t!==this)return;const r=this._findInList(e);r>=0&&this._feaList.splice(r,1),e.parent&&e.parent===this?this.remove(e):console.warn("Feature parent mismatch:",e.parent),this._disposeFeatureResources(e)}_findInList(e){const t=this._feaList.length;if(t===0)return-1;let r=0,i=t-1,o;for(;r<=i;){if(o=Math.floor((r+i)/2),this._feaList[o]===e)return o;r=o+1}return-1}_disposeFeatureResources(e){try{e.geometry&&e.geometry.dispose&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(t=>t.dispose?.()):e.material.dispose&&e.material.dispose()),e instanceof f.Object3D&&e.traverse(t=>{t!==e&&this._disposeFeatureResources(t)})}catch(t){console.error("Error disposing feature resources:",t)}}_mergedGeometry(){this.traverse(e=>{e.isMesh&&e.geometry&&e.material&&console.log("Merging geometry 几何体合并中",e)})}setCollisionEngine(e){return this._collisionEngine=e,this}}var Dg=Object.defineProperty,Ig=(s,e,t)=>e in s?Dg(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Vc=(s,e,t)=>Ig(s,typeof e!="symbol"?e+"":e,t);class Fg extends f.Group{constructor(){super(...arguments),Vc(this,"_layers",new Set),Vc(this,"_layerids",new Set)}add(...e){return e.forEach(t=>{if(!(t instanceof ds))throw new Error("LayerContainer can only contain Layer instances! LayerContainer只能包含Layer实例!");const r=t.getId();if(this._layerids.has(r))throw new Error(`Layer with ID '${r}' already exists in the container! ID为'${r}'的图层已存在于容器中!`);this._layers.add(t),this._layerids.add(r),super.add(t)}),this}remove(...e){return e.forEach(t=>{this._layers.delete(t),this._layerids.delete(t.getId()),super.remove(t)}),this}getLayers(){return Array.from(this._layers)}getLayerById(e){for(const t of this._layers)if(t.getId()===e)return t}clearLayers(){return this._layers.clear(),this._layerids.clear(),super.clear(),this}}var Bg=Object.defineProperty,Ug=(s,e,t)=>e in s?Bg(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Vg=(s,e,t)=>Ug(s,e+"",t);class kg{constructor(){Vg(this,"canvasDict",{})}getCanvas(e=40,t=30,r=1,i){const o=Math.ceil(e*r),l=Math.ceil(t*r),c=i?`${o}_${l}_${i}`:`${o}_${l}`;if(!this.canvasDict[c]){const m=document.createElement("canvas");m.width=o,m.height=l,this.canvasDict[c]=m}const u=this.canvasDict[c],d=u.getContext("2d");return d.setTransform(1,0,0,1,0,0),d.clearRect(0,0,u.width,u.height),d.scale(r,r),u}}function zg(s){const e=+this._x.call(null,s),t=+this._y.call(null,s);return kc(this.cover(e,t),e,t,s)}function kc(s,e,t,r){if(isNaN(e)||isNaN(t))return s;var i,o=s._root,l={data:r},c=s._x0,u=s._y0,d=s._x1,m=s._y1,p,_,v,M,S,x,O,P;if(!o)return s._root=l,s;for(;o.length;)if((S=e>=(p=(c+d)/2))?c=p:d=p,(x=t>=(_=(u+m)/2))?u=_:m=_,i=o,!(o=o[O=x<<1|S]))return i[O]=l,s;if(v=+s._x.call(null,o.data),M=+s._y.call(null,o.data),e===v&&t===M)return l.next=o,i?i[O]=l:s._root=l,s;do i=i?i[O]=new Array(4):s._root=new Array(4),(S=e>=(p=(c+d)/2))?c=p:d=p,(x=t>=(_=(u+m)/2))?u=_:m=_;while((O=x<<1|S)===(P=(M>=_)<<1|v>=p));return i[P]=o,i[O]=l,s}function Ng(s){var e,t,r=s.length,i,o,l=new Array(r),c=new Array(r),u=1/0,d=1/0,m=-1/0,p=-1/0;for(t=0;t<r;++t)isNaN(i=+this._x.call(null,e=s[t]))||isNaN(o=+this._y.call(null,e))||(l[t]=i,c[t]=o,i<u&&(u=i),i>m&&(m=i),o<d&&(d=o),o>p&&(p=o));if(u>m||d>p)return this;for(this.cover(u,d).cover(m,p),t=0;t<r;++t)kc(this,l[t],c[t],s[t]);return this}function Rg(s,e){if(isNaN(s=+s)||isNaN(e=+e))return this;var t=this._x0,r=this._y0,i=this._x1,o=this._y1;if(isNaN(t))i=(t=Math.floor(s))+1,o=(r=Math.floor(e))+1;else{for(var l=i-t||1,c=this._root,u,d;t>s||s>=i||r>e||e>=o;)switch(d=(e<r)<<1|s<t,u=new Array(4),u[d]=c,c=u,l*=2,d){case 0:i=t+l,o=r+l;break;case 1:t=i-l,o=r+l;break;case 2:i=t+l,r=o-l;break;case 3:t=i-l,r=o-l;break}this._root&&this._root.length&&(this._root=c)}return this._x0=t,this._y0=r,this._x1=i,this._y1=o,this}function Wg(){var s=[];return this.visit(function(e){if(!e.length)do s.push(e.data);while(e=e.next)}),s}function Gg(s){return arguments.length?this.cover(+s[0][0],+s[0][1]).cover(+s[1][0],+s[1][1]):isNaN(this._x0)?void 0:[[this._x0,this._y0],[this._x1,this._y1]]}function ot(s,e,t,r,i){this.node=s,this.x0=e,this.y0=t,this.x1=r,this.y1=i}function $g(s,e,t){var r,i=this._x0,o=this._y0,l,c,u,d,m=this._x1,p=this._y1,_=[],v=this._root,M,S;for(v&&_.push(new ot(v,i,o,m,p)),t==null?t=1/0:(i=s-t,o=e-t,m=s+t,p=e+t,t*=t);M=_.pop();)if(!(!(v=M.node)||(l=M.x0)>m||(c=M.y0)>p||(u=M.x1)<i||(d=M.y1)<o))if(v.length){var x=(l+u)/2,O=(c+d)/2;_.push(new ot(v[3],x,O,u,d),new ot(v[2],l,O,x,d),new ot(v[1],x,c,u,O),new ot(v[0],l,c,x,O)),(S=(e>=O)<<1|s>=x)&&(M=_[_.length-1],_[_.length-1]=_[_.length-1-S],_[_.length-1-S]=M)}else{var P=s-+this._x.call(null,v.data),L=e-+this._y.call(null,v.data),F=P*P+L*L;if(F<t){var z=Math.sqrt(t=F);i=s-z,o=e-z,m=s+z,p=e+z,r=v.data}}return r}function jg(s){if(isNaN(m=+this._x.call(null,s))||isNaN(p=+this._y.call(null,s)))return this;var e,t=this._root,r,i,o,l=this._x0,c=this._y0,u=this._x1,d=this._y1,m,p,_,v,M,S,x,O;if(!t)return this;if(t.length)for(;;){if((M=m>=(_=(l+u)/2))?l=_:u=_,(S=p>=(v=(c+d)/2))?c=v:d=v,e=t,!(t=t[x=S<<1|M]))return this;if(!t.length)break;(e[x+1&3]||e[x+2&3]||e[x+3&3])&&(r=e,O=x)}for(;t.data!==s;)if(i=t,!(t=t.next))return this;return(o=t.next)&&delete t.next,i?(o?i.next=o:delete i.next,this):e?(o?e[x]=o:delete e[x],(t=e[0]||e[1]||e[2]||e[3])&&t===(e[3]||e[2]||e[1]||e[0])&&!t.length&&(r?r[O]=t:this._root=t),this):(this._root=o,this)}function Xg(s){for(var e=0,t=s.length;e<t;++e)this.remove(s[e]);return this}function Yg(){return this._root}function Zg(){var s=0;return this.visit(function(e){if(!e.length)do++s;while(e=e.next)}),s}function Kg(s){var e=[],t,r=this._root,i,o,l,c,u;for(r&&e.push(new ot(r,this._x0,this._y0,this._x1,this._y1));t=e.pop();)if(!s(r=t.node,o=t.x0,l=t.y0,c=t.x1,u=t.y1)&&r.length){var d=(o+c)/2,m=(l+u)/2;(i=r[3])&&e.push(new ot(i,d,m,c,u)),(i=r[2])&&e.push(new ot(i,o,m,d,u)),(i=r[1])&&e.push(new ot(i,d,l,c,m)),(i=r[0])&&e.push(new ot(i,o,l,d,m))}return this}function qg(s){var e=[],t=[],r;for(this._root&&e.push(new ot(this._root,this._x0,this._y0,this._x1,this._y1));r=e.pop();){var i=r.node;if(i.length){var o,l=r.x0,c=r.y0,u=r.x1,d=r.y1,m=(l+u)/2,p=(c+d)/2;(o=i[0])&&e.push(new ot(o,l,c,m,p)),(o=i[1])&&e.push(new ot(o,m,c,u,p)),(o=i[2])&&e.push(new ot(o,l,p,m,d)),(o=i[3])&&e.push(new ot(o,m,p,u,d))}t.push(r)}for(;r=t.pop();)s(r.node,r.x0,r.y0,r.x1,r.y1);return this}function Qg(s){return s[0]}function Eg(s){return arguments.length?(this._x=s,this):this._x}function Jg(s){return s[1]}function Hg(s){return arguments.length?(this._y=s,this):this._y}function zc(s,e,t){var r=new sa(e??Qg,t??Jg,NaN,NaN,NaN,NaN);return s==null?r:r.addAll(s)}function sa(s,e,t,r,i,o){this._x=s,this._y=e,this._x0=t,this._y0=r,this._x1=i,this._y1=o,this._root=void 0}function Nc(s){for(var e={data:s.data},t=e;s=s.next;)t=t.next={data:s.data};return e}var at=zc.prototype=sa.prototype;at.copy=function(){var s=new sa(this._x,this._y,this._x0,this._y0,this._x1,this._y1),e=this._root,t,r;if(!e)return s;if(!e.length)return s._root=Nc(e),s;for(t=[{source:e,target:s._root=new Array(4)}];e=t.pop();)for(var i=0;i<4;++i)(r=e.source[i])&&(r.length?t.push({source:r,target:e.target[i]=new Array(4)}):e.target[i]=Nc(r));return s},at.add=zg,at.addAll=Ng,at.cover=Rg,at.data=Wg,at.extent=Gg,at.find=$g,at.remove=jg,at.removeAll=Xg,at.root=Yg,at.size=Zg,at.visit=Kg,at.visitAfter=qg,at.x=Eg,at.y=Hg;var e_=Object.defineProperty,t_=(s,e,t)=>e in s?e_(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Rc=(s,e,t)=>t_(s,typeof e!="symbol"?e+"":e,t);class Wc{constructor(e){Rc(this,"_quadtree"),Rc(this,"_viewport"),this._viewport=e,this._rebuildQuadTree()}updateViewport(e){(e.width!==this._viewport.width||e.height!==this._viewport.height)&&(this._viewport=e,this._rebuildQuadTree())}addBoxes(e){e.forEach(t=>{this._isBoxInViewport(t)&&this._quadtree.add(t)})}findCollisions(e){const t=[],r=this._getSearchBounds(e);return this._quadtree.visit((i,o,l,c,u)=>this._checkNodeCollision(r,o,l,c,u)?(i.length||this._getNodeData(i).forEach(m=>{m.id!==e.id&&this._checkBoxCollision(e,m)&&t.push(m)}),!1):void 0),t}clear(){this._rebuildQuadTree()}getAllBoxes(){const e=[];return this._quadtree.visit(t=>{if(!t.length){const r=this._getNodeData(t);e.push(...r)}return!1}),e}_rebuildQuadTree(){this._quadtree=zc().x(e=>e.x).y(e=>e.y).extent([[0,0],[this._viewport.width,this._viewport.height]])}_isBoxInViewport(e){const t=e.width/2,r=e.height/2;return e.x+t>=0&&e.x-t<=this._viewport.width&&e.y+r>=0&&e.y-r<=this._viewport.height}_getSearchBounds(e){return{x:e.x,y:e.y,width:e.width*2,height:e.height*2}}_checkNodeCollision(e,t,r,i,o){const l=(t+i)/2,c=(r+o)/2,u=i-t,d=o-r;return Math.abs(e.x-l)*2<e.width+u&&Math.abs(e.y-c)*2<e.height+d}_checkBoxCollision(e,t){return Math.abs(e.x-t.x)*2<e.width+t.width&&Math.abs(e.y-t.y)*2<e.height+t.height}_getNodeData(e){return e?Array.isArray(e.data)?e.data:e.data?[e.data]:[]:[]}removeBox(e){const r=this.getAllBoxes().filter(i=>i.id!==e);this.clear(),r.length>0&&this.addBoxes(r)}}var r_=Object.defineProperty,i_=(s,e,t)=>e in s?r_(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Gc=(s,e,t)=>i_(s,typeof e!="symbol"?e+"":e,t);class n_{constructor(){Gc(this,"_strategies",new Map),Gc(this,"_executionOrder",[])}registerStrategy(e,t){return this._strategies.set(e.name,e),t!==void 0?this._executionOrder.splice(t,0,e.name):this._executionOrder.push(e.name),this}async executeStrategies(e,t){const r=new Map;e.forEach(i=>{r.set(i._id,{featureId:i._id,visible:!0,reason:hr.NO_COLLISION,collidedWith:[],timestamp:t.timestamp})});for(const i of this._executionOrder){const o=this._strategies.get(i);if(o?.enabled)try{const l=await o.execute(e,t,r);this._mergeResults(r,l)}catch(l){console.error(`Strategy ${i} execution failed: 策略 ${i} 执行失败:`,l)}}return r}_mergeResults(e,t){t.forEach(r=>{const i=e.get(r.featureId);i&&!i.visible||e.set(r.featureId,r)})}}var s_=Object.defineProperty,o_=(s,e,t)=>e in s?s_(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,fi=(s,e,t)=>o_(s,typeof e!="symbol"?e+"":e,t);class a_{constructor(){fi(this,"frameStats",new Map),fi(this,"summaryStats",{totalFrames:0,averageFrameTime:0,averageFPS:0,minFrameTime:1/0,maxFrameTime:0,totalFeaturesProcessed:0}),fi(this,"sampleWindowSize",60),fi(this,"currentFrameId",0),fi(this,"lastReportTime",0),fi(this,"reportInterval",5e3),fi(this,"performanceThresholds",{criticalFrameTime:33,warningFrameTime:16,idealFrameTime:8}),this.lastReportTime=Date.now()}startFrame(e){this.currentFrameId=e;const t={frameId:e,startTime:performance.now(),endTime:0,duration:0,featureCount:0,visibleCount:0,hiddenCount:0,collisionChecks:0,memoryUsage:0,strategyTimes:new Map};this.frameStats.set(e,t),this.cleanupOldFrames()}endFrame(e,t){const r=this.frameStats.get(e);if(!r)return;const i=performance.now();r.endTime=i,r.duration=i-r.startTime,t&&Object.assign(r,t),"memory"in performance&&(r.memoryUsage=performance.memory.usedJSHeapSize),this.updateSummaryStats(r),this.maybeOutputReport()}recordStrategyTime(e,t){const r=this.frameStats.get(this.currentFrameId);r&&r.strategyTimes.set(e,t)}recordCollisionChecks(e){const t=this.frameStats.get(this.currentFrameId);t&&(t.collisionChecks+=e)}getStats(){const e=this.getRecentFrames(this.sampleWindowSize),t=this.calculateFPS(e),r=this.calculateAverageFrameTime(e);return{summary:{...this.summaryStats},recent:{fps:t,frameTime:r,frameTimeStdDev:this.calculateFrameTimeStdDev(e),averageFeaturesPerFrame:this.calculateAverageFeatures(e),performanceLevel:this.getPerformanceLevel(r)},currentFrame:this.frameStats.get(this.currentFrameId)||null,strategies:this.getStrategyPerformance(e),warnings:this.getPerformanceWarnings(e)}}getDetailedReport(){const e=this.getRecentFrames(this.sampleWindowSize),t=this.getStats();return{...t,frameHistory:Array.from(e.values()),trends:this.calculateTrends(e),recommendations:this.getPerformanceRecommendations(t)}}reset(){this.frameStats.clear(),this.summaryStats={totalFrames:0,averageFrameTime:0,averageFPS:0,minFrameTime:1/0,maxFrameTime:0,totalFeaturesProcessed:0},this.currentFrameId=0,this.lastReportTime=Date.now()}cleanupOldFrames(){this.frameStats.size>this.sampleWindowSize*2&&Array.from(this.frameStats.keys()).sort((t,r)=>t-r).slice(0,this.frameStats.size-this.sampleWindowSize).forEach(t=>{this.frameStats.delete(t)})}updateSummaryStats(e){this.summaryStats.totalFrames++,this.summaryStats.totalFeaturesProcessed+=e.featureCount||0,this.summaryStats.averageFrameTime=(this.summaryStats.averageFrameTime*(this.summaryStats.totalFrames-1)+e.duration)/this.summaryStats.totalFrames,this.summaryStats.minFrameTime=Math.min(this.summaryStats.minFrameTime,e.duration),this.summaryStats.maxFrameTime=Math.max(this.summaryStats.maxFrameTime,e.duration),this.summaryStats.averageFPS=1e3/this.summaryStats.averageFrameTime}maybeOutputReport(){const e=Date.now();if(e-this.lastReportTime>=this.reportInterval){const t=this.getStats();t.warnings.length>0?console.warn("避让系统性能报告:",t):console.log("避让系统性能正常:",t),this.lastReportTime=e}}getRecentFrames(e){return Array.from(this.frameStats.values()).slice(-e).filter(r=>r.duration>0)}calculateFPS(e){if(e.length===0)return 0;const t=this.calculateAverageFrameTime(e);return t>0?1e3/t:0}calculateAverageFrameTime(e){return e.length===0?0:e.reduce((t,r)=>t+r.duration,0)/e.length}calculateFrameTimeStdDev(e){if(e.length===0)return 0;const t=this.calculateAverageFrameTime(e),r=e.map(i=>Math.pow(i.duration-t,2));return Math.sqrt(r.reduce((i,o)=>i+o,0)/e.length)}calculateAverageFeatures(e){return e.length===0?0:e.reduce((t,r)=>t+(r.featureCount||0),0)/e.length}getPerformanceLevel(e){return e>this.performanceThresholds.criticalFrameTime?"critical":e>this.performanceThresholds.warningFrameTime?"warning":e>this.performanceThresholds.idealFrameTime?"good":"excellent"}getStrategyPerformance(e){const t=new Map;return e.forEach(r=>{r.strategyTimes.forEach((i,o)=>{t.has(o)||t.set(o,[]),t.get(o).push(i)})}),Array.from(t.entries()).map(([r,i])=>({name:r,averageTime:i.reduce((o,l)=>o+l,0)/i.length,maxTime:Math.max(...i),minTime:Math.min(...i),callCount:i.length}))}getPerformanceWarnings(e){const t=[],r=e.slice(-30);if(r.length===0)return t;const i=this.calculateAverageFrameTime(r);i>this.performanceThresholds.criticalFrameTime?t.push({type:"critical",message:`帧率过低: ${Math.round(1e3/i)}fps`,suggestion:"考虑减少要素数量或简化避让策略"}):i>this.performanceThresholds.warningFrameTime&&t.push({type:"warning",message:`帧率较低: ${Math.round(1e3/i)}fps`,suggestion:"建议优化避让算法或增加更新间隔"});const o=r.map(l=>l.memoryUsage).filter(l=>l>0);if(o.length>0){const l=o.reduce((c,u)=>c+u,0)/o.length;l>100*1024*1024&&t.push({type:"warning",message:`内存使用较高: ${(l/1024/1024).toFixed(1)}MB`,suggestion:"检查内存泄漏，及时清理无用资源"})}return t}calculateTrends(e){if(e.length<2)return{frameTime:"stable",fps:"stable",features:"stable"};const t=e.slice(0,Math.floor(e.length/2)),r=e.slice(Math.floor(e.length/2)),i=this.calculateAverageFrameTime(t),l=(this.calculateAverageFrameTime(r)-i)/i*100;return{frameTime:Math.abs(l)<5?"stable":l>0?"worsening":"improving",fps:Math.abs(l)<5?"stable":l>0?"improving":"worsening",features:"stable"}}getPerformanceRecommendations(e){const t=[];return e.recent.performanceLevel==="critical"&&(t.push("建议启用要素抽样或聚合显示"),t.push("考虑增加避让更新间隔时间"),t.push("检查是否有不必要的避让策略")),e.recent.averageFeaturesPerFrame>5e3&&t.push("要素数量过多，建议启用LOD分级"),e.strategies.forEach(r=>{r.averageTime>10&&t.push(`策略 "${r.name}" 执行时间较长，考虑优化`)}),t}}var l_=Object.defineProperty,c_=(s,e,t)=>e in s?l_(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,gs=(s,e,t)=>c_(s,typeof e!="symbol"?e+"":e,t);class u_{constructor(){gs(this,"name","priority"),gs(this,"enabled",!0),gs(this,"weight",1),gs(this,"description","Priority-based avoidance strategy, smaller value means higher priority 基于优先级的避让策略，数值越小优先级越高")}async execute(e,t,r){const i=[],o=new Wc(t.viewport),l=[],c=new Map;return e.forEach(u=>{if(!u.collidable)return;const d=u.getScreenBoundingBox(t.camera,t.renderer);d&&(l.push(d),c.set(u._id,u),r?.get(u._id)?.visible)}),l.sort((u,d)=>u.priority-d.priority),l.forEach(u=>{const d=o.findCollisions(u);d.length===0?(o.addBoxes([u]),i.push({featureId:u.featureId,visible:!0,reason:hr.NO_COLLISION,collidedWith:[],timestamp:t.timestamp})):d.some(p=>p.priority<u.priority)?i.push({featureId:u.featureId,visible:!1,reason:hr.PRIORITY_LOST,collidedWith:d.map(p=>p.featureId),timestamp:t.timestamp}):(o.addBoxes([u]),i.push({featureId:u.featureId,visible:!0,reason:hr.NO_COLLISION,collidedWith:[],timestamp:t.timestamp}),d.forEach(p=>{i.push({featureId:p.featureId,visible:!1,reason:hr.PRIORITY_LOST,collidedWith:[u.featureId],timestamp:t.timestamp})}))}),i}}var h_=Object.defineProperty,f_=(s,e,t)=>e in s?h_(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Rr=(s,e,t)=>f_(s,typeof e!="symbol"?e+"":e,t);class d_{constructor(e,t={}){this.renderer=e,Rr(this,"_quadTreeManager"),Rr(this,"_strategyOrchestrator"),Rr(this,"_performanceMonitor"),Rr(this,"_layers",new Set),Rr(this,"_config"),Rr(this,"_isUpdating",!1),Rr(this,"_lastUpdateTime",0),Rr(this,"_frameCount",0),this._config={enabled:!0,padding:4,updateInterval:0,animationDuration:300,maxFeaturesPerFrame:2e3,viewportMargin:50,strategies:{priority:!0,grouping:!1,proximity:!1},...t},this._initializeComponents(),this._setupPerformanceMonitoring()}async update(e){if(!this._config.enabled||this._isUpdating)return;const t=Date.now();if(!(this._config.updateInterval>0&&t-this._lastUpdateTime<this._config.updateInterval)){this._isUpdating=!0,this._frameCount++;try{this._resetAllFeaturesVisibility();const r=this._createCollisionContext(e,t),i=this._collectCollidableFeatures();if(i.length===0)return;this._performanceMonitor.startFrame(this._frameCount);const o=await this._strategyOrchestrator.executeStrategies(i,r);await this._applyCollisionResults(o,i),this._performanceMonitor.endFrame(this._frameCount,{featureCount:i.length,visibleCount:Array.from(o.values()).filter(l=>l.visible).length,hiddenCount:Array.from(o.values()).filter(l=>!l.visible).length}),this._lastUpdateTime=t}catch(r){console.error("避让引擎更新失败:",r)}finally{this._isUpdating=!1}}}_resetAllFeaturesVisibility(){this._layers.forEach(e=>{e.getFeatures().filter(r=>r.collidable).forEach(r=>{r.setCollisionVisibility(!0,hr.NO_COLLISION)})})}registerLayer(e){return this._layers.add(e),this}unregisterLayer(e){return this._layers.delete(e),this}setConfig(e){return Object.assign(this._config,e),this}getPerformanceStats(){return this._performanceMonitor.getStats()}_initializeComponents(){const e={width:this.renderer.domElement.width,height:this.renderer.domElement.height};this._quadTreeManager=new Wc(e),this._strategyOrchestrator=new n_,this._performanceMonitor=new a_,this._strategyOrchestrator.registerStrategy(new u_,0),this._setupViewportResizeHandler()}_createCollisionContext(e,t){return{camera:e,renderer:this.renderer,viewport:{width:this.renderer.domElement.width,height:this.renderer.domElement.height},zoomLevel:e.position.z,timestamp:t,frameNumber:this._frameCount}}_collectCollidableFeatures(){const e=[];return this._layers.forEach(t=>{const r=t.getFeatures().filter(i=>i.collidable&&i instanceof Je);if(e.length+r.length>this._config.maxFeaturesPerFrame){console.warn(`达到每帧最大要素处理限制: ${this._config.maxFeaturesPerFrame}`);return}e.push(...r)}),e}async _applyCollisionResults(e,t){const r=t.map(i=>{const o=e.get(i._id);return o&&i.setCollisionVisibility(o.visible,o.reason),Promise.resolve()});await Promise.all(r)}_setupViewportResizeHandler(){new ResizeObserver(t=>{t.forEach(r=>{const{width:i,height:o}=r.contentRect;this._quadTreeManager.updateViewport({width:i,height:o})})}).observe(this.renderer.domElement)}_setupPerformanceMonitoring(){setInterval(()=>{const e=this.getPerformanceStats();e.frameRate<30&&console.warn("避让系统性能警告:",e)},5e3)}}var _s=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},An={exports:{}};var p_=An.exports,$c;function m_(){return $c||($c=1,(function(s,e){(function(){var t,r="4.17.21",i=200,o="Unsupported core-js use. Try https://npms.io/search?q=ponyfill.",l="Expected a function",c="Invalid `variable` option passed into `_.template`",u="__lodash_hash_undefined__",d=500,m="__lodash_placeholder__",p=1,_=2,v=4,M=1,S=2,x=1,O=2,P=4,L=8,F=16,z=32,j=64,G=128,U=256,X=512,N=30,k="...",Z=800,E=16,q=1,te=2,H=3,Pe=1/0,ve=9007199254740991,we=17976931348623157e292,me=NaN,Le=4294967295,Ce=Le-1,Oe=Le>>>1,lt=[["ary",G],["bind",x],["bindKey",O],["curry",L],["curryRight",F],["flip",X],["partial",z],["partialRight",j],["rearg",U]],ct="[object Arguments]",Vt="[object Array]",Et="[object AsyncFunction]",gt="[object Boolean]",Jt="[object Date]",Yi="[object DOMException]",xr="[object Error]",Ht="[object Function]",Mr="[object GeneratorFunction]",We="[object Map]",St="[object Number]",mi="[object Null]",_t="[object Object]",gi="[object Promise]",Zi="[object Proxy]",_i="[object RegExp]",At="[object Set]",Xr="[object String]",Yr="[object Symbol]",yi="[object Undefined]",vi="[object WeakMap]",wa="[object WeakSet]",Zr="[object ArrayBuffer]",pr="[object DataView]",Un="[object Float32Array]",Vn="[object Float64Array]",Ki="[object Int8Array]",kn="[object Int16Array]",zn="[object Int32Array]",qi="[object Uint8Array]",wi="[object Uint8ClampedArray]",I="[object Uint16Array]",Y="[object Uint32Array]",oe=/\b__p \+= '';/g,ye=/\b(__p \+=) '' \+/g,Ge=/(__e\(.*?\)|\b__t\)) \+\n'';/g,kt=/&(?:amp|lt|gt|quot|#39);/g,er=/[&<>"']/g,Iu=RegExp(kt.source),Is=RegExp(er.source),tr=/<%-([\s\S]+?)%>/g,rr=/<%([\s\S]+?)%>/g,Kr=/<%=([\s\S]+?)%>/g,bi=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,xi=/^\w*$/,Qi=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,ba=/[\\^$.*+?()[\]{}|]/g,$v=RegExp(ba.source),xa=/^\s+/,jv=/\s/,Xv=/\{(?:\n\/\* \[wrapped with .+\] \*\/)?\n?/,Yv=/\{\n\/\* \[wrapped with (.+)\] \*/,Zv=/,? & /,Kv=/[^\x00-\x2f\x3a-\x40\x5b-\x60\x7b-\x7f]+/g,qv=/[()=,{}\[\]\/\s]/,Qv=/\\(\\)?/g,Ev=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g,Fu=/\w*$/,Jv=/^[-+]0x[0-9a-f]+$/i,Hv=/^0b[01]+$/i,ew=/^\[object .+?Constructor\]$/,tw=/^0o[0-7]+$/i,rw=/^(?:0|[1-9]\d*)$/,iw=/[\xc0-\xd6\xd8-\xf6\xf8-\xff\u0100-\u017f]/g,Fs=/($^)/,nw=/['\n\r\u2028\u2029\\]/g,Bs="\\ud800-\\udfff",sw="\\u0300-\\u036f",ow="\\ufe20-\\ufe2f",aw="\\u20d0-\\u20ff",Bu=sw+ow+aw,Uu="\\u2700-\\u27bf",Vu="a-z\\xdf-\\xf6\\xf8-\\xff",lw="\\xac\\xb1\\xd7\\xf7",cw="\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf",uw="\\u2000-\\u206f",hw=" \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000",ku="A-Z\\xc0-\\xd6\\xd8-\\xde",zu="\\ufe0e\\ufe0f",Nu=lw+cw+uw+hw,Ma="['’]",fw="["+Bs+"]",Ru="["+Nu+"]",Us="["+Bu+"]",Wu="\\d+",dw="["+Uu+"]",Gu="["+Vu+"]",$u="[^"+Bs+Nu+Wu+Uu+Vu+ku+"]",Sa="\\ud83c[\\udffb-\\udfff]",pw="(?:"+Us+"|"+Sa+")",ju="[^"+Bs+"]",Aa="(?:\\ud83c[\\udde6-\\uddff]){2}",Pa="[\\ud800-\\udbff][\\udc00-\\udfff]",Ei="["+ku+"]",Xu="\\u200d",Yu="(?:"+Gu+"|"+$u+")",mw="(?:"+Ei+"|"+$u+")",Zu="(?:"+Ma+"(?:d|ll|m|re|s|t|ve))?",Ku="(?:"+Ma+"(?:D|LL|M|RE|S|T|VE))?",qu=pw+"?",Qu="["+zu+"]?",gw="(?:"+Xu+"(?:"+[ju,Aa,Pa].join("|")+")"+Qu+qu+")*",_w="\\d*(?:1st|2nd|3rd|(?![123])\\dth)(?=\\b|[A-Z_])",yw="\\d*(?:1ST|2ND|3RD|(?![123])\\dTH)(?=\\b|[a-z_])",Eu=Qu+qu+gw,vw="(?:"+[dw,Aa,Pa].join("|")+")"+Eu,ww="(?:"+[ju+Us+"?",Us,Aa,Pa,fw].join("|")+")",bw=RegExp(Ma,"g"),xw=RegExp(Us,"g"),La=RegExp(Sa+"(?="+Sa+")|"+ww+Eu,"g"),Mw=RegExp([Ei+"?"+Gu+"+"+Zu+"(?="+[Ru,Ei,"$"].join("|")+")",mw+"+"+Ku+"(?="+[Ru,Ei+Yu,"$"].join("|")+")",Ei+"?"+Yu+"+"+Zu,Ei+"+"+Ku,yw,_w,Wu,vw].join("|"),"g"),Sw=RegExp("["+Xu+Bs+Bu+zu+"]"),Aw=/[a-z][A-Z]|[A-Z]{2}[a-z]|[0-9][a-zA-Z]|[a-zA-Z][0-9]|[^a-zA-Z0-9 ]/,Pw=["Array","Buffer","DataView","Date","Error","Float32Array","Float64Array","Function","Int8Array","Int16Array","Int32Array","Map","Math","Object","Promise","RegExp","Set","String","Symbol","TypeError","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","WeakMap","_","clearTimeout","isFinite","parseInt","setTimeout"],Lw=-1,Ie={};Ie[Un]=Ie[Vn]=Ie[Ki]=Ie[kn]=Ie[zn]=Ie[qi]=Ie[wi]=Ie[I]=Ie[Y]=!0,Ie[ct]=Ie[Vt]=Ie[Zr]=Ie[gt]=Ie[pr]=Ie[Jt]=Ie[xr]=Ie[Ht]=Ie[We]=Ie[St]=Ie[_t]=Ie[_i]=Ie[At]=Ie[Xr]=Ie[vi]=!1;var Te={};Te[ct]=Te[Vt]=Te[Zr]=Te[pr]=Te[gt]=Te[Jt]=Te[Un]=Te[Vn]=Te[Ki]=Te[kn]=Te[zn]=Te[We]=Te[St]=Te[_t]=Te[_i]=Te[At]=Te[Xr]=Te[Yr]=Te[qi]=Te[wi]=Te[I]=Te[Y]=!0,Te[xr]=Te[Ht]=Te[vi]=!1;var Cw={À:"A",Á:"A",Â:"A",Ã:"A",Ä:"A",Å:"A",à:"a",á:"a",â:"a",ã:"a",ä:"a",å:"a",Ç:"C",ç:"c",Ð:"D",ð:"d",È:"E",É:"E",Ê:"E",Ë:"E",è:"e",é:"e",ê:"e",ë:"e",Ì:"I",Í:"I",Î:"I",Ï:"I",ì:"i",í:"i",î:"i",ï:"i",Ñ:"N",ñ:"n",Ò:"O",Ó:"O",Ô:"O",Õ:"O",Ö:"O",Ø:"O",ò:"o",ó:"o",ô:"o",õ:"o",ö:"o",ø:"o",Ù:"U",Ú:"U",Û:"U",Ü:"U",ù:"u",ú:"u",û:"u",ü:"u",Ý:"Y",ý:"y",ÿ:"y",Æ:"Ae",æ:"ae",Þ:"Th",þ:"th",ß:"ss",Ā:"A",Ă:"A",Ą:"A",ā:"a",ă:"a",ą:"a",Ć:"C",Ĉ:"C",Ċ:"C",Č:"C",ć:"c",ĉ:"c",ċ:"c",č:"c",Ď:"D",Đ:"D",ď:"d",đ:"d",Ē:"E",Ĕ:"E",Ė:"E",Ę:"E",Ě:"E",ē:"e",ĕ:"e",ė:"e",ę:"e",ě:"e",Ĝ:"G",Ğ:"G",Ġ:"G",Ģ:"G",ĝ:"g",ğ:"g",ġ:"g",ģ:"g",Ĥ:"H",Ħ:"H",ĥ:"h",ħ:"h",Ĩ:"I",Ī:"I",Ĭ:"I",Į:"I",İ:"I",ĩ:"i",ī:"i",ĭ:"i",į:"i",ı:"i",Ĵ:"J",ĵ:"j",Ķ:"K",ķ:"k",ĸ:"k",Ĺ:"L",Ļ:"L",Ľ:"L",Ŀ:"L",Ł:"L",ĺ:"l",ļ:"l",ľ:"l",ŀ:"l",ł:"l",Ń:"N",Ņ:"N",Ň:"N",Ŋ:"N",ń:"n",ņ:"n",ň:"n",ŋ:"n",Ō:"O",Ŏ:"O",Ő:"O",ō:"o",ŏ:"o",ő:"o",Ŕ:"R",Ŗ:"R",Ř:"R",ŕ:"r",ŗ:"r",ř:"r",Ś:"S",Ŝ:"S",Ş:"S",Š:"S",ś:"s",ŝ:"s",ş:"s",š:"s",Ţ:"T",Ť:"T",Ŧ:"T",ţ:"t",ť:"t",ŧ:"t",Ũ:"U",Ū:"U",Ŭ:"U",Ů:"U",Ű:"U",Ų:"U",ũ:"u",ū:"u",ŭ:"u",ů:"u",ű:"u",ų:"u",Ŵ:"W",ŵ:"w",Ŷ:"Y",ŷ:"y",Ÿ:"Y",Ź:"Z",Ż:"Z",Ž:"Z",ź:"z",ż:"z",ž:"z",Ĳ:"IJ",ĳ:"ij",Œ:"Oe",œ:"oe",ŉ:"'n",ſ:"s"},Ow={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},Tw={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"},Dw={"\\":"\\","'":"'","\n":"n","\r":"r","\u2028":"u2028","\u2029":"u2029"},Iw=parseFloat,Fw=parseInt,Ju=typeof _s=="object"&&_s&&_s.Object===Object&&_s,Bw=typeof self=="object"&&self&&self.Object===Object&&self,He=Ju||Bw||Function("return this")(),Ca=e&&!e.nodeType&&e,Mi=Ca&&!0&&s&&!s.nodeType&&s,Hu=Mi&&Mi.exports===Ca,Oa=Hu&&Ju.process,zt=(function(){try{var T=Mi&&Mi.require&&Mi.require("util").types;return T||Oa&&Oa.binding&&Oa.binding("util")}catch{}})(),eh=zt&&zt.isArrayBuffer,th=zt&&zt.isDate,rh=zt&&zt.isMap,ih=zt&&zt.isRegExp,nh=zt&&zt.isSet,sh=zt&&zt.isTypedArray;function Pt(T,V,B){switch(B.length){case 0:return T.call(V);case 1:return T.call(V,B[0]);case 2:return T.call(V,B[0],B[1]);case 3:return T.call(V,B[0],B[1],B[2])}return T.apply(V,B)}function Uw(T,V,B,J){for(var ae=-1,be=T==null?0:T.length;++ae<be;){var $e=T[ae];V(J,$e,B($e),T)}return J}function Nt(T,V){for(var B=-1,J=T==null?0:T.length;++B<J&&V(T[B],B,T)!==!1;);return T}function Vw(T,V){for(var B=T==null?0:T.length;B--&&V(T[B],B,T)!==!1;);return T}function oh(T,V){for(var B=-1,J=T==null?0:T.length;++B<J;)if(!V(T[B],B,T))return!1;return!0}function qr(T,V){for(var B=-1,J=T==null?0:T.length,ae=0,be=[];++B<J;){var $e=T[B];V($e,B,T)&&(be[ae++]=$e)}return be}function Vs(T,V){var B=T==null?0:T.length;return!!B&&Ji(T,V,0)>-1}function Ta(T,V,B){for(var J=-1,ae=T==null?0:T.length;++J<ae;)if(B(V,T[J]))return!0;return!1}function Fe(T,V){for(var B=-1,J=T==null?0:T.length,ae=Array(J);++B<J;)ae[B]=V(T[B],B,T);return ae}function Qr(T,V){for(var B=-1,J=V.length,ae=T.length;++B<J;)T[ae+B]=V[B];return T}function Da(T,V,B,J){var ae=-1,be=T==null?0:T.length;for(J&&be&&(B=T[++ae]);++ae<be;)B=V(B,T[ae],ae,T);return B}function kw(T,V,B,J){var ae=T==null?0:T.length;for(J&&ae&&(B=T[--ae]);ae--;)B=V(B,T[ae],ae,T);return B}function Ia(T,V){for(var B=-1,J=T==null?0:T.length;++B<J;)if(V(T[B],B,T))return!0;return!1}var zw=Fa("length");function Nw(T){return T.split("")}function Rw(T){return T.match(Kv)||[]}function ah(T,V,B){var J;return B(T,function(ae,be,$e){if(V(ae,be,$e))return J=be,!1}),J}function ks(T,V,B,J){for(var ae=T.length,be=B+(J?1:-1);J?be--:++be<ae;)if(V(T[be],be,T))return be;return-1}function Ji(T,V,B){return V===V?Jw(T,V,B):ks(T,lh,B)}function Ww(T,V,B,J){for(var ae=B-1,be=T.length;++ae<be;)if(J(T[ae],V))return ae;return-1}function lh(T){return T!==T}function ch(T,V){var B=T==null?0:T.length;return B?Ua(T,V)/B:me}function Fa(T){return function(V){return V==null?t:V[T]}}function Ba(T){return function(V){return T==null?t:T[V]}}function uh(T,V,B,J,ae){return ae(T,function(be,$e,Ae){B=J?(J=!1,be):V(B,be,$e,Ae)}),B}function Gw(T,V){var B=T.length;for(T.sort(V);B--;)T[B]=T[B].value;return T}function Ua(T,V){for(var B,J=-1,ae=T.length;++J<ae;){var be=V(T[J]);be!==t&&(B=B===t?be:B+be)}return B}function Va(T,V){for(var B=-1,J=Array(T);++B<T;)J[B]=V(B);return J}function $w(T,V){return Fe(V,function(B){return[B,T[B]]})}function hh(T){return T&&T.slice(0,mh(T)+1).replace(xa,"")}function Lt(T){return function(V){return T(V)}}function ka(T,V){return Fe(V,function(B){return T[B]})}function Nn(T,V){return T.has(V)}function fh(T,V){for(var B=-1,J=T.length;++B<J&&Ji(V,T[B],0)>-1;);return B}function dh(T,V){for(var B=T.length;B--&&Ji(V,T[B],0)>-1;);return B}function jw(T,V){for(var B=T.length,J=0;B--;)T[B]===V&&++J;return J}var Xw=Ba(Cw),Yw=Ba(Ow);function Zw(T){return"\\"+Dw[T]}function Kw(T,V){return T==null?t:T[V]}function Hi(T){return Sw.test(T)}function qw(T){return Aw.test(T)}function Qw(T){for(var V,B=[];!(V=T.next()).done;)B.push(V.value);return B}function za(T){var V=-1,B=Array(T.size);return T.forEach(function(J,ae){B[++V]=[ae,J]}),B}function ph(T,V){return function(B){return T(V(B))}}function Er(T,V){for(var B=-1,J=T.length,ae=0,be=[];++B<J;){var $e=T[B];($e===V||$e===m)&&(T[B]=m,be[ae++]=B)}return be}function zs(T){var V=-1,B=Array(T.size);return T.forEach(function(J){B[++V]=J}),B}function Ew(T){var V=-1,B=Array(T.size);return T.forEach(function(J){B[++V]=[J,J]}),B}function Jw(T,V,B){for(var J=B-1,ae=T.length;++J<ae;)if(T[J]===V)return J;return-1}function Hw(T,V,B){for(var J=B+1;J--;)if(T[J]===V)return J;return J}function en(T){return Hi(T)?tb(T):zw(T)}function ir(T){return Hi(T)?rb(T):Nw(T)}function mh(T){for(var V=T.length;V--&&jv.test(T.charAt(V)););return V}var eb=Ba(Tw);function tb(T){for(var V=La.lastIndex=0;La.test(T);)++V;return V}function rb(T){return T.match(La)||[]}function ib(T){return T.match(Mw)||[]}var nb=(function T(V){V=V==null?He:tn.defaults(He.Object(),V,tn.pick(He,Pw));var B=V.Array,J=V.Date,ae=V.Error,be=V.Function,$e=V.Math,Ae=V.Object,Na=V.RegExp,sb=V.String,Rt=V.TypeError,Ns=B.prototype,ob=be.prototype,rn=Ae.prototype,Rs=V["__core-js_shared__"],Ws=ob.toString,Me=rn.hasOwnProperty,ab=0,gh=(function(){var n=/[^.]+$/.exec(Rs&&Rs.keys&&Rs.keys.IE_PROTO||"");return n?"Symbol(src)_1."+n:""})(),Gs=rn.toString,lb=Ws.call(Ae),cb=He._,ub=Na("^"+Ws.call(Me).replace(ba,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),$s=Hu?V.Buffer:t,Jr=V.Symbol,js=V.Uint8Array,_h=$s?$s.allocUnsafe:t,Xs=ph(Ae.getPrototypeOf,Ae),yh=Ae.create,vh=rn.propertyIsEnumerable,Ys=Ns.splice,wh=Jr?Jr.isConcatSpreadable:t,Rn=Jr?Jr.iterator:t,Si=Jr?Jr.toStringTag:t,Zs=(function(){try{var n=Oi(Ae,"defineProperty");return n({},"",{}),n}catch{}})(),hb=V.clearTimeout!==He.clearTimeout&&V.clearTimeout,fb=J&&J.now!==He.Date.now&&J.now,db=V.setTimeout!==He.setTimeout&&V.setTimeout,Ks=$e.ceil,qs=$e.floor,Ra=Ae.getOwnPropertySymbols,pb=$s?$s.isBuffer:t,bh=V.isFinite,mb=Ns.join,gb=ph(Ae.keys,Ae),je=$e.max,nt=$e.min,_b=J.now,yb=V.parseInt,xh=$e.random,vb=Ns.reverse,Wa=Oi(V,"DataView"),Wn=Oi(V,"Map"),Ga=Oi(V,"Promise"),nn=Oi(V,"Set"),Gn=Oi(V,"WeakMap"),$n=Oi(Ae,"create"),Qs=Gn&&new Gn,sn={},wb=Ti(Wa),bb=Ti(Wn),xb=Ti(Ga),Mb=Ti(nn),Sb=Ti(Gn),Es=Jr?Jr.prototype:t,jn=Es?Es.valueOf:t,Mh=Es?Es.toString:t;function w(n){if(ke(n)&&!le(n)&&!(n instanceof ge)){if(n instanceof Wt)return n;if(Me.call(n,"__wrapped__"))return Af(n)}return new Wt(n)}var on=(function(){function n(){}return function(a){if(!Ue(a))return{};if(yh)return yh(a);n.prototype=a;var h=new n;return n.prototype=t,h}})();function Js(){}function Wt(n,a){this.__wrapped__=n,this.__actions__=[],this.__chain__=!!a,this.__index__=0,this.__values__=t}w.templateSettings={escape:tr,evaluate:rr,interpolate:Kr,variable:"",imports:{_:w}},w.prototype=Js.prototype,w.prototype.constructor=w,Wt.prototype=on(Js.prototype),Wt.prototype.constructor=Wt;function ge(n){this.__wrapped__=n,this.__actions__=[],this.__dir__=1,this.__filtered__=!1,this.__iteratees__=[],this.__takeCount__=Le,this.__views__=[]}function Ab(){var n=new ge(this.__wrapped__);return n.__actions__=yt(this.__actions__),n.__dir__=this.__dir__,n.__filtered__=this.__filtered__,n.__iteratees__=yt(this.__iteratees__),n.__takeCount__=this.__takeCount__,n.__views__=yt(this.__views__),n}function Pb(){if(this.__filtered__){var n=new ge(this);n.__dir__=-1,n.__filtered__=!0}else n=this.clone(),n.__dir__*=-1;return n}function Lb(){var n=this.__wrapped__.value(),a=this.__dir__,h=le(n),g=a<0,y=h?n.length:0,b=N1(0,y,this.__views__),A=b.start,C=b.end,D=C-A,R=g?C:A-1,W=this.__iteratees__,$=W.length,K=0,ee=nt(D,this.__takeCount__);if(!h||!g&&y==D&&ee==D)return Zh(n,this.__actions__);var ne=[];e:for(;D--&&K<ee;){R+=a;for(var ue=-1,se=n[R];++ue<$;){var pe=W[ue],_e=pe.iteratee,Tt=pe.type,ft=_e(se);if(Tt==te)se=ft;else if(!ft){if(Tt==q)continue e;break e}}ne[K++]=se}return ne}ge.prototype=on(Js.prototype),ge.prototype.constructor=ge;function Ai(n){var a=-1,h=n==null?0:n.length;for(this.clear();++a<h;){var g=n[a];this.set(g[0],g[1])}}function Cb(){this.__data__=$n?$n(null):{},this.size=0}function Ob(n){var a=this.has(n)&&delete this.__data__[n];return this.size-=a?1:0,a}function Tb(n){var a=this.__data__;if($n){var h=a[n];return h===u?t:h}return Me.call(a,n)?a[n]:t}function Db(n){var a=this.__data__;return $n?a[n]!==t:Me.call(a,n)}function Ib(n,a){var h=this.__data__;return this.size+=this.has(n)?0:1,h[n]=$n&&a===t?u:a,this}Ai.prototype.clear=Cb,Ai.prototype.delete=Ob,Ai.prototype.get=Tb,Ai.prototype.has=Db,Ai.prototype.set=Ib;function Sr(n){var a=-1,h=n==null?0:n.length;for(this.clear();++a<h;){var g=n[a];this.set(g[0],g[1])}}function Fb(){this.__data__=[],this.size=0}function Bb(n){var a=this.__data__,h=Hs(a,n);if(h<0)return!1;var g=a.length-1;return h==g?a.pop():Ys.call(a,h,1),--this.size,!0}function Ub(n){var a=this.__data__,h=Hs(a,n);return h<0?t:a[h][1]}function Vb(n){return Hs(this.__data__,n)>-1}function kb(n,a){var h=this.__data__,g=Hs(h,n);return g<0?(++this.size,h.push([n,a])):h[g][1]=a,this}Sr.prototype.clear=Fb,Sr.prototype.delete=Bb,Sr.prototype.get=Ub,Sr.prototype.has=Vb,Sr.prototype.set=kb;function Ar(n){var a=-1,h=n==null?0:n.length;for(this.clear();++a<h;){var g=n[a];this.set(g[0],g[1])}}function zb(){this.size=0,this.__data__={hash:new Ai,map:new(Wn||Sr),string:new Ai}}function Nb(n){var a=ho(this,n).delete(n);return this.size-=a?1:0,a}function Rb(n){return ho(this,n).get(n)}function Wb(n){return ho(this,n).has(n)}function Gb(n,a){var h=ho(this,n),g=h.size;return h.set(n,a),this.size+=h.size==g?0:1,this}Ar.prototype.clear=zb,Ar.prototype.delete=Nb,Ar.prototype.get=Rb,Ar.prototype.has=Wb,Ar.prototype.set=Gb;function Pi(n){var a=-1,h=n==null?0:n.length;for(this.__data__=new Ar;++a<h;)this.add(n[a])}function $b(n){return this.__data__.set(n,u),this}function jb(n){return this.__data__.has(n)}Pi.prototype.add=Pi.prototype.push=$b,Pi.prototype.has=jb;function nr(n){var a=this.__data__=new Sr(n);this.size=a.size}function Xb(){this.__data__=new Sr,this.size=0}function Yb(n){var a=this.__data__,h=a.delete(n);return this.size=a.size,h}function Zb(n){return this.__data__.get(n)}function Kb(n){return this.__data__.has(n)}function qb(n,a){var h=this.__data__;if(h instanceof Sr){var g=h.__data__;if(!Wn||g.length<i-1)return g.push([n,a]),this.size=++h.size,this;h=this.__data__=new Ar(g)}return h.set(n,a),this.size=h.size,this}nr.prototype.clear=Xb,nr.prototype.delete=Yb,nr.prototype.get=Zb,nr.prototype.has=Kb,nr.prototype.set=qb;function Sh(n,a){var h=le(n),g=!h&&Di(n),y=!h&&!g&&ii(n),b=!h&&!g&&!y&&un(n),A=h||g||y||b,C=A?Va(n.length,sb):[],D=C.length;for(var R in n)(a||Me.call(n,R))&&!(A&&(R=="length"||y&&(R=="offset"||R=="parent")||b&&(R=="buffer"||R=="byteLength"||R=="byteOffset")||Or(R,D)))&&C.push(R);return C}function Ah(n){var a=n.length;return a?n[Ha(0,a-1)]:t}function Qb(n,a){return fo(yt(n),Li(a,0,n.length))}function Eb(n){return fo(yt(n))}function $a(n,a,h){(h!==t&&!sr(n[a],h)||h===t&&!(a in n))&&Pr(n,a,h)}function Xn(n,a,h){var g=n[a];(!(Me.call(n,a)&&sr(g,h))||h===t&&!(a in n))&&Pr(n,a,h)}function Hs(n,a){for(var h=n.length;h--;)if(sr(n[h][0],a))return h;return-1}function Jb(n,a,h,g){return Hr(n,function(y,b,A){a(g,y,h(y),A)}),g}function Ph(n,a){return n&&gr(a,Ye(a),n)}function Hb(n,a){return n&&gr(a,wt(a),n)}function Pr(n,a,h){a=="__proto__"&&Zs?Zs(n,a,{configurable:!0,enumerable:!0,value:h,writable:!0}):n[a]=h}function ja(n,a){for(var h=-1,g=a.length,y=B(g),b=n==null;++h<g;)y[h]=b?t:Sl(n,a[h]);return y}function Li(n,a,h){return n===n&&(h!==t&&(n=n<=h?n:h),a!==t&&(n=n>=a?n:a)),n}function Gt(n,a,h,g,y,b){var A,C=a&p,D=a&_,R=a&v;if(h&&(A=y?h(n,g,y,b):h(n)),A!==t)return A;if(!Ue(n))return n;var W=le(n);if(W){if(A=W1(n),!C)return yt(n,A)}else{var $=st(n),K=$==Ht||$==Mr;if(ii(n))return Qh(n,C);if($==_t||$==ct||K&&!y){if(A=D||K?{}:gf(n),!C)return D?T1(n,Hb(A,n)):O1(n,Ph(A,n))}else{if(!Te[$])return y?n:{};A=G1(n,$,C)}}b||(b=new nr);var ee=b.get(n);if(ee)return ee;b.set(n,A),Xf(n)?n.forEach(function(se){A.add(Gt(se,a,h,se,n,b))}):$f(n)&&n.forEach(function(se,pe){A.set(pe,Gt(se,a,h,pe,n,b))});var ne=R?D?ul:cl:D?wt:Ye,ue=W?t:ne(n);return Nt(ue||n,function(se,pe){ue&&(pe=se,se=n[pe]),Xn(A,pe,Gt(se,a,h,pe,n,b))}),A}function e1(n){var a=Ye(n);return function(h){return Lh(h,n,a)}}function Lh(n,a,h){var g=h.length;if(n==null)return!g;for(n=Ae(n);g--;){var y=h[g],b=a[y],A=n[y];if(A===t&&!(y in n)||!b(A))return!1}return!0}function Ch(n,a,h){if(typeof n!="function")throw new Rt(l);return Jn(function(){n.apply(t,h)},a)}function Yn(n,a,h,g){var y=-1,b=Vs,A=!0,C=n.length,D=[],R=a.length;if(!C)return D;h&&(a=Fe(a,Lt(h))),g?(b=Ta,A=!1):a.length>=i&&(b=Nn,A=!1,a=new Pi(a));e:for(;++y<C;){var W=n[y],$=h==null?W:h(W);if(W=g||W!==0?W:0,A&&$===$){for(var K=R;K--;)if(a[K]===$)continue e;D.push(W)}else b(a,$,g)||D.push(W)}return D}var Hr=tf(mr),Oh=tf(Ya,!0);function t1(n,a){var h=!0;return Hr(n,function(g,y,b){return h=!!a(g,y,b),h}),h}function eo(n,a,h){for(var g=-1,y=n.length;++g<y;){var b=n[g],A=a(b);if(A!=null&&(C===t?A===A&&!Ot(A):h(A,C)))var C=A,D=b}return D}function r1(n,a,h,g){var y=n.length;for(h=ce(h),h<0&&(h=-h>y?0:y+h),g=g===t||g>y?y:ce(g),g<0&&(g+=y),g=h>g?0:Zf(g);h<g;)n[h++]=a;return n}function Th(n,a){var h=[];return Hr(n,function(g,y,b){a(g,y,b)&&h.push(g)}),h}function et(n,a,h,g,y){var b=-1,A=n.length;for(h||(h=j1),y||(y=[]);++b<A;){var C=n[b];a>0&&h(C)?a>1?et(C,a-1,h,g,y):Qr(y,C):g||(y[y.length]=C)}return y}var Xa=rf(),Dh=rf(!0);function mr(n,a){return n&&Xa(n,a,Ye)}function Ya(n,a){return n&&Dh(n,a,Ye)}function to(n,a){return qr(a,function(h){return Tr(n[h])})}function Ci(n,a){a=ti(a,n);for(var h=0,g=a.length;n!=null&&h<g;)n=n[_r(a[h++])];return h&&h==g?n:t}function Ih(n,a,h){var g=a(n);return le(n)?g:Qr(g,h(n))}function ut(n){return n==null?n===t?yi:mi:Si&&Si in Ae(n)?z1(n):E1(n)}function Za(n,a){return n>a}function i1(n,a){return n!=null&&Me.call(n,a)}function n1(n,a){return n!=null&&a in Ae(n)}function s1(n,a,h){return n>=nt(a,h)&&n<je(a,h)}function Ka(n,a,h){for(var g=h?Ta:Vs,y=n[0].length,b=n.length,A=b,C=B(b),D=1/0,R=[];A--;){var W=n[A];A&&a&&(W=Fe(W,Lt(a))),D=nt(W.length,D),C[A]=!h&&(a||y>=120&&W.length>=120)?new Pi(A&&W):t}W=n[0];var $=-1,K=C[0];e:for(;++$<y&&R.length<D;){var ee=W[$],ne=a?a(ee):ee;if(ee=h||ee!==0?ee:0,!(K?Nn(K,ne):g(R,ne,h))){for(A=b;--A;){var ue=C[A];if(!(ue?Nn(ue,ne):g(n[A],ne,h)))continue e}K&&K.push(ne),R.push(ee)}}return R}function o1(n,a,h,g){return mr(n,function(y,b,A){a(g,h(y),b,A)}),g}function Zn(n,a,h){a=ti(a,n),n=wf(n,a);var g=n==null?n:n[_r(jt(a))];return g==null?t:Pt(g,n,h)}function Fh(n){return ke(n)&&ut(n)==ct}function a1(n){return ke(n)&&ut(n)==Zr}function l1(n){return ke(n)&&ut(n)==Jt}function Kn(n,a,h,g,y){return n===a?!0:n==null||a==null||!ke(n)&&!ke(a)?n!==n&&a!==a:c1(n,a,h,g,Kn,y)}function c1(n,a,h,g,y,b){var A=le(n),C=le(a),D=A?Vt:st(n),R=C?Vt:st(a);D=D==ct?_t:D,R=R==ct?_t:R;var W=D==_t,$=R==_t,K=D==R;if(K&&ii(n)){if(!ii(a))return!1;A=!0,W=!1}if(K&&!W)return b||(b=new nr),A||un(n)?df(n,a,h,g,y,b):V1(n,a,D,h,g,y,b);if(!(h&M)){var ee=W&&Me.call(n,"__wrapped__"),ne=$&&Me.call(a,"__wrapped__");if(ee||ne){var ue=ee?n.value():n,se=ne?a.value():a;return b||(b=new nr),y(ue,se,h,g,b)}}return K?(b||(b=new nr),k1(n,a,h,g,y,b)):!1}function u1(n){return ke(n)&&st(n)==We}function qa(n,a,h,g){var y=h.length,b=y,A=!g;if(n==null)return!b;for(n=Ae(n);y--;){var C=h[y];if(A&&C[2]?C[1]!==n[C[0]]:!(C[0]in n))return!1}for(;++y<b;){C=h[y];var D=C[0],R=n[D],W=C[1];if(A&&C[2]){if(R===t&&!(D in n))return!1}else{var $=new nr;if(g)var K=g(R,W,D,n,a,$);if(!(K===t?Kn(W,R,M|S,g,$):K))return!1}}return!0}function Bh(n){if(!Ue(n)||Y1(n))return!1;var a=Tr(n)?ub:ew;return a.test(Ti(n))}function h1(n){return ke(n)&&ut(n)==_i}function f1(n){return ke(n)&&st(n)==At}function d1(n){return ke(n)&&vo(n.length)&&!!Ie[ut(n)]}function Uh(n){return typeof n=="function"?n:n==null?bt:typeof n=="object"?le(n)?zh(n[0],n[1]):kh(n):nd(n)}function Qa(n){if(!En(n))return gb(n);var a=[];for(var h in Ae(n))Me.call(n,h)&&h!="constructor"&&a.push(h);return a}function p1(n){if(!Ue(n))return Q1(n);var a=En(n),h=[];for(var g in n)g=="constructor"&&(a||!Me.call(n,g))||h.push(g);return h}function Ea(n,a){return n<a}function Vh(n,a){var h=-1,g=vt(n)?B(n.length):[];return Hr(n,function(y,b,A){g[++h]=a(y,b,A)}),g}function kh(n){var a=fl(n);return a.length==1&&a[0][2]?yf(a[0][0],a[0][1]):function(h){return h===n||qa(h,n,a)}}function zh(n,a){return pl(n)&&_f(a)?yf(_r(n),a):function(h){var g=Sl(h,n);return g===t&&g===a?Al(h,n):Kn(a,g,M|S)}}function ro(n,a,h,g,y){n!==a&&Xa(a,function(b,A){if(y||(y=new nr),Ue(b))m1(n,a,A,h,ro,g,y);else{var C=g?g(gl(n,A),b,A+"",n,a,y):t;C===t&&(C=b),$a(n,A,C)}},wt)}function m1(n,a,h,g,y,b,A){var C=gl(n,h),D=gl(a,h),R=A.get(D);if(R){$a(n,h,R);return}var W=b?b(C,D,h+"",n,a,A):t,$=W===t;if($){var K=le(D),ee=!K&&ii(D),ne=!K&&!ee&&un(D);W=D,K||ee||ne?le(C)?W=C:Ne(C)?W=yt(C):ee?($=!1,W=Qh(D,!0)):ne?($=!1,W=Eh(D,!0)):W=[]:Hn(D)||Di(D)?(W=C,Di(C)?W=Kf(C):(!Ue(C)||Tr(C))&&(W=gf(D))):$=!1}$&&(A.set(D,W),y(W,D,g,b,A),A.delete(D)),$a(n,h,W)}function Nh(n,a){var h=n.length;if(h)return a+=a<0?h:0,Or(a,h)?n[a]:t}function Rh(n,a,h){a.length?a=Fe(a,function(b){return le(b)?function(A){return Ci(A,b.length===1?b[0]:b)}:b}):a=[bt];var g=-1;a=Fe(a,Lt(ie()));var y=Vh(n,function(b,A,C){var D=Fe(a,function(R){return R(b)});return{criteria:D,index:++g,value:b}});return Gw(y,function(b,A){return C1(b,A,h)})}function g1(n,a){return Wh(n,a,function(h,g){return Al(n,g)})}function Wh(n,a,h){for(var g=-1,y=a.length,b={};++g<y;){var A=a[g],C=Ci(n,A);h(C,A)&&qn(b,ti(A,n),C)}return b}function _1(n){return function(a){return Ci(a,n)}}function Ja(n,a,h,g){var y=g?Ww:Ji,b=-1,A=a.length,C=n;for(n===a&&(a=yt(a)),h&&(C=Fe(n,Lt(h)));++b<A;)for(var D=0,R=a[b],W=h?h(R):R;(D=y(C,W,D,g))>-1;)C!==n&&Ys.call(C,D,1),Ys.call(n,D,1);return n}function Gh(n,a){for(var h=n?a.length:0,g=h-1;h--;){var y=a[h];if(h==g||y!==b){var b=y;Or(y)?Ys.call(n,y,1):rl(n,y)}}return n}function Ha(n,a){return n+qs(xh()*(a-n+1))}function y1(n,a,h,g){for(var y=-1,b=je(Ks((a-n)/(h||1)),0),A=B(b);b--;)A[g?b:++y]=n,n+=h;return A}function el(n,a){var h="";if(!n||a<1||a>ve)return h;do a%2&&(h+=n),a=qs(a/2),a&&(n+=n);while(a);return h}function he(n,a){return _l(vf(n,a,bt),n+"")}function v1(n){return Ah(hn(n))}function w1(n,a){var h=hn(n);return fo(h,Li(a,0,h.length))}function qn(n,a,h,g){if(!Ue(n))return n;a=ti(a,n);for(var y=-1,b=a.length,A=b-1,C=n;C!=null&&++y<b;){var D=_r(a[y]),R=h;if(D==="__proto__"||D==="constructor"||D==="prototype")return n;if(y!=A){var W=C[D];R=g?g(W,D,C):t,R===t&&(R=Ue(W)?W:Or(a[y+1])?[]:{})}Xn(C,D,R),C=C[D]}return n}var $h=Qs?function(n,a){return Qs.set(n,a),n}:bt,b1=Zs?function(n,a){return Zs(n,"toString",{configurable:!0,enumerable:!1,value:Ll(a),writable:!0})}:bt;function x1(n){return fo(hn(n))}function $t(n,a,h){var g=-1,y=n.length;a<0&&(a=-a>y?0:y+a),h=h>y?y:h,h<0&&(h+=y),y=a>h?0:h-a>>>0,a>>>=0;for(var b=B(y);++g<y;)b[g]=n[g+a];return b}function M1(n,a){var h;return Hr(n,function(g,y,b){return h=a(g,y,b),!h}),!!h}function io(n,a,h){var g=0,y=n==null?g:n.length;if(typeof a=="number"&&a===a&&y<=Oe){for(;g<y;){var b=g+y>>>1,A=n[b];A!==null&&!Ot(A)&&(h?A<=a:A<a)?g=b+1:y=b}return y}return tl(n,a,bt,h)}function tl(n,a,h,g){var y=0,b=n==null?0:n.length;if(b===0)return 0;a=h(a);for(var A=a!==a,C=a===null,D=Ot(a),R=a===t;y<b;){var W=qs((y+b)/2),$=h(n[W]),K=$!==t,ee=$===null,ne=$===$,ue=Ot($);if(A)var se=g||ne;else R?se=ne&&(g||K):C?se=ne&&K&&(g||!ee):D?se=ne&&K&&!ee&&(g||!ue):ee||ue?se=!1:se=g?$<=a:$<a;se?y=W+1:b=W}return nt(b,Ce)}function jh(n,a){for(var h=-1,g=n.length,y=0,b=[];++h<g;){var A=n[h],C=a?a(A):A;if(!h||!sr(C,D)){var D=C;b[y++]=A===0?0:A}}return b}function Xh(n){return typeof n=="number"?n:Ot(n)?me:+n}function Ct(n){if(typeof n=="string")return n;if(le(n))return Fe(n,Ct)+"";if(Ot(n))return Mh?Mh.call(n):"";var a=n+"";return a=="0"&&1/n==-Pe?"-0":a}function ei(n,a,h){var g=-1,y=Vs,b=n.length,A=!0,C=[],D=C;if(h)A=!1,y=Ta;else if(b>=i){var R=a?null:B1(n);if(R)return zs(R);A=!1,y=Nn,D=new Pi}else D=a?[]:C;e:for(;++g<b;){var W=n[g],$=a?a(W):W;if(W=h||W!==0?W:0,A&&$===$){for(var K=D.length;K--;)if(D[K]===$)continue e;a&&D.push($),C.push(W)}else y(D,$,h)||(D!==C&&D.push($),C.push(W))}return C}function rl(n,a){return a=ti(a,n),n=wf(n,a),n==null||delete n[_r(jt(a))]}function Yh(n,a,h,g){return qn(n,a,h(Ci(n,a)),g)}function no(n,a,h,g){for(var y=n.length,b=g?y:-1;(g?b--:++b<y)&&a(n[b],b,n););return h?$t(n,g?0:b,g?b+1:y):$t(n,g?b+1:0,g?y:b)}function Zh(n,a){var h=n;return h instanceof ge&&(h=h.value()),Da(a,function(g,y){return y.func.apply(y.thisArg,Qr([g],y.args))},h)}function il(n,a,h){var g=n.length;if(g<2)return g?ei(n[0]):[];for(var y=-1,b=B(g);++y<g;)for(var A=n[y],C=-1;++C<g;)C!=y&&(b[y]=Yn(b[y]||A,n[C],a,h));return ei(et(b,1),a,h)}function Kh(n,a,h){for(var g=-1,y=n.length,b=a.length,A={};++g<y;){var C=g<b?a[g]:t;h(A,n[g],C)}return A}function nl(n){return Ne(n)?n:[]}function sl(n){return typeof n=="function"?n:bt}function ti(n,a){return le(n)?n:pl(n,a)?[n]:Sf(xe(n))}var S1=he;function ri(n,a,h){var g=n.length;return h=h===t?g:h,!a&&h>=g?n:$t(n,a,h)}var qh=hb||function(n){return He.clearTimeout(n)};function Qh(n,a){if(a)return n.slice();var h=n.length,g=_h?_h(h):new n.constructor(h);return n.copy(g),g}function ol(n){var a=new n.constructor(n.byteLength);return new js(a).set(new js(n)),a}function A1(n,a){var h=a?ol(n.buffer):n.buffer;return new n.constructor(h,n.byteOffset,n.byteLength)}function P1(n){var a=new n.constructor(n.source,Fu.exec(n));return a.lastIndex=n.lastIndex,a}function L1(n){return jn?Ae(jn.call(n)):{}}function Eh(n,a){var h=a?ol(n.buffer):n.buffer;return new n.constructor(h,n.byteOffset,n.length)}function Jh(n,a){if(n!==a){var h=n!==t,g=n===null,y=n===n,b=Ot(n),A=a!==t,C=a===null,D=a===a,R=Ot(a);if(!C&&!R&&!b&&n>a||b&&A&&D&&!C&&!R||g&&A&&D||!h&&D||!y)return 1;if(!g&&!b&&!R&&n<a||R&&h&&y&&!g&&!b||C&&h&&y||!A&&y||!D)return-1}return 0}function C1(n,a,h){for(var g=-1,y=n.criteria,b=a.criteria,A=y.length,C=h.length;++g<A;){var D=Jh(y[g],b[g]);if(D){if(g>=C)return D;var R=h[g];return D*(R=="desc"?-1:1)}}return n.index-a.index}function Hh(n,a,h,g){for(var y=-1,b=n.length,A=h.length,C=-1,D=a.length,R=je(b-A,0),W=B(D+R),$=!g;++C<D;)W[C]=a[C];for(;++y<A;)($||y<b)&&(W[h[y]]=n[y]);for(;R--;)W[C++]=n[y++];return W}function ef(n,a,h,g){for(var y=-1,b=n.length,A=-1,C=h.length,D=-1,R=a.length,W=je(b-C,0),$=B(W+R),K=!g;++y<W;)$[y]=n[y];for(var ee=y;++D<R;)$[ee+D]=a[D];for(;++A<C;)(K||y<b)&&($[ee+h[A]]=n[y++]);return $}function yt(n,a){var h=-1,g=n.length;for(a||(a=B(g));++h<g;)a[h]=n[h];return a}function gr(n,a,h,g){var y=!h;h||(h={});for(var b=-1,A=a.length;++b<A;){var C=a[b],D=g?g(h[C],n[C],C,h,n):t;D===t&&(D=n[C]),y?Pr(h,C,D):Xn(h,C,D)}return h}function O1(n,a){return gr(n,dl(n),a)}function T1(n,a){return gr(n,pf(n),a)}function so(n,a){return function(h,g){var y=le(h)?Uw:Jb,b=a?a():{};return y(h,n,ie(g,2),b)}}function an(n){return he(function(a,h){var g=-1,y=h.length,b=y>1?h[y-1]:t,A=y>2?h[2]:t;for(b=n.length>3&&typeof b=="function"?(y--,b):t,A&&ht(h[0],h[1],A)&&(b=y<3?t:b,y=1),a=Ae(a);++g<y;){var C=h[g];C&&n(a,C,g,b)}return a})}function tf(n,a){return function(h,g){if(h==null)return h;if(!vt(h))return n(h,g);for(var y=h.length,b=a?y:-1,A=Ae(h);(a?b--:++b<y)&&g(A[b],b,A)!==!1;);return h}}function rf(n){return function(a,h,g){for(var y=-1,b=Ae(a),A=g(a),C=A.length;C--;){var D=A[n?C:++y];if(h(b[D],D,b)===!1)break}return a}}function D1(n,a,h){var g=a&x,y=Qn(n);function b(){var A=this&&this!==He&&this instanceof b?y:n;return A.apply(g?h:this,arguments)}return b}function nf(n){return function(a){a=xe(a);var h=Hi(a)?ir(a):t,g=h?h[0]:a.charAt(0),y=h?ri(h,1).join(""):a.slice(1);return g[n]()+y}}function ln(n){return function(a){return Da(rd(td(a).replace(bw,"")),n,"")}}function Qn(n){return function(){var a=arguments;switch(a.length){case 0:return new n;case 1:return new n(a[0]);case 2:return new n(a[0],a[1]);case 3:return new n(a[0],a[1],a[2]);case 4:return new n(a[0],a[1],a[2],a[3]);case 5:return new n(a[0],a[1],a[2],a[3],a[4]);case 6:return new n(a[0],a[1],a[2],a[3],a[4],a[5]);case 7:return new n(a[0],a[1],a[2],a[3],a[4],a[5],a[6])}var h=on(n.prototype),g=n.apply(h,a);return Ue(g)?g:h}}function I1(n,a,h){var g=Qn(n);function y(){for(var b=arguments.length,A=B(b),C=b,D=cn(y);C--;)A[C]=arguments[C];var R=b<3&&A[0]!==D&&A[b-1]!==D?[]:Er(A,D);if(b-=R.length,b<h)return cf(n,a,oo,y.placeholder,t,A,R,t,t,h-b);var W=this&&this!==He&&this instanceof y?g:n;return Pt(W,this,A)}return y}function sf(n){return function(a,h,g){var y=Ae(a);if(!vt(a)){var b=ie(h,3);a=Ye(a),h=function(C){return b(y[C],C,y)}}var A=n(a,h,g);return A>-1?y[b?a[A]:A]:t}}function of(n){return Cr(function(a){var h=a.length,g=h,y=Wt.prototype.thru;for(n&&a.reverse();g--;){var b=a[g];if(typeof b!="function")throw new Rt(l);if(y&&!A&&uo(b)=="wrapper")var A=new Wt([],!0)}for(g=A?g:h;++g<h;){b=a[g];var C=uo(b),D=C=="wrapper"?hl(b):t;D&&ml(D[0])&&D[1]==(G|L|z|U)&&!D[4].length&&D[9]==1?A=A[uo(D[0])].apply(A,D[3]):A=b.length==1&&ml(b)?A[C]():A.thru(b)}return function(){var R=arguments,W=R[0];if(A&&R.length==1&&le(W))return A.plant(W).value();for(var $=0,K=h?a[$].apply(this,R):W;++$<h;)K=a[$].call(this,K);return K}})}function oo(n,a,h,g,y,b,A,C,D,R){var W=a&G,$=a&x,K=a&O,ee=a&(L|F),ne=a&X,ue=K?t:Qn(n);function se(){for(var pe=arguments.length,_e=B(pe),Tt=pe;Tt--;)_e[Tt]=arguments[Tt];if(ee)var ft=cn(se),Dt=jw(_e,ft);if(g&&(_e=Hh(_e,g,y,ee)),b&&(_e=ef(_e,b,A,ee)),pe-=Dt,ee&&pe<R){var Re=Er(_e,ft);return cf(n,a,oo,se.placeholder,h,_e,Re,C,D,R-pe)}var or=$?h:this,Ir=K?or[n]:n;return pe=_e.length,C?_e=J1(_e,C):ne&&pe>1&&_e.reverse(),W&&D<pe&&(_e.length=D),this&&this!==He&&this instanceof se&&(Ir=ue||Qn(Ir)),Ir.apply(or,_e)}return se}function af(n,a){return function(h,g){return o1(h,n,a(g),{})}}function ao(n,a){return function(h,g){var y;if(h===t&&g===t)return a;if(h!==t&&(y=h),g!==t){if(y===t)return g;typeof h=="string"||typeof g=="string"?(h=Ct(h),g=Ct(g)):(h=Xh(h),g=Xh(g)),y=n(h,g)}return y}}function al(n){return Cr(function(a){return a=Fe(a,Lt(ie())),he(function(h){var g=this;return n(a,function(y){return Pt(y,g,h)})})})}function lo(n,a){a=a===t?" ":Ct(a);var h=a.length;if(h<2)return h?el(a,n):a;var g=el(a,Ks(n/en(a)));return Hi(a)?ri(ir(g),0,n).join(""):g.slice(0,n)}function F1(n,a,h,g){var y=a&x,b=Qn(n);function A(){for(var C=-1,D=arguments.length,R=-1,W=g.length,$=B(W+D),K=this&&this!==He&&this instanceof A?b:n;++R<W;)$[R]=g[R];for(;D--;)$[R++]=arguments[++C];return Pt(K,y?h:this,$)}return A}function lf(n){return function(a,h,g){return g&&typeof g!="number"&&ht(a,h,g)&&(h=g=t),a=Dr(a),h===t?(h=a,a=0):h=Dr(h),g=g===t?a<h?1:-1:Dr(g),y1(a,h,g,n)}}function co(n){return function(a,h){return typeof a=="string"&&typeof h=="string"||(a=Xt(a),h=Xt(h)),n(a,h)}}function cf(n,a,h,g,y,b,A,C,D,R){var W=a&L,$=W?A:t,K=W?t:A,ee=W?b:t,ne=W?t:b;a|=W?z:j,a&=~(W?j:z),a&P||(a&=-4);var ue=[n,a,y,ee,$,ne,K,C,D,R],se=h.apply(t,ue);return ml(n)&&bf(se,ue),se.placeholder=g,xf(se,n,a)}function ll(n){var a=$e[n];return function(h,g){if(h=Xt(h),g=g==null?0:nt(ce(g),292),g&&bh(h)){var y=(xe(h)+"e").split("e"),b=a(y[0]+"e"+(+y[1]+g));return y=(xe(b)+"e").split("e"),+(y[0]+"e"+(+y[1]-g))}return a(h)}}var B1=nn&&1/zs(new nn([,-0]))[1]==Pe?function(n){return new nn(n)}:Tl;function uf(n){return function(a){var h=st(a);return h==We?za(a):h==At?Ew(a):$w(a,n(a))}}function Lr(n,a,h,g,y,b,A,C){var D=a&O;if(!D&&typeof n!="function")throw new Rt(l);var R=g?g.length:0;if(R||(a&=-97,g=y=t),A=A===t?A:je(ce(A),0),C=C===t?C:ce(C),R-=y?y.length:0,a&j){var W=g,$=y;g=y=t}var K=D?t:hl(n),ee=[n,a,h,g,y,W,$,b,A,C];if(K&&q1(ee,K),n=ee[0],a=ee[1],h=ee[2],g=ee[3],y=ee[4],C=ee[9]=ee[9]===t?D?0:n.length:je(ee[9]-R,0),!C&&a&(L|F)&&(a&=-25),!a||a==x)var ne=D1(n,a,h);else a==L||a==F?ne=I1(n,a,C):(a==z||a==(x|z))&&!y.length?ne=F1(n,a,h,g):ne=oo.apply(t,ee);var ue=K?$h:bf;return xf(ue(ne,ee),n,a)}function hf(n,a,h,g){return n===t||sr(n,rn[h])&&!Me.call(g,h)?a:n}function ff(n,a,h,g,y,b){return Ue(n)&&Ue(a)&&(b.set(a,n),ro(n,a,t,ff,b),b.delete(a)),n}function U1(n){return Hn(n)?t:n}function df(n,a,h,g,y,b){var A=h&M,C=n.length,D=a.length;if(C!=D&&!(A&&D>C))return!1;var R=b.get(n),W=b.get(a);if(R&&W)return R==a&&W==n;var $=-1,K=!0,ee=h&S?new Pi:t;for(b.set(n,a),b.set(a,n);++$<C;){var ne=n[$],ue=a[$];if(g)var se=A?g(ue,ne,$,a,n,b):g(ne,ue,$,n,a,b);if(se!==t){if(se)continue;K=!1;break}if(ee){if(!Ia(a,function(pe,_e){if(!Nn(ee,_e)&&(ne===pe||y(ne,pe,h,g,b)))return ee.push(_e)})){K=!1;break}}else if(!(ne===ue||y(ne,ue,h,g,b))){K=!1;break}}return b.delete(n),b.delete(a),K}function V1(n,a,h,g,y,b,A){switch(h){case pr:if(n.byteLength!=a.byteLength||n.byteOffset!=a.byteOffset)return!1;n=n.buffer,a=a.buffer;case Zr:return!(n.byteLength!=a.byteLength||!b(new js(n),new js(a)));case gt:case Jt:case St:return sr(+n,+a);case xr:return n.name==a.name&&n.message==a.message;case _i:case Xr:return n==a+"";case We:var C=za;case At:var D=g&M;if(C||(C=zs),n.size!=a.size&&!D)return!1;var R=A.get(n);if(R)return R==a;g|=S,A.set(n,a);var W=df(C(n),C(a),g,y,b,A);return A.delete(n),W;case Yr:if(jn)return jn.call(n)==jn.call(a)}return!1}function k1(n,a,h,g,y,b){var A=h&M,C=cl(n),D=C.length,R=cl(a),W=R.length;if(D!=W&&!A)return!1;for(var $=D;$--;){var K=C[$];if(!(A?K in a:Me.call(a,K)))return!1}var ee=b.get(n),ne=b.get(a);if(ee&&ne)return ee==a&&ne==n;var ue=!0;b.set(n,a),b.set(a,n);for(var se=A;++$<D;){K=C[$];var pe=n[K],_e=a[K];if(g)var Tt=A?g(_e,pe,K,a,n,b):g(pe,_e,K,n,a,b);if(!(Tt===t?pe===_e||y(pe,_e,h,g,b):Tt)){ue=!1;break}se||(se=K=="constructor")}if(ue&&!se){var ft=n.constructor,Dt=a.constructor;ft!=Dt&&"constructor"in n&&"constructor"in a&&!(typeof ft=="function"&&ft instanceof ft&&typeof Dt=="function"&&Dt instanceof Dt)&&(ue=!1)}return b.delete(n),b.delete(a),ue}function Cr(n){return _l(vf(n,t,Cf),n+"")}function cl(n){return Ih(n,Ye,dl)}function ul(n){return Ih(n,wt,pf)}var hl=Qs?function(n){return Qs.get(n)}:Tl;function uo(n){for(var a=n.name+"",h=sn[a],g=Me.call(sn,a)?h.length:0;g--;){var y=h[g],b=y.func;if(b==null||b==n)return y.name}return a}function cn(n){var a=Me.call(w,"placeholder")?w:n;return a.placeholder}function ie(){var n=w.iteratee||Cl;return n=n===Cl?Uh:n,arguments.length?n(arguments[0],arguments[1]):n}function ho(n,a){var h=n.__data__;return X1(a)?h[typeof a=="string"?"string":"hash"]:h.map}function fl(n){for(var a=Ye(n),h=a.length;h--;){var g=a[h],y=n[g];a[h]=[g,y,_f(y)]}return a}function Oi(n,a){var h=Kw(n,a);return Bh(h)?h:t}function z1(n){var a=Me.call(n,Si),h=n[Si];try{n[Si]=t;var g=!0}catch{}var y=Gs.call(n);return g&&(a?n[Si]=h:delete n[Si]),y}var dl=Ra?function(n){return n==null?[]:(n=Ae(n),qr(Ra(n),function(a){return vh.call(n,a)}))}:Dl,pf=Ra?function(n){for(var a=[];n;)Qr(a,dl(n)),n=Xs(n);return a}:Dl,st=ut;(Wa&&st(new Wa(new ArrayBuffer(1)))!=pr||Wn&&st(new Wn)!=We||Ga&&st(Ga.resolve())!=gi||nn&&st(new nn)!=At||Gn&&st(new Gn)!=vi)&&(st=function(n){var a=ut(n),h=a==_t?n.constructor:t,g=h?Ti(h):"";if(g)switch(g){case wb:return pr;case bb:return We;case xb:return gi;case Mb:return At;case Sb:return vi}return a});function N1(n,a,h){for(var g=-1,y=h.length;++g<y;){var b=h[g],A=b.size;switch(b.type){case"drop":n+=A;break;case"dropRight":a-=A;break;case"take":a=nt(a,n+A);break;case"takeRight":n=je(n,a-A);break}}return{start:n,end:a}}function R1(n){var a=n.match(Yv);return a?a[1].split(Zv):[]}function mf(n,a,h){a=ti(a,n);for(var g=-1,y=a.length,b=!1;++g<y;){var A=_r(a[g]);if(!(b=n!=null&&h(n,A)))break;n=n[A]}return b||++g!=y?b:(y=n==null?0:n.length,!!y&&vo(y)&&Or(A,y)&&(le(n)||Di(n)))}function W1(n){var a=n.length,h=new n.constructor(a);return a&&typeof n[0]=="string"&&Me.call(n,"index")&&(h.index=n.index,h.input=n.input),h}function gf(n){return typeof n.constructor=="function"&&!En(n)?on(Xs(n)):{}}function G1(n,a,h){var g=n.constructor;switch(a){case Zr:return ol(n);case gt:case Jt:return new g(+n);case pr:return A1(n,h);case Un:case Vn:case Ki:case kn:case zn:case qi:case wi:case I:case Y:return Eh(n,h);case We:return new g;case St:case Xr:return new g(n);case _i:return P1(n);case At:return new g;case Yr:return L1(n)}}function $1(n,a){var h=a.length;if(!h)return n;var g=h-1;return a[g]=(h>1?"& ":"")+a[g],a=a.join(h>2?", ":" "),n.replace(Xv,`{
/* [wrapped with `+a+`] */
`)}function j1(n){return le(n)||Di(n)||!!(wh&&n&&n[wh])}function Or(n,a){var h=typeof n;return a=a??ve,!!a&&(h=="number"||h!="symbol"&&rw.test(n))&&n>-1&&n%1==0&&n<a}function ht(n,a,h){if(!Ue(h))return!1;var g=typeof a;return(g=="number"?vt(h)&&Or(a,h.length):g=="string"&&a in h)?sr(h[a],n):!1}function pl(n,a){if(le(n))return!1;var h=typeof n;return h=="number"||h=="symbol"||h=="boolean"||n==null||Ot(n)?!0:xi.test(n)||!bi.test(n)||a!=null&&n in Ae(a)}function X1(n){var a=typeof n;return a=="string"||a=="number"||a=="symbol"||a=="boolean"?n!=="__proto__":n===null}function ml(n){var a=uo(n),h=w[a];if(typeof h!="function"||!(a in ge.prototype))return!1;if(n===h)return!0;var g=hl(h);return!!g&&n===g[0]}function Y1(n){return!!gh&&gh in n}var Z1=Rs?Tr:Il;function En(n){var a=n&&n.constructor,h=typeof a=="function"&&a.prototype||rn;return n===h}function _f(n){return n===n&&!Ue(n)}function yf(n,a){return function(h){return h==null?!1:h[n]===a&&(a!==t||n in Ae(h))}}function K1(n){var a=_o(n,function(g){return h.size===d&&h.clear(),g}),h=a.cache;return a}function q1(n,a){var h=n[1],g=a[1],y=h|g,b=y<(x|O|G),A=g==G&&h==L||g==G&&h==U&&n[7].length<=a[8]||g==(G|U)&&a[7].length<=a[8]&&h==L;if(!(b||A))return n;g&x&&(n[2]=a[2],y|=h&x?0:P);var C=a[3];if(C){var D=n[3];n[3]=D?Hh(D,C,a[4]):C,n[4]=D?Er(n[3],m):a[4]}return C=a[5],C&&(D=n[5],n[5]=D?ef(D,C,a[6]):C,n[6]=D?Er(n[5],m):a[6]),C=a[7],C&&(n[7]=C),g&G&&(n[8]=n[8]==null?a[8]:nt(n[8],a[8])),n[9]==null&&(n[9]=a[9]),n[0]=a[0],n[1]=y,n}function Q1(n){var a=[];if(n!=null)for(var h in Ae(n))a.push(h);return a}function E1(n){return Gs.call(n)}function vf(n,a,h){return a=je(a===t?n.length-1:a,0),function(){for(var g=arguments,y=-1,b=je(g.length-a,0),A=B(b);++y<b;)A[y]=g[a+y];y=-1;for(var C=B(a+1);++y<a;)C[y]=g[y];return C[a]=h(A),Pt(n,this,C)}}function wf(n,a){return a.length<2?n:Ci(n,$t(a,0,-1))}function J1(n,a){for(var h=n.length,g=nt(a.length,h),y=yt(n);g--;){var b=a[g];n[g]=Or(b,h)?y[b]:t}return n}function gl(n,a){if(!(a==="constructor"&&typeof n[a]=="function")&&a!="__proto__")return n[a]}var bf=Mf($h),Jn=db||function(n,a){return He.setTimeout(n,a)},_l=Mf(b1);function xf(n,a,h){var g=a+"";return _l(n,$1(g,H1(R1(g),h)))}function Mf(n){var a=0,h=0;return function(){var g=_b(),y=E-(g-h);if(h=g,y>0){if(++a>=Z)return arguments[0]}else a=0;return n.apply(t,arguments)}}function fo(n,a){var h=-1,g=n.length,y=g-1;for(a=a===t?g:a;++h<a;){var b=Ha(h,y),A=n[b];n[b]=n[h],n[h]=A}return n.length=a,n}var Sf=K1(function(n){var a=[];return n.charCodeAt(0)===46&&a.push(""),n.replace(Qi,function(h,g,y,b){a.push(y?b.replace(Qv,"$1"):g||h)}),a});function _r(n){if(typeof n=="string"||Ot(n))return n;var a=n+"";return a=="0"&&1/n==-Pe?"-0":a}function Ti(n){if(n!=null){try{return Ws.call(n)}catch{}try{return n+""}catch{}}return""}function H1(n,a){return Nt(lt,function(h){var g="_."+h[0];a&h[1]&&!Vs(n,g)&&n.push(g)}),n.sort()}function Af(n){if(n instanceof ge)return n.clone();var a=new Wt(n.__wrapped__,n.__chain__);return a.__actions__=yt(n.__actions__),a.__index__=n.__index__,a.__values__=n.__values__,a}function ex(n,a,h){(h?ht(n,a,h):a===t)?a=1:a=je(ce(a),0);var g=n==null?0:n.length;if(!g||a<1)return[];for(var y=0,b=0,A=B(Ks(g/a));y<g;)A[b++]=$t(n,y,y+=a);return A}function tx(n){for(var a=-1,h=n==null?0:n.length,g=0,y=[];++a<h;){var b=n[a];b&&(y[g++]=b)}return y}function rx(){var n=arguments.length;if(!n)return[];for(var a=B(n-1),h=arguments[0],g=n;g--;)a[g-1]=arguments[g];return Qr(le(h)?yt(h):[h],et(a,1))}var ix=he(function(n,a){return Ne(n)?Yn(n,et(a,1,Ne,!0)):[]}),nx=he(function(n,a){var h=jt(a);return Ne(h)&&(h=t),Ne(n)?Yn(n,et(a,1,Ne,!0),ie(h,2)):[]}),sx=he(function(n,a){var h=jt(a);return Ne(h)&&(h=t),Ne(n)?Yn(n,et(a,1,Ne,!0),t,h):[]});function ox(n,a,h){var g=n==null?0:n.length;return g?(a=h||a===t?1:ce(a),$t(n,a<0?0:a,g)):[]}function ax(n,a,h){var g=n==null?0:n.length;return g?(a=h||a===t?1:ce(a),a=g-a,$t(n,0,a<0?0:a)):[]}function lx(n,a){return n&&n.length?no(n,ie(a,3),!0,!0):[]}function cx(n,a){return n&&n.length?no(n,ie(a,3),!0):[]}function ux(n,a,h,g){var y=n==null?0:n.length;return y?(h&&typeof h!="number"&&ht(n,a,h)&&(h=0,g=y),r1(n,a,h,g)):[]}function Pf(n,a,h){var g=n==null?0:n.length;if(!g)return-1;var y=h==null?0:ce(h);return y<0&&(y=je(g+y,0)),ks(n,ie(a,3),y)}function Lf(n,a,h){var g=n==null?0:n.length;if(!g)return-1;var y=g-1;return h!==t&&(y=ce(h),y=h<0?je(g+y,0):nt(y,g-1)),ks(n,ie(a,3),y,!0)}function Cf(n){var a=n==null?0:n.length;return a?et(n,1):[]}function hx(n){var a=n==null?0:n.length;return a?et(n,Pe):[]}function fx(n,a){var h=n==null?0:n.length;return h?(a=a===t?1:ce(a),et(n,a)):[]}function dx(n){for(var a=-1,h=n==null?0:n.length,g={};++a<h;){var y=n[a];g[y[0]]=y[1]}return g}function Of(n){return n&&n.length?n[0]:t}function px(n,a,h){var g=n==null?0:n.length;if(!g)return-1;var y=h==null?0:ce(h);return y<0&&(y=je(g+y,0)),Ji(n,a,y)}function mx(n){var a=n==null?0:n.length;return a?$t(n,0,-1):[]}var gx=he(function(n){var a=Fe(n,nl);return a.length&&a[0]===n[0]?Ka(a):[]}),_x=he(function(n){var a=jt(n),h=Fe(n,nl);return a===jt(h)?a=t:h.pop(),h.length&&h[0]===n[0]?Ka(h,ie(a,2)):[]}),yx=he(function(n){var a=jt(n),h=Fe(n,nl);return a=typeof a=="function"?a:t,a&&h.pop(),h.length&&h[0]===n[0]?Ka(h,t,a):[]});function vx(n,a){return n==null?"":mb.call(n,a)}function jt(n){var a=n==null?0:n.length;return a?n[a-1]:t}function wx(n,a,h){var g=n==null?0:n.length;if(!g)return-1;var y=g;return h!==t&&(y=ce(h),y=y<0?je(g+y,0):nt(y,g-1)),a===a?Hw(n,a,y):ks(n,lh,y,!0)}function bx(n,a){return n&&n.length?Nh(n,ce(a)):t}var xx=he(Tf);function Tf(n,a){return n&&n.length&&a&&a.length?Ja(n,a):n}function Mx(n,a,h){return n&&n.length&&a&&a.length?Ja(n,a,ie(h,2)):n}function Sx(n,a,h){return n&&n.length&&a&&a.length?Ja(n,a,t,h):n}var Ax=Cr(function(n,a){var h=n==null?0:n.length,g=ja(n,a);return Gh(n,Fe(a,function(y){return Or(y,h)?+y:y}).sort(Jh)),g});function Px(n,a){var h=[];if(!(n&&n.length))return h;var g=-1,y=[],b=n.length;for(a=ie(a,3);++g<b;){var A=n[g];a(A,g,n)&&(h.push(A),y.push(g))}return Gh(n,y),h}function yl(n){return n==null?n:vb.call(n)}function Lx(n,a,h){var g=n==null?0:n.length;return g?(h&&typeof h!="number"&&ht(n,a,h)?(a=0,h=g):(a=a==null?0:ce(a),h=h===t?g:ce(h)),$t(n,a,h)):[]}function Cx(n,a){return io(n,a)}function Ox(n,a,h){return tl(n,a,ie(h,2))}function Tx(n,a){var h=n==null?0:n.length;if(h){var g=io(n,a);if(g<h&&sr(n[g],a))return g}return-1}function Dx(n,a){return io(n,a,!0)}function Ix(n,a,h){return tl(n,a,ie(h,2),!0)}function Fx(n,a){var h=n==null?0:n.length;if(h){var g=io(n,a,!0)-1;if(sr(n[g],a))return g}return-1}function Bx(n){return n&&n.length?jh(n):[]}function Ux(n,a){return n&&n.length?jh(n,ie(a,2)):[]}function Vx(n){var a=n==null?0:n.length;return a?$t(n,1,a):[]}function kx(n,a,h){return n&&n.length?(a=h||a===t?1:ce(a),$t(n,0,a<0?0:a)):[]}function zx(n,a,h){var g=n==null?0:n.length;return g?(a=h||a===t?1:ce(a),a=g-a,$t(n,a<0?0:a,g)):[]}function Nx(n,a){return n&&n.length?no(n,ie(a,3),!1,!0):[]}function Rx(n,a){return n&&n.length?no(n,ie(a,3)):[]}var Wx=he(function(n){return ei(et(n,1,Ne,!0))}),Gx=he(function(n){var a=jt(n);return Ne(a)&&(a=t),ei(et(n,1,Ne,!0),ie(a,2))}),$x=he(function(n){var a=jt(n);return a=typeof a=="function"?a:t,ei(et(n,1,Ne,!0),t,a)});function jx(n){return n&&n.length?ei(n):[]}function Xx(n,a){return n&&n.length?ei(n,ie(a,2)):[]}function Yx(n,a){return a=typeof a=="function"?a:t,n&&n.length?ei(n,t,a):[]}function vl(n){if(!(n&&n.length))return[];var a=0;return n=qr(n,function(h){if(Ne(h))return a=je(h.length,a),!0}),Va(a,function(h){return Fe(n,Fa(h))})}function Df(n,a){if(!(n&&n.length))return[];var h=vl(n);return a==null?h:Fe(h,function(g){return Pt(a,t,g)})}var Zx=he(function(n,a){return Ne(n)?Yn(n,a):[]}),Kx=he(function(n){return il(qr(n,Ne))}),qx=he(function(n){var a=jt(n);return Ne(a)&&(a=t),il(qr(n,Ne),ie(a,2))}),Qx=he(function(n){var a=jt(n);return a=typeof a=="function"?a:t,il(qr(n,Ne),t,a)}),Ex=he(vl);function Jx(n,a){return Kh(n||[],a||[],Xn)}function Hx(n,a){return Kh(n||[],a||[],qn)}var eM=he(function(n){var a=n.length,h=a>1?n[a-1]:t;return h=typeof h=="function"?(n.pop(),h):t,Df(n,h)});function If(n){var a=w(n);return a.__chain__=!0,a}function tM(n,a){return a(n),n}function po(n,a){return a(n)}var rM=Cr(function(n){var a=n.length,h=a?n[0]:0,g=this.__wrapped__,y=function(b){return ja(b,n)};return a>1||this.__actions__.length||!(g instanceof ge)||!Or(h)?this.thru(y):(g=g.slice(h,+h+(a?1:0)),g.__actions__.push({func:po,args:[y],thisArg:t}),new Wt(g,this.__chain__).thru(function(b){return a&&!b.length&&b.push(t),b}))});function iM(){return If(this)}function nM(){return new Wt(this.value(),this.__chain__)}function sM(){this.__values__===t&&(this.__values__=Yf(this.value()));var n=this.__index__>=this.__values__.length,a=n?t:this.__values__[this.__index__++];return{done:n,value:a}}function oM(){return this}function aM(n){for(var a,h=this;h instanceof Js;){var g=Af(h);g.__index__=0,g.__values__=t,a?y.__wrapped__=g:a=g;var y=g;h=h.__wrapped__}return y.__wrapped__=n,a}function lM(){var n=this.__wrapped__;if(n instanceof ge){var a=n;return this.__actions__.length&&(a=new ge(this)),a=a.reverse(),a.__actions__.push({func:po,args:[yl],thisArg:t}),new Wt(a,this.__chain__)}return this.thru(yl)}function cM(){return Zh(this.__wrapped__,this.__actions__)}var uM=so(function(n,a,h){Me.call(n,h)?++n[h]:Pr(n,h,1)});function hM(n,a,h){var g=le(n)?oh:t1;return h&&ht(n,a,h)&&(a=t),g(n,ie(a,3))}function fM(n,a){var h=le(n)?qr:Th;return h(n,ie(a,3))}var dM=sf(Pf),pM=sf(Lf);function mM(n,a){return et(mo(n,a),1)}function gM(n,a){return et(mo(n,a),Pe)}function _M(n,a,h){return h=h===t?1:ce(h),et(mo(n,a),h)}function Ff(n,a){var h=le(n)?Nt:Hr;return h(n,ie(a,3))}function Bf(n,a){var h=le(n)?Vw:Oh;return h(n,ie(a,3))}var yM=so(function(n,a,h){Me.call(n,h)?n[h].push(a):Pr(n,h,[a])});function vM(n,a,h,g){n=vt(n)?n:hn(n),h=h&&!g?ce(h):0;var y=n.length;return h<0&&(h=je(y+h,0)),wo(n)?h<=y&&n.indexOf(a,h)>-1:!!y&&Ji(n,a,h)>-1}var wM=he(function(n,a,h){var g=-1,y=typeof a=="function",b=vt(n)?B(n.length):[];return Hr(n,function(A){b[++g]=y?Pt(a,A,h):Zn(A,a,h)}),b}),bM=so(function(n,a,h){Pr(n,h,a)});function mo(n,a){var h=le(n)?Fe:Vh;return h(n,ie(a,3))}function xM(n,a,h,g){return n==null?[]:(le(a)||(a=a==null?[]:[a]),h=g?t:h,le(h)||(h=h==null?[]:[h]),Rh(n,a,h))}var MM=so(function(n,a,h){n[h?0:1].push(a)},function(){return[[],[]]});function SM(n,a,h){var g=le(n)?Da:uh,y=arguments.length<3;return g(n,ie(a,4),h,y,Hr)}function AM(n,a,h){var g=le(n)?kw:uh,y=arguments.length<3;return g(n,ie(a,4),h,y,Oh)}function PM(n,a){var h=le(n)?qr:Th;return h(n,yo(ie(a,3)))}function LM(n){var a=le(n)?Ah:v1;return a(n)}function CM(n,a,h){(h?ht(n,a,h):a===t)?a=1:a=ce(a);var g=le(n)?Qb:w1;return g(n,a)}function OM(n){var a=le(n)?Eb:x1;return a(n)}function TM(n){if(n==null)return 0;if(vt(n))return wo(n)?en(n):n.length;var a=st(n);return a==We||a==At?n.size:Qa(n).length}function DM(n,a,h){var g=le(n)?Ia:M1;return h&&ht(n,a,h)&&(a=t),g(n,ie(a,3))}var IM=he(function(n,a){if(n==null)return[];var h=a.length;return h>1&&ht(n,a[0],a[1])?a=[]:h>2&&ht(a[0],a[1],a[2])&&(a=[a[0]]),Rh(n,et(a,1),[])}),go=fb||function(){return He.Date.now()};function FM(n,a){if(typeof a!="function")throw new Rt(l);return n=ce(n),function(){if(--n<1)return a.apply(this,arguments)}}function Uf(n,a,h){return a=h?t:a,a=n&&a==null?n.length:a,Lr(n,G,t,t,t,t,a)}function Vf(n,a){var h;if(typeof a!="function")throw new Rt(l);return n=ce(n),function(){return--n>0&&(h=a.apply(this,arguments)),n<=1&&(a=t),h}}var wl=he(function(n,a,h){var g=x;if(h.length){var y=Er(h,cn(wl));g|=z}return Lr(n,g,a,h,y)}),kf=he(function(n,a,h){var g=x|O;if(h.length){var y=Er(h,cn(kf));g|=z}return Lr(a,g,n,h,y)});function zf(n,a,h){a=h?t:a;var g=Lr(n,L,t,t,t,t,t,a);return g.placeholder=zf.placeholder,g}function Nf(n,a,h){a=h?t:a;var g=Lr(n,F,t,t,t,t,t,a);return g.placeholder=Nf.placeholder,g}function Rf(n,a,h){var g,y,b,A,C,D,R=0,W=!1,$=!1,K=!0;if(typeof n!="function")throw new Rt(l);a=Xt(a)||0,Ue(h)&&(W=!!h.leading,$="maxWait"in h,b=$?je(Xt(h.maxWait)||0,a):b,K="trailing"in h?!!h.trailing:K);function ee(Re){var or=g,Ir=y;return g=y=t,R=Re,A=n.apply(Ir,or),A}function ne(Re){return R=Re,C=Jn(pe,a),W?ee(Re):A}function ue(Re){var or=Re-D,Ir=Re-R,sd=a-or;return $?nt(sd,b-Ir):sd}function se(Re){var or=Re-D,Ir=Re-R;return D===t||or>=a||or<0||$&&Ir>=b}function pe(){var Re=go();if(se(Re))return _e(Re);C=Jn(pe,ue(Re))}function _e(Re){return C=t,K&&g?ee(Re):(g=y=t,A)}function Tt(){C!==t&&qh(C),R=0,g=D=y=C=t}function ft(){return C===t?A:_e(go())}function Dt(){var Re=go(),or=se(Re);if(g=arguments,y=this,D=Re,or){if(C===t)return ne(D);if($)return qh(C),C=Jn(pe,a),ee(D)}return C===t&&(C=Jn(pe,a)),A}return Dt.cancel=Tt,Dt.flush=ft,Dt}var BM=he(function(n,a){return Ch(n,1,a)}),UM=he(function(n,a,h){return Ch(n,Xt(a)||0,h)});function VM(n){return Lr(n,X)}function _o(n,a){if(typeof n!="function"||a!=null&&typeof a!="function")throw new Rt(l);var h=function(){var g=arguments,y=a?a.apply(this,g):g[0],b=h.cache;if(b.has(y))return b.get(y);var A=n.apply(this,g);return h.cache=b.set(y,A)||b,A};return h.cache=new(_o.Cache||Ar),h}_o.Cache=Ar;function yo(n){if(typeof n!="function")throw new Rt(l);return function(){var a=arguments;switch(a.length){case 0:return!n.call(this);case 1:return!n.call(this,a[0]);case 2:return!n.call(this,a[0],a[1]);case 3:return!n.call(this,a[0],a[1],a[2])}return!n.apply(this,a)}}function kM(n){return Vf(2,n)}var zM=S1(function(n,a){a=a.length==1&&le(a[0])?Fe(a[0],Lt(ie())):Fe(et(a,1),Lt(ie()));var h=a.length;return he(function(g){for(var y=-1,b=nt(g.length,h);++y<b;)g[y]=a[y].call(this,g[y]);return Pt(n,this,g)})}),bl=he(function(n,a){var h=Er(a,cn(bl));return Lr(n,z,t,a,h)}),Wf=he(function(n,a){var h=Er(a,cn(Wf));return Lr(n,j,t,a,h)}),NM=Cr(function(n,a){return Lr(n,U,t,t,t,a)});function RM(n,a){if(typeof n!="function")throw new Rt(l);return a=a===t?a:ce(a),he(n,a)}function WM(n,a){if(typeof n!="function")throw new Rt(l);return a=a==null?0:je(ce(a),0),he(function(h){var g=h[a],y=ri(h,0,a);return g&&Qr(y,g),Pt(n,this,y)})}function GM(n,a,h){var g=!0,y=!0;if(typeof n!="function")throw new Rt(l);return Ue(h)&&(g="leading"in h?!!h.leading:g,y="trailing"in h?!!h.trailing:y),Rf(n,a,{leading:g,maxWait:a,trailing:y})}function $M(n){return Uf(n,1)}function jM(n,a){return bl(sl(a),n)}function XM(){if(!arguments.length)return[];var n=arguments[0];return le(n)?n:[n]}function YM(n){return Gt(n,v)}function ZM(n,a){return a=typeof a=="function"?a:t,Gt(n,v,a)}function KM(n){return Gt(n,p|v)}function qM(n,a){return a=typeof a=="function"?a:t,Gt(n,p|v,a)}function QM(n,a){return a==null||Lh(n,a,Ye(a))}function sr(n,a){return n===a||n!==n&&a!==a}var EM=co(Za),JM=co(function(n,a){return n>=a}),Di=Fh((function(){return arguments})())?Fh:function(n){return ke(n)&&Me.call(n,"callee")&&!vh.call(n,"callee")},le=B.isArray,HM=eh?Lt(eh):a1;function vt(n){return n!=null&&vo(n.length)&&!Tr(n)}function Ne(n){return ke(n)&&vt(n)}function eS(n){return n===!0||n===!1||ke(n)&&ut(n)==gt}var ii=pb||Il,tS=th?Lt(th):l1;function rS(n){return ke(n)&&n.nodeType===1&&!Hn(n)}function iS(n){if(n==null)return!0;if(vt(n)&&(le(n)||typeof n=="string"||typeof n.splice=="function"||ii(n)||un(n)||Di(n)))return!n.length;var a=st(n);if(a==We||a==At)return!n.size;if(En(n))return!Qa(n).length;for(var h in n)if(Me.call(n,h))return!1;return!0}function nS(n,a){return Kn(n,a)}function sS(n,a,h){h=typeof h=="function"?h:t;var g=h?h(n,a):t;return g===t?Kn(n,a,t,h):!!g}function xl(n){if(!ke(n))return!1;var a=ut(n);return a==xr||a==Yi||typeof n.message=="string"&&typeof n.name=="string"&&!Hn(n)}function oS(n){return typeof n=="number"&&bh(n)}function Tr(n){if(!Ue(n))return!1;var a=ut(n);return a==Ht||a==Mr||a==Et||a==Zi}function Gf(n){return typeof n=="number"&&n==ce(n)}function vo(n){return typeof n=="number"&&n>-1&&n%1==0&&n<=ve}function Ue(n){var a=typeof n;return n!=null&&(a=="object"||a=="function")}function ke(n){return n!=null&&typeof n=="object"}var $f=rh?Lt(rh):u1;function aS(n,a){return n===a||qa(n,a,fl(a))}function lS(n,a,h){return h=typeof h=="function"?h:t,qa(n,a,fl(a),h)}function cS(n){return jf(n)&&n!=+n}function uS(n){if(Z1(n))throw new ae(o);return Bh(n)}function hS(n){return n===null}function fS(n){return n==null}function jf(n){return typeof n=="number"||ke(n)&&ut(n)==St}function Hn(n){if(!ke(n)||ut(n)!=_t)return!1;var a=Xs(n);if(a===null)return!0;var h=Me.call(a,"constructor")&&a.constructor;return typeof h=="function"&&h instanceof h&&Ws.call(h)==lb}var Ml=ih?Lt(ih):h1;function dS(n){return Gf(n)&&n>=-ve&&n<=ve}var Xf=nh?Lt(nh):f1;function wo(n){return typeof n=="string"||!le(n)&&ke(n)&&ut(n)==Xr}function Ot(n){return typeof n=="symbol"||ke(n)&&ut(n)==Yr}var un=sh?Lt(sh):d1;function pS(n){return n===t}function mS(n){return ke(n)&&st(n)==vi}function gS(n){return ke(n)&&ut(n)==wa}var _S=co(Ea),yS=co(function(n,a){return n<=a});function Yf(n){if(!n)return[];if(vt(n))return wo(n)?ir(n):yt(n);if(Rn&&n[Rn])return Qw(n[Rn]());var a=st(n),h=a==We?za:a==At?zs:hn;return h(n)}function Dr(n){if(!n)return n===0?n:0;if(n=Xt(n),n===Pe||n===-Pe){var a=n<0?-1:1;return a*we}return n===n?n:0}function ce(n){var a=Dr(n),h=a%1;return a===a?h?a-h:a:0}function Zf(n){return n?Li(ce(n),0,Le):0}function Xt(n){if(typeof n=="number")return n;if(Ot(n))return me;if(Ue(n)){var a=typeof n.valueOf=="function"?n.valueOf():n;n=Ue(a)?a+"":a}if(typeof n!="string")return n===0?n:+n;n=hh(n);var h=Hv.test(n);return h||tw.test(n)?Fw(n.slice(2),h?2:8):Jv.test(n)?me:+n}function Kf(n){return gr(n,wt(n))}function vS(n){return n?Li(ce(n),-ve,ve):n===0?n:0}function xe(n){return n==null?"":Ct(n)}var wS=an(function(n,a){if(En(a)||vt(a)){gr(a,Ye(a),n);return}for(var h in a)Me.call(a,h)&&Xn(n,h,a[h])}),qf=an(function(n,a){gr(a,wt(a),n)}),bo=an(function(n,a,h,g){gr(a,wt(a),n,g)}),bS=an(function(n,a,h,g){gr(a,Ye(a),n,g)}),xS=Cr(ja);function MS(n,a){var h=on(n);return a==null?h:Ph(h,a)}var SS=he(function(n,a){n=Ae(n);var h=-1,g=a.length,y=g>2?a[2]:t;for(y&&ht(a[0],a[1],y)&&(g=1);++h<g;)for(var b=a[h],A=wt(b),C=-1,D=A.length;++C<D;){var R=A[C],W=n[R];(W===t||sr(W,rn[R])&&!Me.call(n,R))&&(n[R]=b[R])}return n}),AS=he(function(n){return n.push(t,ff),Pt(Qf,t,n)});function PS(n,a){return ah(n,ie(a,3),mr)}function LS(n,a){return ah(n,ie(a,3),Ya)}function CS(n,a){return n==null?n:Xa(n,ie(a,3),wt)}function OS(n,a){return n==null?n:Dh(n,ie(a,3),wt)}function TS(n,a){return n&&mr(n,ie(a,3))}function DS(n,a){return n&&Ya(n,ie(a,3))}function IS(n){return n==null?[]:to(n,Ye(n))}function FS(n){return n==null?[]:to(n,wt(n))}function Sl(n,a,h){var g=n==null?t:Ci(n,a);return g===t?h:g}function BS(n,a){return n!=null&&mf(n,a,i1)}function Al(n,a){return n!=null&&mf(n,a,n1)}var US=af(function(n,a,h){a!=null&&typeof a.toString!="function"&&(a=Gs.call(a)),n[a]=h},Ll(bt)),VS=af(function(n,a,h){a!=null&&typeof a.toString!="function"&&(a=Gs.call(a)),Me.call(n,a)?n[a].push(h):n[a]=[h]},ie),kS=he(Zn);function Ye(n){return vt(n)?Sh(n):Qa(n)}function wt(n){return vt(n)?Sh(n,!0):p1(n)}function zS(n,a){var h={};return a=ie(a,3),mr(n,function(g,y,b){Pr(h,a(g,y,b),g)}),h}function NS(n,a){var h={};return a=ie(a,3),mr(n,function(g,y,b){Pr(h,y,a(g,y,b))}),h}var RS=an(function(n,a,h){ro(n,a,h)}),Qf=an(function(n,a,h,g){ro(n,a,h,g)}),WS=Cr(function(n,a){var h={};if(n==null)return h;var g=!1;a=Fe(a,function(b){return b=ti(b,n),g||(g=b.length>1),b}),gr(n,ul(n),h),g&&(h=Gt(h,p|_|v,U1));for(var y=a.length;y--;)rl(h,a[y]);return h});function GS(n,a){return Ef(n,yo(ie(a)))}var $S=Cr(function(n,a){return n==null?{}:g1(n,a)});function Ef(n,a){if(n==null)return{};var h=Fe(ul(n),function(g){return[g]});return a=ie(a),Wh(n,h,function(g,y){return a(g,y[0])})}function jS(n,a,h){a=ti(a,n);var g=-1,y=a.length;for(y||(y=1,n=t);++g<y;){var b=n==null?t:n[_r(a[g])];b===t&&(g=y,b=h),n=Tr(b)?b.call(n):b}return n}function XS(n,a,h){return n==null?n:qn(n,a,h)}function YS(n,a,h,g){return g=typeof g=="function"?g:t,n==null?n:qn(n,a,h,g)}var Jf=uf(Ye),Hf=uf(wt);function ZS(n,a,h){var g=le(n),y=g||ii(n)||un(n);if(a=ie(a,4),h==null){var b=n&&n.constructor;y?h=g?new b:[]:Ue(n)?h=Tr(b)?on(Xs(n)):{}:h={}}return(y?Nt:mr)(n,function(A,C,D){return a(h,A,C,D)}),h}function KS(n,a){return n==null?!0:rl(n,a)}function qS(n,a,h){return n==null?n:Yh(n,a,sl(h))}function QS(n,a,h,g){return g=typeof g=="function"?g:t,n==null?n:Yh(n,a,sl(h),g)}function hn(n){return n==null?[]:ka(n,Ye(n))}function ES(n){return n==null?[]:ka(n,wt(n))}function JS(n,a,h){return h===t&&(h=a,a=t),h!==t&&(h=Xt(h),h=h===h?h:0),a!==t&&(a=Xt(a),a=a===a?a:0),Li(Xt(n),a,h)}function HS(n,a,h){return a=Dr(a),h===t?(h=a,a=0):h=Dr(h),n=Xt(n),s1(n,a,h)}function e2(n,a,h){if(h&&typeof h!="boolean"&&ht(n,a,h)&&(a=h=t),h===t&&(typeof a=="boolean"?(h=a,a=t):typeof n=="boolean"&&(h=n,n=t)),n===t&&a===t?(n=0,a=1):(n=Dr(n),a===t?(a=n,n=0):a=Dr(a)),n>a){var g=n;n=a,a=g}if(h||n%1||a%1){var y=xh();return nt(n+y*(a-n+Iw("1e-"+((y+"").length-1))),a)}return Ha(n,a)}var t2=ln(function(n,a,h){return a=a.toLowerCase(),n+(h?ed(a):a)});function ed(n){return Pl(xe(n).toLowerCase())}function td(n){return n=xe(n),n&&n.replace(iw,Xw).replace(xw,"")}function r2(n,a,h){n=xe(n),a=Ct(a);var g=n.length;h=h===t?g:Li(ce(h),0,g);var y=h;return h-=a.length,h>=0&&n.slice(h,y)==a}function i2(n){return n=xe(n),n&&Is.test(n)?n.replace(er,Yw):n}function n2(n){return n=xe(n),n&&$v.test(n)?n.replace(ba,"\\$&"):n}var s2=ln(function(n,a,h){return n+(h?"-":"")+a.toLowerCase()}),o2=ln(function(n,a,h){return n+(h?" ":"")+a.toLowerCase()}),a2=nf("toLowerCase");function l2(n,a,h){n=xe(n),a=ce(a);var g=a?en(n):0;if(!a||g>=a)return n;var y=(a-g)/2;return lo(qs(y),h)+n+lo(Ks(y),h)}function c2(n,a,h){n=xe(n),a=ce(a);var g=a?en(n):0;return a&&g<a?n+lo(a-g,h):n}function u2(n,a,h){n=xe(n),a=ce(a);var g=a?en(n):0;return a&&g<a?lo(a-g,h)+n:n}function h2(n,a,h){return h||a==null?a=0:a&&(a=+a),yb(xe(n).replace(xa,""),a||0)}function f2(n,a,h){return(h?ht(n,a,h):a===t)?a=1:a=ce(a),el(xe(n),a)}function d2(){var n=arguments,a=xe(n[0]);return n.length<3?a:a.replace(n[1],n[2])}var p2=ln(function(n,a,h){return n+(h?"_":"")+a.toLowerCase()});function m2(n,a,h){return h&&typeof h!="number"&&ht(n,a,h)&&(a=h=t),h=h===t?Le:h>>>0,h?(n=xe(n),n&&(typeof a=="string"||a!=null&&!Ml(a))&&(a=Ct(a),!a&&Hi(n))?ri(ir(n),0,h):n.split(a,h)):[]}var g2=ln(function(n,a,h){return n+(h?" ":"")+Pl(a)});function _2(n,a,h){return n=xe(n),h=h==null?0:Li(ce(h),0,n.length),a=Ct(a),n.slice(h,h+a.length)==a}function y2(n,a,h){var g=w.templateSettings;h&&ht(n,a,h)&&(a=t),n=xe(n),a=bo({},a,g,hf);var y=bo({},a.imports,g.imports,hf),b=Ye(y),A=ka(y,b),C,D,R=0,W=a.interpolate||Fs,$="__p += '",K=Na((a.escape||Fs).source+"|"+W.source+"|"+(W===Kr?Ev:Fs).source+"|"+(a.evaluate||Fs).source+"|$","g"),ee="//# sourceURL="+(Me.call(a,"sourceURL")?(a.sourceURL+"").replace(/\s/g," "):"lodash.templateSources["+ ++Lw+"]")+`
`;n.replace(K,function(se,pe,_e,Tt,ft,Dt){return _e||(_e=Tt),$+=n.slice(R,Dt).replace(nw,Zw),pe&&(C=!0,$+=`' +
__e(`+pe+`) +
'`),ft&&(D=!0,$+=`';
`+ft+`;
__p += '`),_e&&($+=`' +
((__t = (`+_e+`)) == null ? '' : __t) +
'`),R=Dt+se.length,se}),$+=`';
`;var ne=Me.call(a,"variable")&&a.variable;if(!ne)$=`with (obj) {
`+$+`
}
`;else if(qv.test(ne))throw new ae(c);$=(D?$.replace(oe,""):$).replace(ye,"$1").replace(Ge,"$1;"),$="function("+(ne||"obj")+`) {
`+(ne?"":`obj || (obj = {});
`)+"var __t, __p = ''"+(C?", __e = _.escape":"")+(D?`, __j = Array.prototype.join;
function print() { __p += __j.call(arguments, '') }
`:`;
`)+$+`return __p
}`;var ue=id(function(){return be(b,ee+"return "+$).apply(t,A)});if(ue.source=$,xl(ue))throw ue;return ue}function v2(n){return xe(n).toLowerCase()}function w2(n){return xe(n).toUpperCase()}function b2(n,a,h){if(n=xe(n),n&&(h||a===t))return hh(n);if(!n||!(a=Ct(a)))return n;var g=ir(n),y=ir(a),b=fh(g,y),A=dh(g,y)+1;return ri(g,b,A).join("")}function x2(n,a,h){if(n=xe(n),n&&(h||a===t))return n.slice(0,mh(n)+1);if(!n||!(a=Ct(a)))return n;var g=ir(n),y=dh(g,ir(a))+1;return ri(g,0,y).join("")}function M2(n,a,h){if(n=xe(n),n&&(h||a===t))return n.replace(xa,"");if(!n||!(a=Ct(a)))return n;var g=ir(n),y=fh(g,ir(a));return ri(g,y).join("")}function S2(n,a){var h=N,g=k;if(Ue(a)){var y="separator"in a?a.separator:y;h="length"in a?ce(a.length):h,g="omission"in a?Ct(a.omission):g}n=xe(n);var b=n.length;if(Hi(n)){var A=ir(n);b=A.length}if(h>=b)return n;var C=h-en(g);if(C<1)return g;var D=A?ri(A,0,C).join(""):n.slice(0,C);if(y===t)return D+g;if(A&&(C+=D.length-C),Ml(y)){if(n.slice(C).search(y)){var R,W=D;for(y.global||(y=Na(y.source,xe(Fu.exec(y))+"g")),y.lastIndex=0;R=y.exec(W);)var $=R.index;D=D.slice(0,$===t?C:$)}}else if(n.indexOf(Ct(y),C)!=C){var K=D.lastIndexOf(y);K>-1&&(D=D.slice(0,K))}return D+g}function A2(n){return n=xe(n),n&&Iu.test(n)?n.replace(kt,eb):n}var P2=ln(function(n,a,h){return n+(h?" ":"")+a.toUpperCase()}),Pl=nf("toUpperCase");function rd(n,a,h){return n=xe(n),a=h?t:a,a===t?qw(n)?ib(n):Rw(n):n.match(a)||[]}var id=he(function(n,a){try{return Pt(n,t,a)}catch(h){return xl(h)?h:new ae(h)}}),L2=Cr(function(n,a){return Nt(a,function(h){h=_r(h),Pr(n,h,wl(n[h],n))}),n});function C2(n){var a=n==null?0:n.length,h=ie();return n=a?Fe(n,function(g){if(typeof g[1]!="function")throw new Rt(l);return[h(g[0]),g[1]]}):[],he(function(g){for(var y=-1;++y<a;){var b=n[y];if(Pt(b[0],this,g))return Pt(b[1],this,g)}})}function O2(n){return e1(Gt(n,p))}function Ll(n){return function(){return n}}function T2(n,a){return n==null||n!==n?a:n}var D2=of(),I2=of(!0);function bt(n){return n}function Cl(n){return Uh(typeof n=="function"?n:Gt(n,p))}function F2(n){return kh(Gt(n,p))}function B2(n,a){return zh(n,Gt(a,p))}var U2=he(function(n,a){return function(h){return Zn(h,n,a)}}),V2=he(function(n,a){return function(h){return Zn(n,h,a)}});function Ol(n,a,h){var g=Ye(a),y=to(a,g);h==null&&!(Ue(a)&&(y.length||!g.length))&&(h=a,a=n,n=this,y=to(a,Ye(a)));var b=!(Ue(h)&&"chain"in h)||!!h.chain,A=Tr(n);return Nt(y,function(C){var D=a[C];n[C]=D,A&&(n.prototype[C]=function(){var R=this.__chain__;if(b||R){var W=n(this.__wrapped__),$=W.__actions__=yt(this.__actions__);return $.push({func:D,args:arguments,thisArg:n}),W.__chain__=R,W}return D.apply(n,Qr([this.value()],arguments))})}),n}function k2(){return He._===this&&(He._=cb),this}function Tl(){}function z2(n){return n=ce(n),he(function(a){return Nh(a,n)})}var N2=al(Fe),R2=al(oh),W2=al(Ia);function nd(n){return pl(n)?Fa(_r(n)):_1(n)}function G2(n){return function(a){return n==null?t:Ci(n,a)}}var $2=lf(),j2=lf(!0);function Dl(){return[]}function Il(){return!1}function X2(){return{}}function Y2(){return""}function Z2(){return!0}function K2(n,a){if(n=ce(n),n<1||n>ve)return[];var h=Le,g=nt(n,Le);a=ie(a),n-=Le;for(var y=Va(g,a);++h<n;)a(h);return y}function q2(n){return le(n)?Fe(n,_r):Ot(n)?[n]:yt(Sf(xe(n)))}function Q2(n){var a=++ab;return xe(n)+a}var E2=ao(function(n,a){return n+a},0),J2=ll("ceil"),H2=ao(function(n,a){return n/a},1),eA=ll("floor");function tA(n){return n&&n.length?eo(n,bt,Za):t}function rA(n,a){return n&&n.length?eo(n,ie(a,2),Za):t}function iA(n){return ch(n,bt)}function nA(n,a){return ch(n,ie(a,2))}function sA(n){return n&&n.length?eo(n,bt,Ea):t}function oA(n,a){return n&&n.length?eo(n,ie(a,2),Ea):t}var aA=ao(function(n,a){return n*a},1),lA=ll("round"),cA=ao(function(n,a){return n-a},0);function uA(n){return n&&n.length?Ua(n,bt):0}function hA(n,a){return n&&n.length?Ua(n,ie(a,2)):0}return w.after=FM,w.ary=Uf,w.assign=wS,w.assignIn=qf,w.assignInWith=bo,w.assignWith=bS,w.at=xS,w.before=Vf,w.bind=wl,w.bindAll=L2,w.bindKey=kf,w.castArray=XM,w.chain=If,w.chunk=ex,w.compact=tx,w.concat=rx,w.cond=C2,w.conforms=O2,w.constant=Ll,w.countBy=uM,w.create=MS,w.curry=zf,w.curryRight=Nf,w.debounce=Rf,w.defaults=SS,w.defaultsDeep=AS,w.defer=BM,w.delay=UM,w.difference=ix,w.differenceBy=nx,w.differenceWith=sx,w.drop=ox,w.dropRight=ax,w.dropRightWhile=lx,w.dropWhile=cx,w.fill=ux,w.filter=fM,w.flatMap=mM,w.flatMapDeep=gM,w.flatMapDepth=_M,w.flatten=Cf,w.flattenDeep=hx,w.flattenDepth=fx,w.flip=VM,w.flow=D2,w.flowRight=I2,w.fromPairs=dx,w.functions=IS,w.functionsIn=FS,w.groupBy=yM,w.initial=mx,w.intersection=gx,w.intersectionBy=_x,w.intersectionWith=yx,w.invert=US,w.invertBy=VS,w.invokeMap=wM,w.iteratee=Cl,w.keyBy=bM,w.keys=Ye,w.keysIn=wt,w.map=mo,w.mapKeys=zS,w.mapValues=NS,w.matches=F2,w.matchesProperty=B2,w.memoize=_o,w.merge=RS,w.mergeWith=Qf,w.method=U2,w.methodOf=V2,w.mixin=Ol,w.negate=yo,w.nthArg=z2,w.omit=WS,w.omitBy=GS,w.once=kM,w.orderBy=xM,w.over=N2,w.overArgs=zM,w.overEvery=R2,w.overSome=W2,w.partial=bl,w.partialRight=Wf,w.partition=MM,w.pick=$S,w.pickBy=Ef,w.property=nd,w.propertyOf=G2,w.pull=xx,w.pullAll=Tf,w.pullAllBy=Mx,w.pullAllWith=Sx,w.pullAt=Ax,w.range=$2,w.rangeRight=j2,w.rearg=NM,w.reject=PM,w.remove=Px,w.rest=RM,w.reverse=yl,w.sampleSize=CM,w.set=XS,w.setWith=YS,w.shuffle=OM,w.slice=Lx,w.sortBy=IM,w.sortedUniq=Bx,w.sortedUniqBy=Ux,w.split=m2,w.spread=WM,w.tail=Vx,w.take=kx,w.takeRight=zx,w.takeRightWhile=Nx,w.takeWhile=Rx,w.tap=tM,w.throttle=GM,w.thru=po,w.toArray=Yf,w.toPairs=Jf,w.toPairsIn=Hf,w.toPath=q2,w.toPlainObject=Kf,w.transform=ZS,w.unary=$M,w.union=Wx,w.unionBy=Gx,w.unionWith=$x,w.uniq=jx,w.uniqBy=Xx,w.uniqWith=Yx,w.unset=KS,w.unzip=vl,w.unzipWith=Df,w.update=qS,w.updateWith=QS,w.values=hn,w.valuesIn=ES,w.without=Zx,w.words=rd,w.wrap=jM,w.xor=Kx,w.xorBy=qx,w.xorWith=Qx,w.zip=Ex,w.zipObject=Jx,w.zipObjectDeep=Hx,w.zipWith=eM,w.entries=Jf,w.entriesIn=Hf,w.extend=qf,w.extendWith=bo,Ol(w,w),w.add=E2,w.attempt=id,w.camelCase=t2,w.capitalize=ed,w.ceil=J2,w.clamp=JS,w.clone=YM,w.cloneDeep=KM,w.cloneDeepWith=qM,w.cloneWith=ZM,w.conformsTo=QM,w.deburr=td,w.defaultTo=T2,w.divide=H2,w.endsWith=r2,w.eq=sr,w.escape=i2,w.escapeRegExp=n2,w.every=hM,w.find=dM,w.findIndex=Pf,w.findKey=PS,w.findLast=pM,w.findLastIndex=Lf,w.findLastKey=LS,w.floor=eA,w.forEach=Ff,w.forEachRight=Bf,w.forIn=CS,w.forInRight=OS,w.forOwn=TS,w.forOwnRight=DS,w.get=Sl,w.gt=EM,w.gte=JM,w.has=BS,w.hasIn=Al,w.head=Of,w.identity=bt,w.includes=vM,w.indexOf=px,w.inRange=HS,w.invoke=kS,w.isArguments=Di,w.isArray=le,w.isArrayBuffer=HM,w.isArrayLike=vt,w.isArrayLikeObject=Ne,w.isBoolean=eS,w.isBuffer=ii,w.isDate=tS,w.isElement=rS,w.isEmpty=iS,w.isEqual=nS,w.isEqualWith=sS,w.isError=xl,w.isFinite=oS,w.isFunction=Tr,w.isInteger=Gf,w.isLength=vo,w.isMap=$f,w.isMatch=aS,w.isMatchWith=lS,w.isNaN=cS,w.isNative=uS,w.isNil=fS,w.isNull=hS,w.isNumber=jf,w.isObject=Ue,w.isObjectLike=ke,w.isPlainObject=Hn,w.isRegExp=Ml,w.isSafeInteger=dS,w.isSet=Xf,w.isString=wo,w.isSymbol=Ot,w.isTypedArray=un,w.isUndefined=pS,w.isWeakMap=mS,w.isWeakSet=gS,w.join=vx,w.kebabCase=s2,w.last=jt,w.lastIndexOf=wx,w.lowerCase=o2,w.lowerFirst=a2,w.lt=_S,w.lte=yS,w.max=tA,w.maxBy=rA,w.mean=iA,w.meanBy=nA,w.min=sA,w.minBy=oA,w.stubArray=Dl,w.stubFalse=Il,w.stubObject=X2,w.stubString=Y2,w.stubTrue=Z2,w.multiply=aA,w.nth=bx,w.noConflict=k2,w.noop=Tl,w.now=go,w.pad=l2,w.padEnd=c2,w.padStart=u2,w.parseInt=h2,w.random=e2,w.reduce=SM,w.reduceRight=AM,w.repeat=f2,w.replace=d2,w.result=jS,w.round=lA,w.runInContext=T,w.sample=LM,w.size=TM,w.snakeCase=p2,w.some=DM,w.sortedIndex=Cx,w.sortedIndexBy=Ox,w.sortedIndexOf=Tx,w.sortedLastIndex=Dx,w.sortedLastIndexBy=Ix,w.sortedLastIndexOf=Fx,w.startCase=g2,w.startsWith=_2,w.subtract=cA,w.sum=uA,w.sumBy=hA,w.template=y2,w.times=K2,w.toFinite=Dr,w.toInteger=ce,w.toLength=Zf,w.toLower=v2,w.toNumber=Xt,w.toSafeInteger=vS,w.toString=xe,w.toUpper=w2,w.trim=b2,w.trimEnd=x2,w.trimStart=M2,w.truncate=S2,w.unescape=A2,w.uniqueId=Q2,w.upperCase=P2,w.upperFirst=Pl,w.each=Ff,w.eachRight=Bf,w.first=Of,Ol(w,(function(){var n={};return mr(w,function(a,h){Me.call(w.prototype,h)||(n[h]=a)}),n})(),{chain:!1}),w.VERSION=r,Nt(["bind","bindKey","curry","curryRight","partial","partialRight"],function(n){w[n].placeholder=w}),Nt(["drop","take"],function(n,a){ge.prototype[n]=function(h){h=h===t?1:je(ce(h),0);var g=this.__filtered__&&!a?new ge(this):this.clone();return g.__filtered__?g.__takeCount__=nt(h,g.__takeCount__):g.__views__.push({size:nt(h,Le),type:n+(g.__dir__<0?"Right":"")}),g},ge.prototype[n+"Right"]=function(h){return this.reverse()[n](h).reverse()}}),Nt(["filter","map","takeWhile"],function(n,a){var h=a+1,g=h==q||h==H;ge.prototype[n]=function(y){var b=this.clone();return b.__iteratees__.push({iteratee:ie(y,3),type:h}),b.__filtered__=b.__filtered__||g,b}}),Nt(["head","last"],function(n,a){var h="take"+(a?"Right":"");ge.prototype[n]=function(){return this[h](1).value()[0]}}),Nt(["initial","tail"],function(n,a){var h="drop"+(a?"":"Right");ge.prototype[n]=function(){return this.__filtered__?new ge(this):this[h](1)}}),ge.prototype.compact=function(){return this.filter(bt)},ge.prototype.find=function(n){return this.filter(n).head()},ge.prototype.findLast=function(n){return this.reverse().find(n)},ge.prototype.invokeMap=he(function(n,a){return typeof n=="function"?new ge(this):this.map(function(h){return Zn(h,n,a)})}),ge.prototype.reject=function(n){return this.filter(yo(ie(n)))},ge.prototype.slice=function(n,a){n=ce(n);var h=this;return h.__filtered__&&(n>0||a<0)?new ge(h):(n<0?h=h.takeRight(-n):n&&(h=h.drop(n)),a!==t&&(a=ce(a),h=a<0?h.dropRight(-a):h.take(a-n)),h)},ge.prototype.takeRightWhile=function(n){return this.reverse().takeWhile(n).reverse()},ge.prototype.toArray=function(){return this.take(Le)},mr(ge.prototype,function(n,a){var h=/^(?:filter|find|map|reject)|While$/.test(a),g=/^(?:head|last)$/.test(a),y=w[g?"take"+(a=="last"?"Right":""):a],b=g||/^find/.test(a);y&&(w.prototype[a]=function(){var A=this.__wrapped__,C=g?[1]:arguments,D=A instanceof ge,R=C[0],W=D||le(A),$=function(pe){var _e=y.apply(w,Qr([pe],C));return g&&K?_e[0]:_e};W&&h&&typeof R=="function"&&R.length!=1&&(D=W=!1);var K=this.__chain__,ee=!!this.__actions__.length,ne=b&&!K,ue=D&&!ee;if(!b&&W){A=ue?A:new ge(this);var se=n.apply(A,C);return se.__actions__.push({func:po,args:[$],thisArg:t}),new Wt(se,K)}return ne&&ue?n.apply(this,C):(se=this.thru($),ne?g?se.value()[0]:se.value():se)})}),Nt(["pop","push","shift","sort","splice","unshift"],function(n){var a=Ns[n],h=/^(?:push|sort|unshift)$/.test(n)?"tap":"thru",g=/^(?:pop|shift)$/.test(n);w.prototype[n]=function(){var y=arguments;if(g&&!this.__chain__){var b=this.value();return a.apply(le(b)?b:[],y)}return this[h](function(A){return a.apply(le(A)?A:[],y)})}}),mr(ge.prototype,function(n,a){var h=w[a];if(h){var g=h.name+"";Me.call(sn,g)||(sn[g]=[]),sn[g].push({name:a,func:h})}}),sn[oo(t,O).name]=[{name:"wrapper",func:t}],ge.prototype.clone=Ab,ge.prototype.reverse=Pb,ge.prototype.value=Lb,w.prototype.at=rM,w.prototype.chain=iM,w.prototype.commit=nM,w.prototype.next=sM,w.prototype.plant=aM,w.prototype.reverse=lM,w.prototype.toJSON=w.prototype.valueOf=w.prototype.value=cM,w.prototype.first=w.prototype.head,Rn&&(w.prototype[Rn]=oM),w}),tn=nb();Mi?((Mi.exports=tn)._=tn,Ca._=tn):He._=tn}).call(p_)})(An,An.exports)),An.exports}var g_=m_(),__=Object.defineProperty,y_=(s,e,t)=>e in s?__(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,v_=(s,e,t)=>y_(s,e+"",t);let Zt=class extends Je{constructor(e){super(e),v_(this,"_baseType","Point"),this._renderObject=this._createRenderObject(),this._paint&&this._paint.applyTo(this._renderObject)}_coordsTransform(){const e=this.getMap(),t=new f.Vector3(this._geometry.coordinates[0],this._geometry.coordinates[1],this._geometry.coordinates[2]||0);return e?e.lngLatToWorld(t):t}async _buildRenderObject(){this.map}_refreshCoordinates(){const e=this._coordsTransform();if(this._worldCoordinates=e,this._renderObject){const t=this.getMap();t?.prjcenter?this._renderObject.position.copy(e).sub(t.prjcenter):this._renderObject.position.copy(e),this.children.includes(this._renderObject)||this.add(this._renderObject),this.updateMatrixWorld(!0)}else this._buildRenderObject()}_createRenderObject(){return new f.Points(new f.BufferGeometry,new f.PointsMaterial({size:1,color:8947848}))}};var w_=Object.defineProperty,b_=(s,e,t)=>e in s?w_(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,x_=(s,e,t)=>b_(s,e+"",t);const M_={};class wr extends Zt{constructor(e){super(e),x_(this,"_type","Marker")}async _buildRenderObject(){this._worldCoordinates=this._coordsTransform(),this._paint&&(this._renderObject&&this._disposeGeometry(),this._renderObject=await this._createObject(this._paint),this._refreshCoordinates())}_refreshCoordinates(){this._worldCoordinates=this._coordsTransform(),this._renderObject?(this._renderObject.position.copy(this._worldCoordinates),this.children.includes(this._renderObject)||this.add(this._renderObject),this.updateMatrixWorld(!0),this._renderObject.updateMatrixWorld(!0)):this._buildRenderObject()}async _createObject(e){switch(e.config.type){case"circle":return Cc(e.config,new f.Vector3(0,0,0));case"icon":return eg(e.config,this._worldCoordinates);case"symbol":return cg(e.config,this._worldCoordinates);default:throw new Error(`不支持的样式类型: ${e.config.type}`)}}_calculateCollisionBoundingBox(e,t){if(!this.visible||!this._renderObject||!e||!t)return null;try{return this._paint?.config.type==="icon"?this._calculateSpriteBoundingBox(this._renderObject):this._getFallbackBoundingBox()}catch(r){return console.warn(`Marker ${this._id} bounding box calculation failed:`,r),console.warn(`Marker ${this._id} 包围盒计算失败:`,r),this._getFallbackBoundingBox()}}_calculateSpriteBoundingBox(e){try{const r=Math.max(Math.abs(e.scale.x),Math.abs(e.scale.y))/.002;return{width:r,height:r,offsetX:-r/2,offsetY:-r/2}}catch{return{width:20,height:20,offsetX:-10,offsetY:-10}}}_getFallbackBoundingBox(){switch(this.getPaint()?.config.type){case"icon":case"symbol":return{width:20,height:20,offsetX:-10,offsetY:-10};case"circle":return{width:10,height:10,offsetX:-5,offsetY:-5};default:return{width:15,height:15,offsetX:-7.5,offsetY:-7.5}}}}wr.mergeOptions(M_);var S_=Object.defineProperty,A_=(s,e,t)=>e in s?S_(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,jc=(s,e,t)=>A_(s,typeof e!="symbol"?e+"":e,t);class Xc extends Je{constructor(e){super(e),jc(this,"_baseType","Line"),jc(this,"_vertexPoints"),this._renderObject=this._createRenderObject(),this._vertexPoints=[0,0,0],this._paint&&this._paint.applyTo(this._renderObject)}_coordsTransform(){const e=this.getMap(),t=this._geometry,r=e?.prjcenter;if(this._geometry.type==="LineString"){let o=t.coordinates.map(c=>{const u=new f.Vector3(c[0],c[1],c[2]||0);return(e?e.lngLatToWorld(u):u).sub(r)}),l=o.flatMap(c=>[c.x,c.y,c.z]);return{_worldLngLatLikes:o,_vertexPoints:l}}}_buildRenderObject(){}_createRenderObject(){const e=new as,t=new vn({color:8947848,linewidth:.1,dashed:!1,resolution:new f.Vector2(window.innerWidth,window.innerHeight)});return new us(e,t)}}var P_=Object.defineProperty,L_=(s,e,t)=>e in s?P_(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,C_=(s,e,t)=>L_(s,e+"",t);const O_={};class pt extends Xc{constructor(e){super(e),C_(this,"_type","LineString")}async _buildRenderObject(){let{_vertexPoints:e}=this._coordsTransform();this._vertexPoints=e,this._paint&&(this._renderObject&&this._disposeGeometry(),this._renderObject=await this._createObject(this._paint),this._refreshCoordinates())}_refreshCoordinates(){let{_vertexPoints:e}=this._coordsTransform();if(this._vertexPoints=e,this._renderObject&&(this._renderObject.isLine2||this._renderObject instanceof us)){const i=this._renderObject.geometry;i.setPositions(this._vertexPoints),i.computeBoundingSphere(),i.computeBoundingBox();const o=this.getMap();o?.prjcenter&&this._renderObject.position.set(o.prjcenter.x,o.prjcenter.y,o.prjcenter.z),this.children.includes(this._renderObject)||this.add(this._renderObject),this.updateMatrixWorld(!0),this._renderObject.updateMatrixWorld(!0)}else console.warn("[LineString] _updateGeometryPositions: Geometry type mismatch, fallback to full rebuild",{hasGeometry:!!this._renderObject,geometryType:this._renderObject?.constructor?.name,isLine2:this._renderObject?.isLine2}),this._buildRenderObject()}async _createObject(e){switch(e.config.type){case"line":return ra(e.config,this._vertexPoints);case"flow-tube":return Oc(e.config,this._vertexPoints);case"arrow":return Tc(e.config,this._vertexPoints);case"flow-texture":return await Dc(e.config,this._vertexPoints);default:throw new Error(`Unsupported style type: ${e.config.type}`)}}}pt.mergeOptions(O_);var T_=Object.defineProperty,D_=(s,e,t)=>e in s?T_(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Yc=(s,e,t)=>D_(s,typeof e!="symbol"?e+"":e,t);class I_ extends Je{constructor(e){super(e),Yc(this,"_baseType","Surface"),Yc(this,"_vertexPoints"),this._buildRenderObject(),this._vertexPoints=[0,0,0],this._paint&&this._renderObject&&this._paint.applyTo(this._renderObject)}_buildRenderObject(){if(this._renderObject||!this._geometry)return;const{_vertexPoints:t}=this._coordsTransform();this._vertexPoints=t,this._renderObject=this._createRenderObject()}_coordsTransform(){const e=this.getMap(),t=e?.prjcenter,r=this._geometry;if(!r)throw new Error("Geometry data undefined");if(r.type==="Polygon"){const i=r.coordinates;let o=[],l=[];return i.forEach(c=>{const u=c.map(d=>{const m=new f.Vector3(d[0],d[1],d[2]||0),p=e?e.lngLatToWorld(m):m;return t?p.sub(t):p});o.push(u),l.push(...u.flatMap(d=>[d.x,d.y,d.z]))}),{_worldLngLatLikes:o,_vertexPoints:l}}else if(r.type==="MultiPolygon"){const i=r.coordinates;let o=[],l=[];return i.forEach(c=>{const u=[];c.forEach(d=>{const m=d.map(p=>{const _=new f.Vector3(p[0],p[1],p[2]||0),v=e?e.lngLatToWorld(_):_;return t?v.sub(t):v});u.push(m),l.push(...m.flatMap(p=>[p.x,p.y,p.z]))}),o.push(u)}),{_worldLngLatLikes:o,_vertexPoints:l}}else throw new Error(`Unsupported geometry type: ${r.type}`)}_refreshLngLatLikes(){const e=this._paint?.config.type;if(this.clear(),!this._renderObject||!this._vertexPoints?.length){console.warn("Cannot update geometry: missing geometry or vertex data");return}const t=this.getMap();try{e==="basic-polygon"?(this._renderObject.renderOrder=90,this._renderObject.position.add(t?.prjcenter),this._renderObject.updateMatrix(),this.add(this._renderObject)):(e==="extrude-polygon"||e?.includes("water"))&&(this._renderObject.renderOrder=90,this._renderObject.position.add(t?.prjcenter),this._renderObject.updateMatrix(),this.add(this._renderObject))}catch(r){throw console.error("Failed to update polygon position:",r),r}}_createRenderObject(){const e=new as,t=new vn({color:8947848,linewidth:.1,dashed:!1,resolution:new f.Vector2(window.innerWidth,window.innerHeight)});return new us(e,t)}}var F_=Object.defineProperty,B_=(s,e,t)=>e in s?F_(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,U_=(s,e,t)=>B_(s,e+"",t);const V_={};class fr extends I_{constructor(e){super(e),U_(this,"_type","Polygon")}async _buildRenderObject(){let{_vertexPoints:e}=this._coordsTransform();if(this._vertexPoints=e,this._paint){this._renderObject&&this.remove(this._renderObject),this._renderObject=await this._createObject(this._paint);const t=this.getMap();t&&this._renderObject&&(this._renderObject.position.add(t.prjcenter),this._renderObject.updateMatrix(),this.add(this._renderObject)),await this._paint.applyTo(this._renderObject)}}_refreshCoordinates(){if(this._renderObject){let{_vertexPoints:e}=this._coordsTransform();this._vertexPoints=e;const t=this.getMap();this.clear(),t&&t.prjcenter&&(this._renderObject.position.set(0,0,0),this._renderObject.position.add(t.prjcenter),this._renderObject.updateMatrix()),this.add(this._renderObject),this.updateMatrixWorld(!0),this._renderObject.updateMatrixWorld(!0);return}console.warn("[Polygon] _refreshCoordinates: No render object, calling full rebuild"),this._buildRenderObject()}async _createObject(e){switch(e.config.type){case"fill":return rg(e.config,this._vertexPoints);case"extrusion":return ig(e.config,this._vertexPoints);case"water":return ng(e.config,this.getMap(),this._vertexPoints);case"water-simple":return sg(e.config,this._vertexPoints);default:throw new Error(`Unsupported style type: ${e.config.type}`)}}_calculateCollisionBoundingBox(){return null}}fr.mergeOptions(V_);var k_=Object.defineProperty,z_=(s,e,t)=>e in s?k_(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,oa=(s,e,t)=>z_(s,typeof e!="symbol"?e+"":e,t);const N_={};class Zc extends Xc{constructor(e){super(e),oa(this,"_type","MultiLineString"),oa(this,"_lineObjects",[]),oa(this,"_linesContainer"),this._linesContainer=new f.Group}async _buildRenderObject(){const{_worldCoordinates:e}=this._coordsTransform(),t=this.getMap();if(this.clearLines(),this._disposeGeometry(),this._paint){for(const r of e){const i=r.flatMap(l=>[l.x,l.y,l.z]),o=await this._createLineObject(this._paint,i);o.position.add(t?.prjcenter),o.updateMatrixWorld(!0),o.renderOrder=99,this._lineObjects.push(o),this._linesContainer.add(o)}this._linesContainer.renderOrder=99,this._renderObject=this._linesContainer,this.add(this._renderObject),this._updateContainer(),this.updateMatrixWorld(!0),this._renderObject.updateMatrixWorld(!0),this._tryProcessQueue()}}async _createLineObject(e,t){switch(e.config.type){case"line":return ra(e.config,t);case"flow-tube":return Oc(e.config,t);case"arrow":return Tc(e.config,t);case"flow-texture":return await Dc(e.config,t);default:throw new Error(`Unsupported style type: ${e.config.type}`)}}_coordsTransform(){const e=this.getMap(),t=this._geometry;if(this._geometry.type==="MultiLineString"){const r=e?.prjcenter;return{_worldCoordinates:t.coordinates.map(o=>o.map(l=>{const c=new f.Vector3(l[0],l[1],l[2]||0);return(e?e.lngLatToWorld(c):c).sub(r)}))}}}_updateContainer(){this._linesContainer.updateMatrixWorld(!0)}clearLines(){this._lineObjects.forEach(e=>{this._linesContainer.remove(e),e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(t=>t.dispose()):e.material.dispose())}),this._lineObjects=[]}_refreshCoordinates(){this._buildRenderObject()}_disposeObject(){}}Zc.mergeOptions(N_);var R_=Object.defineProperty,W_=(s,e,t)=>e in s?R_(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Pn=(s,e,t)=>W_(s,typeof e!="symbol"?e+"":e,t);const aa=64;class G_ extends tt.MeshStandardMaterial{constructor(e={}){const{shaderOption:t,regionOverlay:r,...i}=e;if(super({color:"rgb(58,126,182)",roughness:.7,metalness:.1,transparent:!0,opacity:.9,envMapIntensity:.8,depthWrite:!0,depthTest:!0,...i}),Pn(this,"shaderOption"),Pn(this,"clock"),Pn(this,"time"),Pn(this,"startTime"),Pn(this,"regionOverlay"),r&&r.vertices&&r.vertices.length>0){const o=r.vertices.slice(0,aa).map(c=>c.clone()),l=o.length;for(;o.length<aa;)o.push(new tt.Vector2(0,0));this.regionOverlay={color:r.color,opacity:r.opacity,vertices:o,vertexCount:l}}this.shaderOption={minY:0,maxY:100,minRate:.3,maxRate:1.5,effects:{diffusion:{enabled:!1,color:new tt.Color("#9ECDEC"),width:20,speed:1,maxDistance:100,center:void 0},flow:{enabled:!1,color:new tt.Color("#00E4FF"),range:10,speed:20},sweep:{enabled:!1,color:new tt.Color("#FFFFFF"),width:1.5,speed:10}},...t},this.clock=new tt.Clock,this.time={value:0},this.startTime={value:0},this.animate()}onBeforeCompile(e){const{minY:t,maxY:r,minRate:i,maxRate:o,effects:l}=this.shaderOption,c=r-t,u=!!this.regionOverlay;e.uniforms={...e.uniforms,time:this.time,uStartTime:this.startTime,uMinY:{value:t},uMaxY:{value:r},uHeightRange:{value:c},uMinRate:{value:i},uMaxRate:{value:o},uDiffusionEnabled:{value:l?.diffusion?.enabled?1:0},uDiffusionColor:{value:l?.diffusion?.color||new tt.Color("#9ECDEC")},uDiffusionWidth:{value:l?.diffusion?.width||20},uDiffusionSpeed:{value:l?.diffusion?.speed||1},uDiffusionMaxDistance:{value:l?.diffusion?.maxDistance||100},uDiffusionCenter:{value:l?.diffusion?.center||new tt.Vector3(0,0,0)},uFlowEnabled:{value:l?.flow?.enabled?1:0},uFlowColor:{value:l?.flow?.color||new tt.Color("#00E4FF")},uFlowRange:{value:l?.flow?.range||10},uFlowSpeed:{value:l?.flow?.speed||20},uSweepEnabled:{value:l?.sweep?.enabled?1:0},uSweepColor:{value:l?.sweep?.color||new tt.Color("#FFFFFF")},uSweepWidth:{value:l?.sweep?.width||1.5},uSweepSpeed:{value:l?.sweep?.speed||10},uRegionOverlayEnabled:{value:u?1:0},uRegionOverlayColor:{value:this.regionOverlay?.color||new tt.Color("#00FF88")},uRegionOverlayOpacity:{value:this.regionOverlay?.opacity??0},uRegionOverlayVertexCount:{value:this.regionOverlay?.vertexCount??0},uRegionOverlayVertices:{value:this.regionOverlay?.vertices||new Array(aa).fill(0).map(()=>new tt.Vector2(0,0))}},e.vertexShader=`
      varying vec3 vWorldPosition;
      varying vec3 vPosition;
      varying float vHeight;
      ${e.vertexShader}
    `.replace("#include <begin_vertex>",`
      #include <begin_vertex>
      vWorldPosition = (modelMatrix * vec4(position, 1.0)).xyz;
      vPosition = position;
      vHeight = position.y;
      `),e.fragmentShader=`
      #define PI 3.141592653589793
      #define REGION_OVERLAY_MAX_VERTS 64
      varying vec3 vWorldPosition;
      varying vec3 vPosition;
      varying float vHeight;
      uniform float uMinY;
      uniform float uMaxY;
      uniform float uHeightRange;
      uniform float uMinRate;
      uniform float uMaxRate;
      uniform float time;
      uniform float uStartTime;
      uniform int uDiffusionEnabled;
      uniform vec3 uDiffusionColor;
      uniform float uDiffusionWidth;
      uniform float uDiffusionSpeed;
      uniform float uDiffusionMaxDistance;
      uniform vec3 uDiffusionCenter;
      uniform int uFlowEnabled;
      uniform vec3 uFlowColor;
      uniform float uFlowRange;
      uniform float uFlowSpeed;
      uniform int uSweepEnabled;
      uniform vec3 uSweepColor;
      uniform float uSweepWidth;
      uniform float uSweepSpeed;

       // 区域多边形外衣相关 uniform 声明（之前缺少）
      uniform int uRegionOverlayEnabled;
      uniform vec3 uRegionOverlayColor;
      uniform float uRegionOverlayOpacity;
      uniform int uRegionOverlayVertexCount;
      uniform vec2 uRegionOverlayVertices[REGION_OVERLAY_MAX_VERTS];
      
      
      float distanceTo(vec2 src, vec2 dst) {
        return distance(src, dst);
      }
      
      ${e.fragmentShader}
    `.replace("#include <color_fragment>",`
      #include <color_fragment>
      
      // 高度渐变计算
      float normalizedHeight = clamp((vWorldPosition.y - uMinY) / uHeightRange, 0.0, 1.0);
      float heightFactor = smoothstep(0.0, 1.0, normalizedHeight);
      diffuseColor.rgb *= mix(uMinRate, uMaxRate, heightFactor);
      
      // 圆环扩散效果
      if (uDiffusionEnabled == 1) {
        vec2 position2D = vec2(vWorldPosition.x, vWorldPosition.z);
        vec2 center2D = vec2(uDiffusionCenter.x, uDiffusionCenter.z);
        float distToCenter = distance(position2D, center2D);
        
        float progress = mod(time * uDiffusionSpeed, 1.0);
        float currentRadius = progress * uDiffusionMaxDistance;
        
        if (distToCenter > currentRadius - uDiffusionWidth && 
            distToCenter < currentRadius) {
            float ringFactor = smoothstep(
                currentRadius - uDiffusionWidth,
                currentRadius,
                distToCenter
            );
            
            vec3 highBrightnessColor = uDiffusionColor * 5.0;
            diffuseColor.rgb += highBrightnessColor * (1.0 - ringFactor);
            diffuseColor.rgb = min(diffuseColor.rgb, vec3(2.0));
        }
      }
      
      // 流光效果
      if (uFlowEnabled == 1) {
        float dTime = mod(time * uFlowSpeed, uFlowRange * 2.0);
        if (vPosition.z > dTime - uFlowRange && vPosition.z < dTime) {
          float dIndex = sin((dTime - vPosition.z) / uFlowRange * PI);
          diffuseColor.rgb = mix(uFlowColor, diffuseColor.rgb, 1.0 - dIndex);
        }
      }
      
      // 扫光效果
      if (uSweepEnabled == 1) {
        float sweepPos = mod(time * uSweepSpeed, 2.0);
        if (vHeight > sweepPos - uSweepWidth && vHeight < sweepPos) {
          float sweepFactor = smoothstep(sweepPos - uSweepWidth, sweepPos, vHeight);
          diffuseColor.rgb = mix(uSweepColor, diffuseColor.rgb, 1.0 - sweepFactor);
        }
      }
    // 区域多边形外衣叠色（Ray casting 判定点是否在多边形内）
      if (uRegionOverlayEnabled == 1 && uRegionOverlayOpacity > 0.0 && uRegionOverlayVertexCount >= 3) {
        vec2 p = vec2(vWorldPosition.x, vWorldPosition.z);
        bool inside = false;
        int j = 0;
        for (int i = 0; i < REGION_OVERLAY_MAX_VERTS; i++) {
          if (i >= uRegionOverlayVertexCount) break;
          if (i == 0) {
            j = uRegionOverlayVertexCount - 1;
          }
          vec2 pi = uRegionOverlayVertices[i];
          vec2 pj = uRegionOverlayVertices[j];

          bool intersect = ((pi.y > p.y) != (pj.y > p.y)) &&
            (p.x < (pj.x - pi.x) * (p.y - pi.y) / (pj.y - pi.y + 1e-6) + pi.x);
          if (intersect) {
            inside = !inside;
          }
          j = i;
        }

        if (inside) {
          diffuseColor.rgb = mix(
            diffuseColor.rgb,
            uRegionOverlayColor,
            clamp(uRegionOverlayOpacity, 0.0, 1.0)
          );
        }
      }
      `)}setDiffusionFromObject(e){if(!this.shaderOption.effects?.diffusion)return;const t=new tt.Box3().setFromObject(e);if(t.isEmpty())return;const r=new tt.Vector3;t.getCenter(r);const i=[new tt.Vector3(t.min.x,t.min.y,t.min.z),new tt.Vector3(t.max.x,t.max.y,t.max.z)];let o=0;i.forEach(l=>{const c=r.distanceTo(l);c>o&&(o=c)}),this.shaderOption.effects.diffusion={...this.shaderOption.effects.diffusion,center:r,maxDistance:o},this.needsUpdate=!0}updateBoundingBox(e,t){this.shaderOption.minY=e,this.shaderOption.maxY=t,this.needsUpdate=!0}updateEffects(e){this.shaderOption.effects={...this.shaderOption.effects,...e},this.needsUpdate=!0}animate(){requestAnimationFrame(()=>this.animate()),this.time.value=this.clock.getElapsedTime(),this.startTime.value<1&&(this.startTime.value+=.01)}}var $_=Object.defineProperty,j_=(s,e,t)=>e in s?$_(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Kt=(s,e,t)=>j_(s,typeof e!="symbol"?e+"":e,t);const X_={emissive:!1,emissiveIntensity:1,emissiveColor:"#ffffff"};class Kc extends Zt{constructor(e){super(e),Kt(this,"_type","Model"),Kt(this,"_emissive",!1),Kt(this,"_emissiveIntensity",1),Kt(this,"_emissiveColor","#ffffff"),Kt(this,"_mixer",null),Kt(this,"_currentAction",null),Kt(this,"_animations",[]),Kt(this,"_clock",new f.Clock),Kt(this,"_autoUpdate",!0),Kt(this,"_animationRequestId",null),Kt(this,"_iscity",!1),this._emissive=e.emissive||!1,this._emissiveIntensity=e.emissiveIntensity||1,this._emissiveColor=e.emissiveColor||"#ffffff",this.castShadow=e.castShadow||!1,this.receiveShadow=e.receiveShadow||!1,this._iscity=e.iscity||!1}async _buildRenderObject(){if(this._worldCoordinates=this._coordsTransform(),this._paint){if(this._renderObject&&this._disposeGeometry(),this.modelunino=await this._createObject(this._paint),this._renderObject=this.modelunino.model,!this._renderObject){console.error("Model load failed: model returned by _createObject is undefined"),console.error("模型加载失败：_createObject返回的model为undefined");return}this._renderObject.userData._type="Model",this.modelunino.animations&&this.modelunino.animations.length>0&&(this._animations=this.modelunino.animations,this._mixer=new f.AnimationMixer(this._renderObject),this._startAnimationLoop(),this.playAnimation({name:this._animations[0].name,loop:!0,speed:1.5,fadeInDuration:.5,fadeOutDuration:.3})),this._refreshCoordinates(),this.setShadows({cast:this.castShadow,receive:this.receiveShadow}),this._applyEmissionProperties(),this._iscity&&this._rendercity()}}async _createObject(e){switch(e.config.type){case"model-fbx":case"model-gltf":return tg(e.config,this._worldCoordinates);default:throw new Error(`Unsupported style type: ${e.config.type}`)}}_applyEmissionProperties(){this._renderObject&&this._renderObject.traverse(e=>{if("material"in e){const t=e.material;t&&(t.emissiveIntensity=this._emissive?this._emissiveIntensity:0,t.emissive&&t.emissive.setStyle(this._emissiveColor))}})}get emissive(){return this._emissive}set emissive(e){this._emissive=e,this._applyEmissionProperties()}get emissiveIntensity(){return this._emissiveIntensity}set emissiveIntensity(e){this._emissiveIntensity=e,this._applyEmissionProperties()}get emissiveColor(){return this._emissiveColor}set emissiveColor(e){this._emissiveColor=e,this._applyEmissionProperties()}setEmission(e,t,r){this._emissive=e,t!==void 0&&(this._emissiveIntensity=t),r!==void 0&&(this._emissiveColor=r),this._applyEmissionProperties()}async setShadows(e){this.castShadow=e.cast,this.receiveShadow=e.receive,this._renderObject&&this._renderObject.traverse(t=>{t.isMesh&&t.material&&(t.castShadow=e.cast,t.receiveShadow=e.receive)})}setBloom(e,t){return this.userData.bloom=e,this._renderObject&&this._renderObject.traverse(r=>{r instanceof f.Mesh&&(r.userData.originalMaterial||(r.userData.originalMaterial=r.material),e?Array.isArray(r.material)?r.material.forEach(i=>{"emissive"in i&&(i.emissive.setHex(16777215),i.emissiveIntensity=.5)}):"emissive"in r.material&&(r.material.emissive.setHex(16777215),r.material.emissiveIntensity=.5):Array.isArray(r.material)?r.material.forEach(i=>{"emissive"in i&&(i.emissive.setHex(0),i.emissiveIntensity=0)}):"emissive"in r.material&&(r.material.emissive.setHex(0),r.material.emissiveIntensity=0))}),this}playAnimation(e){if(!this._mixer||this._animations.length===0){console.warn("No available animations for model"),console.warn("模型没有可用的动画");return}this._currentAction&&(e.fadeOutDuration&&e.fadeOutDuration>0?this._currentAction.fadeOut(e.fadeOutDuration):this._currentAction.stop());const t=typeof e.name=="number"?this._animations[e.name]:this._animations.find(r=>r.name===e.name);if(!t){console.warn(`Animation not found: ${e.name}`),console.warn(`找不到动画: ${e.name}`);return}this._currentAction=this._mixer.clipAction(t),this._currentAction.setLoop(e.loop?f.LoopRepeat:f.LoopOnce,e.loop?1/0:1),this._currentAction.timeScale=e.speed||1,this._currentAction.time=e.startAt||0,this._currentAction.setEffectiveWeight(e.weight||1),e.fadeInDuration&&e.fadeInDuration>0&&this._currentAction.fadeIn(e.fadeInDuration),this._currentAction.play(),this._autoUpdate&&this._animationRequestId===null&&this._startAnimationLoop()}stopAnimation(e={}){this._currentAction&&(e.fadeDuration&&e.fadeDuration>0?(this._currentAction.fadeOut(e.fadeDuration),setTimeout(()=>{this._currentAction&&(this._currentAction.stop(),this._currentAction=null)},e.fadeDuration*1e3)):(this._currentAction.stop(),this._currentAction=null))}setAnimationPaused(e){this._currentAction&&(this._currentAction.paused=e.paused)}setAnimationSpeed(e){this._currentAction&&(this._currentAction.timeScale=e.speed)}updateAnimation(e){this._mixer&&this._mixer.update(e.deltaTime)}getAnimationNames(){return this._animations.map(e=>e.name)}getCurrentAnimationName(){return this._currentAction?this._currentAction.getClip().name:null}getAnimationDuration(e){let t;return typeof e.name=="number"?t=this._animations[e.name]:t=this._animations.find(r=>r.name===e.name),t?t.duration:null}dispose(){this._stopAnimationLoop(),this._mixer&&(this._mixer.stopAllAction(),this._mixer.uncacheRoot(this._renderObject)),super.dispose()}_startAnimationLoop(){if(!this._autoUpdate||this._animationRequestId!==null)return;const e=()=>{if(this._mixer){const t=this._clock.getDelta();this._mixer.update(t)}this._animationRequestId=requestAnimationFrame(e)};this._clock.start(),this._animationRequestId=requestAnimationFrame(e)}_stopAnimationLoop(){this._animationRequestId!==null&&(cancelAnimationFrame(this._animationRequestId),this._animationRequestId=null),this._clock.stop()}setAutoUpdate(e){this._autoUpdate=e,e?this._startAnimationLoop():this._stopAnimationLoop()}_computeOverlayVertices(e){const t=e.feature;if(t&&Array.isArray(t._vertexPoints)&&t._vertexPoints.length>=6){const u=t.getMap?.()||this.getMap();if(u&&u.prjcenter){const d=u.prjcenter,m=t._vertexPoints,p=[];for(let _=0;_+2<m.length;_+=3){const v=m[_],M=m[_+2],S=d.x+v,x=d.z+M;p.push(new f.Vector2(S,x))}if(p.length>=3)return p}}const r=this.getMap();if(!r||!e.geometry)return null;const i=e.geometry;let o;if(i.type==="Polygon")o=i.coordinates;else if(i.type==="MultiPolygon"){if(!i.coordinates.length)return null;o=i.coordinates[0]}else return null;if(!o.length||!o[0].length)return null;const l=o[0],c=[];for(const u of l){const d=u[0],m=u[1],p=r.lngLatToWorld(new f.Vector3(d,m,0));c.push(new f.Vector2(p.x,p.z))}return c.length<3?null:c}_rendercity(){const e=this.getLayer();let t=null;if(e&&e.getRegionOverlays){const r=e.getRegionOverlays()||[];if(r.length){const i=r.filter(l=>(l.mode??"overlay")==="overlay").sort((l,c)=>(l.zIndex??0)-(c.zIndex??0)),o=i[i.length-1];if(o&&(o.geometry||o.feature)){const l=this._computeOverlayVertices(o);l&&l.length>=3&&(t={color:new f.Color(o.color??"#00FF88"),opacity:o.opacity??.3,vertices:l})}}}this.traverse(async r=>{if(r instanceof f.Mesh&&r.material){if(r.castShadow=!0,r.name==="building"){const i=new G_({color:new f.Color("#6BA7EC").multiplyScalar(1.8),opacity:.9,shaderOption:{minY:0,maxY:50,minRate:.3,maxRate:1.5,effects:{diffusion:{enabled:!0,color:new f.Color("#FFFFF"),width:300,speed:.05},flow:{enabled:!1,color:new f.Color("#FFFFF"),range:1e3,speed:3e3},sweep:{enabled:!0,color:new f.Color("#ffffff"),width:3,speed:5}}},regionOverlay:t||void 0}),o=new f.Box3().setFromObject(r);i.updateBoundingBox(o.min.y,o.max.y),i.setDiffusionFromObject(r),r.receiveShadow=!1,r.material=i,r.material.needsUpdate=!0}r.name==="grass"&&(r.castShadow=!1,r.receiveShadow=!0,r.material.color=new f.Color("#81e4d8ff)").multiplyScalar(.7),r.material.metalness=.2,r.material.roughness=.8,["metalnessMap","normalMap","roughnessMap","specularColorMap"].forEach(i=>{const o=r.material[i];o&&(o.wrapS=o.wrapT=f.RepeatWrapping,o.repeat.set(.3,.3),o.needsUpdate=!0)}),r.material.normalScale=new f.Vector2(3,3))}})}}Kc.mergeOptions(X_);var Y_=Object.defineProperty,Z_=(s,e,t)=>e in s?Y_(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,K_=(s,e,t)=>Z_(s,e+"",t);const q_={};class qc extends Zt{constructor(e){super(e),K_(this,"_type","Cloud")}async _buildRenderObject(){this._worldCoordinates=this._coordsTransform(),this._paint&&(this._renderObject&&this._disposeGeometry(),this._renderObject=await this._createObject(this._paint),this._refreshCoordinates())}_refreshCoordinates(){this._disposeGeometry();const e=this.getLayer();this._renderObject&&(this._renderObject.position.copy(this._worldCoordinates),this._renderObject.renderOrder=99,e&&(e._clouds.add(this._renderObject),e._clouds.updateMatrixWorld()))}async _createObject(e){if(e.config.type==="cloud")return og(e.config,this._worldCoordinates);throw new Error(`Unsupported style type: ${e.config.type}`)}}qc.mergeOptions(q_);var Q_=Object.defineProperty,E_=(s,e,t)=>e in s?Q_(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,J_=(s,e,t)=>E_(s,e+"",t);const H_={};class Qc extends Zt{constructor(e){super(e),J_(this,"_type","Label")}async _buildRenderObject(){this._worldCoordinates=this._coordsTransform(),this._paint&&(this._renderObject&&this._disposeGeometry(),this._renderObject=await this._createObject(this._paint),this._refreshCoordinates())}_refreshCoordinates(){this._worldCoordinates=this._coordsTransform(),this._renderObject?(this._renderObject.position.copy(this._worldCoordinates),this.children.includes(this._renderObject)||this.add(this._renderObject),this.updateMatrixWorld(!0),this._renderObject.updateMatrixWorld(!0)):this._buildRenderObject()}async _createObject(e){switch(e.config.type){case"text-fixed":return lg(e.config,new f.Vector3(0,0,0),this.getMap());case"text":return ag(e.config,new f.Vector3(0,0,0));default:throw new Error(`Unsupported style type: ${e.config.type}`)}}}Qc.mergeOptions(H_);var e0=Object.defineProperty,t0=(s,e,t)=>e in s?e0(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ec=(s,e,t)=>t0(s,typeof e!="symbol"?e+"":e,t);const r0={};class Jc extends Zt{constructor(e){super(e),Ec(this,"_type","TPoints"),Ec(this,"_geometries"),this._geometries=e.geometries}async _buildRenderObject(){this._worldCoordinates=this._coordsTransform(),this._paint&&(this._renderObject&&this._disposeGeometry(),this._renderObject=await this._createObject(this._paint),this._refreshCoordinates())}_refreshCoordinates(){this._renderObject&&(this._renderObject.points&&this.add(this._renderObject.points),this._renderObject.InstancedCol&&this.add(this._renderObject.InstancedCol),this.updateMatrixWorld(!0))}async _createObject(e){if(e.config.type==="light")return _g(e.config,this._geometries,this.getMap());throw new Error(`Unsupported style type: ${e.config.type}`)}}Jc.mergeOptions(r0);var i0=Object.defineProperty,n0=(s,e,t)=>e in s?i0(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Wr=(s,e,t)=>n0(s,typeof e!="symbol"?e+"":e,t);class Ln extends zr(Object){constructor(e,t){super(),Wr(this,"options"),Wr(this,"map"),Wr(this,"_sprite",null),Wr(this,"_isDragging",!1),Wr(this,"_dragStartPosition",null),Wr(this,"_lastCoordinate",null),Wr(this,"_boundOnMouseMove",null),Wr(this,"_boundOnMouseUp",null),this.map=t,this.options={position:e.position,index:e.index,symbol:e.symbol??0,size:e.size??8,color:e.color??"#ffffff",opacity:e.opacity??.9,draggable:e.draggable??!0},this._createSprite(),this._boundOnMouseMove=this._onMouseMove.bind(this),this._boundOnMouseUp=this._onMouseUp.bind(this)}_createSprite(){const t=document.createElement("canvas"),r=t.getContext("2d");t.width=64,t.height=64;const i=64/2,o=64/2-2;r.clearRect(0,0,t.width,t.height),r.beginPath(),r.arc(i,i,o,0,2*Math.PI),r.fillStyle="#000000",r.fill(),r.beginPath(),r.arc(i,i,o-2,0,2*Math.PI),r.fillStyle=this.options.color,r.fill();const l=new f.CanvasTexture(t);l.needsUpdate=!0;const c=new f.SpriteMaterial({map:l,opacity:this.options.opacity,transparent:!0,depthTest:!1,depthWrite:!1,sizeAttenuation:!0});this._sprite=new f.Sprite(c),this._sprite.position.copy(this.options.position),this._sprite.renderOrder=999999;const u=new f.Vector2;this._sprite.onBeforeRender=(d,m,p)=>{if(!this._sprite||!p)return;const _=p.position.distanceTo(this._sprite.position);d.getSize(u);const v=d.getPixelRatio(),M=this.options.size*v;let S=1;if(p.isPerspectiveCamera){const x=p.fov*Math.PI/180,O=2*Math.tan(x/2)*_;S=M/u.y*O}else if(p.isOrthographicCamera){const x=p.top,O=p.bottom,P=Math.abs(x-O)/p.zoom;S=M/u.y*P}this._sprite.scale.set(S,S,1)},this._sprite._editHandle=this,this.map.sceneRenderer.scene.add(this._sprite)}updatePosition(e){this.options.position=e,this._sprite&&this._sprite.position.copy(e)}getPosition(){return this.options.position.clone()}getIndex(){return this.options.index}getSymbol(){return this.options.symbol}getSprite(){return this._sprite}intersect(e){return!this._sprite||!this.options.draggable?!1:e.intersectObject(this._sprite).length>0}startDrag(e){this.options.draggable&&(this._isDragging=!0,this._dragStartPosition=this.options.position.clone(),this._lastCoordinate=e,this.map.sceneRenderer.configure("draggable",!1),this.map.on("mousemove",this._boundOnMouseMove),this.map.on("mouseup",this._boundOnMouseUp),this.fire("dragstart",{target:this,coordinate:e,position:this.options.position.clone()}))}_onMouseMove(e){if(!this._isDragging||!this._lastCoordinate)return;const t=e.coordinate,r=t[0]-this._lastCoordinate[0],i=t[1]-this._lastCoordinate[1],o=this.map.worldToLngLat(this.options.position),l=this.map.lngLatToWorld(new f.Vector3(t[0],t[1],o.z));this.updatePosition(l),this._lastCoordinate=t,this.fire("dragging",{target:this,coordinate:t,position:this.options.position.clone(),offset:{dx:r,dy:i}})}_onMouseUp(e){this._isDragging&&(this._isDragging=!1,this.map.sceneRenderer.configure("draggable",!0),this.map.off("mousemove",this._boundOnMouseMove),this.map.off("mouseup",this._boundOnMouseUp),this.fire("dragend",{target:this,coordinate:e.coordinate,position:this.options.position.clone(),startPosition:this._dragStartPosition}),this._dragStartPosition=null,this._lastCoordinate=null)}show(){this._sprite&&(this._sprite.visible=!0)}hide(){this._sprite&&(this._sprite.visible=!1)}remove(){if(this._isDragging&&(this._isDragging=!1,this.map.sceneRenderer.configure("draggable",!0),this.map.off("mousemove",this._boundOnMouseMove),this.map.off("mouseup",this._boundOnMouseUp)),this._sprite){this.map.sceneRenderer.scene.remove(this._sprite);const e=this._sprite.material;e.map&&e.map.dispose(),e.dispose(),this._sprite=null}this._dragStartPosition=null,this._lastCoordinate=null,this._boundOnMouseMove=null,this._boundOnMouseUp=null}}function la(s,e,t){const{currentTarget:r,clientX:i,clientY:o}=s;if(r instanceof HTMLElement){const l=r.clientWidth,c=r.clientHeight,u=new f.Vector2(i/l*2-1,-(o/c)*2+1);return So(t,e,u)?.location}else return}var s0=Object.defineProperty,o0=(s,e,t)=>e in s?s0(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,rt=(s,e,t)=>o0(s,typeof e!="symbol"?e+"":e,t);class a0 extends fs{constructor(e,t){super(e),rt(this,"options"),rt(this,"_handles",[]),rt(this,"_middleHandles",[]),rt(this,"_middleHandleColor","rgba(255, 255, 255, 0.6)"),rt(this,"_editing",!1),rt(this,"_shadow",null),rt(this,"_shadowSnapshot",null),rt(this,"_updating",!1),rt(this,"_history",[]),rt(this,"_historyIndex",-1),rt(this,"_draggableOriginalState",!1),rt(this,"_boundOnMapMouseMove",null),rt(this,"_boundOnMapClick",null),rt(this,"_boundOnMapMouseDown",null),rt(this,"_boundOnFeatureDragging",null),rt(this,"_boundOnFeatureDragEnd",null),this.options={handleSize:t?.handleSize??8,handleColor:t?.handleColor??"#ffffff",showMiddleHandles:t?.showMiddleHandles??!1,maxHistorySize:t?.maxHistorySize??20,removeVertexOn:t?.removeVertexOn??"contextmenu"},this._boundOnMapMouseMove=this._onMapMouseMove.bind(this),this._boundOnMapClick=this._onMapClick.bind(this),this._boundOnMapMouseDown=this._onMapMouseDown.bind(this),this._boundOnFeatureDragging=this._onFeatureDragging.bind(this),this._boundOnFeatureDragEnd=this._onFeatureDragEnd.bind(this)}enable(){return this._editing?this:(super.enable(),this._editing=!0,this._createShadow(),this._saveSnapshot(),this._setFeatureEditingStyle(!0),this._createHandles(),this.target.fire("editstart"),this._draggableOriginalState=this.target.options.draggable||!1,this._draggableOriginalState||(this.target.options.draggable=!0,this.target.draggable&&this.target.draggable.enable()),this)}disable(){return this._editing?(super.disable(),this._editing=!1,this._clearHandles(),this._setFeatureEditingStyle(!1),this._draggableOriginalState||(this.target.options.draggable=!1,this.target.draggable&&this.target.draggable.disable()),this._draggableOriginalState=!1,this._updateCoordFromShadow(),this._removeShadow(),this.target.fire("editend"),this):this}addHooks(){const e=this._getMap();e&&(e.on("mousemove",this._boundOnMapMouseMove),e.on("click",this._boundOnMapClick),e.sceneRenderer.container&&e.sceneRenderer.container.addEventListener("mousedown",this._boundOnMapMouseDown,!0),this.options.removeVertexOn==="contextmenu"&&e.on("contextmenu",this._boundOnMapClick)),this.target.on("dragging",this._boundOnFeatureDragging),this.target.on("dragend",this._boundOnFeatureDragEnd)}removeHooks(){const e=this._getMap();e&&(e.off("mousemove",this._boundOnMapMouseMove),e.off("click",this._boundOnMapClick),e.sceneRenderer.container&&e.sceneRenderer.container.removeEventListener("mousedown",this._boundOnMapMouseDown,!0),this.options.removeVertexOn==="contextmenu"&&e.off("contextmenu",this._boundOnMapClick)),this.target.off("dragging",this._boundOnFeatureDragging),this.target.off("dragend",this._boundOnFeatureDragEnd)}isEditing(){return this._editing}_createShadow(){this._shadow=null}_removeShadow(){this._shadow&&(this._shadow=null),this._shadowSnapshot=null}_updateCoordFromShadow(e=!1){e&&!this._updating&&this.target._refreshCoordinates()}_saveSnapshot(){const e=this.target._geometry;this._shadowSnapshot={type:e.type,coordinates:JSON.parse(JSON.stringify(e.coordinates))},this._addHistory(e.coordinates)}_addHistory(e){this._historyIndex<this._history.length-1&&(this._history=this._history.slice(0,this._historyIndex+1)),this._history.push({coordinates:JSON.parse(JSON.stringify(e)),timestamp:Date.now()}),this._history.length>this.options.maxHistorySize?this._history.shift():this._historyIndex++}undo(){if(this._historyIndex>0){this._historyIndex--;const e=this._history[this._historyIndex];this._restoreCoordinates(e.coordinates),this.target.fire("editundo")}return this}redo(){if(this._historyIndex<this._history.length-1){this._historyIndex++;const e=this._history[this._historyIndex];this._restoreCoordinates(e.coordinates),this.target.fire("editredo")}return this}_restoreCoordinates(e){const t=this.target._geometry;t.coordinates=JSON.parse(JSON.stringify(e)),this.target._refreshCoordinates(),this._updateHandlePositions()}cancel(){return this._shadowSnapshot&&this._restoreCoordinates(this._shadowSnapshot.coordinates),this.disable(),this}_createHandles(){const e=this.target._geometry,t=this._getMap();if(!t){console.warn("[FeatureEditHandler] No map found, cannot create handles");return}this.target instanceof Zt?this._createPointHandles(e,t):this.target instanceof pt?this._createLineStringHandles(e,t):this.target instanceof fr&&this._createPolygonHandles(e,t)}_createPointHandles(e,t){const r=e.coordinates,i=t.lngLatToWorld(new f.Vector3(r[0],r[1],r[2]||0)),o=new Ln({position:i,index:0,symbol:0,size:this.options.handleSize,color:this.options.handleColor},t);o.on("dragstart",l=>{this._onHandleDragStart(l,0)}),o.on("dragging",l=>{this._onHandleDragging(l,0)}),o.on("dragend",l=>{this._onHandleDragEnd(l,0)}),this._handles.push(o)}_createLineStringHandles(e,t){const r=e.coordinates;r.forEach((i,o)=>{const l=t.lngLatToWorld(new f.Vector3(i[0],i[1],i[2]||0)),c=new Ln({position:l,index:o,symbol:0,size:this.options.handleSize,color:this.options.handleColor},t);c.on("dragstart",u=>{this._onHandleDragStart(u,o)}),c.on("dragging",u=>{this._onHandleDragging(u,o)}),c.on("dragend",u=>{this._onHandleDragEnd(u,o)}),this._handles.push(c)}),this.options.showMiddleHandles&&this._createLineStringMiddleHandles(r,t)}_onHandleDragging(e,t){this._updating=!0;const i=e.target.getPosition();if(!this._getMap())return;const l=this._fixHandlePointCoordinates(i,t),c=this.target._geometry;this.target instanceof Zt?c.coordinates=[l.x,l.y,l.z]:this.target instanceof pt&&(c.coordinates[t]=[l.x,l.y,l.z]),this.target._refreshCoordinates(),this.target.fire("handledragging",{index:t,coordinate:[l.x,l.y,l.z]}),this.target.fire("editing",{index:t,coordinate:[l.x,l.y,l.z]}),this._updating=!1}_onHandleDragStart(e,t){this._updating=!0,this.target.fire("handledragstart",{index:t,coordinate:e.coordinate})}_onHandleDragEnd(e,t){this._updating=!1;const r=this.target._geometry;this._addHistory(r.coordinates),this.target.fire("handledragend",{index:t,coordinate:this.target instanceof Zt?r.coordinates:r.coordinates[t]}),this.target.fire("editvertex",{index:t,coordinate:this.target instanceof Zt?r.coordinates:r.coordinates[t]})}_createPolygonHandles(e,t){const r=e.coordinates;if(!r||!Array.isArray(r)||r.length===0){console.warn("[FeatureEditHandler] Invalid polygon coordinates");return}r.forEach((o,l)=>{if(!o||o.length<3)return;const c=o[0][0]===o[o.length-1][0]&&o[0][1]===o[o.length-1][1]?o.length-1:o.length;for(let u=0;u<c;u++){const d=o[u],m=t.lngLatToWorld(new f.Vector3(d[0],d[1],d[2]||0)),p=new Ln({position:m,index:u,symbol:0,size:this.options.handleSize,color:this.options.handleColor},t);p._ringIndex=l,p.on("dragstart",_=>{this._onPolygonHandleDragStart(_,u,l)}),p.on("dragging",_=>{this._onPolygonHandleDragging(_,u,l)}),p.on("dragend",_=>{this._onPolygonHandleDragEnd(_,u,l)}),this._handles.push(p)}this.options.showMiddleHandles&&this._createPolygonMiddleHandles(o,l,t)})}_onPolygonHandleDragStart(e,t,r){this._updating=!0,this.target.fire("handledragstart",{index:t,ringIndex:r,coordinate:e.coordinate})}_onPolygonHandleDragging(e,t,r){const o=e.target.getPosition();if(!this._getMap())return;const c=this._fixHandlePointCoordinates(o,t,r),d=this.target._geometry.coordinates;if(d[r]&&d[r][t]&&(d[r][t]=[c.x,c.y,c.z],t===0&&d[r].length>1)){const m=d[r].length-1;d[r][m]=[c.x,c.y,c.z]}this.target._refreshCoordinates(),this.target.fire("handledragging",{index:t,ringIndex:r,coordinate:[c.x,c.y,c.z]}),this.target.fire("editing",{index:t,ringIndex:r,coordinate:[c.x,c.y,c.z]})}_onPolygonHandleDragEnd(e,t,r){this._updating=!1;const i=this.target._geometry,o=i.coordinates;this._addHistory(i.coordinates),this.target.fire("handledragend",{index:t,ringIndex:r,coordinate:o[r]?.[t]||null}),this.target.fire("editvertex",{index:t,ringIndex:r,coordinate:o[r]?.[t]||null})}_updateHandlePositions(){const e=this.target._geometry,t=this._getMap();if(t){if(this.target instanceof Zt){const r=e.coordinates,i=t.lngLatToWorld(new f.Vector3(r[0],r[1],r[2]||0));this._handles[0]&&this._handles[0].updatePosition(i)}else if(this.target instanceof pt)e.coordinates.forEach((i,o)=>{const l=t.lngLatToWorld(new f.Vector3(i[0],i[1],i[2]||0));this._handles[o]&&this._handles[o].updatePosition(l)});else if(this.target instanceof fr){const r=e.coordinates;let i=0;r.forEach(o=>{const l=o[0][0]===o[o.length-1][0]&&o[0][1]===o[o.length-1][1]?o.length-1:o.length;for(let c=0;c<l;c++){const u=o[c],d=t.lngLatToWorld(new f.Vector3(u[0],u[1],u[2]||0));this._handles[i]&&this._handles[i].updatePosition(d),i++}})}}}_clearHandles(){this._handles.forEach(e=>e.remove()),this._handles=[],this._middleHandles.forEach(e=>e.remove()),this._middleHandles=[]}_onFeatureDragging(e){this._updateHandlePositions(),this.options.showMiddleHandles&&this._updateMiddleHandlePositions()}_onFeatureDragEnd(e){const t=this.target._geometry;this._addHistory(t.coordinates),this._updateHandlePositions(),this.options.showMiddleHandles&&this._updateMiddleHandlePositions()}_updateMiddleHandlePositions(){const e=this.target._geometry,t=this._getMap();if(!t)return;let r=0;if(this.target instanceof pt){const i=e.coordinates;for(let o=0;o<i.length-1&&!(r>=this._middleHandles.length);o++){const l=i[o],c=i[o+1],u=[(l[0]+c[0])/2,(l[1]+c[1])/2,((l[2]||0)+(c[2]||0))/2],d=t.lngLatToWorld(new f.Vector3(u[0],u[1],u[2]));this._middleHandles[r].updatePosition(d),r++}}else this.target instanceof fr&&e.coordinates.forEach(o=>{const l=o[0][0]===o[o.length-1][0]&&o[0][1]===o[o.length-1][1]?o.length-1:o.length;for(let c=0;c<l&&!(r>=this._middleHandles.length);c++){const u=(c+1)%l,d=o[c],m=o[u],p=[(d[0]+m[0])/2,(d[1]+m[1])/2,((d[2]||0)+(m[2]||0))/2],_=t.lngLatToWorld(new f.Vector3(p[0],p[1],p[2]));this._middleHandles[r].updatePosition(_),r++}})}_onMapMouseDown(e){const t=this._getMap();if(!t)return;const r=new f.Raycaster;r.params.Points={threshold:.5};const i=e,o=t.sceneRenderer.renderer.domElement,l=o.getBoundingClientRect(),c=new f.Vector2((i.clientX-l.left)/l.width*2-1,-((i.clientY-l.top)/l.height)*2+1);r.setFromCamera(c,t.sceneRenderer.camera);const u=[...this._handles,...this._middleHandles];for(const d of u)if(d.intersect(r)){const m=la({currentTarget:o,clientX:i.clientX,clientY:i.clientY},t,t.sceneRenderer.camera);m&&(d.startDrag([m.x,m.y]),i.stopPropagation&&i.stopPropagation(),i.stopImmediatePropagation&&i.stopImmediatePropagation(),i.preventDefault&&i.preventDefault());return}}_onMapMouseMove(e){}_onMapClick(e){if(!(e.type===this.options.removeVertexOn))return;const r=this._getMap();if(!r)return;const i=new f.Raycaster;i.params.Points={threshold:.5};const o=e.originEvent;if(!o)return;const l=new f.Vector2(o.offsetX/r.sceneRenderer.renderer.domElement.clientWidth*2-1,-(o.offsetY/r.sceneRenderer.renderer.domElement.clientHeight)*2+1);i.setFromCamera(l,r.sceneRenderer.camera);for(let c=0;c<this._handles.length;c++)if(this._handles[c].intersect(i)){this._removeVertex(c),o.stopPropagation&&o.stopPropagation(),o.preventDefault&&o.preventDefault();return}}_setFeatureEditingStyle(e){const t=this.target._renderObject;t&&t.traverse(r=>{r.material&&(e?Array.isArray(r.material)?r.material.forEach(i=>{i.userData._originalOpacity||(i.userData._originalOpacity=i.opacity),i.opacity=Math.min(i.opacity*.6,.6),i.transparent=!0}):(r.material.userData._originalOpacity||(r.material.userData._originalOpacity=r.material.opacity),r.material.opacity=Math.min(r.material.opacity*.6,.6),r.material.transparent=!0):Array.isArray(r.material)?r.material.forEach(i=>{i.userData._originalOpacity!==void 0&&(i.opacity=i.userData._originalOpacity,delete i.userData._originalOpacity)}):r.material.userData._originalOpacity!==void 0&&(r.material.opacity=r.material.userData._originalOpacity,delete r.material.userData._originalOpacity))})}_removeVertex(e){const t=this.target._geometry,r=this._handles[e],i=r.getIndex(),o=r._ringIndex||0;let l=null;if(this.target instanceof pt){const c=t.coordinates;if(c.length<=2){console.warn("[FeatureEditHandler] LineString requires at least 2 vertices");return}l=c[i],c.splice(i,1)}else if(this.target instanceof fr){const u=t.coordinates[o];if(!u)return;const d=u.length>1&&u[0][0]===u[u.length-1][0]&&u[0][1]===u[u.length-1][1],m=d?4:3;if(u.length<=m){console.warn("[FeatureEditHandler] Polygon ring requires at least 3 vertices");return}l=u[i],u.splice(i,1),d&&i===0&&u.length>0&&(u[u.length-1]=[...u[0]])}else return;this.target._refreshCoordinates(),r.remove(),this._handles.splice(e,1),this._updateHandleIndices(),this._addHistory(t.coordinates),this.target.fire("handleremove",{index:i,ringIndex:o,coordinate:l})}_createLineStringMiddleHandles(e,t){for(let r=0;r<e.length-1;r++){const i=e[r],o=e[r+1],l=[(i[0]+o[0])/2,(i[1]+o[1])/2,((i[2]||0)+(o[2]||0))/2],c=t.lngLatToWorld(new f.Vector3(l[0],l[1],l[2])),u=new Ln({position:c,index:r,symbol:1,size:this.options.handleSize,color:this._middleHandleColor,opacity:.6},t);u.on("dragstart",d=>{this._onMiddleHandleClick(r,"LineString",0)}),this._middleHandles.push(u)}}_createPolygonMiddleHandles(e,t,r){const i=e[0][0]===e[e.length-1][0]&&e[0][1]===e[e.length-1][1]?e.length-1:e.length;for(let o=0;o<i;o++){const l=(o+1)%i,c=e[o],u=e[l],d=[(c[0]+u[0])/2,(c[1]+u[1])/2,((c[2]||0)+(u[2]||0))/2],m=r.lngLatToWorld(new f.Vector3(d[0],d[1],d[2])),p=new Ln({position:m,index:o,symbol:1,size:this.options.handleSize,color:this._middleHandleColor,opacity:.6},r);p._ringIndex=t,p.on("dragstart",_=>{this._onMiddleHandleClick(o,"Polygon",t)}),this._middleHandles.push(p)}}_onMiddleHandleClick(e,t,r){const i=this.target._geometry;if(this._getMap()){if(t==="LineString"){const l=i.coordinates,c=l[e],u=l[e+1],d=[(c[0]+u[0])/2,(c[1]+u[1])/2,((c[2]||0)+(u[2]||0))/2];l.splice(e+1,0,d)}else if(t==="Polygon"){const c=i.coordinates[r];if(!c)return;const u=c[0][0]===c[c.length-1][0]&&c[0][1]===c[c.length-1][1]?c.length-1:c.length,d=(e+1)%u,m=c[e],p=c[d],_=[(m[0]+p[0])/2,(m[1]+p[1])/2,((m[2]||0)+(p[2]||0))/2];c.splice(e+1,0,_),c.length>1&&c[0][0]===c[c.length-1][0]&&c[0][1]===c[c.length-1][1]&&e===u-1&&(c[c.length-1]=[...c[0]])}this.target._applyCoordinateChanges(!0),this._clearHandles(),this._createHandles(),this._addHistory(i.coordinates),this.target.fire("vertexinsert",{index:e+1,ringIndex:r})}}_updateHandleIndices(){if(this.target instanceof pt)this._handles.forEach((e,t)=>{e._index=t});else if(this.target instanceof fr){let e=0;this.target._geometry.coordinates.forEach((i,o)=>{const l=i[0][0]===i[i.length-1][0]&&i[0][1]===i[i.length-1][1]?i.length-1:i.length;for(let c=0;c<l;c++)this._handles[e]&&(this._handles[e]._index=c,this._handles[e]._ringIndex=o),e++})}}_fixHandlePointCoordinates(e,t,r=0){const i=this._getMap();if(!i)return e;const o=this.target._geometry;let l=null;if(this.target instanceof Zt)l=o.coordinates;else if(this.target instanceof pt)l=o.coordinates[t];else if(this.target instanceof fr){const u=o.coordinates;u[r]&&u[r][t]&&(l=u[r][t])}if(!l||!l[2]||l[2]===0)return i.worldToLngLat(e);const c=i.worldToLngLat(e);return c.z=l[2],c}_getMap(){return this.target.getMap()}remove(){this.disable(),this._history=[],this._historyIndex=-1,this._shadow=null,this._shadowSnapshot=null,this._boundOnMapMouseMove=null,this._boundOnMapClick=null,this._boundOnMapMouseDown=null}}Je.prototype.startEdit=function(s){return this.options?.editable?(this._editor&&this.endEdit(),this._editor=new a0(this,s),this._editor.enable(),this):(console.warn("Feature is not editable. Set editable option to true."),this)},Je.prototype.endEdit=function(){return this._editor&&(this._editor.disable(),this._editor.remove(),delete this._editor),this},Je.prototype.isEditing=function(){return this._editor?this._editor.isEditing():!1},Je.prototype.cancelEdit=function(){return this._editor&&this._editor.cancel(),this},Je.prototype.undoEdit=function(){return this._editor&&this._editor.undo(),this},Je.prototype.redoEdit=function(){return this._editor&&this._editor.redo(),this};function ys(s,e){if(!s||s===!0)return!0;if(!Array.isArray(s))return!!s;switch(s[0]){case"all":return s.slice(1).every(r=>ys(r,e));case"any":return s.slice(1).some(r=>ys(r,e));case"!":return!ys(s[1],e);case"==":{const r=it(s[1],e),i=it(s[2],e);return vs(r)==vs(i)}case"!=":{const r=it(s[1],e),i=it(s[2],e);return vs(r)!=vs(i)}case">":{const r=it(s[1],e),i=it(s[2],e);return Gr(r)>Gr(i)}case"<":{const r=it(s[1],e),i=it(s[2],e);return Gr(r)<Gr(i)}case">=":{const r=it(s[1],e),i=it(s[2],e);return Gr(r)>=Gr(i)}case"<=":{const r=it(s[1],e),i=it(s[2],e);return Gr(r)<=Gr(i)}case"in":{const r=it(s[1],e);return s.slice(2).map(o=>it(o,e)).includes(r)}case"!in":{const r=it(s[1],e);return!s.slice(2).map(o=>it(o,e)).includes(r)}case"has":{const r=s[1];return e!=null&&Object.prototype.hasOwnProperty.call(e,r)}case"!has":{const r=s[1];return!(e!=null&&Object.prototype.hasOwnProperty.call(e,r))}default:return!0}}function it(s,e){return Array.isArray(s)&&s[0]==="get"?e?e[s[1]]:void 0:s}function vs(s){if(s==null)return null;if(typeof s=="string"){const e=Number(s);if(!isNaN(e)&&s.trim()!=="")return e}return typeof s=="boolean"?s?1:0:s}function Gr(s){if(s==null)return 0;if(typeof s=="number")return s;if(typeof s=="boolean")return s?1:0;if(typeof s=="string"){const e=Number(s);return isNaN(e)?0:e}return Number(s)}var l0=Object.defineProperty,c0=(s,e,t)=>e in s?l0(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Cn=(s,e,t)=>c0(s,typeof e!="symbol"?e+"":e,t);class ca extends Nr{constructor(e,t){super(e,t),Cn(this,"TILE_SIZE"),Cn(this,"EXTENT"),Cn(this,"paint"),Cn(this,"_tileFeatureMap",new Map),Cn(this,"_activeFeatureFilter"),this.TILE_SIZE=t.tileSize??256,this.EXTENT=t.extent??4096,this.paint=t.paint||[],this._onMapUpdate=this._onMapUpdate.bind(this)}processTileData(e,t){const r=this.getMap(),i=`${e.z}-${e.x}-${e.y}`,o=this._tileFeatureMap.get(i);if(o&&o.length>0){o.forEach(d=>{d.visible=!0,this.children.some(m=>m&&d&&m.uuid===d.uuid)||d.addTo(this)});return}const l=t.vectorData;if(!l||!l.layers||!r||this.paint.length===0)return;const c=[],u=this.paint;Object.keys(l.layers).forEach(d=>{const m=l.layers[d];for(let p=0;p<m.length;p++){const _=m[p],v=_.geometry;if(this._activeFeatureFilter&&!this._activeFeatureFilter(_.properties))continue;let M=null;for(const S of u)if(this._evaluateFilter(S.filter,_.properties,d,_.geometry.type)){M=S.paint;break}if(M){const S={isVectorTile:!0,tileZ:e.z,tileX:e.x,tileY:e.y,rawCoordinates:v,extent:this.EXTENT,tileSize:this.TILE_SIZE},x=this._createFeatureInstance(_.geometry,_.geometry.type,M,_.properties);x&&(x.userData.tileData=S,x.paint=xt.create(M),x.addTo(this),x.initializeGeometry(),c.push(x))}}}),this._tileFeatureMap.set(i,c)}_evaluateFilter(e,t,r,i){if(!e||e===!0)return!0;const o={...t,$layer:r,$type:i};return ys(e,o)}hideFeaturesByTileKey(e){const t=this._tileFeatureMap.get(e);t&&t.forEach(r=>{r.visible=!1})}removeFeaturesByTileKey(e){this._removeFeaturesByTileKey(e)}_removeFeaturesByTileKey(e){const t=this._tileFeatureMap.get(e);t&&(t.forEach(r=>{r._remove()}),this._tileFeatureMap.delete(e))}_createFeatureInstance(e,t,r,i){const l={geometry:{ismvt:!0,...e},paint:r,userData:i};switch(t){case"Point":return new wr(l);case"LineString":return new pt(l);default:return null}}setFeatureFilter(e){this._activeFeatureFilter=e}clearFeatureFilter(){this._activeFeatureFilter=void 0}setOpacity(e){this.opacity=e,this._tileFeatureMap.forEach(t=>{t.forEach(r=>{r.material&&(r.material.opacity=e,r.material.transparent=e<1)})})}_onMapUpdate(){}validateFeature(e){return e instanceof Je}dispose(){this._tileFeatureMap.forEach((e,t)=>{this._removeFeaturesByTileKey(t)}),super.dispose()}}var u0=Object.defineProperty,h0=(s,e,t)=>e in s?u0(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,mt=(s,e,t)=>h0(s,typeof e!="symbol"?e+"":e,t);class Hc extends ds{constructor(e,t){super(e,t),this.layerId=e,mt(this,"isTileLayer",!0),mt(this,"layerType","base"),mt(this,"isBaseLayer",!1),mt(this,"_enabled",!0),mt(this,"_visible",!0),mt(this,"_rootTile"),mt(this,"_loader"),mt(this,"_LODThreshold",1),mt(this,"isSceneLayer",!1),mt(this,"opacity",1),mt(this,"source"),mt(this,"projection"),mt(this,"minLevel",2),mt(this,"maxLevel",19),this.source=t.source,this.projection=t.projection,this.minLevel=t.minLevel??2,this.maxLevel=t.maxLevel??19,this._LODThreshold=t.LODThreshold??1,this.opacity=t.opacity??1,this.name=`Layer-${e}`,this._loader=this.createLoader(),this._rootTile=new ni,this._rootTile.matrixAutoUpdate=!0,this._rootTile.scale.set(this.projection.mapWidth,this.projection.mapHeight,1),this.add(this._rootTile),this._rootTile.updateMatrix(),this.layerId=e,this.name==="Layer-label-layer"&&this.position.set(0,0,1)}get LODThreshold(){return this._LODThreshold}set LODThreshold(e){this._LODThreshold=e}get loader(){return this._loader}get enabled(){return this._enabled}set enabled(e){this._enabled=e,this._rootTile&&(this._rootTile.visible=e&&this._visible)}get ivisible(){return this._visible&&super._visible}set ivisible(e){this._visible=e,this._rootTile&&(this._rootTile.visible=e&&this._enabled)}update(e){if(!(!this._enabled||!this._visible)){try{this.updateMatrixWorld(!0),this._rootTile.update({camera:e,loader:this._loader,minLevel:this.minLevel,maxLevel:this.maxLevel,LODThreshold:this.LODThreshold})}catch{}console.groupEnd()}}_debugTileTree(){this._rootTile.traverse(e=>{e.isTile&&(e.loaded,e.visible,e.inFrustum,e.loaded)})}_getLODThreshold(){return 1}_getCurrentTileLevel(){let e=0;return this._rootTile.traverse(t=>{t.isTile&&t.loaded&&(e=Math.max(e,t.z))}),`最大层级: ${e}`}dispose(){this.remove(this._rootTile),this._rootTile.reload(this._loader)}reload(){this._rootTile.reload(this._loader)}setElevation(e){this.position.y=e,this.updateMatrix(),this.updateMatrixWorld(!0)}raiseElevation(e){this.position.z+=e,this.updateMatrix(),this.updateMatrixWorld(!0)}getElevation(){return this.position.y}}class eu extends f.MeshStandardMaterial{constructor(e={}){super({transparent:!0,side:f.FrontSide,...e})}setTexture(e){this.map=e,this.needsUpdate=!0}dispose(){const e=this.map;e&&(e.image instanceof ImageBitmap&&e.image.close(),e.dispose())}}var Xe=(s=>(s[s.Unknown=0]="Unknown",s[s.Point=1]="Point",s[s.Linestring=2]="Linestring",s[s.Polygon=3]="Polygon",s))(Xe||{});class tu{render(e,t,r,i,o=1){switch(e.lineCap="round",e.lineJoin="round",(i.shadowBlur??0)>0&&(e.shadowBlur=i.shadowBlur??2,e.shadowColor=i.shadowColor??"black",e.shadowOffsetX=i.shadowOffset?i.shadowOffset[0]:0,e.shadowOffsetY=i.shadowOffset?i.shadowOffset[1]:0),t){case Xe.Point:e.textAlign="center",e.textBaseline="middle",e.font=i.font??"14px Arial",e.fillStyle=i.fontColor??"white",this._renderPointText(e,r,o,i.textField??"name",i.fontOffset??[0,-8]);break;case Xe.Linestring:this._renderLineString(e,r,o);break;case Xe.Polygon:this._renderPolygon(e,r,o);break;default:console.warn(`Unknown feature type: ${t}`)}(i.fill||t===Xe.Point)&&(e.globalAlpha=i.fillOpacity||.5,e.fillStyle=i.fillColor||i.color||"#3388ff",e.fill(i.fillRule||"evenodd")),(i.stroke??!0)&&(i.weight??1)>0&&(e.globalAlpha=i.opacity||1,e.lineWidth=i.weight||1,e.strokeStyle=i.color||"#3388ff",e.setLineDash(i.dashArray||[]),e.stroke())}_renderPointText(e,t,r=1,i="name",o=[0,0]){const l=t.geometry;e.beginPath();for(const u of l)for(let d=0;d<u.length;d++){const m=u[d];e.arc(m.x*r,m.y*r,2,0,2*Math.PI)}const c=t.properties;c&&c[i]&&e.fillText(c[i],l[0][0].x*r+o[0],l[0][0].y*r+o[1])}_renderLineString(e,t,r){const i=t.geometry;e.beginPath();for(const o of i)for(let l=0;l<o.length;l++){const{x:c,y:u}=o[l];l===0?e.moveTo(c*r,u*r):e.lineTo(c*r,u*r)}}_renderPolygon(e,t,r){const i=t.geometry;e.beginPath();for(let o=0;o<i.length;o++){const l=i[o];for(let c=0;c<l.length;c++){const{x:u,y:d}=l[c];c===0?e.moveTo(u*r,d*r):e.lineTo(u*r,d*r)}e.closePath()}}}var f0=Object.defineProperty,d0=(s,e,t)=>e in s?f0(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,p0=(s,e,t)=>d0(s,e+"",t);class ru extends f.LoadingManager{constructor(){super(...arguments),p0(this,"onParseEnd")}parseEnd(e){this.onParseEnd&&this.onParseEnd(e)}}var m0=Object.defineProperty,g0=(s,e,t)=>e in s?m0(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ws=(s,e,t)=>g0(s,typeof e!="symbol"?e+"":e,t);class Ve{static registerMaterialLoader(e){this.materialLoaders.set(e.dataType,e),this.ensureAuthor(e.info)}static registerGeometryLoader(e){this.geometryLoaders.set(e.dataType,e),this.ensureAuthor(e.info)}static registerMeshLoader(e){this.meshLoaders.set(e.dataType,e),this.ensureAuthor(e.info)}static getMaterialLoader(e){const t=this.materialLoaders.get(e.dataType);if(!t)throw new Error(`[TileLoaderFactory] Unsupported material source type: "${e.dataType}"`);return t}static getGeometryLoader(e){const t=this.geometryLoaders.get(e.dataType);if(!t)throw new Error(`[TileLoaderFactory] Unsupported geometry source type: "${e.dataType}"`);return t}static getMeshLoader(e){const t=this.meshLoaders.get(e.dataType);if(!t)throw new Error(`[TileLoaderFactory] Unsupported mesh source type: "${e.dataType}"`);return t}static ensureAuthor(e){e.author||(e.author="MapOrbis")}}ws(Ve,"manager",new ru),ws(Ve,"geometryLoaders",new Map),ws(Ve,"materialLoaders",new Map),ws(Ve,"meshLoaders",new Map);class On{static getBoundsCoord(e,t){const r=Math.floor(e[0]*t),i=Math.floor(e[1]*t),o=Math.floor((e[2]-e[0])*t),l=Math.floor((e[3]-e[1])*t);return{sx:r,sy:i,sw:o,sh:l}}static getSafeTileUrlAndBounds(e,t,r,i){if(i<e.minLevel)return{url:void 0,clipBounds:[0,0,1,1]};if(i<=e.maxLevel)return{url:e._getUrl(t,r,i),clipBounds:[0,0,1,1]};const o=this.getMaxLevelTileAndBounds(t,r,i,e.maxLevel),l=o.parentNO;return{url:e._getUrl(l.x,l.y,l.z),clipBounds:o.bounds}}static getMaxLevelTileAndBounds(e,t,r,i){const o=r-i,l={x:e>>o,y:t>>o,z:r-o},c=Math.pow(2,o),u=Math.pow(.5,o),d=e%c/c-.5+u/2,m=t%c/c-.5+u/2,p=new f.Vector2(d,m),_=new f.Box2().setFromCenterAndSize(p,new f.Vector2(u,u)),v=[_.min.x+.5,_.min.y+.5,_.max.x+.5,_.max.y+.5];return{parentNO:l,bounds:v}}}var _0=Object.defineProperty,y0=(s,e,t)=>e in s?_0(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,v0=(s,e,t)=>y0(s,e+"",t);class bs{constructor(){v0(this,"info",{version:"1.0.0",description:"Abstract material loader base class"})}async load(e){const{source:t,x:r,y:i,z:o}=e,l=new f.MeshBasicMaterial({transparent:!0}),{url:c,clipBounds:u}=On.getSafeTileUrlAndBounds(t,r,i,o);if(c)try{const d=await this.performLoad(c,{...e,bounds:u});l.map=d,Ve.manager.parseEnd(c)}catch(d){console.warn(`[AbstractMaterialLoader] Failed to load texture from ${c}`,d)}return l}unload(e){e.map&&e.map.dispose(),e.dispose()}}var w0=Object.defineProperty,b0=(s,e,t)=>e in s?w0(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,x0=(s,e,t)=>b0(s,e+"",t);class M0 extends bs{constructor(){super(...arguments),x0(this,"info",{version:"1.0.0",description:"Abstract loader for generating procedural canvas textures."})}async load(e){const t=this.createCanvasContext(256,256);this.drawTile(t,e);const r=new f.CanvasTexture(t.canvas.transferToImageBitmap());return new eu({transparent:!0,map:r,opacity:e.source.opacity??1})}async performLoad(e,t){throw new Error("Method not implemented.")}createCanvasContext(e,t){const i=new OffscreenCanvas(e,t).getContext("2d");if(!i)throw new Error("Failed to create OffscreenCanvas context");return i.scale(1,-1),i.translate(0,-t),i}}class Ni{static concatenateTypedArrays(...e){if(!e||e.length===0)throw new Error("[GeometryHelper] No arrays provided to concatenate.");const t=e[0].constructor,r=e.reduce((l,c)=>l+c.length,0),i=new t(r);let o=0;for(const l of e)i.set(l,o),o+=l.length;return i}static computeVertexNormals(e,t){const r=new Float32Array(e.length);for(let i=0;i<t.length;i+=3){const o=t[i]*3,l=t[i+1]*3,c=t[i+2]*3,u=e[o],d=e[o+1],m=e[o+2],p=e[l],_=e[l+1],v=e[l+2],M=e[c],S=e[c+1],x=e[c+2],O=p-u,P=_-d,L=v-m,F=M-u,z=S-d,j=x-m,G=P*j-L*z,U=L*F-O*j,X=O*z-P*F;r[o]+=G,r[o+1]+=U,r[o+2]+=X,r[l]+=G,r[l+1]+=U,r[l+2]+=X,r[c]+=G,r[c+1]+=U,r[c+2]+=X}for(let i=0;i<r.length;i+=3){const o=r[i],l=r[i+1],c=r[i+2],u=Math.sqrt(o*o+l*l+c*c);u>0?(r[i]/=u,r[i+1]/=u,r[i+2]/=u):(r[i]=0,r[i+1]=0,r[i+2]=1)}return r}static generateGridIndices(e,t){const r=(e-1)*(t-1)*6,i=e*t>65535?Uint32Array:Uint16Array,o=new i(r);let l=0;for(let c=0;c<e-1;c++)for(let u=0;u<t-1;u++){const d=c*t+u,m=d+1,p=(c+1)*t+u,_=p+1;o[l++]=d,o[l++]=m,o[l++]=p,o[l++]=p,o[l++]=m,o[l++]=_}return o}static fromDEM(e){if(e.length<4)throw new Error("[GeometryHelper] DEM data too small.");const t=Math.floor(Math.sqrt(e.length)),r=t,i=t,o=this.generateGridIndices(i,r),l=r*i,c=new Float32Array(l*3),u=new Float32Array(l*2);let d=0;for(let p=0;p<i;p++)for(let _=0;_<r;_++){const v=_/(r-1),M=p/(i-1);u[d*2]=v,u[d*2+1]=M,c[d*3]=v-.5,c[d*3+1]=M-.5,c[d*3+2]=e[(i-p-1)*r+_],d++}const m=this.computeVertexNormals(c,o);return{attributes:{position:{value:c,size:3},texcoord:{value:u,size:2},normal:{value:m,size:3}},indices:o}}}class iu{static addSkirt(e,t,r){const i=e.attributes.position.value,o=e.attributes.texcoord.value,l=e.attributes.normal.value,c=e.indices,u=r?this.getEdgesFromIndices(r,i):this.extractBoundaryEdges(c),d=u.length;if(d===0)return e;const m=d*2,p=new Float32Array(m*3),_=new Float32Array(m*2),v=new Float32Array(m*3),S=i.length/3+m>65535?Uint32Array:Uint16Array,x=c instanceof Uint32Array?Uint32Array:S,O=new x(d*6);let P=0,L=0;const F=i.length/3;for(let z=0;z<d;z++){const j=u[z],G=j[0],U=j[1],X=i[G*3],N=i[G*3+1],k=i[G*3+2],Z=i[U*3],E=i[U*3+1],q=i[U*3+2],te=o[G*2],H=o[G*2+1],Pe=o[U*2],ve=o[U*2+1];p[P*3+0]=X,p[P*3+1]=N,p[P*3+2]=k-t,_[P*2+0]=te,_[P*2+1]=H,v[P*3+0]=0,v[P*3+1]=0,v[P*3+2]=1;const we=F+P;P++,p[P*3+0]=Z,p[P*3+1]=E,p[P*3+2]=q-t,_[P*2+0]=Pe,_[P*2+1]=ve,v[P*3+0]=0,v[P*3+1]=0,v[P*3+2]=1;const me=F+P;P++,O[L++]=G,O[L++]=me,O[L++]=U,O[L++]=me,O[L++]=G,O[L++]=we}return{attributes:{position:{value:Ni.concatenateTypedArrays(i,p),size:3},texcoord:{value:Ni.concatenateTypedArrays(o,_),size:2},normal:{value:Ni.concatenateTypedArrays(l,v),size:3}},indices:Ni.concatenateTypedArrays(c,O)}}static extractBoundaryEdges(e){const t=[];for(let l=0;l<e.length;l+=3){const c=e[l],u=e[l+1],d=e[l+2];t.push([c,u],[u,d],[d,c])}const r=new Map,i=new Map;for(const l of t){const c=l[0]<l[1]?`${l[0]}-${l[1]}`:`${l[1]}-${l[0]}`;r.set(c,(r.get(c)||0)+1),i.has(c)||i.set(c,l)}const o=[];return r.forEach((l,c)=>{l===1&&o.push(i.get(c))}),o}static getEdgesFromIndices(e,t){const r=[],i=(_,v)=>Array.from(_).sort(v),o=_=>t[_*3],l=_=>t[_*3+1],c=i(e.west,(_,v)=>l(_)-l(v)),u=i(e.east,(_,v)=>l(v)-l(_)),d=i(e.south,(_,v)=>o(v)-o(_)),m=i(e.north,(_,v)=>o(_)-o(v)),p=_=>{if(_.length>1)for(let v=0;v<_.length-1;v++)r.push([_[v],_[v+1]])};return p(c),p(u),p(d),p(m),r}}var S0=Object.defineProperty,A0=(s,e,t)=>e in s?S0(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,P0=(s,e,t)=>A0(s,e+"",t);class Ri extends f.PlaneGeometry{constructor(){super(...arguments),P0(this,"type","MapTileGeometry")}setTerrainData(e,t=1e3){let r;return e instanceof Float32Array?r=Ni.fromDEM(e):r=e,t>0&&(r=iu.addSkirt(r,t)),this.updateThreeJSAttributes(r),this.computeBoundingBox(),this.computeBoundingSphere(),this}updateThreeJSAttributes(e){const{attributes:t,indices:r}=e;this.setIndex(new f.BufferAttribute(r,1)),this.setAttribute("position",new f.BufferAttribute(t.position.value,t.position.size)),this.setAttribute("uv",new f.BufferAttribute(t.texcoord.value,t.texcoord.size)),this.setAttribute("normal",new f.BufferAttribute(t.normal.value,t.normal.size))}}var L0=Object.defineProperty,C0=(s,e,t)=>e in s?L0(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Wi=(s,e,t)=>C0(s,typeof e!="symbol"?e+"":e,t);const nu=class ad{constructor(e=ad.DEFAULT_GRID_SIZE){Wi(this,"gridSize"),Wi(this,"numTriangles"),Wi(this,"numParentTriangles"),Wi(this,"indices"),Wi(this,"coords"),this.gridSize=e;const t=e-1;if(t&t-1)throw new Error(`[TerrainMeshBuilder] Invalid grid size: ${e}. Expected 2^k + 1.`);this.numTriangles=t*t*2-2,this.numParentTriangles=this.numTriangles-t*t,this.indices=new Uint32Array(this.gridSize*this.gridSize),this.coords=new Uint16Array(this.numTriangles*4),this.precomputeCoords(t)}precomputeCoords(e){for(let t=0;t<this.numTriangles;t++){let r=t+2,i=0,o=0,l=0,c=0,u=0,d=0;for(r&1?l=c=u=e:i=o=d=e;(r>>=1)>1;){const p=i+l>>1,_=o+c>>1;r&1?(l=i,c=o,i=u,o=d):(i=l,o=c,l=u,c=d),u=p,d=_}const m=t*4;this.coords[m+0]=i,this.coords[m+1]=o,this.coords[m+2]=l,this.coords[m+3]=c}}build(e,t=0){const r=this.calculateErrors(e),i=this.generateGeometry(r,t),o=i._vertices,l=i.indices,c=o.length/2,u=new Float32Array(c*3),d=new Float32Array(c*2),m=new Float32Array(c*3),p=this.gridSize;for(let _=0;_<c;_++){const v=o[2*_],M=o[2*_+1];u[3*_+0]=v,u[3*_+1]=M,u[3*_+2]=e[M*p+v],d[2*_+0]=v/(p-1),d[2*_+1]=M/(p-1)}return{attributes:{position:{value:u,size:3},texcoord:{value:d,size:2},normal:{value:m,size:3}},indices:l}}calculateErrors(e){const{gridSize:t,numTriangles:r,numParentTriangles:i,coords:o}=this,l=new Float32Array(e.length);for(let c=r-1;c>=0;c--){const u=c*4,d=o[u+0],m=o[u+1],p=o[u+2],_=o[u+3],v=d+p>>1,M=m+_>>1,S=v+M-m,x=M+v-d,O=(e[m*t+d]+e[_*t+p])/2,P=M*t+v,L=Math.abs(O-e[P]);if(l[P]=Math.max(l[P],L),c<i){const F=(m+x>>1)*t+(d+S>>1),z=(_+x>>1)*t+(p+S>>1);l[P]=Math.max(l[P],l[F],l[z])}}return l}generateGeometry(e,t){const{gridSize:r,indices:i}=this;i.fill(0);let o=0,l=0;const c=r-1,u=(v,M,S,x,O,P)=>{const L=v+S>>1,F=M+x>>1;if(Math.abs(v-O)+Math.abs(M-P)>1&&e[F*r+L]>t)u(O,P,v,M,L,F),u(S,x,O,P,L,F);else{const z=M*r+v,j=x*r+S,G=P*r+O;i[z]===0&&(i[z]=++o),i[j]===0&&(i[j]=++o),i[G]===0&&(i[G]=++o),l++}};u(0,0,c,c,c,0),u(c,c,0,0,0,c);const d=new Uint16Array(o*2),m=new Uint32Array(l*3);let p=0;const _=(v,M,S,x,O,P)=>{const L=v+S>>1,F=M+x>>1;if(Math.abs(v-O)+Math.abs(M-P)>1&&e[F*r+L]>t)_(O,P,v,M,L,F),_(S,x,O,P,L,F);else{const z=i[M*r+v]-1,j=i[x*r+S]-1,G=i[P*r+O]-1;d[2*z]=v,d[2*z+1]=M,d[2*j]=S,d[2*j+1]=x,d[2*G]=O,d[2*G+1]=P,m[p++]=z,m[p++]=j,m[p++]=G}};return _(0,0,c,c,c,0),_(c,c,0,0,0,c),{attributes:{position:{value:new Float32Array(0),size:3},texcoord:{value:new Float32Array(0),size:2},normal:{value:new Float32Array(0),size:3}},indices:m,_vertices:d}}};Wi(nu,"DEFAULT_GRID_SIZE",257);let O0=nu;var T0=Object.defineProperty,D0=(s,e,t)=>e in s?T0(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,I0=(s,e,t)=>D0(s,e+"",t);class ua{constructor(){I0(this,"info",{version:"1.0.0",description:"Abstract geometry loader base class"})}async load(e){const{source:t,x:r,y:i,z:o}=e,{url:l,clipBounds:c}=On.getSafeTileUrlAndBounds(t,r,i,o);if(!l)return new Ri;const u=await this.performLoad(l,{...e,bounds:c});return Ve.manager.parseEnd(l),u}}const su='(function(){"use strict";var ee=Object.defineProperty,re=(B,d,U)=>d in B?ee(B,d,{enumerable:!0,configurable:!0,writable:!0,value:U}):B[d]=U,j=(B,d,U)=>re(B,typeof d!="symbol"?d+"":d,U);const K=class P{constructor(d=P.DEFAULT_GRID_SIZE){j(this,"gridSize"),j(this,"numTriangles"),j(this,"numParentTriangles"),j(this,"indices"),j(this,"coords"),this.gridSize=d;const U=d-1;if(U&U-1)throw new Error(`[TerrainMeshBuilder] Invalid grid size: ${d}. Expected 2^k + 1.`);this.numTriangles=U*U*2-2,this.numParentTriangles=this.numTriangles-U*U,this.indices=new Uint32Array(this.gridSize*this.gridSize),this.coords=new Uint16Array(this.numTriangles*4),this.precomputeCoords(U)}precomputeCoords(d){for(let U=0;U<this.numTriangles;U++){let F=U+2,a=0,e=0,r=0,f=0,n=0,i=0;for(F&1?r=f=n=d:a=e=i=d;(F>>=1)>1;){const t=a+r>>1,s=e+f>>1;F&1?(r=a,f=e,a=n,e=i):(a=r,e=f,r=n,f=i),n=t,i=s}const m=U*4;this.coords[m+0]=a,this.coords[m+1]=e,this.coords[m+2]=r,this.coords[m+3]=f}}build(d,U=0){const F=this.calculateErrors(d),a=this.generateGeometry(F,U),e=a._vertices,r=a.indices,f=e.length/2,n=new Float32Array(f*3),i=new Float32Array(f*2),m=new Float32Array(f*3),t=this.gridSize;for(let s=0;s<f;s++){const c=e[2*s],o=e[2*s+1];n[3*s+0]=c,n[3*s+1]=o,n[3*s+2]=d[o*t+c],i[2*s+0]=c/(t-1),i[2*s+1]=o/(t-1)}return{attributes:{position:{value:n,size:3},texcoord:{value:i,size:2},normal:{value:m,size:3}},indices:r}}calculateErrors(d){const{gridSize:U,numTriangles:F,numParentTriangles:a,coords:e}=this,r=new Float32Array(d.length);for(let f=F-1;f>=0;f--){const n=f*4,i=e[n+0],m=e[n+1],t=e[n+2],s=e[n+3],c=i+t>>1,o=m+s>>1,h=c+o-m,v=o+c-i,u=(d[m*U+i]+d[s*U+t])/2,l=o*U+c,g=Math.abs(u-d[l]);if(r[l]=Math.max(r[l],g),f<a){const x=(m+v>>1)*U+(i+h>>1),k=(s+v>>1)*U+(t+h>>1);r[l]=Math.max(r[l],r[x],r[k])}}return r}generateGeometry(d,U){const{gridSize:F,indices:a}=this;a.fill(0);let e=0,r=0;const f=F-1,n=(c,o,h,v,u,l)=>{const g=c+h>>1,x=o+v>>1;if(Math.abs(c-u)+Math.abs(o-l)>1&&d[x*F+g]>U)n(u,l,c,o,g,x),n(h,v,u,l,g,x);else{const k=o*F+c,p=v*F+h,y=l*F+u;a[k]===0&&(a[k]=++e),a[p]===0&&(a[p]=++e),a[y]===0&&(a[y]=++e),r++}};n(0,0,f,f,f,0),n(f,f,0,0,0,f);const i=new Uint16Array(e*2),m=new Uint32Array(r*3);let t=0;const s=(c,o,h,v,u,l)=>{const g=c+h>>1,x=o+v>>1;if(Math.abs(c-u)+Math.abs(o-l)>1&&d[x*F+g]>U)s(u,l,c,o,g,x),s(h,v,u,l,g,x);else{const k=a[o*F+c]-1,p=a[v*F+h]-1,y=a[l*F+u]-1;i[2*k]=c,i[2*k+1]=o,i[2*p]=h,i[2*p+1]=v,i[2*y]=u,i[2*y+1]=l,m[t++]=k,m[t++]=p,m[t++]=y}};return s(0,0,f,f,f,0),s(f,f,0,0,0,f),{attributes:{position:{value:new Float32Array(0),size:3},texcoord:{value:new Float32Array(0),size:2},normal:{value:new Float32Array(0),size:3}},indices:m,_vertices:i}}};j(K,"DEFAULT_GRID_SIZE",257);let ie=K;const ne=(function(){var B={};B.defaultNoDataValue=-34027999387901484e22,B.decode=function(r,f){f=f||{};var n=f.encodedMaskData||f.encodedMaskData===null,i=a(r,f.inputOffset||0,n),m=f.noDataValue!==null?f.noDataValue:B.defaultNoDataValue,t=d(i,f.pixelType||Float32Array,f.encodedMaskData,m,f.returnMask),s={width:i.width,height:i.height,pixelData:t.resultPixels,minValue:t.minValue,maxValue:i.pixels.maxValue,noDataValue:m};return t.resultMask&&(s.maskData=t.resultMask),f.returnEncodedMask&&i.mask&&(s.encodedMaskData=i.mask.bitset?i.mask.bitset:null),f.returnFileInfo&&(s.fileInfo=U(i),f.computeUsedBitDepths&&(s.fileInfo.bitDepths=F(i))),s};var d=function(r,f,n,i,m){var t=0,s=r.pixels.numBlocksX,c=r.pixels.numBlocksY,o=Math.floor(r.width/s),h=Math.floor(r.height/c),v=2*r.maxZError,u=Number.MAX_VALUE,l;n=n||(r.mask?r.mask.bitset:null);var g,x;g=new f(r.width*r.height),m&&n&&(x=new Uint8Array(r.width*r.height));for(var k=new Float32Array(o*h),p,y,M=0;M<=c;M++){var S=M!==c?h:r.height%c;if(S!==0)for(var I=0;I<=s;I++){var w=I!==s?o:r.width%s;if(w!==0){var D=M*r.width*h+I*o,V=r.width-w,A=r.pixels.blocks[t],L,T,b;A.encoding<2?(A.encoding===0?L=A.rawData:(e(A.stuffedData,A.bitsPerPixel,A.numValidPixels,A.offset,v,k,r.pixels.maxValue),L=k),T=0):A.encoding===2?b=0:b=A.offset;var z;if(n)for(y=0;y<S;y++){for(D&7&&(z=n[D>>3],z<<=D&7),p=0;p<w;p++)D&7||(z=n[D>>3]),z&128?(x&&(x[D]=1),l=A.encoding<2?L[T++]:b,u=u>l?l:u,g[D++]=l):(x&&(x[D]=0),g[D++]=i),z<<=1;D+=V}else if(A.encoding<2)for(y=0;y<S;y++){for(p=0;p<w;p++)l=L[T++],u=u>l?l:u,g[D++]=l;D+=V}else for(u=u>b?b:u,y=0;y<S;y++){for(p=0;p<w;p++)g[D++]=b;D+=V}if(A.encoding===1&&T!==A.numValidPixels)throw"Block and Mask do not match";t++}}}return{resultPixels:g,resultMask:x,minValue:u}},U=function(r){return{fileIdentifierString:r.fileIdentifierString,fileVersion:r.fileVersion,imageType:r.imageType,height:r.height,width:r.width,maxZError:r.maxZError,eofOffset:r.eofOffset,mask:r.mask?{numBlocksX:r.mask.numBlocksX,numBlocksY:r.mask.numBlocksY,numBytes:r.mask.numBytes,maxValue:r.mask.maxValue}:null,pixels:{numBlocksX:r.pixels.numBlocksX,numBlocksY:r.pixels.numBlocksY,numBytes:r.pixels.numBytes,maxValue:r.pixels.maxValue,noDataValue:r.noDataValue}}},F=function(r){for(var f=r.pixels.numBlocksX*r.pixels.numBlocksY,n={},i=0;i<f;i++){var m=r.pixels.blocks[i];m.encoding===0?n.float32=!0:m.encoding===1?n[m.bitsPerPixel]=!0:n[0]=!0}return Object.keys(n)},a=function(r,f,n){var i={},m=new Uint8Array(r,f,10);if(i.fileIdentifierString=String.fromCharCode.apply(null,m),i.fileIdentifierString.trim()!=="CntZImage")throw"Unexpected file identifier string: "+i.fileIdentifierString;f+=10;var t=new DataView(r,f,24);if(i.fileVersion=t.getInt32(0,!0),i.imageType=t.getInt32(4,!0),i.height=t.getUint32(8,!0),i.width=t.getUint32(12,!0),i.maxZError=t.getFloat64(16,!0),f+=24,!n)if(t=new DataView(r,f,16),i.mask={},i.mask.numBlocksY=t.getUint32(0,!0),i.mask.numBlocksX=t.getUint32(4,!0),i.mask.numBytes=t.getUint32(8,!0),i.mask.maxValue=t.getFloat32(12,!0),f+=16,i.mask.numBytes>0){var s=new Uint8Array(Math.ceil(i.width*i.height/8));t=new DataView(r,f,i.mask.numBytes);var c=t.getInt16(0,!0),o=2,h=0;do{if(c>0)for(;c--;)s[h++]=t.getUint8(o++);else{var v=t.getUint8(o++);for(c=-c;c--;)s[h++]=v}c=t.getInt16(o,!0),o+=2}while(o<i.mask.numBytes);if(c!==-32768||h<s.length)throw"Unexpected end of mask RLE encoding";i.mask.bitset=s,f+=i.mask.numBytes}else(i.mask.numBytes|i.mask.numBlocksY|i.mask.maxValue)===0&&(i.mask.bitset=new Uint8Array(Math.ceil(i.width*i.height/8)));t=new DataView(r,f,16),i.pixels={},i.pixels.numBlocksY=t.getUint32(0,!0),i.pixels.numBlocksX=t.getUint32(4,!0),i.pixels.numBytes=t.getUint32(8,!0),i.pixels.maxValue=t.getFloat32(12,!0),f+=16;var u=i.pixels.numBlocksX,l=i.pixels.numBlocksY,g=u+(i.width%u>0?1:0),x=l+(i.height%l>0?1:0);i.pixels.blocks=new Array(g*x);for(var k=0,p=0;p<x;p++)for(var y=0;y<g;y++){var M=0,S=r.byteLength-f;t=new DataView(r,f,Math.min(10,S));var I={};i.pixels.blocks[k++]=I;var w=t.getUint8(0);if(M++,I.encoding=w&63,I.encoding>3)throw"Invalid block encoding ("+I.encoding+")";if(I.encoding===2){f++;continue}if(w!==0&&w!==2){if(w>>=6,I.offsetType=w,w===2)I.offset=t.getInt8(1),M++;else if(w===1)I.offset=t.getInt16(1,!0),M+=2;else if(w===0)I.offset=t.getFloat32(1,!0),M+=4;else throw"Invalid block offset type";if(I.encoding===1)if(w=t.getUint8(M),M++,I.bitsPerPixel=w&63,w>>=6,I.numValidPixelsType=w,w===2)I.numValidPixels=t.getUint8(M),M++;else if(w===1)I.numValidPixels=t.getUint16(M,!0),M+=2;else if(w===0)I.numValidPixels=t.getUint32(M,!0),M+=4;else throw"Invalid valid pixel count type"}if(f+=M,I.encoding!==3){var D,V;if(I.encoding===0){var A=(i.pixels.numBytes-1)/4;if(A!==Math.floor(A))throw"uncompressed block has invalid length";D=new ArrayBuffer(A*4),V=new Uint8Array(D),V.set(new Uint8Array(r,f,A*4));var L=new Float32Array(D);I.rawData=L,f+=A*4}else if(I.encoding===1){var T=Math.ceil(I.numValidPixels*I.bitsPerPixel/8),b=Math.ceil(T/4);D=new ArrayBuffer(b*4),V=new Uint8Array(D),V.set(new Uint8Array(r,f,T)),I.stuffedData=new Uint32Array(D),f+=T}}}return i.eofOffset=f,i},e=function(r,f,n,i,m,t,s){var c=(1<<f)-1,o=0,h,v=0,u,l,g=Math.ceil((s-i)/m),x=r.length*4-Math.ceil(f*n/8);for(r[r.length-1]<<=8*x,h=0;h<n;h++){if(v===0&&(l=r[o++],v=32),v>=f)u=l>>>v-f&c,v-=f;else{var k=f-v;u=(l&c)<<k&c,l=r[o++],v=32-k,u+=l>>>v}t[h]=u<g?i+u*m:s}return t};return B})(),te=(function(){var B={unstuff:function(a,e,r,f,n,i,m,t){var s=(1<<r)-1,c=0,o,h=0,v,u,l,g,x=a.length*4-Math.ceil(r*f/8);if(a[a.length-1]<<=8*x,n)for(o=0;o<f;o++)h===0&&(u=a[c++],h=32),h>=r?(v=u>>>h-r&s,h-=r):(l=r-h,v=(u&s)<<l&s,u=a[c++],h=32-l,v+=u>>>h),e[o]=n[v];else for(g=Math.ceil((t-i)/m),o=0;o<f;o++)h===0&&(u=a[c++],h=32),h>=r?(v=u>>>h-r&s,h-=r):(l=r-h,v=(u&s)<<l&s,u=a[c++],h=32-l,v+=u>>>h),e[o]=v<g?i+v*m:t},unstuffLUT:function(a,e,r,f,n,i){var m=(1<<e)-1,t=0,s=0,c=0,o=0,h=0,v,u=[],l=a.length*4-Math.ceil(e*r/8);a[a.length-1]<<=8*l;var g=Math.ceil((i-f)/n);for(s=0;s<r;s++)o===0&&(v=a[t++],o=32),o>=e?(h=v>>>o-e&m,o-=e):(c=e-o,h=(v&m)<<c&m,v=a[t++],o=32-c,h+=v>>>o),u[s]=h<g?f+h*n:i;return u.unshift(f),u},unstuff2:function(a,e,r,f,n,i,m,t){var s=(1<<r)-1,c=0,o,h=0,v=0,u,l,g;if(n)for(o=0;o<f;o++)h===0&&(l=a[c++],h=32,v=0),h>=r?(u=l>>>v&s,h-=r,v+=r):(g=r-h,u=l>>>v&s,l=a[c++],h=32-g,u|=(l&(1<<g)-1)<<r-g,v=g),e[o]=n[u];else{var x=Math.ceil((t-i)/m);for(o=0;o<f;o++)h===0&&(l=a[c++],h=32,v=0),h>=r?(u=l>>>v&s,h-=r,v+=r):(g=r-h,u=l>>>v&s,l=a[c++],h=32-g,u|=(l&(1<<g)-1)<<r-g,v=g),e[o]=u<x?i+u*m:t}return e},unstuffLUT2:function(a,e,r,f,n,i){var m=(1<<e)-1,t=0,s=0,c=0,o=0,h=0,v=0,u,l=[],g=Math.ceil((i-f)/n);for(s=0;s<r;s++)o===0&&(u=a[t++],o=32,v=0),o>=e?(h=u>>>v&m,o-=e,v+=e):(c=e-o,h=u>>>v&m,u=a[t++],o=32-c,h|=(u&(1<<c)-1)<<e-c,v=c),l[s]=h<g?f+h*n:i;return l.unshift(f),l},originalUnstuff:function(a,e,r,f){var n=(1<<r)-1,i=0,m,t=0,s,c,o,h=a.length*4-Math.ceil(r*f/8);for(a[a.length-1]<<=8*h,m=0;m<f;m++)t===0&&(c=a[i++],t=32),t>=r?(s=c>>>t-r&n,t-=r):(o=r-t,s=(c&n)<<o&n,c=a[i++],t=32-o,s+=c>>>t),e[m]=s;return e},originalUnstuff2:function(a,e,r,f){var n=(1<<r)-1,i=0,m,t=0,s=0,c,o,h;for(m=0;m<f;m++)t===0&&(o=a[i++],t=32,s=0),t>=r?(c=o>>>s&n,t-=r,s+=r):(h=r-t,c=o>>>s&n,o=a[i++],t=32-h,c|=(o&(1<<h)-1)<<r-h,s=h),e[m]=c;return e}},d={HUFFMAN_LUT_BITS_MAX:12,computeChecksumFletcher32:function(a){for(var e=65535,r=65535,f=a.length,n=Math.floor(f/2),i=0;n;){var m=n>=359?359:n;n-=m;do e+=a[i++]<<8,r+=e+=a[i++];while(--m);e=(e&65535)+(e>>>16),r=(r&65535)+(r>>>16)}return f&1&&(r+=e+=a[i]<<8),e=(e&65535)+(e>>>16),r=(r&65535)+(r>>>16),(r<<16|e)>>>0},readHeaderInfo:function(a,e){var r=e.ptr,f=new Uint8Array(a,r,6),n={};if(n.fileIdentifierString=String.fromCharCode.apply(null,f),n.fileIdentifierString.lastIndexOf("Lerc2",0)!==0)throw"Unexpected file identifier string (expect Lerc2 ): "+n.fileIdentifierString;r+=6;var i=new DataView(a,r,8),m=i.getInt32(0,!0);n.fileVersion=m,r+=4,m>=3&&(n.checksum=i.getUint32(4,!0),r+=4),i=new DataView(a,r,12),n.height=i.getUint32(0,!0),n.width=i.getUint32(4,!0),r+=8,m>=4?(n.numDims=i.getUint32(8,!0),r+=4):n.numDims=1,i=new DataView(a,r,40),n.numValidPixel=i.getUint32(0,!0),n.microBlockSize=i.getInt32(4,!0),n.blobSize=i.getInt32(8,!0),n.imageType=i.getInt32(12,!0),n.maxZError=i.getFloat64(16,!0),n.zMin=i.getFloat64(24,!0),n.zMax=i.getFloat64(32,!0),r+=40,e.headerInfo=n,e.ptr=r;var t,s;if(m>=3&&(s=m>=4?52:48,t=this.computeChecksumFletcher32(new Uint8Array(a,r-s,n.blobSize-14)),t!==n.checksum))throw"Checksum failed.";return!0},checkMinMaxRanges:function(a,e){var r=e.headerInfo,f=this.getDataTypeArray(r.imageType),n=r.numDims*this.getDataTypeSize(r.imageType),i=this.readSubArray(a,e.ptr,f,n),m=this.readSubArray(a,e.ptr+n,f,n);e.ptr+=2*n;var t,s=!0;for(t=0;t<r.numDims;t++)if(i[t]!==m[t]){s=!1;break}return r.minValues=i,r.maxValues=m,s},readSubArray:function(a,e,r,f){var n;if(r===Uint8Array)n=new Uint8Array(a,e,f);else{var i=new ArrayBuffer(f),m=new Uint8Array(i);m.set(new Uint8Array(a,e,f)),n=new r(i)}return n},readMask:function(a,e){var r=e.ptr,f=e.headerInfo,n=f.width*f.height,i=f.numValidPixel,m=new DataView(a,r,4),t={};if(t.numBytes=m.getUint32(0,!0),r+=4,(i===0||n===i)&&t.numBytes!==0)throw"invalid mask";var s,c;if(i===0)s=new Uint8Array(Math.ceil(n/8)),t.bitset=s,c=new Uint8Array(n),e.pixels.resultMask=c,r+=t.numBytes;else if(t.numBytes>0){s=new Uint8Array(Math.ceil(n/8)),m=new DataView(a,r,t.numBytes);var o=m.getInt16(0,!0),h=2,v=0,u=0;do{if(o>0)for(;o--;)s[v++]=m.getUint8(h++);else for(u=m.getUint8(h++),o=-o;o--;)s[v++]=u;o=m.getInt16(h,!0),h+=2}while(h<t.numBytes);if(o!==-32768||v<s.length)throw"Unexpected end of mask RLE encoding";c=new Uint8Array(n);var l=0,g=0;for(g=0;g<n;g++)g&7?(l=s[g>>3],l<<=g&7):l=s[g>>3],l&128&&(c[g]=1);e.pixels.resultMask=c,t.bitset=s,r+=t.numBytes}return e.ptr=r,e.mask=t,!0},readDataOneSweep:function(a,e,r,f){var n=e.ptr,i=e.headerInfo,m=i.numDims,t=i.width*i.height,s=i.imageType,c=i.numValidPixel*d.getDataTypeSize(s)*m,o,h=e.pixels.resultMask;if(r===Uint8Array)o=new Uint8Array(a,n,c);else{var v=new ArrayBuffer(c),u=new Uint8Array(v);u.set(new Uint8Array(a,n,c)),o=new r(v)}if(o.length===t*m)f?e.pixels.resultPixels=d.swapDimensionOrder(o,t,m,r,!0):e.pixels.resultPixels=o;else{e.pixels.resultPixels=new r(t*m);var l=0,g=0,x=0,k=0;if(m>1){if(f){for(g=0;g<t;g++)if(h[g])for(k=g,x=0;x<m;x++,k+=t)e.pixels.resultPixels[k]=o[l++]}else for(g=0;g<t;g++)if(h[g])for(k=g*m,x=0;x<m;x++)e.pixels.resultPixels[k+x]=o[l++]}else for(g=0;g<t;g++)h[g]&&(e.pixels.resultPixels[g]=o[l++])}return n+=c,e.ptr=n,!0},readHuffmanTree:function(a,e){var r=this.HUFFMAN_LUT_BITS_MAX,f=new DataView(a,e.ptr,16);e.ptr+=16;var n=f.getInt32(0,!0);if(n<2)throw"unsupported Huffman version";var i=f.getInt32(4,!0),m=f.getInt32(8,!0),t=f.getInt32(12,!0);if(m>=t)return!1;var s=new Uint32Array(t-m);d.decodeBits(a,e,s);var c=[],o,h,v,u;for(o=m;o<t;o++)h=o-(o<i?0:i),c[h]={first:s[o-m],second:null};var l=a.byteLength-e.ptr,g=Math.ceil(l/4),x=new ArrayBuffer(g*4),k=new Uint8Array(x);k.set(new Uint8Array(a,e.ptr,l));var p=new Uint32Array(x),y=0,M,S=0;for(M=p[0],o=m;o<t;o++)h=o-(o<i?0:i),u=c[h].first,u>0&&(c[h].second=M<<y>>>32-u,32-y>=u?(y+=u,y===32&&(y=0,S++,M=p[S])):(y+=u-32,S++,M=p[S],c[h].second|=M>>>32-y));var I=0,w=0,D=new U;for(o=0;o<c.length;o++)c[o]!==void 0&&(I=Math.max(I,c[o].first));I>=r?w=r:w=I;var V=[],A,L,T,b,z,C;for(o=m;o<t;o++)if(h=o-(o<i?0:i),u=c[h].first,u>0)if(A=[u,h],u<=w)for(L=c[h].second<<w-u,T=1<<w-u,v=0;v<T;v++)V[L|v]=A;else for(L=c[h].second,C=D,b=u-1;b>=0;b--)z=L>>>b&1,z?(C.right||(C.right=new U),C=C.right):(C.left||(C.left=new U),C=C.left),b===0&&!C.val&&(C.val=A[1]);return{decodeLut:V,numBitsLUTQick:w,numBitsLUT:I,tree:D,stuffedData:p,srcPtr:S,bitPos:y}},readHuffman:function(a,e,r,f){var n=e.headerInfo,i=n.numDims,m=e.headerInfo.height,t=e.headerInfo.width,s=t*m,c=this.readHuffmanTree(a,e),o=c.decodeLut,h=c.tree,v=c.stuffedData,u=c.srcPtr,l=c.bitPos,g=c.numBitsLUTQick,x=c.numBitsLUT,k=e.headerInfo.imageType===0?128:0,p,y,M,S=e.pixels.resultMask,I,w,D,V,A,L,T,b=0;l>0&&(u++,l=0);var z=v[u],C=e.encodeMode===1,N=new r(s*i),E=N,X;if(i<2||C){for(X=0;X<i;X++)if(i>1&&(E=new r(N.buffer,s*X,s),b=0),e.headerInfo.numValidPixel===t*m)for(L=0,V=0;V<m;V++)for(A=0;A<t;A++,L++){if(y=0,I=z<<l>>>32-g,w=I,32-l<g&&(I|=v[u+1]>>>64-l-g,w=I),o[w])y=o[w][1],l+=o[w][0];else for(I=z<<l>>>32-x,w=I,32-l<x&&(I|=v[u+1]>>>64-l-x,w=I),p=h,T=0;T<x;T++)if(D=I>>>x-T-1&1,p=D?p.right:p.left,!(p.left||p.right)){y=p.val,l=l+T+1;break}l>=32&&(l-=32,u++,z=v[u]),M=y-k,C?(A>0?M+=b:V>0?M+=E[L-t]:M+=b,M&=255,E[L]=M,b=M):E[L]=M}else for(L=0,V=0;V<m;V++)for(A=0;A<t;A++,L++)if(S[L]){if(y=0,I=z<<l>>>32-g,w=I,32-l<g&&(I|=v[u+1]>>>64-l-g,w=I),o[w])y=o[w][1],l+=o[w][0];else for(I=z<<l>>>32-x,w=I,32-l<x&&(I|=v[u+1]>>>64-l-x,w=I),p=h,T=0;T<x;T++)if(D=I>>>x-T-1&1,p=D?p.right:p.left,!(p.left||p.right)){y=p.val,l=l+T+1;break}l>=32&&(l-=32,u++,z=v[u]),M=y-k,C?(A>0&&S[L-1]?M+=b:V>0&&S[L-t]?M+=E[L-t]:M+=b,M&=255,E[L]=M,b=M):E[L]=M}}else for(L=0,V=0;V<m;V++)for(A=0;A<t;A++)if(L=V*t+A,!S||S[L])for(X=0;X<i;X++,L+=s){if(y=0,I=z<<l>>>32-g,w=I,32-l<g&&(I|=v[u+1]>>>64-l-g,w=I),o[w])y=o[w][1],l+=o[w][0];else for(I=z<<l>>>32-x,w=I,32-l<x&&(I|=v[u+1]>>>64-l-x,w=I),p=h,T=0;T<x;T++)if(D=I>>>x-T-1&1,p=D?p.right:p.left,!(p.left||p.right)){y=p.val,l=l+T+1;break}l>=32&&(l-=32,u++,z=v[u]),M=y-k,E[L]=M}e.ptr=e.ptr+(u+1)*4+(l>0?4:0),e.pixels.resultPixels=N,i>1&&!f&&(e.pixels.resultPixels=d.swapDimensionOrder(N,s,i,r))},decodeBits:function(a,e,r,f,n){{var i=e.headerInfo,m=i.fileVersion,t=0,s=a.byteLength-e.ptr>=5?5:a.byteLength-e.ptr,c=new DataView(a,e.ptr,s),o=c.getUint8(0);t++;var h=o>>6,v=h===0?4:3-h,u=(o&32)>0,l=o&31,g=0;if(v===1)g=c.getUint8(t),t++;else if(v===2)g=c.getUint16(t,!0),t+=2;else if(v===4)g=c.getUint32(t,!0),t+=4;else throw"Invalid valid pixel count type";var x=2*i.maxZError,k,p,y,M,S,I,w,D,V,A=i.numDims>1?i.maxValues[n]:i.zMax;if(u){for(e.counter.lut++,D=c.getUint8(t),t++,M=Math.ceil((D-1)*l/8),S=Math.ceil(M/4),p=new ArrayBuffer(S*4),y=new Uint8Array(p),e.ptr+=t,y.set(new Uint8Array(a,e.ptr,M)),w=new Uint32Array(p),e.ptr+=M,V=0;D-1>>>V;)V++;M=Math.ceil(g*V/8),S=Math.ceil(M/4),p=new ArrayBuffer(S*4),y=new Uint8Array(p),y.set(new Uint8Array(a,e.ptr,M)),k=new Uint32Array(p),e.ptr+=M,m>=3?I=B.unstuffLUT2(w,l,D-1,f,x,A):I=B.unstuffLUT(w,l,D-1,f,x,A),m>=3?B.unstuff2(k,r,V,g,I):B.unstuff(k,r,V,g,I)}else e.counter.bitstuffer++,V=l,e.ptr+=t,V>0&&(M=Math.ceil(g*V/8),S=Math.ceil(M/4),p=new ArrayBuffer(S*4),y=new Uint8Array(p),y.set(new Uint8Array(a,e.ptr,M)),k=new Uint32Array(p),e.ptr+=M,m>=3?f==null?B.originalUnstuff2(k,r,V,g):B.unstuff2(k,r,V,g,!1,f,x,A):f==null?B.originalUnstuff(k,r,V,g):B.unstuff(k,r,V,g,!1,f,x,A))}},readTiles:function(a,e,r,f){var n=e.headerInfo,i=n.width,m=n.height,t=i*m,s=n.microBlockSize,c=n.imageType,o=d.getDataTypeSize(c),h=Math.ceil(i/s),v=Math.ceil(m/s);e.pixels.numBlocksY=v,e.pixels.numBlocksX=h,e.pixels.ptr=0;var u=0,l=0,g=0,x=0,k=0,p=0,y=0,M=0,S=0,I=0,w=0,D=0,V=0,A=0,L=0,T=0,b,z,C,N,E,X,Q=new r(s*s),le=m%s||s,oe=i%s||s,$,R,q=n.numDims,H,Y=e.pixels.resultMask,O=e.pixels.resultPixels,ue=n.fileVersion,W=ue>=5?14:15,_,J=n.zMax,Z;for(g=0;g<v;g++)for(k=g!==v-1?s:le,x=0;x<h;x++)for(p=x!==h-1?s:oe,w=g*i*s+x*s,D=i-p,H=0;H<q;H++){if(q>1?(Z=O,w=g*i*s+x*s,O=new r(e.pixels.resultPixels.buffer,t*H*o,t),J=n.maxValues[H]):Z=null,y=a.byteLength-e.ptr,b=new DataView(a,e.ptr,Math.min(10,y)),z={},T=0,M=b.getUint8(0),T++,_=n.fileVersion>=5?M&4:0,S=M>>6&255,I=M>>2&W,I!==(x*s>>3&W)||_&&H===0)throw"integrity issue";if(X=M&3,X>3)throw e.ptr+=T,"Invalid block encoding ("+X+")";if(X===2){if(_)if(Y)for(u=0;u<k;u++)for(l=0;l<p;l++)Y[w]&&(O[w]=Z[w]),w++;else for(u=0;u<k;u++)for(l=0;l<p;l++)O[w]=Z[w],w++;e.counter.constant++,e.ptr+=T;continue}else if(X===0){if(_)throw"integrity issue";if(e.counter.uncompressed++,e.ptr+=T,V=k*p*o,A=a.byteLength-e.ptr,V=V<A?V:A,C=new ArrayBuffer(V%o===0?V:V+o-V%o),N=new Uint8Array(C),N.set(new Uint8Array(a,e.ptr,V)),E=new r(C),L=0,Y)for(u=0;u<k;u++){for(l=0;l<p;l++)Y[w]&&(O[w]=E[L++]),w++;w+=D}else for(u=0;u<k;u++){for(l=0;l<p;l++)O[w++]=E[L++];w+=D}e.ptr+=L*o}else if($=d.getDataTypeUsed(_&&c<6?4:c,S),R=d.getOnePixel(z,T,$,b),T+=d.getDataTypeSize($),X===3)if(e.ptr+=T,e.counter.constantoffset++,Y)for(u=0;u<k;u++){for(l=0;l<p;l++)Y[w]&&(O[w]=_?Math.min(J,Z[w]+R):R),w++;w+=D}else for(u=0;u<k;u++){for(l=0;l<p;l++)O[w]=_?Math.min(J,Z[w]+R):R,w++;w+=D}else if(e.ptr+=T,d.decodeBits(a,e,Q,R,H),T=0,_)if(Y)for(u=0;u<k;u++){for(l=0;l<p;l++)Y[w]&&(O[w]=Q[T++]+Z[w]),w++;w+=D}else for(u=0;u<k;u++){for(l=0;l<p;l++)O[w]=Q[T++]+Z[w],w++;w+=D}else if(Y)for(u=0;u<k;u++){for(l=0;l<p;l++)Y[w]&&(O[w]=Q[T++]),w++;w+=D}else for(u=0;u<k;u++){for(l=0;l<p;l++)O[w++]=Q[T++];w+=D}}q>1&&!f&&(e.pixels.resultPixels=d.swapDimensionOrder(e.pixels.resultPixels,t,q,r))},formatFileInfo:function(a){return{fileIdentifierString:a.headerInfo.fileIdentifierString,fileVersion:a.headerInfo.fileVersion,imageType:a.headerInfo.imageType,height:a.headerInfo.height,width:a.headerInfo.width,numValidPixel:a.headerInfo.numValidPixel,microBlockSize:a.headerInfo.microBlockSize,blobSize:a.headerInfo.blobSize,maxZError:a.headerInfo.maxZError,pixelType:d.getPixelType(a.headerInfo.imageType),eofOffset:a.eofOffset,mask:a.mask?{numBytes:a.mask.numBytes}:null,pixels:{numBlocksX:a.pixels.numBlocksX,numBlocksY:a.pixels.numBlocksY,maxValue:a.headerInfo.zMax,minValue:a.headerInfo.zMin,noDataValue:a.noDataValue}}},constructConstantSurface:function(a,e){var r=a.headerInfo.zMax,f=a.headerInfo.zMin,n=a.headerInfo.maxValues,i=a.headerInfo.numDims,m=a.headerInfo.height*a.headerInfo.width,t=0,s=0,c=0,o=a.pixels.resultMask,h=a.pixels.resultPixels;if(o)if(i>1){if(e)for(t=0;t<i;t++)for(c=t*m,r=n[t],s=0;s<m;s++)o[s]&&(h[c+s]=r);else for(s=0;s<m;s++)if(o[s])for(c=s*i,t=0;t<i;t++)h[c+i]=n[t]}else for(s=0;s<m;s++)o[s]&&(h[s]=r);else if(i>1&&f!==r)if(e)for(t=0;t<i;t++)for(c=t*m,r=n[t],s=0;s<m;s++)h[c+s]=r;else for(s=0;s<m;s++)for(c=s*i,t=0;t<i;t++)h[c+t]=n[t];else for(s=0;s<m*i;s++)h[s]=r},getDataTypeArray:function(a){var e;switch(a){case 0:e=Int8Array;break;case 1:e=Uint8Array;break;case 2:e=Int16Array;break;case 3:e=Uint16Array;break;case 4:e=Int32Array;break;case 5:e=Uint32Array;break;case 6:e=Float32Array;break;case 7:e=Float64Array;break;default:e=Float32Array}return e},getPixelType:function(a){var e;switch(a){case 0:e="S8";break;case 1:e="U8";break;case 2:e="S16";break;case 3:e="U16";break;case 4:e="S32";break;case 5:e="U32";break;case 6:e="F32";break;case 7:e="F64";break;default:e="F32"}return e},isValidPixelValue:function(a,e){if(e==null)return!1;var r;switch(a){case 0:r=e>=-128&&e<=127;break;case 1:r=e>=0&&e<=255;break;case 2:r=e>=-32768&&e<=32767;break;case 3:r=e>=0&&e<=65536;break;case 4:r=e>=-2147483648&&e<=2147483647;break;case 5:r=e>=0&&e<=4294967296;break;case 6:r=e>=-34027999387901484e22&&e<=34027999387901484e22;break;case 7:r=e>=-17976931348623157e292&&e<=17976931348623157e292;break;default:r=!1}return r},getDataTypeSize:function(a){var e=0;switch(a){case 0:case 1:e=1;break;case 2:case 3:e=2;break;case 4:case 5:case 6:e=4;break;case 7:e=8;break;default:e=a}return e},getDataTypeUsed:function(a,e){var r=a;switch(a){case 2:case 4:r=a-e;break;case 3:case 5:r=a-2*e;break;case 6:e===0?r=a:e===1?r=2:r=1;break;case 7:e===0?r=a:r=a-2*e+1;break;default:r=a;break}return r},getOnePixel:function(a,e,r,f){var n=0;switch(r){case 0:n=f.getInt8(e);break;case 1:n=f.getUint8(e);break;case 2:n=f.getInt16(e,!0);break;case 3:n=f.getUint16(e,!0);break;case 4:n=f.getInt32(e,!0);break;case 5:n=f.getUInt32(e,!0);break;case 6:n=f.getFloat32(e,!0);break;case 7:n=f.getFloat64(e,!0);break;default:throw"the decoder does not understand this pixel type"}return n},swapDimensionOrder:function(a,e,r,f,n){var i=0,m=0,t=0,s=0,c=a;if(r>1)if(c=new f(e*r),n)for(i=0;i<e;i++)for(s=i,t=0;t<r;t++,s+=e)c[s]=a[m++];else for(i=0;i<e;i++)for(s=i,t=0;t<r;t++,s+=e)c[m++]=a[s];return c}},U=function(a,e,r){this.val=a,this.left=e,this.right=r},F={decode:function(a,e){e=e||{};var r=e.noDataValue,f=0,n={};if(n.ptr=e.inputOffset||0,n.pixels={},!!d.readHeaderInfo(a,n)){var i=n.headerInfo,m=i.fileVersion,t=d.getDataTypeArray(i.imageType);if(m>5)throw"unsupported lerc version 2."+m;d.readMask(a,n),i.numValidPixel!==i.width*i.height&&!n.pixels.resultMask&&(n.pixels.resultMask=e.maskData);var s=i.width*i.height;n.pixels.resultPixels=new t(s*i.numDims),n.counter={onesweep:0,uncompressed:0,lut:0,bitstuffer:0,constant:0,constantoffset:0};var c=!e.returnPixelInterleavedDims;if(i.numValidPixel!==0)if(i.zMax===i.zMin)d.constructConstantSurface(n,c);else if(m>=4&&d.checkMinMaxRanges(a,n))d.constructConstantSurface(n,c);else{var o=new DataView(a,n.ptr,2),h=o.getUint8(0);if(n.ptr++,h)d.readDataOneSweep(a,n,t,c);else if(m>1&&i.imageType<=1&&Math.abs(i.maxZError-.5)<1e-5){var v=o.getUint8(1);if(n.ptr++,n.encodeMode=v,v>2||m<4&&v>1)throw"Invalid Huffman flag "+v;v?d.readHuffman(a,n,t,c):d.readTiles(a,n,t,c)}else d.readTiles(a,n,t,c)}n.eofOffset=n.ptr;var u;e.inputOffset?(u=n.headerInfo.blobSize+e.inputOffset-n.ptr,Math.abs(u)>=1&&(n.eofOffset=e.inputOffset+n.headerInfo.blobSize)):(u=n.headerInfo.blobSize-n.ptr,Math.abs(u)>=1&&(n.eofOffset=n.headerInfo.blobSize));var l={width:i.width,height:i.height,pixelData:n.pixels.resultPixels,minValue:i.zMin,maxValue:i.zMax,validPixelCount:i.numValidPixel,dimCount:i.numDims,dimStats:{minValues:i.minValues,maxValues:i.maxValues},maskData:n.pixels.resultMask};if(n.pixels.resultMask&&d.isValidPixelValue(i.imageType,r)){var g=n.pixels.resultMask;for(f=0;f<s;f++)g[f]||(l.pixelData[f]=r);l.noDataValue=r}return n.noDataValue=r,e.returnFileInfo&&(l.fileInfo=d.formatFileInfo(n)),l}},getBandCount:function(a){var e=0,r=0,f={};for(f.ptr=0,f.pixels={};r<a.byteLength-58;)d.readHeaderInfo(a,f),r+=f.headerInfo.blobSize,e++,f.ptr=r;return e}};return F})();var ae=(function(){var B=new ArrayBuffer(4),d=new Uint8Array(B),U=new Uint32Array(B);return U[0]=1,d[0]===1})(),se={decode:function(B,d){if(!ae)throw"Big endian system is not supported.";d=d||{};var U=d.inputOffset||0,F=new Uint8Array(B,U,10),a=String.fromCharCode.apply(null,F),e,r;if(a.trim()==="CntZImage")e=ne,r=1;else if(a.substring(0,5)==="Lerc2")e=te,r=2;else throw"Unexpected file identifier string: "+a;for(var f=0,n=B.byteLength-10,i,m=[],t,s,c={width:0,height:0,pixels:[],pixelType:d.pixelType,mask:null,statistics:[]},o=0;U<n;){var h=e.decode(B,{inputOffset:U,encodedMaskData:i,maskData:s,returnMask:f===0,returnEncodedMask:f===0,returnFileInfo:!0,returnPixelInterleavedDims:d.returnPixelInterleavedDims,pixelType:d.pixelType||null,noDataValue:d.noDataValue||null});U=h.fileInfo.eofOffset,s=h.maskData,f===0&&(i=h.encodedMaskData,c.width=h.width,c.height=h.height,c.dimCount=h.dimCount||1,c.pixelType=h.pixelType||h.fileInfo.pixelType,c.mask=s),r>1&&(s&&m.push(s),h.fileInfo.mask&&h.fileInfo.mask.numBytes>0&&o++),f++,c.pixels.push(h.pixelData),c.statistics.push({minValue:h.minValue,maxValue:h.maxValue,noDataValue:h.noDataValue,dimStats:h.dimStats})}var v,u,l;if(r>1&&o>1){for(l=c.width*c.height,c.bandMasks=m,s=new Uint8Array(l),s.set(m[0]),v=1;v<m.length;v++)for(t=m[v],u=0;u<l;u++)s[u]=s[u]&t[u];c.maskData=s}return c}};const fe={0:7e3,1:6e3,2:5e3,3:4e3,4:3e3,5:2500,6:2e3,7:1500,8:800,9:500,10:200,11:100,12:40,13:12,14:5,15:2,16:1,17:.5,18:.2,19:.1,20:.01};class G{static parse(d,U,F){let a=G.decode(d);F[2]-F[0]<1&&(a=G.getSubDEM(a,F));const{array:e,width:r}=a,f=new ie(r),n=fe[U]||0;return f.build(e,n)}static decode(d){const{height:U,width:F,pixels:a}=se.decode(d),e=new Float32Array(U*F);for(let r=0;r<e.length;r++)e[r]=a[0][r];return{array:e,width:F,height:U}}static getSubDEM(d,U){function F(s,c,o,h,v,u,l,g){const x=new Float32Array(v*u);for(let p=0;p<u;p++)for(let y=0;y<v;y++){const M=(p+h)*c+(y+o),S=p*v+y;x[S]=s[M]}const k=new Float32Array(g*l);if(v===l&&u===g)k.set(x);else{const p=v/l,y=u/g;for(let M=0;M<g;M++)for(let S=0;S<l;S++){const I=Math.floor(S*p),D=Math.floor(M*y)*v+I;k[M*l+S]=x[D]}}return k}const{array:a,width:e}=d,{sx:r,sy:f,sw:n,sh:i}=G.getBoundsCoord(U,e),m=e;return{array:F(a,e,r,f,n,i,m,m),width:m,height:m}}static getBoundsCoord(d,U){const F=Math.floor(d[0]*U),a=Math.floor(d[1]*U),e=Math.floor((d[2]-d[0])*U),r=Math.floor((d[3]-d[1])*U);return{sx:F,sy:a,sw:e,sh:r}}}self.onmessage=B=>{const d=B.data,U=G.parse(d.demData,d.z,d.clipBounds);self.postMessage(U)}})();\n',ou=typeof self<"u"&&self.Blob&&new Blob(["(self.URL || self.webkitURL).revokeObjectURL(self.location.href);",su],{type:"text/javascript;charset=utf-8"});function F0(s){let e;try{if(e=ou&&(self.URL||self.webkitURL).createObjectURL(ou),!e)throw"";const t=new Worker(e,{name:s?.name});return t.addEventListener("error",()=>{(self.URL||self.webkitURL).revokeObjectURL(e)}),t}catch{return new Worker("data:text/javascript;charset=utf-8,"+encodeURIComponent(su),{name:s?.name})}}var B0=Object.defineProperty,U0=(s,e,t)=>e in s?B0(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,xs=(s,e,t)=>U0(s,typeof e!="symbol"?e+"":e,t);const V0=10;class au extends ua{constructor(){super(),xs(this,"info",{version:"1.0.0",description:"Loader for ArcGIS LERC compressed terrain data."}),xs(this,"dataType","lerc"),xs(this,"fileLoader",new f.FileLoader(Ve.manager)),xs(this,"workerPool",new ta(0)),this.fileLoader.setResponseType("arraybuffer"),this.workerPool.setWorkerCreator(()=>new F0)}async performLoad(e,t){this.workerPool.pool===0&&this.workerPool.setWorkerLimit(V0);const r=await this.fileLoader.loadAsync(e).catch(()=>new Float32Array(256*256).buffer),i={demData:r,z:t.z,clipBounds:t.bounds},l=(await this.workerPool.postMessage(i,[r])).data,c=new Ri;return c.setTerrainData(l),c}}var k0=Object.defineProperty,z0=(s,e,t)=>e in s?k0(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ms=(s,e,t)=>z0(s,typeof e!="symbol"?e+"":e,t);class Ss{constructor(){Ms(this,"_imgSources",[]),Ms(this,"_demSource"),Ms(this,"_vtSource"),Ms(this,"manager",Ve.manager)}get imgSource(){return this._imgSources}set imgSource(e){this._imgSources=e}get demSource(){return this._demSource}set demSource(e){this._demSource=e}get vtSource(){return this._vtSource}set vtSource(e){this._vtSource=e}async load(e){const[t,r]=await Promise.all([this.loadGeometry(e),this.loadMaterials(e)]);if(t&&r)for(let i=0;i<r.length;i++)t.addGroup(0,1/0,i);return{geometry:t,materials:r}}unload(e){const t=e.material,r=e.geometry;Array.isArray(t)?t.forEach(i=>i.dispose()):t&&t.dispose(),r&&r.dispose()}async loadGeometry(e){const{z:t,bounds:r}=e;return this.demSource&&t>=this.demSource.minLevel&&this.isBoundsInSource(this.demSource,r)?this.loadFromSource(this.demSource,e,Ve.getGeometryLoader(this.demSource)):this.vtSource&&t>=this.vtSource.minLevel&&this.isBoundsInSource(this.vtSource,r)?this.loadFromSource(this.vtSource,e,Ve.getMeshLoader(this.vtSource)):new f.PlaneGeometry}async loadMaterials(e){const{z:t,bounds:r}=e,o=this._imgSources.filter(l=>t>=l.minLevel&&this.isBoundsInSource(l,r)).map(async l=>{const c=Ve.getMaterialLoader(l);try{const u=await c.load({source:l,...e}),d=m=>{c.unload&&c.unload(m.target),m.target.removeEventListener("dispose",d)};return u instanceof f.MeshBasicMaterial||u.addEventListener("dispose",d),u}catch(u){return console.error(`[CompositeTileLoader] Material load failed for source ${l.dataType}:`,u),new f.MeshBasicMaterial}});return Promise.all(o)}async loadFromSource(e,t,r){try{const i=await r.load({source:e,...t});return i.addEventListener("dispose",()=>{r.unload&&r.unload(i)}),i}catch(i){return console.error(`[CompositeTileLoader] Geometry load failed for source ${e.dataType}:`,i),new f.PlaneGeometry}}isBoundsInSource(e,t){const[r,i,o,l]=e._projectionBounds,[c,u,d,m]=t;return!(d<r||m<i||c>o||u>l)}}const lu=`(function(){"use strict";class s{static parse(t){return s.getDEMFromImage(t.data)}static getDEMFromImage(t){function c(e,g){const a=g*4,[i,u,l,m]=e.slice(a,a+4);return m===0?0:-1e4+(i<<16|u<<8|l)*.1}const n=t.length>>>2,r=new Float32Array(n);for(let e=0;e<n;e++)r[e]=c(t,e);return r}}self.onmessage=o=>{const t=s.parse(o.data.imgData);self.postMessage(t)}})();
`,cu=typeof self<"u"&&self.Blob&&new Blob(["(self.URL || self.webkitURL).revokeObjectURL(self.location.href);",lu],{type:"text/javascript;charset=utf-8"});function N0(s){let e;try{if(e=cu&&(self.URL||self.webkitURL).createObjectURL(cu),!e)throw"";const t=new Worker(e,{name:s?.name});return t.addEventListener("error",()=>{(self.URL||self.webkitURL).revokeObjectURL(e)}),t}catch{return new Worker("data:text/javascript;charset=utf-8,"+encodeURIComponent(lu),{name:s?.name})}}var R0=Object.defineProperty,W0=(s,e,t)=>e in s?R0(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,As=(s,e,t)=>W0(s,typeof e!="symbol"?e+"":e,t);const G0=10;class uu extends ua{constructor(){super(),As(this,"info",{version:"1.0.0",description:"Mapbox-RGB terrain loader for loading elevation data encoded in RGB textures."}),As(this,"dataType","terrain-rgb"),As(this,"imageLoader",new f.ImageLoader(Ve.manager)),As(this,"workerPool",new ta(0)),this.workerPool.setWorkerCreator(()=>new N0)}async performLoad(e,t){const r=await this.imageLoader.loadAsync(e).catch(()=>new Image),i=f.MathUtils.clamp((t.z+2)*3,2,64),o=this.extractSubImageData(r,t.bounds,i);this.workerPool.pool===0&&this.workerPool.setWorkerLimit(G0);const c=(await this.workerPool.postMessage({imgData:o},[o.data.buffer])).data,u=new Ri;return u.setTerrainData(c),u}extractSubImageData(e,t,r){const i=On.getBoundsCoord(t,e.width),o=Math.min(r,i.sw),c=new OffscreenCanvas(o,o).getContext("2d");return c.imageSmoothingEnabled=!1,c.drawImage(e,i.sx,i.sy,i.sw,i.sh,0,0,o,o),c.getImageData(0,0,o,o)}}const hu='(function(){"use strict";const P=23283064365386963e-26,M=12,S=typeof TextDecoder>"u"?null:new TextDecoder("utf-8"),g=0,y=1,F=2,p=5;class E{constructor(t=new Uint8Array(16)){this.buf=ArrayBuffer.isView(t)?t:new Uint8Array(t),this.dataView=new DataView(this.buf.buffer),this.pos=0,this.type=0,this.length=this.buf.length}readFields(t,e,r=this.length){for(;this.pos<r;){const s=this.readVarint(),n=s>>3,o=this.pos;this.type=s&7,t(n,e,this),this.pos===o&&this.skip(s)}return e}readMessage(t,e){return this.readFields(t,e,this.readVarint()+this.pos)}readFixed32(){const t=this.dataView.getUint32(this.pos,!0);return this.pos+=4,t}readSFixed32(){const t=this.dataView.getInt32(this.pos,!0);return this.pos+=4,t}readFixed64(){const t=this.dataView.getUint32(this.pos,!0)+this.dataView.getUint32(this.pos+4,!0)*4294967296;return this.pos+=8,t}readSFixed64(){const t=this.dataView.getUint32(this.pos,!0)+this.dataView.getInt32(this.pos+4,!0)*4294967296;return this.pos+=8,t}readFloat(){const t=this.dataView.getFloat32(this.pos,!0);return this.pos+=4,t}readDouble(){const t=this.dataView.getFloat64(this.pos,!0);return this.pos+=8,t}readVarint(t){const e=this.buf;let r,s;return s=e[this.pos++],r=s&127,s<128||(s=e[this.pos++],r|=(s&127)<<7,s<128)||(s=e[this.pos++],r|=(s&127)<<14,s<128)||(s=e[this.pos++],r|=(s&127)<<21,s<128)?r:(s=e[this.pos],r|=(s&15)<<28,B(r,t,this))}readVarint64(){return this.readVarint(!0)}readSVarint(){const t=this.readVarint();return t%2===1?(t+1)/-2:t/2}readBoolean(){return!!this.readVarint()}readString(){const t=this.readVarint()+this.pos,e=this.pos;return this.pos=t,t-e>=M&&S?S.decode(this.buf.subarray(e,t)):q(this.buf,e,t)}readBytes(){const t=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,t);return this.pos=t,e}readPackedVarint(t=[],e){const r=this.readPackedEnd();for(;this.pos<r;)t.push(this.readVarint(e));return t}readPackedSVarint(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readSVarint());return t}readPackedBoolean(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readBoolean());return t}readPackedFloat(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readFloat());return t}readPackedDouble(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readDouble());return t}readPackedFixed32(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readFixed32());return t}readPackedSFixed32(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readSFixed32());return t}readPackedFixed64(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readFixed64());return t}readPackedSFixed64(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readSFixed64());return t}readPackedEnd(){return this.type===F?this.readVarint()+this.pos:this.pos+1}skip(t){const e=t&7;if(e===g)for(;this.buf[this.pos++]>127;);else if(e===F)this.pos=this.readVarint()+this.pos;else if(e===p)this.pos+=4;else if(e===y)this.pos+=8;else throw new Error(`Unimplemented type: ${e}`)}writeTag(t,e){this.writeVarint(t<<3|e)}realloc(t){let e=this.length||16;for(;e<this.pos+t;)e*=2;if(e!==this.length){const r=new Uint8Array(e);r.set(this.buf),this.buf=r,this.dataView=new DataView(r.buffer),this.length=e}}finish(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)}writeFixed32(t){this.realloc(4),this.dataView.setInt32(this.pos,t,!0),this.pos+=4}writeSFixed32(t){this.realloc(4),this.dataView.setInt32(this.pos,t,!0),this.pos+=4}writeFixed64(t){this.realloc(8),this.dataView.setInt32(this.pos,t&-1,!0),this.dataView.setInt32(this.pos+4,Math.floor(t*P),!0),this.pos+=8}writeSFixed64(t){this.realloc(8),this.dataView.setInt32(this.pos,t&-1,!0),this.dataView.setInt32(this.pos+4,Math.floor(t*P),!0),this.pos+=8}writeVarint(t){if(t=+t||0,t>268435455||t<0){T(t,this);return}this.realloc(4),this.buf[this.pos++]=t&127|(t>127?128:0),!(t<=127)&&(this.buf[this.pos++]=(t>>>=7)&127|(t>127?128:0),!(t<=127)&&(this.buf[this.pos++]=(t>>>=7)&127|(t>127?128:0),!(t<=127)&&(this.buf[this.pos++]=t>>>7&127)))}writeSVarint(t){this.writeVarint(t<0?-t*2-1:t*2)}writeBoolean(t){this.writeVarint(+t)}writeString(t){t=String(t),this.realloc(t.length*4),this.pos++;const e=this.pos;this.pos=O(this.buf,t,this.pos);const r=this.pos-e;r>=128&&k(e,r,this),this.pos=e-1,this.writeVarint(r),this.pos+=r}writeFloat(t){this.realloc(4),this.dataView.setFloat32(this.pos,t,!0),this.pos+=4}writeDouble(t){this.realloc(8),this.dataView.setFloat64(this.pos,t,!0),this.pos+=8}writeBytes(t){const e=t.length;this.writeVarint(e),this.realloc(e);for(let r=0;r<e;r++)this.buf[this.pos++]=t[r]}writeRawMessage(t,e){this.pos++;const r=this.pos;t(e,this);const s=this.pos-r;s>=128&&k(r,s,this),this.pos=r-1,this.writeVarint(s),this.pos+=s}writeMessage(t,e,r){this.writeTag(t,F),this.writeRawMessage(e,r)}writePackedVarint(t,e){e.length&&this.writeMessage(t,C,e)}writePackedSVarint(t,e){e.length&&this.writeMessage(t,L,e)}writePackedBoolean(t,e){e.length&&this.writeMessage(t,U,e)}writePackedFloat(t,e){e.length&&this.writeMessage(t,A,e)}writePackedDouble(t,e){e.length&&this.writeMessage(t,v,e)}writePackedFixed32(t,e){e.length&&this.writeMessage(t,N,e)}writePackedSFixed32(t,e){e.length&&this.writeMessage(t,G,e)}writePackedFixed64(t,e){e.length&&this.writeMessage(t,H,e)}writePackedSFixed64(t,e){e.length&&this.writeMessage(t,R,e)}writeBytesField(t,e){this.writeTag(t,F),this.writeBytes(e)}writeFixed32Field(t,e){this.writeTag(t,p),this.writeFixed32(e)}writeSFixed32Field(t,e){this.writeTag(t,p),this.writeSFixed32(e)}writeFixed64Field(t,e){this.writeTag(t,y),this.writeFixed64(e)}writeSFixed64Field(t,e){this.writeTag(t,y),this.writeSFixed64(e)}writeVarintField(t,e){this.writeTag(t,g),this.writeVarint(e)}writeSVarintField(t,e){this.writeTag(t,g),this.writeSVarint(e)}writeStringField(t,e){this.writeTag(t,F),this.writeString(e)}writeFloatField(t,e){this.writeTag(t,p),this.writeFloat(e)}writeDoubleField(t,e){this.writeTag(t,y),this.writeDouble(e)}writeBooleanField(t,e){this.writeVarintField(t,+e)}}function B(i,t,e){const r=e.buf;let s,n;if(n=r[e.pos++],s=(n&112)>>4,n<128||(n=r[e.pos++],s|=(n&127)<<3,n<128)||(n=r[e.pos++],s|=(n&127)<<10,n<128)||(n=r[e.pos++],s|=(n&127)<<17,n<128)||(n=r[e.pos++],s|=(n&127)<<24,n<128)||(n=r[e.pos++],s|=(n&1)<<31,n<128))return w(i,s,t);throw new Error("Expected varint not more than 10 bytes")}function w(i,t,e){return e?t*4294967296+(i>>>0):(t>>>0)*4294967296+(i>>>0)}function T(i,t){let e,r;if(i>=0?(e=i%4294967296|0,r=i/4294967296|0):(e=~(-i%4294967296),r=~(-i/4294967296),e^4294967295?e=e+1|0:(e=0,r=r+1|0)),i>=18446744073709552e3||i<-18446744073709552e3)throw new Error("Given varint doesn\'t fit into 10 bytes");t.realloc(10),D(e,r,t),I(r,t)}function D(i,t,e){e.buf[e.pos++]=i&127|128,i>>>=7,e.buf[e.pos++]=i&127|128,i>>>=7,e.buf[e.pos++]=i&127|128,i>>>=7,e.buf[e.pos++]=i&127|128,i>>>=7,e.buf[e.pos]=i&127}function I(i,t){const e=(i&7)<<4;t.buf[t.pos++]|=e|((i>>>=3)?128:0),i&&(t.buf[t.pos++]=i&127|((i>>>=7)?128:0),i&&(t.buf[t.pos++]=i&127|((i>>>=7)?128:0),i&&(t.buf[t.pos++]=i&127|((i>>>=7)?128:0),i&&(t.buf[t.pos++]=i&127|((i>>>=7)?128:0),i&&(t.buf[t.pos++]=i&127)))))}function k(i,t,e){const r=t<=16383?1:t<=2097151?2:t<=268435455?3:Math.floor(Math.log(t)/(Math.LN2*7));e.realloc(r);for(let s=e.pos-1;s>=i;s--)e.buf[s+r]=e.buf[s]}function C(i,t){for(let e=0;e<i.length;e++)t.writeVarint(i[e])}function L(i,t){for(let e=0;e<i.length;e++)t.writeSVarint(i[e])}function A(i,t){for(let e=0;e<i.length;e++)t.writeFloat(i[e])}function v(i,t){for(let e=0;e<i.length;e++)t.writeDouble(i[e])}function U(i,t){for(let e=0;e<i.length;e++)t.writeBoolean(i[e])}function N(i,t){for(let e=0;e<i.length;e++)t.writeFixed32(i[e])}function G(i,t){for(let e=0;e<i.length;e++)t.writeSFixed32(i[e])}function H(i,t){for(let e=0;e<i.length;e++)t.writeFixed64(i[e])}function R(i,t){for(let e=0;e<i.length;e++)t.writeSFixed64(i[e])}function q(i,t,e){let r="",s=t;for(;s<e;){const n=i[s];let o=null,h=n>239?4:n>223?3:n>191?2:1;if(s+h>e)break;let a,d,l;h===1?n<128&&(o=n):h===2?(a=i[s+1],(a&192)===128&&(o=(n&31)<<6|a&63,o<=127&&(o=null))):h===3?(a=i[s+1],d=i[s+2],(a&192)===128&&(d&192)===128&&(o=(n&15)<<12|(a&63)<<6|d&63,(o<=2047||o>=55296&&o<=57343)&&(o=null))):h===4&&(a=i[s+1],d=i[s+2],l=i[s+3],(a&192)===128&&(d&192)===128&&(l&192)===128&&(o=(n&15)<<18|(a&63)<<12|(d&63)<<6|l&63,(o<=65535||o>=1114112)&&(o=null))),o===null?(o=65533,h=1):o>65535&&(o-=65536,r+=String.fromCharCode(o>>>10&1023|55296),o=56320|o&1023),r+=String.fromCharCode(o),s+=h}return r}function O(i,t,e){for(let r=0,s,n;r<t.length;r++){if(s=t.charCodeAt(r),s>55295&&s<57344)if(n)if(s<56320){i[e++]=239,i[e++]=191,i[e++]=189,n=s;continue}else s=n-55296<<10|s-56320|65536,n=null;else{s>56319||r+1===t.length?(i[e++]=239,i[e++]=191,i[e++]=189):n=s;continue}else n&&(i[e++]=239,i[e++]=191,i[e++]=189,n=null);s<128?i[e++]=s:(s<2048?i[e++]=s>>6|192:(s<65536?i[e++]=s>>12|224:(i[e++]=s>>18|240,i[e++]=s>>12&63|128),i[e++]=s>>6&63|128),i[e++]=s&63|128)}return e}function f(i,t){this.x=i,this.y=t}f.prototype={clone(){return new f(this.x,this.y)},add(i){return this.clone()._add(i)},sub(i){return this.clone()._sub(i)},multByPoint(i){return this.clone()._multByPoint(i)},divByPoint(i){return this.clone()._divByPoint(i)},mult(i){return this.clone()._mult(i)},div(i){return this.clone()._div(i)},rotate(i){return this.clone()._rotate(i)},rotateAround(i,t){return this.clone()._rotateAround(i,t)},matMult(i){return this.clone()._matMult(i)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(i){return this.x===i.x&&this.y===i.y},dist(i){return Math.sqrt(this.distSqr(i))},distSqr(i){const t=i.x-this.x,e=i.y-this.y;return t*t+e*e},angle(){return Math.atan2(this.y,this.x)},angleTo(i){return Math.atan2(this.y-i.y,this.x-i.x)},angleWith(i){return this.angleWithSep(i.x,i.y)},angleWithSep(i,t){return Math.atan2(this.x*t-this.y*i,this.x*i+this.y*t)},_matMult(i){const t=i[0]*this.x+i[1]*this.y,e=i[2]*this.x+i[3]*this.y;return this.x=t,this.y=e,this},_add(i){return this.x+=i.x,this.y+=i.y,this},_sub(i){return this.x-=i.x,this.y-=i.y,this},_mult(i){return this.x*=i,this.y*=i,this},_div(i){return this.x/=i,this.y/=i,this},_multByPoint(i){return this.x*=i.x,this.y*=i.y,this},_divByPoint(i){return this.x/=i.x,this.y/=i.y,this},_unit(){return this._div(this.mag()),this},_perp(){const i=this.y;return this.y=this.x,this.x=-i,this},_rotate(i){const t=Math.cos(i),e=Math.sin(i),r=t*this.x-e*this.y,s=e*this.x+t*this.y;return this.x=r,this.y=s,this},_rotateAround(i,t){const e=Math.cos(i),r=Math.sin(i),s=t.x+e*(this.x-t.x)-r*(this.y-t.y),n=t.y+r*(this.x-t.x)+e*(this.y-t.y);return this.x=s,this.y=n,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:f},f.convert=function(i){if(i instanceof f)return i;if(Array.isArray(i))return new f(+i[0],+i[1]);if(i.x!==void 0&&i.y!==void 0)return new f(+i.x,+i.y);throw new Error("Expected [x, y] or {x, y} point format")};class m{constructor(t,e,r,s,n){this.properties={},this.extent=r,this.type=0,this.id=void 0,this._pbf=t,this._geometry=-1,this._keys=s,this._values=n,t.readFields(j,this,e)}loadGeometry(){const t=this._pbf;t.pos=this._geometry;const e=t.readVarint()+t.pos,r=[];let s,n=1,o=0,h=0,a=0;for(;t.pos<e;){if(o<=0){const d=t.readVarint();n=d&7,o=d>>3}if(o--,n===1||n===2)h+=t.readSVarint(),a+=t.readSVarint(),n===1&&(s&&r.push(s),s=[]),s&&s.push(new f(h,a));else if(n===7)s&&s.push(s[0].clone());else throw new Error(`unknown command ${n}`)}return s&&r.push(s),r}bbox(){const t=this._pbf;t.pos=this._geometry;const e=t.readVarint()+t.pos;let r=1,s=0,n=0,o=0,h=1/0,a=-1/0,d=1/0,l=-1/0;for(;t.pos<e;){if(s<=0){const x=t.readVarint();r=x&7,s=x>>3}if(s--,r===1||r===2)n+=t.readSVarint(),o+=t.readSVarint(),n<h&&(h=n),n>a&&(a=n),o<d&&(d=o),o>l&&(l=o);else if(r!==7)throw new Error(`unknown command ${r}`)}return[h,d,a,l]}toGeoJSON(t,e,r){const s=this.extent*Math.pow(2,r),n=this.extent*t,o=this.extent*e,h=this.loadGeometry();function a(u){return[(u.x+n)*360/s-180,360/Math.PI*Math.atan(Math.exp((1-(u.y+o)*2/s)*Math.PI))-90]}function d(u){return u.map(a)}let l;if(this.type===1){const u=[];for(const _ of h)u.push(_[0]);const c=d(u);l=u.length===1?{type:"Point",coordinates:c[0]}:{type:"MultiPoint",coordinates:c}}else if(this.type===2){const u=h.map(d);l=u.length===1?{type:"LineString",coordinates:u[0]}:{type:"MultiLineString",coordinates:u}}else if(this.type===3){const u=W(h),c=[];for(const _ of u)c.push(_.map(d));l=c.length===1?{type:"Polygon",coordinates:c[0]}:{type:"MultiPolygon",coordinates:c}}else throw new Error("unknown feature type");const x={type:"Feature",geometry:l,properties:this.properties};return this.id!=null&&(x.id=this.id),x}}m.types=["Unknown","Point","LineString","Polygon"];function j(i,t,e){i===1?t.id=e.readVarint():i===2?J(e,t):i===3?t.type=e.readVarint():i===4&&(t._geometry=e.pos)}function J(i,t){const e=i.readVarint()+i.pos;for(;i.pos<e;){const r=t._keys[i.readVarint()],s=t._values[i.readVarint()];t.properties[r]=s}}function W(i){const t=i.length;if(t<=1)return[i];const e=[];let r,s;for(let n=0;n<t;n++){const o=X(i[n]);o!==0&&(s===void 0&&(s=o<0),s===o<0?(r&&e.push(r),r=[i[n]]):r&&r.push(i[n]))}return r&&e.push(r),e}function X(i){let t=0;for(let e=0,r=i.length,s=r-1,n,o;e<r;s=e++)n=i[e],o=i[s],t+=(o.x-n.x)*(n.y+o.y);return t}class ${constructor(t,e){this.version=1,this.name="",this.extent=4096,this.length=0,this._pbf=t,this._keys=[],this._values=[],this._features=[],t.readFields(b,this,e),this.length=this._features.length}feature(t){if(t<0||t>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[t];const e=this._pbf.readVarint()+this._pbf.pos;return new m(this._pbf,e,this.extent,this._keys,this._values)}}function b(i,t,e){i===15?t.version=e.readVarint():i===1?t.name=e.readString():i===5?t.extent=e.readVarint():i===2?t._features.push(e.pos):i===3?t._keys.push(e.readString()):i===4&&t._values.push(z(e))}function z(i){let t=null;const e=i.readVarint()+i.pos;for(;i.pos<e;){const r=i.readVarint()>>3;t=r===1?i.readString():r===2?i.readFloat():r===3?i.readDouble():r===4?i.readVarint64():r===5?i.readVarint():r===6?i.readSVarint():r===7?i.readBoolean():null}if(t==null)throw new Error("unknown feature value");return t}class Y{constructor(t,e){this.layers=t.readFields(K,{},e)}}function K(i,t,e){if(i===3){const r=new $(e,e.readVarint()+e.pos);r.length&&(t[r.name]=r)}}class V{static async parse(t,e,r,s){try{const n=V.mvt2GeoJSON(t,e,r,s);return{x:e,y:r,z:s,layers:n,timestamp:Date.now(),dataFormat:"mvt"}}catch(n){throw console.error("[MVTParser] Error parsing vector tile data:",n),n}}static mvt2GeoJSON(t,e,r,s){const n=new E(t),o=new Y(n),h={};for(const a in o.layers){const d=o.layers[a],l=[];for(let x=0;x<d.length;x++){const c=d.feature(x).toGeoJSON(e,r,s);l.push(c)}h[a]=l}return h}}self.onmessage=async i=>{const t=i.data;try{const e=await V.parse(t.arrayBuffer,t.x,t.y,t.z);self.postMessage(e)}catch(e){console.error("Worker MVT Parse Failed:",e),self.postMessage({error:e.message})}}})();\n',fu=typeof self<"u"&&self.Blob&&new Blob(["(self.URL || self.webkitURL).revokeObjectURL(self.location.href);",hu],{type:"text/javascript;charset=utf-8"});function $0(s){let e;try{if(e=fu&&(self.URL||self.webkitURL).createObjectURL(fu),!e)throw"";const t=new Worker(e,{name:s?.name});return t.addEventListener("error",()=>{(self.URL||self.webkitURL).revokeObjectURL(e)}),t}catch{return new Worker("data:text/javascript;charset=utf-8,"+encodeURIComponent(hu),{name:s?.name})}}var j0=Object.defineProperty,X0=(s,e,t)=>e in s?j0(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ps=(s,e,t)=>X0(s,typeof e!="symbol"?e+"":e,t);const Y0=10;class du{constructor(){Ps(this,"info",{version:"2.0.0",description:"Mapbox Vector Tile Geometry Loader (Refactored)"}),Ps(this,"dataType","vector-tile"),Ps(this,"fileLoader",new f.FileLoader(Ve.manager)),Ps(this,"_workerPool",new ta(0)),this.fileLoader.setResponseType("arraybuffer"),this._workerPool.setWorkerCreator(()=>new $0)}async load(e){const{source:t,x:r,y:i,z:o}=e,l=typeof t._getUrl=="function"?t._getUrl(r,i,o):this.buildTileUrl(t.url,r,i,o);if(!l)return this.createErrorGeometry(r,i,o,new Error("Source returned empty URL"));this._workerPool.pool===0&&this._workerPool.setWorkerLimit(Y0);try{const c=await this.fetchVectorData(l),u={arrayBuffer:c,x:r,y:i,z:o},m=(await this._workerPool.postMessage(u,[c])).data;if(m.error)throw new Error(m.error);const p=this.createGeometryWithVectorData(m,e);return Ve.manager.parseEnd(l),p}catch(c){return this.createErrorGeometry(r,i,o,c)}}async fetchVectorData(e){try{const t=await this.fileLoader.loadAsync(e);if(!t||t.byteLength===0)throw new Error("Empty response");return t}catch(t){throw new Error(`Failed to fetch vector tile: ${t.message}`)}}buildTileUrl(e,t,r,i){return e?e.replace("{x}",t.toString()).replace("{y}",r.toString()).replace("{z}",i.toString()).replace("{-y}",(Math.pow(2,i)-1-r).toString()):""}createGeometryWithVectorData(e,t){const r=new Ri;return r.userData={vectorData:e,tileInfo:{x:t.x,y:t.y,z:t.z,bounds:t.bounds},metadata:{dataType:this.dataType,version:this.info.version,loadedAt:Date.now()}},r}createErrorGeometry(e,t,r,i){const o=new Ri,l=4007501668557849e-8/Math.pow(2,r);return o.userData={vectorData:{x:e,y:t,z:r,layers:{},totalFeatures:0,bounds:{world:{x:l,y:l}},error:i.message||"Unknown error",timestamp:Date.now(),dataFormat:"error"},tileInfo:{x:e,y:t,z:r,bounds:[0,0,0,0]},metadata:{dataType:"vector-tile-error",error:!0,errorMessage:i.message}},o}unload(e){e.userData?.vectorData&&(e.userData.vectorData=null),e.dispose()}}function $r(s,e){this.x=s,this.y=e}$r.prototype={clone(){return new $r(this.x,this.y)},add(s){return this.clone()._add(s)},sub(s){return this.clone()._sub(s)},multByPoint(s){return this.clone()._multByPoint(s)},divByPoint(s){return this.clone()._divByPoint(s)},mult(s){return this.clone()._mult(s)},div(s){return this.clone()._div(s)},rotate(s){return this.clone()._rotate(s)},rotateAround(s,e){return this.clone()._rotateAround(s,e)},matMult(s){return this.clone()._matMult(s)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(s){return this.x===s.x&&this.y===s.y},dist(s){return Math.sqrt(this.distSqr(s))},distSqr(s){const e=s.x-this.x,t=s.y-this.y;return e*e+t*t},angle(){return Math.atan2(this.y,this.x)},angleTo(s){return Math.atan2(this.y-s.y,this.x-s.x)},angleWith(s){return this.angleWithSep(s.x,s.y)},angleWithSep(s,e){return Math.atan2(this.x*e-this.y*s,this.x*s+this.y*e)},_matMult(s){const e=s[0]*this.x+s[1]*this.y,t=s[2]*this.x+s[3]*this.y;return this.x=e,this.y=t,this},_add(s){return this.x+=s.x,this.y+=s.y,this},_sub(s){return this.x-=s.x,this.y-=s.y,this},_mult(s){return this.x*=s,this.y*=s,this},_div(s){return this.x/=s,this.y/=s,this},_multByPoint(s){return this.x*=s.x,this.y*=s.y,this},_divByPoint(s){return this.x/=s.x,this.y/=s.y,this},_unit(){return this._div(this.mag()),this},_perp(){const s=this.y;return this.y=this.x,this.x=-s,this},_rotate(s){const e=Math.cos(s),t=Math.sin(s),r=e*this.x-t*this.y,i=t*this.x+e*this.y;return this.x=r,this.y=i,this},_rotateAround(s,e){const t=Math.cos(s),r=Math.sin(s),i=e.x+t*(this.x-e.x)-r*(this.y-e.y),o=e.y+r*(this.x-e.x)+t*(this.y-e.y);return this.x=i,this.y=o,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:$r},$r.convert=function(s){if(s instanceof $r)return s;if(Array.isArray(s))return new $r(+s[0],+s[1]);if(s.x!==void 0&&s.y!==void 0)return new $r(+s.x,+s.y);throw new Error("Expected [x, y] or {x, y} point format")};class pu{constructor(e,t,r,i,o){this.properties={},this.extent=r,this.type=0,this.id=void 0,this._pbf=e,this._geometry=-1,this._keys=i,this._values=o,e.readFields(Z0,this,t)}loadGeometry(){const e=this._pbf;e.pos=this._geometry;const t=e.readVarint()+e.pos,r=[];let i,o=1,l=0,c=0,u=0;for(;e.pos<t;){if(l<=0){const d=e.readVarint();o=d&7,l=d>>3}if(l--,o===1||o===2)c+=e.readSVarint(),u+=e.readSVarint(),o===1&&(i&&r.push(i),i=[]),i&&i.push(new $r(c,u));else if(o===7)i&&i.push(i[0].clone());else throw new Error(`unknown command ${o}`)}return i&&r.push(i),r}bbox(){const e=this._pbf;e.pos=this._geometry;const t=e.readVarint()+e.pos;let r=1,i=0,o=0,l=0,c=1/0,u=-1/0,d=1/0,m=-1/0;for(;e.pos<t;){if(i<=0){const p=e.readVarint();r=p&7,i=p>>3}if(i--,r===1||r===2)o+=e.readSVarint(),l+=e.readSVarint(),o<c&&(c=o),o>u&&(u=o),l<d&&(d=l),l>m&&(m=l);else if(r!==7)throw new Error(`unknown command ${r}`)}return[c,d,u,m]}toGeoJSON(e,t,r){const i=this.extent*Math.pow(2,r),o=this.extent*e,l=this.extent*t,c=this.loadGeometry();function u(_){return[(_.x+o)*360/i-180,360/Math.PI*Math.atan(Math.exp((1-(_.y+l)*2/i)*Math.PI))-90]}function d(_){return _.map(u)}let m;if(this.type===1){const _=[];for(const M of c)_.push(M[0]);const v=d(_);m=_.length===1?{type:"Point",coordinates:v[0]}:{type:"MultiPoint",coordinates:v}}else if(this.type===2){const _=c.map(d);m=_.length===1?{type:"LineString",coordinates:_[0]}:{type:"MultiLineString",coordinates:_}}else if(this.type===3){const _=q0(c),v=[];for(const M of _)v.push(M.map(d));m=v.length===1?{type:"Polygon",coordinates:v[0]}:{type:"MultiPolygon",coordinates:v}}else throw new Error("unknown feature type");const p={type:"Feature",geometry:m,properties:this.properties};return this.id!=null&&(p.id=this.id),p}}pu.types=["Unknown","Point","LineString","Polygon"];function Z0(s,e,t){s===1?e.id=t.readVarint():s===2?K0(t,e):s===3?e.type=t.readVarint():s===4&&(e._geometry=t.pos)}function K0(s,e){const t=s.readVarint()+s.pos;for(;s.pos<t;){const r=e._keys[s.readVarint()],i=e._values[s.readVarint()];e.properties[r]=i}}function q0(s){const e=s.length;if(e<=1)return[s];const t=[];let r,i;for(let o=0;o<e;o++){const l=Q0(s[o]);l!==0&&(i===void 0&&(i=l<0),i===l<0?(r&&t.push(r),r=[s[o]]):r&&r.push(s[o]))}return r&&t.push(r),t}function Q0(s){let e=0;for(let t=0,r=s.length,i=r-1,o,l;t<r;i=t++)o=s[t],l=s[i],e+=(l.x-o.x)*(o.y+l.y);return e}let E0=class{constructor(e,t){this.version=1,this.name="",this.extent=4096,this.length=0,this._pbf=e,this._keys=[],this._values=[],this._features=[],e.readFields(J0,this,t),this.length=this._features.length}feature(e){if(e<0||e>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[e];const t=this._pbf.readVarint()+this._pbf.pos;return new pu(this._pbf,t,this.extent,this._keys,this._values)}};function J0(s,e,t){s===15?e.version=t.readVarint():s===1?e.name=t.readString():s===5?e.extent=t.readVarint():s===2?e._features.push(t.pos):s===3?e._keys.push(t.readString()):s===4&&e._values.push(H0(t))}function H0(s){let e=null;const t=s.readVarint()+s.pos;for(;s.pos<t;){const r=s.readVarint()>>3;e=r===1?s.readString():r===2?s.readFloat():r===3?s.readDouble():r===4?s.readVarint64():r===5?s.readVarint():r===6?s.readSVarint():r===7?s.readBoolean():null}if(e==null)throw new Error("unknown feature value");return e}class ey{constructor(e,t){this.layers=e.readFields(ty,{},t)}}function ty(s,e,t){if(s===3){const r=new E0(t,t.readVarint()+t.pos);r.length&&(e[r.name]=r)}}const ha=65536*65536,mu=1/ha,ry=12,gu=typeof TextDecoder>"u"?null:new TextDecoder("utf-8"),fa=0,Ls=1,Tn=2,Cs=5;class iy{constructor(e=new Uint8Array(16)){this.buf=ArrayBuffer.isView(e)?e:new Uint8Array(e),this.dataView=new DataView(this.buf.buffer),this.pos=0,this.type=0,this.length=this.buf.length}readFields(e,t,r=this.length){for(;this.pos<r;){const i=this.readVarint(),o=i>>3,l=this.pos;this.type=i&7,e(o,t,this),this.pos===l&&this.skip(i)}return t}readMessage(e,t){return this.readFields(e,t,this.readVarint()+this.pos)}readFixed32(){const e=this.dataView.getUint32(this.pos,!0);return this.pos+=4,e}readSFixed32(){const e=this.dataView.getInt32(this.pos,!0);return this.pos+=4,e}readFixed64(){const e=this.dataView.getUint32(this.pos,!0)+this.dataView.getUint32(this.pos+4,!0)*ha;return this.pos+=8,e}readSFixed64(){const e=this.dataView.getUint32(this.pos,!0)+this.dataView.getInt32(this.pos+4,!0)*ha;return this.pos+=8,e}readFloat(){const e=this.dataView.getFloat32(this.pos,!0);return this.pos+=4,e}readDouble(){const e=this.dataView.getFloat64(this.pos,!0);return this.pos+=8,e}readVarint(e){const t=this.buf;let r,i;return i=t[this.pos++],r=i&127,i<128||(i=t[this.pos++],r|=(i&127)<<7,i<128)||(i=t[this.pos++],r|=(i&127)<<14,i<128)||(i=t[this.pos++],r|=(i&127)<<21,i<128)?r:(i=t[this.pos],r|=(i&15)<<28,ny(r,e,this))}readVarint64(){return this.readVarint(!0)}readSVarint(){const e=this.readVarint();return e%2===1?(e+1)/-2:e/2}readBoolean(){return!!this.readVarint()}readString(){const e=this.readVarint()+this.pos,t=this.pos;return this.pos=e,e-t>=ry&&gu?gu.decode(this.buf.subarray(t,e)):_y(this.buf,t,e)}readBytes(){const e=this.readVarint()+this.pos,t=this.buf.subarray(this.pos,e);return this.pos=e,t}readPackedVarint(e=[],t){const r=this.readPackedEnd();for(;this.pos<r;)e.push(this.readVarint(t));return e}readPackedSVarint(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readSVarint());return e}readPackedBoolean(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readBoolean());return e}readPackedFloat(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readFloat());return e}readPackedDouble(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readDouble());return e}readPackedFixed32(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readFixed32());return e}readPackedSFixed32(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readSFixed32());return e}readPackedFixed64(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readFixed64());return e}readPackedSFixed64(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readSFixed64());return e}readPackedEnd(){return this.type===Tn?this.readVarint()+this.pos:this.pos+1}skip(e){const t=e&7;if(t===fa)for(;this.buf[this.pos++]>127;);else if(t===Tn)this.pos=this.readVarint()+this.pos;else if(t===Cs)this.pos+=4;else if(t===Ls)this.pos+=8;else throw new Error(`Unimplemented type: ${t}`)}writeTag(e,t){this.writeVarint(e<<3|t)}realloc(e){let t=this.length||16;for(;t<this.pos+e;)t*=2;if(t!==this.length){const r=new Uint8Array(t);r.set(this.buf),this.buf=r,this.dataView=new DataView(r.buffer),this.length=t}}finish(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)}writeFixed32(e){this.realloc(4),this.dataView.setInt32(this.pos,e,!0),this.pos+=4}writeSFixed32(e){this.realloc(4),this.dataView.setInt32(this.pos,e,!0),this.pos+=4}writeFixed64(e){this.realloc(8),this.dataView.setInt32(this.pos,e&-1,!0),this.dataView.setInt32(this.pos+4,Math.floor(e*mu),!0),this.pos+=8}writeSFixed64(e){this.realloc(8),this.dataView.setInt32(this.pos,e&-1,!0),this.dataView.setInt32(this.pos+4,Math.floor(e*mu),!0),this.pos+=8}writeVarint(e){if(e=+e||0,e>268435455||e<0){sy(e,this);return}this.realloc(4),this.buf[this.pos++]=e&127|(e>127?128:0),!(e<=127)&&(this.buf[this.pos++]=(e>>>=7)&127|(e>127?128:0),!(e<=127)&&(this.buf[this.pos++]=(e>>>=7)&127|(e>127?128:0),!(e<=127)&&(this.buf[this.pos++]=e>>>7&127)))}writeSVarint(e){this.writeVarint(e<0?-e*2-1:e*2)}writeBoolean(e){this.writeVarint(+e)}writeString(e){e=String(e),this.realloc(e.length*4),this.pos++;const t=this.pos;this.pos=yy(this.buf,e,this.pos);const r=this.pos-t;r>=128&&_u(t,r,this),this.pos=t-1,this.writeVarint(r),this.pos+=r}writeFloat(e){this.realloc(4),this.dataView.setFloat32(this.pos,e,!0),this.pos+=4}writeDouble(e){this.realloc(8),this.dataView.setFloat64(this.pos,e,!0),this.pos+=8}writeBytes(e){const t=e.length;this.writeVarint(t),this.realloc(t);for(let r=0;r<t;r++)this.buf[this.pos++]=e[r]}writeRawMessage(e,t){this.pos++;const r=this.pos;e(t,this);const i=this.pos-r;i>=128&&_u(r,i,this),this.pos=r-1,this.writeVarint(i),this.pos+=i}writeMessage(e,t,r){this.writeTag(e,Tn),this.writeRawMessage(t,r)}writePackedVarint(e,t){t.length&&this.writeMessage(e,ly,t)}writePackedSVarint(e,t){t.length&&this.writeMessage(e,cy,t)}writePackedBoolean(e,t){t.length&&this.writeMessage(e,fy,t)}writePackedFloat(e,t){t.length&&this.writeMessage(e,uy,t)}writePackedDouble(e,t){t.length&&this.writeMessage(e,hy,t)}writePackedFixed32(e,t){t.length&&this.writeMessage(e,dy,t)}writePackedSFixed32(e,t){t.length&&this.writeMessage(e,py,t)}writePackedFixed64(e,t){t.length&&this.writeMessage(e,my,t)}writePackedSFixed64(e,t){t.length&&this.writeMessage(e,gy,t)}writeBytesField(e,t){this.writeTag(e,Tn),this.writeBytes(t)}writeFixed32Field(e,t){this.writeTag(e,Cs),this.writeFixed32(t)}writeSFixed32Field(e,t){this.writeTag(e,Cs),this.writeSFixed32(t)}writeFixed64Field(e,t){this.writeTag(e,Ls),this.writeFixed64(t)}writeSFixed64Field(e,t){this.writeTag(e,Ls),this.writeSFixed64(t)}writeVarintField(e,t){this.writeTag(e,fa),this.writeVarint(t)}writeSVarintField(e,t){this.writeTag(e,fa),this.writeSVarint(t)}writeStringField(e,t){this.writeTag(e,Tn),this.writeString(t)}writeFloatField(e,t){this.writeTag(e,Cs),this.writeFloat(t)}writeDoubleField(e,t){this.writeTag(e,Ls),this.writeDouble(t)}writeBooleanField(e,t){this.writeVarintField(e,+t)}}function ny(s,e,t){const r=t.buf;let i,o;if(o=r[t.pos++],i=(o&112)>>4,o<128||(o=r[t.pos++],i|=(o&127)<<3,o<128)||(o=r[t.pos++],i|=(o&127)<<10,o<128)||(o=r[t.pos++],i|=(o&127)<<17,o<128)||(o=r[t.pos++],i|=(o&127)<<24,o<128)||(o=r[t.pos++],i|=(o&1)<<31,o<128))return Gi(s,i,e);throw new Error("Expected varint not more than 10 bytes")}function Gi(s,e,t){return t?e*4294967296+(s>>>0):(e>>>0)*4294967296+(s>>>0)}function sy(s,e){let t,r;if(s>=0?(t=s%4294967296|0,r=s/4294967296|0):(t=~(-s%4294967296),r=~(-s/4294967296),t^4294967295?t=t+1|0:(t=0,r=r+1|0)),s>=18446744073709552e3||s<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");e.realloc(10),oy(t,r,e),ay(r,e)}function oy(s,e,t){t.buf[t.pos++]=s&127|128,s>>>=7,t.buf[t.pos++]=s&127|128,s>>>=7,t.buf[t.pos++]=s&127|128,s>>>=7,t.buf[t.pos++]=s&127|128,s>>>=7,t.buf[t.pos]=s&127}function ay(s,e){const t=(s&7)<<4;e.buf[e.pos++]|=t|((s>>>=3)?128:0),s&&(e.buf[e.pos++]=s&127|((s>>>=7)?128:0),s&&(e.buf[e.pos++]=s&127|((s>>>=7)?128:0),s&&(e.buf[e.pos++]=s&127|((s>>>=7)?128:0),s&&(e.buf[e.pos++]=s&127|((s>>>=7)?128:0),s&&(e.buf[e.pos++]=s&127)))))}function _u(s,e,t){const r=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(Math.LN2*7));t.realloc(r);for(let i=t.pos-1;i>=s;i--)t.buf[i+r]=t.buf[i]}function ly(s,e){for(let t=0;t<s.length;t++)e.writeVarint(s[t])}function cy(s,e){for(let t=0;t<s.length;t++)e.writeSVarint(s[t])}function uy(s,e){for(let t=0;t<s.length;t++)e.writeFloat(s[t])}function hy(s,e){for(let t=0;t<s.length;t++)e.writeDouble(s[t])}function fy(s,e){for(let t=0;t<s.length;t++)e.writeBoolean(s[t])}function dy(s,e){for(let t=0;t<s.length;t++)e.writeFixed32(s[t])}function py(s,e){for(let t=0;t<s.length;t++)e.writeSFixed32(s[t])}function my(s,e){for(let t=0;t<s.length;t++)e.writeFixed64(s[t])}function gy(s,e){for(let t=0;t<s.length;t++)e.writeSFixed64(s[t])}function _y(s,e,t){let r="",i=e;for(;i<t;){const o=s[i];let l=null,c=o>239?4:o>223?3:o>191?2:1;if(i+c>t)break;let u,d,m;c===1?o<128&&(l=o):c===2?(u=s[i+1],(u&192)===128&&(l=(o&31)<<6|u&63,l<=127&&(l=null))):c===3?(u=s[i+1],d=s[i+2],(u&192)===128&&(d&192)===128&&(l=(o&15)<<12|(u&63)<<6|d&63,(l<=2047||l>=55296&&l<=57343)&&(l=null))):c===4&&(u=s[i+1],d=s[i+2],m=s[i+3],(u&192)===128&&(d&192)===128&&(m&192)===128&&(l=(o&15)<<18|(u&63)<<12|(d&63)<<6|m&63,(l<=65535||l>=1114112)&&(l=null))),l===null?(l=65533,c=1):l>65535&&(l-=65536,r+=String.fromCharCode(l>>>10&1023|55296),l=56320|l&1023),r+=String.fromCharCode(l),i+=c}return r}function yy(s,e,t){for(let r=0,i,o;r<e.length;r++){if(i=e.charCodeAt(r),i>55295&&i<57344)if(o)if(i<56320){s[t++]=239,s[t++]=191,s[t++]=189,o=i;continue}else i=o-55296<<10|i-56320|65536,o=null;else{i>56319||r+1===e.length?(s[t++]=239,s[t++]=191,s[t++]=189):o=i;continue}else o&&(s[t++]=239,s[t++]=191,s[t++]=189,o=null);i<128?s[t++]=i:(i<2048?s[t++]=i>>6|192:(i<65536?s[t++]=i>>12|224:(s[t++]=i>>18|240,s[t++]=i>>12&63|128),s[t++]=i>>6&63|128),s[t++]=i&63|128)}return t}var vy=Object.defineProperty,wy=(s,e,t)=>e in s?vy(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Os=(s,e,t)=>wy(s,typeof e!="symbol"?e+"":e,t);class yu extends bs{constructor(){super(),Os(this,"info",{version:"2.0.0",description:"Vector Tile Texture Loader (Refactored)"}),Os(this,"dataType","mvt"),Os(this,"_loader",new f.FileLoader(Ve.manager)),Os(this,"_render",new tu),this._loader.setResponseType("arraybuffer")}async performLoad(e,t){const r=await this._loader.loadAsync(e),i=new ey(new iy(r)),o=t.source.paint,l=this.drawTile(i,o,t.z);return new f.CanvasTexture(l)}drawTile(e,t,r){const l=new OffscreenCanvas(256,256),c=l.getContext("2d");if(!c)throw new Error("Canvas context is not available");if(t)for(const u in t.layer){const d=t.layer[u];if(r<(d.minLevel??1)||r>(d.maxLevel??20))continue;const m=e.layers[u];if(m){const p=256/m.extent;this._renderLayer(c,m,d,p)}}else for(const u in e.layers){const d=e.layers[u],m=256/d.extent;this._renderLayer(c,d,void 0,m)}return l}_renderLayer(e,t,r,i=1){e.save();for(let o=0;o<t.length;o++){const l=t.feature(o);this._renderFeature(e,l,r,i)}e.restore()}_renderFeature(e,t,r={},i=1){const o=[Xe.Unknown,Xe.Point,Xe.Linestring,Xe.Polygon][t.type],l={geometry:t.loadGeometry(),properties:t.properties};this._render.render(e,o,l,r,i)}convertVectorTileToGeoJSON(e){const t=[];for(const r in e.layers){const i=e.layers[r];for(let o=0;o<i.length;o++){const l=i.feature(o),c=[Xe.Unknown,Xe.Point,Xe.Linestring,Xe.Polygon,Xe.Unknown][l.type],u={geometry:l.loadGeometry(),properties:l.properties},d=this._convertToGeoJSONFeature(u,c);d&&(d.properties._layer=r,t.push(d))}}return{type:"FeatureCollection",features:t}}_convertToGeoJSONFeature(e,t){const r=this._convertGeometryToGeoJSON(e.geometry,t);return r?{type:"Feature",geometry:r,properties:e.properties||{},id:e.id}:null}_convertGeometryToGeoJSON(e,t){switch(t){case Xe.Point:return this._convertPointGeometry(e);case Xe.Linestring:return this._convertLineGeometry(e);case Xe.Polygon:return this._convertPolygonGeometry(e);default:return console.warn("Unknown geometry type:",t),null}}_convertPointGeometry(e){const t=[];for(const r of e)for(const i of r)t.push([i.x,i.y]);return t.length===0?null:t.length===1?{type:"Point",coordinates:t[0]}:{type:"MultiPoint",coordinates:t}}_convertLineGeometry(e){const t=[];for(const r of e){const i=[];for(const o of r)i.push([o.x,o.y]);i.length>=2&&t.push(i)}return t.length===0?null:t.length===1?{type:"LineString",coordinates:t[0]}:{type:"MultiLineString",coordinates:t}}_convertPolygonGeometry(e){const t=[];let r=[];for(const i of e){const o=[];for(const l of i)o.push([l.x,l.y]);o.length>=4&&(this._isRingClockwise(o)||r.length===0?(r.length>0&&t.push(r),r=[o]):r.push(o))}return r.length>0&&t.push(r),t.length===0?null:t.length===1?{type:"Polygon",coordinates:t[0]}:{type:"MultiPolygon",coordinates:t}}_isRingClockwise(e){let t=0;for(let r=0;r<e.length-1;r++){const[i,o]=e[r],[l,c]=e[r+1];t+=(l-i)*(c+o)}return t>0}}var by=Object.defineProperty,xy=(s,e,t)=>e in s?by(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,da=(s,e,t)=>xy(s,typeof e!="symbol"?e+"":e,t);class vu extends bs{constructor(){super(...arguments),da(this,"info",{version:"1.0.0",description:"Loader for standard web images (XYZ tiles)."}),da(this,"dataType","image"),da(this,"loader",new f.ImageLoader(Ve.manager))}async performLoad(e,t){const r=await this.loader.loadAsync(e).catch(()=>new Image(1,1)),i=new f.Texture;i.colorSpace=f.SRGBColorSpace;const{bounds:o}=t;return o[2]-o[0]<1||o[3]-o[1]<1?i.image=this.extractSubImage(r,o):i.image=r,i.needsUpdate=!0,i}extractSubImage(e,t){const r=e.width,i=new OffscreenCanvas(r,r),o=i.getContext("2d"),{sx:l,sy:c,sw:u,sh:d}=On.getBoundsCoord(t,r);return o.drawImage(e,l,c,u,d,0,0,r,r),i}}function wu(){Ve.registerMaterialLoader(new vu),Ve.registerMaterialLoader(new yu),Ve.registerGeometryLoader(new uu),Ve.registerGeometryLoader(new au),Ve.registerMeshLoader(new du),console.log("[TileLoaderFactory] Default loaders registered.")}var My=Object.defineProperty,Sy=(s,e,t)=>e in s?My(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,di=(s,e,t)=>Sy(s,typeof e!="symbol"?e+"":e,t);class pa extends Hc{constructor(e,t){if(super(e,t),di(this,"layerType","vector"),di(this,"_tileDataMap",new Map),di(this,"_renderer"),di(this,"_style"),di(this,"_feaList",[]),di(this,"_collision",!1),di(this,"_renderAltitude",0),!t.style)throw new Error("VectorTileLayer must provide style configuration! VectorTileLayer 必须提供样式配置");this._style=t.style,this._collision=t.collision||!1,this._featureFilter=t.featureFilter,this._renderAltitude=t.altitude||0,this._rootTile.setDataOnlyMode(!0),this._setupDataModeAndListenersForChildren(),this._setupLifeCycleListeners()}createLoader(){const e=new Ss;return Array.isArray(this.source)?e.vtSource=this.source[0]:e.vtSource=this.source,e}_setupDataModeAndListenersForChildren(){const e=t=>{t!==this._rootTile&&t.setDataOnlyMode(!0),this._addShownListenerToTile(t),this._addUnloadListenerToTile(t)};this._rootTile.addEventListener("tile-created",t=>{const r=t.tile;e(r)}),this._rootTile.traverse(t=>{t.isTile&&e(t)})}_addShownListenerToTile(e){const t=r=>{const i=r.tile,o=`${i.z}-${i.x}-${i.y}`,l=!!this._renderer,c=this._tileDataMap.get(o);l&&c&&this._renderer.processTileData(i,c.data)};e.addEventListener("tile-shown",t)}_addUnloadListenerToTile(e){const t=r=>{const i=r.tile||r.target,o=`${i.z}-${i.x}-${i.y}`;if(this._renderer)try{this._renderer.removeFeaturesByTileKey(o)}catch{}this._tileDataMap.delete(o)};e.addEventListener("unload",t)}setAltitude(e){return super.setAltitude(0),this._renderAltitude=e,this._renderer&&this._renderer.setAltitude(e),this}getAltitude(){return this._renderAltitude}_addHiddenListenerToTile(e){const t=r=>{const i=r.tile,o=`${i.z}-${i.x}-${i.y}`;if(this._renderer)try{this._renderer.hideFeaturesByTileKey(o)}catch{}};e.addEventListener("tile-hidden",t)}_setupLifeCycleListeners(){this._rootTile.addEventListener("tile-loaded",e=>{const t=e.tile,r=`${t.z}-${t.x}-${t.y}`,i=this.getVectorDataFromTile(t);if(!i){console.warn(`[VectorTileLayer] Tile ${r} loaded but has no vector data.`);return}if(i.vectorData?.dataFormat==="mvt"&&this._tileDataMap.set(r,{data:i,tile:t,timestamp:Date.now(),pending:!1}),t.showing&&this._renderer&&i.vectorData?.dataFormat==="mvt")try{this._renderer.processTileData(t,i)}catch{}})}getVectorDataFromTile(e){return!e.geometry||!e.getVectorData()?null:e.getVectorData()}getVisibleVectorTiles(){const e=[];return this._rootTile.traverse(t=>{if(t.isTile&&t.loaded&&t.inFrustum){const r=`${t.z}-${t.x}-${t.y}`,i=this._tileDataMap.get(r);i&&e.push({tileKey:r,data:i.data,tile:i.tile})}}),e}getAllVectorData(){return new Map(this._tileDataMap)}getVectorData(e,t,r){const i=`${r}-${e}-${t}`,o=this._tileDataMap.get(i);return o?o.data:null}setFeatureFilter(e){this._featureFilter=e,this._renderer&&this._renderer.setFeatureFilter(e)}clearFeatureFilter(){this._featureFilter=void 0,this._renderer&&this._renderer.clearFeatureFilter()}setOpacity(e){this.opacity=e,this._renderer&&this._renderer.setOpacity(e)}update(e){!this.enabled||!this.visible||super.update(e)}dispose(){this._renderer&&this._renderer.dispose(),super.dispose()}_setRenderer(e){this._renderer=e}_getRenderer(){return this._renderer||null}getStyle(){return this._style}}var Ay=Object.defineProperty,Py=(s,e,t)=>e in s?Ay(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ly=(s,e,t)=>Py(s,e+"",t);class bu{constructor(e=0){Ly(this,"_centralMeridian",0),this._centralMeridian=e}get centralMeridian(){return this._centralMeridian}adjustTileXWithCentralMeridian(e,t){const r=Math.pow(2,t),i=Math.round(r/360*this._centralMeridian);let o=e+i;return o>=r?o-=r:o<0&&(o+=r),o}getTileOrigin(e,t,r){const i=Math.pow(2,r),o=this.mapWidth,l=this.mapHeight/2,c=e/i*o-o/2,u=l-t/i*this.mapHeight;return{x:c,y:u}}getProjectedBoundsFromGeoBounds(e){const[t,r,i,o]=e,l=this.forward(t,r),c=this.forward(i,o);return[l.x,l.y,c.x,c.y]}getTileProjectedBounds(e,t,r){const i=this.getTileOrigin(e,t,r),o=this.getTileOrigin(e+1,t+1,r);return[Math.min(i.x,o.x),Math.min(i.y,o.y),Math.max(i.x,o.x),Math.max(i.y,o.y)]}getTileGeoBounds(e,t,r){const[i,o,l,c]=this.getTileProjectedBounds(e,t,r),u=this.inverse(i,o),d=this.inverse(l,c);return[Math.min(u.lon,d.lon),Math.min(u.lat,d.lat),Math.max(u.lon,d.lon),Math.max(u.lat,d.lat)]}}var Cy=Object.defineProperty,Oy=(s,e,t)=>e in s?Cy(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Dn=(s,e,t)=>Oy(s,typeof e!="symbol"?e+"":e,t);const xu=class xo extends bu{constructor(e=0){super(e),Dn(this,"ID","3857"),Dn(this,"mapWidth",2*Math.PI*xo.LEGACY_EARTH_RADIUS),Dn(this,"mapHeight",this.mapWidth),Dn(this,"mapDepth",1)}forward(e,t){const r=Math.PI/180,i=xo.LEGACY_EARTH_RADIUS,o=(e-this.centralMeridian)*r,l=t*r,c=i*o,u=i*Math.log(Math.tan(Math.PI/4+l/2));return{x:c,y:u}}inverse(e,t){const r=180/Math.PI,i=xo.LEGACY_EARTH_RADIUS;let o=e/i*r+this.centralMeridian;o>180&&(o-=360),o<-180&&(o+=360);const c=(2*Math.atan(Math.exp(t/i))-Math.PI/2)*r;return{lon:o,lat:c}}};Dn(xu,"LEGACY_EARTH_RADIUS",6378e3);let Mu=xu;var Ty=Object.defineProperty,Dy=(s,e,t)=>e in s?Ty(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,In=(s,e,t)=>Dy(s,typeof e!="symbol"?e+"":e,t);const Su=class Fi extends bu{constructor(e=0){super(e),In(this,"ID","4326"),In(this,"mapWidth",360*Fi.SCALE_FACTOR),In(this,"mapHeight",180*Fi.SCALE_FACTOR),In(this,"mapDepth",1)}forward(e,t){return{x:(e-this.centralMeridian)*Fi.SCALE_FACTOR,y:t*Fi.SCALE_FACTOR}}inverse(e,t){return{lon:e/Fi.SCALE_FACTOR+this.centralMeridian,lat:t/Fi.SCALE_FACTOR}}};In(Su,"SCALE_FACTOR",100);let Iy=Su;class Fy{static create(e="3857",t=0){switch(e){case"3857":return new Mu(t);case"4326":return new Iy(t);default:throw new Error(`[ProjectionFactory] Unsupported projection type: ${e}`)}}}var By=Object.defineProperty,Uy=(s,e,t)=>e in s?By(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Se=(s,e,t)=>Uy(s,typeof e!="symbol"?e+"":e,t);class Vy{constructor(...e){}}const ky={};let pi=class ld extends Eo(zr(ui(Vy))){constructor(e,t){Xo(e,"container","Map container element must be specified"),Yo(t,"state"),Yo(t.state,"center");const r={renderer:{antialias:!0,stencil:!0,logarithmicDepthBuffer:!0},camera:{},interaction:{},source:{}},i={...t,renderer:{...r.renderer,...t.renderer},camera:{...r.camera,...t.camera},interaction:{...r.interaction,...t.interaction},source:{...r.source,...t.source}};super(i),Se(this,"sceneRenderer"),Se(this,"_rootGroup",new f.Group),Se(this,"_layers",new globalThis.Map),Se(this,"_mapProjection",new Mu(0)),Se(this,"_animationClock",new f.Clock),Se(this,"autoUpdate",!0),Se(this,"updateInterval",100),Se(this,"minLevel",2),Se(this,"maxLevel",19),Se(this,"center"),Se(this,"prjcenter"),Se(this,"_layerContainer"),Se(this,"_eventState",{load:{listened:!1}}),Se(this,"_canvasMgr",new kg),Se(this,"_collisionEngine"),Se(this,"_onLoadHooks"),Se(this,"_minZoom",0),Se(this,"_maxZoom",22),Se(this,"_ZOOM_MIN_CONST",0),Se(this,"_ZOOM_MAX_CONST",22),Se(this,"_minZoomDistance",500),Se(this,"_maxZoomDistance",8e4),Se(this,"_isZooming",!1),Se(this,"_zoomStartValue",0),Se(this,"_lastZoomForControls",0),Se(this,"_overZoom",0),Se(this,"_lastCameraDistance",0),this.initMap(i.source??{}),wu(),this.center=this.options.state.center,this.sceneRenderer=new bc(e,{...i.renderer,map:this}),this._rootGroup.receiveShadow=!0,this._rootGroup.up.set(0,0,1),this._rootGroup.rotation.x=-Math.PI/2,this.sceneRenderer.scene.add(this._rootGroup),this.sceneRenderer._updateDefaultGroundPosition();const o=this.lngLatToWorld(new f.Vector3(this.center[0],this.center[1],0));this.prjcenter=o,this.sceneRenderer.on("update",()=>{this.render(this.sceneRenderer.camera)});const l=this.options.camera??{};this.sceneRenderer.easeTo({center:this.center,distance:typeof this.center[2]=="number"?this.center[2]:void 0,pitch:typeof l.pitch=="number"?l.pitch:void 0,bearing:typeof l.bearing=="number"?l.bearing:void 0,duration:0,curvePath:!1}),this._minZoomDistance=this.sceneRenderer.controls.minDistance,this._maxZoomDistance=this.sceneRenderer.controls.maxDistance;const c=this._getCameraDistance();this._lastCameraDistance=c,this._layerGroup=new Fg,this.sceneRenderer.scene.add(this._layerGroup);const u=this.sceneRenderer.controls;this._minZoomDistance=typeof u?.minDistance=="number"?u.minDistance:500,this._maxZoomDistance=typeof u?.maxDistance=="number"?u.maxDistance:8e4;const m=this.getLayers().find(_=>_.isBaseLayer===!0)?.minLevel??this.minLevel;this._minZoom=Math.max(this._ZOOM_MIN_CONST,Math.min(this._ZOOM_MAX_CONST,m)),this._maxZoom=this._ZOOM_MAX_CONST;const p=this.getZoom();this._lastZoomForControls=p,this._zoomStartValue=p,this._collisionEngine=new d_(this.sceneRenderer.renderer,{padding:8,updateInterval:16,animationDuration:200,maxFeaturesPerFrame:2e4,strategies:{priority:!0,grouping:!0,proximity:!0}}),this.on("viewchange",g_.debounce(_=>{if(!this._rootGroup||!this._collisionEngine)return;const v=this.getTileZoom(),S=this.getLayers().find(j=>j.isBaseLayer===!0)?.maxLevel??this.maxLevel,x=this._getCameraDistance(),O=x-this._lastCameraDistance;this._lastCameraDistance=x;const{max:P}=this._getViewZoomRange(),L=Math.max(0,P-S);v<S?this._overZoom=0:O<-.001?this._overZoom=Math.min(this._overZoom+1,L):O>.001&&(this._overZoom=Math.max(this._overZoom-1,0));const F=this.getZoom();Math.abs(F-this._lastZoomForControls)>.001&&(this._isZooming?this.fire("zoom",{from:this._zoomStartValue,to:F}):(this._isZooming=!0,this._zoomStartValue=this._lastZoomForControls,this.fire("zoomstart",{from:this._zoomStartValue,to:F})),this._lastZoomForControls=F),this._collisionEngine.update(_.camera)},10,{leading:!1,trailing:!0})),this.on("moveend",()=>{this._isZooming&&(this._isZooming=!1,this.fire("zoomend",{from:this._zoomStartValue,to:this.getZoom()}))}),this._callOnLoadHooks(),this._updateDefaultGroundVisibility()}get projection(){return this._mapProjection}get lon0(){return this.projection.centralMeridian}lngLatToPoint(e){const t=this.projection.forward(e.x,e.y);return new f.Vector3(t.x,t.y,e.z)}lngLatToWorld(e){return this._rootGroup.localToWorld(this.lngLatToPoint(e))}pointToLngLat(e){const t=this.projection.inverse(e.x,e.y);return new f.Vector3(t.lon,t.lat,e.z)}worldToLngLat(e){return this.pointToLngLat(this._rootGroup.worldToLocal(e.clone()))}queryAtLngLat(e){const t=this.lngLatToWorld(e);return ts(this,t)}queryAtWorld(e){return ts(this,e)}queryAtPoint(e){return So(this.sceneRenderer.camera,this,e)}static addOnLoadHook(e,...t){const r=typeof e=="function"?e:function(){this[e].apply(this,t)},i=this.prototype;return i._onLoadHooks=i._onLoadHooks||[],i._onLoadHooks.push(r),this}_callOnLoadHooks(){const e=ld.prototype;if(e._onLoadHooks)for(let t=0,r=e._onLoadHooks.length;t<r;t++)e._onLoadHooks[t].call(this)}getZoom(){const e=this.getTileZoom(),r=this.getLayers().find(i=>i.isBaseLayer===!0)?.maxLevel??this.maxLevel;return e<r?e:r+this._overZoom}getTileZoom(){let e=this.minLevel;const t=this.getLayers().find(i=>i.isBaseLayer===!0);return!t||!t._rootTile||t._rootTile.traverseVisible(i=>{i.showing&&i.inFrustum&&(e=Math.max(e,i.z))}),e}getMinZoom(){return this._minZoom}getMaxZoom(){return this._maxZoom}setZoomBounds(e,t){if(e>t){const i=e;e=t,t=i}this._minZoom=e,this._maxZoom=t;const r=this.sceneRenderer.controls;if(r){const i=this._computeDistanceFromZoom(this._maxZoom),o=this._computeDistanceFromZoom(this._minZoom);r.minDistance=i,r.maxDistance=o}return this}setMinZoom(e){return this.setZoomBounds(e,this._maxZoom)}setMaxZoom(e){return this.setZoomBounds(this._minZoom,e)}setZoom(e){const t=this.getMinZoom(),r=this.getMaxZoom(),i=Math.max(t,Math.min(r,e)),o=this.getZoom(),l=this._computeDistanceFromZoom(i),c=this.sceneRenderer.controls,u=c?.target??this.prjcenter,d=this.sceneRenderer.camera,m=d.position.clone().sub(u).normalize();return d.position.copy(u).addScaledVector(m,l),d.updateProjectionMatrix(),typeof c?.update=="function"&&c.update(),this._lastZoomForControls=i,this.fire("zoomend",{from:o,to:this.getZoom()}),this}zoomIn(e=1){return this.setZoom(this.getZoom()+e)}zoomOut(e=1){return this.setZoom(this.getZoom()-e)}_computeDistanceFromZoom(e){const t=this._ZOOM_MIN_CONST,r=this._ZOOM_MAX_CONST,i=this._minZoomDistance,o=this._maxZoomDistance;if(i<=0||i>=o){const m=Math.max(t,Math.min(r,e)),p=(r-m)/(r-t);return i+p*(o-i)}const c=(Math.max(t,Math.min(r,e))-t)/(r-t),u=i/o;return o*Math.pow(u,c)}initMap(e){if(this.minLevel=e.minLevel??2,this.maxLevel=e.maxLevel??19,e.baseLayers?.length)for(const t of e.baseLayers)t.isBaseLayer=!0,this.addTileLayer(t);else this._updateDefaultGroundVisibility();setTimeout(()=>{const t={timestamp:Sm(),target:this};this._eventState.load={listened:!0},this.fire("load",t)},0)}_updateDefaultGroundVisibility(){if(!this.sceneRenderer)return;this._layers.size>0?this.sceneRenderer.hideDefaultGround():this.sceneRenderer.showDefaultGround()}setGroundVisible(e){return e?this.sceneRenderer.showDefaultGround():this.sceneRenderer.hideDefaultGround(),this}isGroundVisible(){return this.sceneRenderer.isDefaultGroundVisible()}render(e){if(!this.autoUpdate)return;this._animationClock.getElapsedTime()>this.updateInterval/1e3&&(this._layers.forEach(r=>{r.enabled&&r.visible&&r.update(e)}),this._animationClock.start())}addLayer(e,...t){if(!e)return this;Array.isArray(e)||(e=[e]),t?.length&&(e=e.concat(t)),t?.length&&(e=e.concat(t));for(let r=0,i=e.length;r<i;r++){const o=e[r],l=o.getId();if(vc(l))throw new Error("Invalid id for the layer: "+l);o.isTileLayer?this.addTileLayer(o):this.addRegularLayer(o)}return this}removeLayer(e){const t=this._layers.get(e);if(t){if(t instanceof pa){const i=t._getRenderer();i&&this._layerGroup.remove(i)}return this._layers.delete(e),this._rootGroup.remove(t),this._updateDefaultGroundVisibility(),!0}const r=this._layerGroup.getLayerById(e);return r?(this._layerContainer.remove(r),r instanceof Nr&&r?._collision,!0):(console.warn(`⚠️ Layer does not exist 图层不存在: ${e}`),!1)}addRegularLayer(e){this._layerGroup.add(e),e._bindMap(this),e instanceof Nr&&e?._collision&&(this._collisionEngine.registerLayer(e),e.setCollisionEngine(this._collisionEngine))}addTileLayer(e){if(this._layers.set(e.getId(),e),this._rootGroup.add(e),e._bindMap(this),this._updateDefaultGroundVisibility(),e instanceof pa){const t=e.options||{},r=new ca(e.getId()+"-vtrender",{altitude:e.getAltitude(),paint:e.getPaint(),collision:e._collision,zIndex:typeof t.zIndex=="number"?t.zIndex:void 0,depthOffset:typeof t.depthOffset=="number"?t.depthOffset:void 0});e._setRenderer(r),this.addRegularLayer(r)}return this}clearLayers(){return this._layerGroup.clear(),this._layers.forEach(e=>{this._rootGroup.remove(e)}),this._layers.clear(),this._updateDefaultGroundVisibility(),this}getLayers(){const e=this._layerGroup.getLayers().filter(r=>!(r instanceof ca)),t=Array.from(this._layers.values());return[...e,...t]}getLayer(e){if(this._layers.has(e))return this._layers.get(e);const t=this._layerGroup.getLayerById(e);if(t)return t instanceof ca?void 0:t}_getCanvas(e=40,t=30,r){return this._canvasMgr.getCanvas(e,t,1,r)}getContainer(){return this.sceneRenderer.container}getRenderer(){return this.sceneRenderer.renderer}getCamera(){return this.sceneRenderer.camera}_queryFeaturesAt(e){const t=this,r=t.getRenderer(),i=t.getCamera(),o=r.domElement.getBoundingClientRect(),l=e.x/o.width*2-1,c=-(e.y/o.height)*2+1,u=new f.Raycaster;u.setFromCamera(new f.Vector2(l,c),i);const d=t.getLayers().filter(_=>!_?.isSceneLayer&&_?.visible===!0),p=u.intersectObjects(d,!0).map(_=>{let v=_.object,M=null;for(;v;){if(v instanceof Je){M=v;break}v=v.parent}return!M||M.visible===!1?null:{feature:M,distance:_.distance,object:_.object}}).filter(_=>!!_);return p.length?p.sort((_,v)=>_.distance-v.distance):[]}getCenter(){const e=this.sceneRenderer.controls.target.clone(),t=this.worldToLngLat(e);return[t.x,t.y,t.z]}_getPointerPosition(e){let t,r;if("touches"in e){if(e.touches.length===0)return null;t=e.touches[0].clientX,r=e.touches[0].clientY}else t=e.clientX,r=e.clientY;const i=this.getContainer();if(!i)return null;const o=i.getBoundingClientRect();return{x:t-o.left,y:r-o.top}}get isInteracting(){return this.sceneRenderer?this.sceneRenderer.isInteracting:!1}_getCameraDistance(){const e=this.sceneRenderer.controls,t=this.sceneRenderer.camera,r=e?.target??this.prjcenter;return e&&typeof e.getDistance=="function"?e.getDistance():t.position.distanceTo(r)}_getViewZoomRange(){const e=this.sceneRenderer.controls,t=typeof e?.minDistance=="number"?e.minDistance:this._minZoomDistance,r=typeof e?.maxDistance=="number"?e.maxDistance:this._maxZoomDistance;if(t<=0||t>=r){const p=this.getTileZoom();return{min:p,max:p}}const i=r/t,o=Math.log2(i),l=this.getLayers().find(p=>p.isBaseLayer===!0),c=l?.minLevel??this.minLevel,u=l?.maxLevel??this.maxLevel,d=c,m=u+o;return{min:d,max:m}}flyTo(e){this.sceneRenderer.flyToAdvanced(e)}easeTo(e){this.sceneRenderer.flyToPoint(e)}dispose(){try{this._clearHandlers(),["viewchange","movestart","moveend","zoomstart","zoom","zoomend","load"].forEach(t=>{const r=this._listenerMap?.get(t);r&&r.forEach((i,o)=>{this.off(t,o)})}),this.clearLayers(),Ho.getInstance().clearCache(),this._collisionEngine&&(this._collisionEngine=null),this._layerGroup&&(this._layerGroup.clear(),this._layerGroup=null),this._canvasMgr&&(this._canvasMgr=null),this.sceneRenderer&&(this.sceneRenderer.destroy(),this.sceneRenderer=null),this._eventState={load:{listened:!1}}}catch(e){console.error("Error destroying map 销毁地图时出错:",e)}}};pi.mergeOptions(ky);const zy=["click","dblclick","mousedown","mouseup","mousemove","mouseenter","mouseleave","mouseover","mouseout"];pi.prototype._removeDomEvents=function(){},pi.prototype._registerDomEvents=function(){const s=this.sceneRenderer.container;if(s){let t=null;zy.forEach(r=>{s.addEventListener(r,i=>{if(!this.sceneRenderer)return;if(r==="mousedown"&&(t={x:i.clientX,y:i.clientY}),r==="click"&&t){const c=i.clientX-t.x,u=i.clientY-t.y;if(Math.sqrt(c*c+u*u)>5)return}let o=la(i,this,this.sceneRenderer.camera),l={target:this,originEvent:i,eventName:r,screenXY:{X:i.screenX,Y:i.screenY}};if(o){let c=[o.x,o.y,o.z];l={target:this,originEvent:i,coordinate:c,eventName:r,screenXY:{X:i.screenX,Y:i.screenY}}}this.fire(r,l)})})}},pi.addOnLoadHook("_registerDomEvents");var Ny=Object.defineProperty,Ry=(s,e,t)=>e in s?Ny(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ma=(s,e,t)=>Ry(s,typeof e!="symbol"?e+"":e,t);const Wy=["click","dblclick","mousedown","mouseup","mousemove","mouseenter","mouseleave","mouseover","mouseout","contextmenu","touchstart","touchmove","touchend"];class Gy extends fs{constructor(){super(...arguments),ma(this,"_registeredEvents",[]),ma(this,"_mouseDownTime",0),ma(this,"_eventCommon",e=>{(e.type==="mousedown"||e.type==="touchstart")&&(this._mouseDownTime=Date.now()),!(e.type==="click"&&Date.now()-this._mouseDownTime>300)&&this._handleEvent(e,e.type)})}addHooks(){const t=this.target.getContainer();t&&Wy.forEach(r=>{t.addEventListener(r,this._eventCommon),this._registeredEvents.push(r)})}removeHooks(){const t=this.target.getContainer();t&&this._registeredEvents.length>0&&(this._registeredEvents.forEach(r=>{const i=r;t.removeEventListener(i,this._eventCommon)}),this._registeredEvents=[])}_handleEvent(e,t){const r=this.target;if(!r||!r.sceneRenderer||this._shouldIgnoreEvent(t)||(t==="mousemove"||t==="mouseenter"||t==="mouseleave"||t==="mouseover"||t==="mouseout"||t==="touchmove")&&!r.getLayers().some(u=>!u.isSceneLayer&&u._feaList?.length>0))return;const i=r._getPointerPosition(e);if(!i)return;const o=r._queryFeaturesAt(i);if(o.length===0)return;const l=o[0].feature;switch(t){case"click":this._handleClickEvent(l,e);break;case"mousemove":case"mouseenter":case"mouseleave":case"mouseover":case"mouseout":case"touchmove":this.handleMoveEvent(l,e);break;default:if(l){this._fireFeatureEvent(l,t,e);const c=l.getLayer();c&&c.fire("feature"+t,{feature:l,domEvent:e,type:"feature"+t})}}}_handleClickEvent(e,t){if(!e)return;this._fireFeatureEvent(e,"click",t);const r=e.getLayer();r&&r.fire("featureclick",{feature:e,domEvent:t,type:"featureclick"})}handleMoveEvent(e,t){if(!e)return;this._fireFeatureEvent(e,t.type,t);const r=e.getLayer();r&&r.fire("feature"+t.type,{feature:e,domEvent:t,type:"feature"+t.type})}_fireFeatureEvent(e,t,r){const i=this.target;if(!i||!i.sceneRenderer)return;let o=r,l,c;if("touches"in r){const p=r.touches[0]||r.changedTouches[0];if(!p)return;o={currentTarget:r.currentTarget,clientX:p.clientX,clientY:p.clientY},l=p.screenX,c=p.screenY}else{const p=r;o=p,l=p.screenX,c=p.screenY}const u=la(o,i,i.sceneRenderer.camera);if(!u)return;const d=[u.x,u.y,u.z],m={target:e,originEvent:r,coordinate:d,eventName:t,screenXY:{X:l,Y:c}};e.fire(t,m)}_shouldIgnoreEvent(e){const t=this.target;return t.sceneRenderer?e==="mousedown"||e==="touchstart"?!1:!!t.isInteracting:!0}}pi.mergeOptions({FeatureEvents:!0,onlyVisibleFeatureEvents:!0}),pi.addOnLoadHook("addHandler","FeatureEvents",Gy);var $y=Object.defineProperty,jy=(s,e,t)=>e in s?$y(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,dr=(s,e,t)=>jy(s,typeof e!="symbol"?e+"":e,t);let Xy=class{constructor(...e){}};const Au=class fn extends zr(ui(Xy)){constructor(e={}){super(e),dr(this,"_owner"),dr(this,"_map"),dr(this,"_worldPosition"),dr(this,"_coordinate"),dr(this,"_dom"),dr(this,"_visible",!1),dr(this,"_boundMapHandlers",new Map),dr(this,"_sceneRendererUpdateHandler"),dr(this,"_positionedOnce",!1)}_getClassName(){return"UIComponent"}getOffset(){return{x:this.options.dx??0,y:this.options.dy??0}}addTo(e){if(!e)return this;this._owner=e;const t=typeof e.getMap=="function"?e.getMap():e;return t?(this._map=t,this._bindMapEvents(!0),this.options.single&&(fn._singletons.forEach(r=>{r!==this&&r.options.single&&r._map===t&&r.hide()}),fn._singletons.add(this)),this.onAdd&&this.onAdd(),this.fire("add",{owner:e,map:t}),this):this}remove(){const e=this._map;return this.hideDom(),this._bindMapEvents(!1),this.options.single&&fn._singletons.delete(this),this.onRemove&&this.onRemove(),this.fire("remove",{owner:this._owner,map:e}),this._owner=void 0,this._map=void 0,this}show(e){const t=this._map??(this._owner&&typeof this._owner.getMap=="function"?this._owner.getMap():void 0);if(!t)return this;if(this._map=t,this.options.single&&(fn._singletons.forEach(r=>{r!==this&&r.options.single&&r._map===t&&r.isVisible()&&r.hide()}),fn._singletons.add(this)),!this._dom){const r=this.buildOn();this._dom=r,r.style.position="absolute",typeof this.options.zIndex=="number"&&(r.style.zIndex=String(this.options.zIndex));const i=t.getContainer();if(!i)return this;i.appendChild(r)}return this._coordinate=e?[...e]:void 0,this._visible=!0,this._positionedOnce=!1,this._dom&&(this._dom.style.display="none"),this.fire("show",{owner:this._owner,map:t}),this}hide(){return this._visible=!1,this._dom&&(this._dom.style.display="none"),this._coordinate=void 0,this.fire("hide",{owner:this._owner,map:this._map}),this}hideDom(){return this._dom&&this._dom.parentElement&&(this._dom.parentElement.removeChild(this._dom),this.onDomRemove&&this.onDomRemove()),this._dom=void 0,this._visible=!1,this._coordinate=void 0,this}getMap(){return this._map}isVisible(){return this._visible}_bindMapEvents(e){const t=this._map;if(!t)return;const r=t,i=e?"on":"off",o=(l,c)=>{e?this._boundMapHandlers.set(l,c):this._boundMapHandlers.delete(l)};if(e){const l=()=>{this._visible&&this._refreshDomPosition()};r[i]("viewchange",l),o("viewchange",l);const c=t.sceneRenderer;if(c&&!this._sceneRendererUpdateHandler){const u=()=>{this._visible&&this._refreshDomPosition()};this._sceneRendererUpdateHandler=u,c.addEventListener("update",u)}}else{this._boundMapHandlers.forEach((c,u)=>{r[i](u,c)}),this._boundMapHandlers.clear();const l=t.sceneRenderer;l&&this._sceneRendererUpdateHandler&&(l.removeEventListener("update",this._sceneRendererUpdateHandler),this._sceneRendererUpdateHandler=void 0)}}_resolveWorldPosition(){const e=this._map;if(!e)return;if(this._coordinate){const[r,i,o=0]=this._coordinate,l=new f.Vector3(r,i,o);return e.lngLatToWorld(l)}const t=this._owner;if(t&&t._geometry){const r=t._geometry;if(r&&(r.type==="Point"||r.type==="MultiPoint")){let i;if(r.type==="Point"?i=r.coordinates:r.type==="MultiPoint"&&Array.isArray(r.coordinates)&&r.coordinates.length>0&&(i=r.coordinates[0]),i&&i.length>=2){const o=new f.Vector3(i[0],i[1],i[2]??0);return e.lngLatToWorld(o)}}if(t._renderObject&&typeof t._renderObject.getWorldPosition=="function"){const i=new f.Vector3;if(t._renderObject.getWorldPosition(i),!(i.x===0&&i.y===0&&i.z===0))return i}if(t._worldLngLatLikes instanceof f.Vector3){const i=t._worldLngLatLikes;if(!(i.x===0&&i.y===0&&i.z===0))return i.clone()}}if(t&&typeof t.getWorldPosition=="function"){const r=new f.Vector3;return t.getWorldPosition(r),r}return e.prjcenter?.clone?.()??void 0}_refreshDomPosition(){if(!this._dom||!this._map)return;if(this._visible){const u=this._resolveWorldPosition();if(!u){this._dom.style.display="none";return}this._worldPosition=u}if(!this._worldPosition)return;const e=this._map.sceneRenderer,t=e.camera,r=this._dom.style.display==="none";r&&(this._dom.style.visibility="hidden",this._dom.style.display=""),t.updateMatrixWorld();const i=this._worldPosition.clone().project(t);if(i.x<-1.1||i.x>1.1||i.y<-1.1||i.y>1.1||i.z<-1||i.z>1){this._dom.style.display="none",r&&(this._dom.style.visibility="");return}const o=(i.x*.5+.5)*e.width,l=(-i.y*.5+.5)*e.height,c=this.getOffset();if(this._dom.style.left=`${o+c.x}px`,this._dom.style.top=`${l+c.y}px`,r&&(this._dom.style.visibility=""),!this._positionedOnce){this._positionedOnce=!0,this._dom.style.display="none";return}this._dom.style.display=""}};dr(Au,"_singletons",new Set);let Ts=Au;var Yy=Object.defineProperty,Zy=(s,e,t)=>e in s?Yy(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Pu=(s,e,t)=>Zy(s,typeof e!="symbol"?e+"":e,t);class ga extends Ts{constructor(e){super({single:!0,...e}),Pu(this,"_titleEl"),Pu(this,"_contentEl")}_getClassName(){return"InfoWindow"}buildOn(){if(this.options.custom){let c;this.options.content instanceof HTMLElement?c=this.options.content:(c=document.createElement("div"),typeof this.options.content=="string"&&(c.innerHTML=this.options.content));const u=this.options.containerClass;return u&&(Array.isArray(u)?u:[u]).forEach(m=>{c.classList.add(m)}),this.options.minWidth&&(c.style.minWidth=`${this.options.minWidth}px`),this.options.minHeight&&(c.style.minHeight=`${this.options.minHeight}px`),this._titleEl=void 0,this._contentEl=c,c}const e=document.createElement("div");e.className="maporbis-infowindow";const t=this.options.containerClass;t&&(Array.isArray(t)?t:[t]).forEach(u=>{e.classList.add(u)}),typeof this.options.zIndex=="number"&&(e.style.zIndex=String(this.options.zIndex)),this.options.minWidth&&(e.style.minWidth=`${this.options.minWidth}px`),this.options.minHeight&&(e.style.minHeight=`${this.options.minHeight}px`);const r=document.createElement("div");r.className="maporbis-infowindow-header";const i=document.createElement("div");i.className="maporbis-infowindow-title",this.options.title&&(i.textContent=this.options.title);const o=document.createElement("span");o.className="maporbis-infowindow-close",o.innerHTML="×",o.title="关闭",o.addEventListener("click",c=>{c.stopPropagation(),c.preventDefault(),this.close()}),o.addEventListener("mousedown",c=>{c.preventDefault()}),o.style.cursor="pointer",o.style.userSelect="none",r.appendChild(i),r.appendChild(o);const l=document.createElement("div");return l.className="maporbis-infowindow-content",this.options.content instanceof HTMLElement?l.appendChild(this.options.content):typeof this.options.content=="string"&&(l.innerHTML=this.options.content),e.appendChild(r),e.appendChild(l),this._titleEl=i,this._contentEl=l,e}getOffset(){const e=super.getOffset(),t=this._dom;if(!t)return e;const r=t.offsetWidth,i=t.offsetHeight,o=10;let l=e.x-r/2,c=e.y-i-o;const u=this._owner,d=this.getMap();if(u&&typeof u.getStyle=="function"&&d?.sceneRenderer){const p=u.getStyle?.()?.config,_=p?.type;if(p&&(_==="icon-point"||_==="icon-label-point")){const M=ki(p.anchor)[1];let S=0;const x=u._renderObject;if(x&&x instanceof f.Sprite&&(S=this._getSpriteScreenHeight(x,d.sceneRenderer)),S<=0){let O=0;if(_==="icon-point"){const P=p.size;Array.isArray(P)?O=P[1]:typeof P=="number"&&(O=P)}else if(_==="icon-label-point"){const P=p.size??p.iconSize;Array.isArray(P)?O=P[1]:typeof P=="number"&&(O=P)}S=O*(1-M)}else S=S*(1-M);S>0&&(c-=S)}}return{x:l,y:c}}_getSpriteScreenHeight(e,t){try{const r=t.camera,i=t.renderer;if(!r||!i)return 0;const o=t.height||i.domElement.clientHeight;if(!(e.material.sizeAttenuation!==!1)){const z=r.projectionMatrix.elements[5];return e.scale.y*z*o/2}const u=new f.Vector3;e.getWorldPosition(u);const d=r.position.clone(),m=u.clone().sub(d).normalize(),p=new f.Vector3;p.crossVectors(r.up,m).normalize();const _=new f.Vector3;_.crossVectors(m,p).normalize();const v=e.scale.y*(1-e.center.y),M=e.scale.y*e.center.y,S=u.clone().add(_.clone().multiplyScalar(v)),x=u.clone().sub(_.clone().multiplyScalar(M)),O=S.clone().project(r),P=x.clone().project(r),L=(-O.y*.5+.5)*o,F=(-P.y*.5+.5)*o;return Math.abs(F-L)}catch(r){return console.warn("Failed to calculate sprite screen height: // 计算 sprite 屏幕高度失败:",r),0}}setTitle(e){return this.options.title=e,this._titleEl&&(this._titleEl.textContent=e??""),this}setContent(e){return this.options.content=e,this._contentEl?(this._contentEl.innerHTML="",e instanceof HTMLElement?this._contentEl.appendChild(e):this._contentEl.innerHTML=e,this):this}open(e){super.show(e);const t=this,r=()=>{!t._dom||!t._map||!t._visible||(t._positionedOnce=!0,t._refreshDomPosition())},o=this.getMap()?.sceneRenderer;if(o&&typeof o.addEventListener=="function"){const l=()=>{o.removeEventListener("update",l),r()};o.addEventListener("update",l)}else requestAnimationFrame(r);return this}close(){return this.hide()}}Je.include({setInfoWindow(s){this.removeInfoWindow();let e;return s instanceof ga?e=s:e=new ga(s),this._infoWindow=e,this.getMap()&&e.addTo(this),this},getInfoWindow(){return this._infoWindow},openInfoWindow(s){const e=this._infoWindow;return e?(e.getMap()||this.getMap()&&e.addTo(this),requestAnimationFrame(()=>{e.open(s)}),this):this},closeInfoWindow(){return this._infoWindow&&this._infoWindow.close(),this},removeInfoWindow(){return this._infoWindow&&(this._infoWindow.remove(),this._infoWindow=void 0),this}});var Ky=Object.defineProperty,qy=(s,e,t)=>e in s?Ky(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,$i=(s,e,t)=>qy(s,typeof e!="symbol"?e+"":e,t);class _a extends Ts{constructor(e={}){super({single:!1,...e}),$i(this,"_content"),$i(this,"_timeoutId"),$i(this,"_boundOnOwnerMove",t=>this._onOwnerMove(t)),$i(this,"_boundOnOwnerOut",()=>this._onOwnerOut()),$i(this,"_boundOnOwnerRemoved",()=>this._onOwnerRemoved()),$i(this,"_standaloneCoord"),this._content=e.content}_getClassName(){return"ToolTip"}buildOn(){const e=document.createElement("div"),t=document.createElement("div");t.className="maporbis-tooltip";const r=this.options.containerClass;r&&(Array.isArray(r)?r:[r]).forEach(u=>{t.classList.add(u)});const{width:i,height:o}=this.options;typeof i=="number"&&(t.style.width=`${i}px`),typeof o=="number"&&(t.style.height=`${o}px`);const l=this._content;return typeof l=="function"?l(t):l instanceof HTMLElement?t.appendChild(l):typeof l=="string"&&(t.innerHTML=l),e.appendChild(t),e}getOffset(){const e=super.getOffset(),t=this._dom;if(!t)return e;const r=t.offsetWidth,i=t.offsetHeight,o=ki(this.options.anchor||"top"),l=10;let c=e.x,u=e.y;const d=this.options.anchor||"top";if(typeof d=="string")switch(d){case"top":c=e.x-r/2,u=e.y-i-l;break;case"bottom":c=e.x-r/2,u=e.y+l;break;case"left":c=e.x-r-l,u=e.y-i/2;break;case"right":c=e.x+l,u=e.y-i/2;break;case"top-left":c=e.x-r-l,u=e.y-i-l;break;case"top-right":c=e.x+l,u=e.y-i-l;break;case"bottom-left":c=e.x-r-l,u=e.y+l;break;case"bottom-right":c=e.x+l,u=e.y+l;break;case"center":c=e.x-r/2,u=e.y-i/2;break}else c=e.x-r*o[0],u=e.y-i*(1-o[1]);return{x:c,y:u}}addTo(e){return this._owner=e,this.options.coordinate&&(this._standaloneCoord=[...this.options.coordinate]),super.addTo(e),this._standaloneCoord&&this.options.persistent&&this.show(this._standaloneCoord),!this.options.persistent&&!this._standaloneCoord&&e&&typeof e.on=="function"&&(e.on("mousemove",this._boundOnOwnerMove),e.on("mouseout",this._boundOnOwnerOut),e.on("removed",this._boundOnOwnerRemoved)),this}_onOwnerMove(e){const t=this.getMap();if(!t)return;this._timeoutId!=null&&(window.clearTimeout(this._timeoutId),this._timeoutId=void 0);const r=e?.coordinate??(this._owner&&typeof this._owner.getLngLatLike=="function"?this._owner.getLngLatLike():t.getCenter?.()),i=this.options.showTimeout??400,o=()=>{super.show(r);const l=this;l._positionedOnce=!0,l._refreshDomPosition(),l._dom&&(l._dom.style.display="block")};i<=0?o():this._timeoutId=window.setTimeout(o,i)}_onOwnerOut(){this._timeoutId!=null&&(window.clearTimeout(this._timeoutId),this._timeoutId=void 0),this.hide()}_onOwnerRemoved(){this.remove()}setCoordinate(e){return this._standaloneCoord=[...e],this.isVisible()&&this.show(this._standaloneCoord),this}getCoordinate(){return this._standaloneCoord?[...this._standaloneCoord]:void 0}setContent(e){this._content=e,this.options.content=e;const t=this._dom;if(!t)return this;const r=t.querySelector(".maporbis-tooltip");return r?(r.innerHTML="",typeof e=="function"?e(r):e instanceof HTMLElement?r.appendChild(e):typeof e=="string"&&(r.innerHTML=e),this):this}show(e){const t=e||this._standaloneCoord;if(!t&&!this._owner)return console.warn("ToolTip: coordinate required for standalone mode"),this;super.show(t);const r=this;return r._positionedOnce=!0,r._refreshDomPosition(),r._dom&&(r._dom.style.display="block"),this}onRemove(){this._timeoutId!=null&&(window.clearTimeout(this._timeoutId),this._timeoutId=void 0);const e=this._owner;e&&typeof e.off=="function"&&(e.off("mousemove",this._boundOnOwnerMove),e.off("mouseout",this._boundOnOwnerOut),e.off("removed",this._boundOnOwnerRemoved)),this._owner=void 0,this._standaloneCoord=void 0}}Je.include({setToolTip(s){this.removeToolTip();let e;return s instanceof _a?e=s:e=new _a(s),this._toolTip=e,this.getMap()&&e.addTo(this),this},getToolTip(){return this._toolTip},openToolTip(s){const e=this._toolTip;return e?(e.getMap()||this.getMap()&&e.addTo(this),e.show(s),this):this},closeToolTip(){return this._toolTip&&this._toolTip.hide(),this},removeToolTip(){return this._toolTip&&(this._toolTip.remove(),this._toolTip=void 0),this}});var Qy=Object.defineProperty,Ey=(s,e,t)=>e in s?Qy(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ya=(s,e,t)=>Ey(s,typeof e!="symbol"?e+"":e,t);class Jy{constructor(...e){}}class Lu extends zr(ui(Jy)){constructor(e={}){super(e),ya(this,"_map"),ya(this,"_enabled",!1),ya(this,"_boundHandlers",new Map)}addTo(e){if(!e)return this;const t=e;return t._activeMapTool&&t._activeMapTool!==this&&t._activeMapTool.disable(),t._activeMapTool=this,this._map=e,this.onAdd&&this.onAdd(),this.enable(),this.fire("add",{map:e}),this}getMap(){return this._map}enable(){return!this._map||this._enabled?this:(this._enabled=!0,this._bindEvents(),this.onEnable&&this.onEnable(),this.fire("enable",{map:this._map}),this)}disable(){return!this._map||!this._enabled?this:(this._enabled=!1,this._unbindEvents(),this.onDisable&&this.onDisable(),this.fire("disable",{map:this._map}),this)}isEnabled(){return!!this._enabled}remove(){if(!this._map)return this;this.disable();const e=this._map;return e._activeMapTool===this&&delete e._activeMapTool,this._map=void 0,this.fire("remove"),this}_bindEvents(){const e=this._map;if(!e)return;const t=this.getEvents()||{};Object.keys(t).forEach(r=>{const i=t[r];if(!i)return;const o=l=>i.call(this,l);this._boundHandlers.set(r,o),e.on(r,o)})}_unbindEvents(){const e=this._map;e&&(this._boundHandlers.forEach((t,r)=>{e.off(r,t)}),this._boundHandlers.clear())}}var Hy=Object.defineProperty,ev=(s,e,t)=>e in s?Hy(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Fn=(s,e,t)=>ev(s,typeof e!="symbol"?e+"":e,t);class tv extends Nr{constructor(e){super(e,{altitude:1})}validateFeature(e){return!!e}}const Cu={};class ji extends Lu{constructor(e){super(e),Fn(this,"_modeDef"),Fn(this,"_clickCoords",[]),Fn(this,"_isDrawing",!1),Fn(this,"_geometry"),Fn(this,"_draftLayer"),this.options.once=this.options.once??!1,this._ensureMode()}static registerMode(e,t){Cu[e.toLowerCase()]=t}static getModeDefinition(e){return Cu[e.toLowerCase()]}getMode(){return(this.options.mode||"").toLowerCase()}setMode(e){return this._finishDrawingSilently(),this.options.mode=e,this._ensureMode(),this}setPaint(e){return e.geometryPaint!==void 0&&(this.options.geometryPaint=e.geometryPaint),Object.prototype.hasOwnProperty.call(e,"vertexPaint")&&(this.options.vertexPaint=e.vertexPaint??null),this}getEvents(){return{click:this._handleClick.bind(this),mousemove:this._handleMouseMove.bind(this),dblclick:this._handleDblClick.bind(this)}}onEnable(){this._ensureMode()}onDisable(){this._finishDrawingSilently(),this._destroyDraftLayer()}_ensureMode(){const e=this.getMode(),t=ji.getModeDefinition(e);if(!t)throw new Error(`DrawTool: mode "${e}" 未注册，请先调用 DrawTool.registerMode`);this._modeDef=t}_handleClick(e){if(!this._modeDef||!e.coordinate)return;const t=e.coordinate,r=this._modeDef,i={...e,drawTool:this};this._isDrawing?(this._clickCoords.push(t),r.update(this._clickCoords,this._geometry,i),this.fire("drawvertex",{coordinate:t,geometry:this._geometry,coords:[...this._clickCoords],originEvent:i})):(this._isDrawing=!0,this._clickCoords=[t],this._geometry=r.create(t,i),this.fire("drawstart",{coordinate:t,geometry:this._geometry,coords:[...this._clickCoords],originEvent:i})),r.clickLimit&&this._clickCoords.length>=r.clickLimit&&this._finishDrawing(i)}_handleMouseMove(e){if(!this._modeDef||!this._isDrawing||!e.coordinate)return;const t=this._modeDef,r=[...this._clickCoords,e.coordinate],i={...e,drawTool:this};t.update(r,this._geometry,i),this.fire("drawing",{coordinate:e.coordinate,geometry:this._geometry,coords:r,originEvent:i})}_handleDblClick(e){if(!this._modeDef||!this._isDrawing)return;const t={...e,drawTool:this};this._finishDrawing(t)}_finishDrawing(e){if(!this._modeDef||!this._isDrawing)return;const r=this._modeDef.generate(this._geometry,[...this._clickCoords]);this.fire("drawend",{geometry:r,coords:[...this._clickCoords],originEvent:e}),this._isDrawing=!1,this._clickCoords=[],this._geometry=void 0,this.options.once&&this.disable()}_finishDrawingSilently(){this._isDrawing=!1,this._clickCoords=[],this._geometry=void 0}_getOrCreateDraftLayer(){if(this._draftLayer)return this._draftLayer;const e=this.getMap();if(!e)throw new Error("DrawTool: 尚未绑定地图，请先调用 addTo(map)");const t=`__draw_draft_${Date.now().toString(36)}`,r=new tv(t);return e.addLayer(r),this._draftLayer=r,r}_destroyDraftLayer(){const e=this.getMap();e&&this._draftLayer&&e.removeLayer(this._draftLayer.getId()),this._draftLayer=void 0}}const rv={actions:["click","mousemove"],create(s,e){const t=e.drawTool,r=t._getOrCreateDraftLayer(),i=jr(t.options.geometryPaint,{type:"circle",size:10,color:"#00ffff"}),o={type:"Point",coordinates:s},l=new wr({geometry:o,paint:i});return l.addTo(r),l.initializeGeometry(),{tool:t,draftLayer:r,draftMarker:l}},update(s,e,t){const r=e?.draftMarker;if(!r)return;const i=s[s.length-1];r._geometry={type:"Point",coordinates:i},r._worldLngLatLikes=r._coordsTransform(),r._buildRenderObject&&r._buildRenderObject()},generate(s,e){const t=s.tool;if(!e.length)return null;s.draftMarker&&(s.draftMarker._remove(),s.draftMarker=null);const r=jr(t.options.geometryPaint,{type:"basic-point",size:10,color:"#00ffff"}),i=e[e.length-1];return new wr({geometry:{type:"Point",coordinates:i},paint:r})},clickLimit:1},iv={actions:["click","mousemove","dblclick"],create(s,e){const t=e.drawTool,r=t._getOrCreateDraftLayer(),i=jr(t.options.geometryPaint,{type:"basic-line",color:"#ff0000",width:2}),o=t.options.vertexPaint===null?void 0:jr(t.options.vertexPaint,{type:"basic-point",size:8,color:"#00ffff"}),l={type:"LineString",coordinates:[s]},c=new pt({geometry:l,paint:i});c.addTo(r);const u=[];if(o){const d={type:"Point",coordinates:s},m=new wr({geometry:d,paint:o});m.addTo(r),u.push(m)}return{tool:t,draftLayer:r,draftLine:c,draftAnchors:u,linePaint:i,vertexPaint:o}},update(s,e,t){if(!e)return;const r=e.draftLayer;if(!s||s.length<2)return;e.draftLine&&(e.draftLine._remove(),e.draftLine=null);const i={type:"LineString",coordinates:s},o=new pt({geometry:i,paint:e.linePaint});if(o.addTo(r),e.draftLine=o,t.eventName==="click"&&e.vertexPaint){const c={type:"Point",coordinates:s[s.length-1]},u=new wr({geometry:c,paint:e.vertexPaint});u.addTo(r),e.draftAnchors.push(u)}},generate(s,e){const t=s.tool;if(!e.length)return null;if(s.draftLine&&(s.draftLine._remove(),s.draftLine=null),Array.isArray(s.draftAnchors)){for(const o of s.draftAnchors)o?._remove();s.draftAnchors=[]}const r=jr(t.options.geometryPaint,{type:"basic-line",color:"#ff0000",width:2});return new pt({geometry:{type:"LineString",coordinates:e},paint:r})}},nv={actions:["click","mousemove","dblclick"],create(s,e){const t=e.drawTool,r=t._getOrCreateDraftLayer(),i=jr(t.options.geometryPaint,{type:"basic-polygon",color:"#00ff00",opacity:.5}),o=t.options.vertexPaint===null?void 0:jr(t.options.vertexPaint,{type:"basic-point",size:8,color:"#00ffff"}),l=[];if(o){const c={type:"Point",coordinates:s},u=new wr({geometry:c,paint:o});u.addTo(r),u.initializeGeometry(),l.push(u)}return{tool:t,draftLayer:r,draftPolygon:null,draftEdgeLine:null,draftAnchors:l,polygonPaint:i,vertexPaint:o}},update(s,e,t){if(!e)return;const r=e.draftLayer;if(t.eventName==="click"&&e.vertexPaint){const m={type:"Point",coordinates:s[s.length-1]},p=new wr({geometry:m,paint:e.vertexPaint});p.addTo(r),p.initializeGeometry(),e.draftAnchors.push(p)}if(!s||s.length<2){e.draftEdgeLine&&(e.draftEdgeLine._remove(),e.draftEdgeLine=null),e.draftPolygon&&(e.draftPolygon._remove(),e.draftPolygon=null);return}if(s.length===2){e.draftPolygon&&(e.draftPolygon._remove(),e.draftPolygon=null),e.draftEdgeLine&&(e.draftEdgeLine._remove(),e.draftEdgeLine=null);const d={type:"LineString",coordinates:s},m=e.polygonPaint?.config&&e.polygonPaint.config.color||"#00ff00",p=new xt({type:"line",color:m,width:2}),_=new pt({geometry:d,paint:p});_.addTo(r),e.draftEdgeLine=_;return}e.draftEdgeLine&&(e.draftEdgeLine._remove(),e.draftEdgeLine=null);const i=s.slice(),o=i[0],l=i[i.length-1];(o[0]!==l[0]||o[1]!==l[1]||(o[2]||0)!==(l[2]||0))&&i.push(o),e.draftPolygon&&(e.draftPolygon._remove(),e.draftPolygon=null);const c={type:"Polygon",coordinates:[i]},u=new fr({geometry:c,paint:e.polygonPaint});u.addTo(r),e.draftPolygon=u},generate(s,e){const t=s.tool;if(e.length<3)return null;if(s.draftPolygon&&(s.draftPolygon._remove(),s.draftPolygon=null),s.draftEdgeLine&&(s.draftEdgeLine._remove(),s.draftEdgeLine=null),Array.isArray(s.draftAnchors)){for(const u of s.draftAnchors)u?._remove();s.draftAnchors=[]}const r=jr(t.options.geometryPaint,{type:"basic-polygon",color:"#00ff00",opacity:.5}),i=e.slice(),o=i[0],l=i[i.length-1];return(o[0]!==l[0]||o[1]!==l[1]||(o[2]||0)!==(l[2]||0))&&i.push(o),new fr({geometry:{type:"Polygon",coordinates:[i]},paint:r})}};ji.registerMode("point",rv),ji.registerMode("line",iv),ji.registerMode("polygon",nv);function jr(s,e){return xt.create(s||e)}var sv=Object.defineProperty,ov=(s,e,t)=>e in s?sv(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Mt=(s,e,t)=>ov(s,typeof e!="symbol"?e+"":e,t);class qt{constructor(e){Mt(this,"dataType","image"),Mt(this,"attribution","isource"),Mt(this,"minLevel",0),Mt(this,"maxLevel",18),Mt(this,"projectionID","3857"),Mt(this,"url",""),Mt(this,"subdomains",[]),Mt(this,"s",""),Mt(this,"opacity",1),Mt(this,"isTMS",!1),Mt(this,"bounds",[-180,-85,180,85]),Mt(this,"_projectionBounds",[-1/0,-1/0,1/0,1/0]),Mt(this,"tileMaterial"),Object.assign(this,e)}getUrl(e,t,r){const i={...this,x:e,y:t,z:r};return yc(this.url,i)}_getUrl(e,t,r){const i=this.subdomains.length;if(i>0){const l=Math.floor(Math.random()*i);this.s=this.subdomains[l]}const o=this.isTMS?Math.pow(2,r)-1-t:t;return this.getUrl(e,o,r)}static create(e){return new qt(e)}}var av=Object.defineProperty,lv=(s,e,t)=>e in s?av(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Qt=(s,e,t)=>lv(s,typeof e!="symbol"?e+"":e,t);class cv extends qt{constructor(e){if(super(e),Qt(this,"dataType","image"),Qt(this,"attribution","天地图"),Qt(this,"token",""),Qt(this,"style","img_w"),Qt(this,"subdomains","01234"),Qt(this,"url","https://t{s}.tianditu.gov.cn/DataServer?T={style}&x={x}&y={y}&l={z}&tk={token}"),Object.assign(this,e),!this.token)throw new Error("天地图访问令牌(token)是必填参数")}}class uv extends qt{constructor(e){if(super(e),Qt(this,"dataType","quantized-mesh"),Qt(this,"attribution","天地图"),Qt(this,"token",""),Qt(this,"subdomains","01234"),Qt(this,"url","https://t{s}.tianditu.gov.cn/mapservice/swdx?T=elv_c&tk={token}&x={x}&y={y}&l={z}"),Object.assign(this,e),!this.token)throw new Error("天地图访问令牌(token)是必填参数")}}var hv=Object.defineProperty,fv=(s,e,t)=>e in s?hv(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ou=(s,e,t)=>fv(s,typeof e!="symbol"?e+"":e,t);class dv extends qt{constructor(e){super({...e,url:e.urlTemplate,isTMS:e.isTMS||!1}),Ou(this,"minLevel",2),Ou(this,"maxLevel",24)}getUrl(e,t,r){const i=this.isTMS?Math.pow(2,r)-1-t:t;return yc(this.url,{...this,x:e,y:i,z:r,tileMatrix:r,tileRow:i,tileCol:e})}}var pv=Object.defineProperty,mv=(s,e,t)=>e in s?pv(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,br=(s,e,t)=>mv(s,typeof e!="symbol"?e+"":e,t);class gv extends qt{constructor(e){super(e),br(this,"dataType","image"),br(this,"attribution","ArcGIS"),br(this,"style","World_Imagery"),br(this,"url","https://services.arcgisonline.com/arcgis/rest/services/{style}/MapServer/tile/{z}/{y}/{x}"),Object.assign(this,e)}}class _v extends qt{constructor(e){super(e),br(this,"dataType","lerc"),br(this,"attribution","ArcGIS"),br(this,"minLevel",6),br(this,"maxLevel",13),br(this,"url","https://elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/Terrain3D/ImageServer/tile/{z}/{y}/{x}"),Object.assign(this,e)}}var yv=Object.defineProperty,vv=(s,e,t)=>e in s?yv(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Xi=(s,e,t)=>vv(s,typeof e!="symbol"?e+"":e,t);class wv extends qt{constructor(e){if(super(e),Xi(this,"token",""),Xi(this,"format","webp"),Xi(this,"style","cm2myr6qx001t01pi0sf7estf"),Xi(this,"attribution","MapBox"),Xi(this,"maxLevel",25),Xi(this,"url","https://api.mapbox.com/styles/v1/criska/{style}/tiles/256/{z}/{x}/{y}?access_token={token}&format={format}"),Object.assign(this,e),!this.token)throw new Error("MapBox访问令牌(token)是必填参数")}}var bv=Object.defineProperty,xv=(s,e,t)=>e in s?bv(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Tu=(s,e,t)=>xv(s,typeof e!="symbol"?e+"":e,t);class Mv extends qt{constructor(e){super(e),Tu(this,"dataType","mvt"),Tu(this,"paint",{layer:{}}),Object.assign(this,e)}}var Sv=Object.defineProperty,Av=(s,e,t)=>e in s?Sv(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Bn=(s,e,t)=>Av(s,typeof e!="symbol"?e+"":e,t);class Pv extends qt{constructor(e){super(e),Bn(this,"dataType","VectorTile"),Bn(this,"attribution","ArcGIS"),Bn(this,"minLevel",1),Bn(this,"maxLevel",21),Bn(this,"url","https://api.maptiler.com/tiles/v3/{z}/{x}/{y}.pbf?key=uKYsZQZpm72WlbSgH9B7"),Object.assign(this,e)}}class Lv extends Nr{constructor(e,t){super(e,t)}validateFeature(e){return e._baseType==="Line"}}class Cv extends Nr{constructor(e,t){super(e,t)}validateFeature(e){return e._baseType==="Point"}}class Ov extends Nr{constructor(e,t){super(e,t)}validateFeature(e){return e._baseType==="Surface"}}var Tv=Object.defineProperty,Dv=(s,e,t)=>e in s?Tv(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Iv=(s,e,t)=>Dv(s,e+"",t);class Fv extends Nr{constructor(e,t){super(e,t),Iv(this,"_clouds",null);const r=["texture"];for(const i of r)Yo(t,i);this._createClouds(t.texture)}async _createClouds(e){const t=await xt._loadTexture(e),r=new Em({texture:t,material:f.MeshBasicMaterial});r.castShadow=!0,this._clouds=r}validateFeature(e){return e._type==="Cloud"}animate(e,t){this._clouds&&this._clouds.update(this.map.sceneRenderer.camera,t,e)}}var Bv=Object.defineProperty,Uv=(s,e,t)=>e in s?Bv(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Vv=(s,e,t)=>Uv(s,e+"",t);class va extends Hc{constructor(e,t){super(e,t),Vv(this,"layerType","raster")}createLoader(){const e=new Ss;return Array.isArray(this.source)?e.imgSource=this.source:e.imgSource=[this.source],e}}var kv=Object.defineProperty,zv=(s,e,t)=>e in s?kv(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ds=(s,e,t)=>zv(s,typeof e!="symbol"?e+"":e,t);class Nv extends va{constructor(e,t){super(e,t),Ds(this,"layerType","wmts"),Ds(this,"_layerName"),Ds(this,"_style"),Ds(this,"_matrixSet"),this._layerName=t.layerName,this._style=t.style||"default",this._matrixSet=t.matrixSet||"GoogleMapsCompatible"}get layerName(){return this._layerName}get style(){return this._style}get matrixSet(){return this._matrixSet}createLoader(){const e=new Ss;return Array.isArray(this.source)?e.imgSource=this.source:e.imgSource=[this.source],e}update(e){this.loader&&super.update(e)}}var Rv=Object.defineProperty,Wv=(s,e,t)=>e in s?Rv(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Du=(s,e,t)=>Wv(s,typeof e!="symbol"?e+"":e,t);class Gv extends Ts{constructor(e){super({single:!1,...e}),Du(this,"_markerCoord"),Du(this,"_content"),this._markerCoord=[...e.coordinate],this._content=e.content}_getClassName(){return"UIMarker"}buildOn(){const e=document.createElement("div"),{width:t,height:r}=this.options;typeof t=="number"&&(e.style.width=`${t}px`),typeof r=="number"&&(e.style.height=`${r}px`);const i=this.options.containerClass;i&&(Array.isArray(i)?i:[i]).forEach(c=>e.classList.add(c));const o=this._content;return typeof o=="function"?o(e):o instanceof HTMLElement?e.appendChild(o):typeof o=="string"&&(e.innerHTML=o),e}getOffset(){const e=super.getOffset(),t=this._dom;if(!t)return e;const r=t.offsetWidth,i=t.offsetHeight;return{x:e.x-r/2,y:e.y-i/2}}show(e){return e&&(this._markerCoord=[...e]),super.show(this._markerCoord)}setLngLatLikes(e){return this._markerCoord=[...e],this.isVisible()&&super.show(this._markerCoord),this}getLngLatLikes(){return[...this._markerCoord]}getCenter(){return this.getLngLatLikes()}getAltitude(){const e=this._markerCoord;return typeof e[2]=="number"?e[2]:typeof this.options.altitude=="number"?this.options.altitude:0}setAltitude(e){const t=[...this._markerCoord];return t[2]=e,this._markerCoord=t,this.isVisible()&&super.show(this._markerCoord),this}setContent(e){this._content=e,this.options.content=e;const t=this._dom;return t?(t.innerHTML="",typeof e=="function"?e(t):e instanceof HTMLElement?t.appendChild(e):typeof e=="string"&&(t.innerHTML=e),this):this}getContent(){return this._content}addTo(e){return super.addTo(e),this.options.visible!==!1&&this.show(this.options.coordinate),this}}console.log("%c✨ MapOrbis V"+ud+" ","color:rgb(255, 255, 255); font-weight: bold; background: linear-gradient(90deg, #ffb6c1, #ff69b4); padding: 5px; border-radius: 5px;"),Q.AbstractCanvasMaterialLoader=M0,Q.AbstractGeometryLoader=ua,Q.AbstractMaterialLoader=bs,Q.ArcGISLercLoader=au,Q.ArcGisDemSource=_v,Q.ArcGisSource=gv,Q.CloudsLayer=Fv,Q.CompositeTileLoader=Ss,Q.DrawTool=ji,Q.EventClass=Zo,Q.ExternalModelLoader=Ho,Q.Feature=Je,Q.GeometryHelper=Ni,Q.GeometrySkirtUtils=iu,Q.ICloud=qc,Q.InfoWindow=ga,Q.Label=Qc,Q.LineLayer=Lv,Q.LineString=pt,Q.LoaderUtils=On,Q.MVTGeoSource=Pv,Q.MVTSource=Mv,Q.Map=pi,Q.MapBoxSource=wv,Q.MapTileGeometry=Ri,Q.MapTool=Lu,Q.MapboxRGBLoader=uu,Q.MapboxVectorTileGeometryLoader=du,Q.Marker=wr,Q.Model=Kc,Q.MultiLineString=Zc,Q.Paint=xt,Q.PointLayer=Cv,Q.Polygon=fr,Q.PolygonLayer=Ov,Q.ProjectionFactory=Fy,Q.RasterTileLayer=va,Q.SceneRenderer=bc,Q.TDTQMSource=uv,Q.TDTSource=cv,Q.TPoints=Jc,Q.TerrainMeshBuilder=O0,Q.Tile=ni,Q.TileLayer=va,Q.TileLoaderFactory=Ve,Q.TileLoadingManager=ru,Q.TileMaterial=eu,Q.TileSource=qt,Q.ToolTip=_a,Q.UIComponent=Ts,Q.UIMarker=Gv,Q.VectorFeatureTypes=Xe,Q.VectorTileLayer=pa,Q.VectorTileRender=tu,Q.VectorTileTextureLoader=yu,Q.WMTSSource=dv,Q.WMTSTileLayer=Nv,Q.WebImageLoader=vu,Q.getApproxZoomLevel=Sd,Q.getLocalInfoFromGeo=Md,Q.getLocalInfoFromRay=Mo,Q.getLocalInfoFromScreen=So,Q.getLocalInfoFromWorld=ts,Q.registerDefaultLoaders=wu,Object.defineProperty(Q,Symbol.toStringTag,{value:"Module"})}));
