<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="initial-scale=1.0, user-scalable=no, width=device-width"
    />
    <title>MapOrbisStyle 地图标记</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- 引入 MapOrbisStyle CSS -->
    <link rel="stylesheet" href="./example/css/orbisstyle.css" />
    <style></style>
    <style>
      /* 地图应用特定样式 */
      html,
      body {
        height: 100%;
        width: 100%;
        overflow: hidden;
      }

      #container {
        height: 100%;
        width: 100%;
      }

      /* 地图控制面板定位 */
      .map-control-panel {
        position: absolute;
        top: 16px;
        right: 16px;
        width: 240px;
        z-index: var(--orbis-z-index-fixed);
      }

      /* 快捷键提示定位 */
      .map-shortcut-hint {
        position: absolute;
        bottom: 12px;
        left: 12px;
        z-index: var(--orbis-z-index-fixed);
      }

      /* 折叠按钮位置调整 */
      .map-control-panel .orbis-panel-header {
        position: relative;
        padding-right: 60px;
      }

      .map-control-panel .orbis-toggle {
        position: absolute;
        top: 12px;
        right: 12px;
      }

      .map-control-panel .orbis-toggle:nth-of-type(2) {
        right: 52px;
      }

      /* 按钮文字更简洁 */
      .compact-text {
        font-size: 13px;
      }

      /* 地图标记特殊样式 */
      .amap-marker {
        filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.15));
      }
    </style>
  </head>
  <body class="orbis-body">
    <div id="container"></div>

    <!-- MapOrbisStyle 控制面板 -->
    <div class="map-control-panel">
      <div class="orbis-panel">
        <div class="orbis-panel-header">
          <h3 style="font-size: 15px; margin: 0 0 3px 0">
            <i
              class="fas fa-map-marker-alt"
              style="color: var(--orbis-blue)"
            ></i>
            地图标记
          </h3>
          <p style="font-size: 12px; color: var(--orbis-gray-6); margin: 0">
            标记控制面板
          </p>
          <button class="orbis-toggle" id="themeToggle" title="切换暗黑模式">
            <i class="fas fa-moon"></i>
          </button>
        </div>

        <div class="orbis-panel-body">
          <div class="orbis-btn-group orbis-mb-3">
            <button class="orbis-btn  orbis-btn-sm orbis-btn-primary" onclick="addMarker()">
              <i class="fas fa-plus"></i> 添加
            </button>

            <div class="orbis-btn-row orbis-mb-2">
              <button
                class="orbis-btn orbis-btn-sm orbis-btn-success"
                onclick="updateIcon()"
                id="updateIconBtn"
                disabled
              >
                <i class="fas fa-brush"></i> 样式
              </button>
              <button
                class="orbis-btn orbis-btn-sm orbis-btn-secondary"
                onclick="updateContent()"
                id="updateContentBtn"
                disabled
              >
                <i class="fas fa-edit"></i> 内容
              </button>
            </div>

            <button
              class="orbis-btn orbis-btn-sm orbis-btn-danger"
              onclick="clearMarker()"
              id="clearMarkerBtn"
            >
              <i class="fas fa-trash"></i> 删除
            </button>
          </div>

          <div class="orbis-status-card">
            <div class="orbis-status-title">状态</div>
            <div class="orbis-status-indicator orbis-mb-2">
              <span class="orbis-indicator" id="statusIndicator"></span>
              <div class="orbis-status-content" id="statusText">无标记</div>
            </div>
            <div class="orbis-info-grid">
              <div class="orbis-info-item">
                <div class="orbis-info-label">位置</div>
                <div class="orbis-info-value" id="positionInfo">--</div>
              </div>
              <div class="orbis-info-item">
                <div class="orbis-info-label">样式</div>
                <div class="orbis-info-value" id="styleInfo">默认</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 加载提示 -->
    <div class="orbis-loading" id="loading">
      <div class="orbis-spinner"></div>
      <p>加载地图中...</p>
    </div>
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.171.0/build/three.module.js"
        }
      }
    </script>
    <script type="module">
      import * as maporbis from "./src/index.ts";
      var marker, map, layer;
      let markerAdded = false;
      let markerUpdated = false;
      let isDarkMode = false;
      let isPanelCollapsed = false;

      // 初始化地图
      function initMap() {
        const loading = document.getElementById("loading");
        loading.style.display = "block";
        try {
          map = new maporbis.Map("container", {
            center: [116.4, 39.9, 2000], // Beijing, [lon, lat, height]
            basemap: {
              minLevel: 2,
              maxLevel: 19,
              Baselayers: [
                new maporbis.TileLayer("esri_imagery", {
                  source: new maporbis.TileSource({
                    url: "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
                    projectionID: "3857",
                  }),
                  projection: maporbis.ProjectionFactory.create("3857"),
                  opacity: 1.0,
                  visible: true,
                }),
              ],
            },
            viewer: {
              stats: true,
              antialias: true,
              skybox: {
                hdr: "/example/public/image/hdr/kloofendal_48d_partly_cloudy_puresky_2k.hdr",
                hdrExposure: 1,
                defaultColor: "#B9D4FE", // 默认天空颜色
              },
              polarDeg: 75,
              azimuthDeg: 0,
              minDistance: 20,
              maxDistance: 80000,
            },
          });

          updateStatus();
          map.on('loaded', () => {
             loading.style.display = "none";
              showNotification('地图加载完成，点击"添加"开始使用', "info");
          });
          // setTimeout(() => {
          //   showNotification('地图加载完成，点击"添加"开始使用', "info");
          // }, 1000);
        } catch (error) {
          console.error("地图初始化失败:", error);
          showNotification("地图初始化失败: " + error.message, "error");
          loading.style.display = "none";
        }
      }
      function initlayer() {
        layer = new maporbis.PointLayer("markers", { altitude: 1 });
        map.addLayer(layer);
      }

      // 创建地图标记内容
      function createMarkerContent(text = "当前位置", isUpdated = false) {
        const markerContent = document.createElement("div");
        markerContent.className = isUpdated
          ? "orbis-marker orbis-marker-updated"
          : "orbis-marker";

        const markerPin = document.createElement("div");
        markerPin.className = "orbis-marker-pin";
        if (isUpdated) {
          markerPin.style.background = "var(--orbis-green)";
        }
        markerContent.appendChild(markerPin);

        const markerLabel = document.createElement("div");
        markerLabel.className = "orbis-marker-label";
        markerLabel.textContent = text;
        markerContent.appendChild(markerLabel);

        return markerContent;
      }

      // 更新UI状态
      function updateStatus() {
        const statusIndicator = document.getElementById("statusIndicator");
        const statusText = document.getElementById("statusText");
        const positionInfo = document.getElementById("positionInfo");
        const styleInfo = document.getElementById("styleInfo");
        const updateIconBtn = document.getElementById("updateIconBtn");
        const updateContentBtn = document.getElementById("updateContentBtn");
        const clearMarkerBtn = document.getElementById("clearMarkerBtn");

        if (markerAdded && marker) {
          statusIndicator.className = "orbis-indicator orbis-indicator-active";
          statusText.textContent = "标记已添加";

          const position = marker.getPosition();
          if (position) {
            positionInfo.textContent = `${position.lng.toFixed(6)}, ${position.lat.toFixed(6)}`;
          } else {
            positionInfo.textContent = markerUpdated
              ? "116.391467, 39.927761"
              : "116.406315, 39.908775";
          }

          styleInfo.textContent = markerUpdated ? "已更新" : "默认";

          updateIconBtn.disabled = false;
          updateContentBtn.disabled = false;
          // clearMarkerBtn.disabled = false;
        } else {
          statusIndicator.className = "orbis-indicator";
          statusText.textContent = "无标记";
          positionInfo.textContent = "--";
          styleInfo.textContent = "默认";

          updateIconBtn.disabled = true;
          updateContentBtn.disabled = true;
          // clearMarkerBtn.disabled = true;
        }
      }

      // 添加标记
       window.addMarker = function() {
        if (!marker) {
          const markerContent = createMarkerContent("当前位置", false);
          marker = new maporbis.Marker({
            geometry: {
              type: "Point",
              coordinates: [116.4, 39.9],
            },
            style: {
              type: "icon-point",
              url: "https://a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-default.png",
              size: 30,
              rotation: Math.PI / 4,
              anchor: [0.5, 0],
              sizeAttenuation: false,
              transparent: true,
              color: "#fff",
            },
            userData: {},
          });

          marker.addTo(layer);
          markerAdded = true;

          // map.setCenter([116.406315, 39.908775]);

          showNotification("标记添加成功", "success");
          updateStatus();
        } else {
          showNotification("标记已存在", "info");
        }
      }

      // 更新标记图标
      function updateIcon() {
        if (marker) {
          const newContent = createMarkerContent("当前位置", true);
          marker.setContent(newContent);

          showNotification("标记样式已更新", "success");
          updateStatus();
        } else {
          showNotification("请先添加标记", "warning");
        }
      }

      // 更新标记内容
      function updateContent() {
        if (marker) {
          const newContent = createMarkerContent("已更新位置", true);
          marker.setContent(newContent);
          marker.setPosition([116.391467, 39.927761]);

          map.setCenter([116.391467, 39.927761]);

          markerUpdated = true;

          showNotification("标记内容和位置已更新", "success");
          updateStatus();
        } else {
          showNotification("请先添加标记", "warning");
        }
      }

      // 清除标记
      window.clearMarker = function() {
        if (marker) {
          layer.removeFeature(marker);
          marker = null;
          markerAdded = false;
          markerUpdated = false;

          showNotification("标记已删除", "info");
          updateStatus();
        } else {
          showNotification("没有可删除的标记", "warning");
        }
      }

      // 切换暗黑模式
      function toggleDarkMode() {
        isDarkMode = !isDarkMode;
        const body = document.body;
        const themeToggle = document.getElementById("themeToggle");
        const icon = themeToggle.querySelector("i");

        if (isDarkMode) {
          body.classList.add("orbis-dark");
          icon.className = "fas fa-sun";
          themeToggle.title = "切换到浅色模式";

          if (map) {
            map.setMapStyle("amap://styles/dark");
          }

          showNotification("暗黑模式已开启", "info");
        } else {
          body.classList.remove("orbis-dark");
          icon.className = "fas fa-moon";
          themeToggle.title = "切换到暗黑模式";

          if (map) {
            map.setMapStyle("amap://styles/light");
          }

          showNotification("浅色模式已开启", "info");
        }

        localStorage.setItem("mapDarkMode", isDarkMode);
      }

      // 显示通知
      function showNotification(message, type = "info") {
        const existingNotification = document.querySelector(
          ".orbis-notification",
        );
        if (existingNotification) {
          existingNotification.remove();
        }

        const notification = document.createElement("div");
        notification.className = `orbis-notification orbis-notification-${type}`;

        let icon = "fa-info-circle";
        switch (type) {
          case "success":
            icon = "fa-check-circle";
            break;
          case "warning":
            icon = "fa-exclamation-triangle";
            break;
          case "error":
            icon = "fa-exclamation-triangle";
            break;
          case "info":
            icon = "fa-info-circle";
            break;
        }

        notification.innerHTML = `
        <div class="orbis-notification-content">
          <i class="fas ${icon}"></i>
          <span>${message}</span>
        </div>
      `;

        document.body.appendChild(notification);

        setTimeout(() => {
          notification.classList.add("orbis-notification-show");
        }, 10);

        setTimeout(() => {
          notification.classList.remove("orbis-notification-show");
          setTimeout(() => {
            notification.remove();
          }, 400);
        }, 3000);
      }

      // 初始化应用
      document.addEventListener("DOMContentLoaded", function () {
        const savedDarkMode = localStorage.getItem("mapDarkMode");
        if (savedDarkMode === "true") {
          isDarkMode = true;
          document.body.classList.add("orbis-dark");
          document.getElementById("themeToggle").querySelector("i").className =
            "fas fa-sun";
        }


        setTimeout(initMap, 100);
        setTimeout(initlayer, 200);

        document
          .getElementById("themeToggle")
          .addEventListener("click", toggleDarkMode);

      });
    </script>
  </body>
</html>
